
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Application.CloudApps.cloud_apps &#8212; Commvault Automation 11.12 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Application.CloudApps.cloud_apps</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main Module for invoking cloud APIs.</span>

<span class="sd">GAdmin, GMail, GDrive are the classes defined in this file.</span>

<span class="sd">GAdmin: Class for performing GSuite Admin operations like getting user list,</span>
<span class="sd">        modifying user properties etc.</span>

<span class="sd">GMail: Class for performing all gmail related operations.</span>

<span class="sd">GDrive: Class for performing all GDrive related operations.</span>

<span class="sd">GAdmin:</span>
<span class="sd">        __init__(cloud_object)  --  Initializes the GAdmin object</span>

<span class="sd">        __repr__()  --  Representation string for the instance of the GAdmin class</span>

<span class="sd">        __get_users()   --  Gets the list of users by calling GSuite Directory API</span>

<span class="sd">Attributes</span>
<span class="sd">==========</span>

<span class="sd">        **users**   --  Returns the user smtp address list from GSuite account</span>

<span class="sd">GMail:</span>
<span class="sd">        __init__(cloud_object)  --  Initializes the GMail object</span>

<span class="sd">        __repr__()  --  Representation string for the instance of GMail class</span>

<span class="sd">        _get_messages_prop()    --  Gets the message property of all the messages in the mailbox of a user</span>

<span class="sd">        get_labels()    --  Fetches the list of labels for a GMail user</span>

<span class="sd">        get_messages_prop() --  Gets message properties for user mailbox and stores it in TinyDB file</span>

<span class="sd">        delete_messages()   --  Deletes specific messages inside user&#39;s mailbox</span>

<span class="sd">        append_message()    --  Appends a message into the user&#39;s mailbox based on mail_insertion_type setting</span>

<span class="sd">        _create_message()   --  Creates a MIME message by fetching a random page from wikipedia</span>

<span class="sd">        _select_random_sender() --  Selects the random sender from available Google users</span>

<span class="sd">         compare_msg_props()    --  Compares message properties</span>

<span class="sd">GDrive:</span>
<span class="sd">        __init__(cloud_object)  --  Initializes the GDrive object</span>

<span class="sd">        __repr__()  --  Representation string for the instance of GDrive class</span>

<span class="sd">        create_files()  --  This method creates and upload files on user&#39;s GDrive</span>

<span class="sd">        files_op()  --  Method to perform various operations on user&#39;s GDRive</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="k">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="k">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.mime.audio</span> <span class="k">import</span> <span class="n">MIMEAudio</span>
<span class="kn">from</span> <span class="nn">email.mime.base</span> <span class="k">import</span> <span class="n">MIMEBase</span>
<span class="kn">from</span> <span class="nn">email.mime.image</span> <span class="k">import</span> <span class="n">MIMEImage</span>
<span class="kn">from</span> <span class="nn">email</span> <span class="k">import</span> <span class="n">encoders</span>
<span class="kn">from</span> <span class="nn">email.header</span> <span class="k">import</span> <span class="n">Header</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randrange</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">googleapiclient.http</span> <span class="k">import</span> <span class="n">MediaFileUpload</span>
<span class="kn">from</span> <span class="nn">googleapiclient.http</span> <span class="k">import</span> <span class="n">MediaIoBaseDownload</span>
<span class="kn">from</span> <span class="nn">googleapiclient.errors</span> <span class="k">import</span> <span class="n">HttpError</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">.wiki</span> <span class="k">import</span> <span class="n">Wiki</span>
<span class="kn">from</span> <span class="nn">.exception</span> <span class="k">import</span> <span class="n">CVCloudException</span>


<div class="viewcode-block" id="GAdmin"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GAdmin">[docs]</a><span class="k">class</span> <span class="nc">GAdmin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for performing admin level operation for GSuite account.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the GAdmin object.</span>

<span class="sd">                Args:</span>

<span class="sd">                    cc_object  (Object)  --  instance of CloudConnector class</span>

<span class="sd">                Returns:</span>

<span class="sd">                    object  --  instance of GAdmin class</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admin_api</span> <span class="o">=</span> <span class="s1">&#39;GAdmin&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;auth object assigned&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">auth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got mail users in constructor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mail_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_users</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Representation string for the instance of the GAdmin class.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s1">&#39;Google Admin class instance for GSuite Admin API version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
               <span class="n">constants</span><span class="o">.</span><span class="n">GOOGLE_API_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_api</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the list of users by calling GSuite Directory API.</span>

<span class="sd">                Returns:</span>

<span class="sd">                    list    --  A list containing email id of all users</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_api</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">userKey</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">ADMIN_EMAIL</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">user_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;customerId&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;customerId of the GSuite account: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;customerId&#39;</span><span class="p">]))</span>
                <span class="n">customer_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;customerId&#39;</span><span class="p">]</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                    <span class="n">customer</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
                    <span class="n">maxResults</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">USER_SEARCH_MAX_COUNT</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]:</span>
                    <span class="n">user_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;primaryEmail&#39;</span><span class="p">])</span>

                <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">page_token</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">customer</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
                        <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">,</span>
                        <span class="n">maxResults</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">USER_SEARCH_MAX_COUNT</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]:</span>
                        <span class="n">user_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;primaryEmail&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Customer ID not found. Will do a domain search on domain: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">constants</span><span class="o">.</span><span class="n">ADMIN_EMAIL</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                    <span class="n">domain</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">ADMIN_EMAIL</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">maxResults</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">USER_SEARCH_MAX_COUNT</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]:</span>
                    <span class="n">user_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;primaryEmail&#39;</span><span class="p">])</span>
                <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">page_token</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">domain</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">ADMIN_EMAIL</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">,</span>
                        <span class="n">maxResults</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">USER_SEARCH_MAX_COUNT</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]:</span>
                        <span class="n">user_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;primaryEmail&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_api</span><span class="p">,</span> <span class="s1">&#39;101&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s1">&#39;Exception while fetching user list from Google&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_api</span><span class="p">,</span> <span class="s1">&#39;102&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total no of users found: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_list</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">user_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the user smtp address list from GSuite account&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mail_users</span></div>


<div class="viewcode-block" id="GMail"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail">[docs]</a><span class="k">class</span> <span class="nc">GMail</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for performing GMail related operations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the GMail object.</span>

<span class="sd">                Args:</span>

<span class="sd">                    cc_object  (Object)  --  instance of cloud_connector module</span>

<span class="sd">                Returns:</span>

<span class="sd">                    object  --  instance of GMail class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">tc_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wiki</span> <span class="o">=</span> <span class="n">Wiki</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_users</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">gadmin</span><span class="o">.</span><span class="n">users</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Representation string for the instance of GMail class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;GMail operation class instance for GMail API version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
               <span class="n">constants</span><span class="o">.</span><span class="n">GOOGLE_API_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_messages_prop</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">after_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">google_resp_format</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
            <span class="n">oop_type</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the message property of all the messages in the mailbox of a user</span>

<span class="sd">                Args:</span>

<span class="sd">                    after_restore  (boolean)  --  True if properties are fetched after restore job</span>

<span class="sd">                    label_list (list)  -- List of labels to fetch messages from user mailbox.</span>

<span class="sd">                    google_resp_format (str) -- The format to return the message in</span>

<span class="sd">                                                  Allowed values</span>

<span class="sd">                                                    - full -</span>

<span class="sd">                                                    - metadata -</span>

<span class="sd">                                                    - minimal -</span>

<span class="sd">                                                    - raw - With this parameter entire message payload is returned as</span>
<span class="sd">                                                          base64 encoded string.</span>

<span class="sd">                    oop_type  (str)  --  Specifies source or destination for out of place restore</span>



<span class="sd">                Returns:</span>

<span class="sd">                    Dict    --   A dict of following form:</span>
<span class="sd">                            {&#39;userid&#39;: [{message1 property dict},</span>
<span class="sd">                                        {message2 property dict},</span>
<span class="sd">                                        {message3 property dict}</span>
<span class="sd">                                        ]</span>
<span class="sd">                            }</span>

<span class="sd">                            Message property dict format    --   A list containing dicts for</span>
<span class="sd">                                                                 message properties.</span>
<span class="sd">                                                                 One dict per message.</span>

<span class="sd">                       e.g.:    [</span>
<span class="sd">                                    {&#39;To&#39;:&#39;some address&#39;,&#39;From&#39;:&#39;some address&#39;,</span>
<span class="sd">                                    &#39;Message-ID&#39;:&#39;someid&#39;},</span>
<span class="sd">                                     {&#39;To&#39;:&#39;some address&#39;,&#39;From&#39;:&#39;some address&#39;,</span>
<span class="sd">                                     &#39;Message-ID&#39;:&#39;someid&#39;},</span>
<span class="sd">                                      {&#39;To&#39;:&#39;some address&#39;,&#39;From&#39;:&#39;some address&#39;,</span>
<span class="sd">                                      &#39;Message-ID&#39;:&#39;someid&#39;}</span>
<span class="sd">                                  ]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fetching message properties for the users&#39;</span><span class="p">)</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>

        <span class="n">table_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_TABLE</span>
        <span class="k">if</span> <span class="n">after_restore</span><span class="p">:</span>
            <span class="n">table_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_RES_TABLE</span>
        <span class="k">if</span> <span class="n">oop_type</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>
            <span class="n">table_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_OOP_SOURCE</span>
        <span class="k">if</span> <span class="n">oop_type</span> <span class="o">==</span> <span class="s1">&#39;destination&#39;</span><span class="p">:</span>
            <span class="n">table_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_OOP_DESTINATION</span>

        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="n">userID</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">gmail_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                    <span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">,</span> <span class="n">labelIds</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span> <span class="n">includeSpamTrash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="s1">&#39;messages&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">])</span>
                <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">page_token</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">,</span>
                        <span class="n">labelIds</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span>
                        <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">,</span>
                        <span class="n">includeSpamTrash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>

                    <span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="n">google_resp_format</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                    <span class="n">label_id_list</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelIds&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Label id list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">label_id_list</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">label_id_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;There is no label associated to the mail. &#39;</span>
                                      <span class="s1">&#39;This can be archived mail which we dont backup&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="s1">&#39;SPAM&#39;</span> <span class="ow">in</span> <span class="n">label_id_list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SPAM found. Skipping the message.&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">google_resp_format</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                        <span class="n">headers</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payload&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">)</span>
                        <span class="n">prop_dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="n">prop_dict</span><span class="p">[</span><span class="s1">&#39;labelIds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelIds&#39;</span><span class="p">)</span>
                        <span class="n">prop_dict</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sizeEstimate&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                                    <span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;From&#39;</span><span class="p">,</span> <span class="s1">&#39;To&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Message-ID&#39;</span><span class="p">]:</span>
                                <span class="n">prop_dict</span><span class="p">[</span>
                                    <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving message properties in json db&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_into_table</span><span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">prop_dict</span><span class="p">,</span> <span class="n">table_type</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">google_resp_format</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>

                        <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing illegal content from raw mail content&#39;</span><span class="p">)</span>
                        <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">raw_msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">raw_msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">raw_msg</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">raw_msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating hash for base64 raw mail content&#39;</span><span class="p">)</span>
                        <span class="n">msg_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">raw_msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;message hash: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg_hash</span><span class="p">)</span>
                        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_hash</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving message properties in json db&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_into_table</span><span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">table_type</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                            <span class="s1">&#39;Google response format provided is invalid: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">google_resp_format</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;107&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;message properties got for user: &quot;</span><span class="si">{0}</span><span class="s1">&quot;. &#39;</span>
                    <span class="s1">&#39;Total number of mails for Label ids: </span><span class="si">{1}</span><span class="s1"> (excluding SPAM): &quot;</span><span class="si">{2}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">userID</span><span class="p">,</span> <span class="n">label_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">userID</span> <span class="o">+</span> <span class="s1">&#39;_messages&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">after_restore</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Fetching label list for the user with number of messages in each label&#39;</span><span class="p">)</span>
                    <span class="n">final_label_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span>
                        <span class="n">userID</span><span class="p">,</span> <span class="n">gmail_service</span><span class="o">=</span><span class="n">gmail_service</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving label list to json db&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_into_table</span><span class="p">(</span>
                        <span class="n">userID</span><span class="p">,</span> <span class="n">final_label_dict</span><span class="p">[</span><span class="n">userID</span><span class="p">],</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABELS_TABLE</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s1">&#39;An error occurred while fetching messages for user&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">google_exception</span>

<div class="viewcode-block" id="GMail.get_labels"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail.get_labels">[docs]</a>    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userID</span><span class="p">,</span> <span class="n">gmail_service</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches the list of labels for a GMail user</span>

<span class="sd">                Args:</span>

<span class="sd">                    userID (str)  --  SMTP address of the user</span>

<span class="sd">                    gmail_service (object)  --  GMail Resource service object</span>

<span class="sd">                Returns:</span>

<span class="sd">                    A dict containing label details</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gmail_service</span><span class="p">:</span>
            <span class="n">gmail_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>
        <span class="n">label_response</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="n">label_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">final_label_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">):</span>
            <span class="n">label_id</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label_id</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">LABEL_IDS_TO_SKIP</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label_get</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">labels</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">label_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                <span class="n">label_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_get</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">final_label_dict</span><span class="p">[</span><span class="n">userID</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_id_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;final label dict: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_label_dict</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">final_label_dict</span></div>

<div class="viewcode-block" id="GMail.get_messages_prop"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail.get_messages_prop">[docs]</a>    <span class="k">def</span> <span class="nf">get_messages_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">after_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">label_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">google_resp_format</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
                          <span class="n">oop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets message properties for user mailbox and stores it in TinyDB file.</span>

<span class="sd">                Args:</span>

<span class="sd">                    after_restore  (boolean)  --  True if properties are fetched after restore job</span>

<span class="sd">                    label_list  (list)  --  List of labels to fetch from user mailbox</span>

<span class="sd">                    google_resp_format (str) -- The format to return the message in</span>

<span class="sd">                                                  Allowed values</span>

<span class="sd">                                                    - full -</span>

<span class="sd">                                                    - metadata -</span>

<span class="sd">                                                    - minimal -</span>

<span class="sd">                                                    - raw - With this parameter entire message payload is returned</span>
<span class="sd">                                                            as base64 encoded string.</span>

<span class="sd">                    oop  (boolean)  --  True if out of place restore</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">oop</span><span class="p">:</span>
            <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="s1">&#39;joblist&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;job_list&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job list got from db: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Invalid job list: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_list</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;401&#39;</span><span class="p">)</span>

            <span class="n">destination</span> <span class="o">=</span> <span class="n">job_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">job_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">user_id_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]}]</span>
            <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;user id dict: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id_dict</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label list: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_messages_prop</span><span class="p">(</span>
                <span class="n">after_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_list</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span> <span class="n">oop_type</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
            <span class="n">dest_user</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;destination user id: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_user</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;destination label list: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">[</span><span class="n">destination</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">label_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
            <span class="n">label_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels</span><span class="p">(</span><span class="n">userID</span><span class="o">=</span><span class="n">dest_user</span><span class="p">)</span>
            <span class="n">label_list_temp</span> <span class="o">=</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest_user</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dict1</span> <span class="ow">in</span> <span class="n">label_list_temp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dict1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">destination</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">label_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">label_id</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;destination label id: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_messages_prop</span><span class="p">(</span>
                <span class="n">after_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">label_list</span><span class="o">=</span><span class="p">[</span><span class="n">label_id</span><span class="p">],</span>
                <span class="n">oop_type</span><span class="o">=</span><span class="s1">&#39;destination&#39;</span><span class="p">,</span>
                <span class="n">google_resp_format</span><span class="o">=</span><span class="n">google_resp_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_messages_prop</span><span class="p">(</span>
                <span class="n">after_restore</span><span class="o">=</span><span class="n">after_restore</span><span class="p">,</span>
                <span class="n">label_list</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span>
                <span class="n">google_resp_format</span><span class="o">=</span><span class="n">google_resp_format</span><span class="p">)</span></div>

<div class="viewcode-block" id="GMail.delete_messages"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail.delete_messages">[docs]</a>    <span class="k">def</span> <span class="nf">delete_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes specific messages inside user&#39;s mailbox.&quot;&quot;&quot;</span>

        <span class="n">idDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
                <span class="n">userID</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>
                <span class="n">idlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_message_id_list</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>
                <span class="n">msg_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_OOP_DESTINATION</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">msg_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msg_list</span><span class="p">:</span>
                        <span class="n">idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">idDict</span><span class="p">[</span><span class="s1">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">userID</span>
                <span class="n">idDict</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idlist</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;following messages will be deleted: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idDict</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">idDict</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;there is nothing to delete.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gmail_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>
                        <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">batchDelete</span><span class="p">(</span>
                            <span class="n">userId</span><span class="o">=</span><span class="n">userID</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">idDict</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;specified messages have been deleted &#39;</span>
                            <span class="s1">&#39;from user mailbox: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                            <span class="s1">&#39;Exception while deleting messages from GMail&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;201&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="GMail.append_message"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail.append_message">[docs]</a>    <span class="k">def</span> <span class="nf">append_message</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">unicode_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">no_of_mails</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">mail_insertion_type</span><span class="o">=</span><span class="s1">&#39;APPEND&#39;</span>
            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends a message into the user&#39;s mailbox based on mail_insertion_type setting.</span>
<span class="sd">           Message body is created by fetching random wiki page.</span>
<span class="sd">           Please refer to Args for more details</span>

<span class="sd">                Args:</span>

<span class="sd">                    sc_content (list) -- Subclient content list. This can be obtained by</span>
<span class="sd">                    get_sc_content method of commvault class</span>

<span class="sd">                    unicode_data (Boolean) -- If True, unicode mails will be created.</span>

<span class="sd">                    no_of_mails (int) -- Number of mails to create in each mail account.</span>

<span class="sd">                    mail_insertion_type (str): Whether to import or append message.</span>

<span class="sd">                        Allowed values:</span>

<span class="sd">                            APPEND: Directly inserts a message into only this user&#39;s mailbox similar to IMAP APPEND,</span>
<span class="sd">                                    bypassing most scanning and classification. Does not send a message.</span>

<span class="sd">                            IMPORT: Imports a message into only this user&#39;s mailbox, with standard email delivery</span>
<span class="sd">                                    scanning and classification similar to receiving via SMTP. Does not send a message</span>

<span class="sd">                            SEND: Sends the message to random sender</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;subclient content: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sc_content</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
                <span class="n">userID</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating documents for attachment&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">create_docx</span><span class="p">(</span>
                        <span class="n">unicode_data</span><span class="o">=</span><span class="n">unicode_data</span><span class="p">,</span>
                        <span class="n">pdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">google_docs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ca_type</span><span class="o">=</span><span class="s1">&#39;gmail&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;inserting message into user mailbox: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>

                    <span class="n">gmail_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_mails</span><span class="p">):</span>
                        <span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_random_sender</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">sender</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">userID</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_random_sender</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;mail insertion type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="n">mail_insertion_type</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">mail_insertion_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;APPEND&#39;</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message</span><span class="p">(</span>
                                <span class="n">sender</span><span class="p">,</span> <span class="n">userID</span><span class="p">,</span> <span class="n">unicode_data</span><span class="p">,</span> <span class="n">mail_insertion_type</span><span class="p">)</span>

                            <span class="n">imported_message</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                                <span class="n">userId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">mail_insertion_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;IMPORT&#39;</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message</span><span class="p">(</span>
                                <span class="n">sender</span><span class="p">,</span> <span class="n">userID</span><span class="p">,</span> <span class="n">unicode_data</span><span class="p">,</span> <span class="n">mail_insertion_type</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;base64 encoded: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
                            <span class="n">imported_message</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">import_</span><span class="p">(</span>
                                <span class="n">userId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">mail_insertion_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;SEND&#39;</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_message</span><span class="p">(</span>
                                <span class="n">userID</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">unicode_data</span><span class="p">,</span> <span class="n">mail_insertion_type</span><span class="p">)</span>
                            <span class="n">imported_message</span> <span class="o">=</span> <span class="n">gmail_service</span><span class="o">.</span><span class="n">users</span><span class="p">()</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                                <span class="n">userId</span><span class="o">=</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;mail insertion type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="n">mail_insertion_type</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                <span class="s1">&#39;Invalid mail insertion type provided.&#39;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;108&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">u</span><span class="s1">&#39;Following message has been appended into user mailbox: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imported_message</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s1">&#39;Exception while inserting message into user mailbox&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;102&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;101&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_create_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">unicode_data</span><span class="p">,</span> <span class="n">mail_insertion_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a MIME message by fetching a random page from wikipedia</span>

<span class="sd">                Args:</span>

<span class="sd">                    sender (str) -- sender&#39;s email id</span>

<span class="sd">                    to (str) -- recipient&#39;s email id</span>

<span class="sd">                    unicode_data (boolean) -- set it true to create mails with unicode data</span>

<span class="sd">                    mail_insertion_type (str)  --  Type of mail insertion to Google</span>

<span class="sd">                                                    Allowed Values:</span>
<span class="sd">                                                        - APPEND</span>
<span class="sd">                                                        - IMPORT</span>
<span class="sd">                                                        - SEND</span>

<span class="sd">                Returns:</span>

<span class="sd">                    dict of following form: {&#39;raw&#39;: base64 encoded MIME message, &#39;labelIds&#39;: [labels to apply]}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fetching random message from wiki&#39;</span><span class="p">)</span>
            <span class="n">wiki</span> <span class="o">=</span> <span class="n">Wiki</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
            <span class="n">wiki_message</span> <span class="o">=</span> <span class="n">wiki</span><span class="o">.</span><span class="n">create_message_from_wiki</span><span class="p">(</span><span class="n">unicode_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;message content got from wiki. Creating MIME object now.&#39;</span><span class="p">)</span>

            <span class="n">message</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">()</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="n">wiki_message</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

            <span class="n">body</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">wiki_message</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span> <span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>

            <span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="c1"># Creating attachments for GMail</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">GMAIL_DOCUMENT_DIRECTORY</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;attachment directory exists for GMail. Uploading attachments&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">GMAIL_DOCUMENT_DIRECTORY</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">GMAIL_DOCUMENT_DIRECTORY</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Guess the content type based on the file&#39;s extension.  Encoding</span>
                    <span class="c1"># will be ignored, although we should check for simple things like</span>
                    <span class="c1"># gzip&#39;d or compressed files.</span>

                    <span class="n">content_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>
                    <span class="n">main_type</span><span class="p">,</span> <span class="n">sub_type</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">main_type</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">_subtype</span><span class="o">=</span><span class="n">sub_type</span><span class="p">)</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">main_type</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEImage</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">_subtype</span><span class="o">=</span><span class="n">sub_type</span><span class="p">)</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">main_type</span> <span class="o">==</span> <span class="s1">&#39;audio&#39;</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEAudio</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">_subtype</span><span class="o">=</span><span class="n">sub_type</span><span class="p">)</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEBase</span><span class="p">(</span><span class="n">main_type</span><span class="p">,</span> <span class="n">sub_type</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">encoders</span><span class="o">.</span><span class="n">encode_base64</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span>
                        <span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;attachment&#39;</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

                    <span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">as_bytes</span><span class="p">())</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MIME object created successfully&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mail_insertion_type</span> <span class="o">==</span> <span class="s1">&#39;APPEND&#39;</span> <span class="ow">or</span> <span class="n">mail_insertion_type</span> <span class="o">==</span> <span class="s1">&#39;IMPORT&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">raw</span><span class="p">,</span>
                    <span class="s1">&#39;labelIds&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;INBOX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;UNREAD&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">mail_insertion_type</span> <span class="o">==</span> <span class="s1">&#39;SEND&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">raw</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Invalid mail insertion type&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;108&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Exception while creating MIME object&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_select_random_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects the random sender from available Google users to be added in From field while creating a MIME mail</span>

<span class="sd">                Returns:</span>

<span class="sd">                    Str  --  A random user&#39;s SMTP Address</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">random_number</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mail_users</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;setting sender mail id: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mail_users</span><span class="p">[</span><span class="n">random_number</span><span class="p">]))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mail_users</span><span class="p">[</span><span class="n">random_number</span><span class="p">]</span>

<div class="viewcode-block" id="GMail.compare_msg_props"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GMail.compare_msg_props">[docs]</a>    <span class="k">def</span> <span class="nf">compare_msg_props</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">oop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compares message properties.</span>

<span class="sd">                Args:</span>

<span class="sd">                    oop  (boolean)  -- True if the restore is out of place restore</span>

<span class="sd">                                        Default: False</span>

<span class="sd">                Returns:</span>

<span class="sd">                    True on success</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Comparing message properties after restore&#39;</span><span class="p">)</span>

        <span class="n">key_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">len_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
                <span class="n">userID</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>
                <span class="n">table1_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_TABLE</span><span class="p">)</span>
                <span class="n">table2_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_length</span><span class="p">(</span><span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_RES_TABLE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Length of first table: </span><span class="si">{0}</span><span class="s1"> and Length of second table: </span><span class="si">{1}</span><span class="s1">: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">table1_size</span><span class="p">,</span> <span class="n">table2_size</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">table1_size</span> <span class="o">!=</span> <span class="n">table2_size</span><span class="p">:</span>
                    <span class="n">len_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">oop</span><span class="p">:</span>
                        <span class="n">table1</span> <span class="o">=</span> <span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_OOP_SOURCE</span>
                        <span class="n">table2</span> <span class="o">=</span> <span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_OOP_DESTINATION</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table1</span> <span class="o">=</span> <span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_TABLE</span>
                        <span class="n">table2</span> <span class="o">=</span> <span class="n">userID</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">MESSAGES_AFTER_RES_TABLE</span>
                    <span class="n">msg_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">table1</span><span class="p">)</span>
                    <span class="n">msg_list_after_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">table2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;msg list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg_list</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;msg list after restore : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">msg_list_after_res</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">msg1</span> <span class="ow">in</span> <span class="n">msg_list</span><span class="p">:</span>
                        <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">for</span> <span class="n">msg2</span> <span class="ow">in</span> <span class="n">msg_list_after_res</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;raw of msg1: </span><span class="si">{0}</span><span class="s1">, type </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span>
                                        <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">))))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;raw of msg2: </span><span class="si">{0}</span><span class="s1">, type </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span>
                                        <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">))))</span>
                            <span class="k">if</span> <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;raw&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sizeEstimate&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="s1">&#39;sizeEstimate&#39;</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sizeEstimate match successful&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                        <span class="s1">&#39;Size is not matching but this can be becasue of removing illegal characters from the mail.&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">oop</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;This is oop restore so skipping label id match.&#39;</span><span class="p">)</span>
                                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelIds&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                            <span class="s1">&#39;labelIds&#39;</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;labelIds match successful&#39;</span><span class="p">)</span>
                                        <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                            <span class="s1">&#39;labelIds are not matching: </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">msg1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelIds&#39;</span><span class="p">),</span> <span class="n">msg2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labelIds&#39;</span><span class="p">)))</span>
                                        <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;104&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                <span class="s1">&#39;Message property comparison failed for raw format for restored message: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg2</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;104&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_match</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;email id is not present in restore dict&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;105&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">len_match</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s1">&#39;Number of messages in the mailbox are different after restore. &#39;</span>
                <span class="s1">&#39;Before backup number of messages: </span><span class="si">{0}</span><span class="s1"> and after restore number of messages: </span><span class="si">{1}</span><span class="s1"> for user mailbox: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">table1_size</span><span class="p">,</span> <span class="n">table2_size</span><span class="p">,</span> <span class="n">userID</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;301&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;raw properties, size estimates and label Ids are matching.&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GDrive"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GDrive">[docs]</a><span class="k">class</span> <span class="nc">GDrive</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for performing GDrive related operations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the GDrive object.</span>

<span class="sd">                Args:</span>

<span class="sd">                    cc_object  (Object)  --  instance of cloud_connector module</span>


<span class="sd">                Returns:</span>

<span class="sd">                    object  --  instance of GDrive class</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">tc_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_users</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">gadmin</span><span class="o">.</span><span class="n">users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">cc_object</span><span class="o">.</span><span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wiki</span> <span class="o">=</span> <span class="n">Wiki</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Representation string for the instance of GDrive class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;GDrive operation class instance for GDrive API version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="n">constants</span><span class="o">.</span><span class="n">GOOGLE_API_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="GDrive.create_files"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GDrive.create_files">[docs]</a>    <span class="k">def</span> <span class="nf">create_files</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">unicode_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">no_of_docs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">pdf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">google_docs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">new_folder</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method creates and upload files on user&#39;s GDrive</span>

<span class="sd">                Args:</span>

<span class="sd">                    unicode_data  (boolean)  --  True if unicode data files have to be created</span>

<span class="sd">                    no_of_docs  (int)  --  Number of files to create and upload</span>

<span class="sd">                    pdf  (boolean)  --  True if pdf files have to be created</span>

<span class="sd">                    google_docs  (boolean)  --  True if Google Docs have to be created</span>

<span class="sd">                    new_folder  (boolean)  --  True if a new folder has to be created on user&#39;s GDrive</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">create_docx</span><span class="p">(</span>
            <span class="n">no_of_docs</span><span class="o">=</span><span class="n">no_of_docs</span><span class="p">,</span>
            <span class="n">unicode_data</span><span class="o">=</span><span class="n">unicode_data</span><span class="p">,</span>
            <span class="n">pdf</span><span class="o">=</span><span class="n">pdf</span><span class="p">,</span>
            <span class="n">google_docs</span><span class="o">=</span><span class="n">google_docs</span><span class="p">,</span>
            <span class="n">ca_type</span><span class="o">=</span><span class="s1">&#39;gdrive&#39;</span><span class="p">)</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
                <span class="n">userID</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;creating documents into users GDrive: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>

                    <span class="n">gdrive_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userID</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_folder</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Files will be uploaded to existing folder&#39;</span><span class="p">)</span>
                        <span class="n">folder_CVID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_folder_cvid</span><span class="p">(</span><span class="n">userID</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">folder_CVID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;folder cvid of existing folder: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder_CVID</span><span class="p">))</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s2">&quot;name = &#39;&quot;</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_FOLDER</span> <span class="o">+</span> \
                                                           <span class="s2">&quot;&#39; and mimeType = &#39;application/vnd.google-apps.folder&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                            <span class="n">folder</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;folder cvid is None.&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">new_folder</span> <span class="ow">or</span> <span class="n">folder_CVID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating a new folder on GDrive&#39;</span><span class="p">)</span>
                        <span class="n">folder_CVID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
                        <span class="n">file_metadata</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_FOLDER</span><span class="p">,</span>
                            <span class="s1">&#39;mimeType&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.google-apps.folder&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;CVID&#39;</span><span class="p">:</span> <span class="n">folder_CVID</span><span class="p">}</span>
                        <span class="p">}</span>
                        <span class="n">folder</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">file_metadata</span>
                                                               <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;folder created on GDrive: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">folder</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Now creating files inside the folder&#39;</span><span class="p">)</span>

                    <span class="c1"># Walk the tree.</span>
                    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_DOCUMENT_DIRECTORY</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                            <span class="c1"># Join the two strings in order to form the full filepath.</span>
                            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;uploading file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">file_path</span><span class="p">)</span>
                            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filename: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>

                            <span class="n">media_body</span> <span class="o">=</span> <span class="n">MediaFileUpload</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">resumable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Uploaded by script&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;CVID&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())},</span>
                                <span class="s1">&#39;parents&#39;</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="n">folder</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                                <span class="p">]</span>
                            <span class="p">}</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
                                    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">body</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">body</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/vnd.google-apps.document&#39;</span>
                            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                                    <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">media_body</span><span class="o">=</span><span class="n">media_body</span><span class="p">,</span>
                                    <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;name,parents,id,properties,md5Checksum,mimeType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                            <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="c1"># If the error is a rate limit, connection error or backend error,</span>
                                <span class="c1"># wait and try again.</span>

                                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">403</span><span class="p">,</span> <span class="mi">429</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;HTTPError </span><span class="si">{0}</span><span class="s1"> got from Google Server. Waiting for 10 seconds before checking the status&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                                    <span class="c1"># This is backend error from Google so we need the check whether the entity exists</span>
                                    <span class="c1"># If the entity exists, get the details and save into local db.</span>
                                    <span class="c1"># Retry if the entity doesn&#39;t exist</span>
                                    <span class="n">request_file</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                                        <span class="n">q</span><span class="o">=</span><span class="s2">&quot;name = &#39;&quot;</span> <span class="o">+</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; and &#39;&quot;</span> <span class="o">+</span> <span class="n">folder</span><span class="p">[</span>
                                            <span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">request_file</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;file was not found on Gdrive. Uploading again&#39;</span><span class="p">)</span>
                                        <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                                            <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">media_body</span><span class="o">=</span><span class="n">media_body</span><span class="p">,</span>
                                            <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;name,parents,id,properties,md5Checksum,mimeType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File uploaded successfully&#39;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;file was uploaded. Fetching the details and storing in local db&#39;</span><span class="p">)</span>
                                        <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                            <span class="n">fileId</span><span class="o">=</span><span class="n">request_file</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                            <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;name,parents,id,properties,md5Checksum,mimeType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span>
                            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;folder_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder_CVID</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_into_table</span><span class="p">(</span>
                                <span class="n">userID</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_TABLE</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;req json: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File uploaded successfully&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s1">&#39;Exception while creating files in user GDrive&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;101&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="GDrive.files_op"><a class="viewcode-back" href="../../../Application.CloudApps.html#Application.CloudApps.cloud_apps.GDrive.files_op">[docs]</a>    <span class="k">def</span> <span class="nf">files_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to perform various operations on user&#39;s GDRive</span>

<span class="sd">                Args:</span>

<span class="sd">                    optype  (str)  --  Type of operation to perform.</span>

<span class="sd">                                        Valid Values:</span>

<span class="sd">                                        delete - To delete the Automation folder on GDrive</span>

<span class="sd">                                        download - To download files from Automation folder on GDrive</span>

<span class="sd">                                        compare - To compare files after restore</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
                <span class="n">userid</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMTPAddress&#39;</span><span class="p">)</span>

                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">userid</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_TABLE</span><span class="p">)</span>
                <span class="n">folder_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;parents&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;folder id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">folder_id</span><span class="p">)</span>

                <span class="n">gdrive_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_object</span><span class="o">.</span><span class="n">build_service</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="n">delegated_user</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">optype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting the folder: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">folder_id</span><span class="p">)</span>

                    <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fileId</span><span class="o">=</span><span class="n">folder_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GDrive folder deleted successfully&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">optype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downloading the files&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">files</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                                <span class="s2">&quot;application/vnd.google-apps.*&quot;</span><span class="p">,</span>
                                <span class="n">files</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;application/vnd.google-apps.script&#39;</span><span class="p">:</span>
                            <span class="n">file_request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">export_media</span><span class="p">(</span>
                                <span class="n">fileId</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">mimeType</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.google-apps.script&#39;</span><span class="p">:</span>
                            <span class="n">file_request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">export_media</span><span class="p">(</span>
                                <span class="n">fileId</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">mimeType</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">file_request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">get_media</span><span class="p">(</span><span class="n">fileId</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DOWNLOAD_DIRECTORY</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DOWNLOAD_DIRECTORY</span><span class="p">)</span>
                        <span class="n">fh</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">constants</span><span class="o">.</span><span class="n">DOWNLOAD_DIRECTORY</span><span class="p">,</span>
                                <span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)),</span>
                            <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                        <span class="n">downloader</span> <span class="o">=</span> <span class="n">MediaIoBaseDownload</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">file_request</span><span class="p">)</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">while</span> <span class="n">done</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">status</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">next_chunk</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Download </span><span class="si">%d%%</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">progress</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">optype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;compare&#39;</span><span class="p">:</span>

                    <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s2">&quot;name = &#39;&quot;</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_FOLDER</span> <span class="o">+</span>
                                                          <span class="s2">&quot;&#39; and mimeType = &#39;application/vnd.google-apps.folder&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request json: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                    <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">parent_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="n">files_list</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span>
                    <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
                        <span class="n">page_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                            <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">parent_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">,</span> <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;compare json: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parent ID: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parent_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of Backed up documents: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of restored documents: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files_list</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_list</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Number of restored documents is different than the number of backedup documents.&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;106&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">file_metadata</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
                        <span class="n">request_checksum_json</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">fileId</span><span class="o">=</span><span class="n">file_metadata</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;md5Checksum,properties,parents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;md5Checksum json: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_checksum_json</span><span class="p">)</span>

                        <span class="k">if</span> <span class="s1">&#39;md5Checksum&#39;</span> <span class="ow">in</span> <span class="n">request_checksum_json</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">search_md5checksum</span><span class="p">(</span>
                                    <span class="n">request_checksum_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;md5Checksum&#39;</span><span class="p">),</span> <span class="n">userid</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;After restore checksum of file is matching&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checksum did not match after restore:&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;After restore: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">request_checksum_json</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;104&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">optype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;get_properties&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;purging the table before fetching current properties&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">purge_tables</span><span class="p">()</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s2">&quot;name = &#39;&quot;</span> <span class="o">+</span> <span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_FOLDER</span> <span class="o">+</span> \
                                                   <span class="s2">&quot;&#39; and mimeType = &#39;application/vnd.google-apps.folder&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request json: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                    <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">parent_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="n">files_list</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span>
                    <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
                        <span class="n">page_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                            <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">parent_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">,</span> <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">file_metadata</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
                        <span class="n">file_json</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">fileId</span><span class="o">=</span><span class="n">file_metadata</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;name,parents,id,properties,md5Checksum,mimeType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving file json to db: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_json</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save_into_table</span><span class="p">(</span>
                            <span class="n">userid</span><span class="p">,</span> <span class="n">file_json</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">GDRIVE_TABLE</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">optype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;delete_files&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;deleting files inside the folder&#39;</span><span class="p">)</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                        <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">folder_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                    <span class="n">files_list</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span>
                    <span class="k">while</span> <span class="s1">&#39;nextPageToken&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
                        <span class="n">page_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;nextPageToken&#39;</span><span class="p">]</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                            <span class="n">q</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">folder_id</span> <span class="o">+</span> <span class="s2">&quot;&#39; in parents&quot;</span><span class="p">,</span> <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">file_metadata</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
                        <span class="n">gdrive_service</span><span class="o">.</span><span class="n">files</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fileId</span><span class="o">=</span><span class="n">file_metadata</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fileId deleted from GDrive folder: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_metadata</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Exception in file operations from GDrive&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CVCloudException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APIName</span><span class="p">,</span> <span class="s1">&#39;105&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault Systems® Inc. All Rights Reserved.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>