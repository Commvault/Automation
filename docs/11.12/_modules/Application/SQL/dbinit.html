
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Application.SQL.dbinit &#8212; Commvault Automation 11.12 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Application.SQL.dbinit</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Â©2016 Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Helper file for performing SQL Server initialization operations</span>

<span class="sd">DBInit is the only class defined in this file</span>

<span class="sd">DBInit: Helper class to perform sql server initialization operations</span>

<span class="sd">DBInit:</span>
<span class="sd">    __init__()                      --  initializes SQL Server helper object</span>
<span class="sd">    </span>
<span class="sd">    db_new_create()                 --  creates databases based on test case needs</span>
<span class="sd">    </span>
<span class="sd">    check_database()                --  checks if database already exists</span>
<span class="sd">    </span>
<span class="sd">    drop_databases()                --  drops databases</span>
<span class="sd">    </span>
<span class="sd">    kill_db_connections()           --  kill database connections</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="c1"># from AutomationUtils import cvhelper</span>


<div class="viewcode-block" id="DBInit"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit">[docs]</a><span class="k">class</span> <span class="nc">DBInit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform SQL Server initialization operations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_sqluser</span><span class="p">,</span> <span class="n">_sqlpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SQLHelper object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlClient</span> <span class="o">=</span> <span class="n">_sqlclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span> <span class="o">=</span> <span class="n">_sqlinstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span> <span class="o">=</span> <span class="n">_sqluser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span> <span class="o">=</span> <span class="n">_sqlpass</span>

<div class="viewcode-block" id="DBInit.db_new_create"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.db_new_create">[docs]</a>    <span class="k">def</span> <span class="nf">db_new_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">nooffilegroupsdb</span><span class="p">,</span> <span class="n">nooffilesfilegroup</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span><span class="p">,</span>
                      <span class="n">noofrowstable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="o">=</span><span class="s2">&quot;FULL&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function creates as many databases with as many tables specified</span>
<span class="sd">        </span>
<span class="sd">        The databases will be created with the names &quot;databasename+dbnumber&quot; with </span>
<span class="sd">        &quot;tab+dbnumber+filegroupnumber+tablenumber+rownumber&quot;,&quot;tabm+dbnumber+tablenumber+rownumber&quot;</span>
<span class="sd">        </span>
<span class="sd">        This creates as many no of dbs, filegroups, tables for each file group the user requested.</span>
<span class="sd">        </span>
<span class="sd">        On success returns True else False</span>

<span class="sd">        dbname                 : database name</span>
<span class="sd">        noofdbs                : No.of databases to be created</span>
<span class="sd">        nooffilegroupsdb       : No.of file groups for each database</span>
<span class="sd">        nooffilesfilegroup     : No.of files for each file group</span>
<span class="sd">        nooftablesfilegroup    : No.of file for each file group</span>
<span class="sd">        noofrowstable          : No.of rows for each table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT SUBSTRING(physical_name, 1, CHARINDEX(N&#39;master.mdf&#39;, LOWER(physical_name)) - 1) &quot;</span> \
                    <span class="s2">&quot;DataFileLocation FROM master.sys.master_files WHERE database_id = 1 AND FILE_ID = 1&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">dbcreationpath</span> <span class="o">=</span> <span class="n">dbpath</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dbcreationpath</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;DataFileLocation&quot;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data Files Creation Path: [</span><span class="si">{0}</span><span class="s2">]&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbcreationpath</span><span class="p">))</span>
            <span class="c1"># creating the tables for each db on ndf</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">noofdbs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dbname1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE DATABASE [</span><span class="si">{0}</span><span class="s2">]&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dbpathname</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">dbname1</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;CREATE DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ON PRIMARY(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span> 
                        <span class="n">dbpathname</span> <span class="o">+</span> <span class="s2">&quot;.mdf&#39;) LOG ON (NAME = &#39;&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;_log&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span> 
                        <span class="n">dbpathname</span> <span class="o">+</span> <span class="s2">&quot;_log.ldf&#39;)&quot;</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE </span><span class="si">{0}</span><span class="s2"> SET RECOVERY </span><span class="si">{1}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nooffilegroupsdb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">file_group1</span> <span class="o">=</span> <span class="s2">&quot;File_group&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILEGROUP [</span><span class="si">{1}</span><span class="s2">]&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File group </span><span class="si">{0}</span><span class="s2"> is created&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_group1</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nooffilegroupsdb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">file_group1</span> <span class="o">=</span> <span class="s2">&quot;file_group&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nooffilesfilegroup</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">filename1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">path1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ndf&quot;</span>
                        <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logdirpath</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="n">path1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logdirpath</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">path1</span>
                        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="s2">&quot;ALTER DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ADD FILE(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">filename1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span> 
                                <span class="n">logdirpath</span> <span class="o">+</span> <span class="s2">&quot;&#39; , SIZE = 1, MAXSIZE = 2MB, FILEGROWTH = 10%) TO FILEGROUP [&quot;</span> <span class="o">+</span> 
                                <span class="n">file_group1</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="s2">&quot;ALTER DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ADD FILE(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">filename1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span> 
                                <span class="n">logdirpath</span> <span class="o">+</span> <span class="s2">&quot;&#39; , SIZE = 10, MAXSIZE = 20MB, FILEGROWTH = 10%) TO FILEGROUP [&quot;</span> <span class="o">+</span> 
                                <span class="n">file_group1</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{0}</span><span class="s2"> is created under file group </span><span class="si">{1}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">file_group1</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nooftablesfilegroup</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                        <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="s2">&quot;create table [dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;](a bigint,c bit,d char(8),&quot;</span>
                            <span class="s2">&quot;e date,f datetime,g datetime2(7),i decimal(18,0),j float,o int,p money,q nchar(10),&quot;</span>
                            <span class="s2">&quot;r ntext,s numeric(18,0),t nvarchar(50),u nvarchar(MAX),v real,w smalldatetime,x &quot;</span>
                            <span class="s2">&quot;smallint,y smallmoney,z text,aa time(7),bb tinyint,cc uniqueidentifier,ff varchar(50),&quot;</span>
                            <span class="s2">&quot;gg varchar(MAX)) ON &quot;</span> <span class="o">+</span> <span class="n">file_group1</span><span class="p">)</span>
                        <span class="c1"># log.info(&quot;\n   {0} is created  &quot; .format(tab1))</span>
                        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">noofrowstable</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># tabname = tab1 + str(z)</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;].[dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;] VALUES &quot;</span> \
                                    <span class="s2">&quot;( 123456789,&#39;True&#39;,&#39;dvsdv&#39;,&#39;2009-11-19&#39;,&#39;2009-11-19 11:01:30.000&#39;,&quot;</span> \
                                    <span class="s2">&quot;&#39;2009-02-12 12:30:15.1234567&#39;,686868,66.666869,32,$30000,&#39;comm&#39;,&quot;</span> \
                                    <span class="s2">&quot;&#39;cvcvcvcvcvcvc&#39;,686868,&#39;commvault&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> \
                                    <span class="s2">&quot;&#39;,56.56565,&#39;2009-01-01 03:50:00&#39;,1,$1000,&#39;comm&#39;,&#39;12:30:15.1234567&#39;,0,&quot;</span> \
                                     <span class="s2">&quot;&#39;6F9619FF-8B86-D011-B42D-00C04FC964FF&#39;,&#39;commvault&#39;,&#39;cvcvcvcvcvcvcvc&#39;)&quot;</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="c1"># creating the tables for each db on mdf</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">noofdbs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dbname1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nooftablesfilegroup</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                    <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tabm&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;create table [dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;](a bigint,c bit,d char(8),e date,f datetime,g datetime2(7),i &quot;</span>
                        <span class="s2">&quot;decimal(18,0),j float,o int,p money,q nchar(10),r ntext,s numeric(18,0),t nvarchar(50),u &quot;</span>
                        <span class="s2">&quot;nvarchar(MAX),v real,w smalldatetime,x smallint,y smallmoney,z text,aa time(7),bb tinyint,cc &quot;</span>
                        <span class="s2">&quot;uniqueidentifier,ff varchar(50),gg varchar(MAX))&quot;</span><span class="p">)</span>
                    <span class="c1"># log.info(&quot;\n   {0} is created  &quot; .format(tab1))</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">noofrowstable</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># tabname = tab1 + str(z)</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;].[dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;] VALUES &quot;</span> \
                                <span class="s2">&quot;( 123456789,&#39;True&#39;,&#39;dvsdv&#39;,&#39;2009-11-19&#39;,&#39;2009-11-19 11:01:30.000&#39;,&quot;</span> \
                                <span class="s2">&quot;&#39;2009-02-12 12:30:15.1234567&#39;,686868,66.666869,32,$30000,&#39;comm&#39;,&#39;cvcvcvcvcvcvc&#39;,&quot;</span> \
                                <span class="s2">&quot;686868,&#39;commvault&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;,56.56565,&#39;2009-01-01 &quot;</span> \
                                <span class="s2">&quot;03:50:00&#39;,1,$1000,&#39;comm&#39;,&#39;12:30:15.1234567&#39;,0,&#39;6F9619FF-8B86-D011-B42D-00C04FC964FF&#39;&quot;</span> \
                                <span class="s2">&quot;,&#39;commvault&#39;,&#39;cvcvcvcvcvcvcvc&#39;)&quot;</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in db_new_create()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.add_filegroup_and_file"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.add_filegroup_and_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_filegroup_and_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">logdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function adds the file group to database. On success it returns True else False</span>

<span class="sd">        dbname              : database name to add filegroup to</span>
<span class="sd">        filegroupname       : name of filegroup to add</span>
<span class="sd">        filename            : name of file for filegroup</span>
<span class="sd">        logdir              : directory of testcase temp file logging</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">tclogdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILEGROUP [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">))</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILE(NAME = N&#39;</span><span class="si">{1}</span><span class="s2">&#39;, FILENAME = N&#39;</span><span class="si">{2}</span><span class="s2">&#39;, SIZE = 20, MAXSIZE = 30MB, &quot;</span>
                           <span class="s2">&quot;FILEGROWTH = 10%) TO FILEGROUP [</span><span class="si">{3}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tclogdir</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in add_filegroup_and_file()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.check_database"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.check_database">[docs]</a>    <span class="k">def</span> <span class="nf">check_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function checks for the dataBase, If database exists it returns True else False</span>

<span class="sd">        databasename         : database name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">databasename</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database </span><span class="si">{0}</span><span class="s2"> Already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database </span><span class="si">{0}</span><span class="s2"> does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in check_database</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.drop_databases"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.drop_databases">[docs]</a>    <span class="k">def</span> <span class="nf">drop_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function drops the database for the given test case.</span>
<span class="sd">        On success it returns True else False</span>

<span class="sd">        databasename        : database name</span>
<span class="sd">        useexistingdb       : using existing db or not(True or False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">useexistingdb</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">databasename</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">68</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">68</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_db_connections</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to kill database connection.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop database [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">databasename</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is dropped &quot;</span> <span class="o">%</span> <span class="n">databasename</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">databasename</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_db_connections</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to kill database connection.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop database [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">db</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> database dropped&quot;</span> <span class="o">%</span> <span class="n">db</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in drop_databases()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.kill_db_connections"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.kill_db_connections">[docs]</a>    <span class="k">def</span> <span class="nf">kill_db_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function kills the list of open connections to the given DataBase</span>
<span class="sd">        If success returns True else False</span>

<span class="sd">        databasename        : database name</span>
<span class="sd">        noofdbs             : Number of databases to be dropped</span>
<span class="sd">        useexistingdb       : use existing db or not(True or False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlinstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span>
            <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">useexistingdb</span><span class="p">:</span>
                <span class="n">dbflag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbflag</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span>
                                <span class="s1">&#39;SQL&#39;</span><span class="p">,</span> <span class="s1">&#39;Scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;KillDBConnections.sql&#39;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;sqlcmd -i </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> -v databasename =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">databasename</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> \
                  <span class="s2">&quot;dbcount =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noofdbs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> dbflag =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbflag</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> -U &quot;</span> <span class="o">+</span> \
                  <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span> <span class="o">+</span> <span class="s2">&quot; -P &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span> <span class="o">+</span> <span class="s2">&quot; -S </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">sqlinstance</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>

            <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in kill_db_connections()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBInit.set_database_offline"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.set_database_offline">[docs]</a>    <span class="k">def</span> <span class="nf">set_database_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function sets the database to offline.</span>
<span class="sd">        If success it returns True else False</span>
<span class="sd">    </span>
<span class="sd">        dataBaseName         : database name</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] SET OFFLINE WITH ROLLBACK IMMEDIATE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> database is offline&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in set_database_offline()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.restart_sqlserver_services"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.restart_sqlserver_services">[docs]</a>    <span class="k">def</span> <span class="nf">restart_sqlserver_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this function restarts the services of sql server</span>
<span class="sd">        if success returns True else False</span>
<span class="sd">    </span>
<span class="sd">        action              :   1 = Restart Services (default)</span>
<span class="sd">                                2 = Stop Services </span>
<span class="sd">                                3 = Start Services</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="n">sqlinstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span>
        <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
                <span class="c1"># STOP SERVICES</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping the SQL Server Services&quot;</span><span class="p">)</span>
                    <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net stop </span><span class="se">\&quot;</span><span class="s2">SQL Server Agent (</span><span class="si">{0}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                    <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while stopping SQL Server Agent&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net stop </span><span class="se">\&quot;</span><span class="s2">SQL Server (</span><span class="si">%s</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                    <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while services are stopping.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

                <span class="c1"># START SERVICES</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting the SQL Server services&quot;</span><span class="p">)</span>
                    <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net action </span><span class="se">\&quot;</span><span class="s2">SQL Server (</span><span class="si">%s</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                    <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while services are starting.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in restart_sqlserver_services()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBInit.rename_database"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.rename_database">[docs]</a>    <span class="k">def</span> <span class="nf">rename_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function renames the database by appending some random characters&quot;</span>
<span class="sd">        On success returns (renamed database, True) else (1, False)</span>
<span class="sd">    </span>
<span class="sd">        dataBaseName         : database name</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ransum</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                <span class="n">ransum</span> <span class="o">=</span> <span class="n">ransum</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">)</span>

            <span class="n">database_rename</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ransum</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] MODIFY NAME = [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="n">database_rename</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">database_rename</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in rename_database()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.change_recovery_model"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.dbinit.DBInit.change_recovery_model">[docs]</a>    <span class="k">def</span> <span class="nf">change_recovery_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function changes the recovery model for specified databases. On success returns True else False</span>
<span class="sd">    </span>
<span class="sd">        databasename         : Database name</span>
<span class="sd">        noofdbs              : Number of DBs to change recovery model</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">noofdbs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}{1}</span><span class="s2">] SET RECOVERY </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">))</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised  in change_recovery_model()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault SystemsÂ® Inc. All Rights Reserved.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>