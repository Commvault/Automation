
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Application.SQL.sqlhelper &#8212; Commvault Automation 11.12 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Application.SQL.sqlhelper</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Â©2016 Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main helper file for performing SQL Server operations</span>

<span class="sd">SQLAutomation, SQLHelper, DBInit, DBValidate, ModifyDatabase are the only classes defined in this file</span>

<span class="sd">SQLAutomation: Helper class to initialize objects for SQLHelper</span>

<span class="sd">SQLHelper: Helper class to perform sql server operations</span>

<span class="sd">DBInit: Helper class to perform SQL Server initialization operations</span>

<span class="sd">DBValidate: Helper class to perform SQL Server validation operations</span>

<span class="sd">ModifyDatabase: Helper class to perform SQL Server modification operations</span>

<span class="sd">SQLAutomation:</span>

<span class="sd">    __init__()                      --  initializes SQL Automation Helper objects for SQLHelper</span>
<span class="sd">    </span>
<span class="sd">SQLHelper:</span>

<span class="sd">    __init__()                      --  initializes SQL Server helper object</span>
<span class="sd">    </span>
<span class="sd">    sql_setup()                     --  This function creates the sql setup environment by creating testcase directory, </span>
<span class="sd">    databases and subclient.</span>

<span class="sd">    create_subclient()              --  This function creates SQL subclient and assign necessary properties</span>

<span class="sd">    get_sql_backup_end_time()       --  This function gets the last backup finish time for a sql backup jobid</span>
<span class="sd">    </span>
<span class="sd">    get_file_list_restore()         --  This function constructs a list of SQL databases and their files for restore</span>
<span class="sd">    </span>
<span class="sd">    sql_restore()                   --  This function is the restore function for SQL restore operations</span>

<span class="sd">DBInit:</span>

<span class="sd">    __init__()                      --  initializes SQL Server helper object</span>
<span class="sd">    </span>
<span class="sd">    db_new_create()                 --  This function creates databases based on test case needs</span>
<span class="sd">    </span>
<span class="sd">    add_filegroup_and_file()        --  This function adds a file group to the database</span>
<span class="sd">    </span>
<span class="sd">    check_database()                --  This function checks if the database already exists</span>
<span class="sd">    </span>
<span class="sd">    drop_databases()                --  This function drops databases</span>
<span class="sd">    </span>
<span class="sd">    kill_db_connections()           --  This function kills database connections</span>
<span class="sd">    </span>
<span class="sd">    set_database_offline()          --  This function sets the database in offline state</span>
<span class="sd">    </span>
<span class="sd">    restart_sqlserver_services()    --  This function restarts SQL Server services</span>
<span class="sd">    </span>
<span class="sd">    rename_database()               --  This function renames the database by appending random characters</span>
<span class="sd">    </span>
<span class="sd">    change_recovery_model()         --  This function changes the recovery model of the database</span>
<span class="sd">    </span>
<span class="sd">DBValidate:</span>

<span class="sd">    __init__()                              --  initializes SQL Server helper object</span>
<span class="sd">    </span>
<span class="sd">    get_random_db_names_and_filegroups()    --  This function shuffles the database tables and returns some table names</span>
<span class="sd">    </span>
<span class="sd">    dump_db_to_file()                       --  This function writes the database tables to file</span>
<span class="sd">    </span>
<span class="sd">    db_compare()                            --  This function compares two files</span>
<span class="sd">    </span>
<span class="sd">    is_db_online()                          --  This function checks to see if specified databases are online.</span>
<span class="sd">    </span>
<span class="sd">    get_sql_backup_type()                   --  This function returns the type of backup for a job</span>
<span class="sd">    </span>
<span class="sd">    db_path()                               --  This function returns the database file paths for a database</span>

<span class="sd">    get_access_states()                     --  This function returns list of access states for a database.</span>

<span class="sd">    get_tempdb_create_time()                --  This function returns the creation date/time of tempdb</span>
<span class="sd">    </span>
<span class="sd">    get_database_tables()                   --  This function returns a list of table names for the given database</span>
<span class="sd">    </span>
<span class="sd">    get_database_state()                    --  This function returns state of the given database</span>
<span class="sd">    </span>
<span class="sd">ModifyDatabase:</span>

<span class="sd">    __init__()                              --  initializes SQL Server helper object</span>
<span class="sd">    </span>
<span class="sd">    modify_db_for_inc()                     --  This function adds additional data to the target databases   </span>

<span class="sd">    modify_db_for_diff()                    --  This function adds additional data to the target databases</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">sqlconstants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>

<span class="n">global_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<div class="viewcode-block" id="SQLAutomation"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLAutomation">[docs]</a><span class="k">class</span> <span class="nc">SQLAutomation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to initialize SQL Helper objects</span>

<span class="sd">    Args:</span>
<span class="sd">        _sqlclient (str): Name of the client</span>
<span class="sd">        _sqlinstance (str): Name of the SQL instance</span>
<span class="sd">        _sqluser (str): SQL user name</span>
<span class="sd">        _sqlpass (str): SQL password</span>
<span class="sd">        _tcobject (:obj:&#39;CVTestCase&#39;): test case object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcobject</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_sqluser</span><span class="p">,</span> <span class="n">_sqlpass</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">_tcobject</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlClient</span> <span class="o">=</span> <span class="n">_sqlclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlInstance</span> <span class="o">=</span> <span class="n">_sqlinstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlUser</span> <span class="o">=</span> <span class="n">_sqluser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlPass</span> <span class="o">=</span> <span class="n">_sqlpass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span> <span class="o">=</span> <span class="n">_tcobject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">get_csdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="SQLHelper"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper">[docs]</a><span class="k">class</span> <span class="nc">SQLHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform SQL Server operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">global_lock</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcobject</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_sqluser</span><span class="p">,</span> <span class="n">_sqlpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SQLHelper object</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            _sqlclient (str): Name of the client</span>
<span class="sd">            _sqlinstance (str): Name of the SQL instance</span>
<span class="sd">            _sqluser (str): SQL user name</span>
<span class="sd">            _sqlpass (str): SQL password</span>
<span class="sd">            _tcobject (:obj:&#39;CVTestCase&#39;): test case object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span> <span class="o">=</span> <span class="n">SQLAutomation</span><span class="p">(</span><span class="n">_tcobject</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_sqluser</span><span class="p">,</span> <span class="n">_sqlpass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbinit</span> <span class="o">=</span> <span class="n">DBInit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbvalidate</span> <span class="o">=</span> <span class="n">DBValidate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifydatabase</span> <span class="o">=</span> <span class="n">ModifyDatabase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcontent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tctime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noof_dbs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noof_ffg_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noof_files_ffg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noof_tables_ffg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noof_rows_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storagepolicy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_setup</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="SQLHelper.sql_setup"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.sql_setup">[docs]</a>    <span class="k">def</span> <span class="nf">sql_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">noof_dbs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">noof_ffg_db</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                  <span class="n">noof_files_ffg</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                  <span class="n">noof_tables_ffg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">noof_rows_table</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">db_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">snap_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">library_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">media_agent</span><span class="o">=</span><span class="kc">None</span>
                  <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates the sql setup environment by creating testcase directory, databases and subclient.</span>
<span class="sd">         </span>
<span class="sd">        Args:</span>
<span class="sd">            storagepolicy (str): Name of storage policy to assign to subclient</span>
<span class="sd">            </span>
<span class="sd">            noof_dbs (int): Number of databases to create</span>
<span class="sd">            </span>
<span class="sd">            noof_ffg_db (int): Number of file groups per database to create</span>
<span class="sd">            </span>
<span class="sd">            noof_files_ffg (int): Number of files per file groups to create</span>
<span class="sd">            </span>
<span class="sd">            noof_tables_ffg (int): Number of tables per file groups to create</span>
<span class="sd">            </span>
<span class="sd">            noof_rows_table (int): Number of rows per table to create</span>
<span class="sd">            </span>
<span class="sd">            db_path (str): Directory path where to create databases. Default location is SQL Server default data path</span>
<span class="sd">            </span>
<span class="sd">            snap_setup (bool): Boolean whether this setup is for a snap setup or not</span>
<span class="sd">            </span>
<span class="sd">            library_name (str): Name of library to use for storage policy creation</span>
<span class="sd">            </span>
<span class="sd">            media_agent (str): Name of media agent to use for storage policy creation</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">)</span>
        <span class="n">tc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">id</span>
        <span class="n">logdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">log_dir</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">sptime</span> <span class="o">=</span> <span class="n">time1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Temporary until storage policy deletion is fixed. MR 209662</span>
        <span class="n">subclientname</span> <span class="o">=</span> <span class="s2">&quot;Subclient</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tc_id</span><span class="p">,</span> <span class="n">time1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># set storage policy name if not given</span>
            <span class="k">if</span> <span class="n">storagepolicy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">library_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">media_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">storagepolicy</span> <span class="o">=</span> <span class="s2">&quot;SQLSP_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tc_id</span><span class="p">,</span> <span class="n">sptime</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">storagepolicy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">snap_setup</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please provide valid storage policy or library and media agent.&quot;</span><span class="p">)</span>

            <span class="c1"># generate a random database name</span>
            <span class="n">ransum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                <span class="n">ransum</span> <span class="o">=</span> <span class="n">ransum</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">)</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">ransum</span>

            <span class="c1"># build temporary testcase logging directory and create it</span>
            <span class="n">tcdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">tc_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">ransum</span><span class="p">))</span>
            <span class="n">sqlmachine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">tcdir</span><span class="p">)</span>

            <span class="c1"># SQL linux require that the destination path of the databases is owned by mssql user.</span>
            <span class="k">if</span> <span class="n">sqlmachine</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;unix&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sqlmachine</span><span class="o">.</span><span class="n">change_folder_owner</span><span class="p">(</span><span class="s2">&quot;mssql&quot;</span><span class="p">,</span> <span class="n">tcdir</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to change directory owner. &quot;</span><span class="p">)</span>

            <span class="c1"># build list for subclient content</span>
            <span class="n">subcontent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noof_dbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subcontent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

            <span class="c1"># perform database check if exists, if so, drop it first.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbinit</span><span class="o">.</span><span class="n">check_database</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbinit</span><span class="o">.</span><span class="n">drop_databases</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop the database&quot;</span><span class="p">)</span>

            <span class="c1"># create databases</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Creating database [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbinit</span><span class="o">.</span><span class="n">db_new_create</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">noof_dbs</span><span class="p">,</span> <span class="n">noof_ffg_db</span><span class="p">,</span>
                                             <span class="n">noof_files_ffg</span><span class="p">,</span> <span class="n">noof_tables_ffg</span><span class="p">,</span> <span class="n">noof_rows_table</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="n">db_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create databases.&quot;</span><span class="p">)</span>

            <span class="c1"># if this is snap setup then create storage policy and snap copy</span>
            <span class="k">if</span> <span class="n">snap_setup</span><span class="p">:</span>
                <span class="n">sp_snap_copy</span> <span class="o">=</span> <span class="s2">&quot;SQLSnap_Copy_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tc_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">storagepolicy</span><span class="p">):</span>
                    <span class="n">storagepolicyname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">storagepolicy</span><span class="p">,</span>
                                                                                                  <span class="n">library_name</span><span class="p">,</span>
                                                                                                  <span class="n">media_agent</span><span class="p">,</span>
                                                                                                  <span class="n">number_of_streams</span><span class="o">=</span><span class="mi">10</span>
                                                                                                  <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storagepolicyname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storagepolicy</span><span class="p">)</span>
                <span class="n">storagepolicyname</span><span class="o">.</span><span class="n">create_secondary_copy</span><span class="p">(</span><span class="n">sp_snap_copy</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">snap_copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">library_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">media_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">storagepolicy</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">storagepolicy</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">)</span>

            <span class="c1"># create subclient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Creating subclient [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subclient</span><span class="p">(</span><span class="n">subclientname</span><span class="p">,</span> <span class="n">subcontent</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create subclient.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subcontent</span> <span class="o">=</span> <span class="n">subcontent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcdir</span> <span class="o">=</span> <span class="n">tcdir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tctime</span> <span class="o">=</span> <span class="n">time1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noof_dbs</span> <span class="o">=</span> <span class="n">noof_dbs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noof_ffg_db</span> <span class="o">=</span> <span class="n">noof_ffg_db</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noof_files_ffg</span> <span class="o">=</span> <span class="n">noof_files_ffg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noof_tables_ffg</span> <span class="o">=</span> <span class="n">noof_tables_ffg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noof_rows_table</span> <span class="o">=</span> <span class="n">noof_rows_table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storagepolicy</span> <span class="o">=</span> <span class="n">storagepolicy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_setup</span> <span class="o">=</span> <span class="n">snap_setup</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sql_setup()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="SQLHelper.create_subclient"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.create_subclient">[docs]</a>    <span class="k">def</span> <span class="nf">create_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclientname</span><span class="p">,</span> <span class="n">subcontent</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">,</span>
                         <span class="n">subclient_type</span><span class="o">=</span><span class="n">sqlconstants</span><span class="o">.</span><span class="n">SUBCLIENT_DATABASE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function makes the necessary calls and assignments to create a SQL subclient.</span>

<span class="sd">        Args:</span>
<span class="sd">            subclientname (str): Name of subclient to be created </span>
<span class="sd">            subcontent (list): Content to add to subclient</span>
<span class="sd">            storagepolicy (str): Storage policy to assign to subclient</span>
<span class="sd">            subclient_type (str, Optional): Type of sql subclient to create: DATABASE or FILE_FILEGROUP.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subclientname</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">,</span> <span class="n">subclient_type</span><span class="o">=</span><span class="n">subclient_type</span><span class="p">)</span>
            <span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">log_backup_storage_policy</span> <span class="o">=</span> <span class="n">storagepolicy</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">subcontent</span>

            <span class="n">request_json</span> <span class="o">=</span> <span class="n">sqlconstants</span><span class="o">.</span><span class="n">SQL_SUBCLIENT_PROP_DICT</span>

            <span class="n">subclient_prop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_mssql_subclient_prop&quot;</span><span class="p">,</span> <span class="n">request_json</span><span class="p">]</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">mssql_subclient_prop</span> <span class="o">=</span> <span class="n">subclient_prop</span>

            <span class="n">request_json</span> <span class="o">=</span> <span class="n">sqlconstants</span><span class="o">.</span><span class="n">SQL_SUBCLIENT_STORAGE_DICT</span>

            <span class="n">subclient</span><span class="o">.</span><span class="n">mssql_subclient_prop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_commonProperties[&#39;storageDevice&#39;]&quot;</span><span class="p">,</span> <span class="n">request_json</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_subclient()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SQLHelper.get_sql_backup_end_time"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.get_sql_backup_end_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_backup_end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">timeformat</span><span class="o">=</span><span class="s2">&quot;datestringformat&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function gets the last backup finish time for a sql backup jobid</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str): Job id that we are checking end time of</span>
<span class="sd">            timeformat (str): Time format either unixformat or datestringformat</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: sql backup end time for entire job </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">epochtime</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get getSqlBackupFinishTime for a given backup job [&quot;</span> <span class="o">+</span> <span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select max(backup_finish_Date) from sqlDbBackupInfo where jobid = &#39;&quot;</span> <span class="o">+</span> <span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">epochtime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">timeformat</span> <span class="o">==</span> <span class="s2">&quot;unixformat&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">epochtime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting EpochSeconds: &#39;</span><span class="si">{0}</span><span class="s2">&#39; to YYYY/MM/DD HH:MM:SS Format&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">epochtime</span><span class="p">)))</span>
                <span class="n">datetimeobj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">epochtime</span><span class="p">)</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">datetimeobj</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">endtime</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in getSqlBackupFinishTime()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SQLHelper.get_file_list_restore"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.get_file_list_restore">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_list_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_list</span><span class="p">,</span> <span class="n">restore_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filerename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function compiles the file list needed for performing out of place restores</span>

<span class="sd">        Args:</span>
<span class="sd">            database_list (list): List of dicts of original database names and names to be restored </span>
<span class="sd">            restore_path (str, Optional): Path of where to restore databases to</span>
<span class="sd">            filerename (bool, Optional): If True the files names will be prefixed with newName_, if False then the file</span>
<span class="sd">            names will remain the same as they were on the source.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of paths for all database files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbvalidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbvalidate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ransum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">restore_path_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                <span class="n">ransum</span> <span class="o">=</span> <span class="n">ransum</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">db_dict</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_dict</span><span class="p">:</span>
                    <span class="n">db</span> <span class="o">=</span> <span class="n">db_dict</span><span class="p">[</span><span class="n">database</span><span class="p">][</span><span class="n">sqlconstants</span><span class="o">.</span><span class="n">DATABASE_ORIG_NAME</span><span class="p">]</span>
                    <span class="n">dbrename</span> <span class="o">=</span> <span class="n">db_dict</span><span class="p">[</span><span class="n">database</span><span class="p">][</span><span class="n">sqlconstants</span><span class="o">.</span><span class="n">DATABASE_NEW_NAME</span><span class="p">]</span>
                    <span class="n">listfg</span><span class="p">,</span> <span class="n">listdb</span> <span class="o">=</span> <span class="n">dbvalidate</span><span class="o">.</span><span class="n">db_path</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

                    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listdb</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">listfg</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="n">orig_path</span><span class="p">,</span> <span class="n">orig_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">restore_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># If restore path not passed in take path of original</span>
                            <span class="n">restore_path</span> <span class="o">=</span> <span class="n">orig_path</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">filerename</span><span class="p">:</span>  <span class="c1"># If file rename is false keep the original file names</span>
                            <span class="n">restore_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqlconstants</span><span class="o">.</span><span class="n">VDI_RESTORE_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">db</span><span class="p">,</span> <span class="n">dbrename</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">restore_path</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># use new file names</span>
                            <span class="n">file_name</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                            <span class="n">new_file</span> <span class="o">=</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ransum</span> <span class="o">+</span> <span class="n">file_ext</span>
                            <span class="n">restore_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqlconstants</span><span class="o">.</span><span class="n">VDI_RESTORE_FORMAT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">db</span><span class="p">,</span> <span class="n">dbrename</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">restore_path</span><span class="p">,</span> <span class="n">new_file</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                        <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">restore_path_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_file_list_restore()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SQLHelper.sql_backup"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.sql_backup">[docs]</a>    <span class="k">def</span> <span class="nf">sql_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function initiates a backup job, waits for completion, and validates the number of databases backed up</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            backup_type (str): Type of backup to run: Full, Differential, Transaction_Log</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Job id of backup job</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Starting Subclient </span><span class="si">{0}</span><span class="s2"> Backup &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started </span><span class="si">{0}</span><span class="s2"> backup with Job ID: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run </span><span class="si">{0}</span><span class="s2"> backup job with error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">backup_type</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;Completed&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished </span><span class="si">{0}</span><span class="s2"> backup job&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Backup job </span><span class="si">{0}</span><span class="s2"> did not complete successfully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1"># sql vdi objects equal 2 per database whereas snap objects are 1 per database</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">snap_setup</span><span class="p">:</span>
                <span class="n">j_details</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">details</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">j_details</span><span class="p">[</span><span class="s1">&#39;jobDetail&#39;</span><span class="p">][</span><span class="s1">&#39;detailInfo&#39;</span><span class="p">][</span><span class="s1">&#39;numOfObjects&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to backup all databases in subclient&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sql_backup()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SQLHelper.sql_restore"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.SQLHelper.sql_restore">[docs]</a>    <span class="k">def</span> <span class="nf">sql_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">job_delay_reason</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restore_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function makes the necessary calls and assignments to perform a SQL restore.</span>

<span class="sd">        Args:</span>
<span class="sd">            content (list): Content to add to subclient</span>
<span class="sd">            timeout (int, optional): Timeout value to wait for job completion</span>
<span class="sd">            job_delay_reason (str, optional): Job delay reason</span>
<span class="sd">            restore_count (int, optional): Expected database objects as success</span>
<span class="sd">        </span>
<span class="sd">        Keyword Args:</span>
<span class="sd">            restore_path (str): Path to restore databases to, inplace restore if not specified</span>
<span class="sd">            drop_connections_to_databse (bool): Drop connections to database</span>
<span class="sd">            overwrite (bool): Overwrite on restore </span>
<span class="sd">            to_time (str): Restore to time</span>
<span class="sd">            sql_restore_type (str): Type of sql restore (database restore, step restore, recovery only)</span>
<span class="sd">            sql_recover_type (str): Type of sql recovery (recover, no recovery, stand by)</span>
<span class="sd">            undo_path (str): File path for undo path for sql server standby restores.</span>
<span class="sd">            restricted_user (bool): Restore database in restricted user mode</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started restore job with job id: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">job_delay_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">job_delay_reason</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Restore did not complete with expected reason.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restore completed with expected reason.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Restore job failed for unexpected reasons. Check log files.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job_delay_reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">j_details</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">details</span>
                <span class="k">if</span> <span class="n">restore_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">restore_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">j_details</span><span class="p">[</span><span class="s1">&#39;jobDetail&#39;</span><span class="p">][</span><span class="s1">&#39;detailInfo&#39;</span><span class="p">][</span><span class="s1">&#39;numOfObjects&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">restore_count</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to restore all databases&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished restore job.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Restore job failed for unexpected reasons. Check log files.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sql_restore()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="DBInit"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit">[docs]</a><span class="k">class</span> <span class="nc">DBInit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform SQL Server initialization operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">global_lock</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sqlautomation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SQLHelper object</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            _sqlautomation (:obj: &#39;SQLAutomation&#39;): Instance of SQLAutomation</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span> <span class="o">=</span> <span class="n">_sqlautomation</span>

<div class="viewcode-block" id="DBInit.db_new_create"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.db_new_create">[docs]</a>    <span class="k">def</span> <span class="nf">db_new_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">nooffilegroupsdb</span><span class="p">,</span> <span class="n">nooffilesfilegroup</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span><span class="p">,</span>
                      <span class="n">noofrowstable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="o">=</span><span class="s2">&quot;FULL&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates as many databases with as many tables specified</span>

<span class="sd">            The databases will be created with the names &quot;databasename+dbnumber&quot; with </span>
<span class="sd">            &quot;tab+dbnumber+filegroupnumber+tablenumber+rownumber&quot;,&quot;tabm+dbnumber+tablenumber+rownumber&quot;</span>
<span class="sd">    </span>
<span class="sd">            This creates as many no of dbs, filegroups, tables for each file group the user requested.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str): Database name</span>
<span class="sd">            noofdbs (int): Number of databases to be created</span>
<span class="sd">            nooffilegroupsdb (int): Number of file groups for each database</span>
<span class="sd">            nooffilesfilegroup (int): Number of files for each file group</span>
<span class="sd">            nooftablesfilegroup (int): Number of files for each file group</span>
<span class="sd">            noofrowstable (int): Number of rows for each table</span>
<span class="sd">            size (int, optional): Database size will be limited to optional size of 1MB if passed. </span>
<span class="sd">                                    Default is 0 which will default to native SQL Server size.</span>
<span class="sd">            dbpath (str, optional): Path where to create databases. Default is SQL Server native location.</span>
<span class="sd">            recoverymodel (str, optional): Create database with specific recovery model. Default is FULL.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT SUBSTRING(physical_name, 1, CHARINDEX(N&#39;master.mdf&#39;, LOWER(physical_name)) - 1) &quot;</span> \
                    <span class="s2">&quot;DataFileLocation FROM master.sys.master_files WHERE database_id = 1 AND FILE_ID = 1&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">dbcreationpath</span> <span class="o">=</span> <span class="n">dbpath</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dbcreationpath</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;DataFileLocation&quot;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data Files Creation Path: [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbcreationpath</span><span class="p">))</span>
            <span class="c1"># creating the tables for each db on ndf</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dbname1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE DATABASE [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dbpathname</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">dbname1</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;CREATE DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ON PRIMARY(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span>
                        <span class="n">dbpathname</span> <span class="o">+</span> <span class="s2">&quot;.mdf&#39;) LOG ON (NAME = &#39;&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;_log&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span>
                        <span class="n">dbpathname</span> <span class="o">+</span> <span class="s2">&quot;_log.ldf&#39;)&quot;</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE </span><span class="si">{0}</span><span class="s2"> SET RECOVERY </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooffilegroupsdb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">file_group1</span> <span class="o">=</span> <span class="s2">&quot;File_group&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILEGROUP [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File group [</span><span class="si">{0}</span><span class="s2">] is created&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_group1</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooffilesfilegroup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">filename1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">path1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.ndf&quot;</span>
                        <span class="k">if</span> <span class="n">dbpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logdirpath</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="n">path1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logdirpath</span> <span class="o">=</span> <span class="n">dbcreationpath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path1</span>
                        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="s2">&quot;ALTER DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ADD FILE(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">filename1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span>
                                <span class="n">logdirpath</span> <span class="o">+</span> <span class="s2">&quot;&#39; , SIZE = 1, MAXSIZE = 2MB, FILEGROWTH = 10%) TO FILEGROUP [&quot;</span> <span class="o">+</span>
                                <span class="n">file_group1</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="s2">&quot;ALTER DATABASE [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;] ADD FILE(NAME = N&#39;&quot;</span> <span class="o">+</span> <span class="n">filename1</span> <span class="o">+</span> <span class="s2">&quot;&#39;, FILENAME = N&#39;&quot;</span> <span class="o">+</span>
                                <span class="n">logdirpath</span> <span class="o">+</span> <span class="s2">&quot;&#39; , SIZE = 10, MAXSIZE = 20MB, FILEGROWTH = 10%) TO FILEGROUP [&quot;</span> <span class="o">+</span>
                                <span class="n">file_group1</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File [</span><span class="si">{0}</span><span class="s2">] is created under file group [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename1</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                        <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="s2">&quot;create table [dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;](a bigint,c bit,d char(8),&quot;</span>
                            <span class="s2">&quot;e date,f datetime,g datetime2(7),i decimal(18,0),j float,o int,p money,q nchar(10),&quot;</span>
                            <span class="s2">&quot;r ntext,s numeric(18,0),t nvarchar(50),u nvarchar(MAX),v real,w smalldatetime,x &quot;</span>
                            <span class="s2">&quot;smallint,y smallmoney,z text,aa time(7),bb tinyint,cc uniqueidentifier,ff varchar(50),&quot;</span>
                            <span class="s2">&quot;gg varchar(MAX)) ON &quot;</span> <span class="o">+</span> <span class="n">file_group1</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofrowstable</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;].[dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;] VALUES &quot;</span> \
                                    <span class="s2">&quot;( 123456789,&#39;True&#39;,&#39;dvsdv&#39;,&#39;2009-11-19&#39;,&#39;2009-11-19 11:01:30.000&#39;,&quot;</span> \
                                    <span class="s2">&quot;&#39;2009-02-12 12:30:15.1234567&#39;,686868,66.666869,32,$30000,&#39;comm&#39;,&quot;</span> \
                                    <span class="s2">&quot;&#39;cvcvcvcvcvcvc&#39;,686868,&#39;commvault&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> \
                                    <span class="s2">&quot;&#39;,56.56565,&#39;2009-01-01 03:50:00&#39;,1,$1000,&#39;comm&#39;,&#39;12:30:15.1234567&#39;,0,&quot;</span> \
                                    <span class="s2">&quot;&#39;6F9619FF-8B86-D011-B42D-00C04FC964FF&#39;,&#39;commvault&#39;,&#39;cvcvcvcvcvcvcvc&#39;)&quot;</span>
                            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="c1"># creating the tables for each db on mdf</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dbname1</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname1</span><span class="p">))</span>
                    <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tabm&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="s2">&quot;create table [dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;](a bigint,c bit,d char(8),e date,f datetime,g datetime2(7),i &quot;</span>
                        <span class="s2">&quot;decimal(18,0),j float,o int,p money,q nchar(10),r ntext,s numeric(18,0),t nvarchar(50),u &quot;</span>
                        <span class="s2">&quot;nvarchar(MAX),v real,w smalldatetime,x smallint,y smallmoney,z text,aa time(7),bb tinyint,cc &quot;</span>
                        <span class="s2">&quot;uniqueidentifier,ff varchar(50),gg varchar(MAX))&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofrowstable</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO [&quot;</span> <span class="o">+</span> <span class="n">dbname1</span> <span class="o">+</span> <span class="s2">&quot;].[dbo].[&quot;</span> <span class="o">+</span> <span class="n">tab1</span> <span class="o">+</span> <span class="s2">&quot;] VALUES &quot;</span> \
                                <span class="s2">&quot;( 123456789,&#39;True&#39;,&#39;dvsdv&#39;,&#39;2009-11-19&#39;,&#39;2009-11-19 11:01:30.000&#39;,&quot;</span> \
                                <span class="s2">&quot;&#39;2009-02-12 12:30:15.1234567&#39;,686868,66.666869,32,$30000,&#39;comm&#39;,&#39;cvcvcvcvcvcvc&#39;,&quot;</span> \
                                <span class="s2">&quot;686868,&#39;commvault&#39;,&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;,56.56565,&#39;2009-01-01 &quot;</span> \
                                <span class="s2">&quot;03:50:00&#39;,1,$1000,&#39;comm&#39;,&#39;12:30:15.1234567&#39;,0,&#39;6F9619FF-8B86-D011-B42D-00C04FC964FF&#39;&quot;</span> \
                                <span class="s2">&quot;,&#39;commvault&#39;,&#39;cvcvcvcvcvcvcvc&#39;)&quot;</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in db_new_create()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.add_filegroup_and_file"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.add_filegroup_and_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_filegroup_and_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">logdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function adds the file group to database.</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str) : Database name to add filegroup to</span>
<span class="sd">            filegroupname (str) : Name of filegroup to add</span>
<span class="sd">            filename (str) : Name of file for filegroup</span>
<span class="sd">            logdir (str) : Directory of testcase temp file logging</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">tclogdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILEGROUP [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">))</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] ADD FILE(NAME = N&#39;</span><span class="si">{1}</span><span class="s2">&#39;, FILENAME = N&#39;</span><span class="si">{2}</span><span class="s2">&#39;, SIZE = 20, MAXSIZE = 30MB, &quot;</span>
                           <span class="s2">&quot;FILEGROWTH = 10%) TO FILEGROUP [</span><span class="si">{3}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tclogdir</span><span class="p">,</span> <span class="n">filegroupname</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in add_filegroup_and_file()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.check_database"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.check_database">[docs]</a>    <span class="k">def</span> <span class="nf">check_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function checks for the dataBase.</span>

<span class="sd">        Args: </span>
<span class="sd">            databasename (str) : Database name</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for exists, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">databasename</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database </span><span class="si">{0}</span><span class="s2"> Already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database </span><span class="si">{0}</span><span class="s2"> does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in check_database</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.drop_databases"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.drop_databases">[docs]</a>    <span class="k">def</span> <span class="nf">drop_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function drops the database for the given test case.</span>

<span class="sd">        Args:</span>
<span class="sd">            databasename (str) : Database name</span>
<span class="sd">            useexistingdb (bool, optional) : Drop all databases with names that contain provided databasename</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="c1"># This code block is to handle specific provided database name only.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">useexistingdb</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">databasename</span> <span class="o">==</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_db_connections</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to kill database connection.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop database [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is dropped from </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># This code block is to handle all databases that contain the provided database name.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.databases&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">databasename</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                        <span class="n">db</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_db_connections</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to kill database connection.&quot;</span><span class="p">)</span>

                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop database [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is dropped from </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>

                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in drop_databases()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.kill_db_connections"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.kill_db_connections">[docs]</a>    <span class="k">def</span> <span class="nf">kill_db_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function kills the list of open connections to the given DataBase</span>

<span class="sd">        Args:</span>
<span class="sd">            databasename (str) : Database name</span>
<span class="sd">            noofdbs (int) : Number of databases to be dropped</span>
<span class="sd">            useexistingdb (bool) : Kill connections for all databases that begin with databasename</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sqlinstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">:</span>
                <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">useexistingdb</span><span class="p">:</span>
                <span class="n">dbflag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dbflag</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span>
                                <span class="s1">&#39;SQL&#39;</span><span class="p">,</span> <span class="s1">&#39;Scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;KillDBConnections.sql&#39;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;sqlcmd -i </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> -v databasename =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">databasename</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> \
                <span class="s2">&quot;dbcount =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noofdbs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> dbflag =</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbflag</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> -U &quot;</span> <span class="o">+</span> \
                  <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span> <span class="o">+</span> <span class="s2">&quot; -P &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span> <span class="o">+</span> <span class="s2">&quot; -S </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">sqlinstance</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>

            <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in kill_db_connections()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBInit.set_database_offline"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.set_database_offline">[docs]</a>    <span class="k">def</span> <span class="nf">set_database_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function sets the database to offline.</span>

<span class="sd">        Args:</span>
<span class="sd">            databasename (str) : Database name</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] SET OFFLINE WITH ROLLBACK IMMEDIATE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> database is offline&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in set_database_offline()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.restart_sqlserver_services"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.restart_sqlserver_services">[docs]</a>    <span class="k">def</span> <span class="nf">restart_sqlserver_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function restarts the services of sql server</span>

<span class="sd">        Args:</span>
<span class="sd">            action (int, optional): 1 = Restart Services (default)</span>
<span class="sd">                                    2 = Stop Services </span>
<span class="sd">                                    3 = Start Services</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlinstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span>
        <span class="n">sqlmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlClient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># STOP SERVICES</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping the SQL Server Services&quot;</span><span class="p">)</span>
                <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net stop </span><span class="se">\&quot;</span><span class="s2">SQL Server Agent (</span><span class="si">{0}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while stopping SQL Server Agent&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net stop </span><span class="se">\&quot;</span><span class="s2">SQL Server (</span><span class="si">{0}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while services are stopping.&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="c1"># START SERVICES</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting the SQL Server services&quot;</span><span class="p">)</span>
                <span class="n">sqlmachine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;net action </span><span class="se">\&quot;</span><span class="s2">SQL Server (</span><span class="si">{0}</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sqlinstance</span><span class="p">))</span>
                <span class="c1"># command output is an object.. need to parse output message on success or failure.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleep for 30 seconds while services are starting.&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in restart_sqlserver_services()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBInit.rename_database"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.rename_database">[docs]</a>    <span class="k">def</span> <span class="nf">rename_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function renames the database by appending some random characters</span>
<span class="sd">        On success returns (renamed database, True) else (1, False)</span>

<span class="sd">        Args:</span>
<span class="sd">            databasename (str): Database name</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: database name</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ransum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                <span class="n">ransum</span> <span class="o">=</span> <span class="n">ransum</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">)</span>

            <span class="n">database_rename</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ransum</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}</span><span class="s2">] MODIFY NAME = [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="n">database_rename</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">database_rename</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in rename_database()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBInit.change_recovery_model"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBInit.change_recovery_model">[docs]</a>    <span class="k">def</span> <span class="nf">change_recovery_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function changes the recovery model for specified databases.</span>

<span class="sd">        Args:</span>
<span class="sd">            databasename (str): Database name</span>
<span class="sd">            noofdbs (int): Number of DBs to change recovery model</span>
<span class="sd">            recoverymodel (str): Recovery model to set database to</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ALTER DATABASE [</span><span class="si">{0}{1}</span><span class="s2">] SET RECOVERY </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">databasename</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">recoverymodel</span><span class="p">))</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised  in change_recovery_model()</span><span class="se">\n</span><span class="s2">Error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="DBValidate"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate">[docs]</a><span class="k">class</span> <span class="nc">DBValidate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform SQL Server validation operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">global_lock</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sqlautomation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes DBValidate object</span>

<span class="sd">        Args:</span>
<span class="sd">            _sqlautomation (:obj:&#39;SQLAutomation&#39;): Instance of SQLAutomation</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span> <span class="o">=</span> <span class="n">_sqlautomation</span>

<div class="viewcode-block" id="DBValidate.db_compare"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.db_compare">[docs]</a>    <span class="k">def</span> <span class="nf">db_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function compares two files.</span>

<span class="sd">        Args:</span>
<span class="sd">            file1 (str): File to be compared to file2</span>
<span class="sd">            file2 (str): File to be compared to file1</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, False otherwise.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Comparing the files&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Files </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> are identical&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Files </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> differ!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">file2</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in db_compare()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBValidate.get_random_dbnames_and_filegroups"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_random_dbnames_and_filegroups">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_random_dbnames_and_filegroups</span><span class="p">(</span><span class="n">randomization</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">,</span> <span class="n">nooffilegroupsdb</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function shuffles the database tables and returns some table names</span>

<span class="sd">        Args:</span>
<span class="sd">            randomization (int): Randomization 0 to 100</span>
<span class="sd">            noofdbs (int): Number of databases</span>
<span class="sd">            nooffilegroupsdb (int): Number of file groups for each database</span>
<span class="sd">            nooftablesfilegroup (int): Number of file for each file group</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise</span>
<span class="sd">            list: database numbers</span>
<span class="sd">            list: file group numbers</span>
<span class="sd">            list: table numbers</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">list1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">list2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">list3</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooffilegroupsdb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nooftablesfilegroup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">list3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">randomization</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">list3</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">noofdbs</span><span class="p">))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list1</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">nooffilegroupsdb</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list2</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="n">nooftablesfilegroup</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list3</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_random_dbnames_and_filegroups()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBValidate.dump_db_to_file"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.dump_db_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">dump_db_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">databasename</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">incbackuptype</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function writes the database tables to file</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (str): File name</span>
<span class="sd">            databasename (str): Database name</span>
<span class="sd">            l (list): List contains the table data</span>
<span class="sd">            m (list): List contains the file group data</span>
<span class="sd">            n (list): List contains the no.of records in table</span>
<span class="sd">            incbackuptype (str): Is &quot;incremental&quot; or &quot;differential&quot; or other</span>
<span class="sd">            p (int, Optional): Number we put in the table name so runs don&#39;t</span>
<span class="sd">                conflict with previous runs of this function.  Default of 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for Success else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">filehandle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the data to file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">f_name</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="n">filehandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">val3</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">dbn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;tab&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val3</span><span class="p">)</span>
                        <span class="n">cur1</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbn</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur1</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val1</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">val3</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">dbn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;tabm&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val3</span><span class="p">)</span>
                    <span class="n">cur3</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dbn</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur3</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                        <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">incbackuptype</span> <span class="o">==</span> <span class="s2">&quot;INCREMENTAL&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">db</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">cur4</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur4</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">cur5</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur5</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">incbackuptype</span> <span class="o">==</span> <span class="s2">&quot;DIFFERENTIAL&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="n">db</span> <span class="o">=</span> <span class="n">databasename</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">cur4</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur4</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">cur5</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cur5</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">filehandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully writing the data to file &quot;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in dump_db_to_file()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filehandle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filehandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.is_db_online"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.is_db_online">[docs]</a>    <span class="k">def</span> <span class="nf">is_db_online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">noofdbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useexistingdb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function checks if the databases are online</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str): Database name</span>
<span class="sd">            noofdbs (int, Optional): Number of databases being checked.  Only needed if useexistingdb is True.</span>
<span class="sd">            useexistingdb (bool, Optional): If True assume passed in dbname is base name and loop through for noofdbs,</span>
<span class="sd">            if False then take the passed in dbname as the actual database name</span>

<span class="sd">        Returns:</span>
<span class="sd">             bool: True for Success else False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="c1"># This code block is for a specific provided database name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">useexistingdb</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name FROM sys.databases where state_desc=&#39;online&#39; and name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">db</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is ONLINE on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR - Database [</span><span class="si">{0}</span><span class="s2">] is NOT ONLINE on [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is NOT ONLINE on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># This code block is to iterate through noofdbs and append num to provided database name</span>
            <span class="k">elif</span> <span class="n">useexistingdb</span> <span class="ow">and</span> <span class="n">noofdbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dbcount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name FROM sys.databases where state_desc=&#39;online&#39; and name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">db</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is ONLINE on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                            <span class="n">dbcount</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR - Database [</span><span class="si">{0}</span><span class="s2">] is NOT ONLINE on [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">dbcount</span> <span class="o">==</span> <span class="n">noofdbs</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not all databases are ONLINE on [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All databases are ONLINE on [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Provide number of databases to check for base name [</span><span class="si">{0}</span><span class="s2">] when using useexistingdb flag&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in is_db_online()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.get_sql_backup_type"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_sql_backup_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_backup_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">multidb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function checks the backup type in CS database based on the specific job id.</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str): Job id of the backup we want to get the level of</span>
<span class="sd">            multidb (bool): True if you want to check multiple distinct backup levels</span>

<span class="sd">        Returns:</span>
<span class="sd">             str: The type of job.  &quot;Full&quot;, &quot;Transaction Log&quot; or &quot;Differential&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting backup type for backup jobid [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select distinct(type) from sqlDbBackupInfo where jobId = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

            <span class="sd">&#39;&#39;&#39; If there are multiple databases in the job and the backup</span>
<span class="sd">                level of each database is different then multiple rows will</span>
<span class="sd">                be returned from the query.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">backuptype</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multidb</span><span class="p">:</span>  <span class="c1"># return a single type</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">backuptype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Back up type is more than one : &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">backuptype</span> <span class="o">==</span> <span class="s2">&quot;[&#39;D&#39;]&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Full&quot;</span>
                <span class="k">elif</span> <span class="n">backuptype</span> <span class="o">==</span> <span class="s2">&quot;[&#39;L&#39;]&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Transaction Log&quot;</span>
                <span class="k">elif</span> <span class="n">backuptype</span> <span class="o">==</span> <span class="s2">&quot;[&#39;I&#39;]&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;Differential&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">backuptype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># return all of the backup types</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Back up type is only 1 : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Back up type is more than 1: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_sql_backup_type()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="DBValidate.db_path"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.db_path">[docs]</a>    <span class="k">def</span> <span class="nf">db_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns the path of the database files (mdf, ldf, ndf).</span>

<span class="sd">        Args: </span>
<span class="sd">            dbname (str): Database name</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: Database file name</span>
<span class="sd">            list: Database file path</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">list1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">list2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select name,filename from sysfiles&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="n">list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">list1</span><span class="p">,</span> <span class="n">list2</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in db_path()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.get_access_states"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_access_states">[docs]</a>    <span class="k">def</span> <span class="nf">get_access_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">noofdbs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns a list of database access states</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str): Database base name</span>
<span class="sd">            noofdbs (int): number of databases being worked on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: database access types for each database</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">accesslist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noofdbs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name,user_access_desc FROM sys.databases where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">db</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database state for database - </span><span class="si">{0}</span><span class="s2"> is </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;user_access_desc&quot;</span><span class="p">]))</span>
                        <span class="n">accesslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR - could not determine access state for database: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;could not determine access state for database</span><span class="se">\n</span><span class="s2">Database: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">accesslist</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_access_states()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.get_tempdb_create_time"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_tempdb_create_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_tempdb_create_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns the creation time of the tempdb for the instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: timestamp of the tempdb creation time.  If no timestamp found in master then returns False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT CONVERT(VARCHAR(30),create_date,109) as timestamp from sys.databases where database_id=2&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TEMPDB: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]))</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_tempdb_create_time()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.get_database_tables"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_database_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_database_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns a list of table names for the given database</span>

<span class="sd">        Args:</span>
<span class="sd">            database_name (str): Database name</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of table names for given database</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">database_table_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name FROM sys.tables&quot;</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">database_table_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">database_table_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_database_tables()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DBValidate.get_database_state"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.DBValidate.get_database_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_database_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function returns state of the given database</span>

<span class="sd">        Args:</span>
<span class="sd">            database_name (str): Database name</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: State of the database</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name,state_desc FROM sys.databases where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">database_state</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;state_desc&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database [</span><span class="si">{0}</span><span class="s2">] is in [</span><span class="si">{1}</span><span class="s2">] state on [</span><span class="si">{2}</span><span class="s2">]&quot;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="n">database_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">))</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">database_state</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_database_tables()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ModifyDatabase"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.ModifyDatabase">[docs]</a><span class="k">class</span> <span class="nc">ModifyDatabase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform SQL Server modification operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">global_lock</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sqlautomation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes ModifyDatabase object</span>

<span class="sd">        Args:</span>
<span class="sd">            _sqlautomation (:obj:&#39;SQLAutomation&#39;): Instance of SQLAutomation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span> <span class="o">=</span> <span class="n">_sqlautomation</span>

<div class="viewcode-block" id="ModifyDatabase.modify_db_for_inc"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.ModifyDatabase.modify_db_for_inc">[docs]</a>    <span class="k">def</span> <span class="nf">modify_db_for_inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function adds additional data to specified databases before log backups</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str): Base database name to modify</span>
<span class="sd">            l (list): List contains the table data</span>
<span class="sd">            m (list): List contains the file group data</span>
<span class="sd">            n (list): List contains the no.of records in table</span>
<span class="sd">            p (list, Optional): If calling multiple times in a test case this number needs to be incremented </span>
<span class="sd">                                for each call to avoid name conflicts. Default is 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="c1"># TRUNCATE TABLE CODE BLOCK</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">tab2</span> <span class="o">=</span> <span class="s2">&quot;tabm&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;truncate table &quot;</span> <span class="o">+</span> <span class="n">tab1</span><span class="p">)</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;truncate table &quot;</span> <span class="o">+</span> <span class="n">tab2</span><span class="p">)</span>

            <span class="c1"># CREATE TABLE CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">file_group1</span> <span class="o">=</span> <span class="s2">&quot;file_group&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf](fname nvarchar(15),lname nvarchar(15)) on </span><span class="si">{3}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf](fname nvarchar(15),lname nvarchar(15))&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="c1"># INSERT CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf] values(N&#39;inc1&#39;,N&#39;commvault1 &#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf] values(N&#39;inc2&#39;,N&#39;commvault2&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="c1"># UPDATE CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf] set fname=N&#39;Incremental1&#39; where fname=N&#39;inc1&#39;&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update [tab_inc</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf] set lname=N&#39;cvcvcv2&#39; where lname=N&#39;commvault2&#39;&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT TRANSACTION&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in modify_db_for_inc()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModifyDatabase.modify_db_for_diff"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.ModifyDatabase.modify_db_for_diff">[docs]</a>    <span class="k">def</span> <span class="nf">modify_db_for_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function adds additional data to specified databases before differential backups</span>

<span class="sd">        Args:</span>
<span class="sd">            dbname (str): Base database name to modify</span>
<span class="sd">            l (list): List contains the table data</span>
<span class="sd">            m (list): List contains the file group data</span>
<span class="sd">            n (list): List contains the number of records in table</span>
<span class="sd">            p (list, Optional): If calling multiple times in a test case this number needs to be incremented </span>
<span class="sd">                                for each call to avoid name conflicts. Default is 1.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True for success, else False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="c1"># TRUNCATE TABLE CODE BLOCK</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN TRANSACTION&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">tab1</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">tab2</span> <span class="o">=</span> <span class="s2">&quot;tabm&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;truncate table &quot;</span> <span class="o">+</span> <span class="n">tab1</span><span class="p">)</span>
                        <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;truncate table &quot;</span> <span class="o">+</span> <span class="n">tab2</span><span class="p">)</span>

            <span class="c1"># CREATE TABLE CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">file_group1</span> <span class="o">=</span> <span class="s2">&quot;file_group&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf](fname nvarchar(15),lname nvarchar(15)) on </span><span class="si">{3}</span><span class="s2">&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">file_group1</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf](fname nvarchar(15),lname nvarchar(15))&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="c1"># INSERT CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf] values(N&#39;diff1&#39;,N&#39;commvault1&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf] values(N&#39;diff2&#39;,N&#39;commvault2&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="c1"># UPDATE CODE BLOCK</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;use [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_mdf] set fname=N&#39;Differential1&#39; where fname=N&#39;diff1&#39;&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
                    <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update [tab_diff</span><span class="si">{0}{1}{2}</span><span class="s2">_ndf] set lname=N&#39;cvcvcv2&#39; where lname=N&#39;commvault2&#39;&quot;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT TRANSACTION&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in modify_db_for_diff()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModifyDatabase.create_table"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.ModifyDatabase.create_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates a table on a given database</span>

<span class="sd">        Args:</span>
<span class="sd">            database_name (str): Name of database to create table on</span>
<span class="sd">            table_name (str): Name of new table to be created</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">))</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE [</span><span class="si">{0}</span><span class="s2">] (fname nvarchar(15),lname nvarchar(15))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table [</span><span class="si">{0}</span><span class="s2">] created successfully on database [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span>
                                                                                                <span class="n">database_name</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_table()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModifyDatabase.drop_table"><a class="viewcode-back" href="../../../Application.SQL.html#Application.SQL.sqlhelper.ModifyDatabase.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function drops a table on a given database</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            database_name (str): Name of database containing table to drop</span>
<span class="sd">            table_name (str): Name of table to be dropped</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqlcon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">global_lock</span><span class="p">:</span>
                <span class="n">sqlcon</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlUser</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">sqlPass</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>

            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;USE [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_name</span><span class="p">))</span>
            <span class="n">sqlcon</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqlhelper</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table [</span><span class="si">{0}</span><span class="s2">] dropped successfully on database [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span>
                                                                                                <span class="n">database_name</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_table()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sqlcon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sqlcon</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault SystemsÂ® Inc. All Rights Reserved.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>