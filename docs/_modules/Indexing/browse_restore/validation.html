

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Indexing.browse_restore.validation &mdash; Commvault Automation 11.23 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Indexing.browse_restore.validation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Indexing.browse_restore.validation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main module which contains the class to execute and validate browse/find and restore operations.</span>

<span class="sd">Validation:</span>

<span class="sd">    __init__()              --  Initializes the indexing validation DB class</span>

<span class="sd">    register_subclient()    --  Registers a subclient to the validation object</span>

<span class="sd">    record_job()            --  Scans the test data, calculates the modified/added/deleted items</span>
<span class="sd">    of the subclient and adds them into the SQLite DB for validation</span>

<span class="sd">    validate_browse_restore()-- Performs browse &amp; restore operation and validates the</span>
<span class="sd">    results of both</span>

<span class="sd">    validate_browse()       --  Performs browse/find/version operation and validates the actual</span>
<span class="sd">    and expected results</span>

<span class="sd">    validate_browse_recursive() --  Performs browse operation recursively and validates the result</span>

<span class="sd">    validate_restore()      --  Performs restore operation and verifies the actual and</span>
<span class="sd">    expected results</span>

<span class="sd">    do_after_aux_copy()     --  Update validation DB after running auxiliary copy for a job</span>

<span class="sd">    do_after_backup_copy()  --  Update validation DB after running backup copy for a storage policy</span>

<span class="sd">    do_after_data_aging()   --  Marks jobs are aged in the validation DB. The jobs will not be</span>
<span class="sd">    considered for browse and restore for validation</span>

<span class="sd">    do_delete_items()       --  Marks the given list of items as erased in the the validation DB.</span>
<span class="sd">    The items will then be not considered for browse and restore validation</span>

<span class="sd">    get_items()             --  Queries the validation DB and returns items which match as per</span>
<span class="sd">    the parameters passed.</span>

<span class="sd">    cleanup()               --  Closes and deletes the validation DB directory</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">xmltodict</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">commonutils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">idautils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">options_selector</span>

<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">cvpysdk.commcell</span> <span class="kn">import</span> <span class="n">Commcell</span>
<span class="kn">from</span> <span class="nn">cvpysdk.backupset</span> <span class="kn">import</span> <span class="n">Backupset</span>
<span class="kn">from</span> <span class="nn">cvpysdk.subclient</span> <span class="kn">import</span> <span class="n">Subclient</span>


<div class="viewcode-block" id="Validation"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation">[docs]</a><span class="k">class</span> <span class="nc">Validation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to validate browse and results for backupset/subclient.</span>
<span class="sd">    Supported clients for now are Windows, Unix and NAS</span>

<span class="sd">    Usage:</span>
<span class="sd">    ======</span>
<span class="sd">        1) - Initialize the validation class with commcell and backupset objects</span>
<span class="sd">            &gt;&gt;&gt; idx = Validation({</span>
<span class="sd">            &gt;&gt;&gt;     &#39;commcell&#39; : &#39;&lt;commcell_pysdk_object&gt;&#39;,</span>
<span class="sd">            &gt;&gt;&gt;     &#39;backupset&#39;: &#39;&lt;backupset_pysdk_object&gt;&#39;</span>
<span class="sd">            &gt;&gt;&gt; })</span>

<span class="sd">        2) - Register the subclients and some of its properties related to validation class.</span>
<span class="sd">            &gt;&gt;&gt; idx.register_subclient(&#39;&lt;subclient_obj&gt;&#39;, &#39;{subclient_props}&#39;)</span>

<span class="sd">        3) - When the backup job completes for the subclient, record the job for validation</span>
<span class="sd">            &gt;&gt;&gt; idx.record_job(&#39;&lt;job_obj&gt;&#39;)</span>

<span class="sd">        4) - Validate browse, restore using the validate_* methods</span>
<span class="sd">            &gt;&gt;&gt; idx.validate_browse(&#39;{browse_options}&#39;)</span>
<span class="sd">            &gt;&gt;&gt; idx.validate_restore(&#39;{restore_options}&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the Browse &amp; Restore validation object</span>

<span class="sd">            Args:</span>
<span class="sd">                config          (dict)          Dictionary of backupset under validation</span>

<span class="sd">            Example:</span>
<span class="sd">                Validation({</span>
<span class="sd">                    &#39;commcell&#39;: &lt;commcell_pysdk_object&gt;,</span>
<span class="sd">                    &#39;backupset&#39;: &lt;backupset_pysdk_object&gt;,</span>
<span class="sd">                    &#39;debug&#39;: True</span>
<span class="sd">                })</span>

<span class="sd">            Returns:</span>
<span class="sd">                The validation class object</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception when the commcell and backupset objects are not PySDK objects</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;commcell&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_restore_directory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_browse_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">,</span> <span class="n">Commcell</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Commcell object is expected as argument for validation class&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="p">,</span> <span class="n">Backupset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backupset object is expected as argument for validation class&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_entities</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_repo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_validation_db</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cv_utils</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options_help</span> <span class="o">=</span> <span class="n">options_selector</span><span class="o">.</span><span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_stop_browse</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Indexing verification object created successfully for [</span><span class="si">{0}</span><span class="s1">-&gt;</span><span class="si">{1}</span><span class="s1">-&gt;</span><span class="si">{2}</span><span class="s1">] &#39;</span>
            <span class="s1">&#39;Repository path [</span><span class="si">{3}</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="s1">&#39;find&#39;</span><span class="p">,</span>
            <span class="s1">&#39;from_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;to_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">**</span><span class="se">\\</span><span class="s1">*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;show_deleted&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;media_agent&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;copy_precedence&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;include_aged_data&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;include_hidden&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;include_running_jobs&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;page_size&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>

            <span class="s1">&#39;_version_number&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;_is_restore&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;_verify_size&#39;</span><span class="p">:</span> <span class="s1">&#39;skip_auto&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_verify_jobid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;_verify_jobid_directory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;_verify_live_browse&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;_verify_volume_level&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;_exclude_jobs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;_mount_point_level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;_item_type&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="s1">&#39;_raw_response&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

            <span class="s1">&#39;restore&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;do&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;dest_client&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;dest_path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;source_items&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">],</span>
                <span class="s1">&#39;select_version&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;media_agent&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;in_place&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;snap_mount_client&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;preserve_level&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;_force_dest_path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

    <span class="nd">@debug</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">restore_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_restore_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_restore_directory</span>

    <span class="nd">@last_restore_directory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">last_restore_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_restore_directory</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_initialize_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the CvPySDK client, agent and backupset object entities&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agent_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">_agent_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">_client_object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_obj</span><span class="o">.</span><span class="n">client_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_obj</span><span class="o">.</span><span class="n">agent_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">backupset_name</span>

        <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>
        <span class="n">full_client_os</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_obj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;windows&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">=</span> <span class="s1">&#39;windows&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;unix&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">=</span> <span class="s1">&#39;unix&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;nas&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">=</span> <span class="s1">&#39;nas&#39;</span>
            <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">commserv_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_machine</span><span class="o">.</span><span class="n">os_sep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Client, agent and backupset object initialized successfully&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the repository folder where the validation data DB is stored&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">get_log_dir</span><span class="p">(),</span> <span class="s1">&#39;Indexing&#39;</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_validation_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes and creates the SQLite DB in repository folder for storing</span>
<span class="sd">            the backup data&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">,</span> <span class="s1">&#39;validation.db&#39;</span><span class="p">)</span>
        <span class="n">does_db_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">does_db_exist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Validation DB is already created [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">SQLite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">does_db_exist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE indexing</span>
<span class="s1">                   (</span>
<span class="s1">                    path        TEXT        NOT NULL,</span>
<span class="s1">                    parent      TEXT        NOT NULL,</span>
<span class="s1">                    name        TEXT        NOT NULL,</span>
<span class="s1">                    type        TEXT        NOT NULL,</span>
<span class="s1">                    size        INTEGER     NOT NULL,</span>
<span class="s1">                    mtime       INTEGER     NOT NULL,</span>
<span class="s1">                    status      TEXT        NOT NULL,</span>
<span class="s1">                    subclient   TEXT        NOT NULL,</span>
<span class="s1">                    cycle       INTEGER     NOT NULL,</span>
<span class="s1">                    jobid       INTEGER     NULL,</span>
<span class="s1">                    cjobid      INTEGER     NULL,</span>
<span class="s1">                    jobendtime  INTEGER     NULL,</span>
<span class="s1">                    jobtype     TEXT        NULL,</span>
<span class="s1">                    sp          TEXT        NULL,</span>
<span class="s1">                    erased      TEXT        NULL</span>
<span class="s1">                   );&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE spcopy</span>
<span class="s1">                   (</span>
<span class="s1">                    sp          TEXT        NOT NULL,</span>
<span class="s1">                    jobid       INTEGER     NOT NULL,</span>
<span class="s1">                    copy        INTEGER     NOT NULL,</span>
<span class="s1">                    aged        TEXT        NULL</span>
<span class="s1">                   );&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Indexing validation tables are created successfully&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize_restore_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restore_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the machine object of the client which is selected for restore</span>

<span class="sd">            Args:</span>
<span class="sd">                restore_client      (str)       Destination restore client name</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">restore_client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing restore client [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restore_client</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">restore_client</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;machine&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_machine</span><span class="p">,</span>
                <span class="s1">&#39;delim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">,</span>
                <span class="s1">&#39;os&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span><span class="p">,</span>
                <span class="s1">&#39;obj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_obj</span><span class="p">,</span>
                <span class="s1">&#39;restore_path&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating restore client machine objects [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restore_client</span><span class="p">))</span>

            <span class="n">rst_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">restore_client</span><span class="p">)</span>
            <span class="n">full_client_os</span> <span class="o">=</span> <span class="n">rst_client_obj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="n">rst_client_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">restore_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
            <span class="n">rst_client_delim</span> <span class="o">=</span> <span class="n">rst_client_machine</span><span class="o">.</span><span class="n">os_sep</span>
            <span class="n">rst_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">restore_client</span><span class="p">)</span>
            <span class="n">rst_client_os</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="s1">&#39;windows&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
                <span class="n">rst_client_os</span> <span class="o">=</span> <span class="s1">&#39;windows&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;unix&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
                <span class="n">rst_client_os</span> <span class="o">=</span> <span class="s1">&#39;unix&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;nas&#39;</span> <span class="ow">in</span> <span class="n">full_client_os</span><span class="p">:</span>
                <span class="n">rst_client_os</span> <span class="o">=</span> <span class="s1">&#39;nas&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;machine&#39;</span><span class="p">:</span> <span class="n">rst_client_machine</span><span class="p">,</span>
                <span class="s1">&#39;delim&#39;</span><span class="p">:</span> <span class="n">rst_client_delim</span><span class="p">,</span>
                <span class="s1">&#39;os&#39;</span><span class="p">:</span> <span class="n">rst_client_os</span><span class="p">,</span>
                <span class="s1">&#39;obj&#39;</span><span class="p">:</span> <span class="n">rst_client_obj</span><span class="p">,</span>
                <span class="s1">&#39;restore_path&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;os&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;windows&#39;</span><span class="p">,</span> <span class="s1">&#39;unix&#39;</span><span class="p">]:</span>
            <span class="n">rc_delim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;delim&#39;</span><span class="p">]</span>
            <span class="n">rc_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span>
            <span class="n">free_drive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options_help</span><span class="o">.</span><span class="n">get_drive</span><span class="p">(</span><span class="n">rc_machine</span><span class="p">)</span>
            <span class="n">free_drive</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">free_drive</span><span class="p">,</span> <span class="n">rc_delim</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc_delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">free_drive</span><span class="p">,</span> <span class="s1">&#39;automation&#39;</span><span class="p">,</span> <span class="s1">&#39;restores&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_set_default_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the options dictionary with the default values&quot;&quot;&quot;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Set default values</span>
        <span class="n">commonutils</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options</span><span class="p">)</span>

        <span class="c1"># Set restore options</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;do&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;select_version&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v_tag</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="se">\\</span><span class="s1">|#15!vErSiOnS|#15!</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                <span class="n">version_tag</span> <span class="o">=</span> <span class="n">v_tag</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;select_version&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">version_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]:</span>
                    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job_obj</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">convert_to_timestamp</span><span class="p">(</span><span class="n">job_obj</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">_get_index_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translates the given path to a similar format as stored in Index&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">UNC-NT_&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;unix&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;nas&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">_read_collect_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">file_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the collect file maintained by validation object to find modified testdata&quot;&quot;&quot;</span>

        <span class="n">col_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;collect_files&#39;</span><span class="p">][</span><span class="n">file_type</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">col_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">col_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">col_file_hdl</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">col_file_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">col_file_hdl</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">col_file_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">col_file_dict</span>

    <span class="k">def</span> <span class="nf">_write_collect_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes to the local collect file maintained to track modified testdata&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Collect file content to write is not a dictionary&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Subclient [</span><span class="si">{0}</span><span class="s1">] not a registered for validation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subclient</span><span class="p">))</span>

        <span class="n">col_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;collect_files&#39;</span><span class="p">][</span><span class="n">file_type</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">col_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">col_file_hdl</span><span class="p">:</span>
                <span class="n">col_file_hdl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot write collect file: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_latest_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy_precedence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the latest cycle for the given subclient&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">to_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_backup_time</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select max(cycle) from indexing where &quot;</span>
                 <span class="s2">&quot;jobendtime between </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> and subclient = &#39;</span><span class="si">{2}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">from_time</span><span class="p">,</span> <span class="n">to_time</span><span class="p">,</span> <span class="n">subclient</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">copy_precedence</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and jobid in ( select jobid from spcopy where copy = </span><span class="si">{0}</span><span class="s1"> )&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">copy_precedence</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">cycle_no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cycle_no</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">cycle_no</span>

    <span class="k">def</span> <span class="nf">_get_latest_backup_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the latest job&#39;s backup time from validation DB&quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;select max(jobendtime) from indexing&#39;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">latest_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">latest_time</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">latest_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_backup_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_time</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subclient</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if backup copy happened for the given subclient, end time and storage policy&quot;&quot;&quot;</span>

        <span class="n">sp_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">subclient_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">sp</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">sp_query</span> <span class="o">=</span> <span class="s2">&quot;and spcopy.sp = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subclient_query</span> <span class="o">=</span> <span class="s2">&quot;and indexing.subclient = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subclient</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;select copy from spcopy join indexing where indexing.jobid = spcopy.jobid and &#39;</span>
                 <span class="s1">&#39;indexing.jobendtime &lt;= </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &#39;</span>
                 <span class="s1">&#39;order by indexing.jobid desc, spcopy.copy desc limit 1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">to_time</span><span class="p">,</span> <span class="n">sp_query</span><span class="p">,</span> <span class="n">subclient_query</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Backup copy check query [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">copy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Latest available copy is [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">copy</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_filter_timestamps</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;TODO&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">day</span>

    <span class="k">def</span> <span class="nf">_stop_browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if recursive browse has to stop for the given directory&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_stop_browse</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;select name from indexing where parent = &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;stop_browse.txt&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_print_result_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints the difference between the actual and expected results dictionaries&quot;&quot;&quot;</span>

        <span class="n">added</span><span class="p">,</span> <span class="n">removed</span><span class="p">,</span> <span class="n">modified</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">get_dictionary_difference</span><span class="p">(</span>
            <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Actual results: &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">actual_results</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Expected results: &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">expected_results</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only in Actual results: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">added</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only in expected results: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">removed</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Modified: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">modified</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the given path is a file or folder&quot;&quot;&quot;</span>

        <span class="n">last_item</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">last_item</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;UNC-NT_&#39;</span> <span class="ow">in</span> <span class="n">last_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_scan_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scans the testdata directory of the given subclient</span>

<span class="sd">            Args:</span>
<span class="sd">                subclient       (str)           Subclient Name</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of scanned items of below format</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;item_1_path&#39;: {</span>
<span class="sd">                        &#39;parent&#39;: &#39;item_parent&#39;,</span>
<span class="sd">                        &#39;type&#39;: &#39;item_type&#39;,</span>
<span class="sd">                        &#39;size&#39;: &#39;item_size&#39;,</span>
<span class="sd">                        &#39;mtime&#39;: &#39;item_mtime&#39;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sc_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
        <span class="n">scanned_items</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">sc_path</span> <span class="ow">in</span> <span class="n">sc_content</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scanning folder [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sc_path</span><span class="p">))</span>
            <span class="n">root_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">root_mtime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">scan_items_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_machine</span><span class="o">.</span><span class="n">scan_directory</span><span class="p">(</span><span class="n">sc_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">scan_items_list</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_index_path</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                <span class="n">i_type</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span>
                <span class="n">root_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">i_type</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">root_mtime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">root_mtime</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">mtime</span><span class="p">))</span>
                <span class="n">scanned_items</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">get_parent_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">i_type</span><span class="p">,</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                    <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span>
                <span class="p">}</span>

            <span class="n">sc_path_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_index_path</span><span class="p">(</span><span class="n">sc_path</span><span class="p">)</span>
            <span class="n">sc_path_split</span> <span class="o">=</span> <span class="n">sc_path_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_path_split</span><span class="p">)):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc_path_split</span><span class="p">)</span>
                <span class="n">item_parent</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">get_parent_path</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">item_parent</span><span class="p">:</span>  <span class="c1"># UNC, NAS case</span>
                    <span class="k">continue</span>
                <span class="n">scanned_items</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">item_parent</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">root_size</span><span class="p">,</span>
                    <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">root_mtime</span>
                <span class="p">}</span>
                <span class="n">sc_path_split</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">scanned_items</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">scanned_items</span>

    <span class="k">def</span> <span class="nf">_scan_restore_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">restore_client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scans the restored data directory for the given path and client</span>

<span class="sd">            Args:</span>
<span class="sd">                dest_path       (str)           Destination restore directory</span>
<span class="sd">                restore_client  (str)           Restore client name</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of scanned items of below format</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;item_i_path&#39;: {</span>
<span class="sd">                        &#39;parent&#39;: &#39;item_parent&#39;,</span>
<span class="sd">                        &#39;type&#39;: &#39;item_type&#39;,</span>
<span class="sd">                        &#39;size&#39;: &#39;item_size&#39;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">restored_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rst_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">]</span>
        <span class="n">rc_machine</span> <span class="o">=</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span>

        <span class="n">scan_items_list</span> <span class="o">=</span> <span class="n">rc_machine</span><span class="o">.</span><span class="n">scan_directory</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">scan_items_list</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;nas&#39;</span> <span class="ow">and</span> <span class="s1">&#39;restore_symboltable&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">restored_data</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">get_int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">restored_data</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">restored_data</span>

    <span class="k">def</span> <span class="nf">_identify_testdata_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_items</span><span class="p">,</span> <span class="n">job_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify items which are added, modified &amp; deleted from the scan list&quot;&quot;&quot;</span>

        <span class="n">subclient</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        <span class="n">job_type</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span>
        <span class="n">job_endtime</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s1">&#39;job_endtime&#39;</span><span class="p">]</span>
        <span class="n">cycle</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">]</span>

        <span class="n">final_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">col_items</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;current_cycle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cycle</span>
            <span class="n">col_items</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;incremental&#39;</span><span class="p">:</span>
            <span class="n">col_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_collect_file</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;differential&#39;</span><span class="p">:</span>
            <span class="n">col_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_collect_file</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sitem</span> <span class="ow">in</span> <span class="n">scan_items</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">sitem</span><span class="p">]</span>
            <span class="n">final_items</span><span class="p">[</span><span class="n">sitem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">],</span>
                <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span>
                <span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="n">subclient</span><span class="p">,</span>
                <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                <span class="s1">&#39;jobtype&#39;</span><span class="p">:</span> <span class="n">job_type</span><span class="p">,</span>
                <span class="s1">&#39;jobendtime&#39;</span><span class="p">:</span> <span class="n">job_endtime</span><span class="p">,</span>
                <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle</span><span class="p">,</span>
                <span class="s1">&#39;cjobid&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">sitem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_items</span><span class="p">:</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;new&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprop</span> <span class="o">=</span> <span class="n">col_items</span><span class="p">[</span><span class="n">sitem</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cprop</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cprop</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]:</span>
                    <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>

            <span class="n">final_items</span><span class="p">[</span><span class="n">sitem</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="c1"># Identify deletions</span>
        <span class="k">for</span> <span class="n">citem</span> <span class="ow">in</span> <span class="n">col_items</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">col_items</span><span class="p">[</span><span class="n">citem</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">citem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scan_items</span><span class="p">:</span>
                <span class="n">final_items</span><span class="p">[</span><span class="n">citem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">version</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="n">subclient</span><span class="p">,</span>
                    <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                    <span class="s1">&#39;jobtype&#39;</span><span class="p">:</span> <span class="n">job_type</span><span class="p">,</span>
                    <span class="s1">&#39;jobendtime&#39;</span><span class="p">:</span> <span class="n">job_endtime</span><span class="p">,</span>
                    <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle</span><span class="p">,</span>
                    <span class="s1">&#39;cjobid&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">final_items</span><span class="p">[</span><span class="n">citem</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;differential&#39;</span><span class="p">]:</span>
            <span class="n">col_items_inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_collect_file</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">citem_inc</span> <span class="ow">in</span> <span class="n">col_items_inc</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">col_items_inc</span><span class="p">[</span><span class="n">citem_inc</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">citem_inc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_items</span><span class="p">:</span>
                    <span class="n">final_items</span><span class="p">[</span><span class="n">citem_inc</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;deleted&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="n">subclient</span><span class="p">,</span>
                        <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                        <span class="s1">&#39;jobtype&#39;</span><span class="p">:</span> <span class="n">job_type</span><span class="p">,</span>
                        <span class="s1">&#39;jobendtime&#39;</span><span class="p">:</span> <span class="n">job_endtime</span><span class="p">,</span>
                        <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle</span><span class="p">,</span>
                        <span class="s1">&#39;cjobid&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">final_items</span><span class="p">[</span><span class="n">citem_inc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_items</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">final_items</span>

    <span class="k">def</span> <span class="nf">_filter_scan_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_items</span><span class="p">,</span> <span class="n">job_type</span><span class="p">):</span>

        <span class="c1"># Filter eligible files from the scanned dictionary</span>
        <span class="n">filter_items</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fitem</span> <span class="ow">in</span> <span class="n">scan_items</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                For windows:</span>
<span class="sd">                    1. Select new/modified files</span>
<span class="sd">                    2. Recursively add its parent folders</span>

<span class="sd">                For Unix:</span>
<span class="sd">                    1. Select new/modified/deleted files</span>
<span class="sd">                    2. Recursively add its parent folders</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c1"># Select files which are new/modified and also deleted file if it is unix OS</span>
            <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;deleted&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unix&#39;</span><span class="p">,</span> <span class="s1">&#39;nas&#39;</span><span class="p">]):</span>

                <span class="c1"># Add the file to the list</span>
                <span class="n">filter_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span>

                <span class="c1"># Add the root paths of this file to the list</span>
                <span class="n">cur_parent</span> <span class="o">=</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>
                <span class="n">cur_parent_split</span> <span class="o">=</span> <span class="n">cur_parent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_parent_split</span><span class="p">)):</span>

                    <span class="n">p_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_parent_split</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p_parent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># if parent itself is deleted, do not add it, instead continue</span>
                    <span class="c1"># and add its grand parents which are only modified</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">p_parent</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">p_parent</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">):</span>
                        <span class="n">cur_parent_split</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="k">continue</span>

                    <span class="c1"># Add the parent to the list</span>
                    <span class="k">if</span> <span class="n">p_parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_items</span><span class="p">:</span>
                        <span class="n">filter_items</span><span class="p">[</span><span class="n">p_parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">p_parent</span><span class="p">]</span>
                        <span class="n">filter_items</span><span class="p">[</span><span class="n">p_parent</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>

                    <span class="n">cur_parent_split</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="c1"># Add all the items which are marked deleted</span>
            <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span>
                <span class="n">filter_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                Adding folders which are not covered by above method</span>

<span class="sd">                How emtpy folders are backed up ?</span>

<span class="sd">                Type\platform                    |   Win     |    Unix</span>
<span class="sd">                --------------------------------------------------------</span>
<span class="sd">                New empty dir (FULL backup)      |   Yes     |    Yes</span>
<span class="sd">                New empty dir (INC backup)       |   No      |    Yes</span>
<span class="sd">                Folder became empty              |   No      |    Yes</span>
<span class="sd">                Nothing changed in dir           |   No      |    No</span>

<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c1"># Add all the folders which are new ( for empty folder case )</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span>
                    <span class="ow">and</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">):</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;windows&#39;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;windows&#39;</span><span class="p">]:</span>
                    <span class="n">filter_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span>

            <span class="c1"># For Unix alone add folders which are modified</span>
            <span class="c1"># ( like, a file is deleted but other items are not modified )</span>

            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unix&#39;</span><span class="p">]):</span>
                <span class="n">filter_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_items</span><span class="p">[</span><span class="n">fitem</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">filter_items</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">filter_items</span>

    <span class="k">def</span> <span class="nf">_insert_into_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanned_items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts the scanned test data items into the SQLite DB for validation</span>

<span class="sd">            Args:</span>
<span class="sd">                scanned_items       (dict)          Dictionary of scanned items</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserting scanned items into DB&#39;</span><span class="p">)</span>
        <span class="n">insert_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">scanned_items</span><span class="p">:</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="n">scanned_items</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
                <span class="n">sp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">ver</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="s1">&#39;stop_browse.txt&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_has_stop_browse</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">ver</span><span class="p">:</span>
                    <span class="n">insert_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">path</span><span class="p">,</span>              <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span>      <span class="n">name</span><span class="p">,</span>
                            <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>       <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>        <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">],</span>
                            <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>     <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">],</span>   <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">],</span>
                            <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;jobtype&#39;</span><span class="p">],</span>    <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;jobendtime&#39;</span><span class="p">],</span>  <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">],</span>
                            <span class="n">ver</span><span class="p">[</span><span class="s1">&#39;cjobid&#39;</span><span class="p">],</span>     <span class="n">sp_name</span><span class="p">,</span>            <span class="s1">&#39;no&#39;</span>
                         <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">inserted_records</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">insert_values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO indexing &quot;</span>
            <span class="s2">&quot;( path, parent, name, type, size, mtime, status, subclient, jobid, &quot;</span>
            <span class="s2">&quot;jobtype, jobendtime, cycle, cjobid, sp, erased ) VALUES &quot;</span>
            <span class="s2">&quot;( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;</span><span class="p">,</span> <span class="n">insert_values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Validation DB updated successfully. Inserted [</span><span class="si">{0}</span><span class="s1">] items into DB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">inserted_records</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_insert_into_spcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">copy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts the SP, Copy and job_id in spcopy table</span>

<span class="sd">            Args:</span>
<span class="sd">                sp          (str)           Storage policy name of the subclient</span>
<span class="sd">                job_id      (int)           Job ID to be inserted</span>
<span class="sd">                copy        (int)           Copy ID of the job</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s1">&#39;insert into spcopy ( sp, jobid, copy, aged ) values ( ?, ?, ?, &quot;no&quot; )&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserted job copy details in spcopy table </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_prepare_browse_sql_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares the SQL query for the browse/find operation to get the expected results&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No subclients registered for validation !&#39;</span><span class="p">)</span>

        <span class="n">operation</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">subclient</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span>
        <span class="n">from_time</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]</span>
        <span class="n">to_time</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]</span>
        <span class="n">browse_path</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
        <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;copy_precedence&#39;</span><span class="p">]</span>
        <span class="n">exclude_jobs</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_exclude_jobs&#39;</span><span class="p">]</span>
        <span class="n">item_type</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_item_type&#39;</span><span class="p">]</span>
        <span class="n">is_restore</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_is_restore&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">paths</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]:</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">browse_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="c1"># Initializing the path</span>
        <span class="k">if</span> <span class="n">browse_path</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">:</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">browse_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">browse_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="n">operators</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;LT&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GT&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LTE&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GTE&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Initializing the filters</span>
        <span class="n">filter_query_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">temp_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FileSize&#39;</span><span class="p">:</span>
                <span class="n">operator</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">operators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">temp_query</span> <span class="o">=</span> <span class="s1">&#39; and (size &#39;</span> <span class="o">+</span> <span class="n">op</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; and type=&quot;file&quot;&#39;</span>

            <span class="k">if</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ModifiedDate&#39;</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_timestamps</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
                <span class="n">temp_query</span> <span class="o">=</span> <span class="s1">&#39;and (mtime between &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_date</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">to_date</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FileName&#39;</span><span class="p">:</span>
                <span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">temp_query</span> <span class="o">=</span> <span class="s1">&#39; and (name like &quot;&#39;</span> <span class="o">+</span> <span class="n">f_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

            <span class="c1"># During filtered browse include directories in SQL result</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span><span class="p">:</span>
                <span class="n">temp_query</span> <span class="o">+=</span> <span class="s1">&#39; or type = &quot;directory&quot;)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">temp_query</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

            <span class="n">filter_query_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_query</span><span class="p">)</span>

        <span class="c1"># Set to time if not set</span>
        <span class="k">if</span> <span class="n">to_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_backup_time</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;select * from indexing where jobendtime between </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">from_time</span><span class="p">,</span> <span class="n">to_time</span>
        <span class="p">)</span>

        <span class="c1"># Filter by job id if set in request</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( jobId = </span><span class="si">{0}</span><span class="s1"> or status = &quot;deleted&quot; ) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">browse_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="o">+</span> <span class="s1">&#39;**&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">browse_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39; and path like &quot;%</span><span class="si">{0}</span><span class="s1">%&quot; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">browse_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;versions&#39;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39; and path like &quot;%</span><span class="si">{0}</span><span class="s1">%&quot; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">browse_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;browse&#39;</span><span class="p">,</span> <span class="s1">&#39;find&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">fQuery</span> <span class="ow">in</span> <span class="n">filter_query_list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="n">fQuery</span>

        <span class="c1"># Add subclient to query</span>
        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and subclient=&quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subclient</span><span class="p">)</span>

        <span class="c1"># Add exclude jobs query</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( jobid not in ( &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exclude_jobs</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)  ) &#39;</span>

        <span class="c1"># Add item type to query</span>
        <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and type=&quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_type</span><span class="p">)</span>

        <span class="n">cycle_restriction</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Handlers for deleted items</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            NAS NDMP - Deleted items are always not marked</span>
<span class="sd">            NAS Snap - Snap copy - Deleted items are marked</span>
<span class="sd">            NAS Snap - Backup copy - Deleted items are marked</span>

<span class="sd">            Block - Snap copy - Deleted items are marked</span>
<span class="sd">            Block - Backup copy - Deleted items are marked</span>

<span class="sd">            FS Snap - Snap copy - Deleted items are marked</span>
<span class="sd">            FS Snap - Backup copy - Deleted folders alone are not marked</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;nas_ndmp&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_restore</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( status &lt;&gt; &quot;deleted&quot; and subclient = &quot;&#39;</span> <span class="o">+</span> <span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;&quot; )&#39;</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;nas_snap&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_block&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_snap&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_backup_copy</span><span class="p">(</span><span class="n">to_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span> <span class="n">sc</span><span class="p">):</span>
                        <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( ( status &lt;&gt; &quot;deleted&quot; and type = &quot;directory&quot; ) &#39;</span> \
                                 <span class="s1">&#39;or type = &quot;file&quot; and subclient = &quot;&#39;</span> <span class="o">+</span> <span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;&quot; ) &#39;</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_snap_skipcatalog&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_backup_copy</span><span class="p">(</span><span class="n">to_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span> <span class="n">sc</span><span class="p">):</span>
                        <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( status &lt;&gt; &quot;deleted&quot; and subclient = &quot;&#39;</span> <span class="o">+</span> <span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;&quot; ) &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;nas_ndmp&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_restore</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and status &lt;&gt; &quot;deleted&quot; &#39;</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;nas_snap&#39;</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_block&#39;</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_snap&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_backup_copy</span><span class="p">(</span><span class="n">to_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]):</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( ( status &lt;&gt; &quot;deleted&quot; and type = &quot;directory&quot; )&#39;</span> \
                             <span class="s1">&#39; or type = &quot;file&quot; ) &#39;</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_snap_skipcatalog&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_backup_copy</span><span class="p">(</span><span class="n">to_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]):</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and status &lt;&gt; &quot;deleted&quot; &#39;</span>

        <span class="c1"># Add copy precedence query</span>
        <span class="k">if</span> <span class="n">copy_precedence</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and ( jobid in ( select jobid from spcopy where copy = </span><span class="si">{0}</span><span class="s1"> )&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">copy_precedence</span>
            <span class="p">)</span>

            <span class="c1"># Ideally, only latest browse on secondary copy honours</span>
            <span class="c1"># source deletion and not timerange deletions</span>
            <span class="k">if</span> <span class="n">from_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; or status = &quot;deleted&quot; )&#39;</span>
                <span class="n">cycle_restriction</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Do not add cycle restriction</span>
                <span class="c1"># to the query as we need the delete masks from the latest cycle.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="c1"># Restrict indexing to latest cycle in that timerange when from_time is not set</span>
        <span class="k">if</span> <span class="n">from_time</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cycle_restriction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Restricting browse to latest cycle in that timerange since from_time is not set&#39;</span><span class="p">)</span>

            <span class="c1"># Backupset level operation</span>
            <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sc_cycles_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">:</span>
                    <span class="n">cycle_to_restrict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cycle</span><span class="p">(</span>
                        <span class="n">sc</span><span class="p">,</span>
                        <span class="n">from_time</span><span class="p">,</span>
                        <span class="n">to_time</span><span class="p">,</span>
                        <span class="n">copy_precedence</span>
                    <span class="p">)</span>

                    <span class="n">sc_cycles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; ( subclient = &quot;&#39;</span> <span class="o">+</span> <span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;&quot; and cycle = &quot;&#39;</span> <span class="o">+</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="n">cycle_to_restrict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; ) &#39;</span><span class="p">)</span>

                <span class="n">sc_cycle_query</span> <span class="o">=</span> <span class="s1">&#39; and ( &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc_cycles_list</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; )&#39;</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="n">sc_cycle_query</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cycle_to_restrict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cycle</span><span class="p">(</span>
                    <span class="n">subclient</span><span class="p">,</span>
                    <span class="n">from_time</span><span class="p">,</span>
                    <span class="n">to_time</span><span class="p">,</span>
                    <span class="n">copy_precedence</span>
                <span class="p">)</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and cycle=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cycle_to_restrict</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_get_directories_and_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">browse_query_result</span><span class="p">,</span> <span class="n">include_deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares a dictionary of all the directories and its size from the</span>
<span class="sd">        browse query result&quot;&quot;&quot;</span>

        <span class="n">directories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">browse_query_result</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">browse_query_result</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Take the latest version</span>
            <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_deleted</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur_parent</span> <span class="o">=</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>
                    <span class="n">cur_parent_split</span> <span class="o">=</span> <span class="n">cur_parent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_parent_split</span><span class="p">)):</span>
                        <span class="n">cur_parent_join</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_parent_split</span><span class="p">)</span>
                        <span class="n">cur_parent_join</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span>
                            <span class="k">if</span> <span class="n">cur_parent_join</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">else</span> <span class="n">cur_parent_join</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">cur_parent_join</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
                            <span class="n">directories</span><span class="p">[</span><span class="n">cur_parent_join</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">directories</span><span class="p">[</span><span class="n">cur_parent_join</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>

                        <span class="n">cur_parent_split</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">directories</span>

    <span class="k">def</span> <span class="nf">_query_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span> <span class="n">sfull_props</span><span class="p">,</span> <span class="n">deleted_time_threshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries the validation DB and returns the list of items matching the query</span>

<span class="sd">            Args:</span>
<span class="sd">                query                   (str)       SQL query to run on validation DB</span>
<span class="sd">                versions                (int)       No of versions to select for an item</span>
<span class="sd">                sfull_props             (dict)      SFULL job details</span>
<span class="sd">                deleted_time_threshold  (int)       Threshold to carry forward the deleted items</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of items which comes as a result of SQL query. Format:</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;item_path&#39;: [{item_1_props} ... {items_n_props}]</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;select * from indexing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid DB query&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add clause to not include items from aged jobs</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39; and ( jobid in ( select distinct jobid from spcopy&#39;</span>
                      <span class="s1">&#39; where aged &lt;&gt; &quot;yes&quot; ) or status = &quot;deleted&quot; ) and erased &lt;&gt; &quot;yes&quot;&#39;</span>
                      <span class="s1">&#39; order by jobid asc&#39;</span><span class="p">)</span>

        <span class="n">query_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">is_sfull</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Querying DB - [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sfull_props</span><span class="p">:</span>
            <span class="n">is_sfull</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;subclient&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;jobid&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;jobtype&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobendtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;jobendtime&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;cycle&#39;</span><span class="p">)</span>
            <span class="n">version</span><span class="p">[</span><span class="s1">&#39;cjobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;cjobid&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_sfull</span><span class="p">:</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SFULL&#39;</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;cjobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfull_props</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfull_props</span><span class="p">[</span><span class="s1">&#39;cycle&#39;</span><span class="p">]</span>
                <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobendtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfull_props</span><span class="p">[</span><span class="s1">&#39;jobendtime&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">:</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;deleted&#39;</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;deletedtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;jobendtime&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">:</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">item_versions</span> <span class="o">=</span> <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>

                    <span class="c1"># Pop if version stack is full</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_versions</span><span class="p">)</span> <span class="o">==</span> <span class="n">versions</span><span class="p">:</span>
                        <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Pop duplicate versions</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_versions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i_ver</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">item_versions</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i_ver</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]</span> <span class="ow">and</span>
                                    <span class="n">i_ver</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]):</span>
                                <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i_ver</span><span class="p">)</span>

                    <span class="n">query_list</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">query_list</span><span class="p">))</span>

        <span class="c1"># Go through the final list and remove items which are out of image</span>
        <span class="c1"># as per the deleted item carry forward threshold</span>
        <span class="k">if</span> <span class="n">is_sfull</span><span class="p">:</span>

            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current time [</span><span class="si">{0}</span><span class="s1">], deleted item threshold [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span> <span class="nb">str</span><span class="p">(</span><span class="n">deleted_time_threshold</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">query_list</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span>

                    <span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">deleted_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_list</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;deletedtime&#39;</span><span class="p">])</span>
                    <span class="n">should_drop</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">deleted_time</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">deleted_time_threshold</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                            <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
                            <span class="s1">&#39;current_time&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
                            <span class="s1">&#39;deleted_time&#39;</span><span class="p">:</span> <span class="n">deleted_time</span><span class="p">,</span>
                            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">deleted_time_threshold</span><span class="p">,</span>
                            <span class="s1">&#39;should_drop&#39;</span><span class="p">:</span> <span class="n">should_drop</span>
                        <span class="p">}))</span>

                    <span class="c1"># Check if the last deleted version is qualified for carry forward</span>
                    <span class="k">if</span> <span class="n">should_drop</span><span class="p">:</span>
                        <span class="n">query_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># deleted file not qualified so delete it</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if deleted file is qualified, make it active and</span>
                        <span class="c1"># add another version to mark it deleted</span>
                        <span class="c1"># add a version to mark it delete</span>
                        <span class="n">query_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">query_list</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="c1"># make the last previous version as the active one</span>
                        <span class="n">query_list</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;modified&#39;</span>

        <span class="k">return</span> <span class="n">query_list</span>

    <span class="k">def</span> <span class="nf">_get_browse_expected_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the expected browse results for the given browse options&quot;&quot;&quot;</span>

        <span class="n">operation</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">browse_path</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="n">show_deleted</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show_deleted&#39;</span><span class="p">]</span>
        <span class="n">version_number</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_version_number&#39;</span><span class="p">]</span>
        <span class="n">is_restore</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_is_restore&#39;</span><span class="p">]</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span>
        <span class="n">query_versions</span> <span class="o">=</span> <span class="mi">9999</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;versions&#39;</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">paths</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]:</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">browse_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="c1"># Initializing the path</span>
        <span class="k">if</span> <span class="n">browse_path</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">:</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">browse_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
            <span class="n">browse_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">browse_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

        <span class="c1"># Prepare the browse SQL query for the browse/find operation</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_browse_sql_query</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Query local SQLite DB</span>
        <span class="n">browse_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_db</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_versions</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>

        <span class="c1"># Get all directories and its size</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_directories_and_size</span><span class="p">(</span><span class="n">browse_result</span><span class="p">,</span> <span class="n">show_deleted</span><span class="p">)</span>

        <span class="c1"># Loop through the query result and prepare the expected results dictionary</span>
        <span class="n">final_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">browse_items</span> <span class="o">=</span> <span class="n">browse_result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">browse_items</span><span class="p">:</span>
            <span class="n">browse_item</span> <span class="o">=</span> <span class="n">browse_result</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span><span class="p">:</span>
                <span class="n">v_select</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">v_item</span> <span class="o">=</span> <span class="n">browse_item</span><span class="p">[</span><span class="n">v_select</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">browse_path</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="ow">or</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)):</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_deleted</span> <span class="ow">and</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># empty folders ( no folder size in list ) set folder size as 0</span>
                        <span class="k">if</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                            <span class="c1"># If no filters are selected, then show empty dir, else skip it</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">dirs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>

                        <span class="c1"># if directory, take it from the calculated list</span>
                        <span class="n">v_size</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span>
                            <span class="k">else</span> <span class="n">dirs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                        <span class="p">)</span>

                        <span class="c1"># Remove prefix slash for windows</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_prefix_sep</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span>
                            <span class="k">else</span> <span class="n">item</span>
                        <span class="p">)</span>

                        <span class="n">final_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                            <span class="kc">True</span> <span class="k">if</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">v_size</span><span class="p">,</span>
                            <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                        <span class="p">]</span>

            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
                <span class="n">v_select</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">v_item</span> <span class="o">=</span> <span class="n">browse_item</span><span class="p">[</span><span class="n">v_select</span><span class="p">]</span>

                <span class="c1"># UNC case, do not select root slash item.</span>
                <span class="k">if</span> <span class="s1">&#39;UNC-NT_&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">show_deleted</span> <span class="ow">and</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Remove prefix slash for windows</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_prefix_sep</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span>
                        <span class="k">else</span> <span class="n">item</span>
                    <span class="p">)</span>

                    <span class="n">final_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="kc">True</span> <span class="k">if</span> <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                        <span class="n">v_item</span><span class="p">[</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;versions&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ver</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">browse_item</span><span class="p">):</span>
                    <span class="n">version_id</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">version_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">version_number</span> <span class="o">!=</span> <span class="n">version_id</span><span class="p">:</span>
                            <span class="k">continue</span>

                    <span class="n">v_comma</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_id</span><span class="p">)</span>

                    <span class="c1"># No version number for NAS version restores</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;nas&#39;</span> <span class="ow">and</span> <span class="n">is_restore</span><span class="p">:</span>
                        <span class="n">v_comma</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="n">path_split</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">v_path</span> <span class="o">=</span> <span class="n">path_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_comma</span> <span class="o">+</span> <span class="n">path_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># Remove prefix slash for windows</span>
                    <span class="n">v_path</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_prefix_sep</span><span class="p">(</span><span class="n">v_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span>
                        <span class="k">else</span> <span class="n">v_path</span>
                    <span class="p">)</span>

                    <span class="n">final_list</span><span class="p">[</span><span class="n">v_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">browse_item</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                        <span class="kc">True</span> <span class="k">if</span> <span class="n">browse_item</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;deleted&#39;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">browse_item</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                        <span class="n">browse_item</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;jobid&#39;</span><span class="p">]</span>
                    <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_list</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">final_list</span>

    <span class="k">def</span> <span class="nf">_get_browse_actual_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs browse operation and gets the actual results for the given options&quot;&quot;&quot;</span>

        <span class="n">subclient</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subclient&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">options_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="c1"># Sending copy of the options to CvPySDK</span>
        <span class="n">entity_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">browse_response</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entity_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entity_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span>
            <span class="n">options_copy</span><span class="p">[</span><span class="s1">&#39;_subclient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_obj</span><span class="o">.</span><span class="n">_subclient_id</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span><span class="p">:</span>
            <span class="n">dummy_var</span><span class="p">,</span> <span class="n">browse_response</span> <span class="o">=</span> <span class="n">entity_obj</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">options_copy</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
            <span class="n">dummy_var</span><span class="p">,</span> <span class="n">browse_response</span> <span class="o">=</span> <span class="n">entity_obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">options_copy</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;versions&#39;</span><span class="p">:</span>
            <span class="n">dummy_var</span><span class="p">,</span> <span class="n">browse_response</span> <span class="o">=</span> <span class="n">entity_obj</span><span class="o">.</span><span class="n">find_all_versions</span><span class="p">(</span><span class="n">options_copy</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_browse_response</span><span class="p">(</span><span class="n">browse_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_browse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the browse response from Indexing and extracts the required validation data</span>

<span class="sd">            Args:</span>
<span class="sd">                response            (dict)          Browse response dictionary</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of items present in browse response.</span>
<span class="sd">                {</span>
<span class="sd">                    &#39;item_i_path&#39;: [type, deleted, size, job_id]</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ret_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">browse_responses</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;browseResponses&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">browse_response</span> <span class="ow">in</span> <span class="n">browse_responses</span><span class="p">:</span>
            <span class="n">resp_type</span> <span class="o">=</span> <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;respType&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">resp_type</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sessionId&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Browse session ID [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">][</span><span class="s1">&#39;sessionId&#39;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">resp_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ret_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                <span class="k">if</span> <span class="s1">&#39;messages&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got partial results: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">])))</span>

            <span class="k">if</span> <span class="n">resp_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ret_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="s1">&#39;messages&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got error: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">])))</span>

            <span class="k">if</span> <span class="n">resp_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">ret_code</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="s1">&#39;messages&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;live browse&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="p">{}</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got warning: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">])))</span>

            <span class="k">if</span> <span class="s1">&#39;browseResult&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;queryId&#39;</span> <span class="ow">in</span> <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;browseResult&#39;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;browseResult&#39;</span><span class="p">][</span><span class="s1">&#39;queryId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dataQuery&#39;</span>
                             <span class="ow">or</span> <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;browseResult&#39;</span><span class="p">][</span><span class="s1">&#39;queryId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">)):</span>

                    <span class="n">browse_items</span> <span class="o">=</span> <span class="n">browse_response</span><span class="p">[</span><span class="s1">&#39;browseResult&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataResultSet&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Items in actual results [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">browse_items</span><span class="p">)))</span>

                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">browse_items</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                        <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;directory&#39;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;file&#39;</span>
                        <span class="n">deleted</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="n">job_id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;advancedData&#39;</span><span class="p">][</span><span class="s1">&#39;backupJobId&#39;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                            <span class="n">version</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">version_tag</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
                                <span class="n">path_split</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                                <span class="n">path</span> <span class="o">=</span> <span class="n">path_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">version_tag</span> <span class="o">+</span> <span class="n">path_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">result</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">deleted</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">job_id</span><span class="p">]</span>

                    <span class="k">del</span> <span class="n">browse_items</span>

        <span class="k">del</span> <span class="n">browse_responses</span>

        <span class="k">return</span> <span class="n">ret_code</span><span class="p">,</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_verify_browse_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compares the actual and expected browse results&quot;&quot;&quot;</span>

        <span class="c1"># In Unix, NAS OS remove the root slash from both the lists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;unix&#39;</span><span class="p">,</span> <span class="s1">&#39;nas&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="n">actual_results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If it is browse without filters or find, then set directory size to 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;skip_auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))):</span>
            <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span><span class="p">:</span>
                    <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">expected_results</span><span class="p">:</span>
                        <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Skip size check for all the items if option is set</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;skip_all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Skipping size check in actual and expected results&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">expected_results</span><span class="p">:</span>
                    <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Skip job ID check for all the items if option is set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_jobid&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Skipping job ID check in actual and expected results&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">expected_results</span><span class="p">:</span>
                    <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Skip job ID check for all the items if option is set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_jobid_directory&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Skipping job ID check for dirs in actual and expected results&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">expected_results</span> <span class="ow">and</span> <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span><span class="p">:</span>
                    <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">actual_results</span> <span class="o">!=</span> <span class="n">expected_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;---------- </span><span class="si">{0}</span><span class="s1"> verification failed, there is a difference between &#39;</span>
                <span class="s1">&#39;actual and expected results ----------&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_print_result_difference</span><span class="p">(</span><span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual_results</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;++++++++++ </span><span class="si">{0}</span><span class="s1"> operation results verified ++++++++++&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="p">))</span>

            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">actual_results</span>

    <span class="k">def</span> <span class="nf">_prepare_restore_filters_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares the browse filters XML for the restore operation&quot;&quot;&quot;</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">data_browse_tag</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;databrowse_Query&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;@type&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;@queryId&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dataParam&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;sortParam&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;@ascending&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sortBy&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;@val&#39;</span><span class="p">:</span> <span class="s1">&#39;38&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;@val&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">}]</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;paging&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;@firstNode&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;@pageSize&#39;</span><span class="p">:</span> <span class="s1">&#39;100000&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;@skipNode&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;whereClause&#39;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ModifiedDate&#39;</span><span class="p">:</span>
                    <span class="n">filter_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;connector&#39;</span><span class="p">:</span> <span class="s1">&#39;AND&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FileSize&#39;</span><span class="p">:</span>
                        <span class="n">filter_dict</span><span class="p">[</span><span class="s1">&#39;criteria&#39;</span><span class="p">][</span><span class="s1">&#39;dataOperator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">where_clause</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">data_browse_tag</span><span class="p">[</span><span class="s1">&#39;databrowse_Query&#39;</span><span class="p">][</span><span class="s1">&#39;whereClause&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">where_clause</span>
        <span class="n">bf_xml</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">data_browse_tag</span><span class="p">)</span> <span class="c1"># Get browse filters XML</span>
        <span class="n">bf_xml_clean</span> <span class="o">=</span> <span class="n">bf_xml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># Remove new lines</span>
        <span class="n">bf_xml_clean</span> <span class="o">=</span> <span class="n">bf_xml_clean</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="c1"># Replace double quotes with single quotes</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">bf_xml_clean</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_restore_expected_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the expected results for the restore job&quot;&quot;&quot;</span>

        <span class="n">final_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_path&#39;</span><span class="p">]</span>
        <span class="n">source_items</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]</span>
        <span class="n">restore_client</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_client&#39;</span><span class="p">]</span>
        <span class="n">preserve_level</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;preserve_level&#39;</span><span class="p">]</span>

        <span class="n">rst_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">]</span>
        <span class="n">rc_delim</span> <span class="o">=</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;delim&#39;</span><span class="p">]</span>
        <span class="n">rc_os</span> <span class="o">=</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">src_item</span> <span class="ow">in</span> <span class="n">source_items</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;vErSiOnS&#39;</span> <span class="ow">in</span> <span class="n">src_item</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_item</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;find&#39;</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_item_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_is_restore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">v_restore</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;select_version&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">v_restore</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;versions&#39;</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_version_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_restore</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]:</span>
                <span class="n">src_item</span> <span class="o">=</span> <span class="n">src_item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

            <span class="n">expected_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_browse_expected_results</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">expected_items</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">e_item</span> <span class="ow">in</span> <span class="n">expected_items</span><span class="p">:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_file_path</span><span class="p">(</span><span class="n">src_item</span><span class="p">):</span>

                    <span class="n">s_item</span> <span class="o">=</span> <span class="n">src_item</span>
                    <span class="n">s_item</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">s_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                    <span class="n">s_item</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">s_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">preserve_level</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s_item</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s1">&#39;UNC-NT_&#39;</span> <span class="ow">in</span> <span class="n">s_item</span>
                                <span class="ow">or</span> <span class="s1">&#39;/vol&#39;</span> <span class="ow">in</span> <span class="n">s_item</span><span class="p">):</span>
                            <span class="n">unc_split</span> <span class="o">=</span> <span class="n">s_item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
                            <span class="n">unc_split</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="n">s_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unc_split</span><span class="p">)</span>

                    <span class="n">dest_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">rc_delim</span><span class="p">)</span>
                    <span class="n">e_item_processed</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">e_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

                    <span class="c1"># src= \c:\test\ | expectedItem = \c:\test\hello.txt =&gt; hello.txt</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">s_item</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                    <span class="n">rem_expected_path</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">e_item_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span> <span class="ow">and</span> <span class="n">rc_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span><span class="p">:</span>
                        <span class="n">rem_expected_path</span> <span class="o">=</span> <span class="n">rem_expected_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">rc_os</span> <span class="o">==</span> <span class="s1">&#39;unix&#39;</span><span class="p">:</span>
                        <span class="n">rem_expected_path</span> <span class="o">=</span> <span class="n">rem_expected_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">rc_delim</span><span class="p">)</span>

                    <span class="n">rem_expected_path</span> <span class="o">=</span> <span class="n">rem_expected_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">,</span> <span class="n">rc_delim</span><span class="p">)</span>
                    <span class="n">rem_expected_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_prefix_sep</span><span class="p">(</span><span class="n">rem_expected_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>

                    <span class="n">f_path</span> <span class="o">=</span> <span class="n">dest_path</span> <span class="o">+</span> <span class="n">rc_delim</span> <span class="o">+</span> <span class="n">rem_expected_path</span>
                    <span class="n">f_path</span> <span class="o">=</span> <span class="n">f_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">,</span> <span class="n">rc_delim</span><span class="p">)</span>

                    <span class="n">final_list</span><span class="p">[</span><span class="n">f_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_items</span><span class="p">[</span><span class="n">e_item</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">f_path</span> <span class="o">=</span> <span class="n">dest_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span> <span class="o">+</span> <span class="n">e_item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">final_list</span><span class="p">[</span><span class="n">f_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_items</span><span class="p">[</span><span class="n">e_item</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_list</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">final_list</span>

    <span class="k">def</span> <span class="nf">_get_restore_actual_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts a restore job and gets the actual restored data for the given options&quot;&quot;&quot;</span>

        <span class="n">subclient</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subclient&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">restore_client</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_client&#39;</span><span class="p">]</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_path&#39;</span><span class="p">]</span>
        <span class="n">source_items</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]</span>
        <span class="n">rc_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span>
        <span class="n">rc_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span>
        <span class="n">include_deleted_items</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show_deleted&#39;</span><span class="p">]</span>
        <span class="n">all_versions</span> <span class="o">=</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;select_version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">restore_filter_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_restore_filters_xml</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;in_place&#39;</span><span class="p">]:</span>
            <span class="n">skip_deletes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;/opt&#39;</span><span class="p">,</span> <span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="s1">&#39;/bin&#39;</span><span class="p">,</span> <span class="s1">&#39;/lib&#39;</span><span class="p">]</span>
            <span class="n">can_delete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">skip_path</span> <span class="ow">in</span> <span class="n">skip_deletes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_path</span> <span class="o">==</span> <span class="n">dest_path</span><span class="p">:</span>
                    <span class="n">can_delete</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">can_delete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting previous run restore directory [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_path</span><span class="p">))</span>
                <span class="n">rc_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>

        <span class="n">restore_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="n">rc_obj</span><span class="p">,</span>
            <span class="s1">&#39;paths&#39;</span><span class="p">:</span> <span class="n">source_items</span><span class="p">,</span>
            <span class="s1">&#39;destination_path&#39;</span><span class="p">:</span> <span class="n">dest_path</span><span class="p">,</span>
            <span class="s1">&#39;from_time&#39;</span><span class="p">:</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">convert_to_formatted_time</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;to_time&#39;</span><span class="p">:</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">convert_to_formatted_time</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;wait&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;fs_options&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;in_place&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;in_place&#39;</span><span class="p">],</span>
                <span class="s1">&#39;no_image&#39;</span><span class="p">:</span> <span class="n">include_deleted_items</span><span class="p">,</span>
                <span class="s1">&#39;browse_filters&#39;</span><span class="p">:</span> <span class="n">restore_filter_xml</span><span class="p">,</span>
                <span class="s1">&#39;all_versions&#39;</span><span class="p">:</span> <span class="n">all_versions</span><span class="p">,</span>
                <span class="s1">&#39;preserve_level&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;preserve_level&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restore options passed to SDK [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restore_options</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_restore_directory</span> <span class="o">=</span> <span class="n">dest_path</span>

        <span class="n">cv_utils</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">restore_options</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span>
                <span class="n">cv_utils</span><span class="o">.</span><span class="n">backupset_restore_out_of_place</span><span class="p">(</span><span class="o">**</span><span class="n">restore_options</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restore_options</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span>
                <span class="n">cv_utils</span><span class="o">.</span><span class="n">subclient_restore_out_of_place</span><span class="p">(</span><span class="o">**</span><span class="n">restore_options</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Restore job failed: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_restore_data</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">restore_client</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_restore_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies the actual and expected restore results&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;skip_all&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">actual_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">expected_results</span><span class="p">:</span>
                    <span class="n">actual_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">expected_results</span><span class="p">[</span><span class="n">aitem</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">actual_results</span> <span class="o">!=</span> <span class="n">expected_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;---------- Restore verification failed, there is a difference &#39;</span>
                           <span class="s1">&#39;between actual and expected results ----------&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_result_difference</span><span class="p">(</span><span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual_results</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;++++++++++ Restore results verified ++++++++++&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">actual_results</span>

    <span class="k">def</span> <span class="nf">_print_browse_log_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a header log line based on the type of browse operation being done&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l_level</span> <span class="o">=</span> <span class="s1">&#39;job&#39;</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l_level</span> <span class="o">=</span> <span class="s1">&#39;subclient&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_level</span> <span class="o">=</span> <span class="s1">&#39;backupset&#39;</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l_type</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l_type</span> <span class="o">=</span> <span class="s1">&#39;point-in-time&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_type</span> <span class="o">=</span> <span class="s1">&#39;timerange&#39;</span>

        <span class="n">l_operation</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span>
        <span class="n">l_restore</span> <span class="o">=</span> <span class="s1">&#39;with restore&#39;</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;do&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;no restore&#39;</span>
        <span class="n">l_sdi</span> <span class="o">=</span> <span class="s1">&#39;with deleted items&#39;</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show_deleted&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;without deleted items&#39;</span>

        <span class="k">if</span> <span class="n">l_level</span> <span class="o">==</span> <span class="s1">&#39;job&#39;</span><span class="p">:</span>
            <span class="n">l_line</span> <span class="o">=</span> <span class="s1">&#39;Verifying - job level - </span><span class="si">{0}</span><span class="s1"> - for job </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">l_operation</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_line</span> <span class="o">=</span> <span class="s1">&#39;Verifying - </span><span class="si">{0}</span><span class="s1"> - </span><span class="si">{1}</span><span class="s1"> - at </span><span class="si">{2}</span><span class="s1"> level - </span><span class="si">{3}</span><span class="s1"> - </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">l_type</span><span class="p">,</span> <span class="n">l_operation</span><span class="p">,</span> <span class="n">l_level</span><span class="p">,</span> <span class="n">l_sdi</span><span class="p">,</span> <span class="n">l_restore</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;********** &#39;</span> <span class="o">+</span> <span class="n">l_line</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; **********&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Validation.register_subclient"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.register_subclient">[docs]</a>    <span class="k">def</span> <span class="nf">register_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_obj</span><span class="p">,</span> <span class="n">sc_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers a subclient to the validation object</span>

<span class="sd">            Args:</span>
<span class="sd">                subclient_obj   (obj)           The subclient object</span>
<span class="sd">                sc_props        (dict)          Subclient properties</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subclient_obj</span><span class="p">,</span> <span class="n">Subclient</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Subclient object expected as argument to register with validation object&#39;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">content</span>
        <span class="n">storage_policy_name</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">storage_policy</span>
        <span class="n">nversion</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">file_version</span><span class="p">[</span><span class="s1">&#39;DaysOrNumber&#39;</span><span class="p">]</span>
        <span class="n">drop_deleted_age</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9999999999</span> <span class="k">if</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">backup_retention_days</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">else</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">backup_retention_days</span><span class="p">)</span>

        <span class="n">sc_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">sc_props</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sc_props</span>
        <span class="n">collect_file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">collect_file_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">collect_file_dir</span><span class="p">)</span>

        <span class="n">collect_file_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collect_file_dir</span><span class="p">,</span> <span class="s1">&#39;full_job.txt&#39;</span><span class="p">)</span>
        <span class="n">collect_file_inc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collect_file_dir</span><span class="p">,</span> <span class="s1">&#39;inc_job.txt&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;obj&#39;</span><span class="p">:</span> <span class="n">subclient_obj</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
            <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">storage_policy_name</span><span class="p">,</span>
            <span class="s1">&#39;nversion&#39;</span><span class="p">:</span> <span class="n">nversion</span><span class="p">,</span>
            <span class="s1">&#39;drop_deleted_age&#39;</span><span class="p">:</span> <span class="n">drop_deleted_age</span><span class="p">,</span>
            <span class="s1">&#39;collect_files&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="n">collect_file_full</span><span class="p">,</span>
                <span class="s1">&#39;inc&#39;</span><span class="p">:</span> <span class="n">collect_file_inc</span>
            <span class="p">},</span>
            <span class="s1">&#39;current_cycle&#39;</span><span class="p">:</span> <span class="n">sc_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_cycle&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">sc_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">),</span>
            <span class="s1">&#39;last_job_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;last_job_id&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Registered new subclient [</span><span class="si">{0}</span><span class="s1">] - [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Validation.record_job"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.record_job">[docs]</a>    <span class="k">def</span> <span class="nf">record_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scans the test data, calculates the modified/added/deleted items of the subclient</span>
<span class="sd">            and adds them into the SQLite DB for validation</span>

<span class="sd">            Args:</span>
<span class="sd">                job_obj       (obj)       The CvPySDK job object</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of items which were found in subclient test data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_obj</span><span class="p">,</span> <span class="n">Job</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Job object is expected as argument to record job for validation&#39;</span><span class="p">)</span>

        <span class="n">subclient</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="n">job_type</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">backup_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span>
        <span class="n">job_endtime</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">convert_to_timestamp</span><span class="p">(</span><span class="n">job_obj</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Recording the changes of the subclient and updating &#39;</span>
            <span class="s1">&#39;the DB for subclient [</span><span class="si">{0}</span><span class="s1">] job [</span><span class="si">{1}</span><span class="s1">] jobId [</span><span class="si">{2}</span><span class="s1">] end time [</span><span class="si">{3}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">subclient</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_endtime</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Subclient [</span><span class="si">{0}</span><span class="s1">] is not registered with validation object&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">subclient</span><span class="p">))</span>

        <span class="n">final_items</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;current_cycle&#39;</span><span class="p">]</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span>
        <span class="n">nversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;nversion&#39;</span><span class="p">]</span>
        <span class="n">drop_deleted_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;drop_deleted_age&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;incremental&#39;</span><span class="p">,</span> <span class="s1">&#39;differential&#39;</span><span class="p">):</span>

            <span class="c1"># Scan testdata items</span>
            <span class="n">scan_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_test_data</span><span class="p">(</span><span class="n">subclient</span><span class="p">)</span>

            <span class="c1"># Identify testdata modifications</span>
            <span class="n">final_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_testdata_changes</span><span class="p">(</span><span class="n">scan_items</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="n">subclient</span><span class="p">,</span>
                <span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                <span class="s1">&#39;job_type&#39;</span><span class="p">:</span> <span class="n">job_type</span><span class="p">,</span>
                <span class="s1">&#39;job_endtime&#39;</span><span class="p">:</span> <span class="n">job_endtime</span><span class="p">,</span>
                <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle</span>
            <span class="p">})</span>

            <span class="c1"># Filter eligible items from the scanned list</span>
            <span class="n">final_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_scan_results</span><span class="p">(</span><span class="n">final_items</span><span class="p">,</span> <span class="n">job_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_collect_file</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">scan_items</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_collect_file</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="n">scan_items</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;synthetic full&#39;</span><span class="p">:</span>

            <span class="c1"># If the last job is SFULL then replace the FULL collect file with last INC&#39;s state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating local collect file of FULL for the new cycle&#39;</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;collect_files&#39;</span><span class="p">][</span><span class="s1">&#39;inc&#39;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;collect_files&#39;</span><span class="p">][</span><span class="s1">&#39;full&#39;</span><span class="p">])</span>

            <span class="n">sfull_query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;select * from indexing where subclient = &quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span>
                           <span class="s1">&#39;and cycle = &quot;</span><span class="si">{1}</span><span class="s1">&quot; and jobid &lt; &quot;</span><span class="si">{2}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">subclient</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>

            <span class="n">sfull_props</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;jobid&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;jobendtime&#39;</span><span class="p">:</span> <span class="n">job_endtime</span>
            <span class="p">}</span>

            <span class="c1"># Include latest version + x number of previous versions (specified while initializing)</span>
            <span class="n">version_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nversion</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">final_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_db</span><span class="p">(</span><span class="n">sfull_query</span><span class="p">,</span> <span class="n">version_count</span><span class="p">,</span> <span class="n">sfull_props</span><span class="p">,</span> <span class="n">drop_deleted_age</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;current_cycle&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Update cycle number for jobs which ran in parallel with SFULL</span>
            <span class="n">cycle_change_query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;update indexing set cycle = &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span>
                                  <span class="s1">&#39; where subclient = &quot;</span><span class="si">{1}</span><span class="s1">&quot; and jobid &gt; &quot;</span><span class="si">{2}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;current_cycle&#39;</span><span class="p">],</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Updating cycle number for jobs which ran in parallel with SFULL [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">cycle_change_query</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cycle_change_query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;last_job_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclients</span><span class="p">[</span><span class="n">subclient</span><span class="p">][</span><span class="s1">&#39;last_job_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_id</span>

        <span class="c1"># Insert the eligible items from scan results to the SQLite DB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_into_db</span><span class="p">(</span><span class="n">final_items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_into_spcopy</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Automatic backup copy conditions</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;fs_block&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_after_backup_copy</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fs_snap&#39;</span><span class="p">,</span> <span class="s1">&#39;fs_snap_skipcatalog&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SFULL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFULL&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_after_backup_copy</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_items</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">final_items</span></div>

<div class="viewcode-block" id="Validation.validate_browse_restore"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.validate_browse_restore">[docs]</a>    <span class="k">def</span> <span class="nf">validate_browse_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs browse &amp; restore operation and validates the results of both</span>

<span class="sd">            Args:</span>
<span class="sd">                options         (dict)          Dictionary of browse/restore options</span>

<span class="sd">            Returns:</span>
<span class="sd">                 0 on validation passed</span>
<span class="sd">                -1 on validation failed</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_print_browse_log_line</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Browse operation</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">]:</span>
            <span class="n">ret_code</span><span class="p">,</span> <span class="n">browse_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_browse</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span><span class="p">:</span>
            <span class="n">ret_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_browse_recursive</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Browse operation returned unexpected results. Not performing restore&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Restore operation</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;do&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ret_code</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ret_code</span><span class="p">,</span> <span class="n">restore_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_restore</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret_code</span></div>

<div class="viewcode-block" id="Validation.validate_browse"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.validate_browse">[docs]</a>    <span class="k">def</span> <span class="nf">validate_browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs browse/find/version operation and validates the actual and expected results</span>

<span class="sd">            Args:</span>
<span class="sd">                options     (dict)      The browse options to validate.</span>
<span class="sd">                                        Refer self.default_options for supported options</span>

<span class="sd">            Returns:</span>
<span class="sd">                ret_code    (int)       0 if browse results are same as expected</span>
<span class="sd">                                        -1 if browse results are mismatching</span>

<span class="sd">                results     (dict)      The browse results from Indexing</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;browse&#39;</span><span class="p">,</span> <span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="s1">&#39;versions&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unrecognized operation set in options&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_browse_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=&gt; Browse options [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>

        <span class="n">ret_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">skip_node</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">page_size</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;page_size&#39;</span><span class="p">]</span>
        <span class="n">actual_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Loop across multiple pages and get actual results</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">current_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">skip_node</span> <span class="o">/</span> <span class="n">page_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">browse_attempts</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;********** Doing browse [</span><span class="si">{0}</span><span class="s1">] - Page [</span><span class="si">{1}</span><span class="s1">] **********&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_browse_count</span><span class="p">,</span> <span class="n">current_page</span>
            <span class="p">))</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ret_code</span><span class="p">,</span> <span class="n">page_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_browse_actual_results</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

                <span class="c1"># If we got partial results, do browse again for 3 times with an interval</span>
                <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">browse_attempts</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">rand_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
                        <span class="n">browse_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Got partial results, trying browse again in [</span><span class="si">{0}</span><span class="s1">] secs. &#39;</span>
                            <span class="s1">&#39;Attempt [</span><span class="si">{1}</span><span class="s1">/3]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rand_time</span><span class="p">,</span> <span class="n">browse_attempts</span><span class="p">))</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">rand_time</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Partial results attempts exhausted. Browse did not give full results&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_live_browse&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Live browse has been initiated successfully as expected&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_live_browse&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Live browse has started unexpectedly. Please check further&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_volume_level&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">page_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Volume level browse returned no items.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">page_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">page_results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">page_size</span><span class="p">:</span>
                <span class="n">actual_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">page_results</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_page</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Quitting as something is wrong, there are about 200 pages !&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="n">actual_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">page_results</span><span class="p">)</span>
                <span class="n">skip_node</span> <span class="o">+=</span> <span class="n">page_size</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;skip_node&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skip_node</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expected_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_browse_expected_results</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to get actual browse results, aborting browse operation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">ret_code</span><span class="p">,</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;browse&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_browse</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Stopping browse beyond this path&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{}</span>

        <span class="n">ret_code</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_browse_results</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">ret_code</span><span class="p">,</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Validation.validate_browse_recursive"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.validate_browse_recursive">[docs]</a>    <span class="k">def</span> <span class="nf">validate_browse_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs browse operation recursively and validates the result</span>

<span class="sd">            Args:</span>
<span class="sd">                options     (dict)      The browse options to validate.</span>
<span class="sd">                                        Refer self.default_options for supported options</span>

<span class="sd">                path        (str)       The starting path to begin recursive browse validation</span>

<span class="sd">                level       (int)       Level of the current path provided</span>

<span class="sd">            Returns:</span>
<span class="sd">                ret_code    (int)       0 if browse results are same as expected</span>
<span class="sd">                                        -1 if browse results are mismatching</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mount_point_level</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mount_point_level&#39;</span><span class="p">]</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Doing browse for path [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">ret_code</span><span class="p">,</span> <span class="n">browse_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_browse</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_volume_level&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">==</span> <span class="n">mount_point_level</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">browse_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Volume level browse is successful. Level </span><span class="si">{0}</span><span class="s1"> returned no items.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mount_point_level</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_verify_live_browse&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">mount_point_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Live browse is expected here, but browse goes &#39;</span>
                           <span class="s1">&#39;further than mount point level </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mount_point_level</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">browse_item</span> <span class="ow">in</span> <span class="n">browse_result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">browse_result</span><span class="p">[</span><span class="n">browse_item</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;directory&#39;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">recursive_browse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_browse_recursive</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">browse_item</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">recursive_browse</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed while verifying result of path [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Validation.validate_restore"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.validate_restore">[docs]</a>    <span class="k">def</span> <span class="nf">validate_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs restore operation and verifies the actual and expected results</span>

<span class="sd">            Args:</span>
<span class="sd">                options     (dict)      The restore options to validate.</span>
<span class="sd">                                        Refer self.default_options for supported options</span>

<span class="sd">            Returns:</span>
<span class="sd">                ret_code    (int)       0 if restore results are same as expected</span>
<span class="sd">                                        -1 if restore results are mismatching</span>

<span class="sd">                results     (dict)      The restore results</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_restore_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;=&gt; Restore options [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>

        <span class="n">restore_client</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dest_client&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">restore_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="k">if</span> <span class="n">restore_client</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">restore_client</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restore_client</span>

        <span class="n">source_items</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]</span>
        <span class="n">source_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_items</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_items</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">source_items</span><span class="p">]</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;source_items&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_items</span>

        <span class="c1"># Initialize restore client object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_restore_client</span><span class="p">(</span><span class="n">restore_client</span><span class="p">)</span>

        <span class="n">rst_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restore_clients</span><span class="p">[</span><span class="n">restore_client</span><span class="p">]</span>
        <span class="n">rc_delim</span> <span class="o">=</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;delim&#39;</span><span class="p">]</span>
        <span class="n">final_dest_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;_force_dest_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">final_dest_path</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;_force_dest_path&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;in_place&#39;</span><span class="p">]:</span>
            <span class="n">final_dest_path</span> <span class="o">=</span> <span class="n">source_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s1">&#39;Restore path is empty. Possibly cannot assume a default restore path&#39;</span><span class="p">)</span>

                <span class="n">dest_path</span> <span class="o">=</span> <span class="n">rst_client</span><span class="p">[</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span>
                    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_path&#39;</span><span class="p">],</span> <span class="n">rc_delim</span>
                <span class="p">)</span>

            <span class="n">final_dest_path</span> <span class="o">=</span> <span class="n">rc_delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dest_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restore_count</span><span class="p">)])</span>

        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;restore&#39;</span><span class="p">][</span><span class="s1">&#39;dest_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_dest_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Destination path [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_dest_path</span><span class="p">))</span>

        <span class="n">ret_code</span><span class="p">,</span> <span class="n">actual_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_restore_actual_results</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expected_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_restore_expected_results</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to run restore job&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">ret_code</span><span class="p">,</span> <span class="p">{}</span>

        <span class="n">ret_code</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_restore_results</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">actual_results</span><span class="p">,</span> <span class="n">expected_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">ret_code</span><span class="p">,</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Validation.do_after_aux_copy"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.do_after_aux_copy">[docs]</a>    <span class="k">def</span> <span class="nf">do_after_aux_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp</span><span class="o">=</span><span class="s1">&#39;no_name_sp&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update validation DB after running auxiliary copy for a job&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s1">&#39;insert into spcopy ( sp, jobid, copy, aged ) select sp, jobid, ?, &quot;no&quot; &#39;</span>
            <span class="s1">&#39;from spcopy where sp = ? and copy &lt;&gt; ?&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;After aux copy operation complete&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Validation.do_after_backup_copy"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.do_after_backup_copy">[docs]</a>    <span class="k">def</span> <span class="nf">do_after_backup_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update validation DB after running backup copy for a storage policy&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_after_aux_copy</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Validation.do_after_data_aging"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.do_after_data_aging">[docs]</a>    <span class="k">def</span> <span class="nf">do_after_data_aging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Marks jobs are aged in the validation DB. The jobs will not be considered for browse</span>
<span class="sd">        and restore for validation</span>

<span class="sd">            Args:</span>
<span class="sd">                jobs        (list)      --      List of jobs to age in validation DB</span>

<span class="sd">                copy        (str)       --      Copy of the SP to age for</span>

<span class="sd">            Returns:</span>
<span class="sd">                None, if operation is successful</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if SQLite DB query execution fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">jobs_list</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update spcopy set aged=&#39;yes&#39; where copy=</span><span class="si">{0}</span><span class="s2"> and jobid in (</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">copy</span><span class="p">,</span> <span class="n">jobs_list</span>
        <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;After data aging operation complete. Jobs [</span><span class="si">{0}</span><span class="s1">] are marked aged &#39;</span>
                      <span class="s1">&#39;in validation DB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobs_list</span><span class="p">))</span></div>

<div class="viewcode-block" id="Validation.do_delete_items"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.do_delete_items">[docs]</a>    <span class="k">def</span> <span class="nf">do_delete_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Marks the given list of items as erased in the the validation DB. The items will then</span>
<span class="sd">        be not considered for browse and restore validation</span>

<span class="sd">            Args:</span>
<span class="sd">                paths   (str/list)      --      List of item paths to mark erased in index</span>

<span class="sd">            Returns:</span>
<span class="sd">                 None, if operation is successful</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if SQLite DB query execution fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">the_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_paths</span> <span class="o">=</span> <span class="n">paths</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">:</span>
            <span class="n">clean_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">remove_trailing_sep</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
            <span class="n">clean_path</span> <span class="o">=</span> <span class="n">commonutils</span><span class="o">.</span><span class="n">add_prefix_sep</span><span class="p">(</span><span class="n">clean_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delim</span><span class="p">)</span>
            <span class="n">clean_path</span> <span class="o">=</span> <span class="n">clean_path</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
            <span class="n">the_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_path</span><span class="p">)</span>

        <span class="n">where_clause</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;path like &quot;&#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">the_paths</span><span class="p">]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;update indexing set erased=&quot;yes&quot; where </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Erasing items from validation DB. Query [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully marked items as erased in validation DB&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Validation.get_items"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.get_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jobendtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subclient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one_result</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries the validation DB and returns items which match as per the parameters passed.</span>

<span class="sd">            Args:</span>
<span class="sd">                parent      (str)       --      Name of the parent folder to filter</span>

<span class="sd">                name        (str)       --      Name of the file to filter</span>

<span class="sd">                type        (str)       --      Type of item to filter. E.g: file, directory</span>

<span class="sd">                status      (str)       --      Status of the file</span>

<span class="sd">                jobid       (tuple)     --      Range of jobids to filter. E.g: (1234, 3456)</span>

<span class="sd">                jobendtime  (tuple)     --      Range of job end timerange to filter</span>

<span class="sd">                cycle       (str)       --      Cycle to filter for</span>

<span class="sd">                subclient   (str)       --      Name of the subclient</span>

<span class="sd">                one_result  (bool)      --      Returns only one result</span>

<span class="sd">            Returns:</span>
<span class="sd">                List of items which were filtered through the criteria</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;select path from indexing where 1=1 &#39;</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and parent like &quot;%&#39;</span> <span class="o">+</span> <span class="n">parent</span> <span class="o">+</span> <span class="s1">&#39;%&quot;&#39;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and name like &quot;%&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;%&quot;&#39;</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and type=&quot;&#39;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and status=&quot;&#39;</span> <span class="o">+</span> <span class="n">status</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and cycle=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and subclient=&quot;&#39;</span> <span class="o">+</span> <span class="n">subclient</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>

        <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and jobid between </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jobid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">jobendtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobendtime</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobendtime</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; and jobendtime between </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobendtime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jobendtime</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get items query [</span><span class="si">{0}</span><span class="s1">]. Got items [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">one_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">items</span></div>

<div class="viewcode-block" id="Validation.cleanup"><a class="viewcode-back" href="../../../source/Indexing.browse_restore.html#Indexing.browse_restore.validation.Validation.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes and deletes the validation DB directory&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning validation repository&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Closing SQLite DB&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping cleanup of validation repository as debugging is enabled.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_failure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping cleanup of validation repository as there is a failure&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Validation repository [</span><span class="si">{0}</span><span class="s1">] is deleted successfully&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_repo_dir</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>