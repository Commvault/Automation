

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MediaAgents.MAUtils.mahelper &mdash; Commvault Automation 11.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>MediaAgents.MAUtils.mahelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for MediaAgents.MAUtils.mahelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>


<span class="sd">&quot;&quot;&quot;This file contains classes named DedupeHelper, CloudLibrary and MMHelper which consists of</span>
<span class="sd"> methods required for MM testacse assistance like DB queries, log parsing, etc.</span>

<span class="sd">Class DedupeHelper:</span>
<span class="sd">    parse_log()                     --  parsing log files in search of a particular pattern</span>

<span class="sd">    change_path()                   --  modifies given path to network path</span>

<span class="sd">    get_primary_objects()           --  Gets primary objects on a SIDB</span>

<span class="sd">    get_secondary_objects()         --  Gets secondary objects on a SIDB</span>

<span class="sd">    get_primary_objects_sec()       --  Gets primary objects of a secondary copy</span>

<span class="sd">    get_secondary_objects_sec()     --  Gets secondary objects on secondary copy</span>

<span class="sd">    get_sidb_ids()                  --  get SIDB store and substore id</span>

<span class="sd">    get_network_transfer_bytes()    --  gets bytes transfered for a job</span>

<span class="sd">    submit_backup_memdb_recon()     --  Launches full backup, kills SIDB to initiate a</span>
<span class="sd">                                        full DDB Recon</span>

<span class="sd">    poll_ddb_reconstruction()       --  Polls CSDB for recon job</span>

<span class="sd">    get_reconstruction_type()	    --  returns if Delta recon or Regular recon or Full recon</span>

<span class="sd">    execute_sidb_command()          --  executes given sidb2 command and returns back the</span>
<span class="sd">                                        output and status</span>

<span class="sd">    get_ddb_partition_ma()          --  Returns dictionary with partition number as key and</span>
<span class="sd">                                        client object of DDB MA as value</span>

<span class="sd">    get_sidb_dump()                 --  Dumps DDB table and returns the content of the dump as</span>
<span class="sd">                                        a string</span>

<span class="sd">    get_ddb_recon_details()         --  gets non-memDB reconstruction job details</span>

<span class="sd">    is_ddb_online()                 --  Checks if DDB status is online or offline</span>

<span class="sd">    get_db_sidb_ids()           	-- get SIDB store and substore ids for DB agent</span>

<span class="sd">    get_vm_sidb_ids()           	-- get SIDB store and substore ids for VSA agent</span>

<span class="sd">    get_running_sidb_processes()    -- Find out SIDB2 proecesses running on given DDB MA and return details</span>
<span class="sd">                                       about Engine Id, Partition ID, Process ID, Job ID</span>

<span class="sd">    is_sidb_running()               -- Check if sidb process for given engine id and partition id (optional)</span>
<span class="sd">                                       is running on DDB MA</span>

<span class="sd">    wait_till_sidb_down()           -- Periodically checks for SIDB process to shut down within given timeout period</span>
<span class="sd">                                       and returns when either SIDB process goes down or when timeout expires.</span>

<span class="sd">    setup_dedupe_environment()      -- get testcase object and setup library,dedupe storage policy,</span>
<span class="sd">                                        backupset and subclient</span>

<span class="sd">    configure_dedupe_storage_policy()   -- creates a new dedupe storage policy if not exists</span>

<span class="sd">    configure_global_dedupe_storage_policy()    --  creates a new global dedupe storage policy if not exists</span>

<span class="sd">    configure_dedupe_secondary_copy()   -- creates Synchronous copy for the storage policy</span>

<span class="sd">    get_primary_recs_count()        -- get latest count of total primary records on the store</span>

<span class="sd">    get_secondary_recs_count()      -- get latest count of total secondary records on the store</span>

<span class="sd">Class MMHelper:</span>
<span class="sd">    get_drive_pool_id()         -- get drivepool id</span>

<span class="sd">    get_spare_pool_id()         -- get spare pool id</span>

<span class="sd">    get_copy_id()               -- get storage policy copy id</span>

<span class="sd">    get_mount_path_id()         -- get mountPath id from mountpath name</span>

<span class="sd">    get_device_controller_id()  -- get device controller id from mountpath id and media agent id</span>

<span class="sd">    get_device_id()             -- get the device id for the given mountpath id</span>

<span class="sd">    get_media_location()        -- get media location id</span>

<span class="sd">    get_device_path()           -- get device path from mountpath id</span>

<span class="sd">    get_device_access_type()     -- get the device access type for the given mountpath id and mediaagent name</span>

<span class="sd">    remove_content_subclient()  -- Deletes subclient data</span>

<span class="sd">    get_archive_file_size()     -- Gets sum of archive file size on a copy/for a job</span>

<span class="sd">    set_opt_lan()               -- Modifies Optimize for concurrent LAN backups option on the MA</span>

<span class="sd">    get_global_param_value()    -- gets param value from gxglobalparam table</span>

<span class="sd">    get_jobs_picked_for_aux()   -- gets number of jobs picked by an auxcopy job</span>

<span class="sd">    get_to_be_copied_jobs()     -- gets number of jobs in to-be-copied state for a copy</span>

<span class="sd">    move_job_start_time()       -- moves job start and end time to number of days behind</span>

<span class="sd">    execute_update_query()      -- executes update query on CSDB</span>

<span class="sd">    cleanup()                   -- deletes backupset, storage policy</span>

<span class="sd">    validate_copy_prune()       -- verifies if a copy exits or deleted</span>

<span class="sd">    validate_job_prune()        -- Validates if a job is aged by checking table entries</span>

<span class="sd">    validate_jmdatastats()      -- Validate if a job id exists in table jmdatastats</span>

<span class="sd">    validate_archfile()         -- Validate if archfile entry for job id is exists</span>

<span class="sd">    validate_archfilecopy()     -- validate if archfilecopy entry for job id exists</span>

<span class="sd">    validate_archchunkmapping() -- Validate if archchunkmapping entry for job id exists</span>

<span class="sd">    validate_job_retentionflag()-- Validate if extended retention flag is set for a job id</span>

<span class="sd">    setup_environment()         -- get testcase object and setup library, non dedupe storage</span>
<span class="sd">                                   policy, backupset and subclient</span>

<span class="sd">    configure_disk_library()    -- Create a new disk library if not exists</span>

<span class="sd">    configure_disk_mount_path() -- Adds a mount path [local/remote] to the disk library</span>

<span class="sd">    configure_cloud_library()   -- Adds a new Cloud Library to the Commcell</span>

<span class="sd">    configure_cloud_mount_path()-- Adds a mount path to the cloud library</span>

<span class="sd">    configure_storage_policy()  -- creates a new storage policy if not exists</span>

<span class="sd">    configure_backupset()       -- Creates a new backupset if not exits</span>

<span class="sd">    configure_subclient()       -- Created a new subclient and added content</span>

<span class="sd">    configure_secondary_copy()  -- Creates a new secondary copy if doesnt exist</span>

<span class="sd">    create_uncompressable_data() -- Creates unique uncompressable data</span>

<span class="sd">    execute_select_query()      -- Executes CSDB select query</span>

<span class="sd">    unload_drive()              -- Unloads the drive on the library given</span>

<span class="sd">    remove_autocopy_schedule()  -- Removes association with System Created Automatic Auxcopy schedule on the given copy</span>


<span class="sd">CloudLibrary:</span>
<span class="sd">    __init__(libraryname, libraryinfo)             --  initialize the cloud library class</span>
<span class="sd">     instance for the commcell</span>

<span class="sd">    cleanup_entities(commcell, log, entity_config) --   static method to cleanup commcell entities.</span>


<span class="sd">Class PowerManagement:</span>
<span class="sd">	</span>
<span class="sd">	configure_cloud_mediaagent()	 -- Setup and configure cloud MediaAgent</span>
<span class="sd">	</span>
<span class="sd">    power_off_media_agents()         -- power-off a list of MediaAgents simultaneously</span>

<span class="sd">    power_on_media_agents()          -- power-on a list of MediaAgents simultaneously</span>

<span class="sd">	validate_powermgmtjobtovmmap_table () -- Validate the entry on MMPowerMgmtJobToVMMap table for the job and MediaAgent</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">zipfile</span><span class="o">,</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">cvpysdk.client</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.database_helper</span> <span class="kn">import</span> <span class="n">MSSQL</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.idautils</span> <span class="kn">import</span> <span class="n">CommonUtils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="kn">import</span> <span class="n">OptionsSelector</span>
<span class="kn">from</span> <span class="nn">MediaAgents</span> <span class="kn">import</span> <span class="n">mediaagentconstants</span>

<div class="viewcode-block" id="DedupeHelper"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper">[docs]</a><span class="k">class</span> <span class="nc">DedupeHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for deduplication helper functions&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes BasicOperations object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">tcinputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;_client&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm_untils</span> <span class="o">=</span> <span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserver_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;_agent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DedupeStorePath&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;backupset_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">backupset_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;subclient_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;storage_policy_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;library_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">library_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;ddb_path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddb_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddb_path</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">ddb_path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">backupset</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">subclient</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_selector</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;MediaAgentName&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

<div class="viewcode-block" id="DedupeHelper.setup_dedupe_environment"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.setup_dedupe_environment">[docs]</a>    <span class="k">def</span> <span class="nf">setup_dedupe_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                get testcase object and setup library, dedupe storage policy, backupset and subclient</span>

<span class="sd">                Returns:</span>
<span class="sd">                    (object)    -- object of disk library</span>
<span class="sd">                    (object)    -- object of storage policy</span>
<span class="sd">                    (object)    -- object of backupset</span>
<span class="sd">                    (object)    -- object of subclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disk_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">configure_disk_library</span><span class="p">()</span>
        <span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_dedupe_storage_policy</span><span class="p">()</span>
        <span class="n">backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">configure_backupset</span><span class="p">()</span>
        <span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">disk_library</span><span class="p">,</span> <span class="n">storage_policy</span><span class="p">,</span> <span class="n">backupset</span><span class="p">,</span> <span class="n">subclient</span></div>

<div class="viewcode-block" id="DedupeHelper.configure_dedupe_storage_policy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.configure_dedupe_storage_policy">[docs]</a>    <span class="k">def</span> <span class="nf">configure_dedupe_storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                        <span class="n">storage_policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">library_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">ma_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">ddb_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">ddb_ma_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                creates a new dedupe storage policy if not exists</span>
<span class="sd">                Agrs:</span>
<span class="sd">                    storage_policy_name (str)   -- storage policy name to create</span>

<span class="sd">                    library_name (str)          -- library to use for creating storage policy</span>

<span class="sd">                    ma_name (str)               -- datapath MA name</span>

<span class="sd">                    ddb_ma_name (str)           -- MA name to create DDB store</span>

<span class="sd">                    ddb_path (str)              -- path to create DDB store</span>

<span class="sd">                Return:</span>
<span class="sd">                    (object)    -- storage policy object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># config storage policy</span>
        <span class="k">if</span> <span class="n">storage_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storage_policy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="n">library_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span>

        <span class="k">if</span> <span class="n">ma_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ddb_ma_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ma_name</span> <span class="o">=</span> <span class="n">ddb_ma_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ddb_ma_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ddb_ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DDBMediaAgentName&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ddb_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ddb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddb_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check SP: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Storage policy...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">ma_name</span><span class="p">,</span>
                                               <span class="n">ddb_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selector</span><span class="o">.</span><span class="n">get_custom_str</span><span class="p">(),</span>
                                               <span class="n">dedup_media_agent</span><span class="o">=</span><span class="n">ddb_ma_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage policy config done.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage policy exists!&quot;</span><span class="p">)</span>
        <span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">storage_policy</span></div>

<div class="viewcode-block" id="DedupeHelper.configure_global_dedupe_storage_policy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.configure_global_dedupe_storage_policy">[docs]</a>    <span class="k">def</span> <span class="nf">configure_global_dedupe_storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_storage_policy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent_name</span><span class="p">,</span>
                                               <span class="n">ddb_path</span><span class="p">,</span> <span class="n">ddb_media_agent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            creates a new global dedupe storage policy if not exists</span>
<span class="sd">                Args:</span>
<span class="sd">                    global_storage_policy_name (str)   --   global storage policy name to create</span>

<span class="sd">                    library_name (str)          --  library to use for creating storage policy</span>

<span class="sd">                    media_agent_name (str)   --  media_agent to be assigned</span>

<span class="sd">                    ddb_path (str)              -- path to create DDB store</span>

<span class="sd">                    ddb_media_agent         (str)   --  media agent name on which deduplication store</span>
<span class="sd">                                                    is to be hosted</span>

<span class="sd">                Return:</span>
<span class="sd">                    (object)    -- storage policy object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check for GDSP : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">global_storage_policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">global_storage_policy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding a new GDSP: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">global_storage_policy_name</span><span class="p">)</span>
            <span class="n">gdsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add_global_storage_policy</span><span class="p">(</span><span class="n">global_storage_policy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span>
                                                                            <span class="n">media_agent_name</span><span class="p">,</span> <span class="n">ddb_path</span><span class="p">,</span> <span class="n">ddb_media_agent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GDSP Configuration Done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gdsp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GDSP already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">global_storage_policy_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="DedupeHelper.configure_dedupe_secondary_copy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.configure_dedupe_secondary_copy">[docs]</a>    <span class="k">def</span> <span class="nf">configure_dedupe_secondary_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_policy</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent_name</span><span class="p">,</span> <span class="n">partition_path</span><span class="p">,</span>
                                        <span class="n">ddb_media_agent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates Synchronous copy for this storage policy</span>

<span class="sd">            Args:</span>
<span class="sd">                storage_policy          (object) --  instance of storage policy to add the copy to</span>

<span class="sd">                copy_name               (str)   --  copy name to create</span>

<span class="sd">                library_name            (str)   --  library name to be assigned</span>

<span class="sd">                media_agent_name        (str)   --  media_agent to be assigned</span>

<span class="sd">                partition_path          (str)   --  path where deduplication store is to be hosted</span>

<span class="sd">                ddb_media_agent         (str)   --  media agent name on which deduplication store</span>
<span class="sd">                                                    is to be hosted</span>

<span class="sd">            \*\*kwargs  (dict)  --  Optional arguments</span>

<span class="sd">                Available kwargs Options:</span>

<span class="sd">                dash_full               (bool)  --  enable DASH full on deduplication store (True/False)</span>

<span class="sd">                source_side_disk_cache  (bool)  -- enable source side disk cache (True/False)</span>

<span class="sd">                software_compression    (bool)  -- enable software compression (True/False)</span>

<span class="sd">            Return:</span>
<span class="sd">                    (object)    -- storage policy copy object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dash_full</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dash_full&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">source_side_disk_cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_side_disk_cache&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">software_compression</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;software_compression&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check Secondary Copy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">storage_policy</span><span class="o">.</span><span class="n">has_copy</span><span class="p">(</span><span class="n">copy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding a new synchronous secondary copy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">)</span>
            <span class="n">storage_policy</span><span class="o">.</span><span class="n">create_dedupe_secondary_copy</span><span class="p">(</span><span class="n">copy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent_name</span><span class="p">,</span>
                                                        <span class="n">partition_path</span><span class="p">,</span>
                                                        <span class="n">ddb_media_agent</span><span class="p">,</span> <span class="n">dash_full</span><span class="p">,</span>
                                                        <span class="n">source_side_disk_cache</span><span class="p">,</span>
                                                        <span class="n">software_compression</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Secondary Copy has created&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage PolicyCopy Exists!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">storage_policy</span><span class="o">.</span><span class="n">get_copy</span><span class="p">(</span><span class="n">copy_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="DedupeHelper.parse_log"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.parse_log">[docs]</a>    <span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">client</span><span class="p">,</span>
                  <span class="n">log_file</span><span class="p">,</span>
                  <span class="n">regex</span><span class="p">,</span>
                  <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">escape_regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">single_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function parses the log file in the specified location based on</span>
<span class="sd">        the given job id and pattern</span>

<span class="sd">        Args:</span>
<span class="sd">            client  (str)   --  MA/Client Name on which log is to be parsed</span>

<span class="sd">            log_file (str)  --  Name of log file to be parsed</span>

<span class="sd">            regex   (str)   --  Pattern to be searched for in the log file</span>

<span class="sd">            jobid   (str)   --  job id of the job within the pattern to be searched</span>

<span class="sd">            escape_regex (bool) -- Add escape characters in regular expression before actual comparison</span>

<span class="sd">            single_file (bool) -- to parse only the provided log file instead of all older logs</span>

<span class="sd">        Returns:</span>
<span class="sd">           (tuple) --  Result of string searched on all log files of a file name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">matched_string</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matched_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">log_directory</span>
        <span class="k">if</span> <span class="n">escape_regex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Escaping regular expression as escape_regex is True&quot;</span><span class="p">)</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_path</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">single_file</span><span class="p">:</span>
            <span class="n">all_log_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got files in path &quot;</span><span class="p">)</span>
            <span class="n">log_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_log_files</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">log_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_info</span> <span class="o">==</span> <span class="s1">&#39;UNIX&#39;</span><span class="p">:</span>
            <span class="n">logfile_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">log</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.bz2&#39;</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;bzip2 -d </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;decompressing .bz2 file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                    <span class="n">exit</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully decompressed log file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">log</span><span class="p">)</span>
                        <span class="n">log_files</span><span class="p">[</span><span class="n">logfile_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.bz2&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to decompress log file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
                <span class="n">logfile_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># get log file versions</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;.bz2&#39;</span><span class="p">]:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">search_term</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
                    <span class="n">log_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="s1">&#39;Log Files&#39;</span><span class="p">)</span>
                    <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="s1">&#39;Base&#39;</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s%s</span><span class="s1">unzip&quot; -o &quot;</span><span class="si">%s</span><span class="s1">&quot; -d &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Decompressed log file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="n">extracted_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">extracted_file</span><span class="p">,</span> <span class="n">search_term</span><span class="o">=</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to Decompress log file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">jobid</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for [</span><span class="si">{0}</span><span class="s2"> in file </span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">regex_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">regex_check</span><span class="p">:</span>
                            <span class="n">matched_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="n">matched_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regex_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Searching for string [</span><span class="si">{0}</span><span class="s2">] for job [</span><span class="si">{1}</span><span class="s2">] in file [</span><span class="si">{2}</span><span class="s2">]</span>
<span class="s2">                                   &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="c1">#required to change a byte stream to string</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">jobid_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)),</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jobid_check</span><span class="p">:</span>
                            <span class="n">regex_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">regex_check</span><span class="p">:</span>
                                <span class="n">matched_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="n">matched_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regex_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{0}</span><span class="s2"> matching line(s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not found!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DedupeHelper.change_path"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.change_path">[docs]</a>    <span class="k">def</span> <span class="nf">change_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change path to a UNC path</span>

<span class="sd">            Args:</span>
<span class="sd">                file_path (str)     --Path of file</span>

<span class="sd">                machine_name (str)  -- Name of mahine on which the file resides</span>

<span class="sd">            Returns:</span>
<span class="sd">                Network path of the file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drive</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="si">{0}</span><span class="se">\\</span><span class="si">{1}</span><span class="s2">$</span><span class="se">\\</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">machine_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_path</span></div>

<div class="viewcode-block" id="DedupeHelper.get_primary_objects"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_primary_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get primary records</span>

<span class="sd">            Args:</span>
<span class="sd">                jobid   (str)   --Job Id for which primary records to be checked</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of primary records added according to the CSDB</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(primaryObjects) from archFileCopyDedup where archfileid in</span>
<span class="s2">                (select id from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_secondary_objects"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_secondary_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get secondary objects</span>

<span class="sd">            Args:</span>
<span class="sd">                jobid (str)     --Job id for which secondary records to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of secondary records in the DDB for this particular job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(secondaryObjects) from archFileCopyDedup where archfileid in</span>
<span class="s2">                 (select id from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_primary_objects_sec"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_primary_objects_sec">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_objects_sec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkup_jobid</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get primary records for secondary copy</span>

<span class="sd">            Args:</span>
<span class="sd">                bkup_jobid  (str)   --Job id of the initial backup</span>

<span class="sd">                copy_name   (str)   --Name of copy on which records are to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of primary records on given copy for given job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 select sum(primaryObjects) from archFileCopyDedup where archfileid in (select id</span>
<span class="s2">                 from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">) and archcopyid</span>
<span class="s2">                 in (select id from archgroupcopy where name =  &#39;</span><span class="si">{1}</span><span class="s2">&#39;)</span>
<span class="s2">                 &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkup_jobid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_secondary_objects_sec"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_secondary_objects_sec">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_objects_sec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkup_jobid</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get secondary records for secondary copy</span>

<span class="sd">            Args:</span>
<span class="sd">                bkup_jobid  (str)   --Job id of the initial backup</span>

<span class="sd">                copy_name   (str)   --Name of copy on which records are to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of secondary records on given copy for given job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 select sum(secondaryObjects) from archFileCopyDedup where archfileid in (select id</span>
<span class="s2">                 from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">) and archcopyid in (select id</span>
<span class="s2">                 from archgroupcopy where name = &#39;</span><span class="si">{1}</span><span class="s2">&#39;)</span>
<span class="s2">                 &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkup_jobid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_sidb_ids"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_sidb_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_sidb_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get SIDB store and substore ids</span>

<span class="sd">        Args:</span>
<span class="sd">            sp_id   (str)   --  Storage policy id</span>

<span class="sd">            copy_name   (str) -- Storage policy copy name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Store ID associated with the storage policy</span>

<span class="sd">            SubStore ID associated with the storage policy copy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting SIDB ids for copy : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select SS.SIDBStoreId, SS.SubStoreId</span>
<span class="s2">                from IdxSIDBSubStore SS inner join archgroupcopy AGC</span>
<span class="s2">                on SS.SIDBStoreId = AGC.SIDBStoreId</span>
<span class="s2">                and AGC.archGroupId = </span><span class="si">{0}</span><span class="s2"> and AGC.name = &#39;</span><span class="si">{1}</span><span class="s2">&#39;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_id</span><span class="p">),</span> <span class="n">copy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cur</span></div>

<div class="viewcode-block" id="DedupeHelper.get_db_sidb_ids"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_db_sidb_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_sidb_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get SIDB store and substore ids for DB agent</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_id   (str)   --  Storage policy copy id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Store ID associated with the storage policy</span>

<span class="sd">            SubStore ID associated with the storage policy copy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting SIDB ids for copy id : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select S.SIDBStoreId, SS.SubStoreId</span>
<span class="s2">                from IdxSIDBStore S,IdxSIDBSubStore Ss ,archCopySIDBStore ACS</span>
<span class="s2">                where  ACS.SIDBStoreId = S.SIDBStoreId </span>
<span class="s2">                and S.SIDBStoreId = SS.SIDBStoreId</span>
<span class="s2">                and SS.SealedTime = 0</span>
<span class="s2">                and S.AppTypeGroupId = 1002</span>
<span class="s2">                and ACS.CopyId = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cur</span></div>

<div class="viewcode-block" id="DedupeHelper.get_vm_sidb_ids"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_vm_sidb_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_sidb_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get SIDB store and substore ids for VSA agent</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_id   (str)   --  Storage policy copy id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Store ID associated with the storage policy</span>

<span class="sd">            SubStore ID associated with the storage policy copy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting SIDB ids for copy id : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select S.SIDBStoreId, SS.SubStoreId</span>
<span class="s2">                from IdxSIDBStore S,IdxSIDBSubStore Ss ,archCopySIDBStore ACS</span>
<span class="s2">                where  ACS.SIDBStoreId = S.SIDBStoreId </span>
<span class="s2">                and S.SIDBStoreId = SS.SIDBStoreId</span>
<span class="s2">                and SS.SealedTime = 0</span>
<span class="s2">                and S.AppTypeGroupId = 1003</span>
<span class="s2">                and ACS.CopyId = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cur</span></div>

<div class="viewcode-block" id="DedupeHelper.get_network_transfer_bytes"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_network_transfer_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_network_transfer_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets bytes transfered for a job</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str) -- job ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            network transferred bytes for a jobid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select nwTransBytes/1024/1024 from JMBkpStats where jobId = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.submit_backup_memdb_recon"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.submit_backup_memdb_recon">[docs]</a>    <span class="k">def</span> <span class="nf">submit_backup_memdb_recon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">subclient_object</span><span class="p">,</span>
                                  <span class="n">sp_name</span><span class="p">,</span>
                                  <span class="n">copy_name</span><span class="p">,</span>
                                  <span class="n">time_out</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launches full backup, kills SIDB to initiate a full DDB Recon</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_object (object)   -- subclient instance</span>

<span class="sd">            sp_name (str)               -- storage policy name</span>

<span class="sd">            copy_name (str)             -- storage policy copy name</span>

<span class="sd">            time_out (int)              -- Time out period to kill SIDB process</span>
<span class="sd">                Default : 5</span>

<span class="sd">        Returns:</span>
<span class="sd">            backup job ID</span>

<span class="sd">            reconstruction job ID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get MA log location</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&quot;SIDBEngine.log&quot;</span>
        <span class="n">bkp_job</span> <span class="o">=</span> <span class="n">subclient_object</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s2">&quot;FULL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup job for delta recon: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">bkp_job</span><span class="p">:</span>
            <span class="c1"># parse log to find string: &quot;Requested by Job-Id &quot;+str(backupJobId)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="p">(</span><span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">],</span>
                                                            <span class="n">log_file</span><span class="p">,</span>
                                                            <span class="sd">&quot;&quot;&quot;Requested by Job-Id {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                <span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">matched_string</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="p">(</span><span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_log</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">],</span> <span class="n">log_file</span><span class="p">,</span>
                    <span class="sd">&quot;&quot;&quot;Requested by Job-Id {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">300</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SIDB2 process did not start in time&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Going to kill SIDB2 prococess in </span><span class="si">{0}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_out</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time_out</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_info</span> <span class="o">==</span> <span class="s1">&#39;UNIX&#39;</span><span class="p">:</span>
                <span class="n">kill_sidb_cmd</span> <span class="o">=</span> <span class="s2">&quot;kill -9 $(ps -e | grep &#39;sidb2&#39; | awk &#39;{print $1}&#39;)&quot;</span>
                <span class="n">exit</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">kill_sidb_cmd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB Killed Successfully&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB not killed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">cmd_to_kill_sidb</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;taskkill /F /IM SIDB2.exe /T /S </span><span class="si">{0}</span><span class="s2"> /U </span><span class="si">{1}</span><span class="s2"> /P </span><span class="si">{2}</span><span class="s2"></span>
<span class="s2">                                   &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentHostName&quot;</span><span class="p">]),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentUsername&quot;</span><span class="p">]),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentPassword&quot;</span><span class="p">]))</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd_to_kill_sidb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">_exit_code</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to kill SIDB2 process&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to kill SIDB2 process&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB2 process killed&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to resume backup job&quot;</span><span class="p">)</span>
            <span class="n">bkp_job</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">recon_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll_ddb_reconstruction</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to resume backup job&quot;</span><span class="p">)</span>
            <span class="n">bkp_job</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bkp_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to run FULL backup with error:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup job completed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bkp_job</span><span class="p">,</span> <span class="n">recon_job</span></div>

<div class="viewcode-block" id="DedupeHelper.poll_ddb_reconstruction"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.poll_ddb_reconstruction">[docs]</a>    <span class="k">def</span> <span class="nf">poll_ddb_reconstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">,</span> <span class="n">no_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polls whether DDB reconstruction jobs started and if started waits for</span>
<span class="sd">        completion and reports the status.</span>

<span class="sd">        Args:</span>
<span class="sd">            sp_name (str)   -- storage policy name</span>
<span class="sd">            copy_name (str) -- storage policy copy name</span>
<span class="sd">            no_wait (boolean)   -- option to wait for recon job to complete</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstruction job ID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Poll DDB Recon...&quot;</span><span class="p">)</span>
        <span class="n">query1</span> <span class="o">=</span> <span class="s2">&quot;select id from archGroup where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="n">sp_id</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">copyId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">storeId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sidb_ids</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check if given copy is a GDSP dependent copy&quot;</span><span class="p">)</span>
        <span class="n">query4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT dedupeFlags&amp;134217728</span>
<span class="s2">                    FROM archGroupCopy</span>
<span class="s2">                    WHERE id = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copyId</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query4</span><span class="p">)</span>
        <span class="c1"># copy_id = copyId</span>
        <span class="n">dedFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dedFlag</span> <span class="o">==</span> <span class="s1">&#39;134217728&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected as a GDSP dependent copy&quot;</span><span class="p">)</span>
            <span class="n">query5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT id</span>
<span class="s2">                    FROM archGroupCopy</span>
<span class="s2">                    WHERE SIDBStoreId = </span><span class="si">{0}</span><span class="s2"> AND dedupeFlags&amp;268435456 = 268435456</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">storeId</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query5</span><span class="p">)</span>
            <span class="n">copy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copy_id</span> <span class="o">=</span> <span class="n">copyId</span>

        <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">+</span> <span class="mi">10</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select count(*) from JMAdminJobInfoTable where opType=80 and</span>
<span class="s2">                      archGrpCopyID = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;POLL: DDB reconstruction job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select jobId from JMAdminJobInfoTable where opType=80 and</span>
<span class="s2">                                  archGrpCopyID = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon Job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">recon_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_wait</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recon_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to run delta recon: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recon_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon job completed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">recon_job</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Reconstruction Job does not start in the 10 minutes wait time&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DedupeHelper.get_reconstruction_type"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_reconstruction_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_reconstruction_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recon_job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns if Delta recon or Regular recon or Full recon</span>

<span class="sd">        Args:</span>
<span class="sd">            recon_job_id (int/str)    -- reconstruction job ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            Type of reconstruction job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recon_type</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Delta Reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Regular Reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;Full Reconstruction&#39;</span><span class="p">}</span>
        <span class="n">_query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                  select flags</span>
<span class="s2">                  from IdxSIDBRecoveryHistory</span>
<span class="s2">                  where AdminJobId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">recon_job_id</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="n">recon_flag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">recon_flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Delta Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Regular Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Full Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;recon job type not found&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;no results returned - getReconstructionType&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DedupeHelper.execute_sidb_command"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.execute_sidb_command">[docs]</a>    <span class="k">def</span> <span class="nf">execute_sidb_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">engineid</span><span class="p">,</span> <span class="n">groupnumber</span><span class="p">,</span> <span class="n">ddbmaobject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute sidb2 command like compact or reindex to get output</span>

<span class="sd">        Args:</span>
<span class="sd">            operation (str)     -- sidb2 command option like compact or reindx or validate</span>

<span class="sd">            engineid (int)      -- sidbstore id</span>

<span class="sd">            groupnumber (int)   -- sidb partition number ( eg. single partition</span>
<span class="sd">                                    ddb has partition0 where as double partition ddb has</span>
<span class="sd">                                    partition0 and partition1)</span>

<span class="sd">            ddbmaobject (Client or String) -- Client object for DDB MA or Client Name</span>

<span class="sd">            instance (String)   --  Simpana instance</span>
<span class="sd">                                    Default : Instance001</span>
<span class="sd">        Returns:</span>
<span class="sd">            Output list - [returnstatus, output]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddbmaobject</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
            <span class="n">ddbma_clientobj</span> <span class="o">=</span> <span class="n">ddbmaobject</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddbmaobject</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ddbma_clientobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ddbmaobject</span><span class="p">)</span>

        <span class="n">os_sep</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;windows&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os_sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>

        <span class="n">basedir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">Base</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="n">os_sep</span><span class="p">)</span>
        <span class="n">sidb2cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{0}</span><span class="s2">sidb2</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># If WIN MA, enclose in double quotes</span>
        <span class="k">if</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;windows&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> -</span><span class="si">{5}</span><span class="s2"> -in </span><span class="si">{1}</span><span class="s2"> -cn </span><span class="si">{2}</span><span class="s2"> -i </span><span class="si">{3}</span><span class="s2"> -split </span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">sidb2cmd</span><span class="p">,</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="n">engineid</span><span class="p">,</span> <span class="n">groupnumber</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If LINUX MA, use stdbuf -o0</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;stdbuf -o0 </span><span class="si">{0}</span><span class="s2"> -</span><span class="si">{5}</span><span class="s2"> -in </span><span class="si">{1}</span><span class="s2"> -cn </span><span class="si">{2}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -i </span><span class="si">{3}</span><span class="s2"> -split </span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sidb2cmd</span><span class="p">,</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
                                                  <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span> <span class="n">engineid</span><span class="p">,</span>
                                                  <span class="n">groupnumber</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="DedupeHelper.get_ddb_partition_ma"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_ddb_partition_ma">[docs]</a>    <span class="k">def</span> <span class="nf">get_ddb_partition_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sidbstoreid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary having mapping of group number to ddb ma</span>
<span class="sd">        Args:</span>
<span class="sd">         sidbstoreid: sidb store id</span>

<span class="sd">        Return:</span>
<span class="sd">            Dictionary containing group number ==&gt; DDB MA client object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select idxsidbsubstore.GroupNumber,APP_Client.name from</span>
<span class="s2">        idxsidbsubstore inner join APP_Client</span>
<span class="s2">        on idxsidbsubstore.ClientId = APP_Client.id</span>
<span class="s2">        where sidbstoreid = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">        order by IdxSIDBSubStore.GroupNumber&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sidbstoreid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Firing query to find DDB MAs for given SIDB store ==&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">ddbmalist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="n">ddbma_partition_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ddbma</span> <span class="ow">in</span> <span class="n">ddbmalist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating client object for DDB MA ==&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddbma</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ddbma_partition_dict</span><span class="p">[</span><span class="n">ddbma</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ddbma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ddbma_partition_dict</span></div>

<div class="viewcode-block" id="DedupeHelper.get_sidb_dump"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_sidb_dump">[docs]</a>    <span class="k">def</span> <span class="nf">get_sidb_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span> <span class="n">dump_path</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps the SIDB and returns the table as string</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name --  (str)   --  name of the client on which the ddb is located</span>

<span class="sd">                type        --  (str)   --  type of table</span>
<span class="sd">                                            (Primary/Secondary)</span>

<span class="sd">                store_id    --  (str)   -- DDB Store ID</span>

<span class="sd">                dump_path   --  (str)   --  Path where the sidb can be dumped</span>

<span class="sd">                split       --  (int)   --  Split number of DDB</span>

<span class="sd">        Returns:</span>
<span class="sd">                file content of the dump as a string</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">os_info</span> <span class="o">==</span> <span class="s1">&#39;WINDOWS&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;&amp; &#39;</span><span class="si">{0}{1}</span><span class="s2">Base</span><span class="si">{1}</span><span class="s2">SIDB2.exe&#39; -dump </span><span class="si">{2}</span><span class="s2"> -i </span><span class="si">{3}</span><span class="s2"> -split </span><span class="si">{4}</span><span class="s2"> </span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">machine_obj</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span>
                <span class="n">split</span><span class="p">,</span>
                <span class="n">dump_path</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">os_info</span> <span class="o">==</span> <span class="s1">&#39;UNIX&#39;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;(cd </span><span class="si">{0}{1}</span><span class="s2">Base ; ./sidb2 -dump </span><span class="si">{2}</span><span class="s2"> -i </span><span class="si">{3}</span><span class="s2"> -split </span><span class="si">{4}</span><span class="s2"> </span><span class="si">{5}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">machine_obj</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span>
                <span class="n">split</span><span class="p">,</span>
                <span class="n">dump_path</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="n">dump</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">dump_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dump</span></div>

<div class="viewcode-block" id="DedupeHelper.get_ddb_recon_details"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_ddb_recon_details">[docs]</a>    <span class="k">def</span> <span class="nf">get_ddb_recon_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">,</span> <span class="n">wait_for_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets non-memDB reconstruction job details</span>
<span class="sd">        Args:</span>
<span class="sd">           sp_id                --  (str)   --  Storage policy ID</span>

<span class="sd">           wait_for_complete    --  (bool)  -- wait for job to complete</span>
<span class="sd">           Default : True</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstruction job id</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select jobid </span>
<span class="s2">                from jmadminjobinfotable </span>
<span class="s2">                where optype = 80 </span>
<span class="s2">                and archGrpID = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">recon_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started recon job : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">recon_job_id</span><span class="p">)))</span>
        <span class="n">recon_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">job_controller</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">recon_job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait_for_complete</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;waiting for recon job to complete&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recon_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run </span><span class="si">{0}</span><span class="s2">  with error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;recon job&quot;</span><span class="p">,</span> <span class="n">recon_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon job completed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recon_job_id</span></div>

<div class="viewcode-block" id="DedupeHelper.is_ddb_online"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.is_ddb_online">[docs]</a>    <span class="k">def</span> <span class="nf">is_ddb_online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span> <span class="n">sub_store_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if DDB status is online or offline</span>
<span class="sd">        Args:</span>
<span class="sd">           store_id         --  (str)   --  deduplication store id</span>

<span class="sd">           sub_store_id     --  (str)   --  deduplication substore id</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int)   --  deduplication store status (0 - online, 1 - offline)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking if DDB online&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT status</span>
<span class="s2">                          FROM idxSidbSubStore</span>
<span class="s2">                          WHERE SIDBStoreId =  </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                          AND SubStoreId = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                          &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">store_id</span><span class="p">,</span> <span class="n">sub_store_id</span><span class="p">)</span>
        <span class="n">db_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">execute_select_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">db_response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="DedupeHelper.get_running_sidb_processes"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_running_sidb_processes">[docs]</a>    <span class="k">def</span> <span class="nf">get_running_sidb_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddbma_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find out SIDB2 proecesses running on given DDB MA and return details about each</span>
<span class="sd">        Engine ID</span>
<span class="sd">        Partition ID ( Group Number )</span>
<span class="sd">        Process ID</span>
<span class="sd">        Job ID</span>

<span class="sd">        Args:</span>
<span class="sd">            ddbmaobject     --  (client/str)    -- Client object or Client Name for DDB MA</span>

<span class="sd">        Returns:</span>
<span class="sd">            Output dictionary - {sidb2engineid:(groupnumber,pid,jobid),sidb2engineid:(groupnumber,pid, jobid)..}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddbma_object</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
            <span class="n">ddbma_clientobj</span> <span class="o">=</span> <span class="n">ddbma_object</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddbma_object</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ddbma_clientobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ddbma_object</span><span class="p">)</span>
        <span class="n">is_windows</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># If its a windows machine, make a powershell command else a linux cli</span>
        <span class="k">if</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;windows&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;powershell.exe -command </span><span class="se">\&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">|</span><span class="si">{2}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;Get-WmiObject Win32_Process -Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\&quot;</span><span class="s2">name = &#39;SIDB2.EXE&#39;</span><span class="se">\\\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot; format-table -autosize ProcessId, CommandLine | out-string -width 200&quot;</span><span class="p">)</span>
            <span class="n">is_windows</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;ps -eo pid,command | grep sidb2 | grep -v grep&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">ddbma_clientobj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">engine_partition_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;sidb2&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to find any SIDB2 process&quot;</span><span class="p">)</span>
            <span class="c1"># return empty dictionary</span>
            <span class="k">return</span> <span class="n">engine_partition_map</span>
        <span class="c1"># output from windows &amp; linux is in this format respectively, start parsing it</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ProcessId CommandLine                                                                                                                </span>
<span class="sd">        --------- -----------                                                                                                                </span>
<span class="sd">        12164 &quot;C:\Program Files\Commvault\ContentStore\Base\SIDB2.exe&quot; -j 1714825 -i 808 -c 615 -in Instance001 </span>
<span class="sd">        -cn sbhidesp13cs -group 0</span>
<span class="sd">        14252 &quot;C:\Program Files\Commvault\ContentStore\Base\SIDB2.exe&quot; -j 1714829 -i 856 -c 722 -in Instance001</span>
<span class="sd">         -cn sbhidesp13cs -group 0</span>

<span class="sd">        [root@sbhidesp13lima1 /]# ps -eo pid,command | grep sidb2 | grep -v grep</span>
<span class="sd">        15348 /opt/commvault/Base/sidb2 -j 1714828 -i 7 -c 9 -in Instance001 -cn sbhidesp13lima1 -group 0</span>
<span class="sd">        15350 /opt/commvault/Base/sidb2 -j 1714828 -i 7 -c 9 -in Instance001 -cn sbhidesp13lima1 -group 1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a datastructure which will be a dictionary of following type</span>
        <span class="c1"># key = engineid [as it will be unique ]</span>
        <span class="c1"># value = list of (group number, pid) tuples[ same engine can have multiple partitions running ]</span>
        <span class="n">engine_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;-i \d+&#39;</span><span class="p">)</span>
        <span class="n">groupid_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;-group \d&#39;</span><span class="p">)</span>
        <span class="n">jobid_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;-j \d+&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_windows</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output_lines</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_lines</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># start building dictionary from output</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output_lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;ProcessId&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;CommandLine&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># skip blank lines</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># extract process ID and command line</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">engine_id</span> <span class="o">=</span> <span class="n">engine_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">groupid_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobid_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">groupid_pid_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">group_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">engine_id</span> <span class="ow">in</span> <span class="n">engine_partition_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Appending groupid-&gt;partition-&gt;jobid </span><span class="si">{0}</span><span class="s2"> to engine id </span><span class="si">{1}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">groupid_pid_tuple</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">))</span>
                    <span class="n">engine_partition_map</span><span class="p">[</span><span class="n">engine_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">groupid_pid_tuple</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">engine_partition_map</span><span class="p">[</span><span class="n">engine_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupid_pid_tuple</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding new engine id - partition pair &quot;</span> \
                                   <span class="s2">&quot;to map ==&gt; </span><span class="si">{0}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="n">groupid_pid_tuple</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">engine_partition_map</span></div>

<div class="viewcode-block" id="DedupeHelper.is_sidb_running"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.is_sidb_running">[docs]</a>    <span class="k">def</span> <span class="nf">is_sidb_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">ddbma_object</span><span class="p">,</span> <span class="n">partition_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if sidb process for given engine id and partition id (optional) is running on DDB MA</span>

<span class="sd">        Args:</span>
<span class="sd">            engine_id           --  (int)           --  SIDB Store ID</span>
<span class="sd">            ddbma_object        --  (client/str)    --  Client object or Client name for DDB MA</span>
<span class="sd">            partition_number    --  (int)           --  Group number (0,1 etc.) [ Optional ]</span>
<span class="sd">                                                        Default : Skip checking Partition Number and report</span>
<span class="sd">                                                        if SIDB for given engine ID is active  on the DDB MA</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of (groupid,pid,jobid) tuples if SIDB process is running , empty list otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if sidb process for engine : </span><span class="si">{0}</span><span class="s2"> for partition :</span><span class="si">{1}</span><span class="s2"> is running&quot;</span> \
                       <span class="s2">&quot; on DDB MA </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="n">partition_number</span><span class="p">,</span> <span class="n">ddbma_object</span><span class="o">.</span><span class="n">client_name</span><span class="p">))</span>

        <span class="n">ddb_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_sidb_processes</span><span class="p">(</span><span class="n">ddbma_object</span><span class="p">)</span>
        <span class="c1"># If ddb_map is empty, no sidb process is running on MA</span>
        <span class="k">if</span> <span class="n">ddb_map</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if key with given engine id exists</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">group_pid_tuple_list</span> <span class="o">=</span> <span class="n">ddb_map</span><span class="p">[</span><span class="n">engine_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process id corresponding to engine id : </span><span class="si">{0}</span><span class="s2"> ==&gt; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span>
                                                                                            <span class="n">group_pid_tuple_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">partition_number</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Immediately return True as user has not asked to validate a specific group number</span>
                    <span class="k">return</span> <span class="n">group_pid_tuple_list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Loop over tuples list to see if user provided group number is present</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group_pid_tuple_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">partition_number</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found partition </span><span class="si">{0}</span><span class="s2"> running with pid </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">partition_number</span><span class="p">,</span>
                                                                                             <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No process corresponding to engine id : </span><span class="si">{0}</span><span class="s2"> found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine_id</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="DedupeHelper.wait_till_sidb_down"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.wait_till_sidb_down">[docs]</a>    <span class="k">def</span> <span class="nf">wait_till_sidb_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">ddbma_object</span><span class="p">,</span> <span class="n">partition_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically checks for SIDB process to shut down within given timeout period and returns when</span>
<span class="sd">        either SIDB process goes down or when timeout expires.</span>

<span class="sd">        Periodicity with which SIDB process status gets checked is 30 seconds.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine_id                   --  (int)           --  SIDB Store ID</span>
<span class="sd">            ddbma_object                --  (client/str)    --  Client object or Client name for DDB MA</span>
<span class="sd">            partition_number            --  (int)           --  Group number (0,1 etc.) [ Optional ]</span>
<span class="sd">                                                                Default : Skip checking Partition Number and report</span>
<span class="sd">                                                                if SIDB for given engine ID is active  on the DDB MA</span>
<span class="sd">            timeout                     --  (int)           --  Maximum wait time in seconds [ Optional ]</span>
<span class="sd">                                                                Default : 600 seconds</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Boolean) True if SIDB process stops running , False if it keeps running even after timeout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_step</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">time_elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">time_elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="n">is_running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sidb_running</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="n">ddbma_object</span><span class="p">,</span> <span class="n">partition_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_running</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB Process still running ==&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">is_running</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time_elapsed</span> <span class="o">+</span> <span class="n">time_step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB Process doesn&#39;t seem to be running ==&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">is_running</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># As we are here, it means we spent entire timeout period in waiting for SIDB to go down</span>
        <span class="c1"># Return False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB Process did not go down within given timeout period&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DedupeHelper.get_primary_recs_count"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_primary_recs_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_recs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get latest count of total primary records on the store</span>
<span class="sd">        Args:</span>
<span class="sd">            store_id (int): SIDB store ID or Engine ID to get primary count</span>
<span class="sd">            db_password (str): CSDB password to use to run query to get primary count</span>
<span class="sd">            db_user (str):  CSDB username to login</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int) total primary records count on the store id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;with x as (</span>
<span class="s2">                select row_number() over (partition by substoreid order by modifiedtime desc) as y,*</span>
<span class="s2">                from idxsidbusagehistory where historytype = 0)</span>
<span class="s2">                select sum(x.primaryentries)</span>
<span class="s2">                from x where y = 1</span>
<span class="s2">                    and x.sidbstoreid = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                group by x.sidbstoreid&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">db_password</span><span class="o">=</span><span class="n">db_password</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="n">db_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_secondary_recs_count"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.DedupeHelper.get_secondary_recs_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_recs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span> <span class="n">db_password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get latest count of total secondary records on the store</span>
<span class="sd">        Args:</span>
<span class="sd">            store_id (int): SIDB store ID or Engine ID to get secondary count</span>
<span class="sd">            db_password (str): CSDB password to use to run query to get secondary count</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int) total secondary records count on the store id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;with x as (</span>
<span class="s2">                select row_number() over (partition by substoreid order by modifiedtime desc) as y,*</span>
<span class="s2">                from idxsidbusagehistory where historytype = 0)</span>
<span class="s2">                select sum(x.secondaryentries)</span>
<span class="s2">                from x where y = 1</span>
<span class="s2">                    and x.sidbstoreid = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                group by x.sidbstoreid&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">db_password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="MMHelper"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper">[docs]</a><span class="k">class</span> <span class="nc">MMHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base clasee for media management helper functions&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes BasicOperations object</span>

<span class="sd">        Args:</span>
<span class="sd">            test_case_obj (object)  --  instance of the CVtestcase class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">tcinputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;_client&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserver_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_windows_cs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserve_instance</span> <span class="o">=</span> <span class="s2">&quot;commvault&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;_agent&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;backupset_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">backupset_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;subclient_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;storage_policy_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;library_name&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">library_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ContentPath&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">,</span> <span class="s1">&#39;test_data_path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">test_data_path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_client</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;unix&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_windows_cs</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commserve_instance</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_sep</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;SqlSaPassword&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">:</span>
            <span class="n">dbpassword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SqlSaPassword&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbobject</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_hostname</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_sep</span> <span class="o">+</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">commserve_instance</span><span class="p">,</span>
                                  <span class="s2">&quot;sa&quot;</span><span class="p">,</span> <span class="n">dbpassword</span><span class="p">,</span> <span class="s2">&quot;CommServ&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="MMHelper.get_drive_pool_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_drive_pool_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_drive_pool_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get drivepool id</span>

<span class="sd">        Args:</span>
<span class="sd">            tape_id   (str)   --  Tape library ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            DrivePool id of the given Tape library</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select *</span>
<span class="sd">            from MMDrivePool</span>
<span class="sd">            where MasterPoolId =</span>
<span class="sd">            (select MasterPoolId</span>
<span class="sd">            from MMMasterPool</span>
<span class="sd">            where LibraryId = {0})</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tape_id</span><span class="p">)))</span>
        <span class="n">drive_pool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">drive_pool_id</span></div>

<div class="viewcode-block" id="MMHelper.get_spare_pool_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_spare_pool_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_spare_pool_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get sparepool id</span>

<span class="sd">        Args:</span>
<span class="sd">            tape_id   (str)   --  Tape library ID</span>

<span class="sd">        Returns:</span>
<span class="sd">                SparePool id of the given Tape library</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select *</span>
<span class="sd">            from MMSpareGroup</span>
<span class="sd">            where LibraryId = {0}</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tape_id</span><span class="p">)))</span>
        <span class="n">spare_pool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">spare_pool_id</span></div>

<div class="viewcode-block" id="MMHelper.get_copy_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_copy_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get copy id</span>

<span class="sd">         Args:</span>
<span class="sd">            sp_name     (str) --  Storage policy name</span>

<span class="sd">            copy_name   (str) -- Storage policy copy name</span>

<span class="sd">        Returns:</span>
<span class="sd">                Copy id for the given storage policy/copy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot; SELECT AGC.id</span>
<span class="sd">                FROM archgroup AG</span>
<span class="sd">                    INNER JOIN archgroupcopy AGC ON AG.id = AGC.archgroupid</span>
<span class="sd">                WHERE AG.name =&#39;{0}&#39; AND AGC.name = &#39;{1}&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">))</span>
        <span class="n">copy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">copy_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MMHelper.get_mount_path_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_mount_path_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_mount_path_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpath_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get MountPathId from MountPathName</span>

<span class="sd">        Agrs:</span>
<span class="sd">            mountpath_name (str)  --  Mountpath name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mountpath Id for the given Mountpath name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT	MountPathId</span>
<span class="s2">                    FROM	MMMountPath </span>
<span class="s2">                    WHERE	MountPathName = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mountpath_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No entries present&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid MountPathName&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_device_controller_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_device_controller_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_controller_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpath_id</span><span class="p">,</span> <span class="n">media_agent_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get device controller id from mountpath id and media agent id</span>
<span class="sd">        Args:</span>
<span class="sd">            mountpath_id (int)  --  mountpath Id</span>

<span class="sd">            media_agent_id (int) -- media agent Id</span>

<span class="sd">        Returns:</span>
<span class="sd">            Device Controller id for the given mountpath Id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT	MDC.DeviceControllerId</span>
<span class="s2">                    FROM	MMDeviceController MDC</span>
<span class="s2">                    JOIN	MMMountPathToStorageDevice MPSD</span>
<span class="s2">                            ON	MDC.DeviceId = MPSD.DeviceId</span>
<span class="s2">                    JOIN	MMMountPath MP</span>
<span class="s2">                            ON	MPSD.MountPathId = MP.MountPathId</span>
<span class="s2">                    WHERE	MP.MountPathId = </span><span class="si">{0}</span><span class="s2"> AND</span>
<span class="s2">                            MDC.ClientId = </span><span class="si">{1}</span><span class="s2"> &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mountpath_id</span><span class="p">,</span> <span class="n">media_agent_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No entries present&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid MountPathId or ClientId&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_device_id"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_device_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpath_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the device id for the given mountpath id</span>
<span class="sd">            Args:</span>
<span class="sd">             mountpath_id(int)   -   Mountpath Id</span>

<span class="sd">            Returns:</span>
<span class="sd">                int    --  device id</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT	DeviceId</span>
<span class="s2">                  FROM	MMMountPathToStorageDevice</span>
<span class="s2">                  WHERE	MountPathId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mountpath_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to fetch device id&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_media_location"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_media_location">[docs]</a>    <span class="k">def</span> <span class="nf">get_media_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get media location Id</span>
<span class="sd">            Args:</span>
<span class="sd">                media_name (str) : BarCode of the media</span>
<span class="sd">            Returns:</span>
<span class="sd">                Slot Id of the Media</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;SELECT	SlotId</span>
<span class="s2">                    FROM	MMSlot MS</span>
<span class="s2">                    JOIN	MMMedia MM</span>
<span class="s2">                            ON MM.MediaId = MS.MediaId</span>
<span class="s2">                    WHERE	MM.BarCode = &#39;</span><span class="si">{</span><span class="n">media_name</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to fetch media location&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_device_path"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_device_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpath_id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Device Path from MountpathId</span>
<span class="sd">        Agrs:</span>
<span class="sd">            mountpath_id (int)  --  Mountpath Id</span>
<span class="sd">        Returns:</span>
<span class="sd">            Device Path for the given Mountpath Id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT	MDC.Folder</span>
<span class="s2">                    FROM	MMDeviceController MDC</span>
<span class="s2">                    JOIN	MMMountPathToStorageDevice MPSD</span>
<span class="s2">                            ON	MDC.DeviceId = MPSD.DeviceId</span>
<span class="s2">                    JOIN	MMMountPath MP</span>
<span class="s2">                            ON	MPSD.MountPathId = MP.MountPathId</span>
<span class="s2">                    WHERE	MP.MountPathId = </span><span class="si">{0}</span><span class="s2"> AND</span>
<span class="s2">                            MDC.ClientId = </span><span class="si">{1}</span><span class="s2"> &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mountpath_id</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No entries present&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid MountPathId or ClientId&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_device_access_type"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_device_access_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_device_access_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mountpath_id</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To get the device access type for the given mountpath id and mediaagent name</span>
<span class="sd">            Args:</span>
<span class="sd">             mountpath_id(int)   -   Mountpath Id</span>

<span class="sd">             media_agent(str)    -   MediaAgent Name</span>

<span class="sd">            Returns:</span>
<span class="sd">                int    --  device access type</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT	MDC.DeviceAccessType</span>
<span class="s2">                    FROM	MMDeviceController MDC</span>
<span class="s2">                    JOIN	MMMountPathToStorageDevice MPSD</span>
<span class="s2">                            ON	MDC.DeviceId = MPSD.DeviceId</span>
<span class="s2">                    JOIN	APP_Client Cli</span>
<span class="s2">                            ON	MDC.ClientId = Cli.id</span>
<span class="s2">                    WHERE	MPSD.MountPathId = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                            AND	Cli.name = &#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mountpath_id</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to fetch device access type&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.remove_content"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.remove_content">[docs]</a>    <span class="k">def</span> <span class="nf">remove_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data_path</span><span class="p">,</span> <span class="n">client_machine</span><span class="p">,</span> <span class="n">num_files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes subclient data</span>

<span class="sd">        Args:</span>
<span class="sd">            test_data_path  (str)   --  path where the subclient backup content is present</span>

<span class="sd">            client_machine  (obj)   --  object for the client machine on which subclient is present</span>

<span class="sd">            num_files       (int)   --  Number of files to be deleted</span>
<span class="sd">            Default : None [all files to be deleted]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of files deleted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">client_machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">test_data_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting all files&quot;</span><span class="p">)</span>
            <span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">test_data_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">{0}</span><span class="s2"> files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_files</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_files</span><span class="p">):</span>
                <span class="n">client_machine</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">num_files</span></div>

<div class="viewcode-block" id="MMHelper.get_archive_file_size"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_archive_file_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_archive_file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets sum of archive file size on a copy/for a job</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_id  (str)   --  storage policy copy id</span>

<span class="sd">            job_id   (str)   --  job id</span>
<span class="sd">            Default : None</span>

<span class="sd">        Returns:</span>
<span class="sd">            sum of archive file size</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(physicalSize)</span>
<span class="s2">                    from archChunkMapping</span>
<span class="s2">                    where archCopyId = </span><span class="si">{0}</span><span class="s2"> and jobid in</span>
<span class="s2">                        (select distinct jobid</span>
<span class="s2">                        from jmjobdatastats</span>
<span class="s2">                        where archgrpcopyid = </span><span class="si">{0}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(physicalSize)</span>
<span class="s2">                                from archChunkMapping</span>
<span class="s2">                                where archCopyId = </span><span class="si">{0}</span><span class="s2"> and jobid = </span><span class="si">{1}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="MMHelper.set_opt_lan"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.set_opt_lan">[docs]</a>    <span class="k">def</span> <span class="nf">set_opt_lan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">server_name</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">client_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Modifies Optimize for concurrent LAN backups option on the MA</span>

<span class="sd">            Args:</span>
<span class="sd">                value       (str)   -- Disable/Enable</span>

<span class="sd">                server_name (str)   -- SQL server name</span>

<span class="sd">                user        (str)   -- username for the SQL</span>

<span class="sd">                password    (str)   -- password for SQL (from registry)</span>

<span class="sd">                client_id   (str)   -- client machine ID</span>

<span class="sd">                e.g:</span>
<span class="sd">                    mmhelper_obj.set_opt_lan(&quot;Enable&quot;,&quot;######&quot;,</span>
<span class="sd">                    &quot;sa&quot;, &quot;######&quot;, &quot;2&quot;)</span>

<span class="sd">            Raises:</span>
<span class="sd">                SDKException:</span>
<span class="sd">                    if input is incorrect</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;disable&quot;</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;&amp;~&quot;</span>
        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;enable&quot;</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Input is not correct&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE MMHost</span>
<span class="s2">                SET Attribute = Attribute </span><span class="si">{0}</span><span class="s2"> 32</span>
<span class="s2">                WHERE ClientId = </span><span class="si">{1}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="c1">#As Linux CS does not have any instance name, if user has provided instance name as commvault</span>
        <span class="c1">#strip off the instance name and use only server_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_windows_cs</span><span class="p">:</span>
            <span class="n">sql_server_name</span><span class="p">,</span> <span class="n">sql_instance</span> <span class="o">=</span> <span class="n">server_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">server_name</span>  <span class="o">=</span> <span class="n">sql_server_name</span>

        <span class="n">mssql</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span><span class="n">server_name</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="s2">&quot;CommServ&quot;</span><span class="p">)</span>
        <span class="n">mssql</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.get_global_param_value"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_global_param_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_global_param_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets param value from gxglobalparam table</span>
<span class="sd">        Args:</span>
<span class="sd">            param_name   (str)   --  global parameter name</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int)   param value set in DB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select value</span>
<span class="s2">                    from gxglobalparam</span>
<span class="s2">                    where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="MMHelper.get_jobs_picked_for_aux"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_jobs_picked_for_aux">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs_picked_for_aux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auxcopy_job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets number of jobs picked by an auxcopy job</span>
<span class="sd">        Args:</span>
<span class="sd">            auxcopy_job_id   (str)   --  global parameter name</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int)   number of the jobs picked by auxcopy job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT COUNT(DISTINCT BackupJobID)</span>
<span class="s2">            FROM ArchChunkToReplicate</span>
<span class="s2">            WHERE AdminJobID = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">auxcopy_job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="MMHelper.get_to_be_copied_jobs"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.get_to_be_copied_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_to_be_copied_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets number of jobs in to-be-copied state for a copy</span>
<span class="sd">        Args:</span>
<span class="sd">            copy_id   (str)   --  copy id</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int)   count of the jobs picked by auxcopy job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; select count( distinct jobId)</span>
<span class="s2">                    from JMJobDataStats</span>
<span class="s2">                    where status in (101,102,103)</span>
<span class="s2">                    and archGrpCopyId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="MMHelper.move_job_start_time"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.move_job_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">move_job_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">reduce_days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        runs script to change job time based on number of days in arguments</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- Job ID that needs to be moved with time</span>
<span class="sd">            reduce_days (int) -- number of days to reduce the job time</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) -- True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Moving job </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2"> day(s) behind&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">reduce_days</span><span class="p">))</span>
        <span class="n">sql_script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        DECLARE @curCommCellId INTEGER</span>
<span class="s2">        SET @curCommCellId = 0</span>

<span class="s2">        DECLARE @curJobId INTEGER</span>
<span class="s2">        SET @curJobId = </span><span class="si">{0}</span><span class="s2"></span>

<span class="s2">        DECLARE @i_days INTEGER</span>
<span class="s2">        SET @i_days = </span><span class="si">{1}</span><span class="s2"></span>

<span class="s2">        SELECT @curCommCellId = commcellId</span>
<span class="s2">        FROM JMBkpStats</span>
<span class="s2">        where jobId = @curJobId</span>

<span class="s2">        UPDATE JMBkpStats</span>
<span class="s2">        SET servStartDate = servStartDate - (@i_days *24* 3600),</span>
<span class="s2">        servEndDate = servEndDate - (@i_days* 24* 3600)</span>
<span class="s2">        WHERE jobId = @curJobId</span>
<span class="s2">        AND commCellId = @curCommCellId</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">reduce_days</span><span class="p">)</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_update_query</span><span class="p">(</span><span class="n">sql_script</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retcode</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;failed to run the script to move job time&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.execute_update_query"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.execute_update_query">[docs]</a>    <span class="k">def</span> <span class="nf">execute_update_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">db_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes update query on CSDB</span>
<span class="sd">        Args:</span>
<span class="sd">            query (str) -- update query that needs to be run on CSDB</span>
<span class="sd">            db_password (str)   -- sa password for CSDB login</span>
<span class="sd">            db_user (str)   -- username for CSDB login</span>

<span class="sd">        Return:</span>
<span class="sd">            Response / exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_user</span><span class="p">:</span>
            <span class="n">db_user</span> <span class="o">=</span> <span class="s2">&quot;sa&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;SqlSaPassword&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="ow">and</span> <span class="n">db_password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">db_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SqlSaPassword&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dbobject</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_hostname</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_sep</span> <span class="o">+</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">commserve_instance</span><span class="p">,</span>
                                  <span class="n">db_user</span><span class="p">,</span> <span class="n">db_password</span><span class="p">,</span> <span class="s2">&quot;CommServ&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbobject</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;failed to execute query </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span></div>

<div class="viewcode-block" id="MMHelper.cleanup"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        deletes backupset, storage policy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;********* cleaning up BackupSet, StoragePolicy ***********&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.validate_copy_prune"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_copy_prune">[docs]</a>    <span class="k">def</span> <span class="nf">validate_copy_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        verifies if a copy exits or deleted</span>
<span class="sd">        Args:</span>
<span class="sd">            copy_name (str) -- copy name to verify if deleted</span>

<span class="sd">        Return:</span>
<span class="sd">             (Bool) True if copy is deleted</span>
<span class="sd">             (Bool) False if copy exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">has_copy</span><span class="p">(</span><span class="n">copy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy exists! &quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy doesnt exist!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MMHelper.validate_job_prune"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_job_prune">[docs]</a>    <span class="k">def</span> <span class="nf">validate_job_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates if a job is aged by checking table entries</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- job id to check for aged</span>
<span class="sd">            copy_id (int) -- copy id needed for the job</span>
<span class="sd">                            if copy_id exist use new query else old one.</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy_id</span><span class="p">:</span>
            <span class="n">jmdatastats_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_jmdatastats</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
            <span class="p">(</span><span class="n">archfile_exists</span><span class="p">,</span> <span class="n">archfile_id</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_archfile</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="p">(</span><span class="n">archchunkmapping_exists</span><span class="p">,</span> <span class="n">archchunkmapping_values</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_archchunkmapping</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jmdatastats_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_jmdatastats</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="p">(</span><span class="n">archfile_exists</span><span class="p">,</span> <span class="n">archfile_id</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_archfile</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="p">(</span><span class="n">archchunkmapping_exists</span><span class="p">,</span> <span class="n">archchunkmapping_values</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_archchunkmapping</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jmdatastats_exists</span> <span class="ow">and</span> <span class="n">archfile_exists</span> <span class="ow">and</span> <span class="n">archchunkmapping_exists</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job </span><span class="si">{0}</span><span class="s2"> is not aged!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job </span><span class="si">{0}</span><span class="s2"> is aged!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MMHelper.validate_jmdatastats"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_jmdatastats">[docs]</a>    <span class="k">def</span> <span class="nf">validate_jmdatastats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if a job id exists in table jmdatastats</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- backup job id to check in table</span>
<span class="sd">            copy_id (Int) -- we can pass copy id to check for particular copy.</span>
<span class="sd">                            if copy_id : then use new query else old one</span>

<span class="sd">        Return:</span>
<span class="sd">            (int) agedTime</span>
<span class="sd">            (int) agedBy</span>
<span class="sd">            (int) disabled flag for the jobid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy_id</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select agedTime, agedBy, disabled&amp;256 from JMJobDataStats where jobId = </span><span class="si">{0}</span><span class="s2"> </span>
<span class="s2">            and archGrpCopyId = </span><span class="si">{1}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select agedTime, agedBy, disabled&amp;256 from JMJobDataStats where jobId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">256</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no entries present&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MMHelper.validate_archfile"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_archfile">[docs]</a>    <span class="k">def</span> <span class="nf">validate_archfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if archfile entry for job id is exists</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- job id to check in table</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) True with archfileid if exists</span>
<span class="sd">            (Bool) False if entry not present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select id from ArchFile where jobid = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no entries present&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="MMHelper.validate_archfilecopy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_archfilecopy">[docs]</a>    <span class="k">def</span> <span class="nf">validate_archfilecopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archfile_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        validate if archfilecopy entry for job id exists</span>
<span class="sd">        Args:</span>
<span class="sd">            archfile_id (int) -- archfile id to check in table</span>
<span class="sd">            copy_id (int) -- copy id to check in table</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) True if entries exist</span>
<span class="sd">            (Bool) False if entries doesnt exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select 1 from archFileCopy where archFileId = </span><span class="si">{0}</span><span class="s2"> and archCopyId = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archfile_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no entries present&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MMHelper.validate_archchunkmapping"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_archchunkmapping">[docs]</a>    <span class="k">def</span> <span class="nf">validate_archchunkmapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if archchunkmapping entry for job id exists</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- job id to check in table</span>
<span class="sd">            copy_id (int) -- copy id of the job to validate for</span>
<span class="sd">                            if copy_id : then use new query else old one</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) True if entries exist</span>
<span class="sd">            (Bool) False if entries doesnt exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy_id</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select archFileId, archChunkId from archchunkmapping where jobId = </span><span class="si">{0}</span><span class="s2"> and archCopyId = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select archFileId, archChunkId from archchunkmapping where jobId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cur</span> <span class="o">!=</span> <span class="p">[[</span><span class="s1">&#39;&#39;</span><span class="p">]]:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no entries present&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="MMHelper.validate_job_retentionflag"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.validate_job_retentionflag">[docs]</a>    <span class="k">def</span> <span class="nf">validate_job_retentionflag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">retention_flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if extended retention flag is set for a job id</span>
<span class="sd">        Args:</span>
<span class="sd">            job_id (int) -- Job id to check for retention flags</span>
<span class="sd">            retention_flag (str) -- retention flag to check for job id</span>

<span class="sd">        Return:</span>
<span class="sd">            (Bool) True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EXTENDED_ALLFULL&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_WEEK&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_MONTH&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_QUARTER&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_HALFYEAR&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_YEAR&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s2">&quot;MANUALLY_PIN&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_WEEK&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_MONTH&quot;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_QUARTER&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_HALFYEAR&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_YEAR&quot;</span><span class="p">:</span> <span class="mi">4098</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_WEEK&quot;</span><span class="p">:</span> <span class="mi">8192</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_MONTH&quot;</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_QUARTER&quot;</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_HALFYEAR&quot;</span><span class="p">:</span> <span class="mi">65536</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_YEAR&quot;</span><span class="p">:</span> <span class="mi">131072</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_HOUR&quot;</span><span class="p">:</span> <span class="mi">262144</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_DAY&quot;</span><span class="p">:</span> <span class="mi">524288</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_HOUR&quot;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_CANDIDATE_DAY&quot;</span><span class="p">:</span> <span class="mi">2097152</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_HOUR&quot;</span><span class="p">:</span> <span class="mi">4194304</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_GRACE_DAY&quot;</span><span class="p">:</span> <span class="mi">8388608</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_LAST_JOB&quot;</span><span class="p">:</span> <span class="mi">16777216</span><span class="p">,</span>
            <span class="s2">&quot;EXTENDED_FIRST&quot;</span><span class="p">:</span> <span class="mi">33554432</span>
        <span class="p">}</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">retention_flag</span><span class="p">]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select retentionFlags&amp;</span><span class="si">{0}</span><span class="s2"> from JMJobDataStats where jobid = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                and dataType = 2&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flag not present&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MMHelper.setup_environment"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.setup_environment">[docs]</a>    <span class="k">def</span> <span class="nf">setup_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get testcase object and setup library, non dedupe storage policy, backupset and subclient</span>

<span class="sd">        Returns:</span>
<span class="sd">            (object)    -- disk library object</span>
<span class="sd">            (object)    -- storage policy object</span>
<span class="sd">            (object)    -- backupset object</span>
<span class="sd">            (object)    -- subclient object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disk_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_disk_library</span><span class="p">()</span>
        <span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_storage_policy</span><span class="p">()</span>
        <span class="n">backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_backupset</span><span class="p">()</span>
        <span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">disk_library</span><span class="p">,</span> <span class="n">storage_policy</span><span class="p">,</span> <span class="n">backupset</span><span class="p">,</span> <span class="n">subclient</span></div>

<div class="viewcode-block" id="MMHelper.configure_disk_library"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_disk_library">[docs]</a>    <span class="k">def</span> <span class="nf">configure_disk_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">library_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">ma_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">mount_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new disk library if not exists</span>
<span class="sd">        Args:</span>
<span class="sd">            library_name (str)  -- library name to create</span>

<span class="sd">            ma_name (str)       -- MA name to use for library</span>

<span class="sd">            mount_path (str)    -- path to create mount path for library</span>

<span class="sd">        Return:</span>
<span class="sd">            (object)    -- disk library object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># config disk library</span>
        <span class="k">if</span> <span class="n">library_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span>
        <span class="k">if</span> <span class="n">ma_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mount_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mount_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MountPath&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check library: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">library_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">has_library</span><span class="p">(</span><span class="n">library_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Library...&quot;</span><span class="p">)</span>
            <span class="n">disk_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">library_name</span><span class="p">,</span>
                                                            <span class="n">ma_name</span><span class="p">,</span>
                                                            <span class="n">mount_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library Config done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">disk_library</span>
        <span class="n">disk_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">library_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library exists!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disk_library</span></div>

<div class="viewcode-block" id="MMHelper.configure_disk_mount_path"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_disk_mount_path">[docs]</a>    <span class="k">def</span> <span class="nf">configure_disk_mount_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_library</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a mount path [local/remote] to the disk library</span>

<span class="sd">               Args:</span>
<span class="sd">                   disk_library  (object) --  instance of disk library to add the mountpath to</span>

<span class="sd">                   mount_path  (str)   -- Mount path which needs to be added to disklibrary.</span>
<span class="sd">                                         This could be a local or remote mount path on mediaagent</span>

<span class="sd">                   media_agent (str)   -- MediaAgent on which mountpath exists</span>

<span class="sd">                   \*\*kwargs  (dict)  --  Optional arguments</span>

<span class="sd">                    Available kwargs Options:</span>

<span class="sd">                       username    (str)   -- Username to access the mount path</span>

<span class="sd">                       password    (str)   -- Password to access the mount path</span>

<span class="sd">               Returns:</span>
<span class="sd">                   None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding MountPath to Disk Library: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disk_library</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
        <span class="n">disk_library</span><span class="o">.</span><span class="n">add_mount_path</span><span class="p">(</span><span class="n">mount_path</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MountPath Configuration Done.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.configure_cloud_library"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_cloud_library">[docs]</a>    <span class="k">def</span> <span class="nf">configure_cloud_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">server_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">saved_credential_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new Cloud Library to the Commcell.</span>

<span class="sd">            Args:</span>
<span class="sd">                library_name (str)        --  name of the new cloud library to add</span>

<span class="sd">                media_agent  (str/object) --  name or instance of media agent to add the library to</span>

<span class="sd">                mount_path   (str)        --  cloud container or bucket</span>

<span class="sd">                username     (str)        --  username to access mountpath in the format &lt;ServiceHost&gt;//&lt;AccountName&gt;</span>
<span class="sd">                                              Eg: s3.us-west-1.amazonaws.com//MyAccessKeyID</span>

<span class="sd">                password     (str)        --  password to access the mount path</span>

<span class="sd">                server_type   (str)       --  provide cloud library server type</span>

<span class="sd">                saved_credential_name (str) -- name of saved credentials</span>
<span class="sd">                                                if saved credentials are username used be given in the format</span>
<span class="sd">                                                &lt;ServiceHost&gt;//__CVCRED__</span>
<span class="sd">                                                Eg: s3.us-west-1.amazonaws.com//__CVCRED__</span>

<span class="sd">            Returns:</span>
<span class="sd">                object - instance of the disk library class, if created successfully</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_type_dict</span> <span class="o">=</span> <span class="n">mediaagentconstants</span><span class="o">.</span><span class="n">CLOUD_SERVER_TYPES</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">server_type_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid server type specified&#39;</span><span class="p">)</span>
        <span class="n">server_type</span> <span class="o">=</span> <span class="n">server_type_dict</span><span class="p">[</span><span class="n">server_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check library: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">library_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">has_library</span><span class="p">(</span><span class="n">library_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Library...&quot;</span><span class="p">)</span>
            <span class="n">cloud_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">library_name</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                                             <span class="n">server_type</span><span class="p">,</span> <span class="n">saved_credential_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library Config done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cloud_library</span>
        <span class="n">cloud_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">library_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library exists!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cloud_library</span></div>

<div class="viewcode-block" id="MMHelper.configure_cloud_mount_path"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_cloud_mount_path">[docs]</a>    <span class="k">def</span> <span class="nf">configure_cloud_mount_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cloud_library</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">server_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a mount path to the cloud library</span>

<span class="sd">            Args:</span>
<span class="sd">                cloud_library (object)  -- instance of cloud library</span>

<span class="sd">                mount_path  (str)   -- cloud container or bucket.</span>

<span class="sd">                media_agent (str)   -- MediaAgent on which mount path exists</span>

<span class="sd">                username    (str)   -- Username to access the mount path in the format &lt;Service Host&gt;//&lt;Account Name&gt;</span>
<span class="sd">                Eg: s3.us-west-1.amazonaws.com//MyAccessKeyID. For more information refer http://documentation.commvault.com/commvault/v11/article?p=97863.htm</span>

<span class="sd">                password    (str)   -- Password to access the mount path</span>

<span class="sd">                server_type  (str)   -- provide cloud library server type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_type_dict</span> <span class="o">=</span> <span class="n">mediaagentconstants</span><span class="o">.</span><span class="n">CLOUD_SERVER_TYPES</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">server_type_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid server type specified&#39;</span><span class="p">)</span>
        <span class="n">server_type</span> <span class="o">=</span> <span class="n">server_type_dict</span><span class="p">[</span><span class="n">server_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding MountPath to Cloud Library: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cloud_library</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
        <span class="n">cloud_library</span><span class="o">.</span><span class="n">add_cloud_mount_path</span><span class="p">(</span><span class="n">mount_path</span><span class="p">,</span> <span class="n">media_agent</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">server_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MountPath Configuration Done.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.configure_storage_policy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_storage_policy">[docs]</a>    <span class="k">def</span> <span class="nf">configure_storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">storage_policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">library_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">ma_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        creates a new storage policy if not exists</span>
<span class="sd">        Args:</span>
<span class="sd">            storage_policy_name (str)   -- storage policy name to create storage policy</span>

<span class="sd">            library_name (str)          -- library to use for creating storage policy</span>

<span class="sd">            ma_name (str)               -- MA name to use for library</span>

<span class="sd">        Return:</span>
<span class="sd">            (object)    -- storage policy object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># config storage policy</span>
        <span class="k">if</span> <span class="n">storage_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storage_policy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="n">library_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span>
        <span class="k">if</span> <span class="n">ma_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check SP: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Storage policy...&quot;</span><span class="p">)</span>
            <span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">,</span>
                                                                <span class="n">library_name</span><span class="p">,</span>
                                                                <span class="n">ma_name</span><span class="p">,</span>
                                                                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage policy config done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">storage_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage policy exists!&quot;</span><span class="p">)</span>
        <span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">storage_policy</span></div>

<div class="viewcode-block" id="MMHelper.configure_backupset"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_backupset">[docs]</a>    <span class="k">def</span> <span class="nf">configure_backupset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">backupset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">agent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new backupset if not exits</span>
<span class="sd">        Args:</span>
<span class="sd">            backupset_name (str)   -- backupset name to create</span>

<span class="sd">        Return:</span>
<span class="sd">            (object)    -- Backupset object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># config backupset</span>
        <span class="k">if</span> <span class="n">backupset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backupset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span>
        <span class="k">if</span> <span class="n">agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check BS: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">backupset_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">has_backupset</span><span class="p">(</span><span class="n">backupset_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Backupset...&quot;</span><span class="p">)</span>
            <span class="n">backupset</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">backupset_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backupset config done.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">backupset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backupset exists!&quot;</span><span class="p">)</span>
        <span class="n">backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backupset</span></div>

<div class="viewcode-block" id="MMHelper.configure_subclient"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_subclient">[docs]</a>    <span class="k">def</span> <span class="nf">configure_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">backupset_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">subclient_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">storage_policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">content_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">agent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Created a new subclient and added content</span>
<span class="sd">        Args:</span>
<span class="sd">            storage_policy_name (str)   -- storage policy name to associate with storage policy</span>

<span class="sd">            subclient_name (str)        -- subclient name to create</span>

<span class="sd">            backupset_name (str)        -- backupset name to create subclient under it</span>

<span class="sd">            content_path (str)          -- content to add to subclient</span>

<span class="sd">        Return:</span>
<span class="sd">             (object)   -- Subclient object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># config subclient</span>
        <span class="k">if</span> <span class="n">backupset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backupset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span>
        <span class="k">if</span> <span class="n">subclient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subclient_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="k">if</span> <span class="n">storage_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storage_policy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="n">content_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span>
        <span class="k">if</span> <span class="n">agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check SC: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating backupset object: &quot;</span> <span class="o">+</span> <span class="n">backupset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">has_subclient</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding Subclient...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">,</span>
                                                             <span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient exists!&quot;</span><span class="p">)</span>
        <span class="c1"># add subclient content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating subclient object: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting subclient content to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">content_path</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">content_path</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient config done.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclient</span></div>

<div class="viewcode-block" id="MMHelper.configure_secondary_copy"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.configure_secondary_copy">[docs]</a>    <span class="k">def</span> <span class="nf">configure_secondary_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">sec_copy_name</span><span class="p">,</span>
                                 <span class="n">storage_policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">library_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">ma_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">global_policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new secondary copy if doesnt exist</span>
<span class="sd">        Args:</span>
<span class="sd">            sec_copy_name: secondary copy name to create</span>

<span class="sd">            storage_policy_name (str)   -- storage policy name to create secondary copy</span>

<span class="sd">            library_name (str)          -- library to use for creating secondary copy</span>

<span class="sd">            ma_name (str)               -- MA name to use for library</span>

<span class="sd">            global_policy_name (str)    -- global storage policy to use for creating secondary copy</span>

<span class="sd">        Return:</span>
<span class="sd">            (object)    -- secondary copy object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">storage_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storage_policy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span>
        <span class="k">if</span> <span class="n">library_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">global_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span>
        <span class="k">if</span> <span class="n">ma_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">global_policy_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]</span>
        <span class="c1"># create secondary copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;check secondary copy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sec_copy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">has_copy</span><span class="p">(</span><span class="n">sec_copy_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding secondary copy...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">create_secondary_copy</span><span class="p">(</span><span class="n">sec_copy_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">ma_name</span><span class="p">,</span> <span class="n">global_policy</span><span class="o">=</span><span class="n">global_policy_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Secondary copy cofig done.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sec_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">get_copy</span><span class="p">(</span><span class="n">sec_copy_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;secondary copy exists!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">get_copy</span><span class="p">(</span><span class="n">sec_copy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_copy</span></div>

<div class="viewcode-block" id="MMHelper.create_uncompressable_data"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.create_uncompressable_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_uncompressable_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">num_of_folders</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates unique uncompressable data</span>

<span class="sd">        Args:</span>

<span class="sd">            client  --  (str)   -- Client name on which data needs to be created</span>

<span class="sd">            path    --  (str)   --  Path where data is to be created</span>

<span class="sd">            size    --  (float) --  Data in GB to be created for each folder</span>
<span class="sd">                                    (restrict to one decimal point)</span>
<span class="sd">        Returns:</span>
<span class="sd">              (boolean)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options_selector</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options_selector</span><span class="o">.</span><span class="n">create_uncompressable_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">num_of_folders</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.execute_select_query"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.execute_select_query">[docs]</a>    <span class="k">def</span> <span class="nf">execute_select_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Executes CSDB select query</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str) -- select query that needs to be run on CSDB</span>

<span class="sd">        Return:</span>
<span class="sd">            query response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">db_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_response</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">db_response</span></div>

<div class="viewcode-block" id="MMHelper.unload_drive"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.unload_drive">[docs]</a>    <span class="k">def</span> <span class="nf">unload_drive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">drive_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unloads the drive on the library given</span>
<span class="sd">        Args:</span>
<span class="sd">                library_name(str) -- Tape Library Name</span>

<span class="sd">                drive_name(str)   -- Drive Name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unloading Drive </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">drive_name</span><span class="p">,</span> <span class="n">library_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">execute_qcommand</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;qdrive unload -l </span><span class="si">{</span><span class="n">library_name</span><span class="si">}</span><span class="s1"> -dr </span><span class="si">{</span><span class="n">drive_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MMHelper.remove_autocopy_schedule"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.MMHelper.remove_autocopy_schedule">[docs]</a>    <span class="k">def</span> <span class="nf">remove_autocopy_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_policy_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes association with System Created Automatic Auxcopy schedule on the given copy</span>
<span class="sd">        Args:</span>
<span class="sd">                storage_policy_name (str)   -- storage policy name</span>

<span class="sd">                copy_name           (str)   --  copy name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">schedule_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="s1">&#39;System Created Autocopy schedule&#39;</span><span class="p">):</span>
            <span class="n">auxcopy_schedule_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">schedule_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;System Created Autocopy schedule&#39;</span><span class="p">)</span>
            <span class="n">association</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;storagePolicyName&#39;</span><span class="p">:</span> <span class="n">storage_policy_name</span><span class="p">,</span> <span class="s1">&#39;copyName&#39;</span><span class="p">:</span> <span class="n">copy_name</span><span class="p">}]</span>
            <span class="n">auxcopy_schedule_policy</span><span class="o">.</span><span class="n">update_associations</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="s1">&#39;exclude&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CloudLibrary"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.CloudLibrary">[docs]</a><span class="k">class</span> <span class="nc">CloudLibrary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Class for representing CloudLibrary&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libraryname</span><span class="p">,</span> <span class="n">libraryinfo</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Class for representing CloudLibrary</span>
<span class="sd">        Args:</span>
<span class="sd">                libraryname  (str)         --  name of the cloud library</span>
<span class="sd">                libraryinfo  (dictionary)   --  dictionary containing library information</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">            Raises:</span>
<span class="sd">                None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libraryname</span> <span class="o">=</span> <span class="n">libraryname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loginname</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loginName&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_accesskey</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servertype</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serverType&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mountPath&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CloudLibrary.cleanup_entities"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.CloudLibrary.cleanup_entities">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup_entities</span><span class="p">(</span><span class="n">commcell</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">entity_config</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method to cleanup commcell entities</span>

<span class="sd">        Args:</span>
<span class="sd">            entity_config (dict)   -- Dictionary containing the entity(s) as key,</span>
<span class="sd">                                        and value(s) as a list of the entities to delete.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dictonary with failed entities</span>

<span class="sd">        Raises Exception:</span>
<span class="sd">            - If failed to delete any entity</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start deleting entities configured&quot;</span><span class="p">)</span>
            <span class="n">failed_entities</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;storagepolicy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;library&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">if</span> <span class="s1">&#39;storagepolicy&#39;</span> <span class="ow">in</span> <span class="n">entity_config</span><span class="p">:</span>
                <span class="n">storageobj</span> <span class="o">=</span> <span class="n">commcell</span><span class="o">.</span><span class="n">policies</span><span class="o">.</span><span class="n">storage_policies</span>
                <span class="n">storagepolies</span> <span class="o">=</span> <span class="n">entity_config</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">storagepolies</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">storageobj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully deleted SP </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">failed_entities</span><span class="p">[</span><span class="s2">&quot;storagepolicy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;library&#39;</span> <span class="ow">in</span> <span class="n">entity_config</span><span class="p">:</span>
                <span class="n">storageobj</span> <span class="o">=</span> <span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span>
                <span class="n">libraries</span> <span class="o">=</span> <span class="n">entity_config</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">storageobj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully deleted library </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">failed_entities</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">failed_entities</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed in cleanup_enties function with error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="PowerManagement"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.PowerManagement">[docs]</a><span class="k">class</span> <span class="nc">PowerManagement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot; Class for power management helper functions&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
	
<div class="viewcode-block" id="PowerManagement.configure_cloud_mediaagent"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.PowerManagement.configure_cloud_mediaagent">[docs]</a>    <span class="k">def</span> <span class="nf">configure_cloud_mediaagent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudo_client_name</span><span class="p">,</span> <span class="n">ma_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Setup and configure cloud MediaAgent</span>

<span class="sd">                Args:</span>
<span class="sd">                    psudo_client_name -- (str) -- To be used as cloud controller for the MediaAgent</span>
<span class="sd">                    ma_obj -- (MediaAgent class object) -- MediaAgent class Object of the MA to configure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying power management configurations of MediaAgent [</span><span class="si">%s</span><span class="s2">] &quot;</span><span class="p">,</span> <span class="n">ma_obj</span><span class="o">.</span><span class="n">_media_agent_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ma_obj</span><span class="o">.</span><span class="n">_is_power_mgmt_supported</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Power Management supported&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ma_obj</span><span class="o">.</span><span class="n">_is_power_management_enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Power management is enabled&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ma_obj</span><span class="o">.</span><span class="n">_power_management_controller_name</span> <span class="o">==</span> <span class="n">pseudo_client_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MA is using correct cloud controller[</span><span class="si">%s</span><span class="s2">] &quot;</span><span class="p">,</span> <span class="n">pseudo_client_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MA is not using correct cloud controller. Correcting that&quot;</span><span class="p">)</span>
                    <span class="n">ma_obj</span><span class="o">.</span><span class="n">enable_power_management</span><span class="p">(</span><span class="n">pseudo_client_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Power management is not enabled. Enabling that&quot;</span><span class="p">)</span>
                <span class="n">ma_obj</span><span class="o">.</span><span class="n">enable_power_management</span><span class="p">(</span><span class="n">pseudo_client_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Power management is not supported on MediaAgent &#39;</span> <span class="o">+</span> <span class="n">ma_obj</span><span class="o">.</span><span class="n">_media_agent_name</span><span class="p">)</span></div>
			

<div class="viewcode-block" id="PowerManagement.power_off_media_agents"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.PowerManagement.power_off_media_agents">[docs]</a>    <span class="k">def</span> <span class="nf">power_off_media_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_media_agent_objects</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Power-off multiple MediaAgents simultaneously</span>

<span class="sd">                    Args:</span>
<span class="sd">                        list_of_media_agent_objects (list)  --  List of MediaAgent objects</span>

<span class="sd">                    Raises:</span>
<span class="sd">                           If number of MediaAgent object passed is less than 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">list_of_media_agent_objects</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;A List of MediaAgent objects expected. At least 2 MediaAgent objects require. Use ma_obj.power_off() instead&quot;</span><span class="p">)</span>

        <span class="n">thread_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">media_agent</span> <span class="ow">in</span> <span class="n">list_of_media_agent_objects</span><span class="p">:</span>
            <span class="n">power_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">media_agent</span><span class="o">.</span><span class="n">power_off</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting power-off thread. MediaAgent : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">media_agent</span><span class="o">.</span><span class="n">_media_agent_name</span><span class="p">))</span>
            <span class="n">power_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">thread_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">power_thread</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for all MediaAgents to power-off&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">power_thread</span> <span class="ow">in</span> <span class="n">thread_pool</span><span class="p">:</span>
            <span class="n">power_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All MediaAgents are powered-off successfully&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="PowerManagement.power_on_media_agents"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.PowerManagement.power_on_media_agents">[docs]</a>    <span class="k">def</span> <span class="nf">power_on_media_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_media_agent_objects</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Power-on multiple MediaAgents simultaneously</span>

<span class="sd">                    Args:</span>
<span class="sd">                        list_of_media_agent_objects (list)  --  List of MediaAgent objects</span>

<span class="sd">                    Raises:</span>
<span class="sd">                           If number of MediaAgent object passed is less than 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">list_of_media_agent_objects</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;A List of MediaAgent objects expected. At least 2 MediaAgent objects require. Use ma_obj.power_on() instead&quot;</span><span class="p">)</span>

        <span class="n">thread_pool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">media_agent</span> <span class="ow">in</span> <span class="n">list_of_media_agent_objects</span><span class="p">:</span>
            <span class="n">power_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">media_agent</span><span class="o">.</span><span class="n">power_on</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting power-on thread. MediaAgent : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">media_agent</span><span class="o">.</span><span class="n">_media_agent_name</span><span class="p">))</span>
            <span class="n">power_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">thread_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">power_thread</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for all MediaAgents to power-on&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">power_thread</span> <span class="ow">in</span> <span class="n">thread_pool</span><span class="p">:</span>
            <span class="n">power_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All MediaAgents are powered-on successfully&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PowerManagement.validate_powermgmtjobtovmmap_table"><a class="viewcode-back" href="../../../source/MediaAgents.MAUtils.html#MediaAgents.MAUtils.mahelper.PowerManagement.validate_powermgmtjobtovmmap_table">[docs]</a>    <span class="k">def</span> <span class="nf">validate_powermgmtjobtovmmap_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jobid</span><span class="p">,</span><span class="n">media_agent_id</span><span class="p">,</span><span class="n">csdb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the entry on MMPowerMgmtJobToVMMap table for the job and MediaAgent</span>

<span class="sd">            Args:</span>
<span class="sd">                        jobid --  Job ID that powered-on / powered-off the MediaAgent</span>
<span class="sd">                        media_agent_id -- MediaAgent ID that is powered-on / powered-off</span>
<span class="sd">                        csdb -- CSDB object to execute the query</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating entry on table MMPowerMgmtJobToVMMap for job </span><span class="si">{0}</span><span class="s2"> and host id </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span><span class="n">media_agent_id</span><span class="p">))</span>
        <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;select count(*)  </span>
<span class="s2">                from MMPowerMgmtJobToVMMap </span>
<span class="s2">                where hostid=</span><span class="si">{0}</span><span class="s2"> </span>
<span class="s2">                and entityid=</span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">media_agent_id</span><span class="p">,</span><span class="n">jobid</span><span class="p">)</span>

        <span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">count</span><span class="o">=</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> entries found on table MMPowerMgmtJobToVMMap for job </span><span class="si">{1}</span><span class="s2"> and host id </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">jobid</span><span class="p">,</span><span class="n">media_agent_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Validation Failed. No entry found on table MMPowerMgmtJobToVMMap for job </span><span class="si">{0}</span><span class="s2"> and host id </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span><span class="n">media_agent_id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully validated table MMPowerMgmtJobToVMMap for job </span><span class="si">{0}</span><span class="s2"> and host id </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span><span class="n">media_agent_id</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>