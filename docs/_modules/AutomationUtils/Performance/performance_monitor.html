

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AutomationUtils.Performance.performance_monitor &mdash; Commvault Automation 11.23 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>AutomationUtils.Performance.performance_monitor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for AutomationUtils.Performance.performance_monitor</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;&quot;This file contains functions for monitoring performance stats of process/client for the given job</span>

<span class="sd">    PerformanceMonitor:</span>

<span class="sd">        __init__()                          --  Initialize the PerformanceMonitor class object</span>

<span class="sd">        start_monitor()                     --  starts the performance monitor for the given job id and configurations</span>

<span class="sd">        push_configurations()               --  pushes the required configuration files to clients</span>

<span class="sd">        cleanup_configurations()            --  clean ups the configuration files on clients</span>

<span class="sd">        get_config_file_path()              --  forms the config file path for the given counters</span>

<span class="sd">        monitor_thread()                    --  Thread which is used to monitor the commvault process on client</span>
<span class="sd">                                                                                        for performance</span>

<span class="sd">        get_thread_name()                   --  forms the thread name based on config data</span>

<span class="sd">        kill_thread_and_get_stats()         --  kills the monitor process on client machine and get output stats file</span>

<span class="sd">        push_stats_thread()                 --  pushes the performance stats csv file data to the open data source</span>

<span class="sd">        check_and_kill_threads()            --  Kills all the child threads invoked for monitoring process</span>

<span class="sd">        create_performance_data_source()    --  creates the pre-defined data sources for pushing performance stats</span>

<span class="sd">        get_data_from_csv()                 --  converts csv performance file output to list of key value pairs(dict)</span>

<span class="sd">        push_hwinfo_to_data_source()        --  pushes the machine hardware details to the open data source</span>

<span class="sd">        fetch_job_details()                 --  fetches the job details for the given job object</span>

<span class="sd">        push_jobinfo_to_data_source         --  pushes job details to the open data source</span>

<span class="sd">        check_and_log_exception()           --  cross check exception and logs accordingly</span>

<span class="sd">        check_alive_threads()               --  checks the live threads running for monitoring the performance and</span>
<span class="sd">                                                                removes non-alive threads</span>

<span class="sd">        run_cmd_timer()                     --  executes the command provided on remote client with specified time</span>

<span class="sd">        push_netstat_to_data_source()       --  pushes netstat output of process/machine to the open data source</span>

<span class="sd">        get_valid_datetime()                --  returns the valid datetime format to push into data source</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">cvpysdk.datacube.sedstype</span> <span class="kn">import</span> <span class="n">SEDS_TYPE_DICT</span>

<span class="kn">from</span> <span class="nn">dynamicindex.index_server_helper</span> <span class="kn">import</span> <span class="n">IndexServerHelper</span>
<span class="kn">from</span> <span class="nn">dynamicindex.Datacube.data_source_helper</span> <span class="kn">import</span> <span class="n">DataSourceHelper</span>
<span class="kn">from</span> <span class="nn">dynamicindex.utils</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">dynamic_constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.config</span> <span class="kn">import</span> <span class="n">get_config</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">GeneralConstants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">CounterTypes</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">Platforms</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">TimerIntervals</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">JobStatus</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">JobTypes</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.constants</span> <span class="kn">import</span> <span class="n">Binary</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.performance_helper</span> <span class="kn">import</span> <span class="n">PerformanceHelper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.Performance.Utils.performance_helper</span> <span class="kn">import</span> <span class="n">AutomationCache</span>


<span class="n">_CONFIG_DATA</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">DynamicIndex</span><span class="o">.</span><span class="n">PerformanceStats</span>


<div class="viewcode-block" id="PerformanceMonitor"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor">[docs]</a><span class="k">class</span> <span class="nc">PerformanceMonitor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; contains functions for monitoring cv process performance stats for the given job configurations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell_object</span><span class="p">,</span> <span class="n">build_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the PerformanceMonitor class</span>

<span class="sd">            Args:</span>

<span class="sd">                commcell_object         (obj)       --      commcell object</span>

<span class="sd">                build_id                (str)       --      build id for this run</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span> <span class="o">=</span> <span class="n">build_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># for storing thread object of each monitor threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for storing timer tasks last execution time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_task</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span> <span class="o">=</span> <span class="n">PerformanceHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span> <span class="o">=</span> <span class="n">AutomationCache</span><span class="p">()</span>
        <span class="c1"># folder paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_FOLDER_PATH</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="p">,</span>
            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_REPORTS_FOLDER_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">,</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_MACHINE_CONFIG_JSON_FILE_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">,</span>
                                                 <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_PERFORMANCE_CONFIG_JSON_FILE_NAME</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_details_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports_path</span><span class="p">,</span>
                                                  <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_PERFORMANCE_JOB_DETAILS_JSON_FILE_NAME</span><span class="p">)</span>

<div class="viewcode-block" id="PerformanceMonitor.get_valid_datetime"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.get_valid_datetime">[docs]</a>    <span class="k">def</span> <span class="nf">get_valid_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns the valid datetime format to push into data source</span>

<span class="sd">            Args:</span>

<span class="sd">                input           (str)           --  Date time string</span>
<span class="sd">                                            Example: 10/14/2020 18:05:12.019</span>
<span class="sd">                                            Pattern: dd/mm/yy hh:mm:ss.SSS</span>

<span class="sd">            Returns:</span>

<span class="sd">                str - DateTime format of pattern &#39;YYYY-MM-dd HH:MM:SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.push_netstat_to_data_source"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.push_netstat_to_data_source">[docs]</a>    <span class="k">def</span> <span class="nf">push_netstat_to_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_obj</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">process_id</span><span class="p">,</span> <span class="n">push_to_data_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>

<span class="sd">            machine_obj          (obj)       --      Machine class object</span>

<span class="sd">            client_name          (str)       --      client name</span>

<span class="sd">            process_id           (list)      --      Process id</span>

<span class="sd">            binary               (str)       --      Process binary name</span>

<span class="sd">            push_to_data_source  (bool)      --      bool to specify whether to push this stats to data source or not</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">default_param</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="p">,</span>
                <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_MACHINE_NAME</span><span class="p">:</span> <span class="n">client_name</span>
            <span class="p">}</span>
            <span class="n">ds_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Process level netstat</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">process_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">default_param</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">push_to_data_source</span><span class="p">:</span>
                    <span class="n">ds_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">process_id</span><span class="p">:</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BINARY</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PROCESS_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>
                    <span class="n">netstat</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_port_usage</span><span class="p">(</span><span class="n">process_id</span><span class="o">=</span><span class="n">process</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Port usage for binary : </span><span class="si">{</span><span class="n">binary</span><span class="si">}</span><span class="s2"> , Process id : </span><span class="si">{</span><span class="n">process</span><span class="si">}</span><span class="s2"> &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;in client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">netstat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Modify field value to _i at end so that it get pushed as integer to solr</span>
                    <span class="n">netstat</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">SOLR_INTEGER_FIELD_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span>
                        <span class="n">val</span> <span class="ow">in</span> <span class="n">netstat</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">netstat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">process_dict</span><span class="p">)</span>
                    <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">netstat</span><span class="p">)</span>
            <span class="c1"># machine level netstat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">push_to_data_source</span><span class="p">:</span>
                    <span class="n">ds_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">)</span>
                <span class="n">netstat</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_port_usage</span><span class="p">()</span>
                <span class="c1"># Modify field value to _i at end so that it get pushed as integer to solr</span>
                <span class="n">netstat</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">SOLR_INTEGER_FIELD_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">netstat</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Port usage for Machine : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">netstat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">netstat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_param</span><span class="p">)</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">netstat</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">push_to_data_source</span> <span class="ow">and</span> <span class="n">ds_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_obj</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">stats</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Netstats pushed to data source successfully for client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;&amp; binary : </span><span class="si">{</span><span class="n">binary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.run_cmd_timer"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.run_cmd_timer">[docs]</a>    <span class="k">def</span> <span class="nf">run_cmd_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_obj</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; runs command on machine and comes out without waiting for output</span>

<span class="sd">        Args:</span>

<span class="sd">            machine_obj                 (obj)       --      Machine class object</span>

<span class="sd">            cmd                         (str)       --      command which needs to be executed</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">machine_obj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.check_alive_threads"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.check_alive_threads">[docs]</a>    <span class="k">def</span> <span class="nf">check_alive_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prints the alive threads in logs and removes dead one from list</span>
<span class="sd">        Args:</span>

<span class="sd">            threads         (list)      --  list of thread objects</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Thread [</span><span class="si">{</span><span class="n">_thread</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="si">}</span><span class="s2">] is not alive&quot;</span><span class="p">)</span>
                    <span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_thread</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed Thread from stack : </span><span class="si">{</span><span class="n">_thread</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected Threads running count : </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot; Current Running Thread count - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot; Running thread names : </span><span class="si">{</span><span class="n">threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.check_and_log_exception"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.check_and_log_exception">[docs]</a>    <span class="k">def</span> <span class="nf">check_and_log_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;cross check exception and logs accordingly</span>

<span class="sd">        Args:</span>

<span class="sd">                exp         (obj)       --      exception object</span>

<span class="sd">                ignore_list (list)      --      list of additional errors which can be ignored specifically</span>

<span class="sd">        Returns:</span>

<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># ignore if it is remote connection related errors</span>
        <span class="k">for</span> <span class="n">ignore_err</span> <span class="ow">in</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">IGNORE_REMOTE_ERRORS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_err</span> <span class="ow">in</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">IGNORE_EXCEPTION</span><span class="p">)</span>
                <span class="n">log_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># check for any specific error conditions which need to be ignored</span>
        <span class="k">if</span> <span class="n">ignore_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">specific_error</span> <span class="ow">in</span> <span class="n">ignore_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">specific_error</span> <span class="ow">in</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">IGNORE_SPECIFIC_EXCEPTIONS</span><span class="si">}{</span><span class="n">specific_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">log_error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">log_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.push_jobinfo_to_data_source"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.push_jobinfo_to_data_source">[docs]</a>    <span class="k">def</span> <span class="nf">push_jobinfo_to_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pushes job details to the open data source</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exceptions:</span>

<span class="sd">                if failed to fetch job/Data Source details</span>

<span class="sd">                if failed to push to open data source</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_details_file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job details Json file not found @ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_details_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">read_json_file</span><span class="p">(</span><span class="n">json_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_details_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded job details JSON file in memory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job Details JSON : </span><span class="si">{</span><span class="n">job_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># handle json to string here for pushing into solr</span>
        <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_EVENTS</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stringify the job events before pushing to open data source&quot;</span><span class="p">)</span>
            <span class="n">job_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_EVENTS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_EVENTS</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_CONFIG</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stringify the job config before pushing to open data source&quot;</span><span class="p">)</span>
            <span class="n">job_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_CONFIG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_CONFIG</span><span class="p">])</span>
        <span class="n">job_ds_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="p">)</span>
        <span class="n">final_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_details</span><span class="p">]</span>
        <span class="n">job_ds_obj</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">final_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job details successfully pushed into open Data Source&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.fetch_job_details"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.fetch_job_details">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_job_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_obj</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; fetches the job details for the given job object and job type</span>

<span class="sd">        Args:</span>

<span class="sd">            job_obj             (obj)       --  object of Job class</span>

<span class="sd">            job_type            (int)       --      type of job</span>
<span class="sd">                                            Example : defined in JobTypes in constants.py</span>

<span class="sd">                    **kwargs    --  optional params</span>

<span class="sd">                    DataSourceName  --  Name of the data source used in crawl job</span>

<span class="sd">                    ClientId        --  client id of data which got analysed in crawl job</span>

<span class="sd">                    SourceName_s    --  Name of the source data</span>

<span class="sd">                    SourceSize_s    --  Size of the source data</span>


<span class="sd">        Returns:</span>

<span class="sd">            dict        --  containing details about job</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                    if input is not valid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_obj</span><span class="p">,</span> <span class="n">Job</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Input data type is not valid&quot;</span><span class="p">)</span>
        <span class="n">task_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">on_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">task_done</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to fetch job details for the job id : </span><span class="si">{</span><span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">job_obj</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">job_obj</span><span class="o">.</span><span class="n">end_timestamp</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_ID</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span><span class="p">),</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_STATUS</span><span class="p">:</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_START</span><span class="p">:</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">start_timestamp</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_END</span><span class="p">:</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">end_timestamp</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_TYPE</span><span class="p">:</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_EVENTS</span><span class="p">:</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">get_events</span><span class="p">(),</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_DURATION</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)),</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="p">,</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_JOB_CONFIG</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">read_json_file</span><span class="p">(</span>
                        <span class="n">json_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_config_file_path</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="n">task_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_DETAILS_FETCH_THRESHOLD</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_JOB_DETAILS_FETCH_FAILED</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># check whether input job type has associated data source or not. if so, collect data source details</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">DATA_SOURCE_SUPPORTED_JOB_TYPES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data Source associated job. Proceed to get the data source stats&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_PARAM</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataSource name not found in Param&quot;</span><span class="p">)</span>
                <span class="n">client_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_CLIENT_ID</span><span class="p">):</span>
                    <span class="n">client_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_CLIENT_ID</span><span class="p">)</span>
                <span class="n">ds_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">fetch_data_source_crawl_stats</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_PARAM</span><span class="p">),</span>
                    <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">)</span>
                <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_AUTOMATION_JOB_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_type</span>
                <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_DS_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_PARAM</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_NAME</span><span class="p">):</span>
                    <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_NAME</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default Source&quot;</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_SIZE</span><span class="p">):</span>
                    <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_SIZE</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DYNAMIC_COLUMN_SOURCE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ds_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_PARAM</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataSource Type : </span><span class="si">{</span><span class="n">ds_obj</span><span class="o">.</span><span class="n">data_source_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds_obj</span><span class="o">.</span><span class="n">data_source_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">SEDS_TYPE_DICT</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">FILE_SYSTEM_DSTYPE</span><span class="p">)]</span> <span class="ow">and</span> \
                        <span class="n">job_type</span> <span class="ow">in</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">CONTENT_CRAWLS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File system data source with content analysed found for stats analysis&quot;</span><span class="p">)</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">find_fs_extract_duration_stats</span><span class="p">(</span>
                        <span class="n">data_source_name</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">DATA_SOURCE_NAME_PARAM</span><span class="p">))</span>
                    <span class="n">ds_details</span><span class="p">[</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">FIELD_EXTRACT_DURATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
                <span class="c1"># append all data source details to above job details dict</span>
                <span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ds_details</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="PerformanceMonitor.push_hwinfo_to_data_source"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.push_hwinfo_to_data_source">[docs]</a>    <span class="k">def</span> <span class="nf">push_hwinfo_to_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_json_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pushes the machine hardware details to the open data source from input JSON file</span>

<span class="sd">        Args:</span>

<span class="sd">            config_json_file            (str)       --  JSON file containing machine hardware details</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exceptions:</span>

<span class="sd">                    if config json file doesn&#39;t exists</span>

<span class="sd">                    if failed to push data to open data source</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to push machine configuration/Hardware details to the open data source&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_json_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine config file doesn&#39;t exists - </span><span class="si">{</span><span class="n">config_json_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_json</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_json</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully fetched machine config details from Json file&quot;</span><span class="p">)</span>
        <span class="n">push_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="c1"># Remove GB letter from RAM size</span>
            <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span>
            <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span>
            <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_RAM_SIZE</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">]:</span>
                <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_RAM_SIZE</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_RAM_SIZE</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;GB&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_STORAGE</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">]:</span>
                <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_STORAGE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">][</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_STORAGE</span><span class="p">])</span>
            <span class="n">push_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client-</span><span class="si">{</span><span class="n">client</span><span class="si">}</span><span class="s2"> Hardware config - </span><span class="si">{</span><span class="n">json_data</span><span class="p">[</span><span class="n">client</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># push it to machine config open data source</span>
        <span class="n">ds_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="p">)</span>
        <span class="n">ds_obj</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">push_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.get_data_from_csv"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.get_data_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;converts the csv performance file output to list of key value pairs(dict)</span>

<span class="sd">        Args:</span>

<span class="sd">            push_json       (dict)  --  containing information about performance config of process</span>

<span class="sd">                                            Example : {</span>
<span class="sd">                                                        &quot;binary&quot;:&quot;ifind.exe&quot;,</span>
<span class="sd">                                                        &quot;countertype&quot; :&quot;Process&quot;,</span>
<span class="sd">                                                        &quot;binaryprocessids&quot;:[&#39;123&#39;],</span>
<span class="sd">                                                        &quot;statsfile&quot;:&quot;c:\test.csv&quot;,</span>
<span class="sd">                                                        &quot;counters&quot; [r&#39;\Process(cvd*)\Handle Count&#39;],</span>
<span class="sd">                                                        &quot;client&quot;:&quot;xyz&quot;,</span>
<span class="sd">                                                        &quot;platform&quot; : &quot;Windows&quot;</span>
<span class="sd">                                                        }</span>

<span class="sd">        Returns:</span>

<span class="sd">            list        --  list of dict containing key-value pairs which needs to be pushed to data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">csv</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>
        <span class="n">counter_type</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTER_TYPE_PARAM</span><span class="p">]</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PLATFORM_PARAM</span><span class="p">]</span>
        <span class="n">stats_csv_file</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FILE_PARAM</span><span class="p">]</span>
        <span class="n">counters</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_PARAM</span><span class="p">]</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stats_csv_file</span><span class="p">,</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">FILE_READ_MODE</span><span class="p">)</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>
        <span class="n">header_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="c1"># counter to solr field mappings</span>
        <span class="n">map_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">TYPEPERF_TIME_STAMP_HEADER</span><span class="p">):</span>
                <span class="n">map_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">TYPEPERF_TIME_STAMP_HEADER</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">column</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BASH_TIME_STAMP_HEADER</span><span class="p">):</span>
                <span class="n">map_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BASH_TIME_STAMP_HEADER</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header_name</span> <span class="o">=</span> <span class="n">column</span>
                <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="p">:</span>
                    <span class="n">header_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># windows counters</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">counter_type</span> <span class="o">==</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span><span class="p">:</span>
                        <span class="n">header_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># linux counters</span>
                <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="p">[</span><span class="n">header_name</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_fields</span><span class="p">:</span>
                    <span class="n">map_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="p">[</span><span class="n">header_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped Solr fields for file : </span><span class="si">{</span><span class="n">stats_csv_file</span><span class="si">}</span><span class="s2"> is : </span><span class="si">{</span><span class="n">map_fields</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">counter_type</span> <span class="o">==</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got Process level stats for pushing into data source&quot;</span><span class="p">)</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">]</span>
            <span class="c1"># find type of output CSV file. single/multi process output csv</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counters</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">header_length</span><span class="p">:</span>  <span class="c1"># CSV file will have time column as extra at front</span>
                <span class="c1"># for single process file, read all column and rows directly.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Single Process performance stats file </span><span class="si">{</span><span class="n">stats_csv_file</span><span class="si">}</span><span class="s2"> with total &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;columns : </span><span class="si">{</span><span class="n">header_length</span><span class="si">}</span><span class="s2">. Read and push directly&quot;</span><span class="p">)</span>
                <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                    <span class="n">row_data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">zero_skip</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BINARY</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_name</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PLATFORM</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_MACHINE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_name</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">map_fields</span><span class="p">:</span>
                        <span class="c1"># add time field always</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_TIME</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_datetime</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># sometimes counter value can come as zero. so add logic to skip those</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                            <span class="n">zero_skip</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ZERO_VALUE_ROWS_SKIP</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_skip</span><span class="p">:</span>
                        <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">skipped_rows</span> <span class="o">=</span> <span class="n">skipped_rows</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total skipped rows of Zero condition - </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># minus the time header column from header length</span>
                <span class="n">process_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">header_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">counters</span><span class="p">))</span>
                <span class="c1"># for multiple process stats output file from windows, drop the ones which is not needed based on pid</span>
                <span class="c1"># Time,Handle count,Handle Count,Threads count,Threads count,pid,pid</span>
                <span class="c1"># t1,453,345,12,45,43456,23765</span>
                <span class="c1"># t2,453,545,12,55,43456,23765</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Multiple Process performance stats file </span><span class="si">{</span><span class="n">stats_csv_file</span><span class="si">}</span><span class="s2"> with total &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;columns : </span><span class="si">{</span><span class="n">header_length</span><span class="si">}</span><span class="s2">. Read and push accordingly assuming total process as : </span><span class="si">{</span><span class="n">process_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">is_skipped</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">unknown_pids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">process_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">process_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">row_data</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">zero_skip</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BINARY</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary_name</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PLATFORM</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_MACHINE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_name</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">map_fields</span><span class="p">:</span>
                            <span class="c1"># add time field always</span>
                            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_TIME</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_datetime</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># sometimes counter value can come as zero. so add logic to skip those</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                                <span class="n">zero_skip</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ZERO_VALUE_ROWS_SKIP</span>
                            <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">process_index</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">process_count</span>
                        <span class="c1"># check whether this process id is the one which we monitored. if not, drop this</span>
                        <span class="k">if</span> <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PROCESS_ID</span><span class="p">]</span> <span class="ow">in</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PID_PARAM</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_skip</span><span class="p">:</span>
                                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">skipped_rows</span> <span class="o">=</span> <span class="n">skipped_rows</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Multiple instance of same binary running on client. Drop the ones which are not</span>
                            <span class="c1"># related to this configurations and print it for logging purpose</span>
                            <span class="n">is_skipped</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">unknown_pids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PROCESS_ID</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">is_skipped</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;DataSource Push -&gt; Dropping this Unwanted PID </span><span class="si">{</span><span class="n">unknown_pids</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;from binary : </span><span class="si">{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; for the client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">. Data will not be pushed to open data source&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total skipped rows of Zero condition - </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got Machine level stats for pushing into data source&quot;</span><span class="p">)</span>
            <span class="n">skipped_rows</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                <span class="n">row_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">zero_skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_BUILD_ID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span>
                <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_MACHINE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_name</span>
                <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_COMMSERV_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">version</span>
                <span class="n">row_data</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_PLATFORM</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">map_fields</span><span class="p">:</span>
                    <span class="c1"># add time field always</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_TIME</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_datetime</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># sometimes counter value can come as zero. so add logic to skip those</span>
                        <span class="n">row_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                        <span class="n">zero_skip</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ZERO_VALUE_ROWS_SKIP</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_skip</span><span class="p">:</span>
                    <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skipped_rows</span> <span class="o">=</span> <span class="n">skipped_rows</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total skipped rows of Zero condition - </span><span class="si">{</span><span class="n">skipped_rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_list</span></div>

<div class="viewcode-block" id="PerformanceMonitor.create_performance_data_source"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.create_performance_data_source">[docs]</a>    <span class="k">def</span> <span class="nf">create_performance_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; creates the pre-defined data sources for pushing performance stats</span>
<span class="sd">        Args:</span>

<span class="sd">            None</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check whether index server has DS role enabled. if not, enable and then proceed creating open data source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index Server to be used for pushing performance stats : </span><span class="si">{</span><span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="p">)</span> <span class="ow">or</span>\
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="p">):</span>
            <span class="n">index_server_helper</span> <span class="o">=</span> <span class="n">IndexServerHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="p">)</span>
            <span class="n">ds_helper</span> <span class="o">=</span> <span class="n">DataSourceHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Index server/Data Source helper initialised&quot;</span><span class="p">)</span>
            <span class="n">index_server_helper</span><span class="o">.</span><span class="n">update_roles</span><span class="p">(</span><span class="n">index_server_roles</span><span class="o">=</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ROLE_DATA_ANALYTICS</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Going to create Process level - Open DataSource : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">create_open_data_source</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">,</span>
                    <span class="n">index_server_name</span><span class="o">=</span><span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">update_data_source_schema</span><span class="p">(</span><span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">,</span>
                                                    <span class="n">field_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PROCESS_DATA_SOURCE_COLUMN</span><span class="p">,</span>
                                                    <span class="n">field_type</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PROCESS_DATA_SOURCE_COLUMN_TYPES</span><span class="p">,</span>
                                                    <span class="n">schema_field</span><span class="o">=</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">SCHEMA_FIELDS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process level - Open DataSource created successfully&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Going to create Machine level - Open DataSource : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">create_open_data_source</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">,</span>
                    <span class="n">index_server_name</span><span class="o">=</span><span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">update_data_source_schema</span><span class="p">(</span><span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">,</span>
                                                    <span class="n">field_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_DATA_SOURCE_COLUMN</span><span class="p">,</span>
                                                    <span class="n">field_type</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_DATA_SOURCE_COLUMN_TYPES</span><span class="p">,</span>
                                                    <span class="n">schema_field</span><span class="o">=</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">SCHEMA_FIELDS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine level - Open DataSource created successfully&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Going to create Machine Config level - Open DataSource : &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">create_open_data_source</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="p">,</span>
                    <span class="n">index_server_name</span><span class="o">=</span><span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">update_data_source_schema</span><span class="p">(</span><span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Config_Data_Source_Name</span><span class="p">,</span>
                                                    <span class="n">field_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_CONFIG_DATA_SOURCE_COLUMN</span><span class="p">,</span>
                                                    <span class="n">field_type</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_CONFIG_DATA_SOURCE_COLUMN_TYPES</span><span class="p">,</span>
                                                    <span class="n">schema_field</span><span class="o">=</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">SCHEMA_FIELDS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine Config level - Open DataSource created successfully&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">has_datasource</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Going to create Job Details - Open DataSource : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">create_open_data_source</span><span class="p">(</span>
                    <span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="p">,</span>
                    <span class="n">index_server_name</span><span class="o">=</span><span class="n">_CONFIG_DATA</span><span class="o">.</span><span class="n">Index_Server</span><span class="p">)</span>
                <span class="n">ds_helper</span><span class="o">.</span><span class="n">update_data_source_schema</span><span class="p">(</span><span class="n">data_source_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Job_Details_Data_Source_Name</span><span class="p">,</span>
                                                    <span class="n">field_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_DETAILS_DATA_SOURCE_COLUMN</span><span class="p">,</span>
                                                    <span class="n">field_type</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_DETAILS_DATA_SOURCE_COLUMN_TYPES</span><span class="p">,</span>
                                                    <span class="n">schema_field</span><span class="o">=</span><span class="n">dynamic_constants</span><span class="o">.</span><span class="n">SCHEMA_FIELDS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job Details - Open DataSource created successfully&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Open DataSource setup completed successfully&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.check_and_kill_threads"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.check_and_kill_threads">[docs]</a>    <span class="k">def</span> <span class="nf">check_and_kill_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether thread object exists in given list and then Kills the threads</span>

<span class="sd">            Args:</span>

<span class="sd">                threads     (list)      --  list of thread objects to be killed</span>

<span class="sd">            Returns:</span>

<span class="sd">                None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Killing all child threads running - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_alive_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
            <span class="c1"># set stop flag to true so that all child threads will be notified</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting Stop flag to : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="c1"># join and wait for graceful exit of child thread</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing Join for thread : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_thread</span><span class="p">)</span>
                <span class="n">_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_thread</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="si">}</span><span class="s2"> stopped gracefully&quot;</span><span class="p">)</span>
                <span class="c1"># thread came down gracefully. remove thread object from the list</span>
                <span class="n">threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_thread</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed Thread from stack : </span><span class="si">{</span><span class="n">_thread</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_alive_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for all threads to go down!!!&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="c1"># reset stop flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reset stop flag to : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All child threads went down&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No child threads are running&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.get_config_file_path"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.get_config_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_config_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">folder_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;forms the config file path for the given counters</span>

<span class="sd">        Args:</span>

<span class="sd">            config     (dict)      --  dict containing performance monitor config data for a process/Machine</span>

<span class="sd">                    Example : {</span>
<span class="sd">                    &#39;client&#39;: &#39;xyz&#39;,</span>
<span class="sd">                    &#39;binary&#39;: {&#39;Windows&#39;: &#39;IFind.exe&#39;},</span>
<span class="sd">                    &#39;counters&#39;: [&#39;$5&#39;, &#39;$7&#39;],</span>
<span class="sd">                    &#39;platform&#39;: &#39;UNIX&#39;,</span>
<span class="sd">                    &#39;statsfolder&#39;: &#39;/Users/root/commvault_automation/Automation_Performance_Data&#39;}</span>
<span class="sd">                                }</span>

<span class="sd">            separator   (str)   --  OS specific Separator</span>

<span class="sd">            folder_only (bool)  --  returns only the folder level path for the given config</span>

<span class="sd">        Returns:</span>

<span class="sd">            str     --  Config file path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">binary_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span> <span class="ow">in</span> <span class="n">binary_name</span><span class="p">:</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Unix</span> <span class="ow">in</span> <span class="n">binary_name</span><span class="p">:</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">Platforms</span><span class="o">.</span><span class="n">Unix</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FOLDER_PARAM</span><span class="p">]</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">folder_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">separator</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># return windows config file</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">binary_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_TEXT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># returns unix bash file</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}{</span><span class="n">separator</span><span class="si">}{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">binary_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_BASH_FILE</span><span class="si">}</span><span class="s2">&quot;</span></div>

<div class="viewcode-block" id="PerformanceMonitor.cleanup_configurations"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.cleanup_configurations">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_configurations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; cleanups the configurations files on client machines based on given config</span>

<span class="sd">        Args:</span>

<span class="sd">            config_data     (dict)      --  performance Monitor config data</span>

<span class="sd">            Example : {</span>
<span class="sd">                        &#39;Live Scan&#39;: {</span>
<span class="sd">                                        &#39;1&#39;: {</span>
<span class="sd">                                                &#39;client&#39;: &#39;xyz&#39;,</span>
<span class="sd">                                                &#39;binary&#39;: {&#39;Windows&#39;: &#39;IFind.exe&#39;},</span>
<span class="sd">                                                &#39;counters&#39;: [&#39;\\Process(%s*)\\Handle Count&#39;],</span>
<span class="sd">                                                &#39;platform&#39;: &#39;UNIX&#39;,</span>
<span class="sd">                                                &#39;statsfolder&#39;: &#39;/Users/root/Automation_Performance_Data&#39;</span>
<span class="sd">                                            }</span>
<span class="sd">                                    },</span>
<span class="sd">                        &#39;Content Push&#39;: {</span>
<span class="sd">                                        &#39;1&#39;: {</span>
<span class="sd">                                                &#39;client&#39;: &#39;xyz&#39;,</span>
<span class="sd">                                                &#39;binary&#39;: {&#39;Windows&#39;: &#39;CLBackup.exe&#39;},</span>
<span class="sd">                                                &#39;counters&#39;: [&#39;1&#39;, &#39;5&#39;],</span>
<span class="sd">                                                &#39;platform&#39;: &#39;UNIX&#39;,</span>
<span class="sd">                                                &#39;statsfolder&#39;: &#39;/Users/Automation_Performance_Data&#39;}</span>
<span class="sd">                                        }</span>
<span class="sd">                    }</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Raises:</span>

<span class="sd">                Exception:</span>

<span class="sd">                        if failed to delete configurations</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clean_up_clients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">phase_dict</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to cleanup configurations for phase : </span><span class="si">{</span><span class="n">phase_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase Configuration got : </span><span class="si">{</span><span class="n">config_data</span><span class="p">[</span><span class="n">phase_dict</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># check for duplicate configurations</span>
                <span class="n">current_phase_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">remove_dup_configs</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config_data</span><span class="p">[</span><span class="n">phase_dict</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">config_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_phase_config</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="mi">1</span><span class="p">):</span>  <span class="c1"># length of dict + 1 as we starting with index 1</span>
                    <span class="n">config_to_process</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_no</span><span class="p">)</span>
                    <span class="n">config</span> <span class="o">=</span> <span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">config_data</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty Dict @ config no - </span><span class="si">{</span><span class="n">config_no</span><span class="si">}</span><span class="s2">. Proceed further&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">client_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">client_name</span> <span class="ow">in</span> <span class="n">clean_up_clients</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already cleaned up for this client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">. Nothing to do&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">has_client</span><span class="p">(</span><span class="n">client_name</span><span class="p">):</span>
                        <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">client_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_OBJ_CACHE</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">is_exists</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">):</span>
                        <span class="n">machine_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_name</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a Non-commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_name</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
                                                  <span class="n">username</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">USERNAME_PARAM</span><span class="p">],</span>
                                                  <span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PASSWORD_PARAM</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialised Machine object for client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">put_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">machine_obj</span><span class="p">)</span>
                    <span class="n">folder_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FOLDER_PARAM</span><span class="p">]</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}</span><span class="s2">&quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to delete folder path : </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2"> on client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">machine_obj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">directory_name</span><span class="o">=</span><span class="n">folder_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted the folder!!!&quot;</span><span class="p">)</span>
                    <span class="n">clean_up_clients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to cleanup stats folder - </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_FOLDER_PATH</span><span class="si">}</span><span class="s2"> on controller.&quot;</span><span class="p">)</span>
            <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">()</span>
            <span class="n">folder_list</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_folders_in_path</span><span class="p">(</span><span class="n">folder_path</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_FOLDER_PATH</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span><span class="p">:</span>
                <span class="n">machine_obj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">directory_name</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span>
                                             <span class="n">days</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FILE_DELETE_DAYS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deletion on controller finished!!!&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.push_configurations"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.push_configurations">[docs]</a>    <span class="k">def</span> <span class="nf">push_configurations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Pushes the required configurations files to client machines based on given config</span>

<span class="sd">        Args:</span>

<span class="sd">            config_data     (dict)      --  performance Monitor config data</span>

<span class="sd">            Example : {</span>
<span class="sd">                        &#39;Live Scan&#39;: {</span>
<span class="sd">                                        &#39;1&#39;: {</span>
<span class="sd">                                                &#39;client&#39;: &#39;xyz&#39;,</span>
<span class="sd">                                                &#39;binary&#39;: {&#39;Windows&#39;: &#39;IFind.exe&#39;},</span>
<span class="sd">                                                &#39;counters&#39;: [&#39;\\Process(%s*)\\Handle Count&#39;],</span>
<span class="sd">                                                &#39;platform&#39;: &#39;UNIX&#39;,</span>
<span class="sd">                                                &#39;statsfolder&#39;: &#39;/Users/root/Automation_Performance_Data&#39;</span>
<span class="sd">                                            }</span>
<span class="sd">                                    },</span>
<span class="sd">                        &#39;Content Push&#39;: {</span>
<span class="sd">                                        &#39;1&#39;: {</span>
<span class="sd">                                                &#39;client&#39;: &#39;xyz&#39;,</span>
<span class="sd">                                                &#39;binary&#39;: {&#39;Windows&#39;: &#39;CLBackup.exe&#39;},</span>
<span class="sd">                                                &#39;counters&#39;: [&#39;1&#39;, &#39;5&#39;],</span>
<span class="sd">                                                &#39;platform&#39;: &#39;UNIX&#39;,</span>
<span class="sd">                                                &#39;statsfolder&#39;: &#39;/Users/Automation_Performance_Data&#39;}</span>
<span class="sd">                                        }</span>
<span class="sd">                    }</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Raises:</span>

<span class="sd">                Exception:</span>

<span class="sd">                        if failed to push configurations</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">push_finish</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clients_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">push_finish</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">phase_dict</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to push configurations for phase : </span><span class="si">{</span><span class="n">phase_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase Configuration got : </span><span class="si">{</span><span class="n">config_data</span><span class="p">[</span><span class="n">phase_dict</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">config_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">config_data</span><span class="p">[</span><span class="n">phase_dict</span><span class="p">])</span> <span class="o">+</span>
                                           <span class="mi">1</span><span class="p">):</span>  <span class="c1"># length of dict + 1 as we starting with index 1</span>
                        <span class="n">config_to_process</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_no</span><span class="p">)</span>
                        <span class="n">config</span> <span class="o">=</span> <span class="n">config_data</span><span class="p">[</span><span class="n">phase_dict</span><span class="p">][</span><span class="n">config_to_process</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">config_data</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty Dict @ config no - </span><span class="si">{</span><span class="n">config_no</span><span class="si">}</span><span class="s2">. Proceed further&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">client_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>
                        <span class="n">binary_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">]</span>
                        <span class="n">counters</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_PARAM</span><span class="p">]</span>
                        <span class="n">platform</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PLATFORM_PARAM</span><span class="p">]</span>
                        <span class="n">machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">client_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_OBJ_CACHE</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">has_client</span><span class="p">(</span><span class="n">client_name</span><span class="p">):</span>
                            <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">is_exists</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">):</span>
                            <span class="n">machine_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_name</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a Non-commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_name</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
                                                      <span class="n">username</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">USERNAME_PARAM</span><span class="p">],</span>
                                                      <span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PASSWORD_PARAM</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialised Machine object for client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">put_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">client_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">machine_obj</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clients_config</span><span class="p">:</span>
                            <span class="c1"># fetch hardware details for this client</span>
                            <span class="n">hardware_details</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_hardware_info</span><span class="p">()</span>
                            <span class="n">hardware_details</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_CLIENT_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="n">clients_config</span><span class="p">[</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">hardware_details</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched hardware details for the client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> successfully&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Hardware details for this client present already. client name - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">folder_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FOLDER_PARAM</span><span class="p">]</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}</span><span class="s2">&quot;</span> \
                                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">directory_path</span><span class="o">=</span><span class="n">folder_path</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating Folder - </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">  on client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">machine_obj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">directory_name</span><span class="o">=</span><span class="n">folder_path</span><span class="p">)</span>
                        <span class="n">config_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_file_path</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span>
                        <span class="c1"># For windows clients</span>
                        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client is windows machine. Create typeperf config files on : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">file_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">binary_name</span> <span class="o">!=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span><span class="p">:</span>
                                    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">binary_name</span><span class="p">))</span>
                                <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                    <span class="s2">&quot;.exe&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Counter file don&#39;t need extension on process name</span>
                                <span class="n">file_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_text</span><span class="si">}{</span><span class="n">counter</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">WINDOWS_NEW_LINE</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">file_text</span> <span class="o">=</span> <span class="n">file_text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">WINDOWS_NEW_LINE</span><span class="p">)</span>
                            <span class="c1"># create typeperf config file on destination remote client</span>
                            <span class="n">machine_obj</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">config_file_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">file_text</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file got created successfully on windows client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># update typeperf structure to print pid in header column</span>
                            <span class="n">machine_obj</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PERFMON_REGISTRY</span><span class="p">,</span>
                                                        <span class="n">value</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PERFMON_HEADER_PID_REG_KEY</span><span class="p">,</span>
                                                        <span class="n">data</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PERFMON_HEADER_WITH_PID_ON</span><span class="p">,</span>
                                                        <span class="n">reg_type</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">REGISTRY_DWORD</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated the PerfMon output header registry key to value : 2&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">Platforms</span><span class="o">.</span><span class="n">Unix</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client is Linux machine. Copy the bash script to client  : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">config_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_file_path</span><span class="p">(</span>
                                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="n">folder_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">binary_name</span> <span class="o">!=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process level counter matched. &quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;Bash local path : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_PROCESS_BASH_SCRIPT</span><span class="si">}</span><span class="s2"> &quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;Bash remote File path : </span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="nb">dir</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>  <span class="c1"># in case of process name with . in it</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">directory_path</span><span class="o">=</span><span class="nb">dir</span><span class="p">):</span>
                                    <span class="n">machine_obj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">directory_name</span><span class="o">=</span><span class="nb">dir</span><span class="p">)</span>
                                <span class="c1"># copy Process bash script to remote client</span>
                                <span class="n">machine_obj</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_PROCESS_BASH_SCRIPT</span><span class="p">,</span>
                                                            <span class="n">remote_path</span><span class="o">=</span><span class="n">config_folder</span><span class="p">)</span>
                                <span class="n">machine_obj</span><span class="o">.</span><span class="n">rename_file_or_folder</span><span class="p">(</span>
                                    <span class="n">old_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_folder</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}</span><span class="s2">&quot;</span>
                                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_PROCESS_BASH_FILE_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">new_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process level Bash script created successfully on the client&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine level counter matched. &quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;Bash local path : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_MACHINE_BASH_SCRIPT</span><span class="si">}</span><span class="s2">&quot;</span>
                                              <span class="sa">f</span><span class="s2">&quot;Bash remote File path : </span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">directory_path</span><span class="o">=</span><span class="nb">dir</span><span class="p">):</span>
                                    <span class="n">machine_obj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span>
                                        <span class="n">directory_name</span><span class="o">=</span><span class="nb">dir</span><span class="p">)</span>
                                <span class="c1"># copy machine bash script to remote client</span>
                                <span class="n">machine_obj</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">local_path</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_MACHINE_BASH_SCRIPT</span><span class="p">,</span>
                                                            <span class="n">remote_path</span><span class="o">=</span><span class="n">config_folder</span><span class="p">)</span>
                                <span class="n">machine_obj</span><span class="o">.</span><span class="n">rename_file_or_folder</span><span class="p">(</span>
                                    <span class="n">old_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_folder</span><span class="si">}{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="si">}</span><span class="s2">&quot;</span>
                                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">UNIX_MACHINE_BASH_FILE_NAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">new_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Machine level Bash script created successfully on the client&quot;</span><span class="p">)</span>
                <span class="n">push_finish</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">push_finish</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                <span class="n">attempt</span> <span class="o">=</span> <span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># after few attempts, fail the monitor process by raising exceptions</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PUSH_CONFIG_FAIL_RETRY</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Push configurations fail retry threshold exceeded.Fail the Performance collection&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Configurations got pushed to respective clients&quot;</span><span class="p">)</span>
        <span class="c1"># dump machine config and job config to the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dumping Machine configs into file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">dump_json_to_file</span><span class="p">(</span><span class="n">json_data</span><span class="o">=</span><span class="n">clients_config</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">machine_config_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dumping Job configs into file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">dump_json_to_file</span><span class="p">(</span><span class="n">json_data</span><span class="o">=</span><span class="n">config_data</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_config_file_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.get_thread_name"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.get_thread_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_thread_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;forms the thread name based on config data</span>

<span class="sd">        Args:</span>

<span class="sd">            config      (dict)      --  dict containing performance monitor config data</span>

<span class="sd">        Returns:</span>

<span class="sd">            str     --  name of the thread</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">binary_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PLATFORM_PARAM</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forming Thread name with Platform as : </span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">platform</span><span class="p">]</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">binary_name</span> <span class="o">==</span> <span class="n">Binary</span><span class="o">.</span><span class="n">CONTENT_EXTRACTOR</span><span class="p">[</span><span class="n">Platforms</span><span class="o">.</span><span class="n">Unix</span><span class="p">]:</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="s2">&quot;ContentExtractor&quot;</span>
        <span class="n">thread_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2">_Thread&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Formed Thread Name for config : </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thread_name</span></div>

<div class="viewcode-block" id="PerformanceMonitor.kill_thread_and_get_stats"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.kill_thread_and_get_stats">[docs]</a>    <span class="k">def</span> <span class="nf">kill_thread_and_get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_obj</span><span class="p">,</span> <span class="n">cmd_line</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;kills the monitor process on the client machine and get stats file to the controller</span>

<span class="sd">        Args:</span>

<span class="sd">            machine_obj         (obj)       --  Machine class object</span>

<span class="sd">            cmd_line            (str)       --  command line param to look for in process</span>

<span class="sd">            remote_file         (str)       --  remote csv file path which contains the performance stats collected</span>

<span class="sd">            file_path           (str)       --  file path in controller where stats needs to be copied over</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">on_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pending_file_move</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">job_done</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">monitor_pid</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># get pid of the monitored process</span>
                <span class="k">if</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">monitor_pid</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_process_id</span><span class="p">(</span><span class="n">process_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">TYPEPERF_EXE</span><span class="p">,</span>
                                                             <span class="n">command_line_keyword</span><span class="o">=</span><span class="n">cmd_line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">monitor_pid</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_process_id</span><span class="p">(</span><span class="n">process_name</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BASH_EXE</span><span class="p">,</span>
                                                             <span class="n">command_line_keyword</span><span class="o">=</span><span class="n">cmd_line</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># sometimes remote file fetch fails. so we are separating the monitor process kill and remote file</span>
                    <span class="c1"># fetch separately</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">monitor_pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no monitor process running.</span>
                        <span class="c1"># check whether remote file fetch is still pending</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_file_move</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process Instances to be killed is - 0. Skip getting the remote stats file&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Process instance already killed or not running. &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Try to get remote stats file - </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Going to Kill older Monitor Instance on client ip : </span><span class="si">{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;with pid : </span><span class="si">{</span><span class="n">monitor_pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># for unix bash scripts, multiple process may be running as child to bash script. Kill all such</span>
                        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">monitor_pid</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Killing Process id : </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">machine_obj</span><span class="o">.</span><span class="n">kill_process</span><span class="p">(</span><span class="n">process_id</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Killed the older Monitor Instance. Proceed with getting output stats &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;from client IP : </span><span class="si">{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="c1"># sometimes for unix machine, child process of script may not exists. so</span>
                    <span class="c1"># avoid printing that exception</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">NO_VALID_PROCESS</span><span class="p">])</span>
                <span class="c1"># CSV performance stats remote file fetch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to access remote file path : </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2"> on client : </span><span class="si">{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">remote_file</span><span class="p">)</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">FILE_WRITE_MODE</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PYTHON_NEW_LINE</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File - </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2"> fetched successfully from remote client to the controller&quot;</span><span class="p">)</span>
                    <span class="c1"># mark task as done</span>
                    <span class="n">job_done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pending_file_move</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="n">pending_file_move</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">FILE_NOT_EXISTS</span> <span class="ow">in</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error -&gt; Remote stats file not found. File name : </span><span class="si">{</span><span class="n">remote_file</span><span class="si">}</span><span class="s2"> &quot;</span>
                                       <span class="sa">f</span><span class="s2">&quot;on client : </span><span class="si">{</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># after few attempts, fail the monitor by raising exception</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">FILE_DOWNLOAD_ERROR_THRESHOLD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Stats File thread crossed the failure threshold. Fail the collection&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span></div>

<div class="viewcode-block" id="PerformanceMonitor.push_stats_thread"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.push_stats_thread">[docs]</a>    <span class="k">def</span> <span class="nf">push_stats_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pushes the performance stats to the open data source</span>

<span class="sd">        Args:</span>

<span class="sd">            stop                    (bool)      --  boolean value to denote whether to stop the thread or not at runtime</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                    if failed to push data to open data source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">on_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">queue_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">init_data_source</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">process_data_source_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">machine_data_source_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># initialise data source only once for entire run</span>
            <span class="n">monitor_counts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">monitor_counts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No monitor threads are running.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Threads : </span><span class="si">{</span><span class="n">monitor_counts</span><span class="si">}</span><span class="s2"> | &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;Monitor threads running : </span><span class="si">{</span><span class="n">monitor_counts</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># minus the push thread</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">init_data_source</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_performance_data_source</span><span class="p">()</span>
                    <span class="n">process_data_source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Process_Data_Source_Name</span><span class="p">)</span>
                    <span class="n">machine_data_source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">datacube</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">Machine_Data_Source_Name</span><span class="p">)</span>
                    <span class="c1"># push the machine configurations to the open data source</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">push_hwinfo_to_data_source</span><span class="p">(</span><span class="n">config_json_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">machine_config_file_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting open DataSource setup as completed with True flag&quot;</span><span class="p">)</span>
                    <span class="n">init_data_source</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                    <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PUSH_ERROR_THRESHOLD</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to create open data source to store performance stats&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to create open data source to store performance stats&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># check quit flag for thread</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quit flag set. Stopping the Thread : </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># come out if queue is empty or failure crossed threshold or no monitor threads are running</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_alive_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PUSH_ERROR_THRESHOLD</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
                    <span class="c1"># wait for queue to empty before going down</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> waiting for queue to be empty before going down. Current Queue size : </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">queue_count</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> Setting Remaining queue count as : </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">queue_count</span> <span class="o">=</span> <span class="n">count</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if queue size is not decreasing due to some data source push issue, then consider it as fail</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> queue is not decreasing. Current Queue Size : </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PUSH_ERROR_THRESHOLD</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataSource Push Queue is not decreasing. Fail the collection&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;DataSource Push Queue is not decreasing. Fail the collection&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="c1"># get data from queue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get data from Push queue. Current Queue size : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">push_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>  <span class="c1"># lets not block the thread by calling get()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Push stats configuration got from monitor thread&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">config_data</span><span class="o">=</span><span class="n">push_json</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">push_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">post_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_from_csv</span><span class="p">(</span><span class="n">push_json</span><span class="o">=</span><span class="n">push_json</span><span class="p">)</span>
                            <span class="n">counter_type</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTER_TYPE_PARAM</span><span class="p">]</span>
                            <span class="n">stats_csv_file</span> <span class="o">=</span> <span class="n">push_json</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FILE_PARAM</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">counter_type</span> <span class="o">==</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to use Process level Performance DataSource for pushing stats&quot;</span><span class="p">)</span>
                                <span class="n">process_data_source_obj</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Data got pushed for performance stats file : </span><span class="si">{</span><span class="n">stats_csv_file</span><span class="si">}</span><span class="s2"> in Process &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;DataSource. Total rows : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Going to use Machine level Performance DataSource for pushing stats&quot;</span><span class="p">)</span>
                                <span class="n">machine_data_source_obj</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Data got pushed for performance stats file : </span><span class="si">{</span><span class="n">stats_csv_file</span><span class="si">}</span><span class="s2"> in Machine &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;DataSource. Total rows : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pushed back the json to queue as something went wrong&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">push_json</span><span class="p">)</span>
                        <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PUSH_ERROR_THRESHOLD</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Push thread crossed the failure threshold. Fail the collection&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Push thread crossed the failure threshold. Fail the collection&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">stop</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># push thread alone running and all other monitor went down</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quit flag set. Stopping the Thread : </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> completely&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> is up and running. Sleeping for </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PUSH_THREAD_SLEEP_IN_MINS</span><span class="si">}</span><span class="s2"> Mins&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PUSH_THREAD_SLEEP_IN_MINS</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> going down gracefully&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceMonitor.monitor_thread"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.monitor_thread">[docs]</a>    <span class="k">def</span> <span class="nf">monitor_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">push_to_data_source</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Thread which is used to monitor the commvault process on client for performance data</span>

<span class="sd">        Args:</span>

<span class="sd">            job_id              (str)       --  job id</span>

<span class="sd">            push_to_data_source (bool)      --  boolean to specify whether to push stats to open data source or not</span>

<span class="sd">            config              (dict)      --  dict containing performance monitor config</span>

<span class="sd">                                Example : {</span>
<span class="sd">                                            &quot;client&quot;: &quot;xuz&quot;,</span>
<span class="sd">                                            &quot;binary&quot;: &quot;cvd.exe&quot;,</span>
<span class="sd">                                            &quot;counters&quot;: [</span>
<span class="sd">                                                            &quot;\\Process({pname}*)\\Handle Count&quot;,</span>
<span class="sd">                                                            &quot;\\Process({pname}*)\\Thread Count&quot;</span>
<span class="sd">                                                        ],</span>
<span class="sd">                                            &quot;platform&quot;: &quot;Windows&quot;,</span>
<span class="sd">                                            &quot;statsfolder&quot;: &quot;C:\\Automation_Data&quot;,</span>
<span class="sd">                                            &quot;cmdlineparams&quot;:&quot;Instance002&quot;</span>
<span class="sd">                                        }</span>

<span class="sd">            stop                (bool)      --  boolean value to denote whether to stop the thread or not at runtime</span>

<span class="sd">        Returns:</span>

<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">client_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">port_usage_stats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PORT_USAGE_PARAM</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PORT_USAGE_PARAM</span><span class="p">]:</span>
            <span class="n">port_usage_stats</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PLATFORM_PARAM</span><span class="p">]</span>
        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> - Starting&quot;</span><span class="p">)</span>
        <span class="n">binary_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">]</span>
        <span class="n">counters</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_PARAM</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">binary_name</span> <span class="o">=</span> <span class="n">binary_name</span><span class="p">[</span><span class="n">platform</span><span class="p">]</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">]</span>
        <span class="n">cmd_line</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COMMAND_LINE_PARAM</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">has_client</span><span class="p">(</span><span class="n">client_name</span><span class="p">):</span>
            <span class="n">is_cvlt_client</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># check whether command line param is job related, if so include job id</span>
        <span class="k">if</span> <span class="n">cmd_line</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_ID_CMD_LINE_PARAM</span><span class="p">,</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_ID_CMD_LINE_PARAM_OTHER</span><span class="p">,</span>
                        <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">JOB_TOKEN_CMD_LINE_PARAM</span><span class="p">):</span>
            <span class="n">cmd_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_line</span><span class="si">}{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding job id to the command line param. Final cmd line : </span><span class="si">{</span><span class="n">cmd_line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">init_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">on_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># initialise the machine object</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">init_done</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client_obj</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># check cache. if found reuse it or else initialise machine obj again</span>
                <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_OBJ_CACHE</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">is_exists</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">):</span>
                        <span class="n">client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">put_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">client_obj</span><span class="p">)</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MACHINE_OBJ_CACHE</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">is_exists</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">):</span>
                    <span class="n">machine_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
                        <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_obj</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It is a Non-commvault client - </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">client_name</span><span class="p">,</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
                                              <span class="n">username</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">USERNAME_PARAM</span><span class="p">],</span>
                                              <span class="n">password</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PASSWORD_PARAM</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialised Machine object for client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_obj</span><span class="o">.</span><span class="n">put_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">machine_obj</span><span class="p">)</span>

                <span class="n">init_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MONITOR_THREAD_ERROR_THRESHOLD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_INIT_FAIL</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_INIT_FAIL</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="n">config_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_file_path</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file path for this config : </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">controller_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CONTROLLER_FOLDER_PATH</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_id</span><span class="p">,</span>
            <span class="n">client_name</span><span class="p">,</span>
            <span class="n">binary_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">controller_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">controller_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created folder on controller : </span><span class="si">{</span><span class="n">controller_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stats_file_count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">stats_collected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">binary_process_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">is_machine_counter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">on_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># check if quit flag is set</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quit flag set. Stopping the Thread : </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pid_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">binary_name</span> <span class="o">!=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span><span class="p">:</span>
                    <span class="n">pid_list</span> <span class="o">=</span> <span class="n">machine_obj</span><span class="o">.</span><span class="n">get_process_id</span><span class="p">(</span><span class="n">process_name</span><span class="o">=</span><span class="n">binary_name</span><span class="p">,</span> <span class="n">command_line_keyword</span><span class="o">=</span><span class="n">cmd_line</span><span class="p">)</span>
                    <span class="c1"># add all monitored process pid to list to track</span>
                    <span class="k">for</span> <span class="n">process_id</span> <span class="ow">in</span> <span class="n">pid_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">process_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">binary_process_ids</span><span class="p">:</span>
                            <span class="n">binary_process_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_machine_counter</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">is_machine_counter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">port_usage_stats</span><span class="p">:</span>
                        <span class="n">port_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PORT_USAGE_STATS</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">collect_stats</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">port_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_task</span><span class="p">:</span>
                            <span class="n">collect_stats</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">port_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer_task</span><span class="p">:</span>
                            <span class="n">last_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timer_task</span><span class="p">[</span><span class="n">port_key</span><span class="p">])</span>
                            <span class="n">now_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                            <span class="n">time_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PORT_USAGE_CAPTURE_TIME_INTERVAL_IN_MINS</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">now_time</span> <span class="o">&gt;</span> <span class="n">last_time</span> <span class="o">+</span> <span class="n">time_limit</span><span class="p">:</span>
                                <span class="n">collect_stats</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">collect_stats</span><span class="p">:</span>
                            <span class="n">custom_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">push_netstat_to_data_source</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                                <span class="n">machine_obj</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span> <span class="n">binary_name</span><span class="p">,</span> <span class="n">pid_list</span><span class="p">,</span> <span class="n">push_to_data_source</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">custom_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                            <span class="n">now_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> -&gt; Updating port usage last execution time as : </span><span class="si">{</span><span class="n">now_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer_task</span><span class="p">[</span><span class="n">port_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">now_time</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not collecting port usage as criteria is not met&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_machine_counter</span><span class="p">:</span>
                        <span class="c1"># machine performance stats collection</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine level stats collection enabled. Proceeding further&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># process performance stats collection</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected binary process </span><span class="si">{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2"> is running with PID : </span><span class="si">{</span><span class="n">pid_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Windows</span><span class="p">:</span>
                        <span class="c1"># for windows client, start the typeperf command</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_TEXT_FILE</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stats_file_count</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_OUTPUT_TEXT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
                        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">controller_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting the typperf command with stats file count : </span><span class="si">{</span><span class="n">stats_file_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">TYPEPERF_EXE</span><span class="si">}</span><span class="s2"> -cf </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2"> &quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot;-si </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PERFORMANCE_STATS_INTERVAL_IN_SECS</span><span class="si">}</span><span class="s2"> -y -f CSV -o </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Typeperf command formed : </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">stats_started</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">on_stat_error</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">stats_started</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                                    <span class="n">client_obj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># for some reason, subprocess call from powershell is blocking parent process too</span>
                                    <span class="c1"># so implementing this as thread with timeout for non commvault client</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">cmd_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_cmd_timer</span><span class="p">,</span>
                                                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">machine_obj</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
                                        <span class="n">cmd_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                        <span class="n">cmd_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                            <span class="n">timeout</span><span class="o">=</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">NON_COMMVAULT_CLIENT_REMOTE_COMMAND_EXECUTE_WAIT_IN_SECS</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                                <span class="n">stats_started</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                                <span class="n">on_stat_error</span> <span class="o">=</span> <span class="n">on_stat_error</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="n">on_stat_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">REMOTE_CLIENT_PROCESS_START_THRESHOLD</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_PROCESS_START</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Typeperf started on client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> @ time : </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="n">Platforms</span><span class="o">.</span><span class="n">Unix</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting the Bash script with stats file count : </span><span class="si">{</span><span class="n">stats_file_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">process</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pid_list</span><span class="p">])</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_BASH_FILE</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">remote_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stats_file_count</span><span class="si">}{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_OUTPUT_TEXT_FILE</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="c1"># this get passed as command line args in order to kill this instance of bash</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="n">remote_path</span>
                        <span class="c1"># append file name to the controller folder to get full path</span>
                        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">controller_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COLUMN_TIME</span>  <span class="c1"># first column is time always</span>
                        <span class="k">for</span> <span class="n">each_counter</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">:</span>
                            <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="p">[</span><span class="n">each_counter</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">counter_type</span> <span class="o">=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span> <span class="k">if</span> <span class="n">binary_name</span> <span class="o">!=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span> \
                            <span class="k">else</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span>
                        <span class="k">if</span> <span class="n">counter_type</span> <span class="o">==</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process level counters found for this configuration&quot;</span><span class="p">)</span>
                            <span class="c1"># process counters starts with $. so remove those</span>
                            <span class="n">counter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">])</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BASH_EXE</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="n">process</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PERFORMANCE_STATS_INTERVAL_IN_SECS</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process Bash cmd formed : </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">stats_started</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">on_stat_error</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">while</span> <span class="ow">not</span> <span class="n">stats_started</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                                        <span class="n">client_obj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># for some reason, subprocess call from powershell is blocking parent process too</span>
                                        <span class="c1"># so implementing this as thread with timeout for non commvault client</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">cmd_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_cmd_timer</span><span class="p">,</span>
                                                                          <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">machine_obj</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
                                            <span class="n">cmd_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                            <span class="n">cmd_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                <span class="n">timeout</span><span class="o">=</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">NON_COMMVAULT_CLIENT_REMOTE_COMMAND_EXECUTE_WAIT_IN_SECS</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                                    <span class="n">stats_started</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                                    <span class="n">on_stat_error</span> <span class="o">=</span> <span class="n">on_stat_error</span> <span class="o">+</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="n">on_stat_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">REMOTE_CLIENT_PROCESS_START_THRESHOLD</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_PROCESS_START</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Process Bash started on client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> @ time : </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Machine level counters found for this configuration&quot;</span><span class="p">)</span>
                            <span class="c1"># process counters starts with $$. so remove those</span>
                            <span class="n">counter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">])</span>
                            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BASH_EXE</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s2">&#39; &quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">PERFORMANCE_STATS_INTERVAL_IN_SECS</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Machine Bash cmd formed : </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">is_cvlt_client</span><span class="p">:</span>
                                    <span class="n">client_obj</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># for some reason, subprocess call from powershell is blocking parent process too</span>
                                    <span class="c1"># so implementing this as thread with timeout for non commvault client</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">cmd_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_cmd_timer</span><span class="p">,</span>
                                                                      <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">machine_obj</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
                                        <span class="n">cmd_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                                        <span class="n">cmd_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                            <span class="n">timeout</span><span class="o">=</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">NON_COMMVAULT_CLIENT_REMOTE_COMMAND_EXECUTE_WAIT_IN_SECS</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Machine Bash started on client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> @ time : </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats_collected</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">time_limit</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">MONITOR_THREAD_RESTART_INTERVAL_IN_MINS</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="c1"># wait for predefined time before restarting the performance collection threads</span>
                    <span class="k">while</span> <span class="n">current_time</span> <span class="o">&lt;</span> <span class="n">time_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> is up and running. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Sleeping for </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">MONITOR_THREAD_SLEEP_IN_MINS</span><span class="si">}</span><span class="s2"> Mins&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">MONITOR_THREAD_SLEEP_IN_MINS</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="c1"># check for quit flag</span>
                        <span class="k">if</span> <span class="n">stop</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quit flag set. Stopping the Monitor Process : </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">kill_thread_and_get_stats</span><span class="p">(</span><span class="n">machine_obj</span><span class="o">=</span><span class="n">machine_obj</span><span class="p">,</span>
                                                           <span class="n">cmd_line</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                                                           <span class="n">remote_file</span><span class="o">=</span><span class="n">remote_path</span><span class="p">,</span>
                                                           <span class="n">file_path</span><span class="o">=</span><span class="n">local_path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> killed all instances of process. Will go down!!!&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restart the monitor process as it reached the time limit&quot;</span><span class="p">)</span>
                    <span class="c1"># predefined time limit reached. Stop remote scripts and get output csv files</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kill_thread_and_get_stats</span><span class="p">(</span><span class="n">machine_obj</span><span class="o">=</span><span class="n">machine_obj</span><span class="p">,</span>
                                                   <span class="n">cmd_line</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                                                   <span class="n">remote_file</span><span class="o">=</span><span class="n">remote_path</span><span class="p">,</span>
                                                   <span class="n">file_path</span><span class="o">=</span><span class="n">local_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Successfully moved stats file : </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> from client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;to controller : </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stats_file_count</span> <span class="o">=</span> <span class="n">stats_file_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="c1"># put the stats into queue for pushing into data source</span>
                    <span class="k">if</span> <span class="n">push_to_data_source</span><span class="p">:</span>
                        <span class="n">push_json</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PARAM</span><span class="p">:</span> <span class="n">binary_name</span><span class="p">,</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">CLIENT_PARAM</span><span class="p">:</span> <span class="n">client_name</span><span class="p">,</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTER_TYPE_PARAM</span><span class="p">:</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">PROCESS_COUNTER</span> <span class="k">if</span> <span class="n">binary_name</span> <span class="o">!=</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span> <span class="k">else</span> <span class="n">CounterTypes</span><span class="o">.</span><span class="n">MACHINE_COUNTER</span><span class="p">,</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_PARAM</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_PARAM</span><span class="p">],</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">BINARY_PID_PARAM</span><span class="p">:</span> <span class="n">pid_list</span><span class="p">,</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">STATS_FILE_PARAM</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
                            <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PLATFORM_PARAM</span><span class="p">:</span> <span class="n">platform</span><span class="p">}</span>
                        <span class="c1"># quit flag set because of error from any thread, then don&#39;t push further stats to data source</span>
                        <span class="k">if</span> <span class="n">stop</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Quit signal set because of Error. Don&#39;t push any request to queue. &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Dropping request : </span><span class="si">{</span><span class="n">push_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">push_json</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> -&gt; Queue push was success for Json - </span><span class="si">{</span><span class="n">push_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not Found. Skip adding stats file to queue : </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected binary process </span><span class="si">{</span><span class="n">binary_name</span><span class="si">}</span><span class="s2"> is not running on client : </span><span class="si">{</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                <span class="n">on_error</span> <span class="o">=</span> <span class="n">on_error</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MONITOR_THREAD_ERROR_THRESHOLD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_FAIL</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MONITOR_THREAD_FAIL</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> is going down gracefully&quot;</span><span class="p">)</span>
        <span class="c1"># if stats was not collected even once, then it is failure. Raise exception</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stats_collected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> -&gt; Stats not collected properly for this configurations - </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_STATS_NOT_COLLECTED_ONCE</span></div>

<div class="viewcode-block" id="PerformanceMonitor.start_monitor"><a class="viewcode-back" href="../../../source/AutomationUtils.Performance.html#AutomationUtils.Performance.performance_monitor.PerformanceMonitor.start_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">start_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">push_to_data_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; starts the performance monitor for the given job id</span>

<span class="sd">        Args:</span>

<span class="sd">            job_id              (int/str)   --      job id which needs to be monitored for performance</span>

<span class="sd">                In case of non-job based monitoring, this value will be considered as timeout in Mins</span>

<span class="sd">            job_type            (int)       --      type of job</span>
<span class="sd">                                                Example : defined in JobTypes in constants.py</span>

<span class="sd">            push_to_data_source (bool)      --      boolean to specify whether to push stats to open data source or not</span>
<span class="sd">                                                        Default -True</span>

<span class="sd">            config              (dict)      --      dict containing inputs for performance collection</span>

<span class="sd">                        Example : {</span>
<span class="sd">                                    &quot;Recover&quot;: {</span>
<span class="sd">                                                &quot;1&quot;: {</span>
<span class="sd">                                                        &quot;client&quot;: &quot;xyz&quot;,</span>
<span class="sd">                                                        &quot;binary&quot;: &quot;cvd.exe&quot;,</span>
<span class="sd">                                                        &quot;counters&quot;: [</span>
<span class="sd">                                                                            &quot;\\Process({pname}*)\\Handle Count&quot;,</span>
<span class="sd">                                                                            &quot;\\Process({pname}*)\\Thread Count&quot;</span>
<span class="sd">                                                                    ],</span>
<span class="sd">                                                        &quot;platform&quot;: &quot;Windows&quot;,</span>
<span class="sd">                                                        &quot;statsfolder&quot;: &quot;C:\\Automation_Data&quot;,</span>
<span class="sd">                                                        &quot;cmdlineparams&quot;:&quot;Instance002&quot;</span>
<span class="sd">                                                    }</span>
<span class="sd">                                                }</span>
<span class="sd">                                }</span>

<span class="sd">                        -- Recover is the job phase</span>
<span class="sd">                        -- For time based collection, job phase is : TimerPhase</span>

<span class="sd">                        Example : {</span>
<span class="sd">                                    &quot;TimerPhase&quot;: {</span>
<span class="sd">                                                &quot;1&quot;: {</span>
<span class="sd">                                                        &quot;client&quot;: &quot;xyz&quot;,</span>
<span class="sd">                                                        &quot;binary&quot;: &quot;cvd.exe&quot;,</span>
<span class="sd">                                                        &quot;counters&quot;: [</span>
<span class="sd">                                                                            &quot;\\Process({pname}*)\\Handle Count&quot;,</span>
<span class="sd">                                                                            &quot;\\Process({pname}*)\\Thread Count&quot;</span>
<span class="sd">                                                                    ],</span>
<span class="sd">                                                        &quot;platform&quot;: &quot;Windows&quot;,</span>
<span class="sd">                                                        &quot;statsfolder&quot;: &quot;C:\\Automation_Data&quot;,</span>
<span class="sd">                                                        &quot;cmdlineparams&quot;:&quot;&quot;</span>
<span class="sd">                                                    }</span>
<span class="sd">                                                }</span>
<span class="sd">                                }</span>


<span class="sd">                     **kwargs    --  optional params</span>

<span class="sd">                    DataSourceName  --  Name of the data source used in crawl job</span>

<span class="sd">                    SourceName_s    --  Name of the source data</span>

<span class="sd">                    SourceSize_s    --  Size of the source data</span>


<span class="sd">        Returns:</span>

<span class="sd">            bool        --  True: if performance stats was collected properly</span>
<span class="sd">                            False: if performance stats collection ended in some error or failed to collect</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                    if input data type is not valid</span>

<span class="sd">                    if failed to monitor performance stats for the job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Input data type is not valid&quot;</span><span class="p">)</span>
        <span class="n">job_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job based Monitoring&quot;</span><span class="p">)</span>
            <span class="n">job_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">job_controller</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time based Monitoring&quot;</span><span class="p">)</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">time_limit</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">job_id</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout set as : </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> Mins&quot;</span><span class="p">)</span>
        <span class="n">old_phase</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">current_status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">current_phase</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">job_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">job_pause</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">job_status_fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">monitor_phase_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counters field mapping loaded : </span><span class="si">{</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">COUNTERS_FIELD_MAPPING</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
                <span class="n">job_done</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">is_finished</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
        <span class="c1"># loop till job is finished</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">job_done</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
                    <span class="n">job_done</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">is_finished</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">time_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time limit reached&quot;</span><span class="p">)</span>
                        <span class="n">job_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># if job done, then stop all threads and go down</span>
                <span class="k">if</span> <span class="n">job_done</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monitored job completed. Stopping the threads&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
                    <span class="n">current_status</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">status</span>
                <span class="c1"># check job status. if it goes pending/waiting, then stop all collection threads and wait for resume</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span> <span class="ow">and</span> <span class="n">current_status</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">SUSPENDED</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job is in Pending/Suspend or Waiting state. Current state : </span><span class="si">{</span><span class="n">current_status</span><span class="si">}</span><span class="s2">.&quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot; Pausing the peformance monitor&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                    <span class="n">job_pause</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">old_phase</span> <span class="o">=</span> <span class="n">current_status</span>  <span class="c1"># we need it to restart all threads once job gets resumed</span>
                <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timer is running. Remaining Mins - </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time_limit</span> <span class="o">-</span> <span class="n">current_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monitored Job is in Running state&quot;</span><span class="p">)</span>
                    <span class="n">job_pause</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">job_status_fail_count</span> <span class="o">=</span> <span class="n">job_status_fail_count</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job_status_fail_count</span> <span class="o">&gt;</span> <span class="n">TimerIntervals</span><span class="o">.</span><span class="n">JOB_STATUS_FAIL_RETRY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Main thread job status check threshold reached. Going down&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Main thread job status check threshold reached. Please check logs&quot;</span><span class="p">)</span>
                <span class="k">continue</span>  <span class="c1"># continue trying to get job status</span>
            <span class="c1"># one of the thread reported error status, stop the collection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error flag set. Going down&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
                    <span class="n">current_phase</span> <span class="o">=</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">phase</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_phase</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">TIMER_PHASE</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_log_exception</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">exp</span><span class="p">)</span>
            <span class="c1"># current phase is different from old monitored phase, then kill older threads and start new collection for</span>
            <span class="c1"># current job phase</span>
            <span class="k">if</span> <span class="n">old_phase</span> <span class="o">!=</span> <span class="n">current_phase</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_pause</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase change detected. Old Phase : </span><span class="si">{</span><span class="n">old_phase</span><span class="si">}</span><span class="s2">  Current Phase : </span><span class="si">{</span><span class="n">current_phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job is ready for Monitoring performance stats with phase : </span><span class="si">{</span><span class="n">current_phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">old_phase</span> <span class="o">=</span> <span class="n">current_phase</span>
                <span class="c1"># check if current phase is in config which user needs to be monitored</span>
                <span class="k">if</span> <span class="n">current_phase</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Phase present in performance monitor. Going to start off the thread&quot;</span><span class="p">)</span>
                    <span class="n">monitor_phase_count</span> <span class="o">=</span> <span class="n">monitor_phase_count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">current_phase_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">current_phase</span><span class="p">]</span>
                    <span class="c1"># check for duplicate configurations</span>
                    <span class="n">current_phase_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">remove_dup_configs</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">current_phase_config</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">config_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_phase_config</span><span class="p">)</span> <span class="o">+</span>
                                           <span class="mi">1</span><span class="p">):</span>  <span class="c1"># length of dict + 1 as we starting with index 1</span>
                        <span class="n">config_to_process</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config_no</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config_to_process</span><span class="si">}</span><span class="s2"> --&gt; Configuration : </span><span class="si">{</span><span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> \
                                <span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">]</span> <span class="o">==</span> <span class="p">{}:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Empty Configurations. Ignore&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">monitor_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_thread</span><span class="p">,</span>
                                                          <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">],</span>
                                                                <span class="n">push_to_data_source</span><span class="p">,</span>
                                                                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span><span class="p">,</span> <span class="p">))</span>
                        <span class="n">monitor_thread</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thread_name</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">current_phase_config</span><span class="p">[</span><span class="n">config_to_process</span><span class="p">])</span>
                        <span class="n">monitor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="c1"># append the thread details to thread array</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor_thread</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started thread with name : </span><span class="si">{</span><span class="n">monitor_thread</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Threads invoked for Phase : </span><span class="si">{</span><span class="n">current_phase</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">push_to_data_source</span><span class="p">:</span>  <span class="c1"># Pushing stats to open data source</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting the performance stats open data source push thread&quot;</span><span class="p">)</span>
                        <span class="n">push_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">push_stats_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                                <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_threads</span><span class="p">,</span> <span class="p">))</span>
                        <span class="n">push_thread</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">PUSH_THREAD_NAME</span>
                        <span class="n">push_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="c1"># append the thread details to thread array</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">push_thread</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started thread with name : </span><span class="si">{</span><span class="n">push_thread</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Phase : </span><span class="si">{</span><span class="n">current_phase</span><span class="si">}</span><span class="s2"> is not present in Config. No need to Monitor&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">job_pause</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No change in Job phase. Continue Monitoring in phase : </span><span class="si">{</span><span class="n">current_phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_alive_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
            <span class="c1"># sleep for some predefined time and then wake up to check further on job progress</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main Monitor sleeping for </span><span class="si">{</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">MAIN_THREAD_SLEEP_IN_MINS</span><span class="si">}</span><span class="s2"> Mins&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TimerIntervals</span><span class="o">.</span><span class="n">MAIN_THREAD_SLEEP_IN_MINS</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main Monitor Wake up&quot;</span><span class="p">)</span>
        <span class="c1"># job is finished. fetch job details and store it in JSON file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_and_kill_threads</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job finished with status : </span><span class="si">{</span><span class="n">job_obj</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_job_details</span><span class="p">(</span><span class="n">job_obj</span><span class="o">=</span><span class="n">job_obj</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perf_helper</span><span class="o">.</span><span class="n">dump_json_to_file</span><span class="p">(</span><span class="n">json_data</span><span class="o">=</span><span class="n">job_details</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_details_file_path</span><span class="p">)</span>
        <span class="c1"># push job details to the open data source</span>
        <span class="k">if</span> <span class="n">push_to_data_source</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="n">JobTypes</span><span class="o">.</span><span class="n">TIME_BASED_JOB_MONITORING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calling job details push to data source&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_jobinfo_to_data_source</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="c1"># if total monitored phase in config is not equal to actually one monitored, then we missed few job phase.</span>
        <span class="k">if</span> <span class="n">monitor_phase_count</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total phases in configurations : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;but monitored phase count : </span><span class="si">{</span><span class="n">monitor_phase_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">ERROR_MISSING_PERFORMANCE_STATS_FOR_PHASE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance collection done successfully&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_configurations</span><span class="p">(</span><span class="n">config_data</span><span class="o">=</span><span class="n">config</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>