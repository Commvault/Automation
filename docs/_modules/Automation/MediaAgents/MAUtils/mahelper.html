
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Automation.MediaAgents.MAUtils.mahelper &#8212; Commvault Automation 11.14 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Automation.MediaAgents.MAUtils.mahelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;This file contains classes named DedupeHelper, CloudLibrary and MMHelper which consists of</span>
<span class="sd"> methods required for MM testacse assistance like DB queries, log parsing, etc.</span>

<span class="sd">Class DedupeHelper:</span>
<span class="sd">    parse_log()                     --  parsing log files in search of a particular pattern</span>

<span class="sd">    change_path()                   --  modifies given path to network path</span>

<span class="sd">    get_primary_objects()           --  Gets primary objects on a SIDB</span>

<span class="sd">    get_secondary_objects()         --  Gets secondary objects on a SIDB</span>

<span class="sd">    get_primary_objects_sec()       --  Gets primary objects of a secondary copy</span>

<span class="sd">    get_secondary_objects_sec()     --  Gets secondary objects on secondary copy</span>

<span class="sd">    get_sidb_ids()                  --  get SIDB store and substore id</span>

<span class="sd">    get_network_transfer_bytes()    --  gets bytes transfered for a job</span>

<span class="sd">    submit_backup_memdb_recon()     --  Launches full backup, kills SIDB to initiate a</span>
<span class="sd">                                        full DDB Recon</span>

<span class="sd">    poll_ddb_reconstruction()       --  Polls CSDB for recon job</span>

<span class="sd">    get_reconstruction_type()	    --  returns if Delta recon or Regular recon or Full recon</span>


<span class="sd">Class MMHelper:</span>
<span class="sd">    get_drive_pool_id()         -- get drivepool id</span>

<span class="sd">    get_spare_pool_id()         -- get spare pool id</span>

<span class="sd">    get_copy_id()               -- get storage policy copy id</span>

<span class="sd">    remove_content_subclient()  -- Deletes subclient data</span>

<span class="sd">    get_archive_file_size()     -- Gets sum of archive file size on a copy/for a job</span>


<span class="sd">CloudLibrary:</span>
<span class="sd">    __init__(libraryname, libraryinfo)             --  initialize the cloud library class</span>
<span class="sd">     instance for the commcell</span>

<span class="sd">    cleanup_entities(commcell, log, entity_config) --   static method to cleanup commcell entities.</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="k">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">cvpysdk</span> <span class="k">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>


<div class="viewcode-block" id="DedupeHelper"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper">[docs]</a><span class="k">class</span> <span class="nc">DedupeHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes BasicOperations object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">tcinputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserver_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">backupset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">subclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="p">(</span><span class="n">test_case_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

<div class="viewcode-block" id="DedupeHelper.parse_log"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.parse_log">[docs]</a>    <span class="k">def</span> <span class="nf">parse_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">client</span><span class="p">,</span>
                  <span class="n">log_file</span><span class="p">,</span>
                  <span class="n">regex</span><span class="p">,</span>
                  <span class="n">jobid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function parses the log file in the specified location based on</span>
<span class="sd">        the given job id and pattern</span>

<span class="sd">        Args:</span>
<span class="sd">            client  (str)   --  MA/Client Name on which log is to be parsed</span>

<span class="sd">            log_file (str)  --  Name of log file to be parsed</span>

<span class="sd">            regex   (str)   --  Pattern to be searched for in the log file</span>

<span class="sd">            jobid   (str)   --  job id of the job within the pattern to be searched</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result of string searched on all log files of a file name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span><span class="n">log_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_path</span><span class="p">)))</span>
        <span class="n">all_log_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got files in path&quot;</span><span class="p">)</span>
        <span class="n">log_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_log_files</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">log_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_files</span><span class="p">)):</span>
            <span class="c1"># get hostname to avoid machin reachable issues</span>
            <span class="n">log_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_path</span><span class="p">(</span><span class="n">log_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">client</span><span class="p">)</span>

        <span class="c1"># get log file versions</span>
        <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">matched_string</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matched_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
                    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fh</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="nb">zip</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">jobid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Searching for [</span><span class="si">{0}</span><span class="s2"> in file </span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="n">regex_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">regex_check</span><span class="p">:</span>
                            <span class="n">matched_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="n">matched_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regex_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Searching for [</span><span class="si">{0}</span><span class="s2"> job </span><span class="si">{1}</span><span class="s2"> in file </span><span class="si">{2}</span><span class="s2">]</span>
<span class="s2">                                   &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="n">jobid_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)),</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">jobid_check</span><span class="p">:</span>
                            <span class="n">regex_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">regex_check</span><span class="p">:</span>
                                <span class="n">matched_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="n">matched_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regex_check</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">{0}</span><span class="s2"> matching line(s)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not found!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DedupeHelper.change_path"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.change_path">[docs]</a>    <span class="k">def</span> <span class="nf">change_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change path to a UNC path</span>

<span class="sd">            Args:</span>
<span class="sd">                file_path (str)     --Path of file</span>

<span class="sd">                machine_name (str)  -- Name of mahine on which the file resides</span>

<span class="sd">            Returns:</span>
<span class="sd">                Network path of the file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drive</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="si">{0}</span><span class="se">\\</span><span class="si">{1}</span><span class="s2">$</span><span class="se">\\</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">machine_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">drive</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_path</span></div>

<div class="viewcode-block" id="DedupeHelper.get_primary_objects"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_primary_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get primary records</span>

<span class="sd">            Args:</span>
<span class="sd">                jobid   (str)   --Job Id for which primary records to be checked</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of primary records added according to the CSDB</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select primaryObjects from archFileCopyDedup where archfileid in</span>
<span class="s2">                (select id from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_secondary_objects"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_secondary_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get secondary objects</span>

<span class="sd">            Args:</span>
<span class="sd">                jobid (str)     --Job id for which secondary records to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of secondary records in the DDB for this particular job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select secondaryObjects from archFileCopyDedup where archfileid in</span>
<span class="s2">                 (select id from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_primary_objects_sec"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_primary_objects_sec">[docs]</a>    <span class="k">def</span> <span class="nf">get_primary_objects_sec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkup_jobid</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get primary records for secondary copy</span>

<span class="sd">            Args:</span>
<span class="sd">                bkup_jobid  (str)   --Job id of the initial backup</span>

<span class="sd">                copy_name   (str)   --Name of copy on which records are to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of primary records on given copy for given job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 select primaryObjects from archFileCopyDedup where archfileid in (select id </span>
<span class="s2">                 from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">) and archcopyid </span>
<span class="s2">                 in (select id from archgroupcopy where name =  &#39;</span><span class="si">{1}</span><span class="s2">&#39;)</span>
<span class="s2">                 &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkup_jobid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: (0)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_secondary_objects_sec"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_secondary_objects_sec">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_objects_sec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkup_jobid</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get secondary records for secondary copy</span>

<span class="sd">            Args:</span>
<span class="sd">                bkup_jobid  (str)   --Job id of the initial backup</span>

<span class="sd">                copy_name   (str)   --Name of copy on which records are to be fetched</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of secondary records on given copy for given job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select secondaryObjects from archFileCopyDedup where archfileid in (select id </span>
<span class="s2">                 from archFile where fileType =1 and jobId = </span><span class="si">{0}</span><span class="s2">) and archcopyid in (select id </span>
<span class="s2">                 from archgroupcopy where name = &#39;</span><span class="si">{1}</span><span class="s2">&#39;)</span>
<span class="s2">                 &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkup_jobid</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.get_sidb_ids"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_sidb_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_sidb_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get SIDB store and substore ids</span>

<span class="sd">        Args:</span>
<span class="sd">            sp_id   (str)   --  Storage policy id</span>

<span class="sd">            copy_name   (str) -- Storage policy copy name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Store ID associated with the storage policy</span>

<span class="sd">            SubStore ID associated with the storage policy copy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select SS.SIDBStoreId, SS.SubStoreId</span>
<span class="s2">                from IdxSIDBSubStore SS inner join archgroupcopy AGC</span>
<span class="s2">                on SS.SIDBStoreId = AGC.SIDBStoreId</span>
<span class="s2">                and AGC.archGroupId = </span><span class="si">{0}</span><span class="s2"> and AGC.name = &#39;</span><span class="si">{1}</span><span class="s2">&#39;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_id</span><span class="p">),</span> <span class="n">copy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">cur</span></div>

<div class="viewcode-block" id="DedupeHelper.get_network_transfer_bytes"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_network_transfer_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_network_transfer_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets bytes transfered for a job</span>

<span class="sd">        Args:</span>
<span class="sd">            jobid (str) -- job ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            network transferred bytes for a jobid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select nwTransBytes/1024/1024 from JMBkpStats where jobId = </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RESULT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="DedupeHelper.submit_backup_memdb_recon"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.submit_backup_memdb_recon">[docs]</a>    <span class="k">def</span> <span class="nf">submit_backup_memdb_recon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">subclient_object</span><span class="p">,</span>
                                  <span class="n">sp_name</span><span class="p">,</span>
                                  <span class="n">copy_name</span><span class="p">,</span>
                                  <span class="n">time_out</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launches full backup, kills SIDB to initiate a full DDB Recon</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_object (object)   -- subclient instance</span>

<span class="sd">            sp_name (str)               -- storage policy name</span>

<span class="sd">            copy_name (str)             -- storage policy copy name</span>

<span class="sd">            time_out (int)              -- Time out period to kill SIDB process</span>
<span class="sd">                Default : 5</span>

<span class="sd">        Returns:</span>
<span class="sd">            backup job ID</span>

<span class="sd">            reconstruction job ID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get MA log location</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&quot;SIDBEngine.log&quot;</span>
        <span class="n">bkp_job</span> <span class="o">=</span> <span class="n">subclient_object</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s2">&quot;FULL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup job for delta recon: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">bkp_job</span><span class="p">:</span>
            <span class="c1"># parse log to find string: &quot;Requested by Job-Id &quot;+str(backupJobId)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="p">(</span><span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">],</span>
                                                            <span class="n">log_file</span><span class="p">,</span>
                                                            <span class="sd">&quot;&quot;&quot;Requested by Job-Id {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">matched_string</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="p">(</span><span class="n">matched_line</span><span class="p">,</span> <span class="n">matched_string</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">],</span>
                                                                <span class="n">log_file</span><span class="p">,</span>
                                                                <span class="sd">&quot;&quot;&quot;Requested by Job-Id {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">300</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SIDB2 process did not start in time&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Going to kill SIDB2 prococess in </span><span class="si">{0}</span><span class="s2"> secs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time_out</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time_out</span><span class="p">)</span>
            <span class="n">cmd_to_kill_sidb</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;taskkill /F /IM SIDB2.exe /T /S </span><span class="si">{0}</span><span class="s2"> /U </span><span class="si">{1}</span><span class="s2"> /P </span><span class="si">{2}</span><span class="s2"></span>
<span class="s2">                               &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentHostName&quot;</span><span class="p">]),</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentUsername&quot;</span><span class="p">]),</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentPassword&quot;</span><span class="p">]))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd_to_kill_sidb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">_exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to kill SIDB2 process&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to kill SIDB2 process&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SIDB2 process killed&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to resume backup job&quot;</span><span class="p">)</span>
            <span class="n">bkp_job</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">recon_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poll_ddb_reconstruction</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to resume backup job&quot;</span><span class="p">)</span>
            <span class="n">bkp_job</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bkp_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to run FULL backup with error:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bkp_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup job completed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bkp_job</span><span class="p">,</span> <span class="n">recon_job</span></div>

<div class="viewcode-block" id="DedupeHelper.poll_ddb_reconstruction"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.poll_ddb_reconstruction">[docs]</a>    <span class="k">def</span> <span class="nf">poll_ddb_reconstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polls whether DDB reconstruction jobs started and if started waits for</span>
<span class="sd">        completion and reports the status.</span>

<span class="sd">        Args:</span>
<span class="sd">            sp_name (str)   -- storage policy name</span>
<span class="sd">            copy_name (str) -- storage policy copy name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstruction job ID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Poll DDB Recon...&quot;</span><span class="p">)</span>
        <span class="n">query1</span> <span class="o">=</span> <span class="s2">&quot;select id from archGroup where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="n">sp_id</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mmhelper</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">copyId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmhelper</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">storeId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sidb_ids</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">copy_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check if given copy is a GDSP dependent copy&quot;</span><span class="p">)</span>
        <span class="n">query4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT dedupeFlags&amp;134217728</span>
<span class="s2">                    FROM archGroupCopy </span>
<span class="s2">                    WHERE id = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copyId</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query4</span><span class="p">)</span>
        <span class="c1"># copy_id = copyId</span>
        <span class="n">dedFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dedFlag</span> <span class="o">==</span> <span class="s1">&#39;134217728&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected as a GDSP dependent copy&quot;</span><span class="p">)</span>
            <span class="n">query5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT id</span>
<span class="s2">                    FROM archGroupCopy </span>
<span class="s2">                    WHERE SIDBStoreId = </span><span class="si">{0}</span><span class="s2"> AND dedupeFlags&amp;268435456 = 268435456</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">storeId</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query5</span><span class="p">)</span>
            <span class="n">copy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copy_id</span> <span class="o">=</span> <span class="n">copyId</span>

        <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">+</span> <span class="mi">10</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select count(*) from JMAdminJobInfoTable where opType=80 and</span>
<span class="s2">                      archGrpCopyID = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;POLL: DDB reconstruction job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select jobId from JMAdminJobInfoTable where opType=80 and</span>
<span class="s2">                                  archGrpCopyID = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon Job: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">recon_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">recon_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run delta recon: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recon_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Delta recon job completed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">recon_job</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Reconstruction Job does not start in the 10 minutes wait time&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="DedupeHelper.get_reconstruction_type"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.DedupeHelper.get_reconstruction_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_reconstruction_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recon_job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns if Delta recon or Regular recon or Full recon</span>

<span class="sd">        Args:</span>
<span class="sd">            recon_job_id (int/str)    -- reconstruction job ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            Type of reconstruction job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recon_type</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Delta Reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Regular Reconstruction&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;Full Reconstruction&#39;</span><span class="p">}</span>
        <span class="n">_query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                  select flags </span>
<span class="s2">                  from IdxSIDBRecoveryHistory </span>
<span class="s2">                  where AdminJobId = </span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">recon_job_id</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="n">recon_flag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">recon_flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Delta Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Regular Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recon_flag</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recon type: Full Reconstruction&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">recon_type</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;recon job type not found&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;no results returned - getReconstructionType&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="MMHelper"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper">[docs]</a><span class="k">class</span> <span class="nc">MMHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes BasicOperations object</span>

<span class="sd">        Args:</span>
<span class="sd">            test_case_obj (object)  --  instance of the CVtestcase class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">tcinputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserver_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">test_case_obj</span><span class="o">.</span><span class="n">csdb</span>

<div class="viewcode-block" id="MMHelper.get_drive_pool_id"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper.get_drive_pool_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_drive_pool_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get drivepool id</span>

<span class="sd">        Args:</span>
<span class="sd">            tape_id   (str)   --  Tape library ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            DrivePool id of the given Tape library</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select *</span>
<span class="sd">            from MMDrivePool</span>
<span class="sd">            where MasterPoolId =</span>
<span class="sd">            (select MasterPoolId</span>
<span class="sd">            from MMMasterPool</span>
<span class="sd">            where LibraryId = {0})</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tape_id</span><span class="p">)))</span>
        <span class="n">drive_pool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">drive_pool_id</span></div>

<div class="viewcode-block" id="MMHelper.get_spare_pool_id"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper.get_spare_pool_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_spare_pool_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get sparepool id</span>

<span class="sd">        Args:</span>
<span class="sd">            tape_id   (str)   --  Tape library ID</span>

<span class="sd">        Returns:</span>
<span class="sd">                SparePool id of the given Tape library</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select *</span>
<span class="sd">            from MMSpareGroup</span>
<span class="sd">            where LibraryId = {0}</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tape_id</span><span class="p">)))</span>
        <span class="n">spare_pool_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">spare_pool_id</span></div>

<div class="viewcode-block" id="MMHelper.get_copy_id"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper.get_copy_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get copy id</span>

<span class="sd">         Args:</span>
<span class="sd">            sp_name     (str) --  Storage policy name</span>

<span class="sd">            copy_name   (str) -- Storage policy copy name</span>

<span class="sd">        Returns:</span>
<span class="sd">                Copy id for the given storage policy/copy</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;select AGC.id</span>
<span class="sd">            from archgroup AG INNER JOIN archgroupcopy AGC</span>
<span class="sd">            on AG.id = AGC.archgroupid</span>
<span class="sd">            where AG.name =&#39;{0}&#39; and AGC.name = &#39;{1}&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_name</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">))</span>
        <span class="n">copy_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">copy_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MMHelper.remove_content"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper.remove_content">[docs]</a>    <span class="k">def</span> <span class="nf">remove_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data_path</span><span class="p">,</span> <span class="n">client_machine</span><span class="p">,</span> <span class="n">num_files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes subclient data</span>

<span class="sd">        Args:</span>
<span class="sd">            test_data_path  (str)   --  path where the subclient backup content is present</span>

<span class="sd">            client_machine  (obj)   --  object for the client machine on which subclient is present</span>

<span class="sd">            num_files       (int)   --  Number of files to be deleted</span>
<span class="sd">            default : None [all files to be deleted]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of files deleted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">client_machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">test_data_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting all files&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">{0}</span><span class="s2"> files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_files</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_files</span><span class="p">):</span>
            <span class="n">client_machine</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="MMHelper.get_archive_file_size"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.MMHelper.get_archive_file_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_archive_file_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets sum of archive file size on a copy/for a job</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_id  (str)   --  storage policy copy id</span>

<span class="sd">            job_id   (str)   --  job id</span>
<span class="sd">            Default : None</span>

<span class="sd">        Returns:</span>
<span class="sd">            sum of archive file size</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(physicalSize)</span>
<span class="s2">                    from archChunkMapping</span>
<span class="s2">                    where archCopyId = </span><span class="si">{0}</span><span class="s2"> and jobid in</span>
<span class="s2">                        (select distinct jobid</span>
<span class="s2">                        from jmjobdatastats</span>
<span class="s2">                        where archgrpcopyid = </span><span class="si">{0}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">copy_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;select sum(physicalSize)</span>
<span class="s2">                                from archChunkMapping</span>
<span class="s2">                                where archCopyId = </span><span class="si">{0}</span><span class="s2"> and jobid = </span><span class="si">{1}</span><span class="s2">)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running query : </span><span class="se">\n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="CloudLibrary"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.CloudLibrary">[docs]</a><span class="k">class</span> <span class="nc">CloudLibrary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Class for representing CloudLibrary &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">libraryname</span><span class="p">,</span> <span class="n">libraryinfo</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Class for representing CloudLibrary</span>
<span class="sd">        Args:</span>
<span class="sd">                libraryname  (str)         --  name of the cloud library</span>
<span class="sd">                libraryinfo  (dictionary)   --  dictionary containing library information</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">            Raises:</span>
<span class="sd">                None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libraryname</span> <span class="o">=</span> <span class="n">libraryname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loginname</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loginName&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_accesskey</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servertype</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;serverType&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span> <span class="o">=</span> <span class="n">libraryinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mountPath&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CloudLibrary.cleanup_entities"><a class="viewcode-back" href="../../../../Automation.MediaAgents.MAUtils.html#Automation.MediaAgents.MAUtils.mahelper.CloudLibrary.cleanup_entities">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup_entities</span><span class="p">(</span><span class="n">commcell</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">entity_config</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method to cleanup commcell entities</span>

<span class="sd">        Args:</span>
<span class="sd">            entity_config (dict)   -- Dictionary containing the entity(s) as key,</span>
<span class="sd">                                        and value(s) as a list of the entities to delete.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dictonary with failed entities</span>

<span class="sd">        Raises Exception:</span>
<span class="sd">            - If failed to delete any entity</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start deleting entities configured&quot;</span><span class="p">)</span>
            <span class="n">failed_entities</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;storagepolicy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;library&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="k">if</span> <span class="s1">&#39;storagepolicy&#39;</span> <span class="ow">in</span> <span class="n">entity_config</span><span class="p">:</span>
                <span class="n">storageobj</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">StoragePolicies</span><span class="p">(</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">storagepolies</span> <span class="o">=</span> <span class="n">entity_config</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">storagepolies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">storageobj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">policy</span><span class="p">):</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Failed to delete SP </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                        <span class="n">failed_entities</span><span class="p">[</span><span class="s2">&quot;storagepolicy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully deleted SP </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">))</span>

            <span class="k">if</span> <span class="s1">&#39;library&#39;</span> <span class="ow">in</span> <span class="n">entity_config</span><span class="p">:</span>
                <span class="n">storageobj</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">DiskLibraries</span><span class="p">(</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">libraries</span> <span class="o">=</span> <span class="n">entity_config</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">library</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">storageobj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">library</span><span class="p">):</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Failed to delete library </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                        <span class="n">failed_entities</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully deleted library </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">failed_entities</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed in cleanup_enties function with error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault Systems Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>