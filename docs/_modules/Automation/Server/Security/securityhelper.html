
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Automation.Server.Security.securityhelper &#8212; Commvault Automation 11.14 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Automation.Server.Security.securityhelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main file for performing Organization related operations on Commcell</span>

<span class="sd">OrganizationHelper:</span>
<span class="sd">    __init__()                  --  Initialize instance of the OrganizationHelper class</span>

<span class="sd">    modify_auth_code()          --  Modifies the &quot;Requires authcode for installation&quot; property</span>
<span class="sd">                                        for an organization.</span>

<span class="sd">    validate_client()           --  Validates on boarded client for the organization</span>

<span class="sd">    validate_clientgroup_assoc()</span>
<span class="sd">                                --  Validates if on boarded client gets associated to</span>
<span class="sd">                                        Organization&#39;s default plan</span>

<span class="sd">    disable_msp()               --  Disable MSP on the commcell if it is not already disabled.</span>

<span class="sd">    @Property</span>
<span class="sd">        default_plan                    --  Sets/Gets default plan for an organization</span>

<span class="sd">RoleHelper:</span>
<span class="sd">    __init__()                          --  Initialize RoleHelper object</span>

<span class="sd">    create_role()                       --  Creates new role on the CommCell</span>

<span class="sd">    random_permissions()                --  Generates and returns 5 random permissions</span>

<span class="sd">    random_category()                   --  Generates and returns 3 random categories</span>

<span class="sd">    generate_permissions_categories()   --  Returns 5 random permissions and 3 random categories</span>

<span class="sd">    delete_role()                       --  Deletes the specified role on CommCell</span>

<span class="sd">    update_role_properties()            --  Update, Overwrite, deletes capabilities the passed</span>

<span class="sd">    _validate_role_permissions()        --  validates capabilities present on the role with db</span>
<span class="sd">                                            values</span>

<span class="sd">    _update_role_status()               --  Updates role status</span>

<span class="sd">    _update_role_description()          --  Updates role description</span>

<span class="sd">    _update_role_name()                 --  Updates role name</span>

<span class="sd">    _fetch_role_property()              --  Gets role property values from db</span>

<span class="sd">    @property</span>
<span class="sd">        role()                          -- Returns the role object of this CommCell role</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">cvpysdk.security.role</span> <span class="k">import</span> <span class="n">Roles</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.idautils</span> <span class="k">import</span> <span class="n">CommonUtils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="k">import</span> <span class="n">OptionsSelector</span>
<span class="kn">from</span> <span class="nn">Server.Security</span> <span class="k">import</span> <span class="n">securityconstants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">options_selector</span>

<div class="viewcode-block" id="OrganizationHelper"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper">[docs]</a><span class="k">class</span> <span class="nc">OrganizationHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper class to provide Organization related operations on Commcell&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">company</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; initialize instance of the OrganizationHelper class</span>

<span class="sd">        Args:</span>
<span class="sd">            commcell (obj)    -- Commcell object</span>

<span class="sd">            company  (str)    -- Organization name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span> <span class="o">=</span> <span class="n">company</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_company</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">company</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">organizations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span> <span class="o">=</span> <span class="n">company</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tenant_client_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span> <span class="o">+</span> <span class="s1">&#39; clients&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_auth_map</span> <span class="o">=</span> <span class="n">securityconstants</span><span class="o">.</span><span class="n">AUTH_MAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>

<div class="viewcode-block" id="OrganizationHelper.modify_auth_code"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.modify_auth_code">[docs]</a>    <span class="k">def</span> <span class="nf">modify_auth_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hardcheck</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modifies the &quot;Requires authcode for installation&quot; property for an organization.</span>

<span class="sd">            Args:</span>

<span class="sd">                operation    (str)    -- enable/disable auth code for the organization.</span>
<span class="sd">                                            Supported : enable/disable</span>

<span class="sd">                hardcheck     (bool)   -- True/False based on whether the to throw exception in</span>
<span class="sd">                                            case of any error or to return falsy value.</span>

<span class="sd">            Returns:</span>
<span class="sd">                AuthCode    (str)      -- Modified auth code for the organization.</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>

<span class="sd">                    - if Unsupported operation type passed to modify_auth_code</span>

<span class="sd">                    - if failed to enable/disable auth code</span>

<span class="sd">                    - if failed during any step while enabling/disabling the auth code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">company_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_map</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported operation type passed to modify_auth_code&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> auth code for company: [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_map</span><span class="p">[</span><span class="n">operation</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">],</span> <span class="n">company_name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Company&#39;s [</span><span class="si">{0}</span><span class="s2">] current authcode:[</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">auth_code</span><span class="p">))</span>

            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_map</span><span class="p">[</span><span class="n">operation</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">])()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully [</span><span class="si">{0}</span><span class="s2">] auth code for company:  [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth_map</span><span class="p">[</span><span class="n">operation</span><span class="p">][</span><span class="s1">&#39;post_message&#39;</span><span class="p">],</span> <span class="n">company_name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Company&#39;s [</span><span class="si">{0}</span><span class="s2">] current authcode:[</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">auth_code</span><span class="p">))</span>

            <span class="n">auth_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">auth_code</span>

            <span class="c1"># Validation</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;enable&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">auth_code</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s2">&quot;Failed to enable auth code&quot;</span>
            <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;disable&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">auth_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Failed to disable auth code&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auth code validation succeeded.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">auth_code</span>

        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">aserror</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hardcheck</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">aserror</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="OrganizationHelper.validate_client"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.validate_client">[docs]</a>    <span class="k">def</span> <span class="nf">validate_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clients_joined</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chatter_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">client_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates on boarded client for the organization</span>

<span class="sd">            Args:</span>

<span class="sd">                clients_joined    (int)    -- Number of new clients on boarded the organization</span>

<span class="sd">                clients    (str/list)      -- Single client OR List of clients to check in</span>
<span class="sd">                                                defaults plan&#39;s client group.</span>

<span class="sd">                chatter_flag (int)         -- Expected value for nChatter registry flag. (0/1)</span>

<span class="sd">                fail              (bool)   -- If true, will throw exception in case of failed</span>
<span class="sd">                                                client validation.</span>
<span class="sd">                                              If false, will return False if validation fails</span>

<span class="sd">                client_groups (list)       -- List of user specified client groups to validate.</span>
<span class="sd">                                                Default is None</span>
<span class="sd">                                                In case of None validate_clientgroup_assoc() will assume defaults</span>

<span class="sd">            Returns:</span>
<span class="sd">                (bool)                     -- Based on validation failed/pass</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    - if validation failed</span>
<span class="sd">                    - if module failed to execute due to some error</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">clients</span> <span class="o">=</span> <span class="p">[</span><span class="n">clients</span><span class="p">]</span>

            <span class="c1"># Validate number of clients joined in the organization have increased by the</span>
            <span class="c1"># exact account, if the number of clients joined is provided.</span>
            <span class="k">if</span> <span class="n">clients_joined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client count [</span><span class="si">{0}</span><span class="s2">] for company [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">machine_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>

                <span class="n">no_of_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">machine_count</span> <span class="o">+</span> <span class="n">clients_joined</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client count [</span><span class="si">{0}</span><span class="s2">] for company [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">machine_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">no_of_devices</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">machine_count</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Mismatched client count for company [</span><span class="si">{0}</span><span class="s2">]&quot;</span>
                                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client count validation succeeded.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">clients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Check if clients are ready.</span>
                <span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span><span class="o">.</span><span class="n">check_client_readiness</span><span class="p">(</span><span class="n">clients</span><span class="p">)</span>

                <span class="c1"># Check if the clients got associated to Plan and Organization client groups</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_clientgroup_assoc</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">client_groups</span><span class="o">=</span><span class="n">client_groups</span><span class="p">)</span>

                <span class="c1"># Validate nChatter flag registry key value</span>
                <span class="k">if</span> <span class="n">chatter_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">validate_chatter_flag</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">chatter_flag</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">aserror</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Client validation failed </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">aserror</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="OrganizationHelper.validate_clientgroup_assoc"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.validate_clientgroup_assoc">[docs]</a>    <span class="k">def</span> <span class="nf">validate_clientgroup_assoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">retry_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">client_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates if on boarded client gets associated to Organization&#39;s default plan</span>

<span class="sd">            Args:</span>
<span class="sd">                clients    (str/list)      -- Single client OR List of clients to check in</span>
<span class="sd">                                                defaults plan&#39;s/organization&#39;s client group.</span>

<span class="sd">                fail       (bool)          -- If true, will throw exception in case of failed</span>
<span class="sd">                                                client validation.</span>
<span class="sd">                                              If false, will return False if validation fails</span>

<span class="sd">                retry_interval    (int)    -- Interval (in seconds) after which job state</span>
<span class="sd">                                                    will be checked in a loop. Default = 10</span>

<span class="sd">                time_limit        (int)    -- Time limit after which job status check shall be</span>
<span class="sd">                                                aborted if the job does not reach the desired</span>
<span class="sd">                                                 state. Default (in minutes) = 30</span>

<span class="sd">                client_groups (list)       -- List of client groups to validate</span>

<span class="sd">            Returns:</span>
<span class="sd">                (bool)                     -- Based on validation failed/pass</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    - if validation failed</span>
<span class="sd">                    - if module failed to execute due to some error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">clients</span> <span class="o">=</span> <span class="p">[</span><span class="n">clients</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">client_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_groups</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tenant_client_group</span><span class="p">]</span>

            <span class="n">time_limit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">+</span><span class="n">time_limit</span><span class="o">*</span><span class="mi">60</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Validate clients are part of tenant&#39;s / company&#39;s default plan client group</span>
                <span class="k">for</span> <span class="n">_source</span> <span class="ow">in</span> <span class="n">client_groups</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">clients</span><span class="p">,</span> <span class="n">_source</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating if client(s) [</span><span class="si">{0}</span><span class="s2">] are part of client group [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                                  <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">_source</span><span class="p">))</span>

                    <span class="n">cg_clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">client_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_source</span><span class="p">)</span><span class="o">.</span><span class="n">associated_clients</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">client</span> <span class="ow">in</span> <span class="n">cg_clients</span> <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">clients</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Associated clients for client group [</span><span class="si">{0}</span><span class="s2">]: [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span> <span class="n">cg_clients</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">time_limit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timed out after [</span><span class="si">{0}</span><span class="s2">min] waiting for client association&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_limit</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for [</span><span class="si">{0}</span><span class="s2">] seconds &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retry_interval</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Client(s) [</span><span class="si">{0}</span><span class="s2">] did not get associated to client group [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client(s) [</span><span class="si">{0}</span><span class="s2">] associated successfully to client group [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">aserror</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fail</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">aserror</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="OrganizationHelper.validate_chatter_flag"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.validate_chatter_flag">[docs]</a>    <span class="k">def</span> <span class="nf">validate_chatter_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> <span class="n">chatter_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validate nChatter flag reg key value is as expected &quot;&quot;&quot;</span>
        <span class="n">reg_key</span> <span class="o">=</span> <span class="s1">&#39;Session&#39;</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;nChatterFlag&#39;</span>

        <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="n">clients</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span><span class="o">.</span><span class="n">check_reg_key</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg_key</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">chatter_flag</span><span class="p">)</span></div>

<div class="viewcode-block" id="OrganizationHelper.disable_msp"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.disable_msp">[docs]</a>    <span class="k">def</span> <span class="nf">disable_msp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disable MSP on the commcell if it is not already disabled.</span>

<span class="sd">            Args:</span>
<span class="sd">                None</span>

<span class="sd">            Returns:</span>
<span class="sd">                True    (bool)    - If the MSP is disabled on commcell</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    - if Failed to disable MSP on commcell</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Check if the MSP is already disabled on commcell (GxGlobalParam where name=&#39;IsMSPCommcell&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting current value for IsMSPCommcell from GXGlobalParam&#39;</span><span class="p">)</span>

            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select value from GXGlobalParam where name=&#39;IsMSPCommcell&#39;&quot;</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">_cur</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span><span class="o">.</span><span class="n">exec_commserv_query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MSP is already disabled on commcell&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># If it is enabled, disable it and restart tomcat service</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MSP is currently enabled on commcell. Disabling it now at commcell level&#39;</span><span class="p">)</span>
            <span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span><span class="o">.</span><span class="n">modify_additional_settings</span><span class="p">(</span><span class="s1">&#39;IsMSPCommcell&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restarting Tomcat service for the setting to take effect.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">commserv_client</span><span class="o">.</span><span class="n">restart_service</span><span class="p">(</span><span class="s2">&quot;GxTomcatInstance001&quot;</span><span class="p">)</span>

            <span class="n">value</span><span class="p">,</span> <span class="n">_cur</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span><span class="o">.</span><span class="n">exec_commserv_query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to disable MSP on commcell&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Succesfully disabled MSP on commcell.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="OrganizationHelper.commcell_default_plan"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.OrganizationHelper.commcell_default_plan">[docs]</a>    <span class="k">def</span> <span class="nf">commcell_default_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            plan_name (str)    - Plan name</span>

<span class="sd">            Sets default plan at Commcell level</span>
<span class="sd">            This is independent of the Organization as this sets the default plan with organization id as 0</span>
<span class="sd">            AC-&gt;Administration-&gt;Commcell</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting default plan [</span><span class="si">%s</span><span class="s2">] for Commcell, with organization id = 0&quot;</span><span class="p">,</span> <span class="n">plan_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">set_default_plan</span><span class="p">(</span><span class="n">plan_name</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Default Plans associated to this Organization.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span>

    <span class="nd">@default_plan</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the default plan associated with the Organization.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting default plan [</span><span class="si">{0}</span><span class="s2">] for Company [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Company&#39;s [</span><span class="si">{0}</span><span class="s2">] current default plan:[</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span> <span class="o">=</span> <span class="n">value</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully set default plan [</span><span class="si">{0}</span><span class="s2">] for Company [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Company&#39;s [</span><span class="si">{0}</span><span class="s2">] current default plan:[</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span><span class="p">))</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span><span class="o">.</span><span class="n">default_plan</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;Failed to set company&#39;s default plan.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully validated and updated default plan [</span><span class="si">{0}</span><span class="s2">] for company [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">company</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the company name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_company</span>

    <span class="nd">@company</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">company</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates company object based on given company name: (value)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">organizations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_company_name</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Failed to get company object </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="RoleHelper"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper">[docs]</a><span class="k">class</span> <span class="nc">RoleHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform Roles REST API operations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes RoleHelper object</span>

<span class="sd">            Args:</span>
<span class="sd">                commcell    (obj)   -- Commcell object</span>

<span class="sd">                role        (str)   -- Role name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell_obj</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roles_obj</span> <span class="o">=</span> <span class="n">Roles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">CommServDatabase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_utility</span> <span class="o">=</span> <span class="n">options_selector</span><span class="o">.</span><span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell_obj</span><span class="p">)</span>

<div class="viewcode-block" id="RoleHelper.create_role"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.create_role">[docs]</a>    <span class="k">def</span> <span class="nf">create_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_name</span><span class="p">,</span> <span class="n">permission_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">category_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">random_permission</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;creates new role</span>

<span class="sd">             Args:</span>
<span class="sd">                 role_name          (str)   --  Name of the role to be created</span>

<span class="sd">                 category_list      (list)  --  role will be created with all the permissions</span>
<span class="sd">                                                associated with this category</span>

<span class="sd">                    e.g.: category Name=Client :role will have all permisisons from</span>
<span class="sd">                                        this category.</span>
<span class="sd">                    e.g.: category Name=Client Group :role will have all permissions</span>
<span class="sd">                                        from this category</span>
<span class="sd">                    e.g.: category Name=commcell :role will have all permissions from</span>
<span class="sd">                                        this category</span>

<span class="sd">                 permission_list (list)     --  permission array which is to be updated</span>
<span class="sd">                     e.g.: permisison_list=[&quot;View&quot;, &quot;Agent Management&quot;, &quot;Browse&quot;]</span>

<span class="sd">                 random_permission   (bool) --  generates random permissions and categories if value</span>
<span class="sd">                                                is set to True</span>
<span class="sd">             Returns:</span>
<span class="sd">                 Role Object</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating role </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">role_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random_permission</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User preferred to generate random capabilities &quot;</span><span class="p">)</span>
            <span class="n">permission_list</span><span class="p">,</span> <span class="n">category_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_permissions_categories</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating role with randomly generated permission list and categoryName list&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles_obj</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rolename</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">permission_list</span><span class="o">=</span><span class="n">permission_list</span><span class="p">,</span>
                                        <span class="n">categoryname_list</span><span class="o">=</span><span class="n">category_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_role_permissions</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="s1">&#39;Update&#39;</span><span class="p">,</span> <span class="n">permission_list</span><span class="o">=</span><span class="n">permission_list</span><span class="p">,</span>
                                        <span class="n">category_list</span><span class="o">=</span><span class="n">category_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;created role successfully </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RoleHelper.random_permissions"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.random_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">random_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates 5 Random Permissions</span>

<span class="sd">             Returns:</span>
<span class="sd">                 list of 5 randomly selected permissions from DB</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating random permissions&quot;</span><span class="p">)</span>
        <span class="n">permission_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select permissionName from UMPermissions where categoryId in &quot;</span>
                  <span class="s2">&quot;(select id from UMCategories where flags=0 and hierarchyLevel=2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
        <span class="n">permission_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="c1"># fetching total count of permissions from UMPermissions</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">permission_names</span><span class="p">)</span>
        <span class="c1">#generating random numbers to pick up 5 permissions from the permission list</span>
        <span class="n">permission_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">permission_id</span> <span class="ow">in</span> <span class="n">permission_ids</span><span class="p">:</span>
            <span class="n">permission_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">permission_names</span><span class="p">[</span><span class="n">permission_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated Random List of permissions :</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">permission_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">permission_list</span></div>

<div class="viewcode-block" id="RoleHelper.random_category"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.random_category">[docs]</a>    <span class="k">def</span> <span class="nf">random_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="c1">#change the name of the function</span>
        <span class="sd">&quot;&quot;&quot;Generates 3 Random Category</span>

<span class="sd">             Returns:</span>
<span class="sd">                 list of 3 randomly selected categories from DB</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating random Category Names&quot;</span><span class="p">)</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># storing all categories in the lists</span>
        <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select categoryName from UMCategories where flags = 0 and hierarchyLevel =2&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
        <span class="n">categorynames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="c1"># fetching total count of category names from UMCatagories</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">categorynames</span><span class="p">)</span>
        <span class="c1"># generating random numbers to pick up 3 category names from the category list</span>
        <span class="n">category_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">category_id</span> <span class="ow">in</span> <span class="n">category_ids</span><span class="p">:</span>
            <span class="n">category_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">categorynames</span><span class="p">[</span><span class="n">category_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated Random List of Category Names :</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">category_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">category_list</span></div>

<div class="viewcode-block" id="RoleHelper.generate_permissions_categories"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.generate_permissions_categories">[docs]</a>    <span class="k">def</span> <span class="nf">generate_permissions_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates 5 Random permissions and 3 Random Category</span>

<span class="sd">             Returns:</span>
<span class="sd">                 list of 5 randomly selected permissions from DB</span>
<span class="sd">                 list of 3 randomly selected categories from DB</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_permissions</span><span class="p">()</span>
        <span class="n">_categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_category</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_permissions</span><span class="p">,</span> <span class="n">_categories</span></div>

<div class="viewcode-block" id="RoleHelper.delete_role"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.delete_role">[docs]</a>    <span class="k">def</span> <span class="nf">delete_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the role passed</span>
<span class="sd">        Args:</span>
<span class="sd">            role_name        (str)  -- object of role to be deleted</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if role deletion is unsuccessful</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;performing Delete Operation on role: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">role_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles_obj</span><span class="o">.</span><span class="n">has_role</span><span class="p">(</span><span class="n">role_name</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roles_obj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">role_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role deletion is Successsful&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Specified role is not present on the CommCell </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Role(</span><span class="si">%s</span><span class="s2">) Deletion unsuccessful&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">role_name</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the role object of this commcell role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span>

    <span class="nd">@role</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;initialize role object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span> <span class="o">=</span> <span class="n">role_object</span>

<div class="viewcode-block" id="RoleHelper.update_role_properties"><a class="viewcode-back" href="../../../../Automation.Server.Security.html#Automation.Server.Security.securityhelper.RoleHelper.update_role_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_role_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modification_request</span><span class="p">,</span> <span class="n">random_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">permissions_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">category_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update, Overwrite, deletes capabilities of the passed role</span>
<span class="sd">        Args:</span>
<span class="sd">            modification_request    (str)   --  Update, Overwrite, Delete operation for roles</span>

<span class="sd">            random_flag             (bool)  --  no permission list or category is required when</span>
<span class="sd">                                                this flag is set to True</span>

<span class="sd">            permission_list         (list)  --  new set of permissions assigned to role</span>

<span class="sd">            category_list           (list)  --  new set of category permissions assigned on role</span>

<span class="sd">            kwargs:</span>

<span class="sd">                name                (str)   --  New name to assigned to role</span>

<span class="sd">                description         (str)   --  New description to be assigned to role</span>

<span class="sd">                status              (bool)  --  Status flag for role</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_update_role_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">random_flag</span><span class="p">:</span> <span class="c1">#club both and add new function and call it here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User preferred to generate random capabilities&quot;</span><span class="p">)</span>
            <span class="n">permissions_list</span><span class="p">,</span> <span class="n">category_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_permissions_categories</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;updating role with randomly generated permissions and categories&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">permissions_list</span> <span class="ow">or</span> <span class="n">category_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">modify_capability</span><span class="p">(</span>
                <span class="n">request_type</span><span class="o">=</span><span class="n">modification_request</span><span class="p">,</span> <span class="n">permission_list</span><span class="o">=</span><span class="n">permissions_list</span><span class="p">,</span>
                <span class="n">categoryname_list</span><span class="o">=</span><span class="n">category_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_role_permissions</span><span class="p">(</span><span class="n">request_type</span><span class="o">=</span><span class="n">modification_request</span><span class="p">,</span>
                                            <span class="n">permission_list</span><span class="o">=</span><span class="n">permissions_list</span><span class="p">,</span>
                                            <span class="n">category_list</span><span class="o">=</span><span class="n">category_list</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate_role_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">permission_list</span><span class="p">,</span> <span class="n">category_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;validates capabilities present on the role with db values</span>
<span class="sd">        Args:</span>
<span class="sd">            request_type        (str)   --  Update, Overwrite, Delete operation for roles</span>

<span class="sd">            permission_list     (list)  --  set of permissions needed to be verified</span>

<span class="sd">            category_list       (list)  --  set of category permissions needed to be validated</span>

<span class="sd">            returns:</span>
<span class="sd">                True    :   if role capability validation is successful</span>
<span class="sd">            raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if Capability validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validating permissions and categories&#39;</span><span class="p">)</span>
        <span class="n">list_of_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">_role_permissions</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="n">list_of_permissions</span><span class="p">[</span><span class="s1">&#39;permission_list&#39;</span><span class="p">]</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="n">list_of_permissions</span><span class="p">[</span><span class="s1">&#39;category_list&#39;</span><span class="p">]</span>
        <span class="n">permission_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;permission validation started&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">permission_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">permission_arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">permission_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">permissions</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">permission_arr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: these permissions could be part of categories&quot;</span> <span class="o">%</span><span class="n">permission_arr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating the category list for such permissions to &quot;</span>
                          <span class="s2">&quot;validate whether category is present on the role&quot;</span><span class="p">)</span>
            <span class="n">permission_set</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">permission_arr</span><span class="p">)</span>
            <span class="n">permission_set</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">permission_set</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">permission_set</span> <span class="o">=</span> <span class="n">permission_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span>
            <span class="n">permission_set</span> <span class="o">=</span> <span class="n">permission_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
            <span class="n">query_1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select categoryName from UMCategories where id in &quot;</span>
                       <span class="s2">&quot;(select categoryId from UMPermissions where permissionName in </span><span class="si">%s</span><span class="s2">)&quot;</span>
                       <span class="o">%</span><span class="n">permission_set</span><span class="p">)</span>
            <span class="n">cat</span><span class="p">,</span> <span class="n">cat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_utility</span><span class="o">.</span><span class="n">exec_commserv_query</span><span class="p">(</span><span class="n">query_1</span><span class="p">)</span>
            <span class="n">category_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">categories</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;new set of categories for validation: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span><span class="n">category_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;categories list present on the role: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">categories</span><span class="p">)</span>
        <span class="n">diff_categories</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">categories</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">diff_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request_type</span> <span class="o">!=</span> <span class="s1">&#39;Delete&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;These categories are missing on role: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">diff_categories</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not all categories present on the role&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;sucessfully deleted role permissions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Capability Validation is successful on the role&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_update_role_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;updates the role status</span>
<span class="sd">        Args:</span>
<span class="sd">            status        (str)  -- True -Enable role, False -Disable role</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if role status update fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role_status</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span><span class="kc">True</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up role status&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_role_property</span><span class="p">(</span><span class="n">dbvalue</span><span class="o">=</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;UMRoles&#39;</span><span class="p">,</span>
                                         <span class="n">search_value</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">comp_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">role_status</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">stat</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;failed to modify role status&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully modified the role status&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_role_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;updates the role description</span>
<span class="sd">        Args:</span>
<span class="sd">            description        (str)  -- Description of the role</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if role description update fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up description for role&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_role_property</span><span class="p">(</span><span class="n">dbvalue</span><span class="o">=</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;UMRoles&#39;</span><span class="p">,</span>
                                         <span class="n">search_value</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">comp_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_name</span><span class="p">)</span>
        <span class="n">description1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role description from json: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role description from db: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">description1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">description</span> <span class="o">!=</span> <span class="n">description1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;failed to modify role description&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;description for role is successfully updated&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_role_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;updates the role name</span>
<span class="sd">        Args:</span>
<span class="sd">            new_name        (str)  -- Name of the role</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if role name update fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;updating role with new name:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">new_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_name</span> <span class="o">=</span> <span class="n">new_name</span>
        <span class="n">name1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_role_property</span><span class="p">(</span><span class="n">dbvalue</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;UMroles&#39;</span><span class="p">,</span>
                                          <span class="n">search_value</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">comp_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role name from json: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role name from db: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">name1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role</span><span class="o">.</span><span class="n">role_name</span> <span class="o">!=</span> <span class="n">name1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;failed to modify role name&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;role name modification is successful&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_role_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbvalue</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">search_value</span><span class="p">,</span> <span class="n">comp_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets role proerties from db for validation</span>
<span class="sd">        Args:</span>
<span class="sd">            dbvalue         (str)   --  expected column value from db</span>

<span class="sd">            table_name      (str)   --  name of the table to query data</span>

<span class="sd">            search_value    (str)   --  column condition value</span>

<span class="sd">            comp_value      (str)   --  comparison value</span>

<span class="sd">            returns:</span>
<span class="sd">                DB result set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_1</span> <span class="o">=</span> <span class="s2">&quot;select </span><span class="si">{0}</span><span class="s2"> from </span><span class="si">{1}</span><span class="s2"> where </span><span class="si">{2}</span><span class="s2">=&#39;</span><span class="si">{3}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbvalue</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span>
                                                               <span class="n">search_value</span><span class="p">,</span> <span class="n">comp_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result1</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault Systems Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>