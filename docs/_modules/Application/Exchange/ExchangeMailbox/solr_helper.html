

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application.Exchange.ExchangeMailbox.solr_helper &mdash; Commvault Automation 11.20 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>Application.Exchange.ExchangeMailbox.solr_helper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Application.Exchange.ExchangeMailbox.solr_helper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;&quot;Main file for Solr related operations</span>

<span class="sd">Solr:</span>
<span class="sd">    exch_obj()                              -- Return exchange mailbox object</span>

<span class="sd">    keyword_for_client_id()                 -- Return keyword for client id</span>

<span class="sd">    keyword_for_client_id                   -- Set the keyword ofr client id</span>

<span class="sd">    index_details()                         -- Return list of details of index servers</span>

<span class="sd">    base_url()                              -- Return base url for solr queries</span>

<span class="sd">    base_url                                -- Set the base url for Solr queries</span>

<span class="sd">    client_id()                             -- Returns the client id</span>

<span class="sd">    check_cvods_running()                   -- Check if CVODS is running on the index server</span>

<span class="sd">    get_number_of_items_inbackup_job()      -- Get number of items in the provided job</span>

<span class="sd">    create_solr_query()                     -- Create solr search query based on inputs provided</span>

<span class="sd">    _is_job_played()                        -- Check if job has started playing</span>

<span class="sd">    _check_all_items_played_successfully()  -- Check if playback was successfully completed</span>

<span class="sd">    _is_content_indexed()                   -- Check if items for a client are content indexed</span>

<span class="sd">    get_result_of_custom_query()            -- Get the result of any query based on custom filters</span>

<span class="sd">    parse_json()                            -- Parse json output of a solr query</span>

<span class="sd">    get_count_from_json()                   -- Get the value of numFound in json response of solr</span>

<span class="sd">    get_all_field_names()                   -- Get all field names in solr</span>

<span class="sd">    create_url_and_get_response()           -- Get response of url</span>

<span class="sd">    _validate_retention()                   -- Helper method to validate retention</span>

<span class="sd">    call_retention_process()                -- Runs the CvExAutomatedtask Process on the proxy</span>

<span class="sd">    is_solr_standalone()                    -- check if instance of solr is standalone</span>

<span class="sd">SolrStandAlone:</span>
<span class="sd">    get_user_results_count()                -- Get count of all items in all usermbx cores</span>

<span class="sd">    get_journal_results_count()             -- Get count of all items in journal core</span>

<span class="sd">    set_standalone_base_url()               -- Set the base url for standalone solr queries</span>

<span class="sd">    is_job_played()                         -- Check if job has started playing</span>

<span class="sd">    check_all_items_played_successfully()   -- Check if playback was successfully completed</span>

<span class="sd">    is_content_indexed()                   -- Check if items for a client are content indexed</span>

<span class="sd">    get_items_for_users()                   -- Method to get documents for user guids</span>

<span class="sd">    validate_retention()                    -- Method to validate retention</span>

<span class="sd">SolrCloud:</span>
<span class="sd">    get_user_results_count()                -- Get count of all items in all backup set guid</span>

<span class="sd">    set_cloud_base_url()                    -- Set the base url for cloud solr queries</span>

<span class="sd">    is_job_played()                         -- Check if job has started playing</span>

<span class="sd">    check_all_items_played_successfully()   -- Check if playback was successfully completed</span>

<span class="sd">    is_content_indexed()                    -- Check if items for a client are content indexed</span>

<span class="sd">    get_items_for_users()                   -- Method to get documents for user guids</span>

<span class="sd">    validate_retention()                    -- Method to validate retention</span>


<span class="sd">    Example of solr queries:</span>
<span class="sd">    To get all mailbox name where owner name is John Doe</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=cvownerdisp:&quot;John Doe&quot;</span>
<span class="sd">    or</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=cvownerdisp:&quot;John Doe*&quot; * works as LIKE in SQL</span>

<span class="sd">    To get only subject and ccsmtp fields where sender is &quot;john@testexch.commvault.com&quot; and tosmtp</span>
<span class="sd">    is &quot;ritesh@testexch.commvault.com&quot;</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=fmsmtp:&quot;john@testexch.commvault.com&quot; AND</span>
<span class="sd">    tosmtp:&quot;ritesh@testexch.commvault.com&quot;&amp;fl=conv,ccsmtp</span>

<span class="sd">    To get all jobs where job id is greater than 10000</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=jid:[10000 TO *]</span>

<span class="sd">    To get all items where sender is not john</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=-fmsmtp:&quot;john@testexch.commvault.com&quot;</span>

<span class="sd">    To get all items where subject is not empty</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=conv:[* TO *]</span>

<span class="sd">    To get number of records where subject is empty</span>
<span class="sd">    http://localhost:2000/solr/usermbx0/select?q=-conv:[* TO *]&amp;rows=0</span>

<span class="sd">    Example of methods:</span>
<span class="sd">    Create a solr_helper class object:</span>
<span class="sd">    solr = solr_helper(exchange_object)</span>
<span class="sd">    #Name of index server, client details are picked up from this.</span>

<span class="sd">    To check if a job has started playing:</span>
<span class="sd">    s.is_job_played(job_id)</span>

<span class="sd">    To check if playback of job was successful - This method will also return all the results</span>
<span class="sd">    based on attributes:</span>
<span class="sd">    s.check_all_items_played_successfully(job id, [&#39;tosmtp&#39;,&#39;fmsmtp&#39;,&#39;contentid&#39;])</span>
<span class="sd">    This would tell if playback was successful, and if it was, return the tosmtp, fmsmtp and</span>
<span class="sd">    contentid of each item.</span>

<span class="sd">    To get the top 100 rows with fields &#39;tosmtp&#39;, &#39;fmsmtp&#39;, &#39;contentid&#39; where sender was</span>
<span class="sd">    john@testexch.commvault.com</span>
<span class="sd">    s.get_result_of_custom_query({&#39;fmsmtp&#39;:&#39;john@testexch.commvault.com&#39;}, [&#39;tosmtp&#39;,&#39;fmsmtp&#39;,</span>
<span class="sd">    &#39;contentid&#39;], {&#39;start&#39;:0,&#39;rows&#39;:100})</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="n">SOLR_TYPE_DICT</span>


<div class="viewcode-block" id="SolrHelper"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper">[docs]</a><span class="k">class</span> <span class="nc">SolrHelper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to execute solr related operations &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ex_object</span><span class="p">,</span><span class="n">searchURL</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decides which instance object needs to be created</span>
<span class="sd">            Args:</span>
<span class="sd">                ex_object(obj)      -- Exchange Mailbox Object</span>
<span class="sd">                searchURL(str)      -- Search URL with collection names already added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ex_object</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting Index Server details to determine type of Solr&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT DISTINCT &#39;http://&#39;+ CL.net_hostname + &#39;:&#39; + CAST (S.Portno &quot;</span>
                     <span class="s2">&quot;AS nvarchar(20)) as url, C.cloudType, S.ClientId, CL.name, cl2.name, &quot;</span>
                     <span class="s2">&quot;C.cloudId, CL.net_hostname, S.portNo, C.pseudoClientId, C.name FROM DM2Cloud&quot;</span>
                     <span class="s2">&quot; C (NOLOCK) JOIN DM2SearchServerCoreInfo S (NOLOCK) ON S.CloudId = C.cloudId&quot;</span>
                     <span class="s2">&quot; JOIN APP_Client CL (NOLOCK) ON S.ClientId = CL.id JOIN APP_Client CL2 &quot;</span>
                     <span class="s2">&quot;(NOLOCK) ON C.pseudoClientId = CL2.id WHERE S.CloudType IN (1,4,5) AND &quot;</span>
                     <span class="s2">&quot;CL2.name = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">ex_object</span><span class="o">.</span><span class="n">index_server</span><span class="p">)</span>
            <span class="n">ex_object</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">ex_object</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
            <span class="n">ind_details</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">solr_instance</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No records found for the index server: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                    <span class="o">%</span> <span class="n">ex_object</span><span class="o">.</span><span class="n">index_server</span><span class="p">)</span>
                <span class="n">ind_detail</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;server_url&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;server_type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                              <span class="s1">&#39;index_client_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="s1">&#39;index_client_name&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                              <span class="s1">&#39;engine_name&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;cloud_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                              <span class="s1">&#39;host_name&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="s1">&#39;pseudo_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
                              <span class="s1">&#39;pseudo_name&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                              <span class="s1">&#39;backupset_id&#39;</span><span class="p">:</span> <span class="n">ex_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">backupset_id</span><span class="p">,</span>
                              <span class="s1">&#39;backupset_guid&#39;</span><span class="p">:</span> <span class="n">ex_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">guid</span><span class="p">}</span>
                <span class="n">ind_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind_detail</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ex_object</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Type is SolrStandAlone. &quot;</span>
                                             <span class="s2">&quot;Creating SolrStandalone instance&quot;</span><span class="p">)</span>
                <span class="n">solr_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SolrHelper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">SolrStandAlone</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">ex_object</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Type is SolrCloud. &quot;</span>
                                             <span class="s2">&quot;Creating SolrCloud instance&quot;</span><span class="p">)</span>
                <span class="n">solr_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SolrHelper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">SolrCloud</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">solr_instance</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Index Server type couldn&#39;t be determined&quot;</span><span class="p">)</span>
            <span class="n">solr_instance</span><span class="o">.</span><span class="n">_index_details</span> <span class="o">=</span> <span class="n">ind_details</span>
            <span class="k">return</span> <span class="n">solr_instance</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception while creating Solr Object. Reason: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_obj</span><span class="p">,</span><span class="n">searchURL</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the Solr object</span>
<span class="sd">            Args:</span>
<span class="sd">                exchange_obj(object)      -- instance of the exchange object</span>
<span class="sd">                searchURL(str)            -- Search URL with collection names already added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exch_obj</span> <span class="o">=</span> <span class="n">exchange_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exch_obj</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">searchURL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_for_client_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_attrib_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exch_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return exchange mailbox object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exch_obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keyword_for_client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return keyword for client id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_for_client_id</span>

    <span class="nd">@keyword_for_client_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keyword_for_client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword_for_client_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyword_for_client_id</span> <span class="o">=</span> <span class="n">keyword_for_client_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of details of index servers&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_details</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return base url for solr queries&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span>

    <span class="nd">@base_url</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the base url for standalone or cloud&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns id of client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exch_obj</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>

<div class="viewcode-block" id="SolrHelper.check_cvods_running"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.check_cvods_running">[docs]</a>    <span class="k">def</span> <span class="nf">check_cvods_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if CVODS is running on the index server</span>
<span class="sd">            Returns:</span>
<span class="sd">                True if CVODS is running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if CVODS is launched&quot;</span><span class="p">)</span>
            <span class="n">machine_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">machine_name</span> <span class="o">=</span> <span class="n">machine_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">commcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">commcell</span>
            <span class="n">remote_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">remote_machine</span><span class="o">.</span><span class="n">is_process_running</span><span class="p">(</span><span class="s2">&quot;CVODS&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CVODS is running&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CVODS is not launched. Will check again after 1 min&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while checking cvods status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.get_number_of_items_inbackup_job"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.get_number_of_items_inbackup_job">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_items_inbackup_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set the solr search query</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id for which number of items is required</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of items in the provided job id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting number of items in job </span><span class="si">%s</span><span class="s2"> from database&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="n">query_string</span> <span class="o">=</span> <span class="s2">&quot;select totalNumOfFiles from JMBkpStats Where jobId=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">job_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of items in job </span><span class="si">%s</span><span class="s2"> is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error in getting job details from database. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.create_solr_query"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.create_solr_query">[docs]</a>    <span class="k">def</span> <span class="nf">create_solr_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to create the solr query based on the params</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dictionary)     --  Dictionary containing search criteria and value</span>
<span class="sd">                                                Acts as &#39;q&#39; field in solr query</span>

<span class="sd">                attr_list(set)            --  Column names to be returned in results.</span>
<span class="sd">                                                Acts as &#39;fl&#39; in solr query</span>

<span class="sd">                op_params(dictionary)       --  Other params and values for solr query</span>
<span class="sd">                                                (Ex: start, rows)</span>

<span class="sd">            Returns:</span>
<span class="sd">                The solr url based on params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating solr URL&quot;</span><span class="p">)</span>
            <span class="n">search_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;q=&#39;</span>
            <span class="n">simple_search</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">select_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">for</span> <span class="n">key_val</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                    <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s1">&#39;) AND &#39;</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s2">&quot;) AND &quot;</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                        <span class="n">simple_search</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1"> AND &#39;</span>

            <span class="k">if</span> <span class="n">simple_search</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Search query: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">search_query</span><span class="p">)</span>
            <span class="n">field_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">attr_list</span><span class="p">:</span>
                <span class="n">field_query</span> <span class="o">=</span> <span class="s2">&quot;&amp;fl=&quot;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr_list</span><span class="p">:</span>
                    <span class="n">field_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">,&#39;</span>
                <span class="n">field_query</span> <span class="o">=</span> <span class="n">field_query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Field query formed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field_query</span><span class="p">)</span>
            <span class="n">ex_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">op_params</span><span class="p">:</span>
                <span class="n">op_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wt&#39;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">op_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ex_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&amp;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&amp;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optional parameters are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ex_query</span><span class="p">)</span>

            <span class="n">final_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">search_query</span><span class="si">}{</span><span class="n">field_query</span><span class="si">}{</span><span class="n">ex_query</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">final_url</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while creating solr query: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

    <span class="k">def</span> <span class="nf">_is_job_played</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if job has started playing or not. Should be called from SolrCloud or</span>
<span class="sd">        SolrStandAlone class</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dict)  -- Dictionary of keyword and job_id</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if job is not played after 5 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span><span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="n">new_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">tot_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old_cnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">tot_time</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">old_cnt</span> <span class="o">==</span> <span class="n">new_cnt</span> <span class="ow">and</span> <span class="n">new_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job has started playing. Waiting 30 secs to check again&quot;</span><span class="p">)</span>
                <span class="n">old_cnt</span> <span class="o">=</span> <span class="n">new_cnt</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">new_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job is not played&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job has started playing: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while checking if job was played. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span>

    <span class="k">def</span> <span class="nf">_check_all_items_played_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if all items in a job were played successfully. Should be called via</span>
<span class="sd">        check_all_items_played_successfully method in SolrStandalone or SolrCloud</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dict)   -- Dictionary of backup job keyword and datatype</span>

<span class="sd">                job_id(int)         -- Job id</span>

<span class="sd">                attr_list(set)     -- Attribute list to return, Will return the</span>
<span class="sd">                    Default(None)      default_attrib_list by default(Works as fl in Solr)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details about all the items in that job if true</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if the job was not played after 10 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span><span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">old_results</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">total_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_items_inbackup_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="n">tot_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">total_results</span> <span class="o">-</span> <span class="n">new_results</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tot_time</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of files played(</span><span class="si">%d</span><span class="s2">) is not equal to total items in &quot;</span>
                              <span class="s2">&quot;job(</span><span class="si">%d</span><span class="s2">). Waiting for 1 minute and retrying&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_results</span><span class="p">,</span>
                                                                              <span class="n">total_results</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_results</span> <span class="o">!=</span> <span class="n">old_results</span><span class="p">:</span>
                    <span class="n">old_results</span> <span class="o">=</span> <span class="n">new_results</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="n">new_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                    <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="n">new_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_results</span> <span class="o">==</span> <span class="n">old_results</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job is not played&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Job </span><span class="si">%s</span><span class="s2"> was successfully played. Now generating results---&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">total_results</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="p">,</span>
                                                            <span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                                                                       <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">num_rows</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_records&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_results</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="n">attr_list</span><span class="p">)</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">num_rows</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---------------Results for job </span><span class="si">%s</span><span class="s2"> generated succesfully-------------&quot;</span>
                          <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while checking if job was successfully played. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span>

    <span class="k">def</span> <span class="nf">_is_content_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">,</span> <span class="n">number_of_items</span><span class="p">,</span> <span class="n">preview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preview_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if items for the client are content indexed. Should be called via</span>
<span class="sd">        is_content_indexed method in SolrStandalone or SolrCloud</span>
<span class="sd">             Args:</span>
<span class="sd">                select_dict(dict)      -- Dictionary to check if ci was successful</span>

<span class="sd">                number_of_items(int)   -- Number of items applicable for CI job</span>

<span class="sd">                preview(boolean)       -- If job was done with preview option selected</span>

<span class="sd">                preview_path(str)      -- The preview path</span>

<span class="sd">             Raises:</span>
<span class="sd">                Exception if the items are not content indexed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">preview_path</span><span class="p">:</span>
                <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="n">number_of_items</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Solr url formed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">items_in_solr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">preview</span> <span class="ow">and</span> <span class="s1">&#39;docs&#39;</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s1">&#39;response&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;previewpath&#39;</span> <span class="ow">in</span> <span class="n">doc</span> <span class="ow">or</span> <span class="s1">&#39;PreviewPath&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                        <span class="n">items_in_solr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items_in_solr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total items Content Indexed: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">items_in_solr</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">items_in_solr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_of_items</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error in method _is_content_indexed. Reason: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>

<div class="viewcode-block" id="SolrHelper.get_result_of_custom_query"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.get_result_of_custom_query">[docs]</a>    <span class="k">def</span> <span class="nf">get_result_of_custom_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get results of any query.</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dictionary)         --  Dictionary containing search criteria and</span>
<span class="sd">                                                    value. Acts as &#39;q&#39; field in solr query</span>

<span class="sd">                attr_list(set)                  --  Criteria to filter results. Acts as &#39;fl&#39; in</span>
<span class="sd">                                                    solr query</span>

<span class="sd">                op_params(dictionary)           --  Other params and values for solr query. Do not</span>
<span class="sd">                                                    mention &#39;wt&#39; param as it is always json</span>
<span class="sd">                                                    (Ex: start, rows)</span>
<span class="sd">            Returns:</span>
<span class="sd">                result dictionary containing properties as read from solr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">op_params</span><span class="p">:</span>
                <span class="n">op_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">,</span> <span class="n">op_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">tot_rec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;numFound&#39;</span><span class="p">])</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_records&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_rec</span>
            <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">op_params</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
                <span class="n">tot_rec</span> <span class="o">-=</span> <span class="n">start</span>
            <span class="k">if</span> <span class="s2">&quot;rows&quot;</span> <span class="ow">in</span> <span class="n">op_params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tot_rec</span><span class="p">:</span>
                    <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_rec</span>
                <span class="n">tot_rec</span> <span class="o">=</span> <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;rows&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_params</span> <span class="ow">or</span> <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating Results for the above query&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">tot_rec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
                <span class="k">if</span> <span class="n">rows</span> <span class="o">&gt;</span> <span class="n">tot_rec</span><span class="p">:</span>
                    <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_rec</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">,</span> <span class="n">op_params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">)</span>
                <span class="n">tot_rec</span> <span class="o">-=</span> <span class="n">rows</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">rows</span>
            <span class="k">if</span> <span class="s1">&#39;facet_counts&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;facet_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;facet_counts&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while getting result of custom query. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.check_if_error_in_response"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.check_if_error_in_response">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_error_in_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if response has error</span>
<span class="sd">            Args:</span>
<span class="sd">                response(obj)         --  Response Object</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if response was error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error in calling solr URL. Reason </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error in the solr URL. Reason </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">excp</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.parse_json"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.parse_json">[docs]</a>    <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_string</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to parse json output of a solr query</span>
<span class="sd">            Args:</span>
<span class="sd">                json_string(string)         -- json result of solr in the form of string</span>

<span class="sd">                result_obj(dictionary)      -- Dictionary to hold the result</span>

<span class="sd">                attr_list(set)              -- Attribute list to return(Works as fl in solr)</span>
<span class="sd">                    Default(None)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Result dictionary</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if error in parsing json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started parsing the response json&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;result&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_list</span><span class="p">:</span>
                <span class="n">attr_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_attrib_list</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">:</span>
                <span class="n">result_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;docs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">result_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
                <span class="k">return</span> <span class="n">result_obj</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]:</span>
                <span class="n">content_id</span> <span class="o">=</span> <span class="n">ind</span>
                <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="s1">&#39;contentid&#39;</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                    <span class="n">content_id</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;contentid&#39;</span><span class="p">]</span>
                <span class="n">result_list</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attr_list</span><span class="p">:</span>
                        <span class="n">result_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cvownerdisp&#39;</span><span class="p">,</span> <span class="s1">&#39;OwnerName&#39;</span><span class="p">):</span>
                        <span class="n">str_val</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">result_list</span><span class="p">[</span><span class="s1">&#39;cvownerDisplayName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">result_list</span><span class="p">[</span><span class="s1">&#39;cvownerSMTP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_val</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
                        <span class="n">result_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result_obj</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">content_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_list</span>
            <span class="k">return</span> <span class="n">result_obj</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in method &#39;parse_json&#39; while parsing json. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                               <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.get_count_from_json"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.get_count_from_json">[docs]</a>    <span class="k">def</span> <span class="nf">get_count_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return the numFound in any json_string</span>
<span class="sd">            Args:</span>
<span class="sd">                json_string(string)  -- String representation of output solr json</span>

<span class="sd">            Returns:</span>
<span class="sd">                count of numFound</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in method &#39;get_count_from_json&#39; while parsing json to &quot;</span>
                               <span class="s2">&quot;get result count&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.get_all_field_names"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.get_all_field_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_field_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper Method to get all the column names in solr</span>

<span class="sd">            Returns:</span>
<span class="sd">                Dictionary of column names as key and their schema as value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;select?&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">admin/luke?numTerms=0&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">solr_url</span><span class="si">}</span><span class="s1">&amp;</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SolrHelper.create_url_and_get_response"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.create_url_and_get_response">[docs]</a>    <span class="k">def</span> <span class="nf">create_url_and_get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to get results from a url</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dictionary)         --  Dictionary containing search criteria and</span>
<span class="sd">                                                    value. Acts as &#39;q&#39; field in solr query</span>

<span class="sd">                attr_list(set)                  --  Criteria to filter results. Acts as &#39;fl&#39; in</span>
<span class="sd">                                                    solr query</span>

<span class="sd">                op_params(dictionary)           --  Other params and values for solr query. Do not</span>
<span class="sd">                                                    mention &#39;wt&#39; param as it is always json</span>
<span class="sd">                                                    (Ex: start, rows)</span>

<span class="sd">            Returns:</span>
<span class="sd">                content of the response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">,</span> <span class="n">op_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

    <span class="k">def</span> <span class="nf">_validate_retention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_days</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to validate retention</span>
<span class="sd">            Args:</span>
<span class="sd">                number_of_days(int)             --  Number of days in retention period</span>

<span class="sd">                keyword(list)                   --  [&quot;mtm&quot;, &quot;datatype&quot;] or [&quot;ReceivedTime&quot;,</span>
<span class="sd">                                                    &quot;DocumentType&quot;] based on Solr type</span>

<span class="sd">                select_dict(dictionary)         --  Dictionary containing search criteria and</span>
<span class="sd">                                                    value.</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if retention is not validated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">number_of_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mtm_valid</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">month</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">day</span><span class="si">}</span><span class="s1">T</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">hour</span><span class="si">}</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;:</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">minute</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">valid_time</span><span class="o">.</span><span class="n">second</span><span class="si">}</span><span class="s1">Z&#39;</span><span class="p">)</span>
            <span class="n">s_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                      <span class="n">keyword</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="sa">f</span><span class="s1">&#39;[* TO </span><span class="si">{</span><span class="n">mtm_valid</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">2</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">s_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of items not eligible for retention: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_retention_process</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">json_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of items not retained: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">json_num</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Retention not satisfied&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retention Validated&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while validating retention&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span>

<div class="viewcode-block" id="SolrHelper.call_retention_process"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.call_retention_process">[docs]</a>    <span class="k">def</span> <span class="nf">call_retention_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the CvExAutomatedtask Process on the proxy&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running CvExAutomatedtask process on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CvExAutomatedtask.exe -vm </span><span class="si">{</span><span class="n">machine</span><span class="o">.</span><span class="n">instance</span><span class="si">}</span><span class="s1"> -SubmitRet -IS &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrHelper.is_solr_standalone"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrHelper.is_solr_standalone">[docs]</a>    <span class="k">def</span> <span class="nf">is_solr_standalone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if current instance is of SolrCloud or StandAlone</span>
<span class="sd">            Returns:</span>
<span class="sd">                True if instance of SolrStandAlone</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SolrStandAlone</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SolrStandAlone"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone">[docs]</a><span class="k">class</span> <span class="nc">SolrStandAlone</span><span class="p">(</span><span class="n">SolrHelper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to execute solr standalone related operations &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_object</span><span class="p">,</span> <span class="n">searchURL</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the Solr StandAlone object</span>
<span class="sd">            Args:</span>
<span class="sd">                ex_object(object)      -- instance of the exchange object</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SolrStandAlone</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ex_object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------- Solr Stand Alone Constructor -------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_attrib_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;msgclass&#39;</span><span class="p">,</span> <span class="s1">&#39;ccsmtp&#39;</span><span class="p">,</span> <span class="s1">&#39;fmsmtp&#39;</span><span class="p">,</span> <span class="s1">&#39;tosmtp&#39;</span><span class="p">,</span> <span class="s1">&#39;conv&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;hasattach&#39;</span><span class="p">,</span> <span class="s1">&#39;hasAnyAttach&#39;</span><span class="p">,</span> <span class="s1">&#39;folder&#39;</span><span class="p">,</span> <span class="s1">&#39;entity_ccn&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;entity_ssn&#39;</span><span class="p">,</span> <span class="s1">&#39;CAState&#39;</span><span class="p">,</span> <span class="s1">&#39;cijid&#39;</span><span class="p">,</span> <span class="s1">&#39;cistatus&#39;</span><span class="p">,</span> <span class="s1">&#39;afid&#39;</span><span class="p">,</span> <span class="s1">&#39;afof&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_user_results_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_result_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">searchURL</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_standlone_base_url</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">searchURL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span> <span class="o">=</span> <span class="s2">&quot;clid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SOLR_TYPE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;server_type&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------- Solr Stand Alone Constructor Ends-------------&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SolrStandAlone.get_user_results_count"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.get_user_results_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_results_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get the count of items in each core for user mailbox</span>
<span class="sd">            Returns:</span>
<span class="sd">                Count of items in each user mailbox core</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting count of all results in each core&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;server_url&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/solr/&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">usermbx</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/select?q=*:*&amp;rows=0&amp;wt=json&#39;</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;core</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in method &#39;get_user_results_count&#39;&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.get_journal_result_count"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.get_journal_result_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_journal_result_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get the count of items in each core for journal mailbox</span>
<span class="sd">            Returns:</span>
<span class="sd">                Count of items in journal mailbox core</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting count of all results in journalmbx core&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">journalmbx/select?q=*:*&amp;rows=0&amp;wt=json&#39;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;journalmbx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;journalmbx&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in method &#39;get_journal_result_cnt&#39;. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.set_standlone_base_url"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.set_standlone_base_url">[docs]</a>    <span class="k">def</span> <span class="nf">set_standlone_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set the base url of the Solr standalone&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting the base url for solr queries&quot;</span><span class="p">)</span>
            <span class="n">temp_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">==</span> <span class="s2">&quot;usermailbox&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">usermbx0/select?shards=&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">temp_base</span><span class="si">}</span><span class="s1">usermbx</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">,&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">&amp;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">journalmbx/select?&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Base url for solr queries is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in method &#39;set_standlone_base_url&#39;. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.is_job_played"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.is_job_played">[docs]</a>    <span class="k">def</span> <span class="nf">is_job_played</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if job has started playing or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if job is not played after 5 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Checking if job </span><span class="si">%s</span><span class="s2"> started playing------------&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_job_played</span><span class="p">({</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">excp</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.check_all_items_played_successfully"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.check_all_items_played_successfully">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_items_played_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if all items in the job were successfully played or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">                attr_list(set)     -- Attribute list to return, Will return the</span>
<span class="sd">                    Default(None)     default_attrib_list by default(Works as fl in Solr)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details about all the items in that job if playback was successful</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if the job was not played after 10 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Checking if job </span><span class="si">%s</span><span class="s2"> was played successfully------------&quot;</span>
                          <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_items_played_successfully</span><span class="p">({</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">},</span>
                                                      <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.is_content_indexed"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.is_content_indexed">[docs]</a>    <span class="k">def</span> <span class="nf">is_content_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_items</span><span class="p">,</span> <span class="n">preview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preview_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if items are content indexed.</span>
<span class="sd">            Args:</span>
<span class="sd">                number_of_items (int)   -- Number of items applicable for CI job</span>

<span class="sd">                preview(boolean)        -- If job was done with preview option selected</span>

<span class="sd">                preview_path(str)        -- The preview path</span>

<span class="sd">            Raises:</span>
<span class="sd">               Exception if the items are not content indexed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Content index&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_content_indexed</span><span class="p">({</span><span class="s2">&quot;cistatus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;CAState&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">},</span>
                                            <span class="n">number_of_items</span><span class="p">,</span> <span class="n">preview</span><span class="p">,</span> <span class="n">preview_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">excp</span><span class="p">)</span></div>

<div class="viewcode-block" id="SolrStandAlone.get_items_for_users"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.get_items_for_users">[docs]</a>    <span class="k">def</span> <span class="nf">get_items_for_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_guid_lists</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get documents for users guid</span>
<span class="sd">            Args:</span>
<span class="sd">                user_guid_lists(list)     -- List of user guids</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details dictonary of user details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Getting solr documents for users: ------------&quot;</span>
                          <span class="o">%</span> <span class="n">user_guid_lists</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_guid_lists</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_of_custom_query</span><span class="p">(</span><span class="n">select_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
                                                                            <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                                            <span class="s1">&#39;cvowner&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrStandAlone.validate_retention"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrStandAlone.validate_retention">[docs]</a>    <span class="k">def</span> <span class="nf">validate_retention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to validate retention</span>
<span class="sd">            Args:</span>
<span class="sd">                number_of_days(int)     -- Number of days in retention period</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if retention is not valid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Retention for client id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_retention</span><span class="p">(</span><span class="n">number_of_days</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mtm&quot;</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">],</span>
                                     <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                                      <span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while validating retention&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div></div>


<div class="viewcode-block" id="SolrCloud"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud">[docs]</a><span class="k">class</span> <span class="nc">SolrCloud</span><span class="p">(</span><span class="n">SolrHelper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to execute solr cloud related operations &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_object</span><span class="p">,</span> <span class="n">searchURL</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the Solr Cloud object</span>
<span class="sd">            Args:</span>
<span class="sd">                ex_object(object)      -- instance of the exchange object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ex_object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------- Solr Cloud Constructor -------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_attrib_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MessageClass&#39;</span><span class="p">,</span> <span class="s1">&#39;CCSMTP&#39;</span><span class="p">,</span> <span class="s1">&#39;FromSMTP&#39;</span><span class="p">,</span> <span class="s1">&#39;ToSMTP&#39;</span><span class="p">,</span> <span class="s1">&#39;Subject&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;HasAttachment&#39;</span><span class="p">,</span> <span class="s1">&#39;HasAnyAttachment&#39;</span><span class="p">,</span> <span class="s1">&#39;Folder&#39;</span><span class="p">,</span> <span class="s1">&#39;entity_ccn&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;entity_ssn&#39;</span><span class="p">,</span> <span class="s1">&#39;CAState&#39;</span><span class="p">,</span> <span class="s1">&#39;CIJobId&#39;</span><span class="p">,</span> <span class="s1">&#39;ContentIndexingStatus&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;AchiveFileId&#39;</span><span class="p">,</span> <span class="s1">&#39;ArchiveFileOffset&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">searchURL</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cloud_base_url</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user_results_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">searchURL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span> <span class="o">=</span> <span class="s2">&quot;ClientId&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SOLR_TYPE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;server_type&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------- Solr Cloud Constructor Ends -------------&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SolrCloud.set_cloud_base_url"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.set_cloud_base_url">[docs]</a>    <span class="k">def</span> <span class="nf">set_cloud_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set the base url of the Solr cloud</span>
<span class="sd">            Raises:</span>
<span class="sd">                Exception if error in parsing xml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting the base url for solr queries&quot;</span><span class="p">)</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;server_url&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/solr/&#39;</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">==</span> <span class="s2">&quot;usermailbox&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">)):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s1">#/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s1">UM_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;engine_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_&#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;backupset_guid&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/select?&#39;</span><span class="p">)</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mb_type</span> <span class="o">=</span> <span class="s1">&#39;CM_&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exch_obj</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">==</span> <span class="s2">&quot;journalmailbox&quot;</span><span class="p">:</span>
                    <span class="n">mb_type</span> <span class="o">=</span> <span class="s1">&#39;JM_&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">)):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s1">#/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}{</span><span class="n">mb_type</span><span class="si">}</span><span class="s1">&#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;engine_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_&#39;</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;backupset_guid&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/select?&#39;</span><span class="p">)</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Base url for solr queries is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred. Check if index server is down. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrCloud.get_user_results_count"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.get_user_results_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_results_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get the count of items in each core for user mailbox</span>
<span class="sd">            Returns:</span>
<span class="sd">                Count of items in the collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s1">q=*:*&amp;rows=0&amp;wt=json&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the count of all items for the solr cloud. URL = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;engine_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span>
                                                            <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exception occurred while getting total count. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrCloud.is_job_played"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.is_job_played">[docs]</a>    <span class="k">def</span> <span class="nf">is_job_played</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if job has started playing or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if job is not played after 5 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Checking if job </span><span class="si">%s</span><span class="s2"> started playing------------&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_job_played</span><span class="p">({</span><span class="s2">&quot;BackupJobId&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;DocumentType&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrCloud.check_all_items_played_successfully"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.check_all_items_played_successfully">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_items_played_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if all items in the job were successfully played or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">                attr_list(set)     -- Attribute list to return, Will return the</span>
<span class="sd">                    Default(None)      default_attrib_list by default(Works as fl in Solr)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details about all the items in that job if playback was successful</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if the job was not played after 10 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Checking if job </span><span class="si">%s</span><span class="s2"> was played successfully------------&quot;</span>
                          <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_items_played_successfully</span><span class="p">({</span><span class="s2">&quot;BackupJobId&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;DocumentType&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">},</span>
                                                      <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrCloud.is_content_indexed"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.is_content_indexed">[docs]</a>    <span class="k">def</span> <span class="nf">is_content_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_items</span><span class="p">,</span> <span class="n">preview</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preview_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if items for the client are content indexed.</span>
<span class="sd">            Args:</span>
<span class="sd">                number_of_items (int)   -- Number of items applicable for CI job</span>

<span class="sd">                preview(boolean)        -- If job was done with preview option selected</span>

<span class="sd">                preview_path(str)        -- The preview path</span>

<span class="sd">            Raises:</span>
<span class="sd">               Exception if the items are not content indexed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Content Indexing&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_content_indexed</span><span class="p">({</span><span class="s2">&quot;ContentIndexingStatus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;DocumentType&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                             <span class="s2">&quot;CAState&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">},</span>
                                            <span class="n">number_of_items</span><span class="p">,</span> <span class="n">preview</span><span class="p">,</span> <span class="n">preview_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">excp</span><span class="p">)</span></div>

<div class="viewcode-block" id="SolrCloud.get_items_for_users"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.get_items_for_users">[docs]</a>    <span class="k">def</span> <span class="nf">get_items_for_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_guid_lists</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get documents for users guid</span>
<span class="sd">            Args:</span>
<span class="sd">                user_guid_lists(list)     -- List of user guids</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details dictonary of user details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Getting solr documents for users: ------------&quot;</span>
                          <span class="o">%</span> <span class="n">user_guid_lists</span><span class="p">)</span>
            <span class="n">reuslt</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_guid_lists</span><span class="p">:</span>
                <span class="n">reuslt</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result_of_custom_query</span><span class="p">(</span><span class="n">select_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;IsVisible&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
                                                                            <span class="s1">&#39;DocumentType&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                                            <span class="s1">&#39;OwnerId_sort&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">reuslt</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">excp</span></div>

<div class="viewcode-block" id="SolrCloud.validate_retention"><a class="viewcode-back" href="../../../../source/Application.Exchange.ExchangeMailbox.html#Application.Exchange.ExchangeMailbox.solr_helper.SolrCloud.validate_retention">[docs]</a>    <span class="k">def</span> <span class="nf">validate_retention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to validate retention</span>
<span class="sd">            Args:</span>
<span class="sd">                number_of_days(int)     -- Number of days in retention period</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if retention is not validated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Retention for client id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_retention</span><span class="p">(</span><span class="n">number_of_days</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ReceivedTime&quot;</span><span class="p">,</span> <span class="s2">&quot;DocumentType&quot;</span><span class="p">],</span>
                                     <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword_for_client_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                                      <span class="s1">&#39;IsVisible&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s2">&quot;DocumentType&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while validating retention&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>