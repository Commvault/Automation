

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application.Sharepoint.sharepointhelper &mdash; Commvault Automation 11.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Application.Sharepoint.sharepointhelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Application.Sharepoint.sharepointhelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># ————————————————————————–</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># ————————————————————————–</span>

<span class="sd">&quot;&quot;&quot;Main helper file for performing Sharepoint Server operations.</span>

<span class="sd">SharepointAutomation, SharepointHelper, SharepointInit, SharepointValidate are the only classes defined in this file.</span>

<span class="sd">SharepointAutomation: Helper class to initialize objects for SharepointHelper.</span>

<span class="sd">SharepointHelper: Helper class to perform Sharepoint server operations.</span>

<span class="sd">SharepointInit: Helper class to perform Sharepoint Server initialization operations.</span>

<span class="sd">SharepointValidate: Helper class to perform Sharepoint Server validation operations.</span>


<span class="sd">SharepointHelper:</span>

<span class="sd">    __init__()                  --  initializes Sharepoint Server helper object.</span>

<span class="sd">    sharepoint_setup()          --  This function creates the sharepoint setup environment by creating</span>
<span class="sd">    testcase directory, web application, site collections and subclient.</span>

<span class="sd">    create_subclient()          --  This function creates a Sharepoint subclient and assign necessary properties.</span>

<span class="sd">    sharepoint_backup()         --  This function initiates a backup job, waits for completion and validates backed up</span>
<span class="sd">    items.</span>

<span class="sd">    sharepoint_restore()        --  This function initiates a restore job, waits for completion and validates restored</span>
<span class="sd">    items.</span>

<span class="sd">SharepointInit:</span>

<span class="sd">    __init__()                  --  initializes Sharepoint Server helper object.</span>

<span class="sd">    create_web_application()    --  This function creates the Sharepoint server web application.</span>

<span class="sd">    delete_web_application()    --  This function deletes the Sharepoint server web application.</span>

<span class="sd">    create_sites()              --  This function creates a number of Sharepoint server site collections.</span>

<span class="sd">    create_list()               --  This function will create a list/library on a Sharepoint site.</span>

<span class="sd">    upload_file()               --  This function will upload a file to a document library on a given Sharepoint site.</span>

<span class="sd">SharepointValidate:</span>

<span class="sd">    __init__()                  --  initializes Sharepoint Server helper object.</span>

<span class="sd">    create_meta_data()          --  This function will create a validation file with meta data of the web application.</span>

<span class="sd">    check_file()                --  This function will verify a file exists within a library.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">sharepointconstants</span>
<span class="kn">from</span> <span class="nn">.sharepointconstants</span> <span class="kn">import</span> <span class="n">SharepointListTemplate</span>

<span class="n">GLOBAL_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<div class="viewcode-block" id="SharepointAutomation"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointAutomation">[docs]</a><span class="k">class</span> <span class="nc">SharepointAutomation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to initialize Sharepoint Helper objects&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">GLOBAL_LOCK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcobject</span><span class="p">,</span> <span class="n">_spclient</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_spfarmuser</span><span class="p">,</span> <span class="n">_spfarmpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SharepointAutomation class objects</span>

<span class="sd">        Args:</span>
<span class="sd">            _spclient (str): Name of the client</span>
<span class="sd">            _sqlclient (str): Name of the SQL backend client</span>
<span class="sd">            _sqlinstance (str): Name of the Sharepoint Farm&#39;s SQL instance</span>
<span class="sd">            _spfarmuser (str): Sharepoint Farm admin user name</span>
<span class="sd">            _spfarmpass (str): Sharepoint Farm admin password</span>
<span class="sd">            _tcobject (:obj:&#39;CVTestCase&#39;): test case object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">_tcobject</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spclient</span> <span class="o">=</span> <span class="n">_spclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlclient</span> <span class="o">=</span> <span class="n">_sqlclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlinstance</span> <span class="o">=</span> <span class="n">_sqlinstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spfarmuser</span> <span class="o">=</span> <span class="n">_spfarmuser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spfarmpass</span> <span class="o">=</span> <span class="n">_spfarmpass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span> <span class="o">=</span> <span class="n">_tcobject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">get_csdb</span><span class="p">()</span></div>


<div class="viewcode-block" id="SharepointHelper"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointHelper">[docs]</a><span class="k">class</span> <span class="nc">SharepointHelper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform Sharepoint Server operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">GLOBAL_LOCK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tcobject</span><span class="p">,</span> <span class="n">_spclient</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span> <span class="n">_spfarmuser</span><span class="p">,</span> <span class="n">_spfarmpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SharepointHelper object</span>

<span class="sd">            Args:</span>
<span class="sd">                _spclient (str): Name of the client</span>
<span class="sd">                _sqlclient (str): Name of the SQL backend client</span>
<span class="sd">                _sqlinstance (str): Name of the Sharepoint Farm&#39;s SQL instance</span>
<span class="sd">                _spfarmuser (str): Sharepoint Farm admin user name</span>
<span class="sd">                _spfarmpass (str): Sharepoint Farm admin password</span>
<span class="sd">                _tcobject (:obj:&#39;CVTestCase&#39;): test case object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span> <span class="o">=</span> <span class="n">SharepointAutomation</span><span class="p">(</span><span class="n">_tcobject</span><span class="p">,</span> <span class="n">_spclient</span><span class="p">,</span> <span class="n">_sqlclient</span><span class="p">,</span> <span class="n">_sqlinstance</span><span class="p">,</span>
                                                 <span class="n">_spfarmuser</span><span class="p">,</span> <span class="n">_spfarmpass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spinit</span> <span class="o">=</span> <span class="n">SharepointInit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spvalidate</span> <span class="o">=</span> <span class="n">SharepointValidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">tcobject</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">webapp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_pool_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subcontent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storagepolicy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tctime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spsetup_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_file_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharepoint_client_members</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharepoint_client_primary_member</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="SharepointHelper.sharepoint_setup"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointHelper.sharepoint_setup">[docs]</a>    <span class="k">def</span> <span class="nf">sharepoint_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">,</span> <span class="n">noof_apps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noof_sites</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates the sharepoint setup environment by creating the web application,</span>
<span class="sd">        site collections and subclient.</span>

<span class="sd">        Args:</span>
<span class="sd">            storagepolicy (str): Name of storage policy to assign to subclient.</span>

<span class="sd">            noof_apps (int): Number of Web Applications to create.</span>

<span class="sd">            noof_sites (int): Number of Web Applications to create.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">id</span>
            <span class="n">time1</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">logdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">log_dir</span>
            <span class="n">subclientname</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">SUBCLIENT_NAME</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tc_id</span><span class="p">,</span> <span class="n">time1</span><span class="p">)</span>
            <span class="n">site_title</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># build temporary testcase logging directory and create it</span>
            <span class="n">tcdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdir</span><span class="p">,</span> <span class="n">tc_id</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">time1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
            <span class="n">spmachine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">tcdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcdir</span> <span class="o">=</span> <span class="n">tcdir</span>

            <span class="c1"># retrieve client host name from CSDB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT net_hostname FROM APP_CLIENT where name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
            <span class="n">client_hostname</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">spsetup_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">subcontent</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noof_apps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># generate a random port number for web application</span>
                <span class="c1"># TODO add extra code here to verify port isn&#39;t in use</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">65535</span><span class="p">))</span>

                <span class="n">webapp</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">WEBAPP_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

                <span class="n">dbname</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">DB_NAME</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="n">app_pool_name</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">APP_POOL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

                <span class="c1"># create web app</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spinit</span><span class="o">.</span><span class="n">create_web_application</span><span class="p">(</span>
                    <span class="n">webapp</span><span class="p">,</span>
                    <span class="n">app_pool_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spfarmuser</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spfarmpass</span><span class="p">,</span>
                    <span class="n">dbname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">sqlinstance</span>
                <span class="p">)</span>

                <span class="n">setup_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;application_pool&quot;</span><span class="p">:</span> <span class="n">app_pool_name</span><span class="p">,</span>
                    <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
                    <span class="s2">&quot;web_application&quot;</span><span class="p">:</span> <span class="n">webapp</span><span class="p">,</span>
                    <span class="s2">&quot;content_database&quot;</span><span class="p">:</span> <span class="n">dbname</span><span class="p">,</span>
                    <span class="s2">&quot;database_server&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">sqlinstance</span><span class="p">,</span>
                    <span class="s2">&quot;credentials&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spfarmuser</span><span class="p">,</span>
                        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spfarmpass</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">spsetup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setup_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spsetup_list</span> <span class="o">=</span> <span class="n">spsetup_list</span>

                <span class="n">site_title</span> <span class="o">=</span> <span class="s1">&#39;TC_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tc_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">site_url</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">webapp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="n">site_title</span><span class="p">])</span>
                <span class="n">library_name</span> <span class="o">=</span> <span class="s1">&#39;DocLib&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tc_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time1</span>

                <span class="c1"># create site collection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spinit</span><span class="o">.</span><span class="n">create_sites</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spfarmuser</span><span class="p">,</span> <span class="s2">&quot;STS#0&quot;</span><span class="p">,</span> <span class="n">site_title</span><span class="p">,</span> <span class="n">noof_sites</span><span class="p">)</span>

                <span class="c1"># create document library</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spinit</span><span class="o">.</span><span class="n">create_list</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">)</span>

                <span class="c1"># generate test data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">spmachine</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="n">tcdir</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

                <span class="c1"># upload some files to the sharepoint site</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spinit</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">tcdir</span><span class="p">)</span>

                <span class="c1"># subclient content</span>
                <span class="n">subcontent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CONTENT_WEBAPP</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_pool_name</span><span class="p">)[</span><span class="mi">4</span><span class="p">:])</span>

            <span class="c1"># create subclient</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Creating subclient [</span><span class="si">{0}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_subclient</span><span class="p">(</span><span class="n">subclientname</span><span class="p">,</span> <span class="n">subcontent</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create subclient.</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">subcontent</span> <span class="o">=</span> <span class="n">subcontent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storagepolicy</span> <span class="o">=</span> <span class="n">storagepolicy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tctime</span> <span class="o">=</span> <span class="n">time1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_title</span> <span class="o">=</span> <span class="n">site_title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="n">library_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sharepoint_setup()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointHelper.create_subclient"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointHelper.create_subclient">[docs]</a>    <span class="k">def</span> <span class="nf">create_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclientname</span><span class="p">,</span> <span class="n">subcontent</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function makes the necessary calls and assignments to create a Sharepoint</span>
<span class="sd">        subclient.</span>

<span class="sd">        Args:</span>
<span class="sd">            subclientname (str): Name of subclient to be created.</span>

<span class="sd">            subcontent (list): Content to add to subclient.</span>

<span class="sd">            storagepolicy (str): Storage policy to assign to subclient.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subclientname</span><span class="p">,</span> <span class="n">storagepolicy</span><span class="p">)</span>
            <span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclientname</span><span class="p">)</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">subcontent</span>

            <span class="n">request_json</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">SP_SUBCLIENT_PROP_DICT</span>
            <span class="n">sqlclient_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ContentDatabaseSqlClient&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;clientName&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">sqlclient</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">request_json</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sqlclient_dict</span><span class="p">)</span>

            <span class="n">subclient_prop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_sharepoint_subclient_prop&quot;</span><span class="p">,</span> <span class="n">request_json</span><span class="p">]</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">sharepoint_subclient_prop</span> <span class="o">=</span> <span class="n">subclient_prop</span>

            <span class="n">request_json</span> <span class="o">=</span> <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">SP_SUBCLIENT_STORAGE_DICT</span>

            <span class="n">subclient</span><span class="o">.</span><span class="n">sharepoint_subclient_prop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_commonProperties[&#39;storageDevice&#39;]&quot;</span><span class="p">,</span>
                                                   <span class="n">request_json</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_subclient()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointHelper.sharepoint_backup"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointHelper.sharepoint_backup">[docs]</a>    <span class="k">def</span> <span class="nf">sharepoint_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function initiates a backup job, waits for completion, and validates backed up</span>
<span class="sd">        items.</span>

<span class="sd">        Args:</span>
<span class="sd">            backup_type (str): Type of backup to run: Full, Differential.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Starting Subclient </span><span class="si">{0}</span><span class="s2"> Backup &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started </span><span class="si">{0}</span><span class="s2"> backup with Job ID: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run </span><span class="si">{0}</span><span class="s2"> backup job with error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">backup_type</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;Completed&#39;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished </span><span class="si">{0}</span><span class="s2"> backup job&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Backup job </span><span class="si">{0}</span><span class="s2"> did not complete successfully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

            <span class="c1"># TODO Verify how to calculate number of objects for successful backup</span>
            <span class="n">j_details</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">details</span>
            <span class="c1"># if int(j_details[&#39;jobDetail&#39;][&#39;detailInfo&#39;][&#39;numOfObjects&#39;]) != \</span>
            <span class="c1">#         len(self.tcobject.subclient.content) * 4:</span>
            <span class="c1">#     raise Exception(&quot;Failed to backup all content in subclient&quot;)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup job Details: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j_details</span><span class="p">[</span><span class="s1">&#39;jobDetail&#39;</span><span class="p">][</span><span class="s1">&#39;detailInfo&#39;</span><span class="p">][</span><span class="s1">&#39;numOfObjects&#39;</span><span class="p">])))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Content number of objects to expect restored: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sharepoint_backup()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointHelper.sharepoint_restore"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointHelper.sharepoint_restore">[docs]</a>    <span class="k">def</span> <span class="nf">sharepoint_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function initiates a restore job, waits for completion, and validates restored</span>
<span class="sd">        items.</span>

<span class="sd">        Args:</span>
<span class="sd">            content (list): Content to restore.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">sqlclient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsetup_list</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="s2">&quot; Started Restore with Job ID: </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Restore job failed for unexpected reasons. Check log files.&quot;</span><span class="p">)</span>

            <span class="c1"># getting exception when checking job details without a sleep</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">j_details</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">details</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restore job Details: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j_details</span><span class="p">[</span><span class="s1">&#39;jobDetail&#39;</span><span class="p">][</span><span class="s1">&#39;detailInfo&#39;</span><span class="p">][</span><span class="s1">&#39;numOfObjects&#39;</span><span class="p">])))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Content number of objects to expect restored: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>

            <span class="c1"># TODO Verify how to calculate number of objects for successful</span>
            <span class="c1"># if not int(j_details[&#39;jobDetail&#39;][&#39;detailInfo&#39;][&#39;numOfObjects&#39;]) == len(content) * 4:</span>
            <span class="c1">#     raise Exception(&quot;Failed to restore all Sharepoint content.&quot;)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in sharepoint_restore()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SharepointInit"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit">[docs]</a><span class="k">class</span> <span class="nc">SharepointInit</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform Sharepoint Server initialization operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">GLOBAL_LOCK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sphelper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SQLHelper object</span>

<span class="sd">        Args:</span>
<span class="sd">            _sphelper (:obj: &#39;SharepointHelper&#39;): Instance of SharepointHelper</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span> <span class="o">=</span> <span class="n">_sphelper</span>

<div class="viewcode-block" id="SharepointInit.create_web_application"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit.create_web_application">[docs]</a>    <span class="k">def</span> <span class="nf">create_web_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webapp_url</span><span class="p">,</span> <span class="n">webapp_name</span><span class="p">,</span> <span class="n">spfarmuser</span><span class="p">,</span> <span class="n">spfarmpass</span><span class="p">,</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">database_server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates the Sharepoint server web application.</span>

<span class="sd">        Args:</span>

<span class="sd">            webapp_url (list): URL of the web application.</span>

<span class="sd">            webapp_name (str): Name of web application.</span>

<span class="sd">            spfarmuser (str): Sharepoint farm user to create web application.</span>

<span class="sd">            spfarmpass (str): Sharepoint farm user&#39;s password.</span>

<span class="sd">            database_name (str): Content database name to be associated to web application.</span>

<span class="sd">            database_server (str): SQL backend server to Sharepoint farm.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">webapp_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;WebappURL&quot;</span><span class="p">:</span> <span class="n">webapp_url</span><span class="p">,</span>
                <span class="s2">&quot;WebappName&quot;</span><span class="p">:</span> <span class="n">webapp_name</span><span class="p">,</span>
                <span class="s2">&quot;AppPoolName&quot;</span><span class="p">:</span> <span class="n">webapp_name</span><span class="p">,</span>
                <span class="s2">&quot;AppPoolAcct&quot;</span><span class="p">:</span> <span class="n">spfarmuser</span><span class="p">,</span>
                <span class="s2">&quot;AppPoolPass&quot;</span><span class="p">:</span> <span class="n">spfarmpass</span><span class="p">,</span>
                <span class="s2">&quot;DatabaseName&quot;</span><span class="p">:</span> <span class="n">database_name</span><span class="p">,</span>
                <span class="s2">&quot;DatabaseServer&quot;</span><span class="p">:</span> <span class="n">database_server</span>
            <span class="p">}</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Webapp [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">webapp_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CREATE_WEBAPP</span><span class="p">,</span> <span class="n">webapp_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create web application&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_web_application()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointInit.delete_web_application"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit.delete_web_application">[docs]</a>    <span class="k">def</span> <span class="nf">delete_web_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webapp_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function deletes the Sharepoint server web application.</span>

<span class="sd">        Args:</span>

<span class="sd">            webapp_url (str): URL of the web application.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">webapp_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spsetup_list</span><span class="p">:</span>
                    <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;web_application&quot;</span><span class="p">]</span>
                    <span class="n">webapp_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;WebappURL&quot;</span><span class="p">:</span> <span class="n">webapp_url</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting Webapp [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">webapp_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

                    <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                        <span class="n">sharepointconstants</span><span class="o">.</span><span class="n">DELETE_WEBAPP</span><span class="p">,</span> <span class="n">webapp_dict</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to delete web application [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">webapp_url</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">webapp_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;WebappURL&quot;</span><span class="p">:</span> <span class="n">webapp_url</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting Webapp [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">webapp_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">DELETE_WEBAPP</span><span class="p">,</span> <span class="n">webapp_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to delete web application&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception raised in delete_web_application()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="SharepointInit.create_sites"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit.create_sites">[docs]</a>    <span class="k">def</span> <span class="nf">create_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_url</span><span class="p">,</span> <span class="n">spfarmuser</span><span class="p">,</span> <span class="n">site_template</span><span class="p">,</span> <span class="n">site_title</span><span class="p">,</span> <span class="n">site_count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates a number of Sharepoint server site collections.</span>

<span class="sd">        Args:</span>

<span class="sd">            site_url (str): URL of web application.</span>

<span class="sd">            spfarmuser (str): Sharepoint farm user to be associated to site.</span>

<span class="sd">            site_template (str): Sharepoint site template to use for creating site.</span>

<span class="sd">            site_title (str): Title for Sharepoint site.</span>

<span class="sd">            site_count (int): Number of sites to create.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">site_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SiteURL&quot;</span><span class="p">:</span> <span class="n">site_url</span><span class="p">,</span>
                <span class="s2">&quot;SiteOwner&quot;</span><span class="p">:</span> <span class="n">spfarmuser</span><span class="p">,</span>
                <span class="s2">&quot;SiteTemplate&quot;</span><span class="p">:</span> <span class="n">site_template</span><span class="p">,</span>
                <span class="s2">&quot;SiteTitle&quot;</span><span class="p">:</span> <span class="n">site_title</span><span class="p">,</span>
                <span class="s2">&quot;SiteCount&quot;</span><span class="p">:</span> <span class="n">site_count</span>
            <span class="p">}</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Site Collection [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CREATE_SITES</span><span class="p">,</span> <span class="n">site_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create site collection. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_sites()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointInit.create_list"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit.create_list">[docs]</a>    <span class="k">def</span> <span class="nf">create_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">list_template</span><span class="o">=</span><span class="n">SharepointListTemplate</span><span class="o">.</span><span class="n">DOCLIBRARY</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will create a list/library on a Sharepoint site</span>

<span class="sd">        Args:</span>
<span class="sd">            site_url (str): URL of the site where to create list/library</span>

<span class="sd">            library_name (str): name of list/library to create</span>

<span class="sd">            list_template (sharepointconstants.SharepointListTemplate.value): type of list/library to create</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">list_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SiteURL&quot;</span><span class="p">:</span> <span class="n">site_url</span><span class="p">,</span>
                <span class="s2">&quot;LibraryName&quot;</span><span class="p">:</span> <span class="n">library_name</span><span class="p">,</span>
                <span class="s2">&quot;ListTemplate&quot;</span><span class="p">:</span> <span class="n">list_template</span><span class="o">.</span><span class="n">value</span>
            <span class="p">}</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Creating Library\List on Site [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">]&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CREATE_LIST</span><span class="p">,</span> <span class="n">list_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create list or library. &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_list()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointInit.upload_file"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointInit.upload_file">[docs]</a>    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">file_dir</span><span class="p">,</span> <span class="n">noof_files</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function will upload a file to a document library on a given Sharepoint site</span>

<span class="sd">        Args:</span>
<span class="sd">            site_url (str): URL of the site where to upload the file.</span>

<span class="sd">            library_name (str): Name of library where to upload the file.</span>

<span class="sd">            file_dir (str): Path of file to upload to Sharepoint library.</span>

<span class="sd">            noof_files (int): Number of files to upload. Random number between 1-10 will be picked if not given.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">upload_file_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">noof_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">noof_files</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">file_dir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">all_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noof_files</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;SiteURL&quot;</span><span class="p">:</span> <span class="n">site_url</span><span class="p">,</span>
                    <span class="s2">&quot;LibraryName&quot;</span><span class="p">:</span> <span class="n">library_name</span><span class="p">,</span>
                    <span class="s2">&quot;FilePath&quot;</span><span class="p">:</span> <span class="n">file_path</span>
                <span class="p">}</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Uploading file [</span><span class="si">{0}</span><span class="s2">] to library [</span><span class="si">{1}</span><span class="s2">] on Site [</span><span class="si">{2}</span><span class="s2">] on [</span><span class="si">{3}</span><span class="s2">]&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">site_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">UPLOAD_FILE</span><span class="p">,</span> <span class="n">file_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to upload file to library. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">upload_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in upload_file()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SharepointValidate"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointValidate">[docs]</a><span class="k">class</span> <span class="nc">SharepointValidate</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform Sharepoint Server validation operations&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">GLOBAL_LOCK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_sphelper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes SQLHelper object</span>

<span class="sd">        Args:</span>
<span class="sd">            _sphelper (:obj: &#39;SharepointHelper&#39;): Instance of SharepointHelper</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span> <span class="o">=</span> <span class="n">_sphelper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">tcobject</span>

<div class="viewcode-block" id="SharepointValidate.create_meta_data"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointValidate.create_meta_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">webapp_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will create a validation file with meta data of the web application.</span>

<span class="sd">        Args:</span>

<span class="sd">            file_name (str): Name of file.</span>

<span class="sd">            webapp_url (str): URL of web application.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO check backupset and use appropriate scripts for metadata. Should have 1 method to handle all cases.</span>
            <span class="c1"># TODO check if we can create 1 meta data for all web apps or libraries passed in here.</span>

            <span class="k">if</span> <span class="n">webapp_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spsetup_list</span><span class="p">:</span>
                    <span class="n">webapp_url</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;web_application&quot;</span><span class="p">]</span>
                    <span class="n">meta_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;MetaFile&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                        <span class="s2">&quot;WebappURL&quot;</span><span class="p">:</span> <span class="n">webapp_url</span>
                    <span class="p">}</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Meta Information for Webapp [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">] in file [</span><span class="si">{2}</span><span class="s2">]&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">webapp_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>

                    <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CREATE_META_DB</span><span class="p">,</span> <span class="n">meta_dict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create meta data file.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meta_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;MetaFile&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                    <span class="s2">&quot;WebappURL&quot;</span><span class="p">:</span> <span class="n">webapp_url</span>
                <span class="p">}</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Meta Information for Webapp [</span><span class="si">{0}</span><span class="s2">] on [</span><span class="si">{1}</span><span class="s2">] in file [</span><span class="si">{2}</span><span class="s2">]&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">webapp_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>

                <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CREATE_META_DB</span><span class="p">,</span> <span class="n">meta_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to create meta data file.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in create_meta_data()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="SharepointValidate.check_file"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointValidate.check_file">[docs]</a>    <span class="k">def</span> <span class="nf">check_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webapp_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="n">site_title</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will verify a file exists within a library.</span>

<span class="sd">        Args:</span>

<span class="sd">            webapp_url (str): URL of web application.</span>

<span class="sd">            library_name (str): Name of library.</span>

<span class="sd">            site_title (str): Name of library.</span>

<span class="sd">            file_name (str): Name of file.</span>

<span class="sd">        Returns:</span>

<span class="sd">            bool: True for Success else False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">log</span>
        <span class="n">spmachine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">site_url</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">webapp_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="n">site_title</span><span class="p">])</span>
            <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SiteURL&quot;</span><span class="p">:</span> <span class="n">site_url</span><span class="p">,</span>
                <span class="s2">&quot;LibraryName&quot;</span><span class="p">:</span> <span class="n">library_name</span><span class="p">,</span>
                <span class="s2">&quot;FileName&quot;</span><span class="p">:</span> <span class="n">file_name</span>
            <span class="p">}</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking file [</span><span class="si">{0}</span><span class="s2">] on Site [</span><span class="si">{1}</span><span class="s2">] and Library [</span><span class="si">{2}</span><span class="s2">] on [</span><span class="si">{3}</span><span class="s2">]&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">site_url</span><span class="p">,</span> <span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">))</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">spmachine</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">sharepointconstants</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">,</span> <span class="n">file_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="s2">&quot;exists&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span> <span class="k">else</span> <span class="kc">False</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to validate file in library. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in check_file()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>
<div class="viewcode-block" id="SharepointValidate.get_sharepoint_members"><a class="viewcode-back" href="../../../source/Application.Sharepoint.html#Application.Sharepoint.sharepointhelper.SharepointValidate.get_sharepoint_members">[docs]</a>    <span class="k">def</span> <span class="nf">get_sharepoint_members</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_client</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function gets all clients that were detected in the workflow</span>
<span class="sd">        Args:</span>
<span class="sd">            sql_client (str): Name of the SQL server client</span>
<span class="sd">            job_id (str): Job id of the workflow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wfdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">WFEngineDatabase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcobject</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">wfdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT execution from WF_Process where jobId = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
            <span class="n">xml_data</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>
            <span class="n">client_host_names</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//sharePointClientHostNamesStr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_members</span> <span class="o">=</span> <span class="n">client_host_names</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
            <span class="c1"># append sql server and sharepoint pseudo client to the member server list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_client</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_members</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_members</span>
            <span class="p">]</span>
            <span class="c1"># get primary sharepoint server from pseudo client properties</span>
            <span class="n">pm_server_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT c.name</span>
<span class="s2">                FROM APP_Client c</span>
<span class="s2">                WHERE c.id = (</span>
<span class="s2">                    SELECT attrVal</span>
<span class="s2">                        FROM APP_ClientProp cp</span>
<span class="s2">                        WHERE cp.componentNameId = (SELECT id FROM APP_CLIENT WHERE name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span>
<span class="s2">                        AND cp.attrName = &#39;SharePoint Primary Member Server&#39;</span>
<span class="s2">                    )&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">spautomation</span><span class="o">.</span><span class="n">spclient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">pm_server_query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sphelper</span><span class="o">.</span><span class="n">sharepoint_client_primary_member</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised in get_sharepoint_members()</span><span class="se">\n</span><span class="s2">Error: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>