

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application.Office365.solr_helper &mdash; Commvault Automation 11.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Application.Office365.solr_helper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Application.Office365.solr_helper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;&quot;Main file for Solr related operations</span>

<span class="sd">Solr:</span>

<span class="sd">    o365_object()                           -- Returns SharePoint/CloudConnector object</span>

<span class="sd">    index_details()                         -- Return details of the index server associated with client</span>

<span class="sd">    base_url()                              -- Returns base url for solr queries</span>

<span class="sd">    client_id()                             -- Returns the client id</span>

<span class="sd">    client_name()                           -- Returns the client name</span>

<span class="sd">    set_cvsolr_base_url()                   -- Method to set the base url of the cvsolr</span>

<span class="sd">    check_cvods_running()                   -- Checks if CVODS is running on the index server</span>

<span class="sd">    get_number_of_items_in_backup_job()     -- Gets number of items in the provided backup job</span>

<span class="sd">    create_solr_query()                     -- Creates solr search query based on inputs provided</span>

<span class="sd">    _is_job_played()                        -- Checks if job has started play back</span>

<span class="sd">    _check_all_items_played_successfully()  -- Checks if playback was successfully completed</span>

<span class="sd">    check_if_error_in_response              -- Method to check if response has error</span>

<span class="sd">    get_count_from_json()                   -- Gets the value of numFound in json response of solr</span>

<span class="sd">    create_url_and_get_response()           -- Gets response of url</span>

<span class="sd">    update_field()                          -- Updates specified field having specified content id</span>

<span class="sd">    subtract_retention_time()               -- Subtracts the specified number of days from given date deleted time</span>

<span class="sd">    _validate_retention()                   -- Helper method to validate retention</span>

<span class="sd">CVSolr:</span>

<span class="sd">    set_cvsolr_base_url()                   -- Set the base url for cvsolr queries</span>

<span class="sd">    is_job_played()                         -- Check if job has started playing</span>

<span class="sd">    check_all_items_played_successfully()   -- Check if playback was successfully completed</span>

<span class="sd">    validate_retention()                    -- Method to validate retention</span>


<span class="sd">    Example of solr queries:</span>

<span class="sd">    To get all the items present in a collection</span>
<span class="sd">    http://localhost:20000/solr/sharepointindex_backupset_GUID_multinode/select?q=*:*</span>

<span class="sd">    To get items count where job id is 123</span>
<span class="sd">    http://localhost:20000/solr/sharepointindex_backupset_GUID_multinode/select?q=JobId:7538</span>

<span class="sd">    To update a field in Solr</span>
<span class="sd">    http://localhost:20000/solr/sharepointindex_backupset_GUID_multinode/update?&amp;commit=true&amp;wt=json</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>


<div class="viewcode-block" id="SolrHelper"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper">[docs]</a><span class="k">class</span> <span class="nc">SolrHelper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to execute solr related operations &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o365_object</span><span class="p">,</span> <span class="n">search_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the Solr object</span>
<span class="sd">            Args:</span>
<span class="sd">                o365_object(object)      -- instance of the SharePoint/CloudConnector object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_o365_object</span> <span class="o">=</span> <span class="n">o365_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o365_object</span><span class="o">.</span><span class="n">tc_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_details</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">search_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_attrib_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">o365_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns SharePoint/CloudConnector object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_o365_object</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of details of index servers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_details</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index_server_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">index_servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">index_server</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_details</span> <span class="o">=</span> <span class="n">index_server_object</span><span class="o">.</span><span class="n">properties</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_details</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return base url for solr queries&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span>

    <span class="nd">@base_url</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns id of client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns id of client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span>

<div class="viewcode-block" id="SolrHelper.set_cvsolr_base_url"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.set_cvsolr_base_url">[docs]</a>    <span class="k">def</span> <span class="nf">set_cvsolr_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set the base url of the cvsolr</span>
<span class="sd">            Raises:</span>
<span class="sd">                Exception if error in parsing xml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting the base url for solr queries&quot;</span><span class="p">)</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="p">[</span><span class="s2">&quot;cIServerURL&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">/solr/&#39;</span>
            <span class="n">backupset_guid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backupSetEntity&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;backupsetGUID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s1">sharepointindex_</span><span class="si">{</span><span class="n">backupset_guid</span><span class="si">}</span><span class="s1">_multinode/</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s1">?&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Base url for solr queries is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred. Check if index server is down. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.check_cvods_running"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.check_cvods_running">[docs]</a>    <span class="k">def</span> <span class="nf">check_cvods_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if CVODS is running on the index server</span>
<span class="sd">            Returns:</span>
<span class="sd">                True if CVODS is running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if CVODS is launched&quot;</span><span class="p">)</span>
            <span class="n">machine_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">machine_name</span> <span class="o">=</span> <span class="n">machine_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">commcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">commcell</span>
            <span class="n">remote_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">remote_machine</span><span class="o">.</span><span class="n">is_process_running</span><span class="p">(</span><span class="s2">&quot;CVODS&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CVODS is running&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;CVODS is not launched. Will check again after 1 min&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while checking cvods status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.check_all_items_played_successfully"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.check_all_items_played_successfully">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_items_played_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get the total count of items in SharePoint/CloudConnector Collection</span>
<span class="sd">            Returns:</span>
<span class="sd">                Total Count of items in SharePoint/CloudConnector Collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Method Not Implemented by the Child Class&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SolrHelper.get_number_of_items_in_backup_job"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.get_number_of_items_in_backup_job">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_of_items_in_backup_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set the solr search query</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id for which number of items is required</span>

<span class="sd">            Returns:</span>
<span class="sd">                Number of items in the provided job id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Getting number of items in job </span><span class="si">%s</span><span class="s2"> from database&quot;</span> <span class="o">%</span>
                <span class="n">job_id</span><span class="p">)</span>
            <span class="n">query_string</span> <span class="o">=</span> <span class="s2">&quot;select totalNumOfFiles from JMBkpStats Where jobId=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">job_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_string</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Number of items in job </span><span class="si">%s</span><span class="s2"> is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Error in getting job details from database. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.create_solr_query"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.create_solr_query">[docs]</a>    <span class="k">def</span> <span class="nf">create_solr_query</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">select_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">op_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to create the solr query based on the params</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dictionary)     --  Dictionary containing search criteria and value</span>
<span class="sd">                                                Acts as &#39;q&#39; field in solr query</span>

<span class="sd">                attr_list(set)            --  Column names to be returned in results.</span>
<span class="sd">                                                Acts as &#39;fl&#39; in solr query</span>

<span class="sd">                op_params(dictionary)       --  Other params and values for solr query</span>
<span class="sd">                                                (Ex: start, no. of rows)</span>

<span class="sd">            Returns:</span>
<span class="sd">                The solr url based on params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating solr URL&quot;</span><span class="p">)</span>
            <span class="n">search_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;q=&#39;</span>
            <span class="n">simple_search</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">select_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">for</span> <span class="n">key_val</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                                    <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key_val</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s1">&#39;) AND &#39;</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">search_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; OR </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s2">&quot;) AND &quot;</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;keyword&quot;</span><span class="p">:</span>
                        <span class="n">search_query</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                        <span class="n">simple_search</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span> <span class="o">+</span> \
                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1"> AND &#39;</span>

            <span class="k">if</span> <span class="n">simple_search</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Search query: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">search_query</span><span class="p">)</span>
            <span class="n">field_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">attr_list</span><span class="p">:</span>
                <span class="n">field_query</span> <span class="o">=</span> <span class="s2">&quot;&amp;fl=&quot;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attr_list</span><span class="p">:</span>
                    <span class="n">field_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">,&#39;</span>
                <span class="n">field_query</span> <span class="o">=</span> <span class="n">field_query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Field query formed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">field_query</span><span class="p">)</span>
            <span class="n">ex_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">op_params</span><span class="p">:</span>
                <span class="n">op_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wt&#39;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op_params</span><span class="p">[</span><span class="s1">&#39;wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">op_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ex_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&amp;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex_query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&amp;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Optional parameters are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ex_query</span><span class="p">)</span>

            <span class="n">final_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">search_query</span><span class="si">}{</span><span class="n">field_query</span><span class="si">}{</span><span class="n">ex_query</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">final_url</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while creating solr query: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

    <span class="k">def</span> <span class="nf">_is_job_played</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if job has started playing or not. Should be called from CVSolr class</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dict)  -- Dictionary of keyword and job_id</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if job is not played after 5 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span>
                <span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="n">new_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">tot_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">old_cnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">tot_time</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">old_cnt</span> <span class="o">==</span> <span class="n">new_cnt</span> <span class="ow">and</span> <span class="n">new_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Job has started playing. Waiting 30 secs to check again&quot;</span><span class="p">)</span>
                <span class="n">old_cnt</span> <span class="o">=</span> <span class="n">new_cnt</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">new_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job is not played&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job has started playing: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">solr_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while checking if job was played. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span>

    <span class="k">def</span> <span class="nf">_check_all_items_played_successfully</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if all items in a job were played successfully. Should be called via</span>
<span class="sd">        check_all_items_played_successfully method in SolrStandalone or SolrCloud</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dict)   -- Dictionary of backup job keyword and datatype</span>

<span class="sd">                job_id(int)         -- Job id</span>

<span class="sd">                attr_list(set)     -- Attribute list to return, Will return the</span>
<span class="sd">                    Default(None)      default_attrib_list by default(Works as fl in Solr)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details about all the items in that job if true</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if the job was not played after 10 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span>
                <span class="n">select_dict</span><span class="o">=</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="n">solr_url</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">index_new_num_file_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">index_old_num_file_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">job_num_file_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_of_items_in_backup_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="n">tot_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">job_num_file_count</span> <span class="o">-</span> <span class="n">index_new_num_file_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tot_time</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Total number of files played(</span><span class="si">%d</span><span class="s2">) is not equal to total items in &quot;</span>
                    <span class="s2">&quot;job(</span><span class="si">%d</span><span class="s2">). Waiting for 1 minute and retrying&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">index_new_num_file_count</span><span class="p">,</span> <span class="n">job_num_file_count</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index_new_num_file_count</span> <span class="o">!=</span> <span class="n">index_old_num_file_count</span><span class="p">:</span>
                    <span class="n">index_old_num_file_count</span> <span class="o">=</span> <span class="n">index_new_num_file_count</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="n">index_new_num_file_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                    <span class="n">tot_time</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_error_in_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="n">index_new_num_file_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index_new_num_file_count</span> <span class="o">==</span> <span class="n">index_old_num_file_count</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job is not played&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job </span><span class="si">%s</span><span class="s2"> was successfully played.&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while checking if job was successfully played. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span>

<div class="viewcode-block" id="SolrHelper.check_if_error_in_response"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.check_if_error_in_response">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_error_in_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if response has error</span>
<span class="sd">            Args:</span>
<span class="sd">                response(obj)         --  Response Object</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if response was error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Error in calling solr URL. Reason </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Error in the solr URL. Reason </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span>
                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.get_count_from_json"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.get_count_from_json">[docs]</a>    <span class="k">def</span> <span class="nf">get_count_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return the numFound in any json_string</span>
<span class="sd">            Args:</span>
<span class="sd">                json_string(string)  -- String representation of output solr json</span>

<span class="sd">            Returns:</span>
<span class="sd">                count of numFound</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">][</span><span class="s1">&#39;numFound&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception in method &#39;get_count_from_json&#39; while parsing json to &quot;</span>
                <span class="s2">&quot;get result count&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.create_url_and_get_response"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.create_url_and_get_response">[docs]</a>    <span class="k">def</span> <span class="nf">create_url_and_get_response</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">select_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">op_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">http_request</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="n">request_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to get results from a url</span>
<span class="sd">            Args:</span>
<span class="sd">                select_dict(dictionary)         --  Dictionary containing search criteria and</span>
<span class="sd">                                                    value. Acts as &#39;q&#39; field in solr query</span>

<span class="sd">                attr_list(set)                  --  Criteria to filter results. Acts as &#39;fl&#39; in</span>
<span class="sd">                                                    solr query</span>

<span class="sd">                op_params(dictionary)           --  Other params and values for solr query. Do not</span>
<span class="sd">                                                    mention &#39;wt&#39; param as it is always json</span>
<span class="sd">                                                    (Ex: start, rows)</span>

<span class="sd">                http_request (str)              --  Type of http request</span>

<span class="sd">                request_json (dict)             --  Request json if it is post request</span>

<span class="sd">            Returns:</span>
<span class="sd">                content of the response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">solr_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_solr_query</span><span class="p">(</span>
                <span class="n">select_dict</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">,</span> <span class="n">op_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;URL formed from the details provided is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="n">solr_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">http_request</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">http_request</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request_json</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">solr_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_json</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Request json is not provided for post request&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Request json is not provided for post request&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.update_field"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.update_field">[docs]</a>    <span class="k">def</span> <span class="nf">update_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_id</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates specified field having specified content id</span>

<span class="sd">            Args:</span>

<span class="sd">                content_id(str)                --  content id of the item</span>
<span class="sd">                Example: &quot;c8d2d2ebab2a86290f37cd6ae2ecba91!0c6932ab50bf08fa68596dacb6259f8d</span>

<span class="sd">                field_name(str)                --  Name of the field to be updated</span>

<span class="sd">                field_value                    --  Value of the field to be updated</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request_json</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="s2">&quot;contentid&quot;</span><span class="p">:</span> <span class="n">content_id</span><span class="p">,</span>
                <span class="n">field_name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="n">field_value</span>
                <span class="p">}</span>
            <span class="p">}]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cvsolr_base_url</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;update&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span><span class="n">op_params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span> <span class="n">http_request</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
                                                        <span class="n">request_json</span><span class="o">=</span><span class="n">request_json</span><span class="p">)</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;responseHeader&#39;</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> field with value </span><span class="si">{</span><span class="n">field_value</span><span class="si">}</span><span class="s2"> is changed for content id </span><span class="si">{</span><span class="n">content_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error occured while updating </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> field for content id </span><span class="si">{</span><span class="n">content_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error occured while updating </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> field for content id </span><span class="si">{</span><span class="n">content_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while updating </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">field &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="SolrHelper.subtract_retention_time"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.SolrHelper.subtract_retention_time">[docs]</a>    <span class="k">def</span> <span class="nf">subtract_retention_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_deleted_unix_time</span><span class="p">,</span> <span class="n">num_of_days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subtracts the specified number of days from given date deleted time</span>

<span class="sd">            Args:</span>

<span class="sd">                date_deleted_unix_time(int)    --  Unix Time of &#39;DateDeletedAsInt&#39; field</span>
<span class="sd">                                                   Example: 1608610925</span>

<span class="sd">                num_of_days(int)               --  Number of days to be subtracted from &#39;DateDeletedAsInt&#39; field</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date deleted Unix time: </span><span class="si">{</span><span class="n">date_deleted_unix_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">date_deleted_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">date_deleted_unix_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date deleted time: </span><span class="si">{</span><span class="n">date_deleted_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">subtracted_data_deleted_time</span> <span class="o">=</span> <span class="n">date_deleted_time</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">num_of_days</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subtracted date deleted time: </span><span class="si">{</span><span class="n">subtracted_data_deleted_time</span><span class="si">}</span><span class="s2"> after subtracting </span><span class="si">{</span><span class="n">num_of_days</span><span class="si">}</span><span class="s2"> from&quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;date deleted time&quot;</span><span class="p">)</span>
            <span class="n">subtracted_data_deleted_unix_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">subtracted_data_deleted_time</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subtracted date deleted Unix time: </span><span class="si">{</span><span class="n">subtracted_data_deleted_unix_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">subtracted_data_deleted_unix_time</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred subtracting retention time from date deleted time &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

    <span class="k">def</span> <span class="nf">_validate_retention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items_dict</span><span class="p">,</span> <span class="n">select_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to validate retention</span>
<span class="sd">            Args:</span>

<span class="sd">                 items_dict (dict)           --     Dictionary of backed up items along with their retention period</span>

<span class="sd">                    Example:</span>
<span class="sd">                    For SharePoint:</span>

<span class="sd">                        {</span>
<span class="sd">                            &#39;https://cvidc365.sharepoint.com/sites/TestSite1&#39;: 365,</span>
<span class="sd">                            &#39;https://cvidc365.sharepoint.com/sites/TestSite2&#39;: -1</span>
<span class="sd">                        }</span>

<span class="sd">                select_dict(dictionary)      --     Dictionary containing search criteria and value</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if retention is not validated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">op_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span>
                <span class="n">select_dict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;contentid&quot;</span><span class="p">,</span> <span class="s2">&quot;DateDeletedAsInt&quot;</span><span class="p">,</span> <span class="s2">&quot;IsVisible&quot;</span><span class="p">,</span> <span class="s2">&quot;Url&quot;</span><span class="p">],</span> <span class="n">op_params</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of items eligible for retention: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">solr_items</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">retention_period</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">items_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">solr_items</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">solr_items</span><span class="p">:</span>
                    <span class="n">new_date_deleted_as_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_retention_time</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;DateDeletedAsInt&quot;</span><span class="p">],</span> <span class="n">retention_period</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_field</span><span class="p">(</span><span class="n">content_id</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;contentid&quot;</span><span class="p">],</span>
                                      <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;DateDeletedAsInt&quot;</span><span class="p">,</span>
                                      <span class="n">field_value</span><span class="o">=</span><span class="n">new_date_deleted_as_int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o365_object</span><span class="o">.</span><span class="n">cvoperations</span><span class="o">.</span><span class="n">process_index_retention_rules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indexServerClientId&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cvsolr_base_url</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_url_and_get_response</span><span class="p">(</span>
                <span class="n">select_dict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;contentid&quot;</span><span class="p">,</span> <span class="s2">&quot;DateDeletedAsInt&quot;</span><span class="p">,</span> <span class="s2">&quot;IsVisible&quot;</span><span class="p">,</span> <span class="s2">&quot;Url&quot;</span><span class="p">],</span> <span class="n">op_params</span><span class="p">)</span>
            <span class="n">solr_items</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;docs&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">solr_items</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">solr_items</span><span class="p">:</span>
                    <span class="n">item_url</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">items_dict</span><span class="p">[</span><span class="n">item_url</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;IsVisible&quot;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is not validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is not validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">items_dict</span><span class="p">[</span><span class="n">item_url</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;IsVisible&quot;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is not validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retention is not validated for </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">json_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count_from_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total number of items not retained: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">json_num</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Retention not satisfied&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retention Validated&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while validating retention&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div>


<div class="viewcode-block" id="CVSolr"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.CVSolr">[docs]</a><span class="k">class</span> <span class="nc">CVSolr</span><span class="p">(</span><span class="n">SolrHelper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to execute cvsolr related operations &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o365_object</span><span class="p">,</span> <span class="n">search_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the cvsolr object</span>
<span class="sd">            Args:</span>
<span class="sd">                o365_object(object)      -- instance of the SharePoint/CloudConnector object</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CVSolr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">o365_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">search_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_cvsolr_base_url</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">search_url</span>

<div class="viewcode-block" id="CVSolr.is_job_played"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.CVSolr.is_job_played">[docs]</a>    <span class="k">def</span> <span class="nf">is_job_played</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if job has started playing or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if job is not played after 5 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if job </span><span class="si">%s</span><span class="s2"> started playing&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_job_played</span><span class="p">({</span><span class="s2">&quot;JobId&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="CVSolr.check_all_items_played_successfully"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.CVSolr.check_all_items_played_successfully">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_items_played_successfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check if all items in the job were successfully played or not.</span>
<span class="sd">            Args:</span>
<span class="sd">                job_id(int)        -- Job id</span>

<span class="sd">                attr_list(set)     -- Attribute list to return, Will return the</span>
<span class="sd">                    Default(None)      default_attrib_list by default(Works as fl in Solr)</span>

<span class="sd">            Returns:</span>
<span class="sd">                Details about all the items in that job if playback was successful</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception if the job was not played after 10 mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if job </span><span class="si">%s</span><span class="s2"> was played successfully&quot;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_all_items_played_successfully</span><span class="p">({</span><span class="s2">&quot;JobId&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">},</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">attr_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="CVSolr.validate_retention"><a class="viewcode-back" href="../../../source/Application.Office365.html#Application.Office365.solr_helper.CVSolr.validate_retention">[docs]</a>    <span class="k">def</span> <span class="nf">validate_retention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to validate retention</span>

<span class="sd">            Args:</span>

<span class="sd">                items_dict (dict)       -- Dictionary of backed up items along with their retention period</span>
<span class="sd">                Example:</span>
<span class="sd">                For SharePoint:</span>

<span class="sd">                    {</span>
<span class="sd">                        &#39;https://cvidc365.sharepoint.com/sites/TestSite1&#39;: 365,</span>
<span class="sd">                        &#39;https://cvidc365.sharepoint.com/sites/TestSite2&#39;: -1</span>
<span class="sd">                    }</span>



<span class="sd">            Raises:</span>
<span class="sd">                Exception if retention is not valid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validating Retention for client : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_retention</span><span class="p">(</span><span class="n">items_dict</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;DateDeletedAsInt&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;[* TO *]&#39;</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while validating retention&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>