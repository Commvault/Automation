

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Application.CloudStorage.google_storage_helper &mdash; Commvault Automation 11.22 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Application.CloudStorage.google_storage_helper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Application.CloudStorage.google_storage_helper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main Class for performing Google Cloud storage operations</span>

<span class="sd">    This File has one class : GoogleObjectStorage</span>

<span class="sd">    GoogleObjectStorage: Helper to perform operations/manipulations on google cloud object storage</span>

<span class="sd">    __init__()                              --  initializes googleobjectstorage object</span>

<span class="sd">    google_helper_cleanup()                 --  Removes temp directories created</span>
<span class="sd">                                                during google cloud object initialization</span>

<span class="sd">    google_connect()                        --  Establishes connection to google object storage</span>
<span class="sd">                                                and return google storage  object</span>

<span class="sd">    file_generator()                        --  Method to generate files with</span>
<span class="sd">                                                random string content</span>

<span class="sd">    list_buckets()                          --  Lists all buckets available in given google cloud</span>

<span class="sd">    check_if_bucket_exist()                 --  To check if given bucket exists or not</span>

<span class="sd">    create_google_subclient()               --  Creates subclient with given content under</span>
<span class="sd">                                                given google instance</span>

<span class="sd">    create_bucket()                         --  To create bucket in google object storage</span>

<span class="sd">    get_bucket()                            --  Returns bucket object with given name if it exists</span>

<span class="sd">    delete_bucket()                         --  Delete given google Bucket</span>

<span class="sd">    list_objects()                          --  To list all blobs inside given bucket</span>

<span class="sd">    download_single_item()                  --  To download object from given bucket</span>

<span class="sd">    upload_single_item()                    --  To upload single item to given bucket</span>

<span class="sd">    delete_blob()                           --  To delete blob from cloud bucket</span>

<span class="sd">    delete_folder_in_cloud()                --  To delete a subfolder inside the google bucket</span>

<span class="sd">    get_blob_size()                         --  Returns size of given blob in cloud</span>

<span class="sd">    populate_data()                         --  populate basic set of data in google cloud</span>

<span class="sd">    download_google_bucket()                --  Download entire google bucket</span>

<span class="sd">    upload_folder_to_cloud()                --  Upload folder to given google bucket</span>

<span class="sd">    get_google_secret_key()                 --  Returns google instance secret key for given instance</span>

<span class="sd">    upload_files_to_bucket()                --  To upload files directly under google bucket</span>

<span class="sd">    google_restore_overwrite_validation()   --  To perform in-place restore with overwrite</span>
<span class="sd">                                                to google and validating the same</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">google.cloud</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">cvhelper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="kn">import</span> <span class="n">OptionsSelector</span>
<span class="kn">from</span> <span class="nn">Application.CloudApps</span> <span class="kn">import</span> <span class="n">exception</span>


<div class="viewcode-block" id="GoogleObjectStorage"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage">[docs]</a><span class="k">class</span> <span class="nc">GoogleObjectStorage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for performing admin level operation for Google Cloud Storage&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the GoogleObjectStorage object.</span>

<span class="sd">            Args:</span>

<span class="sd">                    testcase_object  (Object)  --  instance of Test case class</span>

<span class="sd">            Returns:</span>

<span class="sd">                    object  --  instance of Google Object Storage class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testcase_object</span> <span class="o">=</span> <span class="n">testcase_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_inputs</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">tcinputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_storage_helper</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">cloud_storage_helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_inputs</span><span class="p">[</span><span class="s2">&quot;key_file_path&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_folder_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;GoogleTemp_</span><span class="si">{0}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
            <span class="n">constants</span><span class="o">.</span><span class="n">TEMP_DIR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_folder_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span>
                                                <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">automation_directory</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AUTOMATION_DIRECTORY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">testcase_object</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">google_connect</span><span class="p">()</span>

<div class="viewcode-block" id="GoogleObjectStorage.google_helper_cleanup"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.google_helper_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">google_helper_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To remove temp directories created</span>
<span class="sd">        during google helper object initialization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.google_connect"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.google_connect">[docs]</a>    <span class="k">def</span> <span class="nf">google_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establishes connection to google object storage</span>
<span class="sd">        and return google storage  object</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to create google storage connection</span>
<span class="sd">                due to missing entries in json file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GOOGLE_APPLICATION_CREDENTIALS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_file_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred while creating google storage object&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">CVCloudException</span><span class="p">(</span>
                <span class="s1">&#39;CloudConnector&#39;</span><span class="p">,</span> <span class="s1">&#39;101&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">google_exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.file_generator"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.file_generator">[docs]</a>    <span class="k">def</span> <span class="nf">file_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_directory_path</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to generate files with random string content</span>

<span class="sd">        Args:</span>
<span class="sd">            local_directory_path    (str)       --  path to local directory for file generation</span>

<span class="sd">            count                   (int)       --  number of files to be generated</span>
<span class="sd">                                                    default : 10</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                <span class="n">local_directory_path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_testfile.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">content_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">))</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span>
                <span class="n">content_string</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.list_buckets"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.list_buckets">[docs]</a>    <span class="k">def</span> <span class="nf">list_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists all available buckets in given google object storage</span>

<span class="sd">        Args:</span>

<span class="sd">            prefix  (str)   --  filter results to buckets whose</span>
<span class="sd">                                names begin with this prefix</span>
<span class="sd">                                default : None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (list)  -    returns list of available buckets</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if its fails to fetch the list of buckets</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;List Bucket Method&quot;</span><span class="p">)</span>
            <span class="n">bucket_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">bucket_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bucket_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred while fetching the google bucket list&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.check_if_bucket_exists"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.check_if_bucket_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_bucket_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To check if given bucket exists or not</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)   --  name of the bucket to be checked</span>

<span class="sd">        Returns:</span>

<span class="sd">            (bool)      -       returns true if bucket exists else false</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check if given </span><span class="si">%s</span><span class="s2"> bucket exists&quot;</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">check_if_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">lookup_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_if_exists</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.create_google_subclient"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.create_google_subclient">[docs]</a>    <span class="k">def</span> <span class="nf">create_google_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_name</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates subclient with given content under given sybase instance</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_name  (str)  -- name of subclient to be created</span>

<span class="sd">            content         (list) -- list of buckets for content</span>

<span class="sd">        Returns:</span>
<span class="sd">            (obj)   -   subclient object created</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get storage policy of default subclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fetching SP&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_name</span><span class="p">)</span>
        <span class="n">default_subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;got subclient object&quot;</span><span class="p">)</span>
        <span class="n">storage_policy</span> <span class="o">=</span> <span class="n">default_subclient</span><span class="o">.</span><span class="n">storage_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fetched SP&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">has_subclient</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;subclient with name:</span><span class="si">%s</span><span class="s2"> already exists.deleting&quot;</span><span class="p">,</span>
                <span class="n">subclient_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">)</span>

        <span class="c1"># create subclient with this bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating subclient object&quot;</span><span class="p">)</span>
        <span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">subclient_name</span><span class="p">,</span> <span class="n">storage_policy</span><span class="p">)</span>
        <span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">return</span> <span class="n">subclient</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.create_bucket"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.create_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">create_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To create bucket in google object storage</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)   --  name of the bucket to be created</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to create bucket</span>

<span class="sd">                if bucket with same name exists</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">lookup_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_if_exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Bucket with given name doesn&#39;t exists . so creating the bucket&quot;</span><span class="p">)</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bucket </span><span class="si">%s</span><span class="s2"> created&quot;</span><span class="p">,</span> <span class="n">bucket</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The bucket matching the name provided exists already&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Bucket with same name already exists in cloud&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.get_bucket"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.get_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns bucket object with given name if it exists</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)       --      name of bucket to be fetched</span>

<span class="sd">        Returns:</span>

<span class="sd">            (object)    -   object of google bucket class</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if bucket is not found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bucket</span>
        <span class="k">except</span> <span class="n">google</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Given bucket does not exist!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.delete_bucket"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.delete_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">delete_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To delete given bucket</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)   --      name of the bucket to be deleted</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if deletion of bucket fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_bucket_exists</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to delete bucket. its exists in cloud&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bucket deleted successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred during bucket deletion: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">google_exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.list_objects"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.list_objects">[docs]</a>    <span class="k">def</span> <span class="nf">list_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To list all blobs inside given bucket</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)   --  name of bucket whose objects to be listed</span>

<span class="sd">        Returns:</span>

<span class="sd">            (list)      -       list of objects inside given bucket</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to list the blobs/objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">blobs</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">()</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">blobs</span><span class="p">:</span>
                <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blob</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">objects</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;issue in listing the blobs of given bucket: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">google_exception</span><span class="p">))</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.download_single_object"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.download_single_object">[docs]</a>    <span class="k">def</span> <span class="nf">download_single_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">bucket_name</span><span class="p">,</span>
            <span class="n">source_blob</span><span class="p">,</span>
            <span class="n">destination_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To download object from given bucket</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name         (str)   --  name of bucket in cloud</span>

<span class="sd">            source_blob         (str)   --  name of object to be downloaded</span>

<span class="sd">            destination_file    (str)   --  destination file name in which object will be downloaded</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to download the object/blob</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">source_blob</span><span class="p">)</span>
            <span class="n">blob</span><span class="o">.</span><span class="n">download_to_filename</span><span class="p">(</span><span class="n">destination_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Blob </span><span class="si">%s</span><span class="s1"> downloaded to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">source_blob</span><span class="p">,</span>
                <span class="n">destination_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to download the object : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">google_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.upload_single_item"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.upload_single_item">[docs]</a>    <span class="k">def</span> <span class="nf">upload_single_item</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">bucket_name</span><span class="p">,</span>
            <span class="n">source_file_name</span><span class="p">,</span>
            <span class="n">destination_blob_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To upload given file bucket</span>

<span class="sd">        Args:</span>
<span class="sd">                bucket_name              (str)   --     name of bucket in cloud</span>

<span class="sd">                source_file_name         (str)   --     name of file to be uploaded with full path</span>

<span class="sd">                destination_blob         (str)   --     destination blob name which</span>
<span class="sd">                                                        will uploaded in cloud</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to upload the object/blob</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">destination_blob_name</span><span class="p">)</span>
            <span class="n">blob</span><span class="o">.</span><span class="n">upload_from_filename</span><span class="p">(</span><span class="n">source_file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> uploaded as blob </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                <span class="n">destination_blob_name</span><span class="p">,</span>
                <span class="n">source_file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to upload the object : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">google_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.delete_blob"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.delete_blob">[docs]</a>    <span class="k">def</span> <span class="nf">delete_blob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To delete blob from cloud bucket</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket_name         (str)       --      name of cloud bucket in</span>
<span class="sd">                                                    which object to be deleted exists</span>

<span class="sd">            blob_name           (str)       --      name of blob/object to be deleted from cloud</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if deletion of object fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">)</span>
            <span class="n">blob</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">delete_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Deletion of cloud blob failed due to : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delete_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.delete_folder_in_cloud"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.delete_folder_in_cloud">[docs]</a>    <span class="k">def</span> <span class="nf">delete_folder_in_cloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">subfolder_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To delete a subfolder inside the google bucket</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket_name         (str)       --      name of the bucket inside which</span>
<span class="sd">                                                    subfolder to be deleted resides</span>

<span class="sd">            subfolder_prefix    (str)       --      prefix of subfolder to be deleted</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails during deletion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">subfolder_prefix</span><span class="p">):</span>
                <span class="n">blob</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">delete_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Deletion of cloud blob failed due to : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delete_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.get_blob_size"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.get_blob_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_blob_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">blob_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns size of given blob in cloud</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket_name         (str)       --      name of bucket in cloud</span>

<span class="sd">            blob_name           (str)       --      name of blob whose size to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">            (int)   -   size of blob in cloud bucket</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails to fetch the blob size</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_blob</span><span class="p">(</span><span class="n">blob_name</span><span class="p">)</span>
            <span class="n">blob_size</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">size</span>
            <span class="k">return</span> <span class="n">blob_size</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred while fetching blob size : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">google_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.populate_data"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.populate_data">[docs]</a>    <span class="k">def</span> <span class="nf">populate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">local_directory_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to populate data to cloud for testing</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket_name             (str)       --      name of bucket in cloud</span>

<span class="sd">            local_directory         (str)       --      local directory containing source files</span>

<span class="sd">            local_directory_path    (str)       --      path of local directory to be uploaded</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_directory_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span>
                                                                <span class="n">local_directory_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_directory_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_directory_path</span><span class="p">)</span>

        <span class="c1"># generate files to upload to cloud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_generator</span><span class="p">(</span><span class="n">local_directory_path</span><span class="o">=</span><span class="n">local_directory_path</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Create bucket</span>
        <span class="n">check_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_bucket_exists</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">check_status</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bucket not existing&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

        <span class="c1"># Upload test files to created bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_folder_to_cloud</span><span class="p">(</span>
            <span class="n">bucket_name</span><span class="p">,</span>
            <span class="n">local_directory_name</span><span class="p">,</span>
            <span class="n">local_directory_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_directory_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_directory_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.download_google_bucket"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.download_google_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">download_google_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">base_folder_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Downloads bucket from Google cloud</span>
<span class="sd">            Args:</span>
<span class="sd">                    bucket_name         (str)       --      name of bucket in cloud</span>

<span class="sd">                    base_folder_name    (str)       --      name of folder to which</span>
<span class="sd">                                                            bucket has to be downloaded</span>

<span class="sd">            Raises :</span>
<span class="sd">                Exception :</span>
<span class="sd">                    if it fails to  download container</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span> <span class="n">base_folder_name</span><span class="p">)</span>
        <span class="n">current_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">blob</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">list_blobs</span><span class="p">():</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;blob name :</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">local_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                    <span class="n">local_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="c1"># local_filename = &quot;{0}{1}{2}&quot;.format(</span>
                <span class="c1">#     local_path, self.controller_object.os_sep, filename)</span>
                <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blob</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Folder object in cloud&quot;</span><span class="p">)</span>
                    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blob</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">test_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">head</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test_path : </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_path</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">tail</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;it is directory object.creating new directory&quot;</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">test_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;creating directory and then downloading  the item&quot;</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">test_path</span><span class="p">)</span>
                            <span class="n">local_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                                <span class="n">test_path</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
                            <span class="c1"># local_file = &quot;{0}{1}{2}&quot;.format(test_path, self.controller_object.os_sep, tail)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">download_single_object</span><span class="p">(</span>
                                <span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">local_file</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;parent directory exists already&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                            <span class="n">test_path</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">download_single_object</span><span class="p">(</span>
                            <span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;single object download&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">download_single_object</span><span class="p">(</span>
                            <span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">local_filename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The specified container does not exist on the cloud </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to download container due to :</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">google_exception</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.upload_folder_to_cloud"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.upload_folder_to_cloud">[docs]</a>    <span class="k">def</span> <span class="nf">upload_folder_to_cloud</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">bucket_name</span><span class="p">,</span>
            <span class="n">local_folder_name</span><span class="p">,</span>
            <span class="n">local_folder_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To upload a folder to google cloud</span>

<span class="sd">        Args:</span>
<span class="sd">            bucket_name         (str)       --      name of bucket in cloud</span>

<span class="sd">            local_folder_name   (str)       --      name of local directory</span>

<span class="sd">            local_folder_path   (str)       --      path of local directory to be uploaded</span>

<span class="sd">        Raises</span>
<span class="sd">            Exception</span>
<span class="sd">                if it fails during upload operation to cloud</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_storage</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="c1"># dummy file creation to create sub folder in cloud</span>
            <span class="n">dummy_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                <span class="n">local_folder_path</span><span class="p">,</span> <span class="s2">&quot;dummy.txt&quot;</span><span class="p">)</span>
            <span class="n">file_pointer</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dummy_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">file_pointer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">local_folder_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;local folder exists . Uploading it to cloud&quot;</span><span class="p">)</span>
                <span class="n">destination_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_folder_name</span><span class="p">)</span>
               <span class="c1">#  destination_folder = &quot;{0}&quot;.format(local_folder_name, self.controller_object.os_sep)</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">destination_folder</span><span class="p">)</span>
                <span class="n">blob</span><span class="o">.</span><span class="n">upload_from_filename</span><span class="p">(</span><span class="n">dummy_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Folder created successfully&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dummy_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Lets upload the items of local folder&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_folder_path</span><span class="p">):</span>
                    <span class="n">source_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                        <span class="n">local_folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">destination_blob_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">destination_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">upload_single_item</span><span class="p">(</span>
                        <span class="n">bucket_name</span><span class="p">,</span> <span class="n">source_file_name</span><span class="p">,</span> <span class="n">destination_blob_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">google_exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to upload the object : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">google_exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.get_google_secret_key"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.get_google_secret_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_google_secret_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns google instance secret key for given instance</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str)       --      returns google instance secret key</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception</span>
<span class="sd">                if failed to get secret key from csdb</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;select attrVal from app_instanceprop where(componentnameid=</span><span class="si">{0}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;and attrName in (&#39;Google Cloud Cloud Password&#39;))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query2</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">google_secret_key</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get the sybase user password&quot;</span>
                <span class="s2">&quot;for given instance from commserve database&quot;</span><span class="p">)</span>
        <span class="n">google_secret_key</span> <span class="o">=</span> <span class="n">cvhelper</span><span class="o">.</span><span class="n">format_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">google_secret_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">google_secret_key</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.upload_files_to_bucket"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.upload_files_to_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">upload_files_to_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To upload files directly under google bucket</span>

<span class="sd">        Args:</span>

<span class="sd">            bucket_name     (str)       --      name of bucket in google</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span> <span class="s2">&quot;single_files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># generate files to upload to cloud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_generator</span><span class="p">(</span><span class="n">local_directory_path</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># self.file_generator(local_directory_path=local_path, count=10)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="n">source_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                <span class="n">local_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upload_single_item</span><span class="p">(</span>
                <span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">source_file_name</span><span class="p">,</span>
                <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleObjectStorage.google_restore_overwrite_validation"><a class="viewcode-back" href="../../../source/Application.CloudStorage.html#Application.CloudStorage.google_storage_helper.GoogleObjectStorage.google_restore_overwrite_validation">[docs]</a>    <span class="k">def</span> <span class="nf">google_restore_overwrite_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">subclient</span><span class="p">,</span>
                                            <span class="n">bucket_name</span><span class="p">,</span>
                                            <span class="n">original_data_path</span><span class="p">,</span>
                                            <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To perform in-place restore with overwrite to google and validating the same</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient           (object)    --      object of subclient class</span>

<span class="sd">            bucket_name         (str)       --      name of bucket in google cloud</span>

<span class="sd">            original_data_path  (str)       --      path where originals contents are downloaded</span>

<span class="sd">            overwrite           (bool)      --      unconditional overwrite files during restore</span>
<span class="sd">                                                    default: False</span>
<span class="sd">        Returns:</span>

<span class="sd">            (bool)      -       returns True if restore validation succeeds</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception</span>
<span class="sd">                if restore validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;original path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">overwrite_option</span> <span class="o">=</span> <span class="s2">&quot;overwrite only if file in media is newer&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overwrite_option</span> <span class="o">=</span> <span class="s2">&quot;unconditional overwrite&quot;</span>

        <span class="c1"># now mark one file for overwrite testing</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>
        <span class="n">version_1</span> <span class="o">=</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;version_1: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version_1</span><span class="p">))</span>

        <span class="c1"># make changes to version_1 file and save it as version_2</span>
        <span class="n">versions_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span>
                                                        <span class="s2">&quot;versions_dir&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">versions_dir</span><span class="p">)</span>
        <span class="n">version_1_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">original_data_path</span><span class="p">,</span> <span class="n">version_1</span><span class="p">)</span>
        <span class="n">version_2_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">versions_dir</span><span class="p">,</span> <span class="n">version_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;version1 path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version_1_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;version2 path : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">versions_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">version_1_path</span><span class="p">,</span> <span class="n">versions_dir</span><span class="p">)</span>

        <span class="c1"># add new contents to version_2 file</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="o">.</span><span class="n">get_custom_str</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">version_2_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_2</span><span class="p">:</span>
            <span class="n">file_2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_line</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">file_2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># now upload version_2 file to cloud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_single_item</span><span class="p">(</span>
            <span class="n">bucket_name</span><span class="p">,</span>
            <span class="n">version_2_path</span><span class="p">,</span>
            <span class="n">version_1</span><span class="p">)</span>

        <span class="c1"># in-place restore to google cloud without overwrite option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restore to google </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">overwrite_option</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_storage_helper</span><span class="o">.</span><span class="n">cloud_apps_restore</span><span class="p">(</span><span class="n">subclient</span><span class="o">=</span><span class="n">subclient</span><span class="p">,</span>
                                                     <span class="n">restore_type</span><span class="o">=</span><span class="s2">&quot;in_place&quot;</span><span class="p">,</span>
                                                     <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="c1"># download that modified file and compare with version_1 and version_2</span>
        <span class="n">restored_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_dir_path</span><span class="p">,</span> <span class="s2">&quot;restored_file.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">download_single_object</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span>
                                    <span class="n">version_1</span><span class="p">,</span>
                                    <span class="n">restored_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;successfully downloaded subclient&quot;</span>
                      <span class="s2">&quot; contents to local file system after restore&quot;</span><span class="p">)</span>

        <span class="c1"># validate restore</span>
        <span class="n">version_1_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">compare_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="p">,</span>
                                                                <span class="n">version_1_path</span><span class="p">,</span>
                                                                <span class="n">restored_file</span><span class="p">)</span>

        <span class="n">version_2_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="o">.</span><span class="n">compare_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller_object</span><span class="p">,</span>
                                                                <span class="n">version_2_path</span><span class="p">,</span>
                                                                <span class="n">restored_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;overwrite details before validation : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="p">)</span>
            <span class="n">validation_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">version_1_result</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">version_2_result</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;overwrite details before validation : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="p">)</span>
            <span class="n">validation_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">version_1_result</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">version_2_result</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;File restored with </span><span class="si">{0}</span><span class="s2"> failed in validation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overwrite_option</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File restored and passed validation&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">versions_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Version directory is removed successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>