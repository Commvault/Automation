

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testcases.54835 &mdash; Commvault Automation 11.23 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Testcases.54835</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Testcases.54835</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>


<span class="sd">&quot;&quot;&quot;&quot;Main file for executing this test case</span>

<span class="sd">TestCase is the only class defined in this file.</span>

<span class="sd">TestCase: Class for executing this test case</span>

<span class="sd">TestCase:</span>
<span class="sd">    __init__()      --  initialize TestCase class</span>

<span class="sd">    setup()         --  setup function of this test case</span>

<span class="sd">    run()           --  run function of this test case</span>

<span class="sd">    tear_down()     --  tear down function of this test case</span>

<span class="sd">Steps :</span>
<span class="sd">    Aim : TC should be able to run on all types of libraries and for target number of volumes [ eg. 1000 ]</span>
<span class="sd">    1. Configure test environment - Library (if not given), Dedup Storage Policy, Backupset and Subclient</span>
<span class="sd">    2. Set subclient properties to use 4 streams, start new media &amp; mark Media Full on Success.</span>
<span class="sd">    3. Generate different sized content from 1 GB to 5 GB for each of the 3 iterations of backups and run backups.</span>
<span class="sd">    4. Reset start new media &amp; mark Media Full on Success and run 2 more jobs with content size from 2 GB to 5 GB</span>
<span class="sd">    5. Get a list of all volumes and verify RMSpareStatusUpdateTime is 24 hours ahead</span>
<span class="sd">    6. Fetch physical size of each volume</span>
<span class="sd">    7. Modify RMSpareStatusUpdateTime to current time - 86400</span>
<span class="sd">    8. Modify MM Admin Thread time to 5 mins and wait for MM thread invocation to happen</span>
<span class="sd">    9. Verify MM logs have volume update logs for each of the volumes</span>
<span class="sd">    10. Verify volume size is updated in MMVolume table</span>
<span class="sd">    11. Validate physical volume size fetched in earlier step matches with size in MMVolume table</span>
<span class="sd">    12. Verify that RMSpareStatusUpdateTime for all the volumes gets updated to -1</span>

<span class="sd">    Sample Input:</span>
<span class="sd">    	&quot;54835&quot;: {</span>
<span class="sd">					&quot;ClientName&quot;: &quot;sbhideautodrive&quot;,</span>
<span class="sd">					&quot;AgentName&quot;: &quot;File System&quot;,</span>
<span class="sd">					&quot;MediaAgentName&quot;: &quot;sbhideautoma1&quot;,</span>
<span class="sd">					&quot;ExistingLibraryName&quot;: &quot;VolumeUpdatesStoragePool&quot;,</span>
<span class="sd">					&quot;ExistingStoragePolicyName&quot;: &quot;None&quot;</span>
<span class="sd">			}</span>
<span class="sd">	Please make sure that MediaAgentName is a datamover MA for ExistingLibraryName.</span>
<span class="sd">	Possible Combinations for (ExistingLibraryName, ExistingStoragePolicyName) tuple are</span>
<span class="sd">	i.  (None, None) =&gt; Both will be created &amp; deleted at the end of successful execution</span>
<span class="sd">	ii. (LibraryName, None) =&gt; New SP will be created using LibraryName, only new SP will be deleted at the</span>
<span class="sd">	    end of successfull execution</span>
<span class="sd">	iii. (None, StoragePolicyName) =&gt; StoragePolicy will be used, no entities will be delted at the end of</span>
<span class="sd">	    successful execution</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="kn">import</span> <span class="n">OptionsSelector</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.cvtestcase</span> <span class="kn">import</span> <span class="n">CVTestCase</span>
<span class="kn">from</span> <span class="nn">MediaAgents.MAUtils.mahelper</span> <span class="kn">import</span> <span class="n">DedupeHelper</span><span class="p">,</span> <span class="n">MMHelper</span>
<span class="kn">from</span> <span class="nn">Web.API.customreports</span> <span class="kn">import</span> <span class="n">WebConsoleCREngine</span>

<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">CVTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for executing this test case&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes test case class object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;volume size update: backup scenario&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;MediaAgentName&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;ExistingLibraryName&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;ExistingStoragePolicyName&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_library_drive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkpset_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_helper_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_physical_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm_admin_thread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_update_interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="TestCase.setup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup function of this test case&quot;&quot;&quot;</span>
        <span class="n">optionobj</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ExistingLibraryName&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ExistingStoragePolicyName&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">timestamp_suffix</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="o">.</span><span class="n">get_custom_str</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span> <span class="o">=</span> <span class="n">optionobj</span><span class="o">.</span><span class="n">get_drive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_library_drive</span> <span class="o">=</span> <span class="n">optionobj</span><span class="o">.</span><span class="n">get_drive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span>  <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="s2">&quot;Lib_TC_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No library name provided, new library [</span><span class="si">%s</span><span class="s2">] will be created&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma_library_drive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s2">&quot;SP_TC_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma_library_drive</span><span class="p">,</span> <span class="s2">&quot;DDBs&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;TC</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">timestamp_suffix</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storage Policy Name </span><span class="si">%s</span><span class="s2"> given. If it exists, it will be reused.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Existing Storage Policy Name provided by user does not exist. Treating as &quot;</span>
                               <span class="s2">&quot;configuration error and exiting...&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;User provided storage policy [</span><span class="si">%s</span><span class="s2">] does not exist, please correct the &quot;</span>
                                <span class="s2">&quot;inputs/configuration and re-run the testcase.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="s2">&quot;BkpSet_TC_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="s2">&quot;Subc_TC_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCase.configure_tc_environment"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.configure_tc_environment">[docs]</a>    <span class="k">def</span> <span class="nf">configure_tc_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure testcase environment - library (if required), storage policy, backupset, subclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===STEP: Configuring TC Environment===&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_mm_admin_thread_frequency</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_helper_obj</span> <span class="o">=</span> <span class="n">DedupeHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting already existing content directory [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating mountpath directory [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Library [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">has_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library [</span><span class="si">%s</span><span class="s2">] already exists. Reusing the Library.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span><span class="o">.</span><span class="n">configure_disk_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mountpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Library [</span><span class="si">%s</span><span class="s2">] created successfully.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping Library creation as user has provided Library [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if user provided Library exists&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">has_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;User Provided Library does not exist. Erroring out.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;User Provided Library [</span><span class="si">%s</span><span class="s2">] does not exist. Please provide correct library name&quot;</span><span class="o">%</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Storage Policy [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_helper_obj</span><span class="o">.</span><span class="n">configure_dedupe_storage_policy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully configured Storage Policy [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Backupset [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkpset_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span><span class="o">.</span><span class="n">configure_backupset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully configured Backupset [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring Subclient [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully configured Subclient [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting Number of Streams to 4 and Allow Multiple Data Readers to True&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modify_subclient_properties</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.modify_subclient_properties"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.modify_subclient_properties">[docs]</a>    <span class="k">def</span> <span class="nf">modify_subclient_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_streams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multiple_readers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify subclient properties like number of streams and allow multiple data readers&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            num_streams (int) - Number of streams</span>
<span class="sd">            multiple_readers(boolean) - Boolean value for setting multiple data readers value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_streams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting number of streams to [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">num_streams</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">data_readers</span> <span class="o">=</span> <span class="n">num_streams</span>
        <span class="k">if</span> <span class="n">multiple_readers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting multiple data readers to [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">multiple_readers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">allow_multiple_readers</span> <span class="o">=</span> <span class="n">multiple_readers</span></div>

<div class="viewcode-block" id="TestCase.generate_data_run_backup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.generate_data_run_backup">[docs]</a>    <span class="k">def</span> <span class="nf">generate_data_run_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_in_gb</span><span class="p">,</span> <span class="n">backup_type</span><span class="o">=</span><span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="n">mark_media_full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate subclient content and run given type of backup on subclient</span>
<span class="sd">        Args:</span>
<span class="sd">            size_in_gb (int)      -- Content Size in GB</span>
<span class="sd">            backup_type (str)     -- Backup Type [ Full or Incremental etc. ]</span>
<span class="sd">            mark_media_full(bool) -- Boolean Flag to decide if volumes are to be marked full after backup completion</span>
<span class="sd">        Return:</span>
<span class="sd">            Returns job object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating content of size [</span><span class="si">%s</span><span class="s2">] at location [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">size_in_gb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mahelper_obj</span><span class="o">.</span><span class="n">create_uncompressable_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">,</span> <span class="n">size_in_gb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mark_media_full</span><span class="p">:</span>
            <span class="n">job_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span> <span class="n">advanced_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mediaOpt&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;startNewMedia&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully initiated a [</span><span class="si">%s</span><span class="s2">] backup job on subclient with jobid [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">,</span>
                      <span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Backup job [</span><span class="si">%s</span><span class="s2">] did not complete in given timeout&quot;</span> <span class="o">%</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully completed the backup job with jobid [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">job_obj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_volumes_for_jobs"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_volumes_for_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_volumes_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates volumes to which list of jobs have written their chunks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_list</span><span class="p">]</span>
        <span class="n">job_ids</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobs_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching volumes to which following jobs have written chunks - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select volumeid from mmvolume where volumeid in (&quot;</span> \
                <span class="s2">&quot;select volumeid from archchunk where id in (&quot;</span> \
                <span class="s2">&quot;select archchunkid from archchunkmapping where jobid in (&quot;</span> \
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">)))&quot;</span><span class="o">%</span><span class="n">job_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">volumes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volumes_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;List of volumes fetched from CSDB - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCase.get_volume_update_time"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_volume_update_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume_update_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns value in RMSpareStatusUpdateTime column against each volume provided in list</span>
<span class="sd">        Args:</span>
<span class="sd">            volume_list (List Obj) - List of volume IDs</span>
<span class="sd">        Return:</span>
<span class="sd">            A dictionary having RMSpareStatusUpdateTime for each volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching RMSpareStatusUpdateTime for following volumes - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume_list</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select volumeid, RMSpareStatusUpdateTime from mmvolume where volumeid in (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">volume_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">update_time_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RMSpareStatusUpdateTime for volumes - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">update_time_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">update_time_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_sql_connection"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_sql_connection">[docs]</a>    <span class="k">def</span> <span class="nf">get_sql_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SQL connection object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlobj</span> <span class="o">=</span> <span class="n">WebConsoleCREngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">webconsole_hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">auth_token</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCase.set_volume_update_time"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.set_volume_update_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_volume_update_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_list</span><span class="p">,</span> <span class="n">time_to_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets value of RMSpareStatusUpdateTime to given time for each volume in the list</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_list (List)  :   List of volume IDs</span>
<span class="sd">            time_to_set (int)   :   Time value to set in the RMSpareStatusUpdateTime column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="k">if</span> <span class="n">time_to_set</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting RMSpareStatusUpdateTime to [</span><span class="si">%s</span><span class="s2">] for following volumes - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                      <span class="n">time_to_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">volume_list</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update mmvolume set RMSpareStatusUpdateTime = RMSPareStatusUpdateTime </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> where volumeid in (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span>\
                <span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time_to_set</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">volume_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlobj</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RMSpareStatusUpdateTime updated to [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">time_to_set</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_volume_physical_size"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_volume_physical_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get physical size of each volume from mountpath</span>
<span class="sd">        Args:</span>
<span class="sd">            volume_list (List) : List of volume IDs</span>

<span class="sd">        Return:</span>
<span class="sd">            Dictionary containing volume and its physical size on disk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Get physical location of the volume</span>
        <span class="n">volume_path_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">volume_physical_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ma_name_obj_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching physical location of volumes in volume list : [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">volume_list</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select MMV.volumeid, MMDC.folder, MNTPATH.MountPathName, CL.name &quot;</span> \
                <span class="s2">&quot;from MMMountpath MNTPATH, MMDeviceController MMDC, MMMountPathToStorageDevice MMPS, MMVOLUME MMV &quot;</span> \
                <span class="s2">&quot;, App_Client CL where MMPS.MountPathId = MMV.CurrMountPathId and &quot;</span> \
                <span class="s2">&quot;MNTPATH.MountPathId = MMV.CurrMountPathId and CL.id = MMDC.clientid &quot;</span> \
                <span class="s2">&quot; and MMDC.deviceid = MMPS.DeviceId and MMV.volumeid in (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">volume_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1">#Now work out the path for each of the volume and fetch its size</span>
        <span class="n">physical_location_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

        <span class="c1">#volumeid	folder	    MountPathName	        client</span>
        <span class="c1">#111799	    C:\\54835	R3BGE3_07.01.2020_04.55	winma1pdcauto</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">volumeid</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">mountpath</span><span class="p">,</span> <span class="n">clientname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">physical_location_list</span><span class="p">:</span>
            <span class="n">volume_path_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%s%s%s%s</span><span class="s2">V_</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="n">mountpath</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="s2">&quot;CV_MAGNETIC&quot;</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine_obj</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="n">volumeid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching physical size of volume [</span><span class="si">%s</span><span class="s2">] from location - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">volumeid</span><span class="p">,</span>
                          <span class="n">volume_path_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">])</span>

            <span class="c1">#Create machine object of MA and store in dictionary as we may need it many times</span>
            <span class="k">if</span> <span class="n">clientname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ma_name_obj_dict</span><span class="p">:</span>
                <span class="n">ma_name_obj_dict</span><span class="p">[</span><span class="n">clientname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">clientname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

            <span class="c1">#Get physical size in bytes</span>
            <span class="n">volume_physical_size_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ma_name_obj_dict</span><span class="p">[</span><span class="n">clientname</span><span class="p">]</span><span class="o">.</span><span class="n">get_folder_size</span><span class="p">(</span>
                <span class="n">volume_path_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">volume_physical_size_dict</span></div>

<div class="viewcode-block" id="TestCase.get_volume_csdb_size"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_volume_csdb_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume_csdb_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches volume size from PhysicalBytesMB column of MMVolume Table</span>
<span class="sd">        Args:</span>
<span class="sd">            volume_list (List of strings)  : List of volumes</span>

<span class="sd">        Return:</span>
<span class="sd">            Dictionary containing volume as key and PhysicalBytesMB as value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">volume_csdb_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching PhysicalBytesMB column value for volumes - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">volume_list</span><span class="p">))</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select volumeid, PhysicalBytesMB from MMVolume where volumeid in (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">volume_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">volume_size_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="ow">in</span> <span class="n">volume_size_list</span><span class="p">:</span>
            <span class="n">volume_csdb_size_dict</span><span class="p">[</span><span class="n">vol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">volume_csdb_size_dict</span></div>

<div class="viewcode-block" id="TestCase.set_mmconfigs_param_value"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.set_mmconfigs_param_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_mmconfigs_param_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set value for param in MMCOnfigs table</span>
<span class="sd">        Args:</span>
<span class="sd">            param (str) -- Parameter whose value is to be set</span>
<span class="sd">            value (int) -- MM admin thread frequency in minutes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting MMConfigs Param [</span><span class="si">%s</span><span class="s2">] value to [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMConfigs set value=</span><span class="si">%s</span><span class="s2">, nmin=</span><span class="si">%s</span><span class="s2"> where &quot;</span> \
                <span class="s2">&quot;name = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlobj</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCase.get_mm_admin_thread_frequency"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.get_mm_admin_thread_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">get_mm_admin_thread_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get MM Admin Thread frequency and set the class variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting MM Admin Thread frequency&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select name, value from MMConfigs where name in &quot;</span> \
                <span class="s2">&quot;(&#39;MMS2_CONFIG_MM_MAINTAINENCE_INTERVAL_MINUTES&#39;, &quot;</span> \
                <span class="s2">&quot;&#39;MMS2_CONFIG_MAGNETIC_VOLUME_SIZE_UPDATE_INTERVAL_MINUTES&#39;)&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MMS2_CONFIG_MM_MAINTAINENCE_INTERVAL_MINUTES&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current MM Admin Thread value - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mm_admin_thread</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current Volume Update Interval Value - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume_update_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.wait_for_mm_thread_invocation"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.wait_for_mm_thread_invocation">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_mm_thread_invocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sleep for MM Thread invocation for given amount of time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for </span><span class="si">%s</span><span class="s2"> minutes for MM Admin Thread invocation&quot;</span><span class="p">,</span> <span class="n">mins</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">mins</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.validate_volume_update"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.validate_volume_update">[docs]</a>    <span class="k">def</span> <span class="nf">validate_volume_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">physical_size_dict</span><span class="p">,</span> <span class="n">csdb_size_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that physical volume size and csdb volume size are same for a volume.</span>
<span class="sd">        Also validate that RMSpareStatusUpdateTime is set to -1 for all the volumes.</span>

<span class="sd">        Args:</span>
<span class="sd">            physical_size_dict (dictionary obj) - dictionary containing volume &amp; its physical size</span>
<span class="sd">            csdb_size_dict (dictionary obj)     - dictionary containing volume &amp; its csdb size</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fail_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">volumeid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VolumeID [</span><span class="si">%s</span><span class="s2">] - Physical Size [</span><span class="si">%s</span><span class="s2">] - CSDB Size [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">volumeid</span><span class="p">,</span>
                          <span class="n">physical_size_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">],</span> <span class="n">csdb_size_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">physical_size_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">]</span> <span class="o">!=</span> <span class="n">csdb_size_dict</span><span class="p">[</span><span class="n">volumeid</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;FAILURE: VolumeID [</span><span class="si">%s</span><span class="s2">] =&gt; Physical Size &amp; CSDB Size does not match&quot;</span><span class="p">,</span> <span class="n">volumeid</span><span class="p">)</span>
                <span class="n">fail_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUCCES: VolumeID [</span><span class="si">%s</span><span class="s2">] =&gt; PHysical Size &amp; CSDB Size matches&quot;</span><span class="p">,</span> <span class="n">volumeid</span><span class="p">)</span>

        <span class="c1">#Check RMSpareStatusUpdateTime for volumes</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select volumeid, RMSpareStatusUpdateTime from mmvolume where &quot;</span> \
                <span class="s2">&quot;RMSpareStatusUpdateTime &lt;&gt; -1 and volumeid in (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Query =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">vol_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">fail_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;FAILURE : RMSpareStatusUpdateTime of following volumes is &quot;</span>
                           <span class="s2">&quot;not set to -1 - [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vol_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUCCESS: Verified that RMSpareStatusUpdateTime for all volumes is set to -1&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fail_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Some volumes failed volume size update validation. Please see logs for more details.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Volume size update validation failure&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.clean_test_environment"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.clean_test_environment">[docs]</a>    <span class="k">def</span> <span class="nf">clean_test_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up test environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting BackupSet&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">has_backupset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Failure in deleting backupset during cleanup. &quot;</span>
                          <span class="s2">&quot;Treating as soft failure as backupset will be reused***&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting Storage Policy&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keeping storage policy intact as it was a user provided storage policy&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Failure in deleting storage policy during cleanup. &quot;</span>
                          <span class="s2">&quot;Treating as soft failure as stroage policy will be reused***&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_lib</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting Library&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">has_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keeping library intact as it was a user provided library&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Failure in deleting library during cleanup. &quot;</span>
                          <span class="s2">&quot;Treating as soft failure as library will be reused***&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine_obj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted the Content Directory.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Content directory does not exist.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.run"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run function of this test case&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_test_environment</span><span class="p">()</span>
            <span class="c1">#STEP : Configure TC environment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_sql_connection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure_tc_environment</span><span class="p">()</span>

            <span class="c1">#STEP : Run 3 Backups</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_data_run_backup</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1">#STEP : Run Full/Incremental/Differential/SynthFull Backups</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_data_run_backup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_data_run_backup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_data_run_backup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Differential&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_data_run_backup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Synthetic_Full&quot;</span><span class="p">)</span>


            <span class="c1">#STEP : Fetch all the volumes to which the above jobs have written data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes_for_jobs</span><span class="p">()</span>

            <span class="c1">#STEP : Get physical size of volumes from mountpath</span>
            <span class="n">volumes_physical_size_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_physical_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mmconfigs_param_value</span><span class="p">(</span><span class="s1">&#39;MMS2_CONFIG_MM_MAINTAINENCE_INTERVAL_MINUTES&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1">#STEP : Set RMSpareStatusUpdateTime to current time - 1 day and Volume Update Interval to 15 mins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_volume_update_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">86400</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mmconfigs_param_value</span><span class="p">(</span><span class="s1">&#39;MMS2_CONFIG_MAGNETIC_VOLUME_SIZE_UPDATE_INTERVAL_MINUTES&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_mm_thread_invocation</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

            <span class="c1">#STEP : Fetch volume size from CSDB</span>
            <span class="n">volumes_csdb_size_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume_csdb_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mmconfigs_param_value</span><span class="p">(</span><span class="s1">&#39;MMS2_CONFIG_MM_MAINTAINENCE_INTERVAL_MINUTES&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_admin_thread</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_mmconfigs_param_value</span><span class="p">(</span><span class="s1">&#39;MMS2_CONFIG_MAGNETIC_VOLUME_SIZE_UPDATE_INTERVAL_MINUTES&#39;</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">volume_update_interval</span><span class="p">)</span>

            <span class="c1">#Validate that volume size on Mountpath and in CSDB are same and RMSpareStatusUpdateTime is set to -1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_volume_update</span><span class="p">(</span><span class="n">volumes_physical_size_dict</span><span class="p">,</span> <span class="n">volumes_csdb_size_dict</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SUCCESS : Test case completed successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to execute test case with error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TestCase.tear_down"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54835.TestCase.tear_down">[docs]</a>    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tear down function of this test case&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not performing cleanup as test case has failed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up Tescase Environment&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_test_environment</span><span class="p">()</span></div></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>