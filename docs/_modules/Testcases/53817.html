

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testcases.53817 &mdash; Commvault Automation 11.18 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Testcases.53817</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Testcases.53817</h1><div class="highlight"><pre>
<span></span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.cvtestcase</span> <span class="k">import</span> <span class="n">CVTestCase</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">win32wnet</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">HyperScale.HyperScaleUtils</span> <span class="k">import</span> <span class="n">esxManagement</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="kn">import</span> <span class="nn">winreg</span>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">CVTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TEST_CASE_NAME&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_to_user</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">PASSED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_string</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">NO_REASON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">automation_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automation_dir</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">HyperScale</span><span class="se">\\</span><span class="s2">HyperScaleUtils&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">automation_dir</span> <span class="o">+</span> \
                                      <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">HyperScale</span><span class="se">\\</span><span class="s2">HyperScaleUtils</span><span class="se">\\</span><span class="s2">pre_ova_generation&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_utils_location</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_custom_package_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md5_checksum_file</span> <span class="o">=</span> <span class="s2">&quot;c:</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">md5.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_system32_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_ova_path</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">cvhcics.ova&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;run_export_ova&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;snapshot_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;manage_via_snapshots&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;run_deploy&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;install_win_updates&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;export_updated_snapshot&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;run_configure&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;clientMachineUser&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;customPackageCreation_URL&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;customPackageLocation&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;esxHostIP&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;esxHostUser&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;esxHostPassword&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;esxDatacenterName&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;esxDataStorename&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;vm_vmdkPath&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;vm_ovfPath&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;run_delete_vm&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;final_machine_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;final_loc_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;final_loc_user&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;final_loc_pass&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

<div class="viewcode-block" id="TestCase.setup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup function of this test case&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span> <span class="o">=</span> <span class="n">esxManagement</span><span class="o">.</span><span class="n">EsxManagement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esxHostIP&quot;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esxHostUser&quot;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esxHostPassword&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestCase.reinitialize_esx"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.reinitialize_esx">[docs]</a>    <span class="k">def</span> <span class="nf">reinitialize_esx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is to just re-initialize the object for esx server.</span>
<span class="sd">        Seems like when performing time consuming operations,</span>
<span class="sd">        the object times out in the backend and needs to be reinitialized</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCase.open_connection"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.open_connection">[docs]</a>    <span class="k">def</span> <span class="nf">open_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will be moved to a different file.</span>
<span class="sd">        I am keeping it here since we have yet to create a utils for hyperscale.</span>
<span class="sd">        This will open a windows connection to the remote machine</span>
<span class="sd">        so that packages can be transferred.</span>

<span class="sd">        Note:</span>
<span class="sd">        Common methods in the Machine class are not working.</span>
<span class="sd">        I tried several of the methods of the class and none of them seem to be working.</span>
<span class="sd">        Will use them once those are in working state</span>

<span class="sd">        :return: Either just returns or raises exception. NO return value as such</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">win32wnet</span><span class="o">.</span><span class="n">WNetAddConnection2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">],</span>
                                         <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Hostname </span><span class="si">%s</span><span class="s1">. Username </span><span class="si">%s</span><span class="s1">, pass </span><span class="si">%s</span><span class="s1">&#39;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="s1">&#39;64&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="ow">and</span> <span class="n">retry</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Open Connection failed. Will now retry one more time&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span></div>

<div class="viewcode-block" id="TestCase.modify_reg_key"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.modify_reg_key">[docs]</a>    <span class="k">def</span> <span class="nf">modify_reg_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">key_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to add needed registry keys on the deployed windowns VM before</span>
<span class="sd">        the CS can be installed</span>
<span class="sd">        :param key: registry key name</span>
<span class="sd">        :param sub_key: subkey name</span>
<span class="sd">        :param value: value of  the sub key</span>
<span class="sd">        :param key_type: type of the key</span>

<span class="sd">        :return: True if successful | False if failed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">ConnectRegistry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">],</span> <span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hKey</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">winreg</span><span class="o">.</span><span class="n">KEY_WOW64_64KEY</span> <span class="o">+</span> <span class="n">winreg</span><span class="o">.</span><span class="n">KEY_ALL_ACCESS</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">winreg</span><span class="o">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="s2">&quot;SOFTWARE\CommVault Systems\Galaxy\Installer\Data&quot;</span><span class="p">)</span>
                <span class="n">hKey</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">OpenKey</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">winreg</span><span class="o">.</span><span class="n">KEY_WOW64_64KEY</span> <span class="o">+</span> <span class="n">winreg</span><span class="o">.</span><span class="n">KEY_ALL_ACCESS</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;dword&#39;</span><span class="p">:</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">REG_DWORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">REG_SZ</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reg key value modified-- cs,key:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span>
                                  <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">sub_key</span> <span class="o">+</span> <span class="s1">&#39; to:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;dword&#39;</span><span class="p">:</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">)</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">REG_DWORD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key_type</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">)</span>
                    <span class="n">winreg</span><span class="o">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">hKey</span><span class="p">,</span> <span class="n">sub_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">REG_SZ</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reg key value not found. Created new -- cs,key:&#39;</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">sub_key</span> <span class="o">+</span> <span class="s1">&#39; to:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">WindowsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TestCase.transfer_files"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.transfer_files">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This will transfer the necessary packages to the remote machine for</span>
<span class="sd">        custom package installation. I am using shutil for the transfer</span>

<span class="sd">        Note:</span>
<span class="sd">        Common methods in the Machine class are not working.</span>
<span class="sd">        I tried several of the methods of the class and none of them seem to be working.</span>
<span class="sd">        Will use them once those are in working state</span>
<span class="sd">        :return: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">()</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        machine_obj = Machine(machine_name=self.tcinputs[&quot;clientMachineHostname&quot;],</span>
<span class="sd">                              commcell_object=None, username=self.tcinputs[&quot;clientMachineUser&quot;],</span>
<span class="sd">                              password=self.tcinputs[&quot;clientMachinePassword&quot;])</span>
<span class="sd">        machine_obj.create_registry(&quot;HKEY_LOCAL_MACHINE\SOFTWARE\CommVault Systems\Galaxy\Installer\Data&quot;,</span>
<span class="sd">                                    &quot;szFTPCacheDir&quot;, &quot;c:\ApplianceInstall\ContentStore&quot;)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modify_reg_key</span><span class="p">(</span><span class="s2">&quot;SOFTWARE\CommVault Systems\Galaxy\Installer\Data&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;szFTPCacheDir&quot;</span><span class="p">,</span> <span class="s2">&quot;c:\ApplianceInstall\ContentStore&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>

        <span class="c1"># copying the batch files needed for unzip and install</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully created remote directory </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully created remote directory </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span><span class="p">)</span>

        <span class="n">ignore_patterns</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span><span class="s1">&#39;CVS*&#39;</span><span class="p">,</span> <span class="s1">&#39;*cache*&#39;</span><span class="p">,</span> <span class="s1">&#39;*.py&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">installPackage.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">postDeploy.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">preExport.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">install_windows_update.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">PS_WinUpdate.ps1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_system32_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Utilities copied&#39;</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># copying the custom package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will copy the custom package now. It may take a while.&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;customPackageLocation&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Custom package copied&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="TestCase.configure_machine"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.configure_machine">[docs]</a>    <span class="k">def</span> <span class="nf">configure_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This methods basically invokes the transferred batch files to</span>
<span class="sd">        1. Disable firewall, Windows defender</span>
<span class="sd">        2. Unzip the custom package transferred</span>
<span class="sd">        3. Install the CS package silently</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">()</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;psexec </span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> \
              <span class="sa">r</span><span class="s1">&#39; -u &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> \
              <span class="s1">&#39; -p &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span> <span class="o">+</span> \
              <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_utils_location</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">postDeploy.bat -accepteula&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Wil now disable firewall, Windows defender and Unzip Custom package&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20000</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Disabled Firewall and Windows defender&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unzipped Custom Package&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
        <span class="c1"># Install Custom package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will now install the Custom package&#39;</span><span class="p">)</span>
        <span class="n">start_install_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">install_cmd</span> <span class="o">=</span> <span class="s1">&#39;psexec </span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -u &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_utils_location</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">installPackage.bat -accepteula&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">install_cmd</span><span class="p">)</span>
        <span class="n">install_op</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">install_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="n">end_install_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">install_op</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CS package installed in </span><span class="si">%d</span><span class="s1"> minutes &#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">end_install_time</span> <span class="o">-</span> <span class="n">start_install_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">()</span>

        <span class="c1">#Create target directories</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># copying the driver</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">EvalLicSeal.exe&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">EvalLicSeal.exe&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">EvalLicUnSeal.exe&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">EvalLicUnSeal.exe&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">UpdateCSGUID.sqle&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">UpdateCSGUID.sqle&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully copied driver data to </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span><span class="p">))</span>

        <span class="c1"># copying the sysprep data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">ForSysprep.xml&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">ForSysprep.xml&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">sysprep.bat&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">sysprep.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">PsGetsid.exe&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">PsGetsid.exe&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">CleanUp.bat&quot;</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_preova_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">CleanUp.bat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully copied sysprep data to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.rdp"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.rdp">[docs]</a>    <span class="k">def</span> <span class="nf">rdp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically will be moved to a common utils or replaced by any existing util.</span>
<span class="sd">        As of now it is a batch file. Will be converted to a threaded function.</span>

<span class="sd">        What it does is basically initiates an RDP connection using the hostname,user and password.</span>
<span class="sd">        This is needed for a brand new machine or a rebooted because it needs a login in order</span>
<span class="sd">        to start a few windows services which are needed by the test</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">rdp.bat&quot;</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]))</span>

            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rdp batch file path: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperscale_utils_path</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">rdp.bat&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span></div>

<div class="viewcode-block" id="TestCase.get_process_id"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.get_process_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_process_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basicall gets the process ID of a process.</span>
<span class="sd">        Since the Machine class is not working.</span>
<span class="sd">        I had to write my own for being able to get process ID of mstsc</span>
<span class="sd">        :param process_name:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;.exe&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">process_name</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="n">process_name</span> <span class="o">+</span> <span class="s2">&quot;.exe&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;tasklist /FI &quot;imagename eq </span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">process_name</span>
            <span class="n">tasklist_output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;No tasks are running which match&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">tasklist_output</span><span class="p">):</span>
                <span class="c1"># means that no rdp sessions are running</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">final_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tasklist_output</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">t1</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;RDP&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;Console&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="n">t1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span></div>

<div class="viewcode-block" id="TestCase.install_windows_update"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.install_windows_update">[docs]</a>    <span class="k">def</span> <span class="nf">install_windows_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically contains the invoking of the batc file which runs</span>
<span class="sd">        the powershell update command.</span>
<span class="sd">        Once initiated, code then waits for the output of the batch file and</span>
<span class="sd">        reads the windows update report from system32 folder.</span>
<span class="sd">        Based on that we check if updates were installed or not. Also if it needs a reboot</span>

<span class="sd">        :return: True (if updates were installed) | False (if no updates)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">update_install_cmd</span> <span class="o">=</span> <span class="s1">&#39;psexec </span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -u &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> \
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_utils_location</span> <span class="o">+</span> \
                      <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">install_windows_update.bat -accepteula&#39;</span>
        <span class="n">update_install_op</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">update_install_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">update_install_op</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">batch_op_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">op.log&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">batch_op</span> <span class="o">=</span> <span class="n">batch_op_obj</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">batch_op_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">new_updates</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">reboot_required</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">downloaded_updates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">installed_updates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">batch_op</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;There are no applicable updates for this computer.&quot;</span> <span class="ow">in</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No new updates to be installed&#39;</span><span class="p">)</span>
                <span class="n">new_updates</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">new_updates</span><span class="p">:</span>
            <span class="n">update_output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_Report.txt&quot;</span><span class="p">):</span>
                    <span class="n">update_output_obj</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">update_output</span> <span class="o">=</span> <span class="n">update_output_obj</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">update_output_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">update_output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_system32_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_Report.txt&quot;</span><span class="p">):</span>
                        <span class="n">update_output_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_system32_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">update_output</span> <span class="o">=</span> <span class="n">update_output_obj</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                        <span class="n">update_output_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">update_output</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">update_output</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;Download Status: SUCCESS&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Latest updates downloaded successfully&#39;</span><span class="p">)</span>
                        <span class="n">downloaded_updates</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s2">&quot;Update Installation Status: SUCCESS&quot;</span> <span class="ow">in</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Latest updates installed successfully&#39;</span><span class="p">)</span>
                        <span class="n">installed_updates</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="s2">&quot;reboot&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Update Requires reboot. Will reboot now&#39;</span><span class="p">)</span>
                        <span class="n">reboot_required</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="s2">&quot;Exception from HRESULT: 0x80248007&quot;</span> <span class="ow">in</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">t&quot;</span><span class="p">):</span>
                        <span class="n">update_cmd_fix</span> <span class="o">=</span> <span class="s1">&#39;psexec </span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="o">+</span> \
                                         <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -u &#39;</span> \
                                             <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> \
                                             <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span> <span class="o">+</span> \
                                         <span class="s1">&#39; net start msiserver -accepteula&#39;</span>
                        <span class="n">update_install_fix_op</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">update_cmd_fix</span><span class="p">,</span>
                                                                        <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">update_install_fix_op</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">downloaded_updates</span> <span class="o">!=</span> <span class="n">installed_updates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Not all updates were installed. Please check the logs &#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">update_output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to check if updates were installed or not.report missing&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">etime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Took </span><span class="si">%d</span><span class="s1"> minutes to process install updates process&#39;</span>
                          <span class="o">%</span> <span class="nb">int</span><span class="p">((</span><span class="n">etime</span> <span class="o">-</span> <span class="n">stime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reboot_required</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">let_windows_finish_update</span><span class="p">()</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            while self.esx_object.get_vm_power_state(self.tcinputs[&quot;vm_name&quot;]) != &#39;off&#39;:</span>
<span class="sd">                time.sleep(15)</span>
<span class="sd">                self.log.info(&#39;Waiting for MAchine to be OFF&#39;)</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">etime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Took </span><span class="si">%d</span><span class="s1"> minutes to process install updates process&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">((</span><span class="n">etime</span><span class="o">-</span><span class="n">stime</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TestCase.initialize_machine"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.initialize_machine">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically just gets the IP of the VM from the host by using hte vm name</span>
<span class="sd">        Then it initializes a rdp connection so as all windows modules are launched</span>
<span class="sd">        before we continue</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get IP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">get_vm_ip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not get the IP of machine. Exiting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IP of the deployed machine is: </span><span class="si">%s</span><span class="s1">&#39;</span>
                      <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]))</span>

        <span class="c1"># rdp into it</span>
        <span class="n">current_rdp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_process_id</span><span class="p">(</span><span class="s1">&#39;mstsc.exe&#39;</span><span class="p">)</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdp</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">end_rdp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_process_id</span><span class="p">(</span><span class="s1">&#39;mstsc.exe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initiated RDP connection&#39;</span><span class="p">)</span>
        <span class="n">rdp_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">end_rdp_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_rdp_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MSTSC process id is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rdp_id</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;taskkill /pid &#39;</span> <span class="o">+</span> <span class="n">rdp_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; /f&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killed RDP session&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.generate_paths"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.generate_paths">[docs]</a>    <span class="k">def</span> <span class="nf">generate_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically generates all the destination paths where all the files</span>
<span class="sd">        need to be copied for the CS install and post install processes</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remote_utils_location</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">utils&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_utils_location</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">utils&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_custom_package_location</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_local_custom_package_path</span> <span class="o">=</span> \
            <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">temp</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;customPackageLocation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_sysprep_path</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">System32</span><span class="se">\\</span><span class="s2">Sysprep&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_system32_path</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">System32&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_driver_path1</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">ApplianceInstall</span><span class="se">\\</span><span class="s2">Driver</span><span class="se">\\</span><span class="s2">Scripts&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_base_path</span> <span class="o">=</span> \
            <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">c$</span><span class="se">\\</span><span class="s2">Program Files</span><span class="se">\\</span><span class="s2">Commvault</span><span class="se">\\</span><span class="s2">ContentStore</span><span class="se">\\</span><span class="s2">Base&quot;</span></div>

<div class="viewcode-block" id="TestCase.copy_iso_to_target"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.copy_iso_to_target">[docs]</a>    <span class="k">def</span> <span class="nf">copy_iso_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to push the generated ova/iso file to the destination as requested</span>
<span class="sd">        sftp / paramiko is used to upload</span>

<span class="sd">        :return: True (if successful) | False (if not)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">paramiko</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_machine_name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">):</span>
                <span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_machine_name&quot;</span><span class="p">],</span>
                            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_loc_user&quot;</span><span class="p">],</span>
                            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_loc_pass&quot;</span><span class="p">])</span>
                <span class="n">sftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">get_channel</span><span class="p">()</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">11000</span><span class="p">)</span>
                <span class="n">temp_folder</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%b-%Y_%H_%M_%S&quot;</span><span class="p">)</span>
                <span class="n">remote_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_loc_path&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">temp_folder</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sftp</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created target directory </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remote_path</span><span class="p">)</span>
                    <span class="n">sftp</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Uploading ova file now...&#39;</span><span class="p">)</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_ova_path</span><span class="p">,</span>
                         <span class="n">remote_path</span> <span class="o">+</span> <span class="s1">&#39;/cvhcics.ova&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Uploading checksum file now &#39;</span><span class="p">)</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_checksum_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;final_loc_path&quot;</span><span class="p">]</span> <span class="o">+</span>
                         <span class="n">temp_folder</span> <span class="o">+</span> <span class="s1">&#39;/md5.txt&#39;</span><span class="p">)</span>
                <span class="n">sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping ova copy since no machine path provided&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to copy the ova to final directory. Please do so manually&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TestCase.let_windows_finish_update"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.let_windows_finish_update">[docs]</a>    <span class="k">def</span> <span class="nf">let_windows_finish_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically helps to figure out when the windows is done</span>
<span class="sd">        configuring windows after windows install updates has been completed.</span>
<span class="sd">        If it cannot figure out it ends the task after about 30 minutes</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will wait for windows to finishing installing updates&#39;</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;tasklist -S &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -U &quot;</span> <span class="o">+</span> \
                  <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -P &quot;</span> <span class="o">+</span> \
                  <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="mi">2880</span><span class="p">:</span>
            <span class="n">call_op</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">call_op</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="c1">#self.log.info(call_op)</span>
                <span class="c1">#TrustedInstaller.exe</span>
                <span class="k">if</span> <span class="s1">&#39;TiWorker&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call_op</span><span class="p">):</span> 
                    <span class="k">if</span> <span class="s1">&#39;winlogon&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call_op</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Machine is on its login page now.&#39;</span><span class="p">)</span>
                        <span class="n">update_done</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="s2">&quot;explorer&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">call_op</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Machine explorer process is running.&#39;</span><span class="p">)</span>
                        <span class="n">update_done</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1">#self.log.info(&#39;Windows finishing updates&#39;)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will keep looking for the logon or explorer process &#39;</span>
                              <span class="s1">&#39;on target machine&#39;</span><span class="p">)</span>
                <span class="c1">#self.log.info(str(call_op))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to verify the completion of install updates in 4 hours&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exiting update finish loop..&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.md5_hash"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.md5_hash">[docs]</a>    <span class="k">def</span> <span class="nf">md5_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This module basically calculates the MD5 hash value of the provided file</span>
<span class="sd">        :param file_name: File name whose checksum need to be calculated</span>

<span class="sd">        :return: MD5 checksum | empty string (if failure)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">hashlib</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10240</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="TestCase.run"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Run function of this test case&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;run_deploy&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">):</span>
                <span class="c1"># destroy vm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will delete if there is any vm by the name already&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">destroy_vm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">])</span>

                <span class="c1"># deploy ovf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">deploy_ovf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esxDatacenterName&quot;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esxDataStorename&quot;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;esx_cluster_name&quot;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_vmdkPath&quot;</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_ovfPath&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping Deployment step as instructed&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will use the suggested snapshot now&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;auto_choose&quot;</span><span class="p">:</span>
                        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;Windows_Updates_installed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]:</span>
                                <span class="n">op</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">latest</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please provide valid snapshot name.Exiting&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">latest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">latest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span><span class="o">.</span>
                                             <span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;Windows_Updates_installed_&quot;</span><span class="p">))</span>
                                <span class="n">latest_snap</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">latest</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span><span class="o">.</span>
                                                        <span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;Windows_Updates_installed_&quot;</span><span class="p">)):</span>
                                    <span class="n">latest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span><span class="o">.</span>
                                                 <span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;Windows_Updates_installed_&quot;</span><span class="p">))</span>
                                    <span class="n">latest_snap</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">latest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">revert_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span>
                                                                   <span class="n">latest_snap</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error selecting snapshot </span><span class="si">%s</span><span class="s1">&#39;</span>
                                               <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">latest_snap</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reverted to snapshot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">latest_snap</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not find any code created snapshot to revert to. &#39;</span>
                                          <span class="s1">&#39;Please provide a valid snapshot name&#39;</span>
                                          <span class="s1">&#39; to select it or pass &quot;None&quot;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">revert_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error selecting snapshot </span><span class="si">%s</span><span class="s1">&#39;</span>
                                           <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">])</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
            <span class="c1"># power ON machine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
            <span class="c1"># get IP and login to machine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_machine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">let_windows_finish_update</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>

            <span class="c1"># -----------------------------------------------------------</span>
            <span class="c1"># Will now generate paths since we now have the machine IP</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_paths</span><span class="p">()</span>
            <span class="c1"># Done generating paths</span>
            <span class="c1"># -----------------------------------------------------------</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;run_configure&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># open connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">()</span>

                <span class="c1"># transfer packages</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_files</span><span class="p">()</span>

                <span class="c1"># install windows update (conditional)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;install_win_updates&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will now install latest windows updates. This can take a while&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_windows_update</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New updates were installed. &#39;</span>
                                      <span class="s1">&#39;We will take a snapshot of the machine for future use&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;We will reset the machine once before taking &#39;</span>
                                      <span class="s1">&#39;a snapshot of it&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;off&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">let_windows_finish_update</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;manage_via_snapshots&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="n">snapshot_name</span> <span class="o">=</span> <span class="s1">&#39;Windows_Updates_installed_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">save_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="n">snapshot_name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Snapshot saved as: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">snapshot_name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;export_updated_snapshot&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># export updated blank windows to ovf</span>
                                <span class="n">output_path</span> <span class="o">=</span> \
                                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_vmdkPath&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">exported_updates_ovf_dir</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">export_vm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span>
                                                              <span class="n">output_path</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">updated_Windows_&quot;</span>
                                                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">exported_updates_ovf_dir</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exported updated windows machine as ovf&#39;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Issues while exporting updated windows vm. &#39;</span>
                                                 <span class="s1">&#39;will continue anyway&#39;</span><span class="p">)</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;on&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">let_windows_finish_update</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_machine</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping install updates as instructed&#39;</span><span class="p">)</span>

                <span class="c1"># configure machine and unzip package</span>
                <span class="c1"># install CS package</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configure_machine</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping Configuration step as instructed&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;run_export_ova&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_connection</span><span class="p">()</span>

                <span class="c1"># enable firewall, run FW exclusions, run eval license ,</span>
                <span class="c1"># run sysprep, delete sysprep data</span>
                <span class="c1"># remove temp directory, remove sysprep batfile, remove vmware tools</span>
                <span class="n">sysprep_cmd</span> <span class="o">=</span> <span class="s1">&#39;psexec </span><span class="se">\\\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineHostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -u &#39;</span> \
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachineUser&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; -p &#39;</span> \
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;clientMachinePassword&quot;</span><span class="p">]</span> <span class="o">+</span>\
                              <span class="s1">&#39; &quot;C:</span><span class="se">\\</span><span class="s1">Windows</span><span class="se">\\</span><span class="s1">System32</span><span class="se">\\</span><span class="s1">Sysprep</span><span class="se">\\</span><span class="s1">sysprep.bat&quot; -accepteula&#39;</span>
                <span class="n">sysprep_call_op</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sysprep_cmd</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executed sysprep batch file. op = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sysprep_call_op</span><span class="p">))</span>

                <span class="c1"># off VM</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

                <span class="c1">#remove adapter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">delete_all_nics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">])</span>

                <span class="c1"># export to ovf</span>
                <span class="n">exported_ovf_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">export_vm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">],</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">temp&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exported CS machine as ovf&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reinitialize_esx</span><span class="p">()</span>

                <span class="c1"># convert to ova</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">create_ova</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_ova_path</span><span class="p">,</span> <span class="n">exported_ovf_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Created OVA: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_ova_path</span><span class="p">))</span>

                <span class="c1"># calculate md5</span>
                <span class="n">md5_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created_ova_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">md5_value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not calculate md5 checksum of ova&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;md5 checksum of ova is: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">md5_value</span><span class="p">))</span>
                <span class="n">op</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5_checksum_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">op</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">md5_value</span><span class="p">)</span>
                <span class="n">op</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># Copy ova to final loc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_iso_to_target</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;run_delete_vm&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="c1"># destroy VM</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Will now destroy the VM&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">esx_object</span><span class="o">.</span><span class="n">destroy_vm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping VM delete as instructed&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping OVA EXPORT step as instructed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to execute test case with error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span></div>

<div class="viewcode-block" id="TestCase.tear_down"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.53817.TestCase.tear_down">[docs]</a>    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tear down function of this test case&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;End of test case&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>