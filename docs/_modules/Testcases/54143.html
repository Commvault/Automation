

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testcases.54143 &mdash; Commvault Automation 11.21 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Testcases.54143</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Testcases.54143</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;&quot;Main file for executing this test case</span>

<span class="sd">This testcase does indexing operations like playback, browse, restore, synthetic full and</span>
<span class="sd">compaction and prepares a report on the time taken between two service packs</span>

<span class="sd">TestCase:</span>
<span class="sd">    __init__()                  --  Initializes the TestCase class</span>

<span class="sd">    setup()                     --  All testcase objects are initializes in this method</span>

<span class="sd">    run()                       --  Contains the core testcase logic and it is the one executed</span>

<span class="sd">    test_playback()             --  Tests play</span>

<span class="sd">    tear_down()                 --  Cleans the data created for Indexing validation</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">commonutils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.cvtestcase</span> <span class="k">import</span> <span class="n">CVTestCase</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.database_helper</span> <span class="k">import</span> <span class="n">MSSQL</span>

<span class="kn">from</span> <span class="nn">Indexing.database</span> <span class="k">import</span> <span class="n">index_db</span>

<span class="kn">from</span> <span class="nn">cvpysdk.exception</span> <span class="k">import</span> <span class="n">SDKException</span>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">CVTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This testcase does indexing operations like playback, browse, restore, synthetic full and</span>
<span class="sd">    compaction and prepares a report on the time taken between two service packs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes test case class object&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Indexing - Performance test report&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_to_user</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;IndexServer&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;CSDBPassword&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_hostname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_db</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cl_machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cl_delim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;playback&#39;</span><span class="p">,</span> <span class="s1">&#39;browse&#39;</span><span class="p">,</span> <span class="s1">&#39;restore&#39;</span><span class="p">,</span> <span class="s1">&#39;synthetic_full&#39;</span><span class="p">,</span> <span class="s1">&#39;compaction&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_process_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_report</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;Full&#39;</span><span class="p">,</span>
            <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;Incremental&#39;</span><span class="p">,</span>
            <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="s1">&#39;Synthetic Full&#39;</span><span class="p">,</span>
            <span class="s1">&#39;16&#39;</span><span class="p">:</span> <span class="s1">&#39;Differential&#39;</span>
        <span class="p">}</span>

<div class="viewcode-block" id="TestCase.setup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All testcase objects are initializes in this method&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">perf_tests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tests&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">perf_tests</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="n">perf_tests</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cs_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs_hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_hostname</span>

            <span class="n">db_server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs_hostname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">Commvault&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cs_db</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span>
                <span class="n">db_server_name</span><span class="p">,</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CSDBPassword&#39;</span><span class="p">),</span> <span class="s1">&#39;CommServ&#39;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span>
                <span class="n">db_server_name</span><span class="p">,</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CSDBPassword&#39;</span><span class="p">),</span> <span class="s1">&#39;HistoryDB&#39;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">create_stats_table</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">isc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_server_change</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isc_delim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">os_sep</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span><span class="o">.</span><span class="n">service_pack</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">attempt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Attempt&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attempt</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skip_delete_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SkipDeleteDB&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SendReport&#39;</span><span class="p">,</span> <span class="s1">&#39;always&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">old_index_server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">index_server</span><span class="o">.</span><span class="n">client_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldest_cycle_etime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oldest_cycle_time</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">get_last_two_sps</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.run"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Contains the core testcase logic and it is the one executed&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started executing </span><span class="si">{0}</span><span class="s1"> testcase&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running following performance tests </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current attempt ID: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attempt</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current Index server: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_index_server_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Index Server service pack: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_report</span> <span class="o">==</span> <span class="s1">&#39;only&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;This run is to send report only&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_email</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_index_server_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span><span class="o">.</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Changing index server&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">index_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restarting CS services&#39;</span><span class="p">)</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_name</span><span class="p">)</span>
                <span class="n">cs</span><span class="o">.</span><span class="n">restart_services</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting for 5 minutes to get CS services ready&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

                <span class="n">new_index_server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">index_server</span><span class="o">.</span><span class="n">client_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New Index Server: &#39;</span> <span class="o">+</span> <span class="n">new_index_server_name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting Index DB object&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">index_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DB Path: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">db_path</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">start_perf_counter</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="s1">&#39;test_&#39;</span> <span class="o">+</span> <span class="n">test</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running test: &#39;</span> <span class="o">+</span> <span class="n">method_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing CVODS processes before test&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">kill_process</span><span class="p">(</span><span class="s1">&#39;CVODS&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">):</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid test name&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">set_test_process_id</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stop_perf_counter</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_report</span> <span class="o">==</span> <span class="s1">&#39;always&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_email</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Test case failed with error: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_perf_counter</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCase.test_playback"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.test_playback">[docs]</a>    <span class="k">def</span> <span class="nf">test_playback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the playback test and collects the playback time taken&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Running playback test *****&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_delete_db</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aging checkpoints&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">age_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">backupset_guid</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting DB&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_db</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Initiating playback *****&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_upto_date</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DB is not upto date&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** DB is upto date *****&#39;</span><span class="p">)</span>

            <span class="n">jbs_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">db_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_delim</span> <span class="o">+</span> <span class="s1">&#39;JobStats.csv&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading job stats file: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jbs_file</span><span class="p">))</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">read_csv_file</span><span class="p">(</span><span class="n">jbs_file</span><span class="p">)</span>
            <span class="n">total_added</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">job_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Job Type&#39;</span><span class="p">]]</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Job Id&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> job - J</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_type</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
                <span class="n">deleted_items</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Deleted Folders&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Deleted Files&#39;</span><span class="p">])</span>
                <span class="n">added_items</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Added Files&#39;</span><span class="p">]</span>
                <span class="n">deleted_items_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">deleted_items</span><span class="p">)</span>
                <span class="n">added_items_fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">added_items</span><span class="p">)</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;Added </span><span class="si">{0}</span><span class="s1"> Deleted </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">added_items_fmt</span><span class="p">,</span> <span class="n">deleted_items_fmt</span><span class="p">)</span>

                <span class="n">total_added</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">added_items</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">deleted_items</span><span class="p">)</span>
                <span class="n">total_time</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Seconds To Playback&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;playback_time&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Seconds To Playback&#39;</span><span class="p">],</span> <span class="n">comments</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">total_added</span><span class="p">:</span>
                <span class="n">pt_1m_items</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span><span class="o">/</span><span class="n">total_added</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span>
                    <span class="s1">&#39;playback_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Playback time for 1 million items&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt_1m_items</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Playback tests completed *****&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while running test: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span></div>

<div class="viewcode-block" id="TestCase.test_restore"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.test_restore">[docs]</a>    <span class="k">def</span> <span class="nf">test_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the restore test and collects the restore vector creation time taken&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Running restore vector tests *****&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting latest cycle restore job&#39;</span><span class="p">)</span>

            <span class="n">rst_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore_out_of_place</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_name</span><span class="p">,</span> <span class="s1">&#39;e:</span><span class="se">\\</span><span class="s1">restores&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">])</span>
            <span class="n">rst_job_id</span> <span class="o">=</span> <span class="n">rst_job</span><span class="o">.</span><span class="n">job_id</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restore_vector_time</span><span class="p">(</span><span class="n">rst_job_id</span><span class="p">,</span> <span class="s1">&#39;restore&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;restore_rv_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Latest cycle restore&#39;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing restore job&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rst_job</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting oldest cycle restore job&#39;</span><span class="p">)</span>

            <span class="n">rst_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore_out_of_place</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cs_name</span><span class="p">,</span> <span class="s1">&#39;e:</span><span class="se">\\</span><span class="s1">restores&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">],</span>
                <span class="n">to_time</span><span class="o">=</span><span class="n">commonutils</span><span class="o">.</span><span class="n">convert_to_formatted_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldest_cycle_etime</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">rst_job_id</span> <span class="o">=</span> <span class="n">rst_job</span><span class="o">.</span><span class="n">job_id</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restore_vector_time</span><span class="p">(</span><span class="n">rst_job_id</span><span class="p">,</span> <span class="s1">&#39;restore&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;restore_rv_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Oldest cycle restore&#39;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing restore job&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">rst_job</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Restore tests completed *****&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while running test: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span></div>

<div class="viewcode-block" id="TestCase.test_synthetic_full"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.test_synthetic_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_synthetic_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the synthetic full job test and collects the time taken for RV creation&quot;&quot;&quot;</span>

        <span class="n">sfull_job</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Running synthetic full job test *****&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting synthetic full job&#39;</span><span class="p">)</span>

            <span class="n">sfull_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s1">&#39;Synthetic_full&#39;</span><span class="p">)</span>
            <span class="n">sfull_job_id</span> <span class="o">=</span> <span class="n">sfull_job</span><span class="o">.</span><span class="n">job_id</span>

            <span class="n">time_taken</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restore_vector_time</span><span class="p">(</span><span class="n">sfull_job_id</span><span class="p">,</span> <span class="s1">&#39;synthetic_full&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time taken for SFULL restore vector creation: &#39;</span> <span class="o">+</span> <span class="n">time_taken</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;sfull_rv_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Restore vector creation time&#39;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing synthetic full job&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Synthetic full job tests completed *****&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">sfull_job</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while running test: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sfull_job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sfull_job</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span></div>

<div class="viewcode-block" id="TestCase.test_compaction"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.test_compaction">[docs]</a>    <span class="k">def</span> <span class="nf">test_compaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the compaction test and collects the compaction  time taken&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Running Compaction test *****&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running index checkpoint job&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">checkpoint_db</span><span class="p">(</span><span class="n">by_all_index_backup_clients</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running compaction operation&#39;</span><span class="p">)</span>
            <span class="n">compaction_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">compact_db</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">compaction_job</span><span class="p">:</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">compaction_job</span><span class="o">.</span><span class="n">job_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Compaction job: &#39;</span> <span class="o">+</span> <span class="n">job_id</span><span class="p">)</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">log_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">attempts</span> <span class="o">=</span> <span class="mi">3</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">attempts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Compaction check attempts exhausted !&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting compaction time from IndexServer.log&#39;</span><span class="p">)</span>

                    <span class="n">db_guid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">backupset_guid</span>
                    <span class="n">log_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_log</span><span class="p">(</span>
                        <span class="s1">&#39;IndexServer.log&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;secs to compact DB&#39;</span><span class="p">,</span> <span class="n">db_guid</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">log_lines</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cannot get compaction time trying again&#39;</span><span class="p">)</span>
                        <span class="n">attempts</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got compaction time&#39;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">log_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\[([0-9.]+)\]&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">time_taken</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time taken for compaction operation: &#39;</span> <span class="o">+</span> <span class="n">time_taken</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;compaction_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Compaction time&#39;</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Compaction tests completed *****&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while running test: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span></div>

<div class="viewcode-block" id="TestCase.test_browse"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.test_browse">[docs]</a>    <span class="k">def</span> <span class="nf">test_browse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the find test and collects the find time taken&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Running browse test *****&#39;</span><span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Doing latest cycle filtered find operation. Attempt [</span><span class="si">{0}</span><span class="s1">/5]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">attempts</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
                        <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;FileName&#39;</span><span class="p">,</span> <span class="s1">&#39;*a*&#39;</span><span class="p">)],</span>
                        <span class="s1">&#39;page_size&#39;</span><span class="p">:</span> <span class="mi">1000</span>
                    <span class="p">})</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">SDKException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Browse request timed out. Error [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time taken for latest cycle filtered find operation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;find_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Latest cycle filtered&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Doing oldest cycle filtered find operation&#39;</span><span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">find</span><span class="p">({</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;FileName&#39;</span><span class="p">,</span> <span class="s1">&#39;*a*&#39;</span><span class="p">)],</span>
                <span class="s1">&#39;page_size&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s1">&#39;to_time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldest_cycle_etime</span>
            <span class="p">})</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time taken for oldest filtered find operation: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_stat</span><span class="p">(</span><span class="s1">&#39;find_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Oldest cycle filtered&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">push_stats_database</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;***** Browse tests completed *****&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while running test: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span></div>

<div class="viewcode-block" id="TestCase.create_stats_table"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.create_stats_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_stats_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the two tables required to store the performance statistics&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM INFORMATION_SCHEMA.TABLES &quot;</span>
                                       <span class="s2">&quot;WHERE TABLE_NAME = &#39;IndexingPerfStats&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                CREATE TABLE [dbo].[IndexingPerfStats](</span>
<span class="s1">                    [id] [bigint] IDENTITY(1,1) NOT NULL,</span>
<span class="s1">                    [attempt] [bigint] NOT NULL,</span>
<span class="s1">                    [service_pack] [varchar](max) NULL,</span>
<span class="s1">                    [type] [varchar](max) NULL,</span>
<span class="s1">                    [name] [varchar](max) NULL,</span>
<span class="s1">                    [value] [float] NULL,</span>
<span class="s1">                    [comments] [varchar](max) NULL</span>
<span class="s1">                )</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Indexing performance stats table created successfully&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Indexing performance stats table already exists&#39;</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM INFORMATION_SCHEMA.TABLES &quot;</span>
                                       <span class="s2">&quot;WHERE TABLE_NAME = &#39;IndexingProcessStats&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                CREATE TABLE [dbo].[IndexingProcessStats](</span>
<span class="s1">                    [attempt] [bigint] NULL,</span>
<span class="s1">                    [service_pack] [bigint] NULL,</span>
<span class="s1">                    [test] [varchar](max) NULL,</span>
<span class="s1">                    [time] [bigint] NULL,</span>
<span class="s1">                    [name] [varchar](max) NULL,</span>
<span class="s1">                    [handles] [bigint] NULL,</span>
<span class="s1">                    [threads] [bigint] NULL,</span>
<span class="s1">                    [memory] [bigint] NULL</span>
<span class="s1">                )</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Indexing process stats table created successfully&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Indexing process stats table already exists&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.push_stats_database"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.push_stats_database">[docs]</a>    <span class="k">def</span> <span class="nf">push_stats_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pushes the collected data to the DB&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pushing stats to database&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;insert into IndexingPerfStats &quot;</span> \
                <span class="s2">&quot;(attempt, service_pack, type, name, value, comments) values &quot;</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_stats</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">attempt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span><span class="p">,</span>
                                 <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]])</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;(&#39;&quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot;&#39;),&quot;</span>

        <span class="n">final_query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserting records: &#39;</span> <span class="o">+</span> <span class="n">final_query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">final_query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_stats</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="TestCase.update_stat"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.update_stat">[docs]</a>    <span class="k">def</span> <span class="nf">update_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Records the collected stat in memory&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_stats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">stype</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span>
        <span class="p">})</span></div>

<div class="viewcode-block" id="TestCase.get_attempt"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_attempt">[docs]</a>    <span class="k">def</span> <span class="nf">get_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the last attempt for the current service pack of the current run&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting last performance test attempt ID for SP: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span><span class="p">))</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select max(attempt) as &#39;attempt&#39; from IndexingPerfStats &quot;</span>
                                       <span class="s2">&quot;where service_pack = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span><span class="p">))</span>
        <span class="n">attempt</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;attempt&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">attempt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_log_file"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_log_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the log file path on IndexServer MA for the given log name&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="s1">&#39;Log Files&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_oldest_cycle_time"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_oldest_cycle_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_oldest_cycle_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the oldest cycle&#39;s job end time&quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select top 1 * from jmbkpstats where appid = </span><span class="si">{0}</span><span class="s2">&quot;</span>
                 <span class="s2">&quot; and fullCycleNum = (select fullcyclenum from jmbkpstats where &quot;</span>
                 <span class="s2">&quot;jobid = (select min(jobid) from archfile where appid = </span><span class="si">{0}</span><span class="s2"> and &quot;</span>
                 <span class="s2">&quot;filetype = 2)) order by jobid asc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_id</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;servEndDate&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="TestCase.get_last_two_sps"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_last_two_sps">[docs]</a>    <span class="k">def</span> <span class="nf">get_last_two_sps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the last two service packs for which numbers were collected&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select max(service_pack) as &quot;sp&quot; from IndexingPerfStats&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Comparing stats for service packs </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCase.read_log"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.read_log">[docs]</a>    <span class="k">def</span> <span class="nf">read_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">words</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the log files for the given words&quot;&quot;&quot;</span>

        <span class="n">tries</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">tries</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">find_lines_in_file</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">words</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception in getaddrinfo. Retrying again [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.age_checkpoints"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.age_checkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">age_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backupset_guid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ages all the checkpoints of the DB&quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;delete from archfile where name like &#39;%</span><span class="si">{0}</span><span class="s2">%&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backupset_guid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Age checkpoint query: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.limit_decimals"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.limit_decimals">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">limit_decimals</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a number with restricted numbers after decimal point&quot;&quot;&quot;</span>

        <span class="n">format_specifier</span> <span class="o">=</span> <span class="s1">&#39;{0:.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;f}&#39;</span>
        <span class="k">return</span> <span class="n">format_specifier</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.format_number"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.format_number">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_number</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">divide_by</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Formats the given number with units&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">divide_by</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span>

            <span class="n">num</span> <span class="o">/=</span> <span class="n">divide_by</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.start_perf_counter"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.start_perf_counter">[docs]</a>    <span class="k">def</span> <span class="nf">start_perf_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the powershell based performance counter on the IndexServer machine&quot;&quot;&quot;</span>

        <span class="n">counter_file</span> <span class="o">=</span> <span class="s1">&#39;c:</span><span class="se">\\</span><span class="s1">perf_counter.ps1&#39;</span>
        <span class="n">counter_report_file</span> <span class="o">=</span> <span class="s1">&#39;c:</span><span class="se">\\</span><span class="s1">perf_stat_result.csv&#39;</span>
        <span class="n">counter_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">function GetIndexingProcID([String] $name = &quot;&quot;){</span>
<span class="s2">    $ids = Get-WmiObject Win32_Process | Where-Object {$_.CommandLine -like &quot;*$name*&quot;} | select-object -ExpandProperty ProcessID </span>
<span class="s2">    return @($ids)[0]</span>
<span class="s2">}</span>

<span class="s2">function WriteProcessInfo([Int] $id = &quot;&quot;, [String] $name = &quot;&quot;)</span>
<span class="s2">{</span>
<span class="s2">    if($id -eq &quot;&quot;){</span>
<span class="s2">        return $false;</span>
<span class="s2">    }</span>
<span class="s2">    $pi = Get-WmiObject -class Win32_PerfFormattedData_PerfProc_Process | where-object {$_.idprocess -eq $id}</span>
<span class="s2">    $table = @</span><span class="si">{}</span><span class="s2"></span>
<span class="s2">    $table.Add(&quot;id&quot;, $pi.IDProcess)</span>
<span class="s2">    $table.Add(&quot;name&quot;, $name)</span>
<span class="s2">    $table.Add(&quot;handles&quot;, $pi.HandleCount)</span>
<span class="s2">    $table.Add(&quot;threads&quot;, $pi.ThreadCount)</span>
<span class="s2">    $table.Add(&quot;memory&quot;, $pi.WorkingSetPrivate)</span>

<span class="s2">    $ourObject = New-Object -TypeName psobject -Property $table</span>
<span class="s2">    $ourObject | export-csv -path &quot;c:\perf_stat_result.csv&quot; -NoTypeInformation -append -Force</span>
<span class="s2">}</span>

<span class="s2">while ($true){</span>
<span class="s2">    $isp_id = GetIndexingProcID &quot;IndexServer&quot;</span>
<span class="s2">    #$lmp_id = GetIndexingProcID &quot;LogManager&quot;</span>

<span class="s2">    WriteProcessInfo $isp_id &quot;IndexServer&quot;</span>
<span class="s2">    #WriteProcessInfo $lmp_id &quot;LogManager&quot;</span>
<span class="s2">    start-sleep -Seconds 30</span>
<span class="s2">}&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">counter_report_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating performance counter file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="s2">&quot;set-content -path &#39;&quot;</span> <span class="o">+</span> <span class="n">counter_file</span> <span class="o">+</span> <span class="s2">&quot;&#39; -value &#39;&quot;</span> <span class="o">+</span> <span class="n">counter_code</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting performance counter&#39;</span><span class="p">)</span>
        <span class="n">counter_id_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="s1">&#39;(start-process -filepath &quot;powershell.exe&quot; -ArgumentList &quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span>
            <span class="s1">&#39;-Verb RunAs -passthru).ID&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter_file</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span> <span class="o">=</span> <span class="n">counter_id_cmd</span><span class="o">.</span><span class="n">formatted_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Started performance counter. Process ID [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCase.stop_perf_counter"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.stop_perf_counter">[docs]</a>    <span class="k">def</span> <span class="nf">stop_perf_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops the performance counting process on the IndexServer machine&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing performance counter process&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">kill_process</span><span class="p">(</span><span class="n">process_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span><span class="p">)</span>

        <span class="n">counter_report_file</span> <span class="o">=</span> <span class="s1">&#39;c:</span><span class="se">\\</span><span class="s1">perf_stat_result.csv&#39;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">read_csv_file</span><span class="p">(</span><span class="n">counter_report_file</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c1"># Splitting lines to 900 per set as we cannot insert more than 1000 records at once</span>
        <span class="n">lines_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">900</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">900</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_process_id</span><span class="p">)</span>

        <span class="n">stat_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">lines_set</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;insert into IndexingProcessStats &quot;</span> \
                    <span class="s2">&quot;(attempt, service_pack, test, time, name, handles, threads, memory) values &quot;</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

                <span class="n">process_id</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">test_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_process_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">process_id</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attempt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">stat_time</span><span class="p">),</span>
                     <span class="n">line</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;handles&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">],</span>
                     <span class="n">line</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;(&#39;&quot;</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="s2">&quot;&#39;),&quot;</span>
                <span class="n">stat_time</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">final_query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pushing process stats to DB&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Inserting records: &#39;</span> <span class="o">+</span> <span class="n">final_query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">final_query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="TestCase.set_test_process_id"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.set_test_process_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_test_process_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Records the test done by the current IndexServer process&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting running index server process id&#39;</span><span class="p">)</span>
            <span class="n">process_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_server_process_id</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_process_id</span><span class="p">[</span><span class="n">process_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_name</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got exception while setting index server process if for the test&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.set_ticks_graph"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.set_ticks_graph">[docs]</a>    <span class="k">def</span> <span class="nf">set_ticks_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_pack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the test name on the x axis of the graph&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">start_times</span><span class="p">,</span> <span class="n">test_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_start_time</span><span class="p">(</span><span class="n">service_pack</span><span class="o">=</span><span class="n">service_pack</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_times</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">test_names</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">test_names</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception while labelling x axis: [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestCase.get_index_server_change"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_index_server_change">[docs]</a>    <span class="k">def</span> <span class="nf">get_index_server_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the index server machine to use for the current run&quot;&quot;&quot;</span>

        <span class="n">isc_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;IndexServer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">isc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">isc_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isc_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">current_is</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">index_server</span><span class="o">.</span><span class="n">client_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_is_idx</span> <span class="o">=</span> <span class="n">isc_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">current_is</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isc_list</span><span class="p">[</span><span class="n">current_is_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TestCase.get_index_server_process_id"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_index_server_process_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_index_server_process_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the currently running IndexServer process ID&quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;@(Get-WmiObject Win32_Process | Where-Object {$_.CommandLine -like &quot;*IndexServer*&quot;} | select-object -ExpandProperty ProcessID)[0]&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current IndexServer process ID: &#39;</span> <span class="o">+</span> <span class="n">out</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">formatted_output</span></div>

<div class="viewcode-block" id="TestCase.get_time_from_logs"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_time_from_logs">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_from_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;Browse.log&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the time value for the log line&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Looking for words </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">words</span><span class="p">))</span>
            <span class="n">log_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_log</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">words</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">log_lines</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Words not found. Trying again.&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">log_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[0-9]+\/[0-9]+ [0-9]+\:[0-9]+\:[0-9]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">time_raw</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_format</span> <span class="o">=</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>

        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_raw</span><span class="p">,</span> <span class="n">time_format</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_restore_vector_time"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_restore_vector_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_restore_vector_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the time taken to create restore vector&quot;&quot;&quot;</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job ID for restore vector creation [</span><span class="si">{0}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
        <span class="n">job_id_search</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;restore&#39;</span><span class="p">:</span>
            <span class="n">end_text</span> <span class="o">=</span> <span class="s1">&#39;Time taken to create restore&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_text</span> <span class="o">=</span> <span class="s1">&#39;Successfully created restore vector at&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking if restore vector creation STARTED in Browse.log&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_logs</span><span class="p">([</span><span class="n">job_id_search</span><span class="p">,</span> <span class="s1">&#39;Received Browse Request From Client&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking if restore vector creation ENDED in Browse.log&#39;</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_from_logs</span><span class="p">([</span><span class="n">job_id_search</span><span class="p">,</span> <span class="n">end_text</span><span class="p">])</span>

        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_diff</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.get_test_start_time"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_test_start_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_test_start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_pack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the start time of the test&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select test, MIN(time) as &#39;start_time&#39; from </span>
<span class="s2">        indexingprocessstats where service_pack = &#39;</span><span class="si">{0}</span><span class="s2">&#39; and name = &#39;IndexServer&#39; and </span>
<span class="s2">        attempt = (select max(attempt) from indexingprocessstats where service_pack = &#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span>
<span class="s2">        group by test&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">service_pack</span><span class="p">))</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">test_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>

            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">test_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">test_names</span></div>

<div class="viewcode-block" id="TestCase.get_compare_results"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_compare_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_compare_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs query to compares the performance stat results&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">IF object_id(&#39;tempdb.dbo.#prevsp&#39;) is not null</span>
<span class="s2">    DROP TABLE #prevsp</span>

<span class="s2">IF object_id(&#39;tempdb.dbo.#cursp&#39;) is not null</span>
<span class="s2">    DROP TABLE #cursp</span>

<span class="s2">CREATE TABLE #prevsp (service_pack varchar(max), type varchar(max), name varchar(max), value float)</span>
<span class="s2">CREATE TABLE #cursp (service_pack varchar(max), type varchar(max), name varchar(max), value float, id bigint)</span>

<span class="s2">declare @curspnum varchar(max) = (select max(service_pack) from IndexingPerfStats)</span>
<span class="s2">declare @prevspnum varchar(max) = @curspnum-1</span>
<span class="s2">declare @avgattempts bigint = 3</span>

<span class="s2">insert into #prevsp</span>
<span class="s2">select service_pack, type, name, avg(value) from IndexingPerfStats</span>
<span class="s2">where service_pack = @prevspnum</span>
<span class="s2">and attempt &gt; (select max(attempt) from IndexingPerfStats where service_pack = @prevspnum)-@avgattempts</span>
<span class="s2">group by service_pack, type, name</span>

<span class="s2">insert into #cursp</span>
<span class="s2">select service_pack, type, name, avg(value), max(id) from IndexingPerfStats</span>
<span class="s2">where service_pack = @curspnum</span>
<span class="s2">and attempt &gt; (select max(attempt) from IndexingPerfStats where service_pack = @curspnum)-@avgattempts</span>
<span class="s2">group by service_pack, type, name</span>

<span class="s2">--select * from #prevsp</span>
<span class="s2">--select * from #cursp</span>

<span class="s2">select cursp.type, cursp.name, prevsp.value as &#39;spl&#39;, cursp.value as &#39;sph&#39;, </span>
<span class="s2">(select comments from IndexingPerfStats where id = cursp.id) as &#39;comments&#39;</span>
<span class="s2">from #cursp cursp</span>
<span class="s2">left join #prevsp prevsp on prevsp.type = cursp.type and prevsp.name = cursp.name</span>
<span class="s2">where cursp.service_pack = @curspnum</span>
<span class="s2">order by cursp.id asc</span>

<span class="s2">DROP TABLE #prevsp</span>
<span class="s2">DROP TABLE #cursp</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span></div>

<div class="viewcode-block" id="TestCase.get_compare_process_stats"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_compare_process_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_compare_process_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs query to compares the process stats results&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">IF object_id(&#39;tempdb.dbo.#prevsp&#39;) is not null</span>
<span class="s2">    DROP TABLE #prevsp</span>

<span class="s2">IF object_id(&#39;tempdb.dbo.#cursp&#39;) is not null</span>
<span class="s2">    DROP TABLE #cursp</span>

<span class="s2">declare @curspnum varchar(max) = (select max(service_pack) from IndexingProcessStats)</span>
<span class="s2">declare @prevspnum varchar(max) = @curspnum-1</span>
<span class="s2">declare @curspattempt int = (select max(attempt) from IndexingProcessStats where service_pack = @curspnum)</span>
<span class="s2">declare @prevspattempt int = (select max(attempt) from IndexingProcessStats where service_pack = @prevspnum)</span>

<span class="s2">CREATE TABLE #prevsp (service_pack varchar(max), test varchar(max), value float)</span>
<span class="s2">CREATE TABLE #cursp (service_pack varchar(max), test varchar(max), value float)</span>

<span class="s2">insert #prevsp</span>
<span class="s2">select service_pack, test, avg(</span><span class="si">{0}</span><span class="s2">) as &#39;value&#39; from indexingprocessstats where service_pack = @prevspnum and attempt = @prevspattempt group by service_pack, test</span>

<span class="s2">insert #cursp</span>
<span class="s2">select service_pack, test, avg(</span><span class="si">{0}</span><span class="s2">) as &#39;value&#39; from indexingprocessstats where service_pack = @curspnum and attempt = @curspattempt group by service_pack, test</span>

<span class="s2">select cursp.test, prevsp.value as &#39;spl&#39;, cursp.value as &#39;sph&#39;</span>
<span class="s2">from #cursp cursp</span>
<span class="s2">join #prevsp prevsp on prevsp.test = cursp.test</span>

<span class="s2">DROP TABLE #prevsp</span>
<span class="s2">DROP TABLE #cursp</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">rows</span></div>

<div class="viewcode-block" id="TestCase.get_process_graph_data"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.get_process_graph_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_process_graph_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_pack</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="s1">&#39;IndexServer&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;memory&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retreives the process stats from the DB&quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select * from indexingprocessstats where </span>
<span class="s2">            service_pack = &#39;</span><span class="si">{0}</span><span class="s2">&#39; and name = &#39;</span><span class="si">{1}</span><span class="s2">&#39; and attempt = (select max(attempt) from </span>
<span class="s2">            indexingprocessstats where service_pack = &#39;</span><span class="si">{0}</span><span class="s2">&#39;) order by time</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">service_pack</span><span class="p">,</span> <span class="n">process</span><span class="p">))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>

<div class="viewcode-block" id="TestCase.create_graph"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.create_graph">[docs]</a>    <span class="k">def</span> <span class="nf">create_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the image tag for the graph&quot;&quot;&quot;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">graph_type</span> <span class="o">==</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Memory usage (MB)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">tick</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()])</span>

        <span class="k">if</span> <span class="n">graph_type</span> <span class="o">==</span> <span class="s1">&#39;handles&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Handles&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">graph_type</span> <span class="o">==</span> <span class="s1">&#39;threads&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Threads&#39;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">bytes_io</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">bytes_io</span><span class="p">)</span>
        <span class="n">bytes_io</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">base64_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">bytes_io</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">string_data</span> <span class="o">=</span> <span class="n">base64_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">&#39;&lt;img src=&quot;data:image/png;base64,&#39;</span> <span class="o">+</span> <span class="n">string_data</span> <span class="o">+</span> <span class="s1">&#39;&quot;/&gt;&#39;</span></div>

<div class="viewcode-block" id="TestCase.create_graph_stats"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.create_graph_stats">[docs]</a>    <span class="k">def</span> <span class="nf">create_graph_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">service_pack</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates graphs for the process stats&quot;&quot;&quot;</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SP&#39;</span> <span class="o">+</span> <span class="n">service_pack</span>
        <span class="n">isp_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_process_graph_data</span><span class="p">(</span><span class="n">service_pack</span><span class="o">=</span><span class="n">service_pack</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">isp_memory</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">isp_memory</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ticks_graph</span><span class="p">(</span><span class="n">service_pack</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.build_table_perf_stats"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.build_table_perf_stats">[docs]</a>    <span class="k">def</span> <span class="nf">build_table_perf_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates HTML for the performance stats table&quot;&quot;&quot;</span>

        <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;table border=&quot;1&quot;&gt;&lt;tr&gt;</span>
<span class="s2">        &lt;th&gt;Test&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;SP</span><span class="si">{0}</span><span class="s2">&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;SP</span><span class="si">{1}</span><span class="s2">&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;% Change&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;Comments&lt;/th&gt;</span>
<span class="s2">        &lt;/tr&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span>
        <span class="p">)</span>

        <span class="n">last_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">type_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;playback_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Playback time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;find_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Find time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;restore_rv_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Restore vector creation time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sfull_rv_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Synthetic full job vector creation time&#39;</span><span class="p">,</span>
            <span class="s1">&#39;compaction_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Compaction time&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compare_results</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">lsp_raw</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;spl&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;spl&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">hsp_raw</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sph&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sph&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">lsp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lsp_raw</span><span class="p">)</span>
            <span class="n">hsp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hsp_raw</span><span class="p">)</span>
            <span class="n">percent_increase</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">percent_increase</span> <span class="o">=</span> <span class="p">(((</span><span class="n">hsp</span><span class="o">-</span><span class="n">lsp</span><span class="p">)</span><span class="o">/</span><span class="n">lsp</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">state_table</span> <span class="o">=</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;darkGreen&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#9660;&#39;</span><span class="p">],</span>
                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#a96500&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#9650;&#39;</span><span class="p">],</span>
                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#9650;&#39;</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">hsp</span> <span class="o">&gt;</span> <span class="n">lsp</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">percent_increase</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
            <span class="k">if</span> <span class="n">hsp</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">lsp</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">hsp</span> <span class="o">=</span> <span class="n">hsp</span><span class="o">/</span><span class="mi">60</span>
                <span class="n">lsp</span> <span class="o">=</span> <span class="n">lsp</span><span class="o">/</span><span class="mi">60</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

            <span class="n">hsp_color</span> <span class="o">=</span> <span class="n">state_table</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hsp_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">hsp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">lsp_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">lsp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">p_increase</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">percent_increase</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;% &#39;</span> <span class="o">+</span>
                          <span class="n">state_table</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">last_type</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]:</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;tr&gt;&lt;th colspan=&quot;5&quot; style=&quot;background-color: #62a0d0; padding: 5px 10px&quot;&gt;&#39;</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="n">type_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/th&gt;&lt;/tr&gt;&#39;</span>

            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;tr&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">lsp_value</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">hsp_value</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td style=&quot;color:&#39;</span> <span class="o">+</span> <span class="n">hsp_color</span> <span class="o">+</span> <span class="s1">&#39;;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">p_increase</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/tr&gt;&#39;</span>

            <span class="n">last_type</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/table&gt;&#39;</span>

        <span class="k">return</span> <span class="n">html</span></div>

<div class="viewcode-block" id="TestCase.build_table_process_stats"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.build_table_process_stats">[docs]</a>    <span class="k">def</span> <span class="nf">build_table_process_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>

        <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;table border=&quot;1&quot;&gt;&lt;tr&gt;</span>
<span class="s2">        &lt;th&gt;Test (average </span><span class="si">{2}</span><span class="s2">)&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;SP</span><span class="si">{0}</span><span class="s2">&lt;/th&gt;</span>
<span class="s2">        &lt;th&gt;SP</span><span class="si">{1}</span><span class="s2">&lt;/th&gt;</span>
<span class="s2">        &lt;/tr&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">,</span> <span class="n">stat</span>
        <span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compare_process_stats</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span>
                <span class="n">lsp_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;spl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;MB&#39;</span>
                <span class="n">hsp_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sph&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;MB&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lsp_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;spl&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">hsp_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_decimals</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sph&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;tr&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">lsp_value</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="n">hsp_value</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/tr&gt;&#39;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/table&gt;&#39;</span>

        <span class="k">return</span> <span class="n">html</span></div>

<div class="viewcode-block" id="TestCase.build_email"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.build_email">[docs]</a>    <span class="k">def</span> <span class="nf">build_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates the HTML for the email report&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stats not available for one of the SP. Not building report&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;style&gt;table{border-collapse: collapse;} th{  </span>
<span class="s2">        background: #2c5e84; color: #fff; } th, td{ padding: 10px; } &lt;/style&gt;&quot;&quot;&quot;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h2&gt;SP</span><span class="si">{0}</span><span class="s1"> vs SP</span><span class="si">{1}</span><span class="s1"> performance stats&lt;/h2&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;p&gt;Note: Below numbers are an average of last three attempts.&lt;/p&gt;&#39;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_table_perf_stats</span><span class="p">()</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h2&gt;IndexServer process stats during above tests&lt;/h2&gt;&#39;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;p&gt;Note: Before every test, IndexServer process is killed and newly launched&lt;/p&gt;&#39;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;RAM consumption&lt;/h3&gt;&#39;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_table_process_stats</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Handles opened&lt;/h3&gt;&#39;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_table_process_stats</span><span class="p">(</span><span class="s1">&#39;handles&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;handles&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;handles&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Threads launched&lt;/h3&gt;&#39;</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_table_process_stats</span><span class="p">(</span><span class="s1">&#39;threads&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_graph_stats</span><span class="p">(</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h3&gt;Setup&lt;/h3&gt;&#39;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;CS: </span><span class="si">{0}</span><span class="s1">&lt;br/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_hostname</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;MA: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isc_obj</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">html</span></div>

<div class="viewcode-block" id="TestCase.send_email"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.send_email">[docs]</a>    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends the report email&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building report and sending email&#39;</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_email</span><span class="p">()</span>

        <span class="n">sp_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sp_text</span> <span class="o">=</span> <span class="s1">&#39; - SP</span><span class="si">{0}</span><span class="s1"> vs SP</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_sp</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">AutomationUtils.mailer</span> <span class="k">import</span> <span class="n">Mailer</span>
        <span class="n">mailer</span> <span class="o">=</span> <span class="n">Mailer</span><span class="p">(</span><span class="n">mailing_inputs</span><span class="o">=</span><span class="p">{},</span> <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="n">mailer</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="s1">&#39;Indexing performance comparison&#39;</span> <span class="o">+</span> <span class="n">sp_text</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.tear_down"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54143.TestCase.tear_down">[docs]</a>    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleanup operation&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Killing performance counter process&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">kill_process</span><span class="p">(</span><span class="n">process_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">counter_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; - SP&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">isc_sp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isc_machine</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>