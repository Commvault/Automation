

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testcases.54669 &mdash; Commvault Automation 11.23 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Testcases.54669</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Testcases.54669</h1><div class="highlight"><pre>
<span></span><span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>


<span class="sd">&quot;&quot;&quot;&quot;Main file for executing this test case</span>

<span class="sd">TestCase is the only class defined in this file.</span>

<span class="sd">TestCase: Class for executing this test case</span>

<span class="sd">TestCase:</span>
<span class="sd">    __init__()      --  initialize TestCase class</span>

<span class="sd">    setup()         --  setup function of this test case</span>

<span class="sd">    run()           --  run function of this test case</span>

<span class="sd">    tear_down()     --  tear down function of this test case</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.database_helper</span> <span class="kn">import</span> <span class="n">MSSQL</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="kn">import</span> <span class="n">OptionsSelector</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.cvtestcase</span> <span class="kn">import</span> <span class="n">CVTestCase</span>
<span class="kn">from</span> <span class="nn">MediaAgents.MAUtils.mahelper</span> <span class="kn">import</span> <span class="n">DedupeHelper</span><span class="p">,</span> <span class="n">MMHelper</span>


<div class="viewcode-block" id="TestCase"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase">[docs]</a><span class="k">class</span> <span class="nc">TestCase</span><span class="p">(</span><span class="n">CVTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for executing this test case&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes test case class object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;DDB_Full_Scenarios&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;MediaAgentName&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;sqlpassword&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;sqluser&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;MountPath&quot;</span> <span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Local variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machineobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span> <span class="o">=</span> <span class="s1">&#39;Primary&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MM_THREAD_SLEEP_TIME</span> <span class="o">=</span> <span class="mi">480</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbhandle</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestCase.setup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup function of this test case&quot;&quot;&quot;</span>
        <span class="n">optionobj</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s2">&quot;MediaAgentName&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span> <span class="o">=</span> <span class="n">optionobj</span><span class="o">.</span><span class="n">get_drive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machineobj</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

        <span class="n">timestamp_suffix</span> <span class="o">=</span> <span class="n">OptionsSelector</span><span class="o">.</span><span class="n">get_custom_str</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span><span class="p">,</span>
                                                    <span class="s2">&quot;DDBs</span><span class="se">\\</span><span class="s2">tc_54669_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp_suffix</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;tc_54669_sp&quot;</span><span class="p">,</span> <span class="n">timestamp_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span> <span class="o">=</span> <span class="s2">&quot;lib_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">timestamp_suffix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="s2">&quot;bkpset_tc_54669_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">timestamp_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_system_drive</span><span class="p">,</span> <span class="s2">&quot;content_104014&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="s2">&quot;defaultBackupSet&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbhandle</span> <span class="o">=</span>  <span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\commvault&#39;</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;sqluser&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;sqlpassword&#39;</span><span class="p">],</span>
                               <span class="s2">&quot;commserv&quot;</span><span class="p">,</span> <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.run"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run function of this test case&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># Local Variable initialization</span>
            <span class="n">dedup_obj</span> <span class="o">=</span> <span class="n">DedupeHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">mmhelper_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">sqluser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;sqluser&#39;</span><span class="p">]</span>
            <span class="n">sqlpassword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;sqlpassword&#39;</span><span class="p">]</span>
            <span class="n">mountpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MountPath&#39;</span><span class="p">]</span>
            <span class="n">subclient_name_prefix</span> <span class="o">=</span> <span class="s2">&quot;subclient_tc_104014&quot;</span>
            <span class="n">storage_policy_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sqlobj</span> <span class="o">=</span> <span class="n">MSSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\commvault&#39;</span><span class="p">,</span> <span class="n">sqluser</span><span class="p">,</span> <span class="n">sqlpassword</span><span class="p">,</span> <span class="s2">&quot;commserv&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Configuring TC environment-----------&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Create new Library---&quot;</span><span class="p">)</span>
            <span class="c1"># Create new library</span>
            <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">configure_disk_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span><span class="p">,</span> <span class="n">mountpath</span><span class="p">)</span>
            <span class="c1"># STEP : Set MM Interval thread to 5 mins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Setting MM Maintenance Check Interval to 5 mins-----------&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMConfigs set nmin=5, value=5 where name = &#39;MMS2_CONFIG_MM_MAINTAINENCE_INTERVAL_MINUTES&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>


            <span class="c1"># Configure backup set and subclients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring backup set---&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="o">.</span><span class="n">configure_backupset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">storage_policy_prefix</span><span class="p">,</span> <span class="s2">&quot;_qi_time_threshold&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_qi_time_threshold</span><span class="p">(</span><span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">dedup_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - QI TIME THRESHOLD ==&gt; PASS&quot;</span><span class="p">)</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;QI TIME THRESHOLD ==&gt; PASS&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - QI TIME THRESHOLD ==&gt; FAIL&quot;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;QI TIME THRESHOLD ==&gt; FAIL&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">storage_policy_prefix</span><span class="p">,</span> <span class="s2">&quot;_free_space_threshold&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_free_space_threshold</span><span class="p">(</span><span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - FREE DISKSPACE THRESHOLD ==&gt; PASS&quot;</span><span class="p">)</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;DISK SPACE THRESHOLD ==&gt; PASS&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - FREE DISKSPACE THRESHOLD ==&gt; FAIL&quot;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;DISK SPACE THRESHOLD ==&gt; FAIL&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring Dedup Storage Policy---&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">storage_policy_prefix</span><span class="p">,</span> <span class="s2">&quot;_subclient_primarycount_threshold&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">,</span> <span class="s2">&quot;_subclient_primarycount_threshold&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Successfully configured storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span>

            <span class="n">copy_id</span> <span class="o">=</span> <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">)</span>
            <span class="n">engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DDB Engine ID created at the time of copy creation - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_subclient_threshold</span><span class="p">(</span><span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - Subclient Number Threshold ==&gt; PASS&quot;</span><span class="p">)</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;SUBCLIENT NUMBER THRESHOLD ==&gt; PASS&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - Subclient Number Threshold ==&gt; FAIL&quot;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;SUBCLIENT NUMBER THRESHOLD ==&gt; FAIL&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_primary_threshold</span><span class="p">(</span><span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - Primary Count Threshold ==&gt; PASS&quot;</span><span class="p">)</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;PRIMARY COUNT THRESHOLD ==&gt; PASS&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;======Horizontal Scaling of DDBs - Primary Count Threshold ==&gt; FAIL&quot;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_string</span><span class="p">,</span> <span class="s2">&quot;PRIMARY COUNT THRESHOLD ==&gt; FAIL&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;------------Disabling the subclient threshold--------------&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMConfigs set value=0 where name = &#39;MMCONFIG_INFINI_STORE_NUMBER_OF_SUBCLIENTS&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>


            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DDB Full Scenario test case failed.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;One or more DDB Full Scenarios failed verification.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DDB Full Senario test case completed successfully.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">********************************</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">********************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result_string</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to execute test case with error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">********************************</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">********************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span></div>

<div class="viewcode-block" id="TestCase.tear_down"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.tear_down">[docs]</a>    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tear down function of this test case&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In tear down method ...&quot;</span><span class="p">)</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cleaning up the test environment ...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">has_backupset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting backupset </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">has_policy</span><span class="p">(</span><span class="n">policy</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting storage policy  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting library </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">disk_libraries</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestCase.test_primary_threshold"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.test_primary_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">test_primary_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test Primary count threshold for DDB full scenario</span>
<span class="sd">        Args:</span>
<span class="sd">        mmhelper_obj (obj) -- mmhelper object</span>
<span class="sd">        sqlobj (obj)    -- SQL connection object</span>

<span class="sd">        Return:</span>
<span class="sd">        True if test succeeds, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_content_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Content directory </span><span class="si">%s</span><span class="s2"> created----------&quot;</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring subclient </span><span class="si">%s</span><span class="s2">_primary---&quot;</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">)</span>
        <span class="n">subclient_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">),</span>
                                                     <span class="n">content_path</span><span class="o">=</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="n">subclient_obj</span><span class="o">.</span><span class="n">data_readers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Creating uncompressable unique data---&quot;</span><span class="p">)</span>
        <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">create_uncompressable_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_backup_job</span><span class="p">(</span><span class="n">subclient_obj</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===================PRIMARY COUNT THRESHOLD=================&quot;</span><span class="p">)</span>
        <span class="n">copy_id</span> <span class="o">=</span> <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">current_ddbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Before starting the primary threshold test, number of SIDBs associated with this storage policy &quot;</span>
            <span class="s2">&quot; --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">))</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="n">current_ddbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping 60 seconds for IdxSIDBUsageHistory update to happen&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># STEP : Modify the idxsidbusagehistory table to make primarycount for last job as 800 millions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting primary entry count for sidbstore to 800 million plus&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxsidbusagehistory set PrimaryEntries = 800000000 where sidbstoreid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Sleep for 5 minutes so that couple of MM threads complete exeuction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing stored proc to simulate MM thread invocations &amp; sleeping for 60 seconds&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;exec CommServ.dbo.archUpdateStoreLimitFlagOnStoragePolicy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbhandle</span><span class="o">.</span><span class="n">execute_stored_procedure</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Now check if a new DDB has got created</span>
        <span class="n">after_test_ddbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="c1"># As we are using same storage policy used by Subclient threshold , we expect it to have 3 DDBs now</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">after_test_ddbs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New DDB got created for Storage Policy copy as expected&quot;</span><span class="p">)</span>
            <span class="n">third_ddb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">after_test_ddbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">third_ddb</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that new DDB engine id </span><span class="si">%s</span><span class="s2"> is not FULL&quot;</span><span class="p">,</span> <span class="n">third_ddb</span><span class="p">)</span>
                <span class="c1"># Set status to True/False based on whether DDB full reason turned out to be 4 as expected</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_ddb_full_reason</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;New DDB engine id </span><span class="si">%s</span><span class="s2"> is marked as FULL instead of ACTIVE&quot;</span><span class="p">,</span> <span class="n">third_ddb</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There are still only 2 DDBs of type FS associated with this storage policy copy&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up storage policy.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="TestCase.test_subclient_threshold"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.test_subclient_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">test_subclient_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test number of subclient threshold for DDB full scenario</span>
<span class="sd">        Args:</span>
<span class="sd">        mmhelper_obj (obj) -- mmhelper object</span>
<span class="sd">        sqlobj (obj)    -- SQL connection object</span>
<span class="sd">        subclient_name_prefix (str) -- subclient name prefix for subclient creation</span>

<span class="sd">        Return:</span>
<span class="sd">        True if test succeeds, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===================SUBCLIENT THRESHOLD=================&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Setting number of subclients threshold to 4-----------&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMConfigs set value=4 where name = &#39;MMCONFIG_INFINI_STORE_NUMBER_OF_SUBCLIENTS&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">copy_id</span> <span class="o">=</span> <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===================SUBCLIENT THRESHOLD=================&quot;</span><span class="p">)</span>
        <span class="c1"># STEP : Create 3 subclients and wait for MM thread to kick off after 2 mins</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="n">current_content_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Content directory </span><span class="si">%s</span><span class="s2"> created----------&quot;</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring subclient </span><span class="si">%s</span><span class="s2">---&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">subclient_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                                         <span class="n">content_path</span><span class="o">=</span><span class="n">current_content_dir</span><span class="p">)</span>
            <span class="n">subclient_obj</span><span class="o">.</span><span class="n">data_readers</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Creating uncompressable unique data---&quot;</span><span class="p">)</span>
            <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">create_uncompressable_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_backup_job</span><span class="p">(</span><span class="n">subclient_obj</span><span class="p">)</span>

            <span class="c1"># STEP : Check subclient to DDB association and that it is getting associated to correct DDB</span>
            <span class="n">assoc_engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclient_ddb_association</span><span class="p">(</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">subclient_id</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">engine_id</span> <span class="o">!=</span> <span class="n">assoc_engine_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Subclient associated with wrong DDB. Expected-&gt; </span><span class="si">%s</span><span class="s2"> Actual-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">engine_id</span><span class="p">,</span> <span class="n">assoc_engine_id</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient </span><span class="si">%s</span><span class="s2"> associated to correct DDB </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">subclient_obj</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_ddbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There is still only 1 DDB of type FS associated with this storage policy copy&quot;</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This storage policy copy now has </span><span class="si">%s</span><span class="s2"> DDBs of type FS &quot;</span>
                                  <span class="s2">&quot;associated with it&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that old DDB engine id </span><span class="si">%s</span><span class="s2"> is marked FULL&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_ddb_full_reason</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Old DDB engine id </span><span class="si">%s</span><span class="s2"> is not marked as FULL&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">assoc_engine_id</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Successfully verified that new DDB engine id </span><span class="si">%s</span><span class="s2"> is not marked FULL&quot;</span><span class="p">,</span> <span class="n">assoc_engine_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;New DDB engine id </span><span class="si">%s</span><span class="s2"> is marked as FULL instead of ACTIVE&quot;</span><span class="p">,</span> <span class="n">assoc_engine_id</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="TestCase.test_free_space_threshold"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.test_free_space_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">test_free_space_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test Disk Free Space threshold for DDB full scenario</span>
<span class="sd">        Args:</span>
<span class="sd">        mmhelper_obj (obj) -- mmhelper object</span>
<span class="sd">        sqlobj (obj)    -- SQL connection object</span>
<span class="sd">        subclient_name_prefix (str) -- subclient name prefix for subclient creation</span>

<span class="sd">        Return:</span>
<span class="sd">        True if test succeeds, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===================FREE SPACE THRESHOLD=================&quot;</span><span class="p">)</span>
        <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring new Dedup Storage Policy for free space threshold verification---&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">,</span> <span class="s2">&quot;_free_space_threshold&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Successfully configured storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="n">copy_id</span> <span class="o">=</span> <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DDB Engine ID created at the time of copy creation - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Setting free disk space threshold to 50%---&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMConfigs set value=50 where name = &#39;MMCONFIG_INFINI_STORE_FREE_SPACE_PERC&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create a new subclient and run a backup&quot;</span><span class="p">)</span>
        <span class="n">subclient_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subclient_run_backup</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping 60 seconds for IdxSIDBUsageHistory update to happen&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="c1"># Set SIDB substore&#39;s idxcache values to breach the free space threshold</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxcache set totalcapacitymb=20480, FreeDiskSpaceMB=8192 where IdxCacheId= &quot;</span> \
                <span class="s2">&quot;(select idxcacheid from idxsidbsubstore where sidbstoreid=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting primary entry count for sidbstore to 200 million plus&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxsidbusagehistory set PrimaryEntries = 200000000 where sidbstoreid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing stored proc to simulate MM thread invocations &amp; sleeping for 60 seconds&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;exec CommServ.dbo.archUpdateStoreLimitFlagOnStoragePolicy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbhandle</span><span class="o">.</span><span class="n">execute_stored_procedure</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Now check if a new DDB has got created</span>
        <span class="n">current_ddbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Second DDB got created for Storage Policy copy as expected&quot;</span><span class="p">)</span>
            <span class="c1"># Now check if 2nd DDB got marked as FULL</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that old DDB engine id </span><span class="si">%s</span><span class="s2"> is marked FULL&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
                <span class="c1"># Check DDB FULL Reason</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_ddb_full_reason</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Old DDB engine id </span><span class="si">%s</span><span class="s2"> is not marked as FULL&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
                <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">new_engine_id</span> <span class="o">=</span> <span class="n">current_ddbs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">new_engine_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that new DDB engine id </span><span class="si">%s</span><span class="s2"> is not FULL&quot;</span><span class="p">,</span> <span class="n">new_engine_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;New DDB engine id </span><span class="si">%s</span><span class="s2"> is marked as FULL instead of ACTIVE&quot;</span><span class="p">,</span> <span class="n">new_engine_id</span><span class="p">)</span>
                <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There is still only 1 DDB of type FS associated with this storage policy copy&quot;</span><span class="p">)</span>
            <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#If test has succeeded, we can clean up the SP. This will reduce number of partition on node</span>
        <span class="c1">#Remember - Number of partitions &gt; 30 on an MA will stop creating new DDBs even when FULL conditions are met</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up storage policy.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_flag</span></div>

<div class="viewcode-block" id="TestCase.test_qi_time_threshold"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.test_qi_time_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">test_qi_time_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">,</span> <span class="n">dedup_obj</span><span class="p">,</span> <span class="n">sqlobj</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test QI time threshold for DDB full scenario</span>
<span class="sd">        Args:</span>
<span class="sd">        mmhelper_obj (obj) -- mmhelper object</span>
<span class="sd">        dedup_obj (obj) -- Dedup Object</span>
<span class="sd">        sqlobj (obj)    -- SQL connection object</span>
<span class="sd">        subclient_name_prefix (str) -- subclient name prefix for subclient creation</span>

<span class="sd">        Return:</span>
<span class="sd">        True if test succeeds, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;===================QI TIME THRESHOLD=================&quot;</span><span class="p">)</span>
        <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring new Dedup Storage Policy for QI time threshold verification---&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">,</span> <span class="s2">&quot;_qi_time_threshold&quot;</span><span class="p">)</span>
        <span class="n">sp_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mediaagentname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedup_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Successfully configured storage policy - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="n">sp_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>

        <span class="n">copy_id</span> <span class="o">=</span> <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">get_copy_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">))</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">substore_id</span> <span class="o">=</span> <span class="n">dedup_obj</span><span class="o">.</span><span class="n">get_sidb_ids</span><span class="p">(</span><span class="n">sp_obj</span><span class="o">.</span><span class="n">storage_policy_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DDB Engine ID created at the time of copy creation - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create a new subclient and run a backup&quot;</span><span class="p">)</span>
        <span class="n">subclient_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subclient_run_backup</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">)</span>

        <span class="c1"># Set DDB Disk space update interval to 5 mins. This is to ensure that if DDB becomes full, it is</span>
        <span class="c1"># solely based on QI Time and no disk space is involved.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating DDB Disk Space Update Threshold to 5 minutes&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update MMCONFIGS set nmin=5, value=5 where name=&#39;MMS2_CONFIG_MM_LOW_SPACE_ALERT_INTERVAL_MINUTES&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for DDB disk space update to happen&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MM_THREAD_SLEEP_TIME</span><span class="p">)</span>
        <span class="c1"># Set SIDB store&#39;s CreatedTime to 2 month old time</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select CreatedTime from idxsidbstore where sidbstoreid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">created_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Original CreatedTime for SIDB store </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">created_time</span><span class="p">)</span>
        <span class="n">backdated_created_time</span> <span class="o">=</span> <span class="n">created_time</span> <span class="o">-</span> <span class="p">(</span><span class="mi">86400</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;2 month old CreatedTime for SIDB store </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">backdated_created_time</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxsidbstore set createdtime = </span><span class="si">%s</span><span class="s2"> where sidbstoreid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">backdated_created_time</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Set SIDB substore&#39;s idxcache values to dummy values which don&#39;t violate disk space constraints</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxcache set totalcapacitymb=204800, FreeDiskSpaceMB=181920 where IdxCacheId= &quot;</span> \
                <span class="s2">&quot;(select idxcacheid from idxsidbsubstore where sidbstoreid=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Now insert 30 rows with QI Time &gt; 1000 so that median value for last 30 days comes to be &gt; 1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting QI time count for last 30 days to be greater than 1000 microseconds&quot;</span><span class="p">)</span>


        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;declare @i int = 0</span>
<span class="s2">                declare @modifiedtime int = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                while @i &lt; 50</span>
<span class="s2">                begin</span>
<span class="s2">                insert into IdxSIDBUsageHistory values</span>
<span class="s2">                (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">,2,2,@modifiedtime,200000000,1500000,1100,100,0,0,0,40000000,0,&#39;&#39;,0,393,151366,0)</span>
<span class="s2">                set @i = @i + 1</span>
<span class="s2">                set @modifiedtime = @modifiedtime - 86400</span>
<span class="s2">                end</span>
<span class="s2">                &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">created_time</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">substore_id</span><span class="p">)</span>


        <span class="c1"># TODO: Add a check that if PrimaryCount is less than 200 million, new store will not get created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="c1"># Need to do this in every loop as new rows keep getting added to this table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting primary entry count for sidbstore to 200 million plus&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;update idxsidbusagehistory set PrimaryEntries = 200000000 where sidbstoreid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">sqlobj</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing stored proc to simulate MM thread invocations &amp; sleeping for 60 seconds&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;exec CommServ.dbo.archUpdateStoreLimitFlagOnStoragePolicy&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbhandle</span><span class="o">.</span><span class="n">execute_stored_procedure</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

            <span class="c1"># Now check if a new DDB has got created</span>
            <span class="n">current_ddbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_ddbs_for_copy</span><span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Second DDB got created for Storage Policy copy as expected&quot;</span><span class="p">)</span>
                <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Now check if 2nd DDB got marked as FULL</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that old DDB engine id </span><span class="si">%s</span><span class="s2"> is marked FULL&quot;</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
                    <span class="c1"># Check DDB FULL Reason</span>
                    <span class="n">return_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_ddb_full_reason</span><span class="p">(</span><span class="n">engine_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">new_engine_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current_ddbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ddb_full</span><span class="p">(</span><span class="n">new_engine_id</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that new DDB engine id </span><span class="si">%s</span><span class="s2"> is not FULL&quot;</span><span class="p">,</span> <span class="n">new_engine_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;New DDB engine id </span><span class="si">%s</span><span class="s2"> is marked as FULL instead of ACTIVE&quot;</span><span class="p">,</span> <span class="n">new_engine_id</span><span class="p">)</span>
                    <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There is still only 1 DDB of type FS associated with this storage policy copy&quot;</span><span class="p">)</span>
                <span class="n">return_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No new DDB creation happened, hence returning failure.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up storage policy.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_obj</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">subclient_obj</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_flag</span></div>

<div class="viewcode-block" id="TestCase.validate_ddb_full_reason"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.validate_ddb_full_reason">[docs]</a>    <span class="k">def</span> <span class="nf">validate_ddb_full_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">expected_reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates if DDB Full Reason matches with the user provided Full Reason</span>
<span class="sd">        Args:</span>
<span class="sd">        engine_id (int) -- DDB Engine ID</span>
<span class="sd">        expected_reason (int) -- Expected FULL reason</span>

<span class="sd">        Return:</span>
<span class="sd">        True if expected reason is same as DDB full reason in CSDB, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select FULLREASON from idxsidbstore where sidbstoreid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">full_reason</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">full_reason</span> <span class="o">==</span> <span class="n">expected_reason</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully verified that DDB FULL REASON = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expected_reason</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to verify DDB FULL REASON. Expected = </span><span class="si">%s</span><span class="s2"> Actual = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expected_reason</span><span class="p">,</span> <span class="n">full_reason</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TestCase.get_subclient_ddb_association"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.get_subclient_ddb_association">[docs]</a>    <span class="k">def</span> <span class="nf">get_subclient_ddb_association</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appid</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get DDB associated with a subclient for a given storage policy copy</span>
<span class="sd">        Args:</span>
<span class="sd">        appid (int) -- Subclient ID</span>
<span class="sd">        copy_id (int) -- Storage policy copy id</span>

<span class="sd">        Return:</span>
<span class="sd">        DDB Engine ID associated with the subclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select sidbstoreid from archsubclientcopyddbmap where appid = </span><span class="si">%s</span><span class="s2"> and copyid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appid</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="TestCase.get_all_ddbs_for_copy"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.get_all_ddbs_for_copy">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_ddbs_for_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_id</span><span class="p">,</span> <span class="n">apptypegroupid</span><span class="p">,</span> <span class="n">only_active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all DDB engines associated to a storage policy copy</span>
<span class="sd">        Args:</span>
<span class="sd">        copy_id (int) -- Storage policy copy id</span>
<span class="sd">        apptypegroupid (int) -- AppTypeGroupID ( FS=1001 DB=1002 VSA=1003)</span>
<span class="sd">        only_active (bool)  -- True for returning only active DDBs, by default set to False</span>

<span class="sd">        Return:</span>
<span class="sd">        List of all the DDBs associated with given copy based on whether user wants only active DDBs or all DDBs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">only_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;filtering out the FULL DDBs associated with copy&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select sidbstoreid from idxsidbstore where sidbstoreid in &quot;</span> \
                <span class="s2">&quot;(select sidbstoreid from archcopysidbstore where copyid=</span><span class="si">%s</span><span class="s2"> and flags  &amp; 1 &lt;&gt; 1)&quot;</span> \
                <span class="s2">&quot; and apptypegroupid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="n">apptypegroupid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fetching all the DDBs associated with copy&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select sidbstoreid from idxsidbstore where sidbstoreid in &quot;</span> \
                    <span class="s2">&quot;(select sidbstoreid from archcopysidbstore where copyid=</span><span class="si">%s</span><span class="s2">)&quot;</span> \
                    <span class="s2">&quot; and apptypegroupid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">copy_id</span><span class="p">,</span> <span class="n">apptypegroupid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestCase.is_ddb_full"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.is_ddb_full">[docs]</a>    <span class="k">def</span> <span class="nf">is_ddb_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engineid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if DDB is marked FULL</span>
<span class="sd">        Args:</span>
<span class="sd">        engineid (int) -- SIDB Store ID</span>

<span class="sd">        Return:</span>
<span class="sd">        True if DDB is FULL, false otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select flags&amp;1 from archcopysidbstore where sidbstoreid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">engineid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;QUERY: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1">#When DDB is FULL, flag 1 is set on store. So a FULL DDB will always have ODD number as flag.</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="TestCase.run_backup_job"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.run_backup_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_backup_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_obj</span><span class="p">,</span> <span class="n">backuptype</span><span class="o">=</span><span class="s2">&quot;Incremental&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a backup job on subclient</span>
<span class="sd">        Args:</span>
<span class="sd">        subclient_obj (object) -- object of subclient class</span>
<span class="sd">        backuptype (str) -- Backup type , Incremental by default.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fulljobobj</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backuptype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully initiated a backup job on subclient with jobid - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fulljobobj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fulljobobj</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Backup job </span><span class="si">%s</span><span class="s2"> did not complete in given timeout&quot;</span> <span class="o">%</span> <span class="n">fulljobobj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully completed a backup job on subclient with jobid - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fulljobobj</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestCase.create_subclient_run_backup"><a class="viewcode-back" href="../../source/Testcases.html#Testcases.54669.TestCase.create_subclient_run_backup">[docs]</a>    <span class="k">def</span> <span class="nf">create_subclient_run_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_number</span><span class="p">,</span> <span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="n">mmhelper_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a subclient and run backup on the subclient</span>
<span class="sd">        Args:</span>
<span class="sd">        subclient_number (int) -- subclient name suffix</span>
<span class="sd">        subclient_name_prefix (str) -- subclient name prefix</span>
<span class="sd">        mmhelper_obj (obj)  -- mmhelper object</span>

<span class="sd">        Return:</span>
<span class="sd">        Returns content subclient object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_content_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">subclient_number</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machineobj</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;----------Content directory </span><span class="si">%s</span><span class="s2"> created----------&quot;</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;---Configuring subclient </span><span class="si">%s</span><span class="s2">---&quot;</span><span class="p">,</span> <span class="n">subclient_number</span><span class="p">)</span>
        <span class="n">subclient_obj</span> <span class="o">=</span> <span class="n">MMHelper</span><span class="o">.</span><span class="n">configure_subclient</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">subclient_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">subclient_name_prefix</span><span class="p">,</span> <span class="n">subclient_number</span><span class="p">),</span> <span class="n">content_path</span><span class="o">=</span><span class="n">current_content_dir</span><span class="p">)</span>
        <span class="n">subclient_obj</span><span class="o">.</span><span class="n">data_readers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mmhelper_obj</span><span class="o">.</span><span class="n">create_uncompressable_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">current_content_dir</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_backup_job</span><span class="p">(</span><span class="n">subclient_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subclient_obj</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>