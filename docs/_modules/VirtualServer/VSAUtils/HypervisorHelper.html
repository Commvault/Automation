

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>VirtualServer.VSAUtils.HypervisorHelper &mdash; Commvault Automation 11.21 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>VirtualServer.VSAUtils.HypervisorHelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for VirtualServer.VSAUtils.HypervisorHelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main file that does all operations on hypervsor</span>

<span class="sd">classes defined:</span>
<span class="sd">    Base class:</span>
<span class="sd">        Hypervisor- Act as base class for all hypervior operations</span>

<span class="sd">    Inherited class:</span>
<span class="sd">        HyperVHelper - Does all operations on Hyper-V Hypervisor</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_all_vms_in_hypervisor()    - abstract -get all the VMs in that hypervisor</span>

<span class="sd">        compute_free_resources()    - compute teh free resource for perfoming restores</span>

<span class="sd">    VmwareHelper:</span>

<span class="sd">        get_all_vms_in_hypervisor()		        - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">        compute_free_resources()		        - compute the Vmware host and Datastore</span>
<span class="sd">                                                    for performing restores</span>

<span class="sd">        _vmware_login()                         - Login to vcenter 6.5 and above</span>

<span class="sd">        _make_request()                         - Rest api calls to vcenter</span>

<span class="sd">        _vmware_get_vms()                       - Get list of qualified vms</span>

<span class="sd">        _get_vcenter_version()                  - get the vcenter version</span>

<span class="sd">        get_all_vms_in_hypervisor()             - Get complete list of vms in the vcenter</span>

<span class="sd">        compute_free_resources()                - Calculate free resources</span>

<span class="sd">        _get_datastore_dict()                   - Get list of datastore with free space</span>

<span class="sd">        _get_host_memory()                      - Get list of esx with free ram and cpu</span>

<span class="sd">        _get_required_resource_for_restore()    - Get restore vm ram and storage requirement</span>

<span class="sd">        _get_datastore_priority_list()          - Get list of datastore in descending</span>
<span class="sd">                                                    order as per free space</span>

<span class="sd">        _get_host_priority_list()               -  Get list of esx in descending oder</span>
<span class="sd">                                                    as per free ram</span>

<span class="sd">        _get_datastore_tree_list()              - get datastore hierarchy</span>

<span class="sd">        copy_test_data_to_each_volume()         - Copy test data to backup vm</span>

<span class="sd">    AzureHelper:</span>

<span class="sd">        get_access_token()		                - Get access token for any first authorization</span>

<span class="sd">        check_for_access_token_expiration()     - this function check if access_token is</span>
<span class="sd">                                                  expired if yes it will generate one</span>

<span class="sd">        copy_test_data_to_each_volume           - copy testdata to each volume in the vm</span>

<span class="sd">        update_hosts                            - Update the VM data Information</span>

<span class="sd">        collect_all_vm_data                     - Collect all VM Data</span>

<span class="sd">        collect_all_resource_group_data         - Collect All RG Info</span>

<span class="sd">        get_all_resource_group                  - get resource group info</span>

<span class="sd">        get_resourcegroup_name                  - gets the resource group of that VM</span>

<span class="sd">        get_resourcegroup_for_region            - get the Resource group for that particular</span>
<span class="sd">                                                  region</span>

<span class="sd">        compute_free_resources                  - compute all free resources required</span>

<span class="sd">         get_storage_access_token               - Gets storage access token</span>

<span class="sd">         check_for_storage_access_token_expiration - Checks if storage  access token has expired</span>

<span class="sd">    AzureStackHelper:</span>

<span class="sd">        compute_free_resources                  - compute all free resources required</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">xmltodict</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">VMHelper</span><span class="p">,</span> <span class="n">VirtualServerConstants</span><span class="p">,</span> <span class="n">VirtualServerUtils</span><span class="p">,</span> \
    <span class="n">FusionComputeServices</span><span class="p">,</span> <span class="n">OracleCloudServices</span><span class="p">,</span> <span class="n">OpenStackWrapper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">machine</span>


<div class="viewcode-block" id="Hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor">[docs]</a><span class="k">class</span> <span class="nc">Hypervisor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for performing all Hypervisor operations</span>

<span class="sd">    Methods:</span>
<span class="sd">         get_all_vms_in_hypervisor()    - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">        compute_free_resources()        - compute the hyperv host and destiantion path</span>
<span class="sd">                                                    for perfoming restores</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                <span class="n">user_name</span><span class="p">,</span>
                <span class="n">password</span><span class="p">,</span>
                <span class="n">instance_type</span><span class="p">,</span>
                <span class="n">commcell</span><span class="p">,</span>
                <span class="n">host_machine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object based in intstance_type</span>

<span class="sd">        server_name (list)  - hypervisor name eg: vcenter name or Hyperv host</span>

<span class="sd">        host_machine    (str)  - client of cs where we will execute all hypervisor operations</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">instance_helper</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">instance_helper</span><span class="p">(</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instance_helper</span> <span class="o">==</span> <span class="s1">&#39;AliCloudHelper&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.alicloud</span> <span class="k">import</span> <span class="n">AliCloudHelper</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">instance_helper</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize common variables for hypervior</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_list</span> <span class="o">=</span> <span class="n">server_host_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_machine</span> <span class="o">=</span> <span class="n">host_machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_machine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets the user name of the Vm . it si read only attribute&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_name</span>

    <span class="nd">@vm_user_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets the user name of the VM if it is differnt form default&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets the user name of the Vm . it si read only attribute&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span>

    <span class="nd">@vm_password</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets the user name of the VM if it is differnt form default&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns List of VMs. It is read onlyt attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span>

    <span class="nd">@VMs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;creates VMObject for list of VM passed</span>
<span class="sd">        Args:</span>
<span class="sd">            vmList    (list) - list of VMs for creating VM object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">vm_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VMs are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in creating object </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="Hypervisor.to_vm_object"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.to_vm_object">[docs]</a>    <span class="k">def</span> <span class="nf">to_vm_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hypervisor.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.get_all_vms_in_hypervisor">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all the Vms in Hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                server    (str)    - specific hypervisor Host for which all Vms has to be fetched</span>

<span class="sd">                pattern    (str)   - Pattern to fetch the vms</span>

<span class="sd">                c_type            (str):  Type of content</span>

<span class="sd">        Return:</span>
<span class="sd">                Vmlist    (list)    - List of Vms in  in host of Pseudoclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get all the VMs in hypervisor class&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hypervisor.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.compute_free_resources">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_list  - list of servers from which best has to be chosen</span>

<span class="sd">            vm_list     - list of Vm to be restored</span>

<span class="sd">        Return:</span>
<span class="sd">                host         (str)    - hypervisor host where vm is to be restored</span>
<span class="sd">                                            like esx, resourcegroup,region,hyperv host</span>

<span class="sd">                datastore    (str)    - diskspace where vm needs to be restored</span>
<span class="sd">                                            like destinationpath,datastore,bucket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;computes the free ESXHost and Datastore in case of VMware&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hypervisor.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy testdata to each volume in the vm provided</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name             (str):  vm to which test data has to be copied</span>

<span class="sd">            _drive              (str):  Drive letter where data needs to be copied</span>

<span class="sd">            backup_folder       (str):  name of the folder to be backed up</span>

<span class="sd">            _test_data_path     (str):  path where testdata needs to be generated</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to generate testdata or if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">))</span>
            <span class="c1"># create Base dir</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">guest_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linux&quot;</span><span class="p">,</span> <span class="s2">&quot;unix&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;windows&#39;</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying testdata to volume </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span> <span class="n">_dest_base_path</span><span class="p">)</span>
            <span class="n">_validation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span>
                                                                   <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">compare_folders</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">,</span>
                                            <span class="n">_validation_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Testdata copy failure on vm:</span><span class="si">{}</span><span class="s2"> on drive:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testdata copied and checksum matched successfully on vm </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="Hypervisor.copy_content_indexing_data"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.copy_content_indexing_data">[docs]</a>    <span class="k">def</span> <span class="nf">copy_content_indexing_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided for content indexing</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name     (basestring):   vm to which test data has to be copied</span>

<span class="sd">                _drive      (basestring):   Drive letter where data needs to be copied</span>

<span class="sd">                backup_folder(basestring):  name of the folder to be backed up</span>

<span class="sd">        Exception:</span>
<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">()</span>
            <span class="n">_test_data_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">get_content_indexing_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>
            <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span>
                                           <span class="n">backup_folder</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying content indexing test data&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span> <span class="n">_dest_base_path</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying content indexing data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="Hypervisor.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the Information of Host</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Host Is updated&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HyperVHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper">[docs]</a><span class="k">class</span> <span class="nc">HyperVHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Hyperv Hyperviosr</span>

<span class="sd">    Methods:</span>
<span class="sd">            get_all_vms_in_hypervisor()        - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">            compute_free_resources()        - compute the hyperv host and destiantion path</span>
<span class="sd">                                                    for perfoming restores</span>

<span class="sd">            mount_disk()                    - Mount the Vhd/VHDX and return the drive letter</span>

<span class="sd">            un_mount_disk()                    - Unmount the VHD mounted provided the path</span>

<span class="sd">            _get_datastore_dict()            - get the list of drives with space in Hyper-V</span>

<span class="sd">            _get_datastore_priority_list()    - return the drives in Hyper-V Host in</span>
<span class="sd">                                                    increasing order of disk size</span>

<span class="sd">            _get_proxy_priority_list()        - returns the proxy associated with that instance in</span>
<span class="sd">                                                    increasing order of memory</span>

<span class="sd">            _get_required_memory_for_restore()- Sum of Memory of the VM to be restored</span>

<span class="sd">            _get_required_diskspace_for_restore()- Sum of disk space of the VM to be restored</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Hyper-V Helper class properties</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HyperVHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span> <span class="o">=</span> <span class="s2">&quot;GetHypervProps.ps1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vhd&quot;</span><span class="p">,</span> <span class="s2">&quot;.avhd&quot;</span><span class="p">,</span> <span class="s2">&quot;.vhdx&quot;</span><span class="p">,</span> <span class="s2">&quot;.avhdx&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vhd_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>

<div class="viewcode-block" id="HyperVHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all the Vms in Hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                server    (str)    - specific hypervisor Host for which all Vms has to be fetched</span>

<span class="sd">                pattern   (str)   - Pattern to fetch the vms</span>

<span class="sd">                c_type            (str):  Type of content</span>

<span class="sd">        Return:</span>
<span class="sd">                Vmlist    (list)    - List of Vms in  in host of Pseudoclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_all_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">server</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">server_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">server_list</span> <span class="o">=</span> <span class="n">server</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">server_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">server</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">_each_server</span> <span class="ow">in</span> <span class="n">server_list</span><span class="p">:</span>
                <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_each_server</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetAllVM&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
                <span class="c1"># _stdout, _stderr = VirtualServerUtils.ExecutePsFile(</span>
                <span class="c1"># _ps_path, _each_server, self.user_name, self.password, &quot;&quot;, &quot;GetAllVM&quot;)</span>

                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                            <span class="n">_all_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_all_vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred while getting all Vms from Hypervisor&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperVHelper.mount_disk"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.mount_disk">[docs]</a>    <span class="k">def</span> <span class="nf">mount_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_obj</span><span class="p">,</span> <span class="n">_vhdpath</span><span class="p">,</span> <span class="n">destination_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mount the disk and return the drive letter mounted</span>

<span class="sd">        vm_obj -         (str)    - Vm helper object of the VM for which disk has to be mounted</span>

<span class="sd">        _vhdpath    (str)    - diks path has to be mounted</span>

<span class="sd">        destination_client  (obj)   - client where the disk to be mounted are located</span>

<span class="sd">        return:</span>
<span class="sd">                _drive_letter    (list)    - drive lettter in which disk is mounted</span>

<span class="sd">        Exception:</span>
<span class="sd">                if disk failed to mount</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_drive_letter</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">,</span> <span class="n">destination_client</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_drive_letter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VsHD might be corrupted mouting failed,&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot Mount the disk&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mounting restored VHD was succesfull&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Drive letter is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_drive_letter</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_drive_letter</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;exception raised in Mounting Disk , cannot proceed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.un_mount_disk"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.un_mount_disk">[docs]</a>    <span class="k">def</span> <span class="nf">un_mount_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_obj</span><span class="p">,</span> <span class="n">_vhdpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        unmount the disk taht is mounted</span>

<span class="sd">         vm_obj -         (str)    - Vm helper object of the VM for which disk has to be unmounted</span>

<span class="sd">        _vhdpath    (str)    - diks path has to be unmounted</span>


<span class="sd">        Exception:</span>
<span class="sd">                if disk failed to unmount</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to unmount diks </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_vhdpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VHD file exists...unmounting the file&quot;</span><span class="p">)</span>
                <span class="n">vm_obj</span><span class="o">.</span><span class="n">un_mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Mountpath provided for cleanup...checking for vhd files&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.vhd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.vhdx&quot;</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.avhd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.avhdx&quot;</span><span class="p">)):</span>
                            <span class="n">_vhdpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found VHD file... &quot;</span> <span class="o">+</span> <span class="n">_vhdpath</span><span class="p">)</span>
                            <span class="n">vm_obj</span><span class="o">.</span><span class="n">un_mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;exception raised in UnMounting Disk , cannot proceed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the list of datastore in an proxy</span>

<span class="sd">        proxy                 (str)    - list of datastores in that</span>
<span class="sd">                                            particular proxy would be returned</span>
<span class="sd">        proxy_host_name       (str)    - host_name of the proxy</span>

<span class="sd">        Return:</span>
<span class="sd">                disk_size_dict    (dict)    - with drive as keys and size</span>
<span class="sd">                                                    as values in proxy provided</span>
<span class="sd">                                                        disk_size_dict = {&#39;proxy-c&#39;:14586}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DISKSIZE&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>

            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">_stdout</span><span class="p">:</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_stdlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">disk</span> <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">disk</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">_each_disk</span> <span class="ow">in</span> <span class="n">_stdlines</span><span class="p">:</span>
                    <span class="n">_diskname</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">_each_disk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_disksize</span> <span class="o">=</span> <span class="n">_each_disk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">_diskname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_disksize</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_disk_size_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetDatastoreDict Disk &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the free memory in proxy</span>

<span class="sd">        Args:</span>

<span class="sd">                proxy     (str)    - list of datastores in that particular proxy would be returned</span>

<span class="sd">                proxy_host_name       (str)    - host_name of the proxy</span>

<span class="sd">        return:</span>
<span class="sd">                val     (int)    - free  memory of Host in GB eg:; 3GB</span>

<span class="sd">        Exception:</span>
<span class="sd">                Raise exception when failed to get Memeory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;HostMemory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>

            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">_stdout</span><span class="p">:</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">val</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Memory&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetMemory  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the host network card name</span>

<span class="sd">        Args:</span>

<span class="sd">                proxy               (str)   - Name of the proxy client</span>

<span class="sd">                proxy_host_name     (str)   - Host_name of the proxy</span>

<span class="sd">        return:</span>
<span class="sd">                str - Network card present in the host machine</span>

<span class="sd">        Exception:</span>
<span class="sd">                Raise exception when failed to get network card</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;HostNetwork&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>

            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">_stdout</span><span class="p">:</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">val</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Network&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Network&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_datastore_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From the given list of proxy get all the details of drive and space</span>
<span class="sd">                                                                and order them in increasing size</span>

<span class="sd">        Args:</span>
<span class="sd">                vsa_proxy_list            (list)    - list of proxies which needs to be</span>
<span class="sd">                                                                    ordered as per disk size</span>

<span class="sd">                host_dict                 (dict)    -dictionary of proxies and their matching host name</span>
<span class="sd">        returns:</span>
<span class="sd">            _sorted_datastore_dict(dict)    - with disk proxy-drive name as keys and size as values</span>
<span class="sd">                                                        _sorted_datastore_dict = {&#39;proxy-c&#39;:14586,</span>
<span class="sd">                                                                                  &#39;proxy1-D&#39;:12456}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">_each_proxy</span> <span class="ow">in</span> <span class="n">vsa_proxy_list</span><span class="p">:</span>
                <span class="n">_datastoredict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">(</span><span class="n">_each_proxy</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">[</span><span class="n">_each_proxy</span><span class="p">])</span>
                <span class="n">_datastore_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_datastoredict</span><span class="p">)</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                        <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  GetDatastorePriorityList &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_proxy_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the free host memory in proxy and arrange them with increarsing order</span>

<span class="sd">        Args:</span>
<span class="sd">                vsa_proxy_list            (list)    - list of proxies which needs to be</span>
<span class="sd">                                                    ordered as per Host Memory</span>

<span class="sd">                host_dict                 (dict)    -dictionary of proxies and their matching host name</span>
<span class="sd">        returns:</span>
<span class="sd">                _sorted_proxy_dict    (dict)    - with disk proxy name as keys and memory as values</span>
<span class="sd">                                                                _sorted_proxy_dict = {&#39;proxy&#39;:5GB,</span>
<span class="sd">                                                                                     &#39;proxy1&#39;:4GB}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_proxy_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">vsa_proxy_list</span><span class="p">:</span>
                <span class="n">_proxy_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_memory</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">])</span>
                <span class="n">_proxy_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_proxy_memory</span><span class="p">)</span>

            <span class="n">_sorted_proxy_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_proxy_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                    <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_proxy_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in  GetProxyPriorityList &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_memory_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the memory of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_list    (list)    - list of vm to be restored</span>

<span class="sd">        returns:</span>
<span class="sd">                sum of total memory of VM to be restored in Gb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">guest_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                    <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_vm_total_memory</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_diskspace_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the disk space of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_list    (list)    - list of vm to be restored</span>

<span class="sd">        returns:</span>
<span class="sd">                sum of total disk space of VM to be restored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_total_disk_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">guest_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
                    <span class="n">storage_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_storage_details</span><span class="p">()</span>
                    <span class="n">_vm_total_disk_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">storage_details</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
            <span class="n">_vm_total_disk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_vm_total_disk_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_disk_size</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  _get_required_diskspace_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="HyperVHelper.get_disk_in_the_path"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.get_disk_in_the_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_disk_in_the_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         get all the disks in the folder</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_path     (str)   - path of the folder from which disk needs to be listed</span>
<span class="sd">                                        e.g: C:\\CVAutomation</span>

<span class="sd">         Returns:</span>
<span class="sd">                disk_list   (list)-   list of disks in the folder</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the list of files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">disk_name_with_path</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">disk_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">disk_name_with_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">disk_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span><span class="p">):</span>
                    <span class="n">_disk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_disk_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception occurred </span><span class="si">{0}</span><span class="s2"> in getting disk list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="HyperVHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies from which best proxy has to found</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">                vm_list        (list) - list of Vms to be restored</span>

<span class="sd">        return:</span>
<span class="sd">                proxy_name    (str)    - the proxy where restore can be performed</span>

<span class="sd">                datastore_name(str)    - datastore where restore has to be performed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">proxy_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datastore_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">_proxy_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proxy_priority_list</span><span class="p">(</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">)</span>
            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_priority_list</span><span class="p">(</span>
                <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">)</span>
            <span class="n">_total_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_memory_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_diskspace_for_restore</span><span class="p">(</span>
                <span class="n">vm_list</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">proxy_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_network</span><span class="p">(</span><span class="n">proxy_name</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">[</span><span class="n">proxy_name</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;The Datastore </span><span class="si">%s</span><span class="s2"> has more than total disk space in VM&quot;</span> <span class="o">%</span> <span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_proxy_priority_dict</span><span class="p">[</span><span class="n">proxy_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;the Proxy </span><span class="si">%s</span><span class="s2"> has higher memory than the total VMs&quot;</span> <span class="o">%</span> <span class="n">proxy_name</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">proxy_name</span><span class="p">,</span> <span class="n">datastore_name</span><span class="p">,</span> <span class="n">network</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in  ComputeFreeResources &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.check_cbt_driver_running"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.check_cbt_driver_running">[docs]</a>    <span class="k">def</span> <span class="nf">check_cbt_driver_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if CBT driver is running on the hyperv node</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies/ hyperv nodes</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">        Exception:</span>
<span class="sd">                If unable to check CBT driver status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">driver_state</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;cmd.exe /c &quot;sc query cvcbt&quot;&#39;</span>
                <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">driver_state</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">_output</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The CVCBT driver is running on proxy </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The CVCBT driver is not running on the proxy </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  checking if CVCBT driver is running  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.check_or_set_cbt_registry"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.check_or_set_cbt_registry">[docs]</a>    <span class="k">def</span> <span class="nf">check_or_set_cbt_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">,</span> <span class="n">instanceno_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check/Set if CBT registry for CBT testing is set on the proxies</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies/ hyperv nodes</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">        Returns:</span>
<span class="sd">                CBTStatFolder (String) -Folder path where CBT stats are collected</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                An error occurred while checking/creating the registry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">proxy_machine</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instanceno_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span>
                <span class="n">registry_path</span> <span class="o">=</span> <span class="s2">&quot;VirtualServer&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_registry_exists</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">CBTStatFolder</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">get_registry_value</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CBTStatFolder</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">CBTStatus&quot;</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">,</span> <span class="n">CBTStatFolder</span><span class="p">,</span> <span class="s2">&quot;String&quot;</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;bDumpCVCBTStatsToFile&quot;</span><span class="p">,</span> <span class="s2">&quot;00000001&quot;</span><span class="p">,</span> <span class="s2">&quot;DWord&quot;</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;bDumpCVCBTStats&quot;</span><span class="p">,</span> <span class="s2">&quot;00000001&quot;</span><span class="p">,</span> <span class="s2">&quot;DWord&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;An error occured while creating the registry&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checked and created CBT driver dump stats registry&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CBTStatFolder</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred while checking/creating the registry  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="VmwareHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper">[docs]</a><span class="k">class</span> <span class="nc">VmwareHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Vmware Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Vmware Helper class properties</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (str):      Hostname of the Vcenter</span>

<span class="sd">            host_machine        (str):      Vcenter name</span>

<span class="sd">            user_name           (str):      Username of the Vcenter</span>

<span class="sd">            password            (str):      Password of the Vcenter</span>

<span class="sd">            instance_type       (str):      Instance type of the Vmware</span>

<span class="sd">            auto_commcell       (object):   Commcell object</span>

<span class="sd">            **kwargs            (dict):   Optional arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pyVmomi</span> <span class="k">import</span> <span class="n">vim</span><span class="p">,</span> <span class="n">vmodl</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VmwareHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span> <span class="o">=</span> <span class="s2">&quot;GetVmwareProps.ps1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
            <span class="s2">&quot;pwd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vmdk&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vim</span> <span class="o">=</span> <span class="n">vim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmodl</span> <span class="o">=</span> <span class="n">vmodl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_login</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_vmware_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login to vcenter 6.0 and above</span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to login to vcenter server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyVim.connect</span> <span class="k">import</span> <span class="n">SmartConnectNoSSL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">SmartConnectNoSSL</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                                                <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                                                <span class="n">pwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection successful to VC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">about</span><span class="o">.</span><span class="n">version</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="VmwareHelper.get_content"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.get_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vimtype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get content object</span>
<span class="sd">        Args:</span>
<span class="sd">            vimtype             (object): vim type</span>

<span class="sd">        Returns:</span>
<span class="sd">            obj                 (object):   object of the content of vimtype</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get content</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_try</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="n">_try</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">viewManager</span><span class="o">.</span><span class="n">CreateContainerView</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">rootFolder</span><span class="p">,</span> <span class="n">vimtype</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">fault</span><span class="o">.</span><span class="n">NotAuthenticated</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Session timed out. Reconnecting&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_login</span><span class="p">()</span>
                    <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">viewManager</span><span class="o">.</span><span class="n">CreateContainerView</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">rootFolder</span><span class="p">,</span> <span class="n">vimtype</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">managed_object_ref</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">managed_object_ref</span><span class="p">:</span> <span class="n">managed_object_ref</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                <span class="n">container</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">obj</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error:</span><span class="si">{}</span><span class="s2"> Attempt </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">_try</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">_try</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Not able to get content from VC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_vmware_get_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all vms of the vcenter</span>

<span class="sd">        Returns:</span>
<span class="sd">             vmlist         (dict): list of vms in the Vcenter</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vms from vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vmlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">get_all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">get_all_vms</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Issue with vm: </span><span class="si">{}</span><span class="s2">. Skipping it&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vm</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">return</span> <span class="n">vmlist</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting list of vms from vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="VmwareHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the vms for vmware</span>

<span class="sd">        Args:</span>
<span class="sd">            server          (str):  Vcenter for which all the VMs has to be fetched</span>

<span class="sd">            pattern         (str):  Pattern to fetch the vms</span>

<span class="sd">            c_type            (str):  Type of content</span>

<span class="sd">        Returns:</span>
<span class="sd">            _all_vm_list    (str):  List of VMs in the host of the Vcenter</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vms from vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_all_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c_type</span><span class="p">:</span>
                <span class="n">get_all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_get_vms</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No pattern received&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rep</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type:server&#39;</span><span class="p">:</span> <span class="s1">&#39;:runtime.host.name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:datastore&#39;</span><span class="p">:</span> <span class="s1">&#39;:datastore[0].name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:datacenter&#39;</span><span class="p">:</span> <span class="s1">&#39;:parent.parent.name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:cluster&#39;</span><span class="p">:</span> <span class="s1">&#39; :runtime.host.parent.name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:resource_pool&#39;</span><span class="p">:</span> <span class="s1">&#39;:resourcePool.name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:vmpowerstate&#39;</span><span class="p">:</span> <span class="s1">&#39;:runtime.powerState&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:vmguestos&#39;</span><span class="p">:</span> <span class="s1">&#39;:config.guestFullName&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:vmguesthostname&#39;</span><span class="p">:</span> <span class="s1">&#39;:guest.hostName&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:tag&#39;</span><span class="p">:</span> <span class="s1">&#39;:get-tag&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type:tagcategory&#39;</span><span class="p">:</span> <span class="s1">&#39;:get-tagcategory&#39;</span><span class="p">}</span>
                <span class="n">rep</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rep</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rep</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">rep</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))],</span> <span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;get-tag&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                    <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_type</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                        <span class="n">get_all_vms</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in getting tags/category vms: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;id:&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;_moId&#39;</span><span class="p">)</span>
                    <span class="n">get_all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_vms</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">get_all_vms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[()\sA-Za-z0-9_-]*&quot;</span><span class="p">,</span> <span class="n">vm</span><span class="p">):</span>
                    <span class="n">_all_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_all_vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting all VMs from Vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_filter_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters teh vms from the vm list</span>
<span class="sd">        Args:</span>
<span class="sd">            pattern             (string):   Patten to be looked for in vms</span>

<span class="sd">        Returns:</span>
<span class="sd">            vms                 (list):     List of vms matching the pattern</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_prop</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_value</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">])</span>
        <span class="n">_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">all_vms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;vm.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_prop</span><span class="p">)):</span>
                <span class="n">vms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vms</span>

<div class="viewcode-block" id="VmwareHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list         (list):  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            Datastore	    (str):  The Datastore where restore can be performed</span>

<span class="sd">            ESX             (str):  ESX where restore has to be performed</span>

<span class="sd">            Cluster         (str):  Cluster where restore has to be performed</span>

<span class="sd">            Datacenter      (str):  DataCenter where restore has to be performed</span>

<span class="sd">            network         (str):  Netowrk which needs to be attached</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get Datastore or ESX or Cluster or Datacenter or all</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()</span>
            <span class="n">_host_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_memory</span><span class="p">()</span>
            <span class="n">network</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_total_vm_memory</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The Datastore </span><span class="si">{}</span><span class="s2"> has more than total&quot;</span>
                                  <span class="s2">&quot;disk space in VM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datastore_name</span><span class="p">))</span>
                    <span class="n">_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_tree_list</span><span class="p">(</span><span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_host_priority_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">_host_priority_dict</span><span class="p">[</span><span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">esx_host</span><span class="p">:</span>
                                    <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_network</span><span class="p">(</span><span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">network</span><span class="p">:</span>
                                        <span class="k">break</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">network</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;the Host </span><span class="si">{}</span><span class="s2"> has higher &quot;</span>
                                <span class="s2">&quot;memory than the total VMs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]))</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]],</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">],</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;Datacenter&#39;</span><span class="p">],</span> <span class="n">network</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting &quot;</span>
                               <span class="s2">&quot;datastore or ESX or Cluster or Datacenter or all&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of datastore in an ESX</span>

<span class="sd">        Returns:</span>
<span class="sd">            _disk_size_dict     (dict): Datastores with name and free spaces</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get datastores from the Vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">Datastore</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">all_ds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">accessible</span> <span class="ow">and</span> <span class="s1">&#39;GX_BACKUP&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">free_space</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">freeSpace</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
                    <span class="n">_disk_size_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">free_space</span><span class="p">)</span>
            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="n">_disk_size_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_disk_size_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in _get_datastore_dict  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_all_nics_in_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the nics in the host</span>

<span class="sd">        Returns:</span>
<span class="sd">            nics_dict           (list):     list of nics in each esx host</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get nic cards from the Vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_nics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_esx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">HostSystem</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">esx</span> <span class="ow">in</span> <span class="n">all_esx</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">network</span> <span class="ow">in</span> <span class="n">esx</span><span class="o">.</span><span class="n">network</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">_nics_dict</span><span class="p">[</span><span class="n">esx</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">name</span>
            <span class="k">return</span> <span class="n">_nics_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in _get_all_nics_in_host  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the free memory in the ESX</span>

<span class="sd">        Returns:</span>
<span class="sd">            _esx_dict           (dict): Dictionary of ESX and its free space</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get Memory of the ESX</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_esx_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_esx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">HostSystem</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">all_esx</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
                    <span class="n">total_memory</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">memorySize</span>
                    <span class="n">used_memory</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">quickStats</span><span class="o">.</span><span class="n">overallMemoryUsage</span>
                    <span class="n">free_memory</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_memory</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">used_memory</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
                    <span class="n">_esx_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">free_memory</span><span class="p">)</span>
            <span class="n">_esx_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="n">_esx_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_esx_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetMemory  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the network in the ESX</span>

<span class="sd">        Args:</span>
<span class="sd">            host            (basestring):   the esx host whose network is to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">            network         (basestring):   the network in the ESX host</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get network of the ESX</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ipaddress</span>
            <span class="n">vms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">network_count</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">all_vms</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">powerState</span> <span class="o">==</span> <span class="s1">&#39;poweredOn&#39;</span><span class="p">:</span>
                        <span class="n">vms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Issue with vm: </span><span class="si">{}</span><span class="s2">. Skipping it&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vms</span><span class="p">:</span>
                <span class="n">_ip</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">guest</span><span class="o">.</span><span class="n">ipAddress</span>
                <span class="k">if</span> <span class="n">_ip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">_ip</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^169\.254&#39;</span><span class="p">,</span> <span class="n">_ip</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">network_count</span><span class="p">:</span>
                            <span class="n">network_count</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">network_count</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">net_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">network_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">net_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetNetwork&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the memory of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list             (list):  list of vm to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            _vm_total_memory    (int):  Total memory required for restoring</span>

<span class="sd">            _vm_total_space     (int):  Total disk space required for restoring</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get space and ram of the source vm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">copy_vm_list</span> <span class="o">=</span> <span class="n">vm_list</span>
            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">get_all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">])</span>
            <span class="n">vms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">copy_vm_list</span><span class="p">,</span> <span class="n">get_all_vms</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vms</span><span class="p">:</span>
                <span class="n">space</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">memorySizeMB</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">vm</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">perDatastoreUsage</span><span class="p">:</span>
                    <span class="n">space</span> <span class="o">=</span> <span class="n">space</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">_v</span><span class="o">.</span><span class="n">committed</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="n">memory</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="n">space</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Error occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_datastore_tree_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datastore</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the free host memory in proxy and arrange them with ascending order</span>

<span class="sd">        Args:</span>
<span class="sd">            datastore           (str):  Datastore for which we need need to find the hierarchy</span>

<span class="sd">        Returns:</span>
<span class="sd">            tree_list           (dict): Dict contains parent ESX, Cluster, Datacenter for the datastore</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get tree structure for the datastore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">Datastore</span><span class="p">])</span>
            <span class="n">datastores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">datastore</span> <span class="o">==</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">all_ds</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datastores</span><span class="p">:</span>
                <span class="n">tree_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ESX&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;Datacenter&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">tree_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to find datastore&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An error occurred in  _get_datastore_tree_list &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="VmwareHelper.deploy_ova"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.deploy_ova">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_ova</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ova_path</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">esx_host</span><span class="p">,</span> <span class="n">datastore</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">vm_password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy the OVA in the vcenter ESX</span>

<span class="sd">        Args:</span>
<span class="sd">            ova_path        (basestring):   the path where the OVA file is present</span>

<span class="sd">            vm_name         (basestring):   the name with which the OVA needs to be deployed</span>

<span class="sd">            esx_host        (basestring):   the esx host where the VM is to be deployed</span>

<span class="sd">            datastore       (basestring):   datastore to store the VM</span>

<span class="sd">            network         (basestring):   network to attach the VM to</span>

<span class="sd">            vm_password     (basestring):   the password of the new VM</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="s2">&quot;DeployOVA.ps1&quot;</span><span class="p">)</span>
            <span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                <span class="s2">&quot;pwd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                <span class="s2">&quot;ova_path&quot;</span><span class="p">:</span> <span class="n">ova_path</span><span class="p">,</span>
                <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="n">vm_name</span><span class="p">,</span>
                <span class="s2">&quot;esx_host&quot;</span><span class="p">:</span> <span class="n">esx_host</span><span class="p">,</span>
                <span class="s2">&quot;datastore&quot;</span><span class="p">:</span> <span class="n">datastore</span><span class="p">,</span>
                <span class="s2">&quot;vm_network&quot;</span><span class="p">:</span> <span class="n">network</span><span class="p">,</span>
                <span class="s2">&quot;vm_pwd&quot;</span><span class="p">:</span> <span class="n">vm_password</span>
            <span class="p">}</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="n">prop_dict</span><span class="p">)</span>
            <span class="n">exception_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Exception&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot&quot;</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">exp</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exception_list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Something went wrong while deploying OVA. Please check logs.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>

<div class="viewcode-block" id="VmwareHelper.find_vm"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.find_vm">[docs]</a>    <span class="k">def</span> <span class="nf">find_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds the vm and returns its status, ESX and Datastore</span>

<span class="sd">            Args:</span>
<span class="sd">                vm_name             (str): Name of the VM to be searched</span>

<span class="sd">            Returns:</span>
<span class="sd">                vm_detail           (list): VM found status, ESX and DS</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    Raise exception when failed to get the status of the vm</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">])</span>
            <span class="n">vms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">vm_name</span> <span class="o">==</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">get_all_vms</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vms</span><span class="p">:</span>
                    <span class="n">_ds</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">logDirectory</span>
                    <span class="n">_ds</span> <span class="o">=</span> <span class="n">_ds</span><span class="p">[</span><span class="n">_ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">_ds</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)]</span>
                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_ds</span>
            <span class="k">return</span> <span class="s1">&#39;Multiple&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in finding the vm details&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VmwareHelper.find_esx_parent"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.find_esx_parent">[docs]</a>    <span class="k">def</span> <span class="nf">find_esx_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_host</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Finds the parent of the ESX host</span>

<span class="sd">            Args:</span>
<span class="sd">               vm_host             (str): ESX host to be checked for</span>

<span class="sd">            Returns:</span>
<span class="sd">               vm_host_detail      (list): ParentId and Parent name</span>

<span class="sd">            Raises:</span>
<span class="sd">               Exception:</span>
<span class="sd">                   Raise exception when failed to get the parent of the vm</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_host_detail</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_esx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">HostSystem</span><span class="p">])</span>
            <span class="n">esx_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">vm_host</span> <span class="o">==</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">all_esx</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">esx_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vm_host_detail</span> <span class="o">=</span> <span class="p">[</span><span class="n">host</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_moId</span><span class="p">,</span> <span class="n">host</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">vm_host_detail</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in finding the vm details: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VmwareHelper.wait_for_tasks"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.wait_for_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits till a task if completed</span>
<span class="sd">        Args:</span>
<span class="sd">            tasks                   (object):   Task to be monitored</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">property_collector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">propertyCollector</span>
        <span class="n">task_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
        <span class="n">obj_specs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vmodl</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">PropertyCollector</span><span class="o">.</span><span class="n">ObjectSpec</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
        <span class="n">property_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmodl</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">PropertyCollector</span><span class="o">.</span><span class="n">PropertySpec</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">Task</span><span class="p">,</span>
                                                                        <span class="n">pathSet</span><span class="o">=</span><span class="p">[],</span>
                                                                        <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filter_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmodl</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">PropertyCollector</span><span class="o">.</span><span class="n">FilterSpec</span><span class="p">()</span>
        <span class="n">filter_spec</span><span class="o">.</span><span class="n">objectSet</span> <span class="o">=</span> <span class="n">obj_specs</span>
        <span class="n">filter_spec</span><span class="o">.</span><span class="n">propSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">property_spec</span><span class="p">]</span>
        <span class="n">pc_filter</span> <span class="o">=</span> <span class="n">property_collector</span><span class="o">.</span><span class="n">CreateFilter</span><span class="p">(</span><span class="n">filter_spec</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_list</span><span class="p">):</span>
                <span class="n">update</span> <span class="o">=</span> <span class="n">property_collector</span><span class="o">.</span><span class="n">WaitForUpdates</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filter_set</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">filterSet</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">obj_set</span> <span class="ow">in</span> <span class="n">filter_set</span><span class="o">.</span><span class="n">objectSet</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">obj_set</span><span class="o">.</span><span class="n">obj</span>
                        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">obj_set</span><span class="o">.</span><span class="n">changeSet</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">change</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;info&#39;</span><span class="p">:</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">state</span>
                            <span class="k">elif</span> <span class="n">change</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;info.state&#39;</span><span class="p">:</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">val</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="ow">in</span> <span class="n">task_list</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">TaskInfo</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                                <span class="n">task_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">TaskInfo</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">error</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">version</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pc_filter</span><span class="p">:</span>
                <span class="n">pc_filter</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span></div>

<div class="viewcode-block" id="VmwareHelper.data_store_for_attach_disk_restore"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.data_store_for_attach_disk_restore">[docs]</a>    <span class="k">def</span> <span class="nf">data_store_for_attach_disk_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the datastore to be used for attach disk restore</span>
<span class="sd">        Args:</span>
<span class="sd">            host                (string):   ESX where datastore has to be searched</span>

<span class="sd">        Returns:</span>
<span class="sd">            datastore_name      (string):   Datastore name where restore will happen</span>

<span class="sd">        Raises:</span>
<span class="sd">               Exception:</span>
<span class="sd">                   Raise exception when failed to get the DS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_tree_list</span><span class="p">(</span><span class="n">datastore_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disk is restoring to datastore: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datastore_name</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">datastore_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;No Datastore found&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in finding DS: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VmwareHelper.power_off_all_vms"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.power_off_all_vms">[docs]</a>    <span class="k">def</span> <span class="nf">power_off_all_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Power off all VMs in VMs dictionary</span>

<span class="sd">        Raise:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise Exception when fails to power off</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">power_off</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exception raised in powering off VMs: </span><span class="si">{exp}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exp</span></div>

<div class="viewcode-block" id="VmwareHelper.power_on_all_vms"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.power_on_all_vms">[docs]</a>    <span class="k">def</span> <span class="nf">power_on_all_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Power on all VMs in VMs dictionary</span>

<span class="sd">        Raise:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise Exception when fails to power on</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">power_on</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exception raised in powering off VMs: </span><span class="si">{exp}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exp</span></div>

<div class="viewcode-block" id="VmwareHelper.check_vms_exist"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.check_vms_exist">[docs]</a>    <span class="k">def</span> <span class="nf">check_vms_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Check each VM in vm_list exists in Hypervisor VMs Dict</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list (list): List of VMs to check</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): If All VMs are present</span>

<span class="sd">            False (bool): If any VM is absent</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">present_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
        <span class="n">present_vms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">present_vms</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">present_vms</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">vm_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="VmwareHelper.check_vms_absence"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.check_vms_absence">[docs]</a>    <span class="k">def</span> <span class="nf">check_vms_absence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Check VMs in vm_list should not be present in Hypervisor VMs Dict</span>

<span class="sd">        Args:</span>

<span class="sd">            vm_list (list): If all VMs are not present</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): If All VMs are absent</span>

<span class="sd">            False (bool): If any VM is present</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">present_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
        <span class="n">present_vms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">present_vms</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">present_vms</span><span class="p">))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="VmwareHelper.check_ds_exist"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.check_ds_exist">[docs]</a>    <span class="k">def</span> <span class="nf">check_ds_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Check datastrores if present in the vcenter</span>

<span class="sd">        Args:</span>

<span class="sd">            ds_list                 (list): List of datastores to be checked in the vcenter</span>

<span class="sd">        Returns:</span>
<span class="sd">            True (bool): If any of the DS is present in the vcenter</span>

<span class="sd">            False (bool): If all DS are not present</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vim</span><span class="o">.</span><span class="n">Datastore</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ds_list</span><span class="p">,</span> <span class="n">all_ds</span><span class="o">.</span><span class="n">items</span><span class="p">())):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An error occurred in checking DS list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AzureHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper">[docs]</a><span class="k">class</span> <span class="nc">AzureHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for performing all operations on AzureRM Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize AzureRM Helper class properties</span>


<span class="sd">            Args:</span>
<span class="sd">                server_host_name    (str):      server list at instance level</span>

<span class="sd">                host_machine        (str):      Co-ordinator at instance level</span>

<span class="sd">                user_name           (str):      App_ID of AzureRM subscription</span>

<span class="sd">                password            (tupple):   consist of password, subscriptionID,</span>
<span class="sd">                                                tenantID</span>

<span class="sd">                instance_type       (str):      Instance type of the AzureRM</span>

<span class="sd">                commcell            (object):   Commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AzureHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                          <span class="n">user_name</span><span class="p">,</span>
                                          <span class="n">password</span><span class="p">,</span>
                                          <span class="n">instance_type</span><span class="p">,</span>
                                          <span class="n">commcell</span><span class="p">,</span>
                                          <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vhd&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">=</span> <span class="s1">&#39;https://login.microsoftonline.com/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.core.windows.net/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.azure.com&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">=</span> <span class="s2">&quot;api-version=&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_id</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="s1">&#39;azure resource manager&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide the default headers required</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide info about all VM&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span>

    <span class="nd">@all_vmdata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the VM related info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_rgdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        collects all resource group data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span>

    <span class="nd">@all_rgdata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all_rgdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the resource group data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="AzureHelper.get_storage_access_token"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_storage_access_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Storage access token</span>


<span class="sd">        Returns: (str) storage access token</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">adal</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">AuthenticationContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
                <span class="n">token_response</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">acquire_token_with_client_credentials</span><span class="p">(</span><span class="s1">&#39;https://storage.azure.com/&#39;</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storage_access_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accessToken&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">strtok_expire_time</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expiresOn&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_access_token</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the storage Access token&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureHelper.check_for_storage_access_token_expiration"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.check_for_storage_access_token_expiration">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_storage_access_token_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if the storage access is expired and return a valid storage access token</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expiry_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strtok_expire_time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="n">curr_loc_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
            <span class="n">curr_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">curr_loc_time</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expiry_time</span> <span class="o">&gt;</span> <span class="n">curr_time</span> <span class="ow">and</span> <span class="p">(</span><span class="n">expiry_time</span> <span class="o">-</span> <span class="n">curr_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_access_token</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_storage_access_token</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Error while checking storage access token validity&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureHelper.get_access_token"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_access_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get access token for any first authorization</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                Failed to get access token while logging into Azure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging into Azure to get access token&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.config.Virtualization.azure.creds&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app_id</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="kn">import</span> <span class="nn">adal</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">AuthenticationContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
            <span class="n">token_response</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">acquire_token_with_client_credentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accessToken&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access Token is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.check_for_access_token_expiration"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.check_for_access_token_expiration">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_access_token_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function check if access_token is expired if yes it will generate one</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                Failed to get access token</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">((</span><span class="ow">not</span> <span class="n">is_sessionok</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)):</span>
                <span class="n">azure_list_subscriptions_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions?&quot;</span> \
                                               <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-05-10&quot;</span>
                <span class="n">subscriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_list_subscriptions_url</span><span class="p">,</span>
                                                       <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">subscriptions</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ExpiredAuthenticationToken&quot;</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The session is not expired , so there are credential issue&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">subscriptions</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There was error even after getting new token&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the VM data Information</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to fetch information from cloud portal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in updating Host&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.collect_all_vm_data"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.collect_all_vm_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_all_vm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect all VM Data from each resource group</span>

<span class="sd">         Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get VM information present in Resource group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_allrg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_resource_group</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">==</span> <span class="s1">&#39;azure resource manager&#39;</span><span class="p">:</span>
                <span class="n">api_date</span> <span class="o">=</span> <span class="s2">&quot;2016-04-30-preview&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">api_date</span> <span class="o">=</span> <span class="s2">&quot;2015-06-15&quot;</span>
            <span class="k">for</span> <span class="n">each_rg</span> <span class="ow">in</span> <span class="n">_allrg</span><span class="p">:</span>
                <span class="n">azure_list_vm_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> \
                                    <span class="o">+</span> <span class="n">each_rg</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Compute/virtualMachines?&quot;</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="n">api_date</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_list_vm_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">_all_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">each_rg</span><span class="p">,</span> <span class="n">_all_data</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in collect_all_vmdata&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.collect_all_resource_group_data"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.collect_all_resource_group_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_all_resource_group_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect All Resource group data</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get information about resource group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">==</span> <span class="s1">&#39;azure resource manager&#39;</span><span class="p">:</span>
                <span class="n">api_date</span> <span class="o">=</span> <span class="s2">&quot;2014-04-01&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">api_date</span> <span class="o">=</span> <span class="s2">&quot;2018-02-01&quot;</span>

            <span class="n">azure_resource_group_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> \
                                       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups?&quot;</span> \
                                       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="n">api_date</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_resource_group_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in CollectAllResourceGroupData&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_all_resource_group"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_all_resource_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_resource_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare list of resource groups and their corressponding resources</span>

<span class="sd">        Returns:</span>
<span class="sd">            resource_group     (str):  list of all resource groups</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to sagregate resources groups and its data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_allrg_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_token_expiry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Token Is expired, Renewing it&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span>
            <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">datadict</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                <span class="n">rg_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">_allrg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_allrg_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in collect_all_resource_group_data&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function fetches information about all VMs in particular resource group</span>

<span class="sd">        Returns:</span>
<span class="sd">            _all_vmlist     (list):  list of all VM&#39;s</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get VM information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_all_vmlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
            <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">eachvalue</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">eachvalue</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                        <span class="n">vm_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">_all_vmlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_all_vmlist</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_resourcegroup_name"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_resourcegroup_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_resourcegroup_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get resource group of particular VM</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name                 (str):  vm whose information needs to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">            resource_group_name     (str):  Resource group where VM is found</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to find particular resource group for VM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">resource_group_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_token_expiry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span><span class="p">[</span><span class="s1">&#39;SPR-EAST&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
            <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">each_value</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">each_value</span><span class="p">:</span>
                    <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">each_value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                            <span class="n">_vm_name</span> <span class="o">=</span> <span class="n">each_key</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_vm_name</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">:</span>
                                <span class="n">vm_id</span> <span class="o">=</span> <span class="n">each_key</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                                <span class="n">temp_str</span> <span class="o">=</span> <span class="n">vm_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">resource_group_name</span> <span class="o">=</span> <span class="n">temp_str</span><span class="p">[</span><span class="n">temp_str</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;resourceGroups&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                                <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot collect information for this VM&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resource_group_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Resource group&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_resourcegroup_for_region"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_resourcegroup_for_region">[docs]</a>    <span class="k">def</span> <span class="nf">get_resourcegroup_for_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all resource groups of particular Region</span>

<span class="sd">        Args:</span>
<span class="sd">            region             (str):  region whose resource groups needs to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">            resource_group     (str):  list of all resource groups</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to find resource groups of particular region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_group</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_token_expiry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>
            <span class="n">rg_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span>
            <span class="k">for</span> <span class="n">eachrg</span> <span class="ow">in</span> <span class="n">rg_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                <span class="n">rg_region</span> <span class="o">=</span> <span class="n">eachrg</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rg_region</span> <span class="o">==</span> <span class="n">region</span><span class="p">:</span>
                    <span class="n">resource_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eachrg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">resource_group</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_resourcegroup_for_region&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">resource_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Compute the free Resource of the subscription based on region</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name             (str):  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            resource_group	    (str):  The resource group where restore can be performed</span>

<span class="sd">            storage_account     (str):  Storage account where restore has to be performed</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get resource group or storage account or all</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sa_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">resource_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
                <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">eachvalue</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">eachvalue</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                            <span class="n">_vm_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">_vm_name</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">region</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                                <span class="k">break</span>

                <span class="n">resource_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resourcegroup_for_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_rg</span> <span class="ow">in</span> <span class="n">resource_group</span><span class="p">:</span>
                <span class="n">storage_account_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                                      <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> <span class="o">+</span> \
                                      <span class="n">each_rg</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Storage/storageAccounts?&quot;</span> \
                                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-06-01&quot;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">storage_account_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">sa_value</span> <span class="o">=</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sa_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">each_sa</span> <span class="ow">in</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                            <span class="n">sa_name</span> <span class="o">=</span> <span class="n">each_sa</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="n">resource_group</span> <span class="o">=</span> <span class="n">each_rg</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">each_rg</span><span class="p">)</span>
            <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_storage_account_location</span><span class="p">(</span><span class="n">resource_group</span><span class="p">,</span> <span class="n">sa_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resource_group</span><span class="p">,</span> <span class="n">sa_name</span><span class="p">,</span> <span class="n">location</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in ComputeFreeResources&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_storage_account_location"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_storage_account_location">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage_account_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_group</span><span class="p">,</span> <span class="n">sa_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the location of the storage account</span>

<span class="sd">        Args:</span>
<span class="sd">            resource_group      (str):  Resource group os storage account</span>

<span class="sd">            sa_name             (str):  Storage Account name for which location has to be identified</span>

<span class="sd">        Returns:</span>
<span class="sd">            location            (str):  Returns the location of the storage account</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get location of storage account</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">storage_account_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                              <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> <span class="o">+</span> \
                              <span class="n">resource_group</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Storage/storageAccounts/&quot;</span> <span class="o">+</span> <span class="n">sa_name</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> \
                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-06-01&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">storage_account_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">location</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get location details for this Storage Account&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureHelper.check_for_token_expiry"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.check_for_token_expiry">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_token_expiry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks for the token expiry</span>

<span class="sd">        Args:</span>
<span class="sd">        data (basestring)  : Response  from api</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;noerror&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ExpiredAuthenticationToken&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AzureHelper.get_storage_account"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_storage_account">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the storage account name</span>

<span class="sd">        Args:</span>
<span class="sd">            resource_group (basestring) :  Resource group for which storage accound has to be looked for</span>

<span class="sd">        Returns:</span>
<span class="sd">            Storage Account for resource group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sa_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">storage_account_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                              <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> <span class="o">+</span> \
                              <span class="n">resource_group</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Storage/storageAccounts?&quot;</span> \
                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-06-01&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">storage_account_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">sa_value</span> <span class="o">=</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sa_value</span></div></div>


<div class="viewcode-block" id="FusionComputeHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper">[docs]</a><span class="k">class</span> <span class="nc">FusionComputeHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Fusion Compute Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FusionComputeHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                                  <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="n">FusionComputeServices</span><span class="o">.</span><span class="n">get_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json;charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en_US&#39;</span><span class="p">,</span>
            <span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span> <span class="o">=</span> <span class="n">FusionComputeServices</span><span class="o">.</span><span class="n">get_vm_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_get_site_url</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

<div class="viewcode-block" id="FusionComputeHelper.get_version"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.get_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Fusion Compute Hypervisor Version Provided</span>
<span class="sd">        :return:</span>
<span class="sd">            version    (str)    : version of the Fusion COmpute Hypervisor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_VERSION&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">latest_version</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json;version=</span><span class="si">{0}</span><span class="s1">;charset=UTF-8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">latest_version</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">latest_version</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>

            <span class="k">raise</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred &quot;</span> \
                               <span class="s2">&quot;getting version from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compute_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does login to the Fusion compute Hypervisor</span>
<span class="sd">        :return:</span>
<span class="sd">            set the token in headers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-AuthType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-UserType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;x-auth-token&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-User&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-Key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-AuthType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-UserType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the VRM&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (str)         --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (str)         --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / str)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) - in case of success</span>

<span class="sd">                (False, response) - in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            Fusion Compute SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                         <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                        <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Raise max attempts exception, if attempts exceeds 3</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_site_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the site urn for the Fusion VRM</span>
<span class="sd">        :return:</span>
<span class="sd">            site_url (str)  - site url for querying about VMs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_SITES&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">site_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;sites&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">site_url</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting version from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="FusionComputeHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the Information of Host</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>

                <span class="k">return</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="FusionComputeHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Get all the vms for Fusion Compute</span>

<span class="sd">       Args:</span>
<span class="sd">            server (str)   -  VRM  for which all the VMs has to be fetched</span>

<span class="sd">            pattern (str)  - Pattern to fetch the vms</span>

<span class="sd">            c_type            (str):  Type of content</span>

<span class="sd">       Returns:</span>
<span class="sd">           _all_vm_list    (str)   -   List of VMs in the host of the pseudoclient</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">while</span> <span class="n">stop</span><span class="p">:</span>
                <span class="n">_vm_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_vm_service</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_list_response</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">100</span>
                        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
                            <span class="n">_temp_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_vm_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name (str)   - name of the VM for which we want to find host</span>
<span class="sd">        return:</span>
<span class="sd">            Host of teh VM where it resides</span>
<span class="sd">            None: if it is not in Fusion Compute</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
        <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
        <span class="n">_host_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_list</span><span class="p">:</span>
                <span class="n">_vm_host_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS_HOSTS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_host_dict</span><span class="p">[</span><span class="n">each_host</span><span class="p">][</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_vm_host_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">vm_host_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">vm_host</span> <span class="ow">in</span> <span class="n">vm_host_list_response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">vm_host</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="n">each_host</span>
                            <span class="k">break</span>

        <span class="k">return</span> <span class="n">host</span>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of datastore in an Host in VRM</span>

<span class="sd">        Args:</span>
<span class="sd">            host_name   (str)   - Name of the host for which datastore has to be fecthed</span>

<span class="sd">        Return:</span>
<span class="sd">                _disk_size_dict	(dict)	- Datastores with name name free spaces</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">host_name</span><span class="p">:</span>
                <span class="n">_host_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">host_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_host_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_list</span><span class="p">:</span>
                <span class="n">_datastore_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_DATASTORES_HOSTS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_host_dict</span><span class="p">[</span><span class="n">each_host</span><span class="p">][</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_datastore_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">disk_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;datastores&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">disk_list_response</span><span class="p">:</span>
                        <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">disk</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">disk</span><span class="p">[</span><span class="s1">&#39;actualFreeSizeGB&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">_disk_size_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastores  from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_host_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of hosts  in VRM</span>

<span class="sd">        Args:</span>

<span class="sd">        Return:</span>
<span class="sd">                _host_dict	(dict)	- host with name and freememory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_HOSTS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">_host_dict_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;hosts&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">_host_dict_response</span><span class="p">:</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;memQuantityMB&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1024</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;urn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;urn&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">_host_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting hosts  from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_datastore_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted datastore Dict according to free space</span>
<span class="sd">        Args:</span>
<span class="sd">            host_name   (str)   - Host Name for which datastore has to be fetched</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_datastore_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to free space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                                 <span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                  <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastore priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_host_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted host Dict according to Memory</span>
<span class="sd">        Args:</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_host_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to Memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                  <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_host_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

            <span class="n">_sorted_host_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                            <span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                             <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_host_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting host priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the required resource for restore</span>
<span class="sd">        :param vm_list:  list of Vms for restore</span>
<span class="sd">        :return:</span>
<span class="sd">            _vm_total_memory    (int)   -   Total memory required for restoring</span>
<span class="sd">            _vm_total_space (int)   -   Total disk space required for restoring</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;vm_space&#39;</span><span class="p">)</span>
                <span class="n">_vm_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">vm_space</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_space</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="FusionComputeHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">,</span> <span class="n">proxy_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>

<span class="sd">                vm_list		(list) - list of Vms to be restored</span>

<span class="sd">        return:</span>
<span class="sd">                Datastore	(str)	- the Datastore where restore can be performed</span>

<span class="sd">                Host            (str)	- Host where restore has to be performed</span>

<span class="sd">                proxy_client    (str)   - Proxy machine used for restore</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datastore_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="n">proxy_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_host</span><span class="p">(</span><span class="n">proxy_client</span><span class="p">)</span>

            <span class="n">_host_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_priority_list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_host</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;the Host </span><span class="si">%s</span><span class="s2"> has higher &quot;</span>
                        <span class="s2">&quot;memory than the total VMs&quot;</span> <span class="o">%</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">proxy_host</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We cannot have same as destination client host as there is known limitation &quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">host_name</span> <span class="o">=</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_priority_list</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span>
                                  <span class="s2">&quot;The Datastore </span><span class="si">%s</span><span class="s2"> has more than total&quot;</span>
                                  <span class="s2">&quot;disk space in VM&quot;</span> <span class="o">%</span> <span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">datastore_name</span><span class="p">,</span> <span class="n">host_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  compute_free_resources &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="OracleVMHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper">[docs]</a><span class="k">class</span> <span class="nc">OracleVMHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on OracleVM Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OracleVMHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                             <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_host_name</span> <span class="o">+</span> <span class="s1">&#39;:7002/ovm/core/wsapi/rest&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (str)         --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (str)         --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / str)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) - in case of success</span>

<span class="sd">                (False, response) - in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            OracleVM SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_REST_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REST_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot; clear the expired cookies so that requests module will use the username and password for next </span>
<span class="sd">                request and update the session with new cookies&quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">attempts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the required resource for restore</span>
<span class="sd">        Args:</span>
<span class="sd">            vm_list: list of Vms for restore</span>

<span class="sd">        Returns:</span>
<span class="sd">            _vm_total_memory    (int)   -   Total memory required for restoring</span>
<span class="sd">            _vm_total_space (int)   -   Total disk space required for restoring</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;vm_space&#39;</span><span class="p">)</span>
                <span class="n">_vm_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">vm_space</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_space</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_verify_manager_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager_json</span><span class="p">,</span> <span class="n">retryCount</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safety check to verify if the Oracle VM manager is in running state.</span>
<span class="sd">        Args:</span>
<span class="sd">            manager_json: Response of the vm manager</span>
<span class="sd">            retryCount: number of times the verification should happen if</span>
<span class="sd">                        the vm manager is in starting state</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM Manager is running. Session successfully created&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARTING&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM Manager is in &quot;</span> <span class="o">+</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; state re-checking after one minute&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retryCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">new_manager_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s2">&quot;/Manager&quot;</span><span class="p">)</span>
                <span class="n">retryCount</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_manager_state</span><span class="p">(</span><span class="n">new_manager_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">retryCount</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Retry limit reached. VM Manager status is &quot;</span> <span class="o">+</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> invalid running state of VM manager&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceNew</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">forceNew</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s2">&quot;/Manager&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Oracle VM manager is not responding&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_manager_state</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="OracleVMHelper.get_cluster_repositories"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_cluster_repositories">[docs]</a>    <span class="k">def</span> <span class="nf">get_cluster_repositories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Total available repositories available under the cluster</span>
<span class="sd">        :return: list of the repositories for the cluster</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/Repository&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while retriving server list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_server_repositories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Available repos that are under a server</span>
<span class="sd">        Args:</span>
<span class="sd">            server: Server for which the repos needs to be listed</span>

<span class="sd">        Returns: list of repository dicts for a server</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_server_repositories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">available_repos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_repositories</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_repo</span> <span class="ow">in</span> <span class="n">available_repos</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_repo</span><span class="p">[</span><span class="s2">&quot;presentedServerIds&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_presentedServer</span> <span class="ow">in</span> <span class="n">_repo</span><span class="p">[</span><span class="s2">&quot;presentedServerIds&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">_presentedServer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                            <span class="n">_server_repositories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_server_repositories</span> <span class="o">=</span> <span class="n">available_repos</span>
        <span class="k">return</span> <span class="n">_server_repositories</span>

<div class="viewcode-block" id="OracleVMHelper.get_servers"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_servers">[docs]</a>    <span class="k">def</span> <span class="nf">get_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a required server or total servers available</span>
<span class="sd">        Args:</span>
<span class="sd">            server: name of the server when passed returns only it&#39;s dict</span>

<span class="sd">        Returns: (list)        dict of server(s)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/Server&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">server</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_server</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">_server</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                            <span class="n">server_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_server</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">server_list</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">server_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while retriving server list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the vm&#39;s that are available under a requested server</span>
<span class="sd">        Args:</span>
<span class="sd">            server: (basestring)    server on which the VMs should be listed</span>

<span class="sd">            pattern: (basestring)   Pattern to fetch the vms</span>

<span class="sd">            c_type            (str):  Type of content</span>

<span class="sd">        Returns:    (list)          list of the vms on a given server</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_vm_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_available_servers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_servers</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">_available_servers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_available_servers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">server_dict</span> <span class="ow">in</span> <span class="n">_available_servers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">_vm_name</span> <span class="ow">in</span> <span class="n">server_dict</span><span class="p">[</span><span class="s2">&quot;vmIds&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span>
                    <span class="n">_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting vm&#39;s in hypervisor&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating hosts of OracleVM hypervisor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_fileSystem_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileSystemId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the response of the given fileSystemId</span>
<span class="sd">        Args:</span>
<span class="sd">            fileSystemId: (basestring)      UniqueID of the file system</span>

<span class="sd">        Returns:    Response JSON of the file system requested</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_file_system_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/FileSystem/&#39;</span> <span class="o">+</span> <span class="n">fileSystemId</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">_file_system_details</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_file_system_details</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while obtaining file system details&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the dict of the datastores available on a given datastore</span>
<span class="sd">        Args:</span>
<span class="sd">            server: (basestring)      Server for which the datastores are needed</span>

<span class="sd">        Returns:    Response JSON of the datastores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_server_repos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_server_repositories</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_server_repo</span> <span class="ow">in</span> <span class="n">_server_repos</span><span class="p">:</span>
                <span class="n">_file_system_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fileSystem_details</span><span class="p">(</span><span class="n">fileSystemId</span><span class="o">=</span><span class="n">_server_repo</span><span class="p">[</span><span class="s2">&quot;fileSystemId&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="n">_datastore_dict</span><span class="p">[</span><span class="n">_server_repo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">bytesto</span><span class="p">(</span><span class="n">_file_system_info</span><span class="p">[</span><span class="s2">&quot;freeSize&quot;</span><span class="p">],</span> <span class="s2">&quot;GB&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_datastore_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastores information&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_repository_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted datastore Dict according to free space</span>
<span class="sd">        Args:</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_datastore_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to free space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                                 <span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                  <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastore priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="OracleVMHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_list  - list of servers from which best has to be chosen</span>

<span class="sd">            vm_list     - list of Vm to be restored</span>

<span class="sd">        Return:</span>
<span class="sd">                host         (str)    - hypervisor host where vm is to be restored</span>
<span class="sd">                                            like esx, resourcegroup,region,hyperv host</span>

<span class="sd">                datastore    (str)    - diskspace where vm needs to be restored</span>
<span class="sd">                                            like destinationpath,datastore,bucket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
            <span class="n">_repository_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repository_priority_list</span><span class="p">()</span>
            <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_repo</span> <span class="ow">in</span> <span class="n">_repository_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">repository</span> <span class="o">=</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">return</span> <span class="n">host_name</span><span class="p">,</span> <span class="n">repository</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.close_session"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.close_session">[docs]</a>    <span class="k">def</span> <span class="nf">close_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the VM Manager session</span>
<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;session closed&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OracleCloudHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper">[docs]</a><span class="k">class</span> <span class="nc">OracleCloudHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Oracle Cloud Classic Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Oracle Cloud Hypervisor Helper Options</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (basestring)    --  the hostname of the oracle cloud server</span>

<span class="sd">            host_machine        (basestring)    --  the hostname of the client where the scripts</span>
<span class="sd">                                                    will be executed</span>

<span class="sd">            user_name           (basestring)    --  the user name of the client</span>

<span class="sd">            password            (basestring)    --  the password of the client</span>

<span class="sd">            instance_type       (basestring)    --  the type of instance</span>

<span class="sd">            commcell            (object)        --  the commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OracleCloudHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                                <span class="n">user_name</span><span class="p">,</span>
                                                <span class="n">password</span><span class="p">,</span>
                                                <span class="n">instance_type</span><span class="p">,</span>
                                                <span class="n">commcell</span><span class="p">,</span>
                                                <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;Compute&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="s2">&quot;Compute-</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="n">OracleCloudServices</span><span class="o">.</span><span class="n">get_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/oracle-compute-v3+json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/oracle-compute-v3+json&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span> <span class="o">=</span> <span class="n">OracleCloudServices</span><span class="o">.</span><span class="n">get_vm_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does login to the Oracle Cloud Hypervisor</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if login to the Oracle Cloud end point fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">}</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">],</span> <span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the end point&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (basestring)  --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (basestring)  --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / basestring)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) -- in case of success</span>

<span class="sd">                (False, response) -- in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            Oracle Cloud SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

            <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/oracle-compute-v3+directory+json&#39;</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Raise max attempts exception, if attempts exceeds 3</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

<div class="viewcode-block" id="OracleCloudHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the vms for Oracle Cloud</span>

<span class="sd">        Args:</span>
<span class="sd">            server (basestring)   --  User for which all the VMs has to be fetched</span>

<span class="sd">            pattern (basestring)   -- Pattern to fetch the vms</span>

<span class="sd">            c_type            (str):  Type of content</span>

<span class="sd">        Returns:</span>
<span class="sd">           _all_vm_list    (list)   --   List of VMs in the host of the pseudoclient</span>

<span class="sd">        Raises:</span>
<span class="sd">              Exception:</span>
<span class="sd">                    if there is an exception in getting all the VMs in the user</span>

<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Cookie&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_INSTANCES&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span> <span class="o">=</span> <span class="n">vm_list_response</span>
                <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">_temp_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from Oracle Cloud&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_user_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of users in the Identity Domain of Oracle Cloud</span>

<span class="sd">        Returns:</span>
<span class="sd">            _compute_users_list	(list)	-- List of all users in the identity domain</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the list of all users in the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_compute_users_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_INSTANCES&#39;</span><span class="p">],</span>
                                                <span class="n">directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">user_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_list_response</span><span class="p">:</span>
                    <span class="n">_compute_users_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_compute_users_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting users from the &quot;</span>
                               <span class="s2">&quot;identity domain&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_security_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the list of all security lists of Oracle Cloud</span>

<span class="sd">        Returns:</span>
<span class="sd">             _security_list  (list)  --  list of all security lists in Oracle Cloud</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an exception is getting all the security lists in the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_security_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_SECLIST&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">security_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">security_list_response</span><span class="p">:</span>
                    <span class="n">_security_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_security_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred getting security lists. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_instance_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the user name of the instance in Oracle Cloud</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --   name of the instance whose username has</span>
<span class="sd">                                                to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">                instance_user_name	(basestring)    -- username to which the instance belongs</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the user name of an instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance_user_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
                    <span class="n">instance_user_name</span> <span class="o">=</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">instance_user_name</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting the user name of the instance&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_security_list_of_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the security list associated with the instance</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --   name of the instance whose security list</span>
<span class="sd">                                                    has to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">            security_lists  (list)  --  list of all security lists associated with the instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the security lists associated with the instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">security_lists</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;networking&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">security_lists</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;seclists&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">security_lists</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting the security list of the&quot;</span>
                               <span class="s2">&quot;instance. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ssh_keys_of_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ssh keys associated with the instance</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --  name of the instance whose ssh keys has</span>
<span class="sd">                                                to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">            ssh_keys  (list)  --  list of all ssh keys associated with the instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the list of all ssh keys associated with instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh_keys</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span> <span class="ow">and</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;sshkeys&#39;</span><span class="p">]:</span>
                    <span class="n">ssh_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;sshkeys&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">ssh_keys</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting the ssh keys of the&quot;</span>
                               <span class="s2">&quot;instance. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

<div class="viewcode-block" id="OracleCloudHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>

<span class="sd">                proxy_list  (list)  --  list of all proxies</span>

<span class="sd">                vm_list		(list)  --  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">                security_list   (list)  --   the security lists to be attached to the instances</span>

<span class="sd">                host_name       (basestring)   --   the host where instances are to be restored</span>

<span class="sd">                ssh_keys        (basestring)  --   The ssh keys to be attached to the instances</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in computing the resources of the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">security_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ssh_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">proxy_list</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="n">security_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_security_list_of_instance</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
                <span class="n">ssh_keys</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_keys_of_instance</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">security_list</span><span class="p">,</span> <span class="n">host_name</span><span class="p">,</span> <span class="n">ssh_keys</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources&quot;</span>
                               <span class="s2">&quot; for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GoogleCloudHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper">[docs]</a><span class="k">class</span> <span class="nc">GoogleCloudHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Google Hyperviosr</span>

<span class="sd">    Methods:</span>
<span class="sd">            get_all_vms_in_hypervisor     - gets a list of all the vms in the hypervisor</span>

<span class="sd">            compute_free_resources        - returns the closest bucket to the proxy for restore</span>

<span class="sd">            _get_all_buckets              - finds alll the buckets associated with the hypervisor</span>

<span class="sd">            get_proxy_zone                - returns the zone of a proxy</span>

<span class="sd">            _find_proxy                   - finds the region and zone of a proxy</span>

<span class="sd">            _make_request                 - makes http rest api requests to google servers</span>

<span class="sd">            _get_access_token             - retrieves an authetnication access token</span>

<span class="sd">            refresh_token                 - refreshes access token</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GoogleCloudHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                                <span class="n">user_name</span><span class="p">,</span>
                                                <span class="n">password</span><span class="p">,</span>
                                                <span class="n">instance_type</span><span class="p">,</span>
                                                <span class="n">commcell</span><span class="p">,</span>
                                                <span class="n">host_machine</span><span class="p">)</span>

        <span class="c1"># TODO: figure out way to integrate service account JSON/p12 from user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_account</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.config.Virtualization.gcp.service_account&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_account</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">credentials_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_access_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">google_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/compute/v1/projects/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_storage_uri</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/storage/v1/b&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">google_projects_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloudresourcemanager.googleapis.com/v1/projects&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_details</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_all_vms</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_id&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Projects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns list of all projects.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_list</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">google_projects_url</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;projects&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;projectId&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in _fetch_all_projects: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns List of VMs. It is read onlyt attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span>

    <span class="nd">@VMs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;creates VMObject for list of VM passed</span>
<span class="sd">        Args:</span>
<span class="sd">            vmList    (list) - list of VMs for creating VM object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">each_vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_name_by_id</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_list</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_name_by_id</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">vm_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VMs are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in creating object </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves access token for authorization</span>

<span class="sd">        Returns:</span>
<span class="sd">            access_token    (str)       -   token that authorizes requests to Google server</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">base64</span> <span class="k">import</span> <span class="n">urlsafe_b64encode</span>
        <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends.openssl.backend</span> <span class="k">import</span> <span class="n">backend</span>
        <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="k">import</span> <span class="n">hashes</span>
        <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="k">import</span> <span class="n">padding</span>

        <span class="n">now_in_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">expiry_in_seconds</span> <span class="o">=</span> <span class="n">now_in_seconds</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3540</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;typ&#39;</span><span class="p">:</span> <span class="s1">&#39;JWT&#39;</span><span class="p">,</span> <span class="s1">&#39;alg&#39;</span><span class="p">:</span> <span class="s1">&#39;RS256&#39;</span><span class="p">}</span>

        <span class="n">claim_set</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials_dict</span><span class="p">[</span><span class="s1">&#39;client_email&#39;</span><span class="p">],</span>
            <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/&quot;</span>
                     <span class="s2">&quot;auth/compute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.googleapis.com/oauth2/v4/token&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expiry_in_seconds</span><span class="p">,</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now_in_seconds</span>
        <span class="p">}</span>

        <span class="n">json_claim_set</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">claim_set</span><span class="p">,</span>
            <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">json_header</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">header</span><span class="p">,</span>
            <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">json_header</span><span class="p">),</span> <span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">json_claim_set</span><span class="p">)]</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials_dict</span><span class="p">[</span><span class="s1">&#39;private_key&#39;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">private_key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">signing_input</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">signing_input</span><span class="p">,</span> <span class="n">padding</span><span class="o">.</span><span class="n">PKCS1v15</span><span class="p">(),</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
        <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">signature</span><span class="p">))</span>
        <span class="n">JWT</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">grant_type</span> <span class="o">=</span> <span class="s1">&#39;urn:ietf:params:oauth:grant-type:jwt-bearer&#39;</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://www.googleapis.com/oauth2/v4/token&#39;</span><span class="p">,</span>
                                 <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="n">grant_type</span><span class="p">,</span>
                                       <span class="s1">&#39;assertion&#39;</span><span class="p">:</span> <span class="n">JWT</span><span class="p">})</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">access_token</span>

<div class="viewcode-block" id="GoogleCloudHelper.refresh_token"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.refresh_token">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates access token value in case of expiration</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_access_token</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_execute_google_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the google api url</span>
<span class="sd">        Args:</span>
<span class="sd">            api_url (basestring):   The api url to be exceuted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The response of the api call</span>

<span class="sd">        Raise:</span>
<span class="sd">            Exception:</span>
<span class="sd">                If the response status is not 200</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="n">attempts</span> <span class="o">=</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">attempts</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot establish the connection &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Api did not return the correct response : Status Code </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in executing google cloud api : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_vm_name_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the vm name corrresponding to the given id</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_id (basestring) : VM Id for which vm name has to be looked for</span>
<span class="sd">            project (bastring) : Name of the project</span>

<span class="sd">        Returns:</span>
<span class="sd">            VM name corresponding to given id</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                When VM is not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">instance_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span><span class="p">[</span><span class="n">project</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">vm_id</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vm_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instance list is : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="n">instance_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in _get_vm_name_by_id: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_vm_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the vm location corrresponding to the given vm name</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name (basestring) : Vm name for which location has to be looked for</span>

<span class="sd">        Returns:</span>
<span class="sd">            VM location corresponding to given vm name</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                When VM is not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_location</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instance_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_details</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
                    <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">vm_location</span>
            <span class="k">if</span> <span class="n">project</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">instance_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span><span class="p">[</span><span class="n">project</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
                        <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">vm_location</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">instance_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span><span class="p">[</span><span class="n">prj</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
                            <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                            <span class="n">vm_location</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">return</span> <span class="n">vm_location</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in _get_vm_location: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_all_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns vm list and vm id dictionary for all vms in all projects</span>

<span class="sd">        Raises:</span>
<span class="sd">             Exception:</span>
<span class="sd">                When Api returns error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_name_id_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
                <span class="n">vm_name_id_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">project</span><span class="p">:</span> <span class="p">[]})</span>
                <span class="n">google_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/regions/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span><span class="n">google_url</span><span class="p">)</span>
                <span class="n">region_list</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">region_list</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;zones&#39;</span><span class="p">]:</span>
                        <span class="n">zone_name</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">google_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/zones/</span><span class="si">{1}</span><span class="s2">/instances&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">project</span><span class="p">,</span> <span class="n">zone_name</span><span class="p">)</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span><span class="n">google_url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                            <span class="n">vm_data</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">vm_data</span><span class="p">:</span>
                                <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                                <span class="n">vm_name_id_dict</span><span class="p">[</span><span class="n">project</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">zone_name</span><span class="p">,</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]])</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">vm_list</span><span class="p">),</span> <span class="n">vm_name_id_dict</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred getting VMs from Google Cloud: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="GoogleCloudHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets all the vms in the hypervisor</span>

<span class="sd">        Returns:</span>
<span class="sd">            vm_list     (list)      -     A list of all the names of the vms in the hypervisor</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                If the list of vms cannot be found</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_all_vms</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="GoogleCloudHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds nearest bucket to proxy for restore</span>

<span class="sd">        Args:</span>
<span class="sd">            vm    (str)   -   google cloud  vm</span>

<span class="sd">        Returns:</span>
<span class="sd">            bucket_id   (str)   -   The name of the bucket closest to the proxy_vm</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if a bucket cannot be found for the proxy</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_location</span><span class="p">(</span><span class="n">vm</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_buckets</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vm_region</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_buckets</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vm_region</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">bucket</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_buckets</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred finding a bucket from Google Cloud: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoogleCloudHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the VM data Information</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to fetch information from cloud portal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_all_vms</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_get_all_buckets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds all the buckets associated with the hypervisor</span>

<span class="sd">        Returns:</span>
<span class="sd">            bucket_list     (list)      -      A list of all the bucket objects</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
                <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_storage_uri</span> <span class="o">+</span> <span class="s1">&#39;?project=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">bucket_list</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">bucket_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred getting buckets from Google Cloud: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="GoogleCloudHelper.get_vm_zone"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.get_vm_zone">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the zone in which a proxy is stored</span>

<span class="sd">        Args:</span>
<span class="sd">            vm    (str)   -   the proxy that is trying to be found</span>

<span class="sd">        Returns:</span>
<span class="sd">            zone        (str)   -   the name of the zone where the proxy is stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_location</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">project</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_get_all_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches all snapshot from all projects</span>

<span class="sd">        Returns:</span>
<span class="sd">            Snapshots   (list) : List containing names of all snapshots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snapshot_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{project_name}</span><span class="s1">/global/snapshots&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">:</span>
                    <span class="n">snapshot_details</span> <span class="o">=</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">snapshot_detail</span> <span class="ow">in</span> <span class="n">snapshot_details</span><span class="p">:</span>
                        <span class="n">snapshot_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot_detail</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;An exception occurred while fetching &quot;</span>
                                   <span class="n">f</span><span class="s2">&quot;snapshots of project: </span><span class="si">{project_name}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exception: </span><span class="si">{err}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">snapshot_names</span>

    <span class="k">def</span> <span class="nf">_get_disks_by_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch disks by project_name</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name    (str):  Name of project to fetch disks from</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception   :   If disks cannot be fetched</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disk_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{project_name}</span><span class="s1">/aggregated/disks&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;disks&#39;</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">region</span><span class="p">]:</span>
                        <span class="n">disks_details</span> <span class="o">=</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;disks&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">disk_detail</span> <span class="ow">in</span> <span class="n">disks_details</span><span class="p">:</span>
                            <span class="n">disk_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_detail</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">disk_names</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;An exception occurred while fetching &quot;</span>
                               <span class="n">f</span><span class="s2">&quot;disks of project: </span><span class="si">{project_name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exception: </span><span class="si">{err}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_all_disks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches all disks from all projects</span>

<span class="sd">        Returns:</span>
<span class="sd">            Disks   (list) : List containing names of all disks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disk_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
            <span class="n">disk_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_disks_by_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">disk_names</span>

<div class="viewcode-block" id="GoogleCloudHelper.check_snapshot_pruning"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.check_snapshot_pruning">[docs]</a>    <span class="k">def</span> <span class="nf">check_snapshot_pruning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if snapshot containing snapshot_prefix is pruned</span>

<span class="sd">        Args:</span>
<span class="sd">            snapshot_prefix  (str):  prefix containing job_id and type of job</span>
<span class="sd">             to check snapshots for</span>

<span class="sd">        Returns:</span>
<span class="sd">            True    (bool): Snapshot containing snapshot_prefix is pruned</span>
<span class="sd">            False   (bool): Snapshot containing snapshot_prefix is not pruned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snapshot_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_snapshots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">snapshot_name</span> <span class="ow">in</span> <span class="n">snapshot_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snapshot_prefix</span> <span class="ow">in</span> <span class="n">snapshot_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GoogleCloudHelper.check_disk_pruning"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.check_disk_pruning">[docs]</a>    <span class="k">def</span> <span class="nf">check_disk_pruning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_prefix</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if disk containing disk_prefix is pruned</span>

<span class="sd">        Args:</span>
<span class="sd">            disk_prefix  (str)/(list):  prefix containing job_id</span>
<span class="sd">             and type of job to check for</span>

<span class="sd">            project_name (str): project in which the disks are to be searched,</span>
<span class="sd">            if not set - disk is searched in all projects</span>

<span class="sd">        Returns:</span>
<span class="sd">            True    (bool): Disk containing disk_prefix is pruned</span>
<span class="sd">            False   (bool): Disk containing disk_prefix is not pruned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">disk_prefix</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">disk_prefix</span> <span class="o">=</span> <span class="p">[</span><span class="n">disk_prefix</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">project_name</span><span class="p">:</span>
            <span class="n">disk_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_disks_by_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">disk_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_disks</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">disk_name</span> <span class="ow">in</span> <span class="n">disk_names</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">disk_prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">disk_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GoogleCloudHelper.get_project_by_instance_name"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.get_project_by_instance_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_project_by_instance_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get project name of the given instance name</span>

<span class="sd">        Args:</span>
<span class="sd">            instance_name   (str):  Name of instance,</span>
<span class="sd">             for which the project name is to be found</span>

<span class="sd">        Returns:</span>
<span class="sd">            project_name    (str): Name of project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Projects</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_id_dict</span><span class="p">[</span><span class="n">project_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">instance_name</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">project_name</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GoogleCloudHelper.check_disk_pruning_by_description"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.GoogleCloudHelper.check_disk_pruning_by_description">[docs]</a>    <span class="k">def</span> <span class="nf">check_disk_pruning_by_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if any disk in the project contains job_id in its description</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name    (str):      Name of project to fetch disks from</span>
<span class="sd">            job_id          (str/int):  Job ID to check in the description</span>

<span class="sd">        Returns:</span>
<span class="sd">            True    :   If disk pruning was successful</span>
<span class="sd">            False   :   If disk pruning failed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_google_api</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_compute_uri</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{project_name}</span><span class="s1">/aggregated/disks&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;disks&#39;</span> <span class="ow">in</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">region</span><span class="p">]:</span>
                        <span class="n">disks_details</span> <span class="o">=</span> <span class="n">response_dict</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">][</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;disks&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">disk_detail</span> <span class="ow">in</span> <span class="n">disks_details</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">disk_detail</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">f</span><span class="s1">&#39;Job </span><span class="si">{job_id}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">disk_detail</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]:</span>
                                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;An exception occurred while fetching &quot;</span>
                               <span class="n">f</span><span class="s2">&quot;disk description of project: </span><span class="si">{project_name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exception: </span><span class="si">{err}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RedHatHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper">[docs]</a><span class="k">class</span> <span class="nc">RedHatHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Red Hat Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Call the test method to check the connectivity with the server. If</span>
    <span class="c1"># connectivity works this method will return &quot;True&quot;. If there is any</span>
    <span class="c1"># connectivy problem it will either return &quot;False&quot; or raise an exception</span>
    <span class="c1"># if the &quot;raise_exception&quot; parameter is &quot;True&quot;.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Red Hat Helper class properties</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (str):      Hostname of the Red Hat Server</span>

<span class="sd">            host_machine        (str):      Red Hat Server name</span>

<span class="sd">            user_name           (str):      Username of the Red Hat Server</span>

<span class="sd">            password            (str):      Password of the Red Hat Server</span>

<span class="sd">            instance_type       (str):      Instance type of the Red Hat Server</span>

<span class="sd">            auto_commcell       (object):   Commcell object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">RedHatHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                           <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhev_url</span> <span class="o">=</span> <span class="s1">&#39;https://</span><span class="si">{0}</span><span class="s1">/ovirt-engine/api&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhev_login</span><span class="p">()</span>

<div class="viewcode-block" id="RedHatHelper.rhev_login"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper.rhev_login">[docs]</a>    <span class="k">def</span> <span class="nf">rhev_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login and check connection with the Red Hat Server</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">ovirtsdk4</span> <span class="k">as</span> <span class="nn">sdk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
            <span class="n">ca_file</span><span class="o">=</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">get_cetificate_file</span><span class="p">(</span><span class="s1">&#39;rhev&#39;</span><span class="p">),</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rhev_url</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection works. checking VMs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Connection doesn&#39;t work.&quot;</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">system_service</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">product_info</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">full_version</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;hosts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">hosts</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sds: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">storage_domains</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;users: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vms: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">vms</span><span class="o">.</span><span class="n">total</span><span class="p">))</span></div>

<div class="viewcode-block" id="RedHatHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            server          (str):  RHEV Server for which all the VMs has to be fetched</span>

<span class="sd">            pattern         (str):  Pattern to fetch the vms</span>

<span class="sd">            c_type            (str):  Type of content</span>

<span class="sd">        Returns:</span>
<span class="sd">            vms_list        (str):  List of VMs in the host of the RHEV</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vms from RHEV Server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vms_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">system_service</span><span class="p">()</span><span class="o">.</span><span class="n">vms_service</span><span class="p">()</span>
        <span class="n">vms</span> <span class="o">=</span> <span class="n">vms_service</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">vms_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vms</span><span class="p">:</span>
            <span class="n">vms_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vms_list</span></div>

<div class="viewcode-block" id="RedHatHelper.get_storage_space"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper.get_storage_space">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the storage domains with their corresponding available space</span>

<span class="sd">        Returns:</span>
<span class="sd">            storage_dict    (dict):     a dict of storage domains and</span>
<span class="sd">                                        the amount of their free space in GB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sds_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">system_service</span><span class="p">()</span><span class="o">.</span><span class="n">storage_domains_service</span><span class="p">()</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">sds_service</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">storage_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sds</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
            <span class="n">storage_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">sds</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">bytesto</span><span class="p">(</span><span class="n">sds</span><span class="o">.</span><span class="n">available</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">storage_dict</span></div>

<div class="viewcode-block" id="RedHatHelper.get_total_disk_size"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper.get_total_disk_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_disk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the total size of all disks</span>
<span class="sd">        Args:</span>
<span class="sd">            vms          (str):  Vms&#39;s whose total disk size needs to be calculated</span>

<span class="sd">        Returns: the sum of the all the disk sizes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vms_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">system_service</span><span class="p">()</span><span class="o">.</span><span class="n">vms_service</span><span class="p">()</span>
        <span class="n">vms_list</span> <span class="o">=</span> <span class="n">vms_service</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">disk_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vms_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vms</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">vm_service</span> <span class="o">=</span> <span class="n">vms_service</span><span class="o">.</span><span class="n">vm_service</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">disk_attachments_service</span> <span class="o">=</span> <span class="n">vm_service</span><span class="o">.</span><span class="n">disk_attachments_service</span><span class="p">()</span>
            <span class="n">disk_attachments</span> <span class="o">=</span> <span class="n">disk_attachments_service</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">disk_attachment</span> <span class="ow">in</span> <span class="n">disk_attachments</span><span class="p">:</span>
                <span class="n">disk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">follow_link</span><span class="p">(</span><span class="n">disk_attachment</span><span class="o">.</span><span class="n">disk</span><span class="p">)</span>
                <span class="n">disk_size</span> <span class="o">+=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">bytesto</span><span class="p">(</span><span class="n">disk</span><span class="o">.</span><span class="n">actual_size</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">disk_size</span></div>

    <span class="k">def</span> <span class="nf">_get_repository_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted storage according to free space</span>

<span class="sd">        Returns:</span>
<span class="sd">            _sorted_storage_dict   (dict):  Returns the descending sorted</span>
<span class="sd">                                            datacenter list according to free space</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get datastore priority list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">storage_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_storage_space</span><span class="p">()</span>
            <span class="n">_sorted_storage_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                               <span class="p">(</span><span class="n">storage_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_storage_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">%s</span><span class="s2"> occurred getting datastore priority list from VRM&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="RedHatHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.RedHatHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list         (str):  Vms&#39;s whose destination need to be calculated</span>

<span class="sd">        Return:</span>
<span class="sd">            _cluster.name   (str):  hypervisor cluster where vm is to be restored</span>

<span class="sd">            repository      (str):  datastore where vm is to be restored</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to compute free resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_repository_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repository_priority_list</span><span class="p">()</span>
            <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_disk_size</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="n">sds_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">system_service</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_repo</span> <span class="ow">in</span> <span class="n">_repository_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sd</span> <span class="o">=</span> <span class="n">sds_service</span><span class="o">.</span><span class="n">storage_domains_service</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="s1">&#39;name=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_repo</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;iso&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vms_in_sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">follow_link</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">vms</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="n">vms_in_sd</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_vm</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                            <span class="n">repository</span> <span class="o">=</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">break</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="n">sds_service</span><span class="o">.</span><span class="n">storage_domains_service</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="s1">&#39;name=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">repository</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># host_name = sd.storage.address.partition(&#39;.&#39;)[0]</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">address</span>
            <span class="n">ht</span> <span class="o">=</span> <span class="n">sds_service</span><span class="o">.</span><span class="n">hosts_service</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">search</span><span class="o">=</span><span class="s1">&#39;address=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host_name</span><span class="p">))</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">follow_link</span><span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>
            <span class="n">c_list</span> <span class="o">=</span> <span class="n">sds_service</span><span class="o">.</span><span class="n">clusters_service</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_cluster</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_cluster</span><span class="o">.</span><span class="n">data_center</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">cl</span><span class="o">.</span><span class="n">data_center</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_cluster</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">repository</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No suitable clusters and datastore found&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">%s</span><span class="s2"> occurred in computing free resources for restore&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OpenStackHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OpenStackHelper">[docs]</a><span class="k">class</span> <span class="nc">OpenStackHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on OpenStack</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the OpenStack instance</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (basestring)    --  the hostname of the openstack server</span>

<span class="sd">            user_name           (basestring)    --  the user name of the openstack server</span>

<span class="sd">            password            (basestring)    --  the password of the openstack server</span>

<span class="sd">            instance_type       (basestring)    --  the type of instance</span>

<span class="sd">            commcell            (object)        --  the commcell object</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenStackHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span>
                                              <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OpenStackHandler</span> <span class="o">=</span> <span class="n">OpenStackWrapper</span><span class="o">.</span><span class="n">OpenStackVMops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

<div class="viewcode-block" id="OpenStackHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OpenStackHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the vms from Openstack server</span>

<span class="sd">        Args:</span>
<span class="sd">            server (basestring)   --  User for which all the VMs has to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">           _all_vm_list    (list)   --   List of VMs in the host of the pseudoclient</span>

<span class="sd">        Raises:</span>
<span class="sd">              Exception:</span>
<span class="sd">                    if there is an exception in getting all the VMs in the user</span>

<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpenStackHandler</span><span class="o">.</span><span class="n">get_instance_list</span><span class="p">()</span>
            <span class="n">_vmlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_vmlist</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from Oracle Cloud&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenStackHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OpenStackHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">securityGroups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">esxHost</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">            Args:</span>

<span class="sd">                    proxy_list  (list)  --  list of all proxies</span>

<span class="sd">                    vm_list		(list)  --  list of Vms to be restored</span>

<span class="sd">                    project_name (string) -- Name of the project the selected Openstack VM is in</span>

<span class="sd">                    securityGroups (string) -- The security groups present in the selected Openstack VM</span>

<span class="sd">                    esxHost (string) -- The availability_zone of the selected Openstack VM</span>

<span class="sd">            Returns:</span>
<span class="sd">                   dictionary of Datacenter -&gt; Project, cluster -&gt;zone, Datastore -&gt; volumeType, networkname -&gt; ,</span>
<span class="sd">                   esxServerName -&gt; OShostname, esxHost -&gt; zone,</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if there is an error in computing the resources of the endpoint.</span>

<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">restoreObj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Set datacenter to Project name</span>
            <span class="k">if</span> <span class="n">project_name</span><span class="p">:</span>
                <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;Datacenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;Datacenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpenStackHandler</span><span class="o">.</span><span class="n">projectName</span>
            <span class="c1"># Security groups</span>
            <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;securityGroups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">securityGroups</span>
            <span class="c1"># Availability zone to restore the VM to</span>
            <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;AZ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">volumelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;availability_zone&#39;</span><span class="p">]</span>
            <span class="c1"># Get volumetype from openstack server</span>
            <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;Datastore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpenStackHandler</span><span class="o">.</span><span class="n">get_volume_typefrom_volid</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">volumelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="c1"># esxServername is openstack server hostname</span>
            <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;esxServerName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>
            <span class="c1"># esxHost will be set to zone</span>
            <span class="k">if</span> <span class="n">esxHost</span><span class="p">:</span>
                <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;esxHost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">esxHost</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;esxHost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">volumelist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;availability_zone&#39;</span><span class="p">]</span>
            <span class="c1"># Cluster will be set to the RegionName from the openstack server</span>
            <span class="n">restoreObj</span><span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OpenStackHandler</span><span class="o">.</span><span class="n">get_region</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">restoreObj</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources&quot;</span>
                               <span class="s2">&quot; for restore&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenStackHelper.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OpenStackHelper.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name    (str)        - vm to which test data has to be copied</span>

<span class="sd">                _test_data_path(str) - path where testdata needs to be generated</span>

<span class="sd">                backup_folder(str)  - name of the folder to be backed up</span>

<span class="sd">        Exception:</span>

<span class="sd">                if fails to generate testdata</span>

<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating test data directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_test_data_path</span><span class="p">)</span>

            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># create Base dir</span>
            <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying testdata to volume </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span> <span class="n">_dest_base_path</span><span class="p">)</span>


        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AzureStackHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureStackHelper">[docs]</a><span class="k">class</span> <span class="nc">AzureStackHelper</span><span class="p">(</span><span class="n">AzureHelper</span><span class="p">,</span> <span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for performing all operations on AzureStack Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Azurestack Helper class properties</span>


<span class="sd">            Args:</span>
<span class="sd">                server_host_name    (str):      server list at instance level</span>

<span class="sd">                host_machine        (str):      Co-ordinator at instance level</span>

<span class="sd">                user_name           (str):      App_ID of Azurestack subscription</span>

<span class="sd">                password            (tupple):   consist of password, subscriptionID,</span>
<span class="sd">                                                tenantID</span>

<span class="sd">                instance_type       (str):      Instance type of the Azurestack</span>

<span class="sd">                commcell            (object):   Commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AzureStackHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                               <span class="n">user_name</span><span class="p">,</span>
                                               <span class="n">password</span><span class="p">,</span>
                                               <span class="n">instance_type</span><span class="p">,</span>
                                               <span class="n">commcell</span><span class="p">,</span>
                                               <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.local.azurestack.external&#39;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/metadata/endpoints?api-version=2015-01-01&quot;</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_adauthorityURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.adfs.azurestack.local/d53eb5b4-5817-4301-a98c-88a9a533ce52&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.adfs.azurestack.local/d53eb5b4-5817-4301-a98c-88a9a533ce52&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">=</span> <span class="s1">&#39;https://adfs.local.azurestack.external/adfs/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span> <span class="o">=</span> <span class="n">endpoints</span><span class="p">[</span><span class="s2">&quot;authentication&quot;</span><span class="p">][</span><span class="s2">&quot;audiences&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_adfs_access_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

<div class="viewcode-block" id="AzureStackHelper.get_adfs_access_token"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureStackHelper.get_adfs_access_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_adfs_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get access token for any first authorization</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                Failed to get access token while logging into Azure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging into Azure Stack ADFS to get access token&quot;</span><span class="p">)</span>

            <span class="kn">import</span> <span class="nn">adal</span>
            <span class="kn">from</span> <span class="nn">OpenSSL.crypto</span> <span class="k">import</span> <span class="n">load_certificate</span><span class="p">,</span> <span class="n">FILETYPE_PEM</span>
            <span class="kn">from</span> <span class="nn">cryptography</span> <span class="k">import</span> <span class="n">x509</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="k">import</span> <span class="n">default_backend</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">AuthenticationContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;C:\certificate.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_file</span><span class="p">:</span>
                <span class="n">pem_data</span> <span class="o">=</span> <span class="n">cert_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;C:\key1.pem&quot;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">key_file</span><span class="p">:</span>
                <span class="n">key_data</span> <span class="o">=</span> <span class="n">key_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">key_data1</span> <span class="o">=</span> <span class="n">key_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

            <span class="n">cert</span> <span class="o">=</span> <span class="n">load_certificate</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">pem_data</span><span class="p">)</span>
            <span class="n">sha1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="s2">&quot;sha1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">token_response</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">acquire_token_with_client_certificate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
                                                                           <span class="n">key_data1</span><span class="p">,</span> <span class="n">sha1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accessToken&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access Token is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureStackHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureStackHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">resource_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Compute the free Resource of the subscription based on region</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name             (list):  list of Vms to be restored</span>

<span class="sd">            resource_group      (str):  resource group if specified explicitly</span>

<span class="sd">        Returns:</span>
<span class="sd">            resource_group	    (str):  The resource group where restore can be performed</span>

<span class="sd">            storage_account     (str):  Storage account where restore has to be performed</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get resource group or storage account or all</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resourcegroup_name</span><span class="p">(</span><span class="n">vm_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">storage_account_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                                  <span class="bp">self</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> <span class="o">+</span> \
                                  <span class="n">resource_group</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Storage/storageAccounts?&quot;</span> \
                                  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2016-01-01&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of VMs usign post </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">storage_account_url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">storage_account_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">sa_value</span> <span class="o">=</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sa_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="k">for</span> <span class="n">each_sa</span> <span class="ow">in</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                        <span class="n">sa_name</span> <span class="o">=</span> <span class="n">each_sa</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">resource_group</span><span class="p">,</span> <span class="n">sa_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in ComputeFreeResources&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AmazonHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AmazonHelper">[docs]</a><span class="k">class</span> <span class="nc">AmazonHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for performing all operations on AWS</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AmazonHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                           <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using secret key and access key authentication&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aws_access_key</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aws_secret_key</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using STS Assume Role&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sts_role</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aws_access_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using IAM based authentication&quot;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.config.Virtualization.aws_login_creds.keys&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aws_access_key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aws_secret_key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aws_region</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span>   <span class="c1"># default region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aws_session</span><span class="p">()</span>

<div class="viewcode-block" id="AmazonHelper.aws_session"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AmazonHelper.aws_session">[docs]</a>    <span class="k">def</span> <span class="nf">aws_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the session with aws &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>
        <span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="k">import</span> <span class="n">ClientError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aws_access_key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">aws_access_key_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_aws_access_key</span><span class="p">,</span>
                                                <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_aws_secret_key</span><span class="p">,</span>
                                                <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_region</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sts_role</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection successful for AWS&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unexpected error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AmazonHelper.assumed_role_session"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AmazonHelper.assumed_role_session">[docs]</a>    <span class="k">def</span> <span class="nf">assumed_role_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role_arn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login via assume role</span>
<span class="sd">        Args:</span>
<span class="sd">            role_arn                    (string):  assume role</span>

<span class="sd">        Returns:</span>
<span class="sd">            aws session</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get login via assume role</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">botocore</span>
            <span class="kn">import</span> <span class="nn">boto3</span>
            <span class="kn">from</span> <span class="nn">dateutil.tz</span> <span class="k">import</span> <span class="n">tzlocal</span>
            <span class="n">base_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">_session</span>
            <span class="n">fetcher</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">AssumeRoleCredentialFetcher</span><span class="p">(</span>
                <span class="n">client_creator</span><span class="o">=</span><span class="n">base_session</span><span class="o">.</span><span class="n">create_client</span><span class="p">,</span>
                <span class="n">source_credentials</span><span class="o">=</span><span class="n">base_session</span><span class="o">.</span><span class="n">get_credentials</span><span class="p">(),</span>
                <span class="n">role_arn</span><span class="o">=</span><span class="n">role_arn</span>
            <span class="p">)</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">DeferredRefreshableCredentials</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;assume-role&#39;</span><span class="p">,</span>
                <span class="n">refresh_using</span><span class="o">=</span><span class="n">fetcher</span><span class="o">.</span><span class="n">fetch_credentials</span><span class="p">,</span>
                <span class="n">time_fetcher</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">botocore_session</span> <span class="o">=</span> <span class="n">botocore</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="n">botocore_session</span><span class="o">.</span><span class="n">_credentials</span> <span class="o">=</span> <span class="n">creds</span>
            <span class="k">return</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">botocore_session</span><span class="o">=</span><span class="n">botocore_session</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aws_region</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception during login via assume role: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AmazonHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AmazonHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the ec2 instances in aws</span>

<span class="sd">        Returns:</span>
<span class="sd">            _all_vm_list    (str):  List of instances in the the AWS</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get instances in the the AWS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
            <span class="n">_all_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">_resource</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">48</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Key&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span><span class="p">:</span>
                            <span class="n">_all_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_all_vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting all VMs from AWS&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="AmazonHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AmazonHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_vm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If proxy is not in  AWS, only then bucket is needed</span>
<span class="sd">        Finds nearest bucket to proxy for restore</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_vm    (str)   -   AWS proxy vm</span>

<span class="sd">        Returns:</span>
<span class="sd">            bucket_id   (str)   -   bucket id</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to retreive bucket for non aws proxy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: this is only for non AWS proxy</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="OciHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper">[docs]</a><span class="k">class</span> <span class="nc">OciHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">oci</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OciHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                        <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci_vm_ip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci_vm_guid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci_vm_vmsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci_vm_vcn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_details_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci</span> <span class="o">=</span> <span class="n">oci</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_user_id&#39;</span><span class="p">],</span>
            <span class="s2">&quot;key_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_private_file_name&#39;</span><span class="p">],</span>
            <span class="s2">&quot;fingerprint&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_finger_print&#39;</span><span class="p">],</span>
            <span class="s2">&quot;tenancy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_tenancy_id&#39;</span><span class="p">],</span>
            <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_region_name&#39;</span><span class="p">],</span>
            <span class="s2">&quot;pass_phrase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci_dict</span><span class="p">[</span><span class="s1">&#39;oci_private_key_password&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">config_validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">ComputeClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NetworkClient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VirtualNetworkClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_validator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">IdentityClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oci_config</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">compartment_id</span>

<div class="viewcode-block" id="OciHelper.get_vm_property"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_vm_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method can get all properties of a particular vm</span>
<span class="sd">        as of now it gets all info and then filters out needed one.</span>
<span class="sd">        needs more research to figureo ut a way to get a particular vm info without</span>
<span class="sd">        getting all vm info</span>

<span class="sd">        :param vm_name: (str)   Name of the vm</span>
<span class="sd">        :return:        (dict)  Instance properties | False if no VM by that name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">detailed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">[</span><span class="n">compartment</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">vm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Collected information for VM: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find a VM by name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OciHelper.get_all_compartments_detailed"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_all_compartments_detailed">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_compartments_detailed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to get all information on all compartments and instances on the OCI</span>

<span class="sd">        :return:    (dict)  Dict format for all compartments and instances</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">op_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">pagination</span><span class="o">.</span><span class="n">list_call_get_all_results</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">list_compartments</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">root_compartment_id</span><span class="p">,</span>
                                                                 <span class="n">compartment_id_in_subtree</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compartments</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
            <span class="n">compartment_name</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">compartment</span><span class="o">.</span><span class="n">lifecycle_state</span> <span class="o">==</span> <span class="n">compartment</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_ACTIVE</span><span class="p">:</span>

                <span class="n">compartment_id</span> <span class="o">=</span> <span class="n">compartment</span><span class="o">.</span><span class="n">id</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">pagination</span><span class="o">.</span><span class="n">list_call_get_all_results</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">list_instances</span><span class="p">,</span>
                            <span class="n">compartment_id</span><span class="o">=</span><span class="n">compartment_id</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="s2">&quot;Compute&quot;</span><span class="p">,</span>
                                                      <span class="n">compartment_id</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">out_p</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="n">op_dict</span><span class="p">[</span><span class="n">compartment_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_p</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Exception occurred while getting compartment details&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">op_dict</span></div>

<div class="viewcode-block" id="OciHelper.cleanup_response"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.cleanup_response">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span>
                         <span class="n">parent_compartment_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method used by get_all_compartments_detailed to sort through the information</span>
<span class="sd">        received from oci</span>

<span class="sd">        :return:    (list) list of dictionary of all instances under a particular compartment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_op_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">NoValueString</span> <span class="o">=</span> <span class="s2">&quot;n/a&quot;</span>  <span class="c1"># what value should be used when no data is available</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">good_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_RUNNING</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_STARTING</span><span class="p">,</span>
                           <span class="n">instance</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_STOPPED</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_STOPPING</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">lifecycle_state</span> <span class="ow">in</span> <span class="n">good_states</span><span class="p">:</span>
                <span class="n">sub_op</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;compartment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">compartment_id</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;instance_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">display_name</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;guid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;power_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">lifecycle_state</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;volumes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;parent_compartment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_compartment_id</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;parent_compartment_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compartment_name</span>

                <span class="c1"># get vcn details</span>
                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;vcn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">vcn_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NetworkClient</span><span class="o">.</span><span class="n">list_vcns</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">compartment_id</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="k">for</span> <span class="n">vcn</span> <span class="ow">in</span> <span class="n">vcn_out</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">vcn</span><span class="o">.</span><span class="n">lifecycle_state</span> <span class="o">==</span> <span class="n">vcn</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_AVAILABLE</span><span class="p">:</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;vcn&#39;</span><span class="p">][</span><span class="n">vcn</span><span class="o">.</span><span class="n">display_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="n">vcn</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                           <span class="s1">&#39;network_id&#39;</span><span class="p">:</span> <span class="n">vcn</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                           <span class="s1">&#39;vcn_domain_name&#39;</span><span class="p">:</span> <span class="n">vcn</span><span class="o">.</span><span class="n">vcn_domain_name</span><span class="p">,</span>
                                                           <span class="s1">&#39;dns_label&#39;</span><span class="p">:</span> <span class="n">vcn</span><span class="o">.</span><span class="n">dns_label</span>
                                                           <span class="p">}</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;sourceNetwork&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcn</span><span class="o">.</span><span class="n">display_name</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;networkName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcn</span><span class="o">.</span><span class="n">display_name</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;networkDisplayName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcn</span><span class="o">.</span><span class="n">id</span>
                        <span class="c1"># sub_op[&#39;name&#39;] = vcn.id</span>

                <span class="c1"># Handle details for Compute Instances</span>
                <span class="k">if</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="s2">&quot;Compute&quot;</span><span class="p">:</span>
                    <span class="c1"># sub_op[&#39;OCPU&#39;], sub_op[&#39;Memory&#39;], sub_op[&#39;SSD&#39;] =</span>
                    <span class="c1"># shapes.ComputeShape(instance.shape)</span>
                    <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;vmSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_shape</span>
                    <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;instanceSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_shape</span>
                    <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;Datastore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">availability_domain</span>

                    <span class="c1"># get volume data</span>
                    <span class="n">vol_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">list_volume_attachments</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">compartment_id</span><span class="p">)</span>
                    <span class="c1"># boot_vol = self.ComputeClient.list_boot_volume_attachments(instance.id)</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">vol_op</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lifecycle_state</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">LIFECYCLE_STATE_ATTACHED</span><span class="p">:</span>
                            <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;volumes&#39;</span><span class="p">][</span><span class="n">item</span><span class="o">.</span><span class="n">display_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">volume_id</span>

                    <span class="c1"># get vnic</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">list_vnic_attachments</span><span class="p">(</span>
                        <span class="n">compartment_id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">compartment_id</span><span class="p">,</span> <span class="n">instance_id</span><span class="o">=</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">vnics</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
                    <span class="k">for</span> <span class="n">vnic</span> <span class="ow">in</span> <span class="n">vnics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">responsenic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NetworkClient</span><span class="o">.</span><span class="n">get_vnic</span><span class="p">(</span><span class="n">vnic_id</span><span class="o">=</span><span class="n">vnic</span><span class="o">.</span><span class="n">vnic_id</span><span class="p">)</span>
                            <span class="n">nicinfo</span> <span class="o">=</span> <span class="n">responsenic</span><span class="o">.</span><span class="n">data</span>
                            <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="n">nicinfo</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Public IP&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">public_ip</span><span class="p">,</span>
                                                             <span class="s1">&#39;Private IP&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">private_ip</span><span class="p">,</span>
                                                             <span class="s1">&#39;subnet_id&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">subnet_id</span><span class="p">,</span>
                                                             <span class="s1">&#39;nic_mac&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">mac_address</span><span class="p">,</span>
                                                             <span class="s1">&#39;nic_is_primary&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">is_primary</span><span class="p">,</span>
                                                             <span class="s1">&#39;vnic_id&#39;</span><span class="p">:</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">id</span>
                                                             <span class="p">}</span>

                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;vcn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">val</span><span class="p">[</span><span class="s1">&#39;subnet_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">subnet_id</span>
                            <span class="k">if</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">is_primary</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">oci_vm_ip</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">public_ip</span>
                                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;source_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">public_ip</span>
                                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">public_ip</span>
                                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;subnetId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">subnet_id</span>

                                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;sourceNetworkId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">subnet_id</span>

                                <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;destinationNetwork&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nicinfo</span><span class="o">.</span><span class="n">subnet_id</span>

                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to get any network information for </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                             <span class="o">%</span> <span class="n">instance</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>

                    <span class="c1"># Get OS Details</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">source_details</span><span class="o">.</span><span class="n">image_id</span><span class="p">)</span>
                        <span class="n">imagedetails</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;OS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imagedetails</span><span class="o">.</span><span class="n">display_name</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sub_op</span><span class="p">[</span><span class="s1">&#39;OS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NoValueString</span>

                    <span class="n">prefix</span><span class="p">,</span> <span class="n">AD</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">availability_domain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                    <span class="n">LicenseIncluded</span> <span class="o">=</span> <span class="s2">&quot;BYOL&quot;</span>

                <span class="n">sub_op_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_op</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sub_op_list</span></div>

<div class="viewcode-block" id="OciHelper.get_vm_details"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_vm_details">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the details of the VM based by its name</span>
<span class="sd">        :param vm_name: Name of the VM</span>
<span class="sd">        :return: Dict of the VM details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">detailed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">[</span><span class="n">compartment</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">vm_name</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_details_dict</span> <span class="o">=</span> <span class="n">instance</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_details_dict</span></div>

<div class="viewcode-block" id="OciHelper.get_vm_ip"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_vm_ip">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets public IP of a VM by name</span>

<span class="sd">        :param vm_name: Name of the VM</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">detailed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">[</span><span class="n">compartment</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">vm_name</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;Public IP&#39;</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;Public IP&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Could not find network information for the client: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span></div>

<div class="viewcode-block" id="OciHelper.get_vm_ids"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_vm_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method can be used to get an instance id by its name</span>
<span class="sd">        :param vm_name: (str)   Name of the VM</span>
<span class="sd">        :return:        (list)   Reutns the ID of the VM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">detailed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">[</span><span class="n">compartment</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">vm_name</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                    <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;instance_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">vm_list</span></div>

<div class="viewcode-block" id="OciHelper.terminate_vm"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.terminate_vm">[docs]</a>    <span class="k">def</span> <span class="nf">terminate_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_id</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">terminate_instance</span><span class="p">(</span><span class="n">vm_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oci</span><span class="o">.</span><span class="n">wait_until</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ComputeClient</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">vm_id</span><span class="p">),</span>
            <span class="s1">&#39;lifecycle_state&#39;</span><span class="p">,</span>
            <span class="s1">&#39;TERMINATED&#39;</span><span class="p">,</span>
            <span class="n">succeed_on_not_found</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="OciHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets list of ALL names of the VM&#39;s in the OCI that user has access to</span>
<span class="sd">        :return:    (list)  Names of all vms in list format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">detailed_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">compartment</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">detailed_dict</span><span class="p">[</span><span class="n">compartment</span><span class="p">]:</span>
                <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">vm_list</span></div>

<div class="viewcode-block" id="OciHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the VM data Information</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to fetch information from cloud portal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_all_compartments_detailed</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in updating Host&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="OciHelper.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OciHelper.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name    (str)        - vm to which test data has to be copied</span>

<span class="sd">                _test_data_path(str) - path where testdata needs to be generated</span>

<span class="sd">                backup_folder(str)  - name of the folder to be backed up</span>

<span class="sd">        Exception:</span>

<span class="sd">                if fails to generate testdata</span>

<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating test data directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_test_data_path</span><span class="p">)</span>

            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">_test_data_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># create Base dir</span>
            <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying testdata to volume </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">is_local_machine</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span>
                                                          <span class="n">_dest_base_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                    <span class="n">network_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vm_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_folder_to_network_share</span><span class="p">(</span>
                        <span class="n">_test_data_path</span><span class="p">,</span> <span class="n">network_path</span><span class="p">,</span>
                        <span class="n">vm_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="VcloudHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper">[docs]</a><span class="k">class</span> <span class="nc">VcloudHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Vcloud Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize VCloud Helper class properties</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (str):      Hostname of the Vcloud</span>

<span class="sd">            host_machine        (str):      host  machine</span>

<span class="sd">            user_name           (str):      Username of the Vcloud</span>

<span class="sd">            password            (str):      Password of the Vcloud</span>

<span class="sd">            instance_type       (str):      Instance type of the Vcloud</span>

<span class="sd">            auto_commcell       (object):   Commcell object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">VcloudHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                           <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span> <span class="o">+</span> <span class="s2">&quot;/api&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">user_name</span> <span class="o">+</span> <span class="s1">&#39;@system&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vapp_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vapp_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vmdk&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/*+xml;version=31.0&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcloud_auth_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcd_login</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide the default headers required</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/*+xml;version=31.0&#39;</span><span class="p">,</span>
                                 <span class="s2">&quot;x-vcloud-authorization&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcloud_auth_token</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide info about all VM&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span>

    <span class="nd">@all_vmdata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the VM related info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="VcloudHelper.vcd_login"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.vcd_login">[docs]</a>    <span class="k">def</span> <span class="nf">vcd_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform login to vCloud Director, saving the vcloud auth token to header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to fet the authorization code for Vcloud.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/sessions&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                                     <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auth code is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-vcloud-authorization&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vcloud_auth_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-vcloud-authorization&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcloud_auth_token</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in _vcd_login&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.check_for_login_validity"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.check_for_login_validity">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_login_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function check if login is expired if yes it will generate one</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                Failed to get login</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">((</span><span class="ow">not</span> <span class="n">is_sessionok</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)):</span>
                <span class="n">vcloudurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/sessions&quot;</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">vcloudurl</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                                     <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The session is unauthorized, trying to get new token&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vcd_login</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The Session is success no need to create new access token&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcloud_auth_token</span>
                    <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There was error even after getting new token&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.update_hosts"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the VM data Information</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to fetch information from cloud portal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in updating Host&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.collect_all_vm_data"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.collect_all_vm_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_all_vm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prepare list of VMs in vapp in Vcloud</span>

<span class="sd">            Returns:</span>
<span class="sd">            vm_list         (str):  list of all vms</span>

<span class="sd">            Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">            Failed to get the vms from vcloud</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vpp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vapp</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">vapp</span> <span class="ow">in</span> <span class="n">vpp_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vapp_name</span> <span class="o">=</span> <span class="n">vapp</span>
                <span class="n">api_url</span> <span class="o">=</span> <span class="n">vpp_list</span><span class="p">[</span><span class="n">vapp</span><span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span>
                                        <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
                <span class="n">xparse</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xparse</span><span class="p">)</span>
                <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;Children&#39;</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">[</span><span class="n">vm</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vapp</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object</span><span class="p">[</span><span class="n">vm</span><span class="p">][</span><span class="s1">&#39;Children&#39;</span><span class="p">][</span><span class="s1">&#39;Vm&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vapp</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vapp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vapp</span><span class="p">]]</span>

                <span class="k">for</span> <span class="n">vmname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vapp</span><span class="p">]:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">vmname</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span>
                    <span class="n">href</span> <span class="o">=</span> <span class="n">vmname</span><span class="p">[</span><span class="s1">&#39;@href&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">href</span><span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_all_vapp_vms&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function fetches information about all VMs in particular resource group</span>

<span class="sd">        Returns:</span>
<span class="sd">            _all_vmlist     (list):  list of all VM&#39;s</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get VM information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
            <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">datadict</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s1">&#39;@href&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">href</span><span class="p">})</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">,</span> <span class="n">vapp_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Compute the free Resource of Vcloud</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name             (str):  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            vapp_name	    (str):  The resource group where restore can be performed</span>

<span class="sd">            network_name     (str):  Storage account where restore has to be performed</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get resource group or storage accountvapp_name or network_name or all</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">vm_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vapp_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_vapp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">each_vapp</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">each_vm</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">vm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">vapp_name</span> <span class="o">=</span> <span class="n">each_vapp</span>

                <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">eachvalue</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">eachdata</span> <span class="o">==</span> <span class="n">vm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">eachvalue</span>

                <span class="n">api_url</span> <span class="o">=</span> <span class="n">href</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
                <span class="n">xparse</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xparse</span><span class="p">)</span>
                <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">network_name</span> <span class="o">=</span> <span class="n">json_object</span><span class="p">[</span><span class="s1">&#39;Vm&#39;</span><span class="p">][</span><span class="s1">&#39;NetworkConnectionSection&#39;</span><span class="p">][</span><span class="s1">&#39;NetworkConnection&#39;</span><span class="p">][</span><span class="s1">&#39;@network&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">vapp_name</span><span class="p">,</span> <span class="n">network_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in ComputeFreeResources&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.get_all_orgs"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.get_all_orgs">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_orgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare list of organizations in Vcloud</span>

<span class="sd">        Returns:</span>
<span class="sd">        org_list         (dict):  list of all resource groups</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get the organizations from vcloud</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">org_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of Organizations&quot;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/org&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
                                    <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">_all_orgdata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">org</span> <span class="ow">in</span> <span class="n">_all_orgdata</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">_all_orgdata</span><span class="p">[</span><span class="n">org</span><span class="p">][</span><span class="s1">&#39;Org&#39;</span><span class="p">]:</span>
                    <span class="n">org_name</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span>
                    <span class="n">org_list</span><span class="p">[</span><span class="n">org_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">each</span><span class="p">[</span><span class="s1">&#39;@href&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">org_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_orgs&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.get_all_org_vdc"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.get_all_org_vdc">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_org_vdc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare list of VDC in Vcloud</span>

<span class="sd">        Returns:</span>
<span class="sd">        vdc_list        (dict):  list of all resource groups</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get the organizations from vcloud</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of VDC&quot;</span><span class="p">)</span>
            <span class="n">org_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_orgs</span><span class="p">()</span>
            <span class="n">vdc_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">org</span> <span class="ow">in</span> <span class="n">org_list</span><span class="p">:</span>
                <span class="n">api_url</span> <span class="o">=</span> <span class="n">org_list</span><span class="p">[</span><span class="n">org</span><span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
                <span class="n">xparse</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xparse</span><span class="p">)</span>
                <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_org</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">each_link</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">[</span><span class="n">each_org</span><span class="p">][</span><span class="s1">&#39;Link&#39;</span><span class="p">]:</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">each_link</span><span class="p">[</span><span class="s1">&#39;@href&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/vdc/&#39;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">):</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">each_link</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span>
                            <span class="n">vdc_list</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">href</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
            <span class="k">return</span> <span class="n">vdc_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_all_org_vdc()&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VcloudHelper.get_all_vapp"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VcloudHelper.get_all_vapp">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vapp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prepare list of vapp in Vcloud</span>

<span class="sd">            Returns:</span>
<span class="sd">            vapp         (dict):  list of all resource groups</span>

<span class="sd">            Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">            Failed to get the vapp from vcloud</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of Vapps in Vcloud&quot;</span><span class="p">)</span>
            <span class="n">vdc_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_org_vdc</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vdc</span> <span class="ow">in</span> <span class="n">vdc_list</span><span class="p">:</span>
                <span class="n">api_url</span> <span class="o">=</span> <span class="n">vdc_list</span><span class="p">[</span><span class="n">vdc</span><span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
                                        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_cert</span><span class="p">)</span>
                <span class="n">xparse</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xparse</span><span class="p">)</span>
                <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">each_vdc</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">json_object</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">][</span><span class="s1">&#39;ResourceEntities&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_object</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">][</span><span class="s1">&#39;ResourceEntities&#39;</span><span class="p">][</span><span class="s1">&#39;ResourceEntity&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">]]</span>

                        <span class="k">for</span> <span class="n">each_vapp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapp_dict</span><span class="p">[</span><span class="n">each_vdc</span><span class="p">]:</span>
                            <span class="n">href</span> <span class="o">=</span> <span class="n">each_vapp</span><span class="p">[</span><span class="s1">&#39;@href&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;/vApp/&#39;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">each_vapp</span><span class="p">[</span><span class="s1">&#39;@name&#39;</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">vapp_list</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">href</span><span class="p">})</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vapp_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_all_vdc_vapp&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="NutanixHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper">[docs]</a><span class="k">class</span> <span class="nc">NutanixHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Nutanix AHV Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Nutanix AHV Helper class properties</span>


<span class="sd">            Args:</span>
<span class="sd">                server_host_name    (str):      server list at instance level</span>

<span class="sd">                host_machine        (str):      Co-ordinator at instance level</span>

<span class="sd">                user_name           (str):      username of Nutanix cluster</span>

<span class="sd">                password            (tupple):   consist of password, nutanix cluster</span>
<span class="sd">                                                URL</span>

<span class="sd">                instance_type       (str):      Instance type of the Nutanix AHV</span>

<span class="sd">                commcell            (object):   Commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NutanixHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                            <span class="n">user_name</span><span class="p">,</span>
                                            <span class="n">password</span><span class="p">,</span>
                                            <span class="n">instance_type</span><span class="p">,</span>
                                            <span class="n">commcell</span><span class="p">,</span>
                                            <span class="n">host_machine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nutanix_cluster</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;api/nutanix/v0.8/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restv2</span> <span class="o">=</span> <span class="s2">&quot;PrismGateway/services/rest/v2.0/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restv3</span> <span class="o">=</span> <span class="s2">&quot;api/nutanix/v3/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BaseUrl</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanix_cluster</span> <span class="o">+</span> <span class="s2">&quot;:9440/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseUrl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseUrl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">restv2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v3url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseUrl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">restv3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmlist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=utf-8&#39;</span><span class="p">})</span>

<div class="viewcode-block" id="NutanixHelper.all_vm_info"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper.all_vm_info">[docs]</a>    <span class="k">def</span> <span class="nf">all_vm_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information about all VMs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get information about all VMs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_info_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;vms&#39;</span> <span class="o">+</span> <span class="s1">&#39;/?includeVMDiskSizes=true&amp;includeAddressAssignments=true&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vm_info_url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump VMInfoURL: &quot;</span> <span class="o">+</span> <span class="n">vm_info_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vmlist</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in all_vm_info&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NutanixHelper.get_nic_info"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper.get_nic_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_nic_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nicuuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all network Info related to the given network interface.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to fetch network details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nic_info_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;networks/&#39;</span> <span class="o">+</span> <span class="n">nicuuid</span> <span class="o">+</span> <span class="s1">&#39;/snapshots?includeSnapshots=true&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump NicInfoURL: &quot;</span> <span class="o">+</span> <span class="n">nic_info_url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nic_info_url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump NicInfo: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in get_nic_info&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="NutanixHelper.get_snap_info"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper.get_snap_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_snap_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_guid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all Snapshot Info related to the given VM.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get snapshot related information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snap_info_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;vms/&#39;</span> <span class="o">+</span> <span class="n">vm_guid</span> <span class="o">+</span> <span class="s1">&#39;/snapshots?includeSnapshots=true&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump SnapInfoURL: &quot;</span> <span class="o">+</span> <span class="n">snap_info_url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">snap_info_url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump SnapInfo: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in get_snap_info&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="NutanixHelper.get_v3snap_count"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper.get_v3snap_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_v3snap_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_guid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Snapshot count of the given VM using v3 api</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get snapshot related information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">snap_info_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v3url</span> <span class="o">+</span> <span class="s1">&#39;vm_snapshots/list&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump SnapInfoURL: &quot;</span> <span class="o">+</span> <span class="n">snap_info_url</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="s2">&quot;entity_uuid==&quot;</span> <span class="o">+</span> <span class="n">vm_guid</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span>
                <span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;vm_snapshot&quot;</span><span class="p">,</span> <span class="s2">&quot;sort_order&quot;</span><span class="p">:</span> <span class="s2">&quot;ASCENDING&quot;</span><span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">snap_info_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;Commvault!12&#39;</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump response: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;list of snapshots: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;uuid&quot;</span><span class="p">]))</span>
            <span class="n">snap_count</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">]))</span>

            <span class="k">return</span> <span class="n">snap_count</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in get_snap_names&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="NutanixHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.NutanixHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">            Args:</span>
<span class="sd">                    vm_name		(list)  --  list of Vms to be restored</span>

<span class="sd">            Returns:</span>
<span class="sd">                   vm_container (str)   --  storage container of VM</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if there is an error in computing the resources of the endpoint.</span>

<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="n">vm_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">disks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">disk_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;containerId&quot;</span> <span class="ow">in</span> <span class="n">disks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">container_uuid</span> <span class="o">=</span> <span class="n">disks</span><span class="p">[</span><span class="s2">&quot;containerUuid&quot;</span><span class="p">]</span>
                    <span class="n">container_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2url</span> <span class="o">+</span> <span class="s1">&#39;storage_containers/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">container_uuid</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutanixsession</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container_url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dump VMInfoURL: &quot;</span> <span class="o">+</span> <span class="n">container_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_container</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking for other disk&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_container</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources&quot;</span>
                               <span class="s2">&quot; for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="XenHelper"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.XenHelper">[docs]</a><span class="k">class</span> <span class="nc">XenHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Xen Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">auto_commcell</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize XEN Helper class properties</span>


<span class="sd">            Args:</span>
<span class="sd">                server_host_name    (str):      server list at instance level</span>

<span class="sd">                host_machine        (str):      Co-ordinator at instance level</span>

<span class="sd">                user_name           (str):      username of Nutanix cluster</span>

<span class="sd">                password            (tupple):   consist of password, nutanix cluster</span>
<span class="sd">                                                URL</span>

<span class="sd">                instance_type       (str):      Instance type of the Nutanix AHV</span>

<span class="sd">                commcell            (object):   Commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">XenHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
                                        <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_login</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">XenAPI</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">XenAPI</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">xenapi</span><span class="o">.</span><span class="n">login_with_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&quot;2.12&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">xenapi</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception login to </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="XenHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.XenHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information about all VMs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to get information about all VMs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_vms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">VM</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span>
            <span class="n">vms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">all_vms</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">VM</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
                <span class="n">vms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name_label&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">vms</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in getting vms info </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="XenHelper.compute_free_resources"><a class="viewcode-back" href="../../../source/VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.XenHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free Resource of the Xen Server based on space</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_list		        (list): list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">               _server              (str): Xen server</span>

<span class="sd">               _storage              (str):  Storage for the server</span>


<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in computing the resources of the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_server</span><span class="p">,</span> <span class="n">_storage</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_server</span><span class="p">:</span>
                    <span class="n">_server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">host</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_server</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Vms are on multiple Server. Please pass teh Server in Input&quot;</span><span class="p">)</span>
            <span class="n">vbds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">SR</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span>
            <span class="n">_data_store_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">vbd</span> <span class="ow">in</span> <span class="n">vbds</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">SR</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">vbd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lvm&#39;</span><span class="p">,</span> <span class="s1">&#39;lvmoiscsi&#39;</span><span class="p">,</span> <span class="s1">&#39;nfs&#39;</span><span class="p">):</span>
                    <span class="n">_data_store_dict</span><span class="p">[</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;name_label&#39;</span><span class="p">],</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;PBDs&#39;</span><span class="p">],</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;physical_size&#39;</span><span class="p">]</span>
            <span class="n">_max_storage</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_server_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_by_name_label</span><span class="p">(</span><span class="n">_server</span><span class="p">)</span>
            <span class="n">_server_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span><span class="n">_server_details</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_val</span> <span class="ow">in</span> <span class="n">_data_store_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_server_details</span><span class="p">[</span><span class="s1">&#39;PBDs&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">_max_storage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_max_storage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_val</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">_storage</span> <span class="o">=</span> <span class="n">_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_max_storage</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">_max_storage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_val</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">_storage</span> <span class="o">=</span> <span class="n">_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">_server</span><span class="p">,</span> <span class="n">_storage</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources&quot;</span>
                               <span class="s2">&quot; for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>