
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>VirtualServer.VSAUtils.HypervisorHelper &#8212; Commvault Automation 11.13 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for VirtualServer.VSAUtils.HypervisorHelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main file that does all operations on hypervsor</span>

<span class="sd">classes defined:</span>
<span class="sd">    Base class:</span>
<span class="sd">        Hypervisor- Act as base class for all hypervior operations</span>

<span class="sd">    Inherited class:</span>
<span class="sd">        HyperVHelper - Does all operations on Hyper-V Hypervisor</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_all_vms_in_hypervisor()    - abstract -get all the VMs in that hypervisor</span>

<span class="sd">        compute_free_resources()    - compute teh free resource for perfoming restores</span>

<span class="sd">    VmwareHelper:</span>

<span class="sd">        get_all_vms_in_hypervisor()		        - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">        compute_free_resources()		        - compute the Vmware host and Datastore</span>
<span class="sd">                                                    for performing restores</span>

<span class="sd">        _vmware_login()                         - Login to vcenter 6.5 and above</span>

<span class="sd">        _make_request()                         - Rest api calls to vcenter</span>

<span class="sd">        _vmware_get_vms()                       - Get list of qualified vms</span>

<span class="sd">        _get_vcenter_version()                  - get the vcenter version</span>

<span class="sd">        get_all_vms_in_hypervisor()             - Get complete list of vms in the vcenter</span>

<span class="sd">        compute_free_resources()                - Calculate free resources</span>

<span class="sd">        _get_datastore_dict()                   - Get list of datastore with free space</span>

<span class="sd">        _get_host_memory()                      - Get list of esx with free ram and cpu</span>

<span class="sd">        _get_required_resource_for_restore()    - Get restore vm ram and storage requirement</span>

<span class="sd">        _get_datastore_priority_list()          - Get list of datastore in descending</span>
<span class="sd">                                                    order as per free space</span>

<span class="sd">        _get_host_priority_list()               -  Get list of esx in descending oder</span>
<span class="sd">                                                    as per free ram</span>

<span class="sd">        _get_datastore_tree_list()              - get datastore hierarchy</span>

<span class="sd">        copy_test_data_to_each_volume() - Copy test data to backup vm</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">VMHelper</span><span class="p">,</span> <span class="n">VirtualServerConstants</span><span class="p">,</span> <span class="n">VirtualServerUtils</span><span class="p">,</span> <span class="n">VmwareServices</span><span class="p">,</span>\
    <span class="n">FusionComputeServices</span><span class="p">,</span> <span class="n">OracleCloudServices</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">machine</span>
<span class="kn">from</span> <span class="nn">requests.packages.urllib3.exceptions</span> <span class="k">import</span> <span class="n">InsecureRequestWarning</span>

<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<div class="viewcode-block" id="Hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor">[docs]</a><span class="k">class</span> <span class="nc">Hypervisor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for performing all Hypervisor operations</span>

<span class="sd">    Methods:</span>
<span class="sd">         get_all_vms_in_hypervisor()    - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">        compute_free_resources()        - compute the hyperv host and destiantion path</span>
<span class="sd">                                                    for perfoming restores</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                <span class="n">host_machine</span><span class="p">,</span>
                <span class="n">user_name</span><span class="p">,</span>
                <span class="n">password</span><span class="p">,</span>
                <span class="n">instance_type</span><span class="p">,</span>
                <span class="n">commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the object based in intstance_type</span>

<span class="sd">        server_name (list)  - hypervisor name eg: vcenter name or Hyperv host</span>

<span class="sd">        host_machine    (str)  - client of cs where we will execute all hypervisor operations</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hv_type</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">hypervisor_type</span>
        <span class="k">if</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">MS_VIRTUAL_SERVER</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">HyperVHelper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">VIRTUAL_CENTER</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">VmwareHelper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">AZURE_V2</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">AzureHelper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">Fusion_Compute</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">FusionComputeHelper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">ORACLE_VM</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">OracleVMHelper</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">instance_type</span> <span class="o">==</span> <span class="n">hv_type</span><span class="o">.</span><span class="n">Oracle_Cloud_Classic</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">OracleCloudHelper</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize common variables for hypervior</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_list</span> <span class="o">=</span> <span class="n">server_host_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_machine</span> <span class="o">=</span> <span class="n">host_machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host_machine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets the user name of the Vm . it si read only attribute&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_name</span>

    <span class="nd">@vm_user_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets the user name of the VM if it is differnt form default&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_name</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;gets the user name of the Vm . it si read only attribute&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span>

    <span class="nd">@vm_password</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets the user name of the VM if it is differnt form default&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns List of VMs. It is read onlyt attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span>

    <span class="nd">@VMs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">VMs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;creates VMObject for list of VM passed</span>
<span class="sd">        Args:</span>
<span class="sd">            vmList    (list) - list of VMs for creating VM object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">[</span><span class="n">vm_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">VMHelper</span><span class="o">.</span><span class="n">HypervisorVM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VMs are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VMs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in creating object </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="Hypervisor.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.get_all_vms_in_hypervisor">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all the Vms in Hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                server    (str)    - specific hypervisor Host for which all Vms has to be fetched</span>

<span class="sd">        Return:</span>
<span class="sd">                Vmlist    (list)    - List of Vms in  in host of Pseudoclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get all the VMs in hypervisor class&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Hypervisor.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.compute_free_resources">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_list  - list of servers from which best has to be chosen</span>

<span class="sd">            vm_list     - list of Vm to be restored</span>

<span class="sd">        Return:</span>
<span class="sd">                host         (str)    - hypervisor host where vm is to be restored</span>
<span class="sd">                                            like esx, resourcegroup,region,hyperv host</span>

<span class="sd">                datastore    (str)    - diskspace where vm needs to be restored</span>
<span class="sd">                                            like destinationpath,datastore,bucket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;computes the free ESXHost and Datastore in case of VMware&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hypervisor.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name    (str)        - vm to which test data has to be copied</span>

<span class="sd">                _drive(str)            - Drive letter where data needs to be copied</span>

<span class="sd">                _test_data_path(str) - path where testdata needs to be generated</span>

<span class="sd">                backup_folder(str)  - name of the folder to be backed up</span>

<span class="sd">        Exception:</span>

<span class="sd">                if fails to generate testdata</span>

<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating test data was successful now copying it&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span> <span class="n">_dest_base_path</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="Hypervisor.update_hosts"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.Hypervisor.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the Information of Host</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Host Is updated&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HyperVHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper">[docs]</a><span class="k">class</span> <span class="nc">HyperVHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Hyperv Hyperviosr</span>

<span class="sd">    Methods:</span>
<span class="sd">            get_all_vms_in_hypervisor()        - abstract -get all the VMs in HYper-V Host</span>

<span class="sd">            compute_free_resources()        - compute the hyperv host and destiantion path</span>
<span class="sd">                                                    for perfoming restores</span>

<span class="sd">            mount_disk()                    - Mount the Vhd/VHDX and return the drive letter</span>

<span class="sd">            un_mount_disk()                    - Unmount the VHD mounted provided the path</span>

<span class="sd">            _get_datastore_dict()            - get the list of drives with space in Hyper-V</span>

<span class="sd">            _get_datastore_priority_list()    - return the drives in Hyper-V Host in</span>
<span class="sd">                                                    increasing order of disk size</span>

<span class="sd">            _get_proxy_priority_list()        - returns the proxy associated with that instance in</span>
<span class="sd">                                                    increasing order of memory</span>

<span class="sd">            _get_required_memory_for_restore()- Sum of Memory of the VM to be restored</span>

<span class="sd">            _get_required_diskspace_for_restore()- Sum of disk space of the VM to be restored</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Hyper-V Helper class properties</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HyperVHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server_host_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span> <span class="o">=</span> <span class="s2">&quot;GetHypervProps.ps1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vhd&quot;</span><span class="p">,</span> <span class="s2">&quot;.avhd&quot;</span><span class="p">,</span> <span class="s2">&quot;.vhdx&quot;</span><span class="p">,</span> <span class="s2">&quot;.avhdx&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vhd_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>

<div class="viewcode-block" id="HyperVHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get all the Vms in Hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                server    (str)    - specific hypervisor Host for which all Vms has to be fetched</span>

<span class="sd">        Return:</span>
<span class="sd">                Vmlist    (list)    - List of Vms in  in host of Pseudoclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_all_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">server</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">server_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">server_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">server</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">_each_server</span> <span class="ow">in</span> <span class="n">server_list</span><span class="p">:</span>
                <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_each_server</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetAllVM&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
                <span class="c1"># _stdout, _stderr = VirtualServerUtils.ExecutePsFile(</span>
                <span class="c1"># _ps_path, _each_server, self.user_name, self.password, &quot;&quot;, &quot;GetAllVM&quot;)</span>

                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                            <span class="n">_all_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_all_vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred while getting all Vms from Hypervisor&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperVHelper.mount_disk"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.mount_disk">[docs]</a>    <span class="k">def</span> <span class="nf">mount_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_obj</span><span class="p">,</span> <span class="n">_vhdpath</span><span class="p">,</span> <span class="n">destination_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mount the disk and return the drive letter mounted</span>

<span class="sd">        vm_obj -         (str)    - Vm helper object of the VM for which disk has to be mounted</span>

<span class="sd">        _vhdpath    (str)    - diks path has to be mounted</span>

<span class="sd">        destination_client  (obj)   - client where the disk to be mounted are located</span>

<span class="sd">        return:</span>
<span class="sd">                _drive_letter    (list)    - drive lettter in which disk is mounted</span>

<span class="sd">        Exception:</span>
<span class="sd">                if disk failed to mount</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_drive_letter</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">,</span> <span class="n">destination_client</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_drive_letter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;VsHD might be corrupted mouting failed,&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot Mount the disk&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mounting restored VHD was succesfull&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Drive letter is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_drive_letter</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_drive_letter</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;exception raised in Mounting Disk , cannot proceed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.un_mount_disk"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.un_mount_disk">[docs]</a>    <span class="k">def</span> <span class="nf">un_mount_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_obj</span><span class="p">,</span> <span class="n">_vhdpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        unmount the disk taht is mounted</span>

<span class="sd">         vm_obj -         (str)    - Vm helper object of the VM for which disk has to be unmounted</span>

<span class="sd">        _vhdpath    (str)    - diks path has to be unmounted</span>


<span class="sd">        Exception:</span>
<span class="sd">                if disk failed to unmount</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to unmount diks </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_vhdpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VHD file exists...unmounting the file&quot;</span><span class="p">)</span>
                <span class="n">vm_obj</span><span class="o">.</span><span class="n">un_mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Mountpath provided for cleanup...checking for vhd files&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.vhd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.vhdx&quot;</span><span class="p">)</span> <span class="ow">or</span>
                                <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.avhd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.avhdx&quot;</span><span class="p">)):</span>
                            <span class="n">_vhdpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found VHD file... &quot;</span> <span class="o">+</span> <span class="n">_vhdpath</span><span class="p">)</span>
                            <span class="n">vm_obj</span><span class="o">.</span><span class="n">un_mount_vhd</span><span class="p">(</span><span class="n">_vhdpath</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;exception raised in UnMounting Disk , cannot proceed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the list of datastore in an proxy</span>

<span class="sd">        proxy                 (str)    - list of datastores in that</span>
<span class="sd">                                            particular proxy would be returned</span>
<span class="sd">        proxy_host_name       (str)    - host_name of the proxy</span>

<span class="sd">        Return:</span>
<span class="sd">                disk_size_dict    (dict)    - with drive as keys and size</span>
<span class="sd">                                                    as values in proxy provided</span>
<span class="sd">                                                        disk_size_dict = {&#39;proxy-c&#39;:14586}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DISKSIZE&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>

            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">_stdout</span><span class="p">:</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_stdlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">disk</span> <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">disk</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">_each_disk</span> <span class="ow">in</span> <span class="n">_stdlines</span><span class="p">:</span>
                    <span class="n">_diskname</span> <span class="o">=</span> <span class="n">proxy</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">_each_disk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_disksize</span> <span class="o">=</span> <span class="n">_each_disk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">_diskname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_disksize</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_disk_size_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetDatastoreDict Disk &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>


    <span class="k">def</span> <span class="nf">_get_host_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the free memory in proxy</span>

<span class="sd">        Args:</span>

<span class="sd">                proxy     (str)    - list of datastores in that particular proxy would be returned</span>

<span class="sd">                proxy_host_name       (str)    - host_name of the proxy</span>

<span class="sd">        return:</span>
<span class="sd">                val     (int)    - free  memory of Host in GB eg:; 3GB</span>

<span class="sd">        Exception:</span>
<span class="sd">                Raise exception when failed to get Memeory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;HostMemory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_host_name</span>
            <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>

            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="n">_stdout</span><span class="p">:</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">val</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Memory&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetMemory  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_datastore_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From the given list of proxy get all the details of drive and space</span>
<span class="sd">                                                                and order them in increasing size</span>

<span class="sd">        Args:</span>
<span class="sd">                vsa_proxy_list            (list)    - list of proxies which needs to be</span>
<span class="sd">                                                                    ordered as per disk size</span>

<span class="sd">                host_dict                 (dict)    -dictionary of proxies and their matching host name</span>
<span class="sd">        returns:</span>
<span class="sd">            _sorted_datastore_dict(dict)    - with disk proxy-drive name as keys and size as values</span>
<span class="sd">                                                        _sorted_datastore_dict = {&#39;proxy-c&#39;:14586,</span>
<span class="sd">                                                                                  &#39;proxy1-D&#39;:12456}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">_each_proxy</span> <span class="ow">in</span> <span class="n">vsa_proxy_list</span><span class="p">:</span>
                <span class="n">_datastoredict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">(</span><span class="n">_each_proxy</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">[</span><span class="n">_each_proxy</span><span class="p">])</span>
                <span class="n">_datastore_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_datastoredict</span><span class="p">)</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                        <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  GetDatastorePriorityList &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_proxy_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the free host memory in proxy and arrange them with increarsing order</span>

<span class="sd">        Args:</span>
<span class="sd">                vsa_proxy_list            (list)    - list of proxies which needs to be</span>
<span class="sd">                                                    ordered as per Host Memory</span>

<span class="sd">                host_dict                 (dict)    -dictionary of proxies and their matching host name</span>
<span class="sd">        returns:</span>
<span class="sd">                _sorted_proxy_dict    (dict)    - with disk proxy name as keys and memory as values</span>
<span class="sd">                                                                _sorted_proxy_dict = {&#39;proxy&#39;:5GB,</span>
<span class="sd">                                                                                     &#39;proxy1&#39;:4GB}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_proxy_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">vsa_proxy_list</span><span class="p">:</span>
                <span class="n">_proxy_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_memory</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">])</span>
                <span class="n">_proxy_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_proxy_memory</span><span class="p">)</span>

            <span class="n">_sorted_proxy_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_proxy_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                    <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_proxy_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in  GetProxyPriorityList &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_memory_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the memory of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_list    (list)    - list of vm to be restored</span>

<span class="sd">        returns:</span>
<span class="sd">                sum of total memory of VM to be restored in Gb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                    <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">Memory</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_vm_total_memory</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_diskspace_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the disk space of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_list    (list)    - list of vm to be restored</span>

<span class="sd">        returns:</span>
<span class="sd">                sum of total disk space of VM to be restored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_total_disk_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="n">storage_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_storage_details</span><span class="p">()</span>
                    <span class="n">_vm_total_disk_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">storage_details</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
            <span class="n">_vm_total_disk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_vm_total_disk_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_disk_size</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  _get_required_diskspace_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="HyperVHelper.get_disk_in_the_path"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.get_disk_in_the_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_disk_in_the_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         get all the disks in the folder</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_path     (str)   - path of the folder from which disk needs to be listed</span>
<span class="sd">                                        e.g: C:\\CVAutomation</span>

<span class="sd">         Returns:</span>
<span class="sd">                disk_list   (list)-   list of disks in the folder</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the list of files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">disk_name_with_path</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">disk_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">disk_name_with_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">disk_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span><span class="p">):</span>
                    <span class="n">_disk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_disk_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception occurred </span><span class="si">{0}</span><span class="s2"> in getting disk list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="p">)</span></div>

<div class="viewcode-block" id="HyperVHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies from which best proxy has to found</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">                vm_list        (list) - list of Vms to be restored</span>

<span class="sd">        return:</span>
<span class="sd">                proxy_name    (str)    - the proxy where restore can be performed</span>

<span class="sd">                datastore_name(str)    - datastore where restore has to be performed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">proxy_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datastore_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_proxy_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_proxy_priority_list</span><span class="p">(</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">)</span>
            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_priority_list</span><span class="p">(</span>
                <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">)</span>
            <span class="n">_total_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_memory_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_diskspace_for_restore</span><span class="p">(</span>
                <span class="n">vm_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">proxy_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;The Datastore </span><span class="si">%s</span><span class="s2"> has more than total disk space in VM&quot;</span> <span class="o">%</span> <span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_proxy_priority_dict</span><span class="p">[</span><span class="n">proxy_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;the Proxy </span><span class="si">%s</span><span class="s2"> has higher memory than the total VMs&quot;</span> <span class="o">%</span> <span class="n">proxy_name</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">proxy_name</span><span class="p">,</span> <span class="n">datastore_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in  ComputeFreeResources &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">,</span>
                                      <span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name    (str)        - vm to which test data has to be copied</span>

<span class="sd">                _drive(str)            - Drive letter where data needs to be copied</span>

<span class="sd">                _test_data_path(str) - path where testdata needs to be generated</span>

<span class="sd">                backup_folder(str)  - name of the folder to be backed up</span>

<span class="sd">                machine(obj)        - the machine class object of the controller</span>

<span class="sd">        Exception:</span>

<span class="sd">                if fails to generate testdata</span>

<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>



            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># create Base dir</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;unix&quot;</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating test data was successful now copying it&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span> <span class="n">_dest_base_path</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.check_cbt_driver_running"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.check_cbt_driver_running">[docs]</a>    <span class="k">def</span> <span class="nf">check_cbt_driver_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if CBT driver is running on the hyperv node</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies/ hyperv nodes</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">        Exception:</span>
<span class="sd">                If unable to check CBT driver status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">driver_state</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;cmd.exe /c &quot;sc query cvcbt&quot;&#39;</span>
                <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">driver_state</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">_output</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The CVCBT driver is running on proxy </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The CVCBT driver is not running on the proxy </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  checking if CVCBT driver is running  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="HyperVHelper.check_or_set_cbt_registry"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.HyperVHelper.check_or_set_cbt_registry">[docs]</a>    <span class="k">def</span> <span class="nf">check_or_set_cbt_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">,</span> <span class="n">instanceno_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check/Set if CBT registry for CBT testing is set on the proxies</span>

<span class="sd">        Args:</span>
<span class="sd">                proxy_list    (list)    -list of proxies/ hyperv nodes</span>

<span class="sd">                host_dict     (dict)    -dictionary of proxies and their matching host name</span>

<span class="sd">        Return:</span>
<span class="sd">                CBTStatFolder (String) -Folder path where CBT stats are collected</span>

<span class="sd">        Exception:</span>
<span class="sd">                An error occurred while checking/creating the registry </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                <span class="n">proxy_machine</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instanceno_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span>
                <span class="n">registry_path</span> <span class="o">=</span> <span class="s2">&quot;VirtualServer&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_registry_exists</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">CBTStatFolder</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">get_registry_value</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CBTStatFolder</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">CBTStatus&quot;</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;sCVCBTStatsFolder&quot;</span><span class="p">,</span> <span class="n">CBTStatFolder</span> <span class="p">,</span> <span class="s2">&quot;String&quot;</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;bDumpCVCBTStatsToFile&quot;</span><span class="p">,</span> <span class="s2">&quot;00000001&quot;</span><span class="p">,</span> <span class="s2">&quot;DWord&quot;</span><span class="p">)</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">registry_path</span><span class="p">,</span> <span class="s2">&quot;bDumpCVCBTStats&quot;</span><span class="p">,</span> <span class="s2">&quot;00000001&quot;</span><span class="p">,</span> <span class="s2">&quot;DWord&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;An error occured while creating the registry&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checked and created CBT driver dump stats registry&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">CBTStatFolder</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred while checking/creating the registry  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="VmwareHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper">[docs]</a><span class="k">class</span> <span class="nc">VmwareHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Vmware Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Vmware Helper class properties</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (str):      Hostname of the Vcenter</span>

<span class="sd">            host_machine        (str):      Vcenter name</span>

<span class="sd">            user_name           (str):      Username of the Vcenter</span>

<span class="sd">            password            (str):      Password of the Vcenter</span>

<span class="sd">            instance_type       (str):      Instance type of the Vmware</span>

<span class="sd">            auto_commcell       (object):   Commcell object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">VmwareHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">auto_commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span> <span class="o">=</span> <span class="s2">&quot;GetVmwareProps.ps1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_operation_ps_file</span> <span class="o">=</span> <span class="s2">&quot;VmwareOperation.ps1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmware_url</span> <span class="o">=</span> <span class="s1">&#39;https://</span><span class="si">{0}</span><span class="s1">/rest&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vmware-api-session-id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="n">VmwareServices</span><span class="o">.</span><span class="n">get_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
            <span class="s2">&quot;pwd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;server_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
            <span class="s2">&quot;pwd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="s2">&quot;vm_name&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_user&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_pass&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extra_args&quot;</span><span class="p">:</span> <span class="s2">&quot;$null&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vmdk&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_vmware_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Login to vcenter 6.5 and above</span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Failed to login to vcenter server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">login_request</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">],</span> <span class="n">login_request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;vmware-api-session-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method          (str):  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url             (str):  the web url or service to run the HTTP request on</span>

<span class="sd">            payload         (str):  data to be passed along with the request</span>

<span class="sd">            attempts        (int):  number of attempts made with the same request</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) - in case of success</span>

<span class="sd">                (False, response) - in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            Vmware SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;vmware-api-session-id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;vmware-api-session-id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_login</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Raise max attempts exception, if attempts exceeds 3</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_vmware_get_vms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sums up all the memory of needs to be restores(passed as VM list)</span>

<span class="sd">        Returns:</span>
<span class="sd">             vmlist         (dict): list of powered on vms in the Vcenter</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vms from vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vmlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_ALL_VMS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                    <span class="n">vmlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">vmlist</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting list of vms from vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_vcenter_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ps_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Get the vcenter version</span>

<span class="sd">        Args:</span>
<span class="sd">            ps_path         (str):  Path for vmware script file</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vvcetner version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting Vcenter version&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="VmwareHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the vms for vmware</span>

<span class="sd">        Args:</span>
<span class="sd">            server          (str):  Vcenter for which all the VMs has to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">            _all_vm_list    (str):  List of VMs in the host of the Vcenter</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get the vms from vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetVcenterVersion&quot;</span>
            <span class="c1"># next code is commented out till we get full support for API for vmware</span>
            <span class="c1">#self._get_vcenter_version(_ps_path)</span>
            <span class="n">_all_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">&gt;=</span> <span class="mf">6.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_login</span><span class="p">()</span>
                <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_get_vms</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetAllVM&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[()\sA-Za-z0-9_-]*&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">_all_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_all_vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting all VMs from Vcenter&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="VmwareHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list         (str):  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            Datastore	    (str):  The Datastore where restore can be performed</span>

<span class="sd">            ESX             (str):  ESX where restore has to be performed</span>

<span class="sd">            Cluster         (str):  Cluster where restore has to be performed</span>

<span class="sd">            Datacenter      (str):  DataCenter where restore has to be performed</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get Datastore or ESX or Cluster or Datacenter or all</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_priority_list</span><span class="p">()</span>
            <span class="n">_host_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_priority_list</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">vm_list</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_total_vm_memory</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span>
                                  <span class="s2">&quot;The Datastore </span><span class="si">%s</span><span class="s2"> has more than total&quot;</span>
                                  <span class="s2">&quot;disk space in VM&quot;</span> <span class="o">%</span> <span class="n">datastore_name</span><span class="p">)</span>
                    <span class="n">_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_tree_list</span><span class="p">(</span><span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">each_host</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span> <span class="ow">and</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;the Host </span><span class="si">%s</span><span class="s2"> has higher &quot;</span>
                                <span class="s2">&quot;memory than the total VMs&quot;</span> <span class="o">%</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;ESX&#39;</span><span class="p">],</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">],</span> <span class="n">_tree</span><span class="p">[</span><span class="s1">&#39;Datacenter&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting &quot;</span>
                               <span class="s2">&quot;datastore or ESX or Cluster or Datacenter or all&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of datastore in an ESX</span>

<span class="sd">        Returns:</span>
<span class="sd">            _disk_size_dict     (dict): Datastores with name and free spaces</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get datastores from the Vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">&gt;=</span> <span class="mf">6.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vmware_login</span><span class="p">()</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_ALL_DATASTORES&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VMFS&#39;</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;[GX]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">_ds_name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                            <span class="n">_disk_size_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">_ds_name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;datastore&#39;</span><span class="p">])</span>
                            <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">_ds_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;free_space&#39;</span><span class="p">])</span>
                            <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">_ds_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetDatastoreDetail&quot;</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
                                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">),</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
                <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
                <span class="n">_temp_ds_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;GetDatastoreDetail = @{&quot;</span><span class="p">)</span>
                <span class="n">_temp_ds_list</span> <span class="o">=</span> <span class="n">_temp_ds_list</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;} @{&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_ds</span> <span class="ow">in</span> <span class="n">_temp_ds_list</span><span class="p">:</span>
                    <span class="n">each_ds_list</span> <span class="o">=</span> <span class="n">each_ds</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">each_ds_data</span> <span class="ow">in</span> <span class="n">each_ds_list</span><span class="p">:</span>
                        <span class="n">each_ds_split</span> <span class="o">=</span> <span class="n">each_ds_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                        <span class="n">each_ds_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">each_ds_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">_disk_size_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">each_ds_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_ds_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_disk_size_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in _get_datastore_dict  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_all_nics_in_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the nics in the host</span>

<span class="sd">        Returns:</span>
<span class="sd">            nics_dict           (list):     list of nics in each esx host</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Not able to get nic cards from the Vcenter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_nics_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;getNicDetail&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
                                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="n">_temp_nics_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;getNicDetail = @{&quot;</span><span class="p">)</span>
            <span class="n">_temp_nics_list</span> <span class="o">=</span> <span class="n">_temp_nics_list</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;} @{&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_nic</span> <span class="ow">in</span> <span class="n">_temp_nics_list</span><span class="p">:</span>
                <span class="n">each_nic_detail</span> <span class="o">=</span> <span class="n">each_nic</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Portgroup&quot;</span> <span class="ow">in</span> <span class="n">each_nic_detail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z0-9.= ]*$&quot;</span><span class="p">,</span> <span class="n">each_nic_detail</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[a-zA-Z0-9.= ]*$&quot;</span><span class="p">,</span> <span class="n">each_nic_detail</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>

                    <span class="n">esx_name</span> <span class="o">=</span> <span class="n">each_nic_detail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;ESX=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">port_group</span> <span class="o">=</span> <span class="n">each_nic_detail</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Portgroup=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">_nics_dict</span><span class="p">[</span><span class="n">esx_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">port_group</span>

            <span class="k">return</span> <span class="n">_nics_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in _get_all_nics_in_host  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the free memory in the ESX</span>

<span class="sd">        Returns:</span>
<span class="sd">            _esx_dict           (dict): Dictionary of ESX and its free space</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get Memory of the ESX</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_esx_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetESXDetail&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcenter_version</span> <span class="o">&gt;=</span> <span class="mf">6.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Vmware Api is limited for HOST. Using powershell&quot;</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                #Vmware Api only gives ESX, name, id, and power state, Commenting the code.</span>
<span class="sd">                It can be used in future</span>
<span class="sd">                self._vmware_login()</span>
<span class="sd">                flag, response = self._make_request(&#39;GET&#39;, self._services[&#39;GET_ALL_ESX&#39;])</span>
<span class="sd">                if flag:</span>
<span class="sd">                    for i in response.json()[&#39;value&#39;]:</span>
<span class="sd">                        if i[&#39;connection_state&#39;] == &#39;CONNECTED&#39;</span>
<span class="sd">                        and i[&#39;power_state&#39;] == &#39;POWERED_ON&#39;:</span>
<span class="sd">                            _esx_name = i[&#39;name&#39;]</span>
<span class="sd">                            _esx_dict.setdefault(_esx_name, []).append(i[&#39;host&#39;])</span>
<span class="sd">                &#39;&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting details for the HOST&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetESXDetail&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
                                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span>
            <span class="n">_temp_esx_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;GetESXDetail = @{&quot;</span><span class="p">)</span>
            <span class="n">_temp_esx_list</span> <span class="o">=</span> <span class="n">_temp_esx_list</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;} @{&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_esx</span> <span class="ow">in</span> <span class="n">_temp_esx_list</span><span class="p">:</span>
                <span class="n">each_esx_detail</span> <span class="o">=</span> <span class="n">each_esx</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_esx_data</span> <span class="ow">in</span> <span class="n">each_esx_detail</span><span class="p">:</span>
                    <span class="n">each_esx_split</span> <span class="o">=</span> <span class="n">each_esx_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">each_esx_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">each_esx_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">_esx_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">each_esx_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_esx_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_esx_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;exception raised in GetMemory  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sums up all the memory of needs to be restores(passed as VM list)</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_list             (str):  list of vm to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">            _vm_total_memory    (int):  Total memory required for restoring</span>

<span class="sd">            _vm_total_space     (int):  Total disk space required for restoring</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get space and ram of the source vm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">Memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;VMSpace&#39;</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_vm_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">VMSpace</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_space</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Error occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_datastore_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted datastore Dict according to free space</span>

<span class="sd">        Returns:</span>
<span class="sd">            _sorted_datastore_dict      (dict): Returns the descending sorted datastore dict</span>
<span class="sd">                                                according to free space</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to set datastore priority list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">),</span>
                                       <span class="nb">list</span><span class="p">(</span><span class="nb">map</span>
                                            <span class="p">(</span><span class="nb">float</span><span class="p">,</span>
                                             <span class="n">_datastore_dict</span><span class="o">.</span><span class="n">get</span>
                                             <span class="p">(</span><span class="s1">&#39;FreeSpaceGB&#39;</span><span class="p">)))))</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                                 <span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                  <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Error occurred in  _get_datastore_priority_list &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_host_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the free host memory in ESX, sorted in descending order</span>

<span class="sd">        Returns:</span>
<span class="sd">            _sorted_proxy_dict      (dict): Descending Sorted dict of esx according to free RAM</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to set esx host priority</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_proxy_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_memory</span><span class="p">()</span>
            <span class="n">_proxy_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">_proxy_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">),</span>
                                   <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">_proxy_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MemoryFreeGB&#39;</span><span class="p">)))))</span>
            <span class="n">_sorted_proxy_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_proxy_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                    <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_proxy_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Error occurred in  _get_host_priority_list &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_get_datastore_tree_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datastore</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the free host memory in proxy and arrange them with ascending order</span>

<span class="sd">        Args:</span>
<span class="sd">            datastore           (str):  Datastore for which we need need to find the hierarchy</span>

<span class="sd">        Returns:</span>
<span class="sd">            tree_list           (dict): Dict contains parent ESX, Cluster, Datacenter for the datastore</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                Raise exception when failed to get tree structure for the datastore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GetStructureTree&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datastore</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>
                                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_ps_file</span><span class="p">),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">)</span>
            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">_formatted_output</span>
            <span class="n">tree_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;GetStructureTree = &quot;</span><span class="p">)</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="n">_temp_vm_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="n">each_vm1</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_vmx</span> <span class="ow">in</span> <span class="n">each_vm1</span><span class="p">:</span>
                    <span class="n">each_vm2</span> <span class="o">=</span> <span class="n">each_vmx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">tree_list</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">each_vm2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">tree_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An error occurred in  _get_datastore_tree_list &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="VmwareHelper.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy testdata to each volume in the vm provided</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name             (str):  vm to which test data has to be copied</span>

<span class="sd">            _drive              (str):  Drive letter where data needs to be copied</span>

<span class="sd">            backup_folder       (str):  name of the folder to be backed up</span>

<span class="sd">            _test_data_path     (str):  path where testdata needs to be generated</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to generate testdata or if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating test data directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_test_data_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating Test data folders&quot;</span><span class="p">)</span>

            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">[</span><span class="s2">&quot;vm_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">[</span><span class="s2">&quot;vm_user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">user_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">[</span><span class="s2">&quot;vm_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">password</span>
            <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span>
                                                                      <span class="s2">&quot;TestData&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;COPYDATA&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">[</span><span class="s2">&quot;extra_args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_test_data_path</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">_dest_base_path</span>
            <span class="n">_ps_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">utils_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_operation_ps_file</span><span class="p">)</span>
            <span class="n">controller_machine</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="n">_stdout</span> <span class="o">=</span> <span class="n">controller_machine</span><span class="o">.</span><span class="n">_execute_script</span><span class="p">(</span><span class="n">_ps_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Error&quot;</span> <span class="ow">in</span> <span class="n">_stdout</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_failed_file_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to copy x =some files </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                <span class="n">_failed_file_list</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="VmwareHelper.get_disk_in_the_path"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.VmwareHelper.get_disk_in_the_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_disk_in_the_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Get all the disks in the folder</span>

<span class="sd">        Args:</span>
<span class="sd">            folder_path         (str):  path of the folder from which disk needs to be listed</span>
<span class="sd">                                        e.g: C:\\CVAutomation</span>

<span class="sd">        Returns:</span>
<span class="sd">            disk_list           (list): list of disks in the folder</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the list of files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">disk_name</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">disk_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span><span class="p">):</span>
                    <span class="n">_disk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_disk_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception occurred </span><span class="si">{0}</span><span class="s2"> in getting disk list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="AzureHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper">[docs]</a><span class="k">class</span> <span class="nc">AzureHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for performing all operations on AzureRM Hypervisor</span>

<span class="sd">        Methods:</span>
<span class="sd">                get_access_token()		                 - Get access token for any first authorization</span>

<span class="sd">                check_for_access_token_expiration()    - this function check if access_token is</span>
<span class="sd">                                                          expired if yes it will generate one</span>

<span class="sd">                copy_test_data_to_each_volume          - copy testdata to each volume in the vm</span>

<span class="sd">                update_hosts                           - Update the VM data Information</span>

<span class="sd">                collect_all_vm_data                    - Collect all VM Data</span>

<span class="sd">                collect_all_resource_group_data        - Collect All RG Info</span>

<span class="sd">                get_all_resource_group                 - get resource group info</span>

<span class="sd">                get_resourcegroup_name                 - gets the resource group of that VM</span>

<span class="sd">                get_resourcegroup_for_region           - get the Resource group for that particular</span>
<span class="sd">                                                         region</span>

<span class="sd">                compute_free_resources                 - compute all free resources required</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Hyper-V Helper class properties</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AzureHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                          <span class="n">host_machine</span><span class="p">,</span>
                                          <span class="n">user_name</span><span class="p">,</span>
                                          <span class="n">password</span><span class="p">,</span>
                                          <span class="n">instance_type</span><span class="p">,</span>
                                          <span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_extension</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.vhd&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">=</span> <span class="s1">&#39;https://login.microsoftonline.com/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.core.windows.net/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">=</span> <span class="s1">&#39;https://management.azure.com&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">=</span> <span class="s2">&quot;api-version=&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscriptionID</span> <span class="o">=</span> <span class="s1">&#39;d60bca80-e1a3-4117-aea3-09775a99d8cc&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appID</span> <span class="o">=</span> <span class="s1">&#39;839b32ef-dc74-4971-9add-a98d51308e71&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenantID</span> <span class="o">=</span> <span class="s1">&#39;da72dd62-58c6-4062-abf9-47be4e73c0f6&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span> <span class="o">=</span> <span class="s1">&#39;builder!12&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide the default headers required</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        provide info about all VM&#39;s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span>

    <span class="nd">@all_vmdata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all_vmdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the VM related info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_vmdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_rgdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        collects all resource group data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span>

    <span class="nd">@all_rgdata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">all_rgdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the resource group data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_rgdata</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="AzureHelper.get_access_token"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_access_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get access token for any first authorization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging into Azure to get access token&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">adal</span>
            <span class="n">Context</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">AuthenticationContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authentication_endpoint</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenantID</span><span class="p">)</span>
            <span class="n">Token_response</span> <span class="o">=</span> <span class="n">Context</span><span class="o">.</span><span class="n">acquire_token_with_client_credentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">azure_resourceURL</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">appID</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">app_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">Token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;accessToken&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Access Token is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.check_for_access_token_expiration"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.check_for_access_token_expiration">[docs]</a>    <span class="k">def</span> <span class="nf">check_for_access_token_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this function check if access_token is expired if yes it will generate one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking access token </span><span class="si">%s</span><span class="s2"> supplied is  valid&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">)</span>
            <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">((</span><span class="ow">not</span> <span class="n">is_sessionok</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)):</span>
                <span class="n">azure_list_subscriptionsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions?&quot;</span> \
                                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-05-10&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of subscriptions usign post </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="n">azure_list_subscriptionsURL</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_list_subscriptionsURL</span><span class="p">,</span>
                                              <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ExpiredAuthenticationToken&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The session is unauthorized, trying to get new token&quot;</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The session is not expired , so there are credential issue&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The Session is success no need to create new access token&quot;</span><span class="p">)</span>
                    <span class="n">is_sessionok</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;There was error even after getting new token&quot;</span><span class="p">)</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.copy_test_data_to_each_volume"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.copy_test_data_to_each_volume">[docs]</a>    <span class="k">def</span> <span class="nf">copy_test_data_to_each_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="n">_test_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy testdata to each volume in the vm provided</span>


<span class="sd">        Args:</span>
<span class="sd">                vm_name    (str)        - vm to which test data has to be copied</span>

<span class="sd">                _test_data_path(str) - path where testdata needs to be generated</span>

<span class="sd">                backup_folder(str)  - name of the folder to be backed up</span>

<span class="sd">        Exception:</span>

<span class="sd">                if fails to generate testdata</span>

<span class="sd">                if fails to copy testdata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating test data directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_test_data_path</span><span class="p">)</span>


            <span class="c1"># initializing prerequisites</span>
            <span class="n">_failed_file_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># create Base dir</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_drive</span><span class="p">,</span> <span class="n">backup_folder</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">):</span>
                <span class="n">_create_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_create_dir</span><span class="p">:</span>
                    <span class="n">_failed_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying testdata to volume </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">is_local_machine</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">_test_data_path</span><span class="p">,</span>
                                                          <span class="n">_dest_base_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">_dest_base_path</span><span class="p">)</span>
                    <span class="n">network_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vm_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy_folder_to_network_share</span><span class="p">(</span>
                        <span class="n">_test_data_path</span><span class="p">,</span> <span class="n">network_path</span><span class="p">,</span>
                        <span class="n">vm_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span>
                            <span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span>
                            <span class="n">vm_name</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  Copying test data to Vm  &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.update_hosts"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the VM data Information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_vm_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collect_all_resource_group_data</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in updating Host&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.collect_all_vm_data"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.collect_all_vm_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_all_vm_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect all VM Data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_allrg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_resource_group</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">each_rg</span> <span class="ow">in</span> <span class="n">_allrg</span><span class="p">:</span>
                <span class="n">azure_list_vmURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                                   <span class="bp">self</span><span class="o">.</span><span class="n">subscriptionID</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> \
                                   <span class="o">+</span> <span class="n">each_rg</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Compute/virtualMachines?&quot;</span> \
                                   <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2016-04-30-preview&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of VMs usign post </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">azure_list_vmURL</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">azure_list_vmURL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">)</span>
                <span class="n">_all_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">each_rg</span><span class="p">,</span> <span class="n">_all_data</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in collect_all_vmdata&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.collect_all_resource_group_data"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.collect_all_resource_group_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_all_resource_group_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect All RG Info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AzureResourceGroupURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptionID</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups?&quot;</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2014-04-01&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of VMs usign post </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">AzureResourceGroupURL</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">AzureResourceGroupURL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in CollectAllResourceGroupData&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_all_resource_group"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_all_resource_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_resource_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get All RG Info</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_allrg_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span>
            <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">datadict</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                <span class="n">rg_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">_allrg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_allrg_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in collect_all_resource_group_data&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get__all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get__all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get__all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        this gets all teh VM in the Subscriptions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_all_vmlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
            <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">eachvalue</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">eachvalue</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                        <span class="n">vm_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">_all_vmlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_all_vmlist</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Access token&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_resourcegroup_name"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_resourcegroup_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_resourcegroup_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Resource group of that VM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">resource_group_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
            <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">each_value</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Value in get_resource_group_name is &quot;</span> <span class="o">%</span> <span class="n">each_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">each_value</span><span class="p">:</span>
                    <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">each_value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                            <span class="n">_vm_name</span> <span class="o">=</span> <span class="n">each_key</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VMname </span><span class="si">%s</span><span class="s2"> in resource group </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_vm_name</span><span class="p">,</span> <span class="n">each_key</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">_vm_name</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">:</span>
                                <span class="n">vm_id</span> <span class="o">=</span> <span class="n">each_key</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                                <span class="n">temp_str</span> <span class="o">=</span> <span class="n">vm_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">resource_group_name</span> <span class="o">=</span> <span class="n">temp_str</span><span class="p">[</span><span class="n">temp_str</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;resourceGroups&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                                <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot collect information for this VM&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resource_group_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting the Resource group&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.get_resourcegroup_for_region"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.get_resourcegroup_for_region">[docs]</a>    <span class="k">def</span> <span class="nf">get_resourcegroup_for_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the Resource group for region</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_group</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rg_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_rgdata</span>
            <span class="k">for</span> <span class="n">eachRG</span> <span class="ow">in</span> <span class="n">rg_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                <span class="n">rg_region</span> <span class="o">=</span> <span class="n">eachRG</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rg_region</span> <span class="o">==</span> <span class="n">region</span><span class="p">:</span>
                    <span class="n">resource_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eachRG</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">resource_group</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in get_resourcegroup_for_region&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AzureHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.AzureHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">resource_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute all the free resources</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sa_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">resource_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">datadict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vmdata</span>
                <span class="k">for</span> <span class="n">eachdata</span><span class="p">,</span> <span class="n">eachvalue</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">vm_info_value</span> <span class="o">=</span> <span class="n">eachvalue</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_info_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">eachkey</span> <span class="ow">in</span> <span class="n">vm_info_value</span><span class="p">:</span>
                            <span class="n">_vm_name</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Check vm </span><span class="si">%s</span><span class="s2"> in resourcegroup </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eachkey</span><span class="p">,</span> <span class="n">_vm_name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">_vm_name</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">region</span> <span class="o">=</span> <span class="n">eachkey</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>
                                <span class="k">break</span>

                <span class="n">resource_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resourcegroup_for_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_rg</span> <span class="ow">in</span> <span class="n">resource_group</span><span class="p">:</span>
                <span class="n">storage_account_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_baseURL</span> <span class="o">+</span> <span class="s2">&quot;/subscriptions/&quot;</span> <span class="o">+</span> \
                                      <span class="bp">self</span><span class="o">.</span><span class="n">subscriptionID</span> <span class="o">+</span> <span class="s2">&quot;/resourceGroups/&quot;</span> <span class="o">+</span> \
                                      <span class="n">each_rg</span> <span class="o">+</span> <span class="s2">&quot;/providers/Microsoft.Storage/storageAccounts?&quot;</span> \
                                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_apiversion</span> <span class="o">+</span> <span class="s2">&quot;2017-06-01&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to get list of VMs usign post </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">storage_account_url</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">azure_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">storage_account_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">storage_account_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">sa_value</span> <span class="o">=</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sa_value</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">each_sa</span> <span class="ow">in</span> <span class="n">storage_account_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                            <span class="n">sa_name</span> <span class="o">=</span> <span class="n">each_sa</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                            <span class="n">resource_group</span> <span class="o">=</span> <span class="n">each_rg</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get SA details for this Resource Group&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">resource_group</span><span class="p">,</span> <span class="n">sa_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in ComputeFreeResources&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="FusionComputeHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper">[docs]</a><span class="k">class</span> <span class="nc">FusionComputeHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Fusion Compute Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FusionComputeHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="n">FusionComputeServices</span><span class="o">.</span><span class="n">get_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json;charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json; charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en_US&#39;</span><span class="p">,</span>
            <span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span> <span class="o">=</span> <span class="n">FusionComputeServices</span><span class="o">.</span><span class="n">get_vm_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_get_site_url</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

<div class="viewcode-block" id="FusionComputeHelper.get_version"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.get_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Fusion Compute Hypervisor Version Provided</span>
<span class="sd">        :return:</span>
<span class="sd">            version    (str)    : version of the Fusion COmpute Hypervisor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_VERSION&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">latest_version</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json;version=</span><span class="si">{0}</span><span class="s1">;charset=UTF-8&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">latest_version</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">latest_version</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>

            <span class="k">raise</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred &quot;</span> \
                               <span class="s2">&quot;getting version from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compute_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does login to the Fusion compute Hypervisor</span>
<span class="sd">        :return:</span>
<span class="sd">            set the token in headers</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_object</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-AuthType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-UserType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;x-auth-token&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-User&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-Key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-AuthType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;X-Auth-UserType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the VRM&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (str)         --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (str)         --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / str)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) - in case of success</span>

<span class="sd">                (False, response) - in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            Fusion Compute SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                         <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                        <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Raise max attempts exception, if attempts exceeds 3</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_site_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the site urn for the Fusion VRM</span>
<span class="sd">        :return:</span>
<span class="sd">            site_url (str)  - site url for querying about VMs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;GET_SITES&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">site_url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;sites&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">site_url</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting version from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="FusionComputeHelper.update_hosts"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the Information of Host</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>

                <span class="k">return</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>


<div class="viewcode-block" id="FusionComputeHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Get all the vms for Fusion Compute</span>

<span class="sd">       Args:</span>
<span class="sd">            server (str)   -  VRM  for which all the VMs has to be fetched</span>

<span class="sd">       Returns:</span>
<span class="sd">           _all_vm_list    (str)   -   List of VMs in the host of the pseudoclient</span>
<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">while</span> <span class="n">stop</span><span class="p">:</span>
                <span class="n">_vm_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_vm_service</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vm_list_response</span><span class="p">:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">100</span>
                        <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
                            <span class="n">_temp_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_vm_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_name (str)   - name of the VM for which we want to find host</span>
<span class="sd">        return:</span>
<span class="sd">            Host of teh VM where it resides</span>
<span class="sd">            None: if it is not in Fusion Compute</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
        <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
        <span class="n">_host_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_list</span><span class="p">:</span>
                <span class="n">_vm_host_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_VMS_HOSTS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_host_dict</span><span class="p">[</span><span class="n">each_host</span><span class="p">][</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_vm_host_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">vm_host_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;vms&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">vm_host</span> <span class="ow">in</span> <span class="n">vm_host_list_response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">vm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">vm_host</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">host</span> <span class="o">=</span> <span class="n">each_host</span>
                            <span class="k">break</span>

        <span class="k">return</span> <span class="n">host</span>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of datastore in an Host in VRM</span>

<span class="sd">        Args:</span>
<span class="sd">            host_name   (str)   - Name of the host for which datastore has to be fecthed</span>

<span class="sd">        Return:</span>
<span class="sd">                _disk_size_dict	(dict)	- Datastores with name name free spaces</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_disk_size_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">host_name</span><span class="p">:</span>
                <span class="n">_host_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">host_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_host_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_list</span><span class="p">:</span>
                <span class="n">_datastore_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_DATASTORES_HOSTS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_host_dict</span><span class="p">[</span><span class="n">each_host</span><span class="p">][</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">_datastore_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">disk_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;datastores&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">disk</span> <span class="ow">in</span> <span class="n">disk_list_response</span><span class="p">:</span>
                        <span class="n">_disk_size_dict</span><span class="p">[</span><span class="n">disk</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">disk</span><span class="p">[</span><span class="s1">&#39;actualFreeSizeGB&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">_disk_size_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastores  from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_host_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of hosts  in VRM</span>

<span class="sd">        Args:</span>

<span class="sd">        Return:</span>
<span class="sd">                _host_dict	(dict)	- host with name and freememory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_HOSTS&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">_host_dict_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;hosts&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">_host_dict_response</span><span class="p">:</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;memQuantityMB&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1024</span>
                    <span class="n">_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]][</span><span class="s1">&#39;urn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;urn&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">_host_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting hosts  from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_datastore_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted datastore Dict according to free space</span>
<span class="sd">        Args:</span>
<span class="sd">            host_name   (str)   - Host Name for which datastore has to be fetched</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_datastore_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to free space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                                 <span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                  <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastore priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_host_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted host Dict according to Memory</span>
<span class="sd">        Args:</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_host_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to Memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_dict</span><span class="p">()</span>
            <span class="n">_host_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                  <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;Memory&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">_host_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

            <span class="n">_sorted_host_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                            <span class="p">(</span><span class="n">_host_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                             <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_host_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting host priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the required resource for restore</span>
<span class="sd">        :param vm_list:  list of Vms for restore</span>
<span class="sd">        :return:</span>
<span class="sd">            _vm_total_memory    (int)   -   Total memory required for restoring</span>
<span class="sd">            _vm_total_space (int)   -   Total disk space required for restoring</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">Memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;VMSpace&#39;</span><span class="p">)</span>
                <span class="n">_vm_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">VMSpace</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_space</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Aerror occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="FusionComputeHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.FusionComputeHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">,</span> <span class="n">proxy_client</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>

<span class="sd">                vm_list		(list) - list of Vms to be restored</span>

<span class="sd">        return:</span>
<span class="sd">                Datastore	(str)	- the Datastore where restore can be performed</span>

<span class="sd">                Host            (str)	- Host where restore has to be performed</span>

<span class="sd">                proxy_client    (str)   - Proxy machine used for restore</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">datastore_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="n">proxy_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vm_host</span><span class="p">(</span><span class="n">proxy_client</span><span class="p">)</span>

            <span class="n">_host_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_host_priority_list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">each_host</span> <span class="ow">in</span> <span class="n">_host_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_host</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_vm_memory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;the Host </span><span class="si">%s</span><span class="s2"> has higher &quot;</span>
                        <span class="s2">&quot;memory than the total VMs&quot;</span> <span class="o">%</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">proxy_host</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We cannot have same as destination client host as there is known limitation &quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">host_name</span> <span class="o">=</span> <span class="n">each_host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">_datastore_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_priority_list</span><span class="p">(</span><span class="n">host_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_datastore</span> <span class="ow">in</span> <span class="n">_datastore_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">each_datastore</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">datastore_name</span> <span class="o">=</span> <span class="n">each_datastore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span>
                                  <span class="s2">&quot;The Datastore </span><span class="si">%s</span><span class="s2"> has more than total&quot;</span>
                                  <span class="s2">&quot;disk space in VM&quot;</span> <span class="o">%</span> <span class="n">datastore_name</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">return</span> <span class="n">datastore_name</span><span class="p">,</span> <span class="n">host_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  compute_free_resources &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>

<div class="viewcode-block" id="OracleVMHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper">[docs]</a><span class="k">class</span> <span class="nc">OracleVMHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on OracleVM Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OracleVMHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span>
                                           <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_host_name</span> <span class="o">=</span> <span class="n">server_host_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_host_name</span><span class="o">+</span><span class="s1">&#39;:7002/ovm/core/wsapi/rest&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (str)         --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (str)         --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / str)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) - in case of success</span>

<span class="sd">                (False, response) - in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            OracleVM SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_REST_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_REST_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot; clear the expired cookies so that requests module will use the username and password for next </span>
<span class="sd">                request and update the session with new cookies&quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">attempts</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_required_resource_for_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the required resource for restore</span>
<span class="sd">        Args:</span>
<span class="sd">            vm_list: list of Vms for restore</span>

<span class="sd">        Returns:</span>
<span class="sd">            _vm_total_memory    (int)   -   Total memory required for restoring</span>
<span class="sd">            _vm_total_space (int)   -   Total disk space required for restoring</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;Memory&#39;</span><span class="p">)</span>
                <span class="n">_vm_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">Memory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;VMSpace&#39;</span><span class="p">)</span>
                <span class="n">_vm_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">VMSpace</span>
                <span class="n">_vm_total_memory</span> <span class="o">=</span> <span class="n">_vm_total_memory</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_memory</span><span class="p">)</span>
                <span class="n">_vm_total_space</span> <span class="o">=</span> <span class="n">_vm_total_space</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_vm_space</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_vm_total_memory</span><span class="p">,</span> <span class="n">_vm_total_space</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occurred in  _get_required_memory_for_restore &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_verify_manager_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager_json</span><span class="p">,</span> <span class="n">retryCount</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safety check to verify if the Oracle VM manager is in running state.</span>
<span class="sd">        Args:</span>
<span class="sd">            manager_json: Response of the vm manager</span>
<span class="sd">            retryCount: number of times the verification should happen if</span>
<span class="sd">                        the vm manager is in starting state</span>

<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM Manager is running. Session successfully created&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARTING&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM Manager is in &quot;</span> <span class="o">+</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; state re-checking after one minute&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retryCount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">new_manager_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s2">&quot;/Manager&quot;</span><span class="p">)</span>
                <span class="n">retryCount</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_manager_state</span><span class="p">(</span><span class="n">new_manager_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">retryCount</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Retry limit reached. VM Manager status is &quot;</span> <span class="o">+</span> <span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> invalid running state of VM manager&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager_json</span><span class="p">[</span><span class="s2">&quot;managerRunState&quot;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceNew</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">forceNew</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">})</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s2">&quot;/Manager&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">200</span><span class="p">:</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Oracle VM manager is not responding&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_manager_state</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="OracleVMHelper.get_cluster_repositories"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_cluster_repositories">[docs]</a>    <span class="k">def</span> <span class="nf">get_cluster_repositories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Total available repositories available under the cluster</span>
<span class="sd">        :return: list of the repositories for the cluster</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/Repository&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_repos</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while retriving server list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_server_repositories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Available repos that are under a server</span>
<span class="sd">        Args:</span>
<span class="sd">            server: Server for which the repos needs to be listed</span>

<span class="sd">        Returns: list of repository dicts for a server</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_server_repositories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">available_repos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_repositories</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_repo</span> <span class="ow">in</span> <span class="n">available_repos</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_repo</span><span class="p">[</span><span class="s2">&quot;presentedServerIds&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_presentedServer</span> <span class="ow">in</span> <span class="n">_repo</span><span class="p">[</span><span class="s2">&quot;presentedServerIds&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">_presentedServer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                            <span class="n">_server_repositories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_server_repositories</span> <span class="o">=</span> <span class="n">available_repos</span>
        <span class="k">return</span> <span class="n">_server_repositories</span>

<div class="viewcode-block" id="OracleVMHelper.get_servers"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_servers">[docs]</a>    <span class="k">def</span> <span class="nf">get_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a required server or total servers available</span>
<span class="sd">        Args:</span>
<span class="sd">            server: name of the server when passed returns only it&#39;s dict</span>

<span class="sd">        Returns: (list)        dict of server(s)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/Server&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_server</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">_server</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">server</span><span class="p">:</span>
                            <span class="n">server_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_server</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">server_list</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">server_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while retriving server list&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the vm&#39;s that are available under a requested server</span>
<span class="sd">        Args:</span>
<span class="sd">            server: (basestring)    server on which the VMs should be listed</span>

<span class="sd">        Returns:    (list)          list of the vms on a given server</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_vm_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_available_servers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_servers</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">_available_servers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_available_servers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">server_dict</span> <span class="ow">in</span> <span class="n">_available_servers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">_vm_name</span> <span class="ow">in</span> <span class="n">server_dict</span><span class="p">[</span><span class="s2">&quot;vmIds&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;uri&quot;</span><span class="p">]</span>
                    <span class="n">_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_vm_name</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_vm_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting vm&#39;s in hypervisor&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.update_hosts"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.update_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">update_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating hosts of OracleVM hypervisor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_fileSystem_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileSystemId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the response of the given fileSystemId</span>
<span class="sd">        Args:</span>
<span class="sd">            fileSystemId: (basestring)      UniqueID of the file system</span>

<span class="sd">        Returns:    Response JSON of the file system requested</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_file_system_details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseUri</span> <span class="o">+</span> <span class="s1">&#39;/FileSystem/&#39;</span><span class="o">+</span><span class="n">fileSystemId</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">_file_system_details</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_file_system_details</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while obtaining file system details&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_datastore_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the dict of the datastores available on a given datastore</span>
<span class="sd">        Args:</span>
<span class="sd">            server: (basestring)      Server for which the datastores are needed</span>

<span class="sd">        Returns:    Response JSON of the datastores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_server_repos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_server_repositories</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_server_repo</span> <span class="ow">in</span> <span class="n">_server_repos</span><span class="p">:</span>
                <span class="n">_file_system_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fileSystem_details</span><span class="p">(</span><span class="n">fileSystemId</span><span class="o">=</span><span class="n">_server_repo</span><span class="p">[</span><span class="s2">&quot;fileSystemId&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="n">_datastore_dict</span><span class="p">[</span><span class="n">_server_repo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">bytesto</span><span class="p">(</span><span class="n">_file_system_info</span><span class="p">[</span><span class="s2">&quot;freeSize&quot;</span><span class="p">],</span> <span class="s2">&quot;GB&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_datastore_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastores information&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_repository_priority_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the descending sorted datastore Dict according to free space</span>
<span class="sd">        Args:</span>

<span class="sd">        returns:</span>
<span class="sd">                _sorted_datastore_dict  (dict)  -   Returns the descending</span>
<span class="sd">                sorted datastore dict according to free space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_datastore_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()</span>
            <span class="n">_sorted_datastore_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span>
                                                 <span class="p">(</span><span class="n">_datastore_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                  <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_sorted_datastore_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting datastore priority list from VRM&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<div class="viewcode-block" id="OracleVMHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free hosting hypervisor and free space for disk in hypervisor</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_list  - list of servers from which best has to be chosen</span>

<span class="sd">            vm_list     - list of Vm to be restored</span>

<span class="sd">        Return:</span>
<span class="sd">                host         (str)    - hypervisor host where vm is to be restored</span>
<span class="sd">                                            like esx, resourcegroup,region,hyperv host</span>

<span class="sd">                datastore    (str)    - diskspace where vm needs to be restored</span>
<span class="sd">                                            like destinationpath,datastore,bucket</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repository</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
            <span class="n">_repository_priority_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_repository_priority_list</span><span class="p">()</span>
            <span class="n">_total_vm_memory</span><span class="p">,</span> <span class="n">_total_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_resource_for_restore</span><span class="p">(</span><span class="n">vm_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_repo</span> <span class="ow">in</span> <span class="n">_repository_priority_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_total_disk_space</span><span class="p">:</span>
                    <span class="n">repository</span> <span class="o">=</span> <span class="n">_repo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>

            <span class="k">return</span> <span class="n">host_name</span><span class="p">,</span> <span class="n">repository</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="OracleVMHelper.close_session"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleVMHelper.close_session">[docs]</a>    <span class="k">def</span> <span class="nf">close_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the VM Manager session</span>
<span class="sd">        Returns: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;session closed&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OracleCloudHelper"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper">[docs]</a><span class="k">class</span> <span class="nc">OracleCloudHelper</span><span class="p">(</span><span class="n">Hypervisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all operations on Oracle Cloud Classic Hypervisor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host_name</span><span class="p">,</span>
                 <span class="n">host_machine</span><span class="p">,</span>
                 <span class="n">user_name</span><span class="p">,</span>
                 <span class="n">password</span><span class="p">,</span>
                 <span class="n">instance_type</span><span class="p">,</span>
                 <span class="n">commcell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Oracle Cloud Hypervisor Helper Options</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host_name    (basestring)    --  the hostname of the oracle cloud server</span>

<span class="sd">            host_machine        (basestring)    --  the hostname of the client where the scripts</span>
<span class="sd">                                                    will be executed</span>

<span class="sd">            user_name           (basestring)    --  the user name of the client</span>

<span class="sd">            password            (basestring)    --  the password of the client</span>

<span class="sd">            instance_type       (basestring)    --  the type of instance</span>

<span class="sd">            commcell            (object)        --  the commcell object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OracleCloudHelper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span>
                                                <span class="n">host_machine</span><span class="p">,</span>
                                                <span class="n">user_name</span><span class="p">,</span>
                                                <span class="n">password</span><span class="p">,</span>
                                                <span class="n">instance_type</span><span class="p">,</span>
                                                <span class="n">commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;Compute&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="s2">&quot;Compute-</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_services</span> <span class="o">=</span> <span class="n">OracleCloudServices</span><span class="o">.</span><span class="n">get_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/oracle-compute-v3+json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/oracle-compute-v3+json&#39;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span> <span class="o">=</span> <span class="n">OracleCloudServices</span><span class="o">.</span><span class="n">get_vm_services</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does login to the Oracle Cloud Hypervisor</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if login to the Oracle Cloud end point fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">}</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_services</span><span class="p">[</span><span class="s1">&#39;LOGIN&#39;</span><span class="p">],</span> <span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while logging in to the end point&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the request of the type specified in the argument &#39;method&#39;</span>

<span class="sd">        Args:</span>
<span class="sd">            method    (basestring)  --  http operation to perform, e.g.; GET, POST, PUT, DELETE</span>

<span class="sd">            url       (basestring)  --  the web url or service to run the HTTP request on</span>

<span class="sd">            payload   (dict / basestring)  --  data to be passed along with the request</span>
<span class="sd">                default: None</span>

<span class="sd">            attempts  (int)         --  number of attempts made with the same request</span>
<span class="sd">                default: 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                (True, response) -- in case of success</span>

<span class="sd">                (False, response) -- in case of failure</span>

<span class="sd">        Raises:</span>
<span class="sd">            Oracle Cloud SDK Exception:</span>
<span class="sd">                if the method passed is incorrect/not supported</span>

<span class="sd">            requests Connection Error   --  requests.exceptions.ConnectionError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

            <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/oracle-compute-v3+directory+json&#39;</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;HTTP method </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">attempts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Raise max attempts exception, if attempts exceeds 3</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;103&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>

            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">]</span><span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">response</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">con_err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">con_err</span><span class="p">)</span>

<div class="viewcode-block" id="OracleCloudHelper.get_all_vms_in_hypervisor"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper.get_all_vms_in_hypervisor">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_in_hypervisor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the vms for Oracle Cloud</span>

<span class="sd">        Args:</span>
<span class="sd">            server (basestring)   --  User for which all the VMs has to be fetched</span>

<span class="sd">        Returns:</span>
<span class="sd">           _all_vm_list    (list)   --   List of VMs in the host of the pseudoclient</span>

<span class="sd">        Raises:</span>
<span class="sd">              Exception:</span>
<span class="sd">                    if there is an exception in getting all the VMs in the user</span>

<span class="sd">       &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Cookie&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_login</span><span class="p">()</span>
            <span class="n">_temp_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_INSTANCES&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">server</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">vm_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span> <span class="o">=</span> <span class="n">vm_list_response</span>
                <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">vm_list_response</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_dict</span><span class="p">[</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="n">_temp_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="n">_temp_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">each_vm</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">each_vm</span> <span class="o">=</span> <span class="n">each_vm</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[A-Za-z0-9_-]*$&quot;</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_vm</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Unicode VM are not supported for now&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">vm_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting VMs from Oracle Cloud&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_user_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of users in the Identity Domain of Oracle Cloud</span>

<span class="sd">        Returns:</span>
<span class="sd">            _compute_users_list	(list)	-- List of all users in the identity domain</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the list of all users in the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_compute_users_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_INSTANCES&#39;</span><span class="p">],</span>
                                                <span class="n">directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">user_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_list_response</span><span class="p">:</span>
                    <span class="n">_compute_users_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_compute_users_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting users from the &quot;</span>
                               <span class="s2">&quot;identity domain&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_security_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the list of all security lists of Oracle Cloud</span>

<span class="sd">        Returns:</span>
<span class="sd">             _security_list  (list)  --  list of all security lists in Oracle Cloud</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an exception is getting all the security lists in the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_security_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">flag</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_services</span><span class="p">[</span><span class="s1">&#39;GET_SECLIST&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">security_list_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">security_list_response</span><span class="p">:</span>
                    <span class="n">_security_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_security_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred getting security lists. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_instance_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the user name of the instance in Oracle Cloud</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --   name of the instance whose username has</span>
<span class="sd">                                                to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">                instance_user_name	(basestring)    -- username to which the instance belongs</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the user name of an instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance_user_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
                    <span class="n">instance_user_name</span> <span class="o">=</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_identity_domain</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">instance_user_name</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred getting the user name of the instance&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_security_list_of_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the security list associated with the instance</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --   name of the instance whose security list</span>
<span class="sd">                                                    has to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">            security_lists  (list)  --  list of all security lists associated with the instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the security lists associated with the instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">security_lists</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;networking&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">security_lists</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;seclists&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">security_lists</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting the security list of the&quot;</span>
                               <span class="s2">&quot;instance. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ssh_keys_of_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ssh keys associated with the instance</span>

<span class="sd">        Args:</span>
<span class="sd">                instance_name (basestring)  --  name of the instance whose ssh keys has</span>
<span class="sd">                                                to be obtained</span>

<span class="sd">        Returns:</span>
<span class="sd">            ssh_keys  (list)  --  list of all ssh keys associated with the instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in getting the list of all ssh keys associated with instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh_keys</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances_json</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">instance_name</span> <span class="ow">and</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;sshkeys&#39;</span><span class="p">]:</span>
                    <span class="n">ssh_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vm_name</span><span class="p">[</span><span class="s1">&#39;sshkeys&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">ssh_keys</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred while getting the ssh keys of the&quot;</span>
                               <span class="s2">&quot;instance. </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

<div class="viewcode-block" id="OracleCloudHelper.compute_free_resources"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.HypervisorHelper.OracleCloudHelper.compute_free_resources">[docs]</a>    <span class="k">def</span> <span class="nf">compute_free_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_list</span><span class="p">,</span> <span class="n">vm_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the free Resource of the Vcenter based on free memory and cpu</span>

<span class="sd">        Args:</span>

<span class="sd">                proxy_list  (list)  --  list of all proxies</span>

<span class="sd">                vm_list		(list)  --  list of Vms to be restored</span>

<span class="sd">        Returns:</span>
<span class="sd">                security_list   (list)  --   the security lists to be attached to the instances</span>

<span class="sd">                host_name       (basestring)   --   the host where instances are to be restored</span>

<span class="sd">                ssh_keys        (basestring)  --   The ssh keys to be attached to the instances</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if there is an error in computing the resources of the endpoint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">security_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ssh_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">host_name</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">proxy_list</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vm_name</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                <span class="n">security_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_security_list_of_instance</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
                <span class="n">ssh_keys</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ssh_keys_of_instance</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">security_list</span><span class="p">,</span> <span class="n">host_name</span><span class="p">,</span> <span class="n">ssh_keys</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in computing free resources&quot;</span>
                               <span class="s2">&quot; for restore&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault Systems® Inc. All Rights Reserved.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>