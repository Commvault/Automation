
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>VirtualServer.VSAUtils.VirtualServerHelper &#8212; Commvault Automation 11.13 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for VirtualServer.VSAUtils.VirtualServerHelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main file that act as wrapper for testcase and SDK</span>

<span class="sd">classes defined:</span>
<span class="sd">    Auto_VSA_Commcell   - wrapper for commcell operations</span>
<span class="sd">    Auto_VSA_VSClient   - wrapper for VSA Client operations</span>
<span class="sd">    Auto_VSA_VSInstance - wrapper for VSA Instance operation</span>
<span class="sd">    Auto_VSA_Backupset  - wrapper for VSA Backupset Operations</span>
<span class="sd">    Auto_VSA_Subclient  - wrapper for VSA Subclient operations</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">.HypervisorHelper</span> <span class="k">import</span> <span class="n">Hypervisor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">VirtualServerConstants</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">VirtualServerUtils</span>
<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="k">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">cvhelper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.idautils</span> <span class="k">import</span> <span class="n">CommonUtils</span>


<div class="viewcode-block" id="AutoVSACommcell"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell">[docs]</a><span class="k">class</span> <span class="nc">AutoVSACommcell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class that act as wrapper for SDK and Testcase</span>

<span class="sd">    Methods:</span>
<span class="sd">            get_client_id()             - gets the client ID of given client name</span>

<span class="sd">            get_hostname_for_client()   - get the Host name for the given client</span>

<span class="sd">            get_base_dir()              - get the base directory of client given</span>
<span class="sd">                                        (default: Commserv client)</span>

<span class="sd">            get_client_os_type()           - get the os info of the client</span>

<span class="sd">            _check_backup_job_type_expected()   - check the passed job id type and</span>
<span class="sd">                                                    passed job type is expeted</span>

<span class="sd">            _client_exist_in_cs()       - check if the client exist in CS</span>

<span class="sd">            get_job_duration()          - get the job duration of the job passed</span>

<span class="sd">            get_job_results_dir()                   - get the job results directory of the client</span>
<span class="sd">                                        (default: commserv client)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">csdb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the  SDK objects</span>

<span class="sd">        Args:</span>
<span class="sd">            commcell    (obj)   - Commcell object of SDK Commcell class</span>

<span class="sd">            csdb        (obj)   - CS Database object from testcase</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commserv_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_dir</span><span class="p">()</span>

<div class="viewcode-block" id="AutoVSACommcell.get_client_id"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_client_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the client ID for the given client</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name     (str)   - Client name for whihc client Id</span>
<span class="sd">                                                                                need to be fetched</span>

<span class="sd">        Return:</span>
<span class="sd">                client_id   (int)       - Id of the client name given</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exists in CS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the client ID for </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_client_obj</span><span class="o">.</span><span class="n">client_id</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occured in getting the client ID </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_hostname_for_client"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_hostname_for_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_hostname_for_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Host name for the given HostName</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name     (str)   - Client name for which client Id</span>
<span class="sd">                                                                                need to be fetched</span>
<span class="sd">                                             default value is  commsev_name</span>

<span class="sd">        Return:</span>
<span class="sd">                host_name   (int)       - Hostname of the client name given</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exists in CS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting HostName for Client for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">client_name</span><span class="p">)</span>
            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Successfully got </span><span class="si">{0}</span><span class="s2"> client object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_client_obj</span><span class="o">.</span><span class="n">client_hostname</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occured in getting the client ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_instanceno_for_client"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_instanceno_for_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_instanceno_for_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the instance number for the given HostName</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name     (str)   - Client name for which client Id</span>
<span class="sd">                                                                                need to be fetched</span>
<span class="sd">                                             default value is  commsev_name</span>

<span class="sd">        Return:</span>
<span class="sd">                instance  (str)       - Instance number of the client name given</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exists in CS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting HostName for Client for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">client_name</span><span class="p">)</span>
            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Successfully got </span><span class="si">{0}</span><span class="s2"> client object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_client_obj</span><span class="o">.</span><span class="n">instance</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occured in getting the instance number </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_client_name_from_hostname"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_client_name_from_hostname">[docs]</a>    <span class="k">def</span> <span class="nf">get_client_name_from_hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Host name for the given HostName</span>

<span class="sd">        Args:</span>
<span class="sd">                host_name     (str)   - host name  for which client name</span>
<span class="sd">                                                                                need to be fetched</span>

<span class="sd">        Return:</span>
<span class="sd">                client_name   (int)       -client name of the client from the given hostname</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exists in CS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting client name for Client for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">host_name</span><span class="p">)</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select name from APP_Client where net_hostname = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">host_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occured in getting the client ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_base_dir"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_base_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_base_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the base directory for the commvault installation</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name     (str)   - Client name for which client Id</span>
<span class="sd">                                                                        need to be fetched</span>
<span class="sd">                                            default value is    (str)   commsev_name</span>

<span class="sd">        Return:</span>
<span class="sd">                base_dir    (int)       - installtion base dir of simpana in that client</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exists in CS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span>

            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Successfully got </span><span class="si">{0}</span><span class="s2"> client object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="n">_base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_client_obj</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span> <span class="s2">&quot;Base&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_base_dir</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error in getting the base directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_client_os_type"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_client_os_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_client_os_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the OS type [Windows / Unix] of the client</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name     (str)   - Client name for which os info</span>
<span class="sd">                                                                        need to be fetched</span>
<span class="sd">                                            default value is    commsev_name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span>

            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Successfully got </span><span class="si">{0}</span><span class="s2"> client object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_client_obj</span><span class="o">.</span><span class="n">os_info</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An error occured in getting the OS version of the client&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_check_backup_job_type_expected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if the Job Type is expected</span>

<span class="sd">        Args:</span>
<span class="sd">                job_id      (int)   - job id whohc needs to be checked</span>

<span class="sd">                job_type    (str)   - the jpb type which the job id provided</span>
<span class="sd">                                                                        dhoulf be verified with</span>

<span class="sd">        Exception:</span>
<span class="sd">                if the job type is not expected</span>

<span class="sd">                if the job does not exist</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_job_info</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="n">_job_type_from_cs</span> <span class="o">=</span> <span class="n">_job_info</span><span class="o">.</span><span class="n">backup_level</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_job_type_from_cs</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">==</span> <span class="p">(</span><span class="n">job_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ok.The job was </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">job_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job type was for the jobid </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> which is not expected&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">errrr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in CheckJobTypeIsExpected&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">errrr</span>

    <span class="k">def</span> <span class="nf">_client_exist_in_cs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check particular client exist in CS</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name (str)   - client which has to be chacked that it exist in CS</span>

<span class="sd">        Return:</span>
<span class="sd">                True - If exists</span>

<span class="sd">                False- if does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">has_client</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AutoVSACommcell.get_job_duration"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_job_duration">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the Duration of the particular Job</span>

<span class="sd">        Args:</span>
<span class="sd">                job_id (int)   -- job id for which duratiuon has to be fetched</span>

<span class="sd">        Exception:</span>
<span class="sd">                if job does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_job_info</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
            <span class="n">_job_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">_job_info</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">_job_info</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_job_duration</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">errrr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in GetJobDuration&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">errrr</span></div>

<div class="viewcode-block" id="AutoVSACommcell.get_job_results_dir"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.get_job_results_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_results_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Job Results Directory</span>

<span class="sd">        Args:</span>
<span class="sd">                client_name (str)   -- client name for which simapana isntalled</span>
<span class="sd">                                            Job results directory has to be fetched</span>
<span class="sd">                                default value is     - commserv_name</span>

<span class="sd">        Exception:</span>
<span class="sd">                if client does not exist in cs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commserv_name</span>

            <span class="n">_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Successfully got </span><span class="si">{0}</span><span class="s2"> client object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_client_obj</span><span class="o">.</span><span class="n">job_results_directory</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to compute Job results Directory&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.find_primary_copy_id"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.find_primary_copy_id">[docs]</a>    <span class="k">def</span> <span class="nf">find_primary_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find the primary copy id of the specified storage policy</span>

<span class="sd">        Args:</span>
<span class="sd">                sp_id   (int)   : storage policy id</span>

<span class="sd">        Return:</span>
<span class="sd">                primary copy id of that storage policy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select copy from archgroup AG,archGroupCopy AGC where AGC.type = 1 and </span><span class="se">\</span>
<span class="s2">            AGC.isSnapCopy = 0 and  ag.id = AGC.archGroupId and AGC.archGroupId = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">sp_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception occurred getting Sp details details&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in find_primary_copy_id &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.execute"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the query passed and return the first row of value</span>
<span class="sd">        :param query: Query to be executed against CSDB</span>
<span class="sd">        :return:</span>
<span class="sd">            value : first row of query executed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> occurred in executing the query </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_results</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Aerror occurred in executing the db statements &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.find_snap_copy_id"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.find_snap_copy_id">[docs]</a>    <span class="k">def</span> <span class="nf">find_snap_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find the snap copy id of the specified storage policy</span>

<span class="sd">        Args:</span>
<span class="sd">                sp_id   (int)   : storage policy id</span>

<span class="sd">        Return:</span>
<span class="sd">                snap copy id of that storage policy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select copy from archgroup AG,archGroupCopy AGC where AGC.isSnapCopy = 1 and </span><span class="se">\</span>
<span class="s2">                                    ag.id = AGC.archGroupId and AGC.archGroupId = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">sp_id</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoVSACommcell.find_aux_copy_id"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.find_aux_copy_id">[docs]</a>    <span class="k">def</span> <span class="nf">find_aux_copy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find the aux copy id of the specified storage policy</span>

<span class="sd">        Args:</span>
<span class="sd">                sp_id   (int)   : storage policy id</span>

<span class="sd">        Return:</span>
<span class="sd">                aux copy id of that storage policy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select copy from archgroup AG,archGroupCopy AGC where </span><span class="se">\</span>
<span class="s2">                            ag.id = AGC.archGroupId and AGC.archGroupId = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">sp_id</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoVSACommcell.find_app_aware_jobs"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.find_app_aware_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">find_app_aware_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_backup_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the workflow Job and IDA backup job id provided the VSA backup job</span>
<span class="sd">        :param vsa_backup_job:  VSA Backup Job ID</span>
<span class="sd">        :return:</span>
<span class="sd">            workflow_job : Work flow job ID for the VSA backup Job</span>
<span class="sd">            IDA_job      : IDA Job id for VSA backup job</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select childjobId  from jmVSAAppJobLink </span><span class="se">\</span>
<span class="s2">                            where Parentjobid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vsa_backup_job</span>
            <span class="n">ida_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>

            <span class="n">_query1</span> <span class="o">=</span> <span class="s2">&quot;select workFlowjobId  from jmVSAAppJobLink</span><span class="se">\</span>
<span class="s2">                            where Parentjobid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vsa_backup_job</span>
            <span class="n">workflow_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ida_job_id</span><span class="p">,</span> <span class="n">workflow_job</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An Error </span><span class="si">{0}</span><span class="s2"> occurred in find_aux_copy_id &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.check_cbt_status"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.check_cbt_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_cbt_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">,</span> <span class="n">subclient_obj</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check CBT status for the backed up VMs according to backup type</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_type    (string) - FULL/INCR/DIFF/SYNTH_FULL</span>
<span class="sd">                subclient_obj   (obj) - Subclient sdk object</span>
<span class="sd">                job_id         (int) - Job ID for which CBT status is needed</span>
<span class="sd">                                         else last jobID is used</span>
<span class="sd">        Raise Exception:</span>
<span class="sd">                If CBt status for given VM for given backup type is unexpected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="n">subclient_obj</span><span class="o">.</span><span class="n">find_latest_job</span><span class="p">(</span><span class="n">include_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_type</span> <span class="ow">is</span> <span class="s2">&quot;FULL&quot;</span><span class="p">:</span>
                <span class="n">cbt_status</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Enabled&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbt_status</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Used&#39;</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT attrVal from APP_VMProp where attrName = &#39;vmCBTStatus&#39; &quot;</span> \
                     <span class="s2">&quot; and jobId =</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="o">.</span><span class="n">_job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>

            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cbt_status</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;cbt_status for the VM is not </span><span class="si">{0}</span><span class="s2">, it is </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbt_status</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The CBT status for all the VMs is </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cbt_status</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while checking the CBT status on the recent backuped VMs:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.find_job_transport_mode"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.find_job_transport_mode">[docs]</a>    <span class="k">def</span> <span class="nf">find_job_transport_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_backup_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and return the Transport mode for the job</span>
<span class="sd">        Args:</span>
<span class="sd">            vsa_backup_job          (str):  Job id</span>

<span class="sd">        Returns:</span>
<span class="sd">            transport_mode          (str):  Transport mode of the job</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the transport mode for the backup job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot; select attrVal from APP_VMProp where attrName like &#39;vmTransportMode&#39; and &quot;</span> \
                     <span class="s2">&quot;jobid = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">vsa_backup_job</span>
            <span class="n">transport_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">transport_mode</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while getting transport mode for the job &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSACommcell.live_browse_get_ds_info"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSACommcell.live_browse_get_ds_info">[docs]</a>    <span class="k">def</span> <span class="nf">live_browse_get_ds_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsa_backup_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To get the list of DS currently mounted</span>

<span class="sd">        Args:</span>
<span class="sd">            vsa_backup_job          (str):  Job id</span>

<span class="sd">        Returns:</span>
<span class="sd">            ds_list                 (list): List of DS currently mounted</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the browse ds information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select MountDevice from SMVolume where SMVolumeId in &quot;</span> \
                    <span class="s2">&quot;(select SMVolumeId from SMSnapResource) and JobId=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vsa_backup_job</span>
            <span class="n">ds_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ds_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while getting transport mode for the job &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AutoVSAVSClient"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSClient">[docs]</a><span class="k">class</span> <span class="nc">AutoVSAVSClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for performing all VSClient operations</span>

<span class="sd">    Methods:</span>
<span class="sd">       enable_snap_on_client - Enable intellisnap on client</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell_obj</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize all the class properties of AutoVSAVSClient class</span>

<span class="sd">        Args:</span>
<span class="sd">            commcell_obj    (obj)   - object of AutovsaCommcell class of VS Helper</span>

<span class="sd">            client  (obj)   - object for Client Class in SDK</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span> <span class="o">=</span> <span class="n">commcell_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">commcell_obj</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client</span><span class="o">.</span><span class="n">client_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client</span><span class="o">.</span><span class="n">client_name</span>

<div class="viewcode-block" id="AutoVSAVSClient.enable_snap_on_client"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSClient.enable_snap_on_client">[docs]</a>    <span class="k">def</span> <span class="nf">enable_snap_on_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        enable intellisnap on agent level</span>

<span class="sd">        Exception:</span>
<span class="sd">                If failed to update the property</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client</span><span class="o">.</span><span class="n">enable_intelli_snap</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Success - enabled snap on client: [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_client_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed Enable Snap on client&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in EnableSnapOnClient:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span></div>

<div class="viewcode-block" id="AutoVSAVSClient.live_mount_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSClient.live_mount_validation">[docs]</a>    <span class="k">def</span> <span class="nf">live_mount_validation</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">vmpolicy</span><span class="p">,</span>
            <span class="n">hvobj</span><span class="p">,</span>
            <span class="n">live_mount_job</span><span class="p">,</span>
            <span class="n">source_vm_name</span><span class="p">,</span>
            <span class="n">mounted_network_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Live Mount the client for the specified vm policy name</span>

<span class="sd">            Args:</span>
<span class="sd">                vmpolicy                (obj)    --  SDK object to LiveMountPolicy class</span>

<span class="sd">                hvobj                   (obj)    --  HypervisorHelper object</span>

<span class="sd">                live_mount_job          (obj)    --  SDK object of Job class</span>

<span class="sd">                source_vm_name          (str)    --  source VM name for Live Mount</span>

<span class="sd">                mounted_network_name    (str)    --  optional network if provided</span>

<span class="sd">            Exception:</span>
<span class="sd">                if it fails to live mount the vm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># starting time to track expiration period</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">vms_in_hypervisor</span> <span class="o">=</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

            <span class="n">mounted_vm_name</span> <span class="o">=</span> <span class="n">vmpolicy</span><span class="o">.</span><span class="n">live_mounted_vm_name</span>

            <span class="c1"># check if vm is in vcenter</span>
            <span class="k">if</span> <span class="n">mounted_vm_name</span> <span class="ow">in</span> <span class="n">vms_in_hypervisor</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="s1">&#39; Live Mounted VM: &quot;</span><span class="si">{0}</span><span class="s1">&quot; found on vcenter: &quot;</span><span class="si">{1}</span><span class="s1">&quot;&#39;</span><span class="o">.</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">mounted_vm_name</span><span class="p">,</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Validations while vm is mounted. &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
                <span class="c1"># 1. check if specified network is being used (before expiry time)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="s2">&quot; Checking if specified network is being used &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
                <span class="c1"># creating VMHelper object for source and client vm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating VMHelper object for source and mounted VM.&quot;</span><span class="p">)</span>
                <span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">source_vm_name</span>  <span class="c1"># self.vsa_client_name</span>
                <span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">mounted_vm_name</span>

                <span class="n">source_machine_vmhelper</span> <span class="o">=</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">source_vm_name</span><span class="p">]</span>  <span class="c1"># self.vsa_client_name]</span>
                <span class="n">mounted_machine_vmhelper</span> <span class="o">=</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">mounted_vm_name</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating VMHelper object for source and live mounted VM.&quot;</span><span class="p">)</span>
                <span class="n">source_machine_vmhelper</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">)</span>
                <span class="n">mounted_machine_vmhelper</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">mounted_network_name</span><span class="p">:</span>
                    <span class="n">mounted_network_name</span> <span class="o">=</span> <span class="n">source_machine_vmhelper</span><span class="o">.</span><span class="n">NetworkName</span>

                <span class="k">if</span> <span class="n">mounted_network_name</span> <span class="o">!=</span> <span class="n">mounted_machine_vmhelper</span><span class="o">.</span><span class="n">NetworkName</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;Live Mounted VM &quot;</span><span class="si">{0}</span><span class="s1">&quot; NOT FOUND in the specified network &quot;</span><span class="si">{1}</span><span class="s1">&quot;.&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mounted_vm_name</span><span class="p">,</span> <span class="n">mounted_network_name</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>

                <span class="c1"># else found in specified network</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Success - Live Mounted VM &quot;</span><span class="si">{0}</span><span class="s1">&quot; found in the specified network: &quot;</span><span class="si">{1}</span><span class="s1">&quot;.&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mounted_vm_name</span><span class="p">,</span> <span class="n">mounted_network_name</span><span class="p">))</span>
                <span class="c1"># 2. validate test data in live mounted vm (before expiry time)</span>

                <span class="c1"># validating data in source vm and mounted vm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="s2">&quot; Validating test data between source VM and mounted VM. &quot;</span>
                                         <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Machine objects for live mounted VM.&quot;</span><span class="p">)</span>

                <span class="c1"># checking if test data has been successfully written on mounted vm</span>
                <span class="n">mounted_machine</span> <span class="o">=</span> <span class="n">mounted_machine_vmhelper</span><span class="o">.</span><span class="n">machine</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching testdata path in source machine.&quot;</span><span class="p">)</span>

                <span class="n">source_testdata_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">get_testdata_path</span><span class="p">(</span><span class="n">hvobj</span><span class="o">.</span><span class="n">machine</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting testdata validation.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_driveletter</span><span class="p">,</span> <span class="n">_drive</span> <span class="ow">in</span> <span class="n">mounted_machine_vmhelper</span><span class="o">.</span><span class="n">drive_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dest_testdata_path</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">get_folder_to_be_compared</span><span class="p">(</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;FULL&#39;</span><span class="p">,</span> <span class="n">_driveletter</span><span class="o">=</span><span class="n">_drive</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Validating test data in &quot;</span><span class="si">{0}</span><span class="s1">&quot; drive.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fs_testdata_validation</span><span class="p">(</span><span class="n">dest_client</span><span class="o">=</span><span class="n">mounted_machine</span><span class="p">,</span>
                                                <span class="n">source_location</span><span class="o">=</span><span class="n">source_testdata_path</span><span class="p">,</span>
                                                <span class="n">dest_location</span><span class="o">=</span><span class="n">dest_testdata_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Test data in &quot;</span><span class="si">{0}</span><span class="s1">&quot; drive has been validated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_drive</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test data validation completed successfully.&quot;</span><span class="p">)</span>

                <span class="c1"># 2.5 Make sure expiry time is over before proceeding to further validation</span>
                <span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vmpolicy</span><span class="o">.</span><span class="n">properties</span><span class="p">()[</span><span class="s1">&#39;daysRetainUntil&#39;</span><span class="p">])</span>
                <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vmpolicy</span><span class="o">.</span><span class="n">properties</span><span class="p">()[</span><span class="s1">&#39;minutesRetainUntil&#39;</span><span class="p">])</span>
                <span class="n">expiration_time</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># converting to seconds</span>
                <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">expiration_time</span> <span class="o">+=</span> <span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># converting to seconds</span>
                <span class="n">expiration_time</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># adding 15 mins extra before checking for unmount</span>

                <span class="n">time_passed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Waiting for expiry time to finish &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">time_passed</span> <span class="o">&lt;</span> <span class="n">expiration_time</span><span class="p">:</span>
                    <span class="n">diff_in_seconds</span> <span class="o">=</span> <span class="n">expiration_time</span> <span class="o">-</span> <span class="n">time_passed</span>
                    <span class="n">diff_in_mins</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">diff_in_seconds</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time left for unmount: </span><span class="si">{0}</span><span class="s2"> minutes.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">diff_in_mins</span><span class="p">)))</span>
                    <span class="c1"># sleeping for remaining time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for </span><span class="si">{0}</span><span class="s2"> minutes.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff_in_mins</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">diff_in_seconds</span><span class="p">)</span>
                    <span class="n">time_passed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Live Mounted VM &quot;</span><span class="si">{0}</span><span class="s1">&quot; not found in vcenter &quot;</span><span class="si">{1}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mounted_vm_name</span><span class="p">,</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Expiration period is over &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
            <span class="c1"># ############ validations after vm is unmounted #################################</span>
            <span class="c1"># refreshing vm list in hypervisor</span>
            <span class="n">vms_in_hypervisor</span> <span class="o">=</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Validations after expiration period is over &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Checking if VM is unmounted &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
            <span class="c1"># 3. check if vm unmounted (after expiry time)</span>
            <span class="k">if</span> <span class="n">mounted_vm_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vms_in_hypervisor</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM successfully unmounted from hypervisor </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">hvobj</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">))</span>
                <span class="kn">from</span> <span class="nn">cvpysdk.client</span> <span class="k">import</span> <span class="n">Client</span>
                <span class="n">media_agent_name</span> <span class="o">=</span> <span class="n">vmpolicy</span><span class="o">.</span><span class="n">properties</span><span class="p">()[</span><span class="s1">&#39;mediaAgent&#39;</span><span class="p">][</span><span class="s1">&#39;clientName&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Client object for media agent.&quot;</span><span class="p">)</span>
                <span class="n">media_agent_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
                                            <span class="n">client_name</span><span class="o">=</span><span class="n">media_agent_name</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating Machine object for media agent.&quot;</span><span class="p">)</span>
                <span class="n">media_agent_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">machine_name</span><span class="o">=</span><span class="n">media_agent_name</span><span class="p">,</span>
                                              <span class="n">commcell_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

                <span class="n">xml_file_path</span> <span class="o">=</span> <span class="n">media_agent_client</span><span class="o">.</span><span class="n">job_results_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">3dfs</span><span class="se">\\</span><span class="s1">Exports.xml&#39;</span>
                <span class="n">xml_file_str</span> <span class="o">=</span> <span class="n">media_agent_machine</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">xml_file_path</span><span class="p">)</span>
                <span class="n">xml_file_each_line</span> <span class="o">=</span> <span class="n">xml_file_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">active_job_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="s2">&quot; Checking Exports.xml in Job Results directory of Media &quot;</span>
                                         <span class="s2">&quot;Agent &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xml_file_each_line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;jobId&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\&quot;</span><span class="s1">]+\d+[</span><span class="se">\&quot;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                            <span class="n">active_job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">))</span>

                <span class="c1"># check for active mounts in exports.xml of media agent</span>
                <span class="n">active_mounts</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">active_job_ids</span><span class="p">:</span>
                    <span class="n">active_mounts</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Active mounts found on Media Agent.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No active mounts found on Media Agent.&quot;</span><span class="p">)</span>

                <span class="c1"># check for job id in active job mounts</span>
                <span class="k">if</span> <span class="n">active_mounts</span> <span class="ow">and</span> <span class="n">live_mount_job</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="n">active_job_ids</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for existing mount on Media Agent.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;Job Id </span><span class="si">{0}</span><span class="s1"> still exists in Exports.xml of Media Agent </span><span class="si">{1}</span><span class="s1">.&#39;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">live_mount_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">media_agent_name</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Existing mount not found on Media Agent.&quot;</span><span class="p">)</span>

                <span class="c1"># 4. check if data store is unmounted (if no active mounts are present)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">+</span> <span class="s2">&quot; Checking associated datastore &quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
                <span class="n">policy_datastore</span> <span class="o">=</span> <span class="n">vmpolicy</span><span class="o">.</span><span class="n">properties</span><span class="p">()[</span><span class="s1">&#39;dataCenter&#39;</span><span class="p">][</span><span class="s1">&#39;dataCenterName&#39;</span><span class="p">]</span>
                <span class="n">mounted_vm_datastore</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">policy_datastore</span> <span class="o">+</span> <span class="s1">&#39;_GX_BACKUP_0_&#39;</span> <span class="o">+</span> <span class="n">media_agent_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                    <span class="n">mounted_machine_vmhelper</span><span class="o">.</span><span class="n">ESXHost</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">active_mounts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking whether datastore is unmounted since there are no &quot;</span>
                                  <span class="s2">&quot;other active mounts.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mounted_vm_datastore</span> <span class="ow">in</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">_get_datastore_dict</span><span class="p">()[</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s1">&#39;Datastore &quot;</span><span class="si">{0}</span><span class="s1">&quot; not unmounted despite media agent &quot;</span><span class="si">{1}</span><span class="s1">&quot; having no &#39;</span>
                            <span class="s1">&#39;active mounts.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mounted_vm_datastore</span><span class="p">,</span> <span class="n">media_agent_name</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Datastore successfully unmounted.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Since there are other active mounts, datastore is &quot;</span>
                                  <span class="s2">&quot;still mounted.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Live Mounted VM </span><span class="si">{0}</span><span class="s1"> not unmounted after expiration time from &#39;</span>
                               <span class="s1">&#39;hypervisor </span><span class="si">{1}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mounted_vm_name</span><span class="p">,</span> <span class="n">hvobj</span><span class="o">.</span><span class="n">server_host_name</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="c1"># success message after validation is complete</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Success. Live Mount validation completed with no issues.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to Live Mount client: </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_vm_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in LiveMount: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span></div>

<div class="viewcode-block" id="AutoVSAVSClient.fs_testdata_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSClient.fs_testdata_validation">[docs]</a>    <span class="k">def</span> <span class="nf">fs_testdata_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_client</span><span class="p">,</span> <span class="n">source_location</span><span class="p">,</span> <span class="n">dest_location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does Validation of live mounted vm comparing testdata in source client</span>

<span class="sd">        Args:</span>
<span class="sd">            source_client     (obj)   --  Machine class object of source client</span>

<span class="sd">            source_location   (str)   --  testdata path for source vm</span>

<span class="sd">            dest_client       (obj)   --  Machine class object of destination client</span>

<span class="sd">            source_location   (str)   --  testdata path for source vm</span>

<span class="sd">            dest_location     (str)   --  testdata path for live mounted vm</span>

<span class="sd">        Exception</span>
<span class="sd">                if folder comparison fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating the testdata&quot;</span><span class="p">)</span>

            <span class="n">controller_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

            <span class="n">difference</span> <span class="o">=</span> <span class="n">controller_machine</span><span class="o">.</span><span class="n">compare_folders</span><span class="p">(</span><span class="n">dest_client</span><span class="p">,</span> <span class="n">source_location</span><span class="p">,</span>
                                                            <span class="n">dest_location</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">difference</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checksum mismatched for files </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">difference</span><span class="p">))</span>

                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Folder Comparison Failed for Source: </span><span class="si">{0}</span><span class="s2"> and destination: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">source_location</span><span class="p">,</span> <span class="n">dest_location</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation completed successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception in FSTestdataValidation&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AutoVSAVSInstance"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSInstance">[docs]</a><span class="k">class</span> <span class="nc">AutoVSAVSInstance</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for perfoming Instance operations. Act as wrapper for SDK and testcases</span>

<span class="sd">    Methods:</span>
<span class="sd">            get_instance_name()     - gets the isntnace name for the agent</span>

<span class="sd">            get_instance_id()       - get the instance id of the associated isntance</span>

<span class="sd">            get_proxy_list()        - gets the list of proxies associated with isntance</span>

<span class="sd">            _create_hyperviosr_object- Initialize objects for hypervisor helper</span>

<span class="sd">            _compute_credentials()   - computes the credentials for hyperviors</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto_client</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize all the class properties of AutoVSAVSInstance class</span>

<span class="sd">        Args:</span>
<span class="sd">                agent   (obj)   - object of Agent class in SDK</span>

<span class="sd">                instance(obj)   - object for Instance class in SDK</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsaclient</span> <span class="o">=</span> <span class="n">auto_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">auto_client</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span> <span class="o">=</span> <span class="n">auto_client</span><span class="o">.</span><span class="n">auto_commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_agent</span> <span class="o">=</span> <span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">instance_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">_instance_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsaclient</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_proxy_esx_host</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_co_ordinator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_proxy_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hypervisor_object</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">proxy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns Proxy list assocaited with that VSInstance . Read only attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_proxy_list</span>

    <span class="nd">@proxy_list</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">proxy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the list of Proxies as Proxy list in Instance level</span>

<span class="sd">        Args:</span>
<span class="sd">            value     (list) -list of proxies need to be set at instance level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">associated_clients</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> has occurred </span><span class="se">\</span>
<span class="s2">                                while setting coordinator client &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">co_ordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retuens Proxy list assocaited witht hat VSInstance . Read only attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_co_ordinator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_co_ordinator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">co_ordinator</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_co_ordinator</span>

    <span class="nd">@co_ordinator</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">co_ordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the proxy given as coordinator</span>

<span class="sd">        Args:</span>
<span class="sd">            Coordinator - Proxy that needs to be set as coordinator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">coordinator_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">coordinator</span><span class="p">)</span>
            <span class="n">temp_vsa_proxy_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">coordinator_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_proxy_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_proxy_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">temp_vsa_proxy_list</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">proxy_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_proxy_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception </span><span class="si">{0}</span><span class="s2"> has occurred </span><span class="se">\</span>
<span class="s2">                               while setting coordinator client &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fbr_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns FBRMA assocaited witht hat VSInstance . Read only attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">fbr_MA_Unix</span>

    <span class="nd">@fbr_ma</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fbr_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fbr_ma_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Proxy as FBR Ma for that Instance</span>

<span class="sd">        Args:</span>
<span class="sd">            fbr_ma_name : Ma that needs to be set as FBR Ma</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">fbr_MA_unix</span> <span class="o">=</span> <span class="n">fbr_ma_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">server_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retuens Server Credentials assocaited witht hat VSInstance . Read only attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span>

<div class="viewcode-block" id="AutoVSAVSInstance.get_instance_name"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSInstance.get_instance_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set Instance Id Provided Virtualization client name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">instance_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in setting the Instance Type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSAVSInstance.get_instance_id"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSInstance.get_instance_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the Instance id of that instance</span>

<span class="sd">        Return:</span>
<span class="sd">            instnace_id - Instance id of Instance associated with VS isntance</span>

<span class="sd">        exception:</span>
<span class="sd">                If there is no Instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">instance_id</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;ERROR - exception while getting instance id Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSAVSInstance.get_proxy_list"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSInstance.get_proxy_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_proxy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the Proxy List for the instance</span>

<span class="sd">        returns</span>
<span class="sd">                v_proxy_list    (dict)-- dict with proxy name as key and its</span>
<span class="sd">                                                                        corresponding id as value</span>

<span class="sd">        Exception:</span>
<span class="sd">                if vsa_client does not exist in cs</span>

<span class="sd">                failed to get  Instance property</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_co_ordinator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">co_ordinator</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">associated_clients</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in creating the Hypervisor object  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_create_hypervisor_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create Hypervisor Object</span>

<span class="sd">        Exception:</span>
<span class="sd">                if initialization fails in creating object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsaclient</span><span class="o">.</span><span class="n">vsa_client_name</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
                <span class="n">agent</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Virtual Server&#39;</span><span class="p">)</span>
                <span class="n">instance_keys</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">_instances</span><span class="p">))</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instance_keys</span><span class="p">)</span>

            <span class="n">host_machine</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">co_ordinator</span>
            <span class="n">server_host_name</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">server_host_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_credentials</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
            <span class="n">hvobj</span> <span class="o">=</span> <span class="n">Hypervisor</span><span class="p">(</span><span class="n">server_host_name</span><span class="p">,</span> <span class="n">host_machine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vsa_instance_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">hvobj</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in creating the Hypervisor object  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_compute_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the credentials required to call the Vcenter&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;Select attrval from APP_InstanceProp where attrname IN </span><span class="se">\</span>
<span class="s2">                      (&#39;Virtual Server Password&#39;,&#39;Virtual Server User&#39;) and componentNameId = ( </span><span class="se">\</span>
<span class="s2">                      select TOP 1 instance  from APP_Application where clientId= ( </span><span class="se">\</span>
<span class="s2">                Select TOP 1 id from App_Client where name = &#39;</span><span class="si">%s</span><span class="s2">&#39;) and appTypeId = &#39;106&#39;)&quot;</span> \
                     <span class="o">%</span> <span class="n">client_name</span>

            <span class="c1">#&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred getting server details&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">_password</span> <span class="o">=</span> <span class="n">_results</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># _password = _results[0][0].strip()</span>
            <span class="c1"># self.user_name = &quot;.\\administrator&quot;</span>
            <span class="c1"># self.password = &quot;builder!12&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">cvhelper</span><span class="o">.</span><span class="n">format_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">_password</span><span class="p">)</span>
            <span class="c1">#&quot;&quot;&quot;</span>
            <span class="c1">#self.user_name = &quot;.\\administrator&quot;</span>
            <span class="c1">#self.password = &quot;builder!12&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in getting credentials for Compute Credentials  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSAVSInstance.cbt_checks"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSAVSInstance.cbt_checks">[docs]</a>    <span class="k">def</span> <span class="nf">cbt_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">instanceno_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">host_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_hostname_for_client</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">)</span>
                <span class="n">host_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">host_name</span>
                <span class="n">instance_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_instanceno_for_client</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">)</span>
                <span class="n">instanceno_dict</span><span class="p">[</span><span class="n">each_proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_number</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">check_cbt_driver_running</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">)</span>
            <span class="n">cbtstat_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">check_or_set_cbt_registry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">,</span> <span class="n">host_dict</span><span class="p">,</span> <span class="n">instanceno_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cbtstat_folder</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in getting CBT driver status </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>


<div class="viewcode-block" id="AutoVSABackupset"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSABackupset">[docs]</a><span class="k">class</span> <span class="nc">AutoVSABackupset</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class for performing backupset operations. it acts as wrapper for Testcase and SDK</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_obj</span><span class="p">,</span> <span class="n">backupset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize SDK objects</span>

<span class="sd">        Args:</span>
<span class="sd">            backupset   (obj)   - object for backupset class in SDK</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span> <span class="o">=</span> <span class="n">instance_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">auto_vsaclient</span><span class="o">.</span><span class="n">auto_commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="n">backupset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">backupset_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">backupset_id</span></div>


<div class="viewcode-block" id="AutoVSASubclient"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient">[docs]</a><span class="k">class</span> <span class="nc">AutoVSASubclient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class for performing subclient operations. It act as wrapper for Testcase and SDK</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backupset_obj</span><span class="p">,</span> <span class="n">subclient</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize subclient SDK objects</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient (obj) - object of subclient class of SDK</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsa_backupset</span> <span class="o">=</span> <span class="n">backupset_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsa_backupset</span><span class="o">.</span><span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsa_backupset</span><span class="o">.</span><span class="n">auto_vsainstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsaclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">auto_vsaclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vsa_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">auto_commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">csdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">hvobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="n">subclient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browse_ma_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_ma_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_browse_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiesce_file_system</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disk_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">vm_diskfilter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disk_filter_input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_record</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_restore_dest</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_live_browse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exe_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controller_machine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_windows_live_browse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_content_details</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disk_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_disk_filter_list</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            current running process id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">controller_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Controller Machine machine class object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller_machine</span><span class="p">:</span>
            <span class="n">_controller_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_client_name_from_hostname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_controller_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">_controller_client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controller_machine</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns storage policy associated with subclient.Read only attribute&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span>

    <span class="nd">@storage_policy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Specified Storage Policy</span>

<span class="sd">        Args:</span>
<span class="sd">            value - storage policy name</span>

<span class="sd">        Exception:</span>
<span class="sd">            if storage policy does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">storage_policy_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns storage policy id associated with subclient.Read only attribute&quot;&quot;&quot;</span>
        <span class="n">sp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp_name</span><span class="o">.</span><span class="n">storage_policy_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vm_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">             Returns content  associated with subclient in the form of dict.Read only attribute</span>

<span class="sd">             Return:</span>
<span class="sd">                 content    (dict)  - with keys</span>
<span class="sd">                 {</span>
<span class="sd">                &#39;allOrAnyChildren&#39;: True,</span>
<span class="sd">                &#39;equalsOrNotEquals&#39;: True,</span>
<span class="sd">                &#39;name&#39;: anme of the VM,</span>
<span class="sd">                &#39;displayName&#39;: display name of the VM,</span>
<span class="sd">                &#39;path&#39;: source path of the VM,</span>
<span class="sd">                &#39;type&#39;: 9(VM),1(Host)</span>
<span class="sd">                        }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>

    <span class="nd">@vm_content</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vm_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set the specified content as content in subclient</span>

<span class="sd">        Args:</span>
<span class="sd">            content (str)   -   like [VM]=startswith=test*,test1</span>
<span class="sd">                                                        [VM] - represent type</span>
<span class="sd">                                                                        like [DNS],[HN]</span>

<span class="sd">                                                        startswith  represent equality in GUI</span>
<span class="sd">                                                                like endswith,equals</span>

<span class="sd">                                                        test* - include all VM starts with test</span>
<span class="sd">                                                               adding dyanamic contetn in GUI</span>

<span class="sd">                                                        , - to include multiple content</span>

<span class="sd">                                                        test1 -  non-dynamic content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_content_details</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">browse_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the browse MA from which the disk restore is perfomed</span>
<span class="sd">        It is read only attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse_ma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse_ma_id</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        over ride deepcopy method to copy every attribute of an objevt to other</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">tempobj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tempobj</span><span class="p">,</span> <span class="n">tempobj</span><span class="o">.</span><span class="n">vm_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tempobj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to deepcopy Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSASubclient.get_previous_full_backup"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_previous_full_backup">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous_full_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Previous full backup  for this subclient</span>

<span class="sd">        args:</span>
<span class="sd">                job_id  (int) - for which previous full has to be fetched</span>

<span class="sd">        Exception:</span>
<span class="sd">                if failed to get app id</span>


<span class="sd">        returns:</span>
<span class="sd">            job id  (int) - job id of the previous full backup of given current backup</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_job_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;Select id from APP_Application where instance = </span><span class="si">%s</span><span class="s2"> and </span><span class="se">\</span>
<span class="s2">                        backupSet = </span><span class="si">%s</span><span class="s2"> and subclientName = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> \
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_instance_id</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsa_backupset</span><span class="o">.</span><span class="n">backupset_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception occurred in getting previous full backup&quot;</span><span class="p">)</span>

            <span class="n">_AppId</span> <span class="o">=</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">_query1</span> <span class="o">=</span> <span class="s2">&quot;Select jobId  from JMBkpStats where appId = </span><span class="si">%s</span><span class="s2"> and appType = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                    and bkpLevel = 1&quot;</span> <span class="o">%</span> \
                      <span class="p">(</span><span class="n">_AppId</span><span class="p">,</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">APP_TYPE</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query1</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception occurred in getting previous full backup&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_result</span> <span class="ow">in</span> <span class="n">_results</span><span class="p">:</span>
                <span class="n">tempval</span> <span class="o">=</span> <span class="n">each_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tempval</span> <span class="o">!=</span> <span class="n">job_id</span><span class="p">:</span>
                    <span class="n">_job_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempval</span><span class="p">)</span>

            <span class="n">_job_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_job_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get Previous Full Job Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR - exception while GetPreviousFULLBackup&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoVSASubclient.set_content_details"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.set_content_details">[docs]</a>    <span class="k">def</span> <span class="nf">set_content_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the subclient details in subclient and prepares VM List</span>

<span class="sd">        Exception:</span>
<span class="sd">                if failed to update subclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_content_string_from_dict</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">_vm_content_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_content_string</span><span class="p">(</span>
                    <span class="n">_vm_content_string</span><span class="p">)</span>
                <span class="n">_vm_content_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_content_dict_from_string</span><span class="p">(</span>
                    <span class="n">option</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">equality</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed in setting Subclient Content&quot;</span><span class="p">)</span>

            <span class="c1"># VM Filter string and dict</span>
            <span class="n">_vm_filter_string</span><span class="p">,</span> <span class="n">_vm_filter_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_filter_details</span><span class="p">()</span>

            <span class="c1"># prepare VM List</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_vm_list</span><span class="p">(</span><span class="n">_vm_content_string</span><span class="p">,</span> <span class="n">_vm_filter_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_vsa_subclient_content</span><span class="p">(</span>
                <span class="n">_vm_content_dict</span><span class="p">,</span> <span class="n">_vm_filter_dict</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to SetContentDetails Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.set_filter_details"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.set_filter_details">[docs]</a>    <span class="k">def</span> <span class="nf">set_filter_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates Filter string and dictionary can be with details for SDK API</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">_vm_filter_string</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_vm_filter_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">vm_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_vm_filter_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_content_string_from_dict</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">vm_filter</span><span class="p">)</span>
                    <span class="n">_vm_filter_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">vm_filter</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_vm_filter_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_filter</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_content_string</span><span class="p">(</span>
                    <span class="n">_vm_filter_string</span><span class="p">)</span>
                <span class="n">_vm_filter_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_content_dict_from_string</span><span class="p">(</span>
                    <span class="n">option</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">equality</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_vm_filter_string</span><span class="p">,</span> <span class="n">_vm_filter_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to SetContentDetails Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_prepare_content_string_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prepares string format of subclient content for preparing vm list</span>

<span class="sd">        Args:</span>
<span class="sd">                content (dict)  - with keys</span>
<span class="sd">                                         {</span>
<span class="sd">                                &#39;equal_value&#39;: True,</span>
<span class="sd">                                &#39;name&#39;: anme of the VM,</span>
<span class="sd">                                &#39;display_name&#39;: display name of the VM,</span>
<span class="sd">                                &#39;path&#39;: source path of the VM,</span>
<span class="sd">                                &#39;type&#39;: Virtual Machine(VM),Host Name(Host)</span>
<span class="sd">                                        }</span>

<span class="sd">        returns:</span>
<span class="sd">                vm_content_string   -(str)  - [VM]=equals=test1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm_content_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">_each_vm</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="n">_content_types</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">content_types</span>
                <span class="n">_vm_display_name</span> <span class="o">=</span> <span class="n">_each_vm</span><span class="p">[</span><span class="s2">&quot;display_name&quot;</span><span class="p">]</span>
                <span class="n">_option</span> <span class="o">=</span> <span class="n">_content_types</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="n">_pattern</span> <span class="o">=</span> <span class="n">_vm_display_name</span>

                <span class="k">if</span> <span class="n">_vm_display_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Ends with&quot;</span>
                    <span class="n">_pattern</span> <span class="o">=</span> <span class="n">_vm_display_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">content_str</span> <span class="o">=</span> <span class="n">_option</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_equality</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_pattern</span>
                    <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="n">content_str</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span> <span class="o">+</span> <span class="n">_vm_content_string</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">_vm_display_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Starts with&quot;</span>
                    <span class="n">_pattern</span> <span class="o">=</span> <span class="n">_vm_display_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">content_str</span> <span class="o">=</span> <span class="n">_option</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_equality</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_pattern</span>
                    <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="n">content_str</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span> <span class="o">+</span> <span class="n">_vm_content_string</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">_vm_display_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_each_vm</span><span class="p">[</span><span class="s2">&quot;equal_value&quot;</span><span class="p">]:</span>
                        <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Contains&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Does not Contains&quot;</span>

                    <span class="n">content_str</span> <span class="o">=</span> <span class="n">_option</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_equality</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_pattern</span>
                    <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="n">content_str</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span> <span class="o">+</span> <span class="n">_vm_content_string</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">_each_vm</span><span class="p">[</span><span class="s2">&quot;equal_value&quot;</span><span class="p">]:</span>
                    <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Equals&quot;</span>
                    <span class="n">content_str</span> <span class="o">=</span> <span class="n">_option</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_equality</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_pattern</span>
                    <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="n">content_str</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span> <span class="o">+</span> <span class="n">_vm_content_string</span>
                    <span class="k">continue</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_equality</span> <span class="o">=</span> <span class="s2">&quot;Does Not Equals&quot;</span>
                    <span class="n">content_str</span> <span class="o">=</span> <span class="n">_option</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_equality</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">_pattern</span>
                    <span class="n">_vm_content_string</span> <span class="o">=</span> <span class="n">content_str</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
                    <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span> <span class="o">+</span> <span class="n">_vm_content_string</span>

            <span class="n">vm_content_string</span> <span class="o">=</span> <span class="n">vm_content_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">vm_content_string</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to PrepareVMListfromSCContent Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSASubclient.get_maname_from_policy"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_maname_from_policy">[docs]</a>    <span class="k">def</span> <span class="nf">get_maname_from_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the MA Name from policy associated with subclient</span>

<span class="sd">        return:</span>
<span class="sd">                ma_name     (str)   - ma client name associated with SP</span>

<span class="sd">        Exception:</span>
<span class="sd">                if failed to get ma name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select DISTINCT AC.name  from MMDataPath MDP, APP_Client AC where </span><span class="se">\</span>
<span class="s2">                        MDP.HostClientId = AC.id AND MDP.CopyId in </span><span class="se">\</span>
<span class="s2">                    (select id from archGroupCopy where archGroupId = </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;An exception occurred in getting ma from policy&quot;</span><span class="p">)</span>

            <span class="n">ma_name</span> <span class="o">=</span> <span class="n">_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ma_name</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to GetStoragePolicy Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.update_vsa_subclient_content"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.update_vsa_subclient_content">[docs]</a>    <span class="k">def</span> <span class="nf">update_vsa_subclient_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_content_dict</span><span class="p">,</span> <span class="n">vm_filter_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the VSA Subclient Content using SDK</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_content_dict     (dict)  - dict in format to pass through SDK API</span>

<span class="sd">                vm_filter_dict      (dict)  - dict in format to pass through SDK API</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># self.subclient.content = vm_content_dict</span>

            <span class="c1"># if vm_filter_dict != {}:</span>
            <span class="c1"># self.subclient.vm_filter = vm_filter_dict</span>

            <span class="c1"># if not(self._disk_filter == []):</span>
            <span class="c1"># self.PrepareDiskList()</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">,</span> <span class="n">each_vm</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">each_vm</span>

                    <span class="c1"># if not(self._disk_filter == []):</span>
                    <span class="c1"># self.PrepareDiskFilterList()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in updating  the subclient </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.get_vm_record_based_on_pattern"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_vm_record_based_on_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_record_based_on_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">equality</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the VM from hypervisor and  get the record of VM based on the pattern</span>

<span class="sd">        Args:</span>
<span class="sd">                option - [VM],[HN] -content is VM, Hostname etc..</span>

<span class="sd">                quality - startswith,equals etc.,</span>

<span class="sd">                pattern - pattern with wihich the option starts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;[HN]&quot;</span><span class="p">:</span>
                <span class="n">_hypervisor_vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">(</span>
                    <span class="n">pattern</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;[VM]&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Equals&quot;</span><span class="p">):</span>
                <span class="n">_hypervisor_vm_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_hypervisor_vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">get_all_vms_in_hypervisor</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">_hypervisor_vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_each_vm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">_each_vm</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred in getting VM record fpor all VMs in Hypervisor  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_is_dyanamic_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">                content     (str)   -- content in the form of [VM]=startswith=test*</span>

<span class="sd">        returns:</span>
<span class="sd">                non_dynamic_content_list    (list)  - returns the non dynamic content</span>
<span class="sd">                                                        like [VM]=equals=test1</span>

<span class="sd">                dynamic_content_list        (list)  - returns the dynamic content list</span>
<span class="sd">                                                        like [VM]=startswith-test1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dynamic_content_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">non_dynamic_content_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_input_lists</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_input_list</span> <span class="ow">in</span> <span class="n">_input_lists</span><span class="p">:</span>
                <span class="n">_inputs</span> <span class="o">=</span> <span class="n">_input_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_input_string</span> <span class="ow">in</span> <span class="n">_inputs</span><span class="p">:</span>
                    <span class="c1"># regex checek</span>
                    <span class="n">_pattern_list</span> <span class="o">=</span> <span class="n">_input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;=&quot;</span><span class="p">)</span>  <span class="c1"># individual items</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pattern_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">non_dynamic_content_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_input_string</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dynamic_content_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_input_string</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">non_dynamic_content_list</span><span class="p">,</span> <span class="n">dynamic_content_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception occurred in isDynamicContent.Error [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_compute_vm_list_from_dynamic_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phase I of dynamic content evaluation - Get all VM records in dictionary based on option given</span>

<span class="sd">        Args:</span>
<span class="sd">                content_list    (list)  - list of dynamic content string like [VM]=startswith=test*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">content_list</span><span class="p">:</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_content_string</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_record_based_on_pattern</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">equality</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error while retrieving VMs and their records&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error while retrieving VMs and their records&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Records for all VMs are created successfully&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception in function ComputeVmListWithDynamicContent &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_match_pattern_in_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It performs pattern matching. like the pattern is test* and</span>
<span class="sd">        if the Vm is test1 it returns True</span>

<span class="sd">        Args:</span>
<span class="sd">                vm -        (str)    - Name of the Vm against which mattern is need to be matched</span>

<span class="sd">                equality    (str)   - like equals, notequals</span>

<span class="sd">                pattern     (str)   -patterns which needs to bematched with the vm</span>
<span class="sd">                                                            like test*,test*1</span>

<span class="sd">        return:</span>
<span class="sd">                True        (bool)  - if the pattern matches the VM</span>

<span class="sd">                False       (bool)  -if the pattern does not matches for the VM</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Equals&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Equals&quot;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Contains&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Contains&quot;</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;.*&quot;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span>

            <span class="k">elif</span> <span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Starts with&quot;</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span>

            <span class="k">elif</span> <span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Ends with&quot;</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;.*&quot;</span> <span class="o">+</span> <span class="n">pattern</span>

            <span class="c1"># pattern of the form ab*cd</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">pattern</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;+&#39;</span><span class="p">))</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">)):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>  <span class="c1"># pattern of the form abc*</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

            <span class="c1"># pattern of the form *abc</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;+&#39;</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pattern of the form *abc*</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Does not match&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while matching patterns. &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSASubclient.split_content_string"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.split_content_string">[docs]</a>    <span class="k">def</span> <span class="nf">split_content_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        split the content string to option equality pattern</span>

<span class="sd">        Args:</span>
<span class="sd">                pattern_string  (str)   - the input contetn string is [VM]=startswith=test*</span>

<span class="sd">        return:</span>

<span class="sd">                option = [VM] - represent the content is VM</span>

<span class="sd">                equality = startswith = the VM name shoudl starts with the test*</span>

<span class="sd">                pattern = test*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">listvalue</span> <span class="o">=</span> <span class="n">pattern_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listvalue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">option</span> <span class="o">=</span> <span class="p">(</span><span class="n">listvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">equality</span> <span class="o">=</span> <span class="p">(</span><span class="n">listvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="n">listvalue</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># commenting out filter string for now since its functionality</span>
                <span class="c1"># is done by MatchPatternforFilter</span>
                <span class="c1"># pattern = self.FetchPatterfromFilterString(equality, pattern)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input is evaluated successfully&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">option</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Input string id in not correct format&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception while evaluating input. &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.process_sc_input_for_vm_list"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.process_sc_input_for_vm_list">[docs]</a>    <span class="k">def</span> <span class="nf">process_sc_input_for_vm_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dynamic_content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process the input contetn string and return the final set of Vms</span>

<span class="sd">        Args:</span>
<span class="sd">                dynamic_content (str)   - process the dynamic content [VM]=startswith=test*</span>

<span class="sd">        returns:</span>
<span class="sd">                qualified_list  (list)  - Qualified list of VMs like test1,test2,test3</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_qualified_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_disqualified_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">process_content</span><span class="p">(</span><span class="n">prop</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                    <span class="n">_vm_prop_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">],</span> <span class="n">prop</span><span class="p">)</span>
                    <span class="n">_retcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_pattern_in_input</span><span class="p">(</span>
                        <span class="n">_vm_prop_value</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(((</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Equals&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Contains&quot;</span><span class="p">))</span>
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">_retcode</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)):</span>
                        <span class="n">_disqualified_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">_retcode</span><span class="p">:</span>
                        <span class="n">_qualified_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">_qualified_list</span><span class="p">,</span> <span class="n">_disqualified_list</span>

            <span class="n">process_filter_dict</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">vm_pattern_names</span>

            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">dynamic_content</span><span class="p">:</span>
                <span class="n">option</span><span class="p">,</span> <span class="n">equality</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_content_string</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">_qualified_list</span><span class="p">,</span> <span class="n">_disqualified_list</span> <span class="o">=</span> <span class="n">process_content</span><span class="p">(</span>
                    <span class="n">process_filter_dict</span><span class="p">[</span><span class="n">option</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Qualified list is made successfully.&quot;</span><span class="p">)</span>

            <span class="n">_qualified_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">_qualified_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_disqualified_list</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_qualified_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while applying filters. Error [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_process_vm_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process the VM content passed as input</span>

<span class="sd">        Args:</span>
<span class="sd">                content (str)   -   like [VM]=startswith=test*,test1</span>
<span class="sd">                                                        [VM] - represent type</span>
<span class="sd">                                                                        like [DNS],[HN]</span>

<span class="sd">                                                        startswith  represent equality in GUI</span>
<span class="sd">                                                                like endswith,equals</span>

<span class="sd">                                                        test* - include all VM starts with test</span>
<span class="sd">                                                               adding dyanamic contetn in GUI</span>

<span class="sd">                                                        , - to include multiple content</span>

<span class="sd">                                                        test1 -  non-dynamic content</span>

<span class="sd">                Return:</span>
<span class="sd">                        non_dynamic_content -   (list)  - list of Vms from non dynamic content</span>

<span class="sd">                        dynamic_list        -   (list)  - list of Vms from dynamic content</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing VM content is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getting VMs using GetVMlist()&quot;</span><span class="p">)</span>
            <span class="n">non_dynamic_content</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">non_dynamic_list</span><span class="p">,</span> <span class="n">dynamic_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dyanamic_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">non_dynamic_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_each_content</span> <span class="ow">in</span> <span class="n">non_dynamic_list</span><span class="p">:</span>
                    <span class="n">_pattern_list</span> <span class="o">=</span> <span class="n">_each_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">non_dynamic_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pattern_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_each_vm</span> <span class="ow">in</span> <span class="n">non_dynamic_content</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_each_vm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">_each_vm</span>

                <span class="k">return</span> <span class="n">non_dynamic_content</span><span class="p">,</span> <span class="n">dynamic_content</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_vm_list_from_dynamic_content</span><span class="p">(</span><span class="n">dynamic_content</span><span class="p">)</span>
                <span class="n">dynamic_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_sc_input_for_vm_list</span><span class="p">(</span>
                    <span class="n">dynamic_content</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">non_dynamic_content</span><span class="p">,</span> <span class="n">dynamic_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;ERROR - VMList could be empty, please check the config file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSASubclient.prepare_vm_list"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.prepare_vm_list">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_vm_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prepare the final set of VM list including filters</span>

<span class="sd">        Args:</span>
<span class="sd">                content_string  (str)   - content string given by user or fetched from</span>
<span class="sd">                                                            subclient (format: [VM]=equals=test1)</span>

<span class="sd">                filter_string   (str)   -filter string given by user or fetched from</span>
<span class="sd">                                                            subclient (format: [VM]=equals=test1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">content_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_content</span>

            <span class="k">if</span> <span class="n">filter_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filter_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_filter</span>

            <span class="n">non_dynamic_content_list</span><span class="p">,</span> <span class="n">dynamic_content_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_vm_content</span><span class="p">(</span>
                <span class="n">content_string</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">filter_string</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">filter_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="n">non_dynamic_filter_list</span><span class="p">,</span> <span class="n">dynamic_filter_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_vm_content</span><span class="p">(</span>
                    <span class="n">filter_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">non_dynamic_filter_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dynamic_filter_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">_filter_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">non_dynamic_filter_list</span><span class="p">)</span> <span class="o">+</span> \
                           <span class="nb">list</span><span class="p">(</span><span class="n">dynamic_filter_list</span><span class="p">)</span>
            <span class="n">_final_dynamic_content_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">dynamic_content_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_filter_list</span><span class="p">)</span>
            <span class="n">_vm_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_final_dynamic_content_list</span><span class="p">)</span> <span class="o">+</span> \
                       <span class="nb">list</span><span class="p">(</span><span class="n">non_dynamic_content_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_vm_list</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in Updating the Subclient Property&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_prepare_content_dict_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">equality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create content in the for SDK API</span>

<span class="sd">        Args:</span>
<span class="sd">                option      - [VM],[HN] - Vms , HostNames</span>

<span class="sd">                equality    - like equals or not equals</span>

<span class="sd">                pattern     -  pattern like test1,test*</span>

<span class="sd">                is_dynamic  -   if it is dynamic or non dynamic content</span>

<span class="sd">        Return:</span>
<span class="sd">                vm content dict</span>
<span class="sd">                        content (dict)  - with keys</span>
<span class="sd">                                         {</span>
<span class="sd">                                &#39;allOrAnyChildren&#39;: True,</span>
<span class="sd">                                &#39;equalsOrNotEquals&#39;: True,</span>
<span class="sd">                                &#39;name&#39;: anme of the VM,</span>
<span class="sd">                                &#39;displayName&#39;: display name of the VM,</span>
<span class="sd">                                &#39;path&#39;: source path of the VM,</span>
<span class="sd">                                &#39;type&#39;: 9(VM),1(Host)</span>
<span class="sd">                                        }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Add Name as pattern</span>
            <span class="n">_vm_content_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">pattern</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
            <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;displayName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
            <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">equality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Equals&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">equality</span> <span class="o">==</span> <span class="s2">&quot;Does Not Contains&quot;</span><span class="p">):</span>
                    <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;equalsOrNotEquals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;equalsOrNotEquals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;equalsOrNotEquals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;[VM]&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_dynamic</span><span class="p">:</span>
                    <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Virtual Machine&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Virtual Machine&quot;</span>
                    <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">pattern</span><span class="p">]</span><span class="o">.</span><span class="n">GUID</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">con_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">_key</span> <span class="k">for</span> <span class="n">_key</span><span class="p">,</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">content_types</span><span class="o">.</span><span class="n">items</span><span class="p">(</span>
                <span class="p">)</span> <span class="k">if</span> <span class="n">_value</span> <span class="o">==</span> <span class="n">option</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_vm_content_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">con_type</span>

            <span class="k">return</span> <span class="n">_vm_content_dict</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in  CreateContentinSCFormat </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_process_disk_filter_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process the filter string to split it into controller , type number</span>

<span class="sd">        controller_string: Filter string that is from CS DB</span>
<span class="sd">        :return:</span>
<span class="sd">            controller_type (str) : it is scsi or ide</span>
<span class="sd">            number  (int)          : ilocation of scsi or ide</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The Controller string is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">controller_string</span><span class="p">)</span>
            <span class="n">_opening_bracket</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_possible_brackets</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;[&quot;</span><span class="p">:</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;(&quot;</span><span class="p">:</span> <span class="s2">&quot;)&quot;</span>
            <span class="p">}</span>
            <span class="n">_brackets_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_bracket</span> <span class="k">for</span> <span class="n">_bracket</span> <span class="ow">in</span> <span class="n">_possible_brackets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">_bracket</span> <span class="ow">in</span> <span class="n">controller_string</span><span class="p">)</span>
            <span class="n">_total_brackets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_brackets_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_total_brackets</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_opening_bracket</span> <span class="o">=</span> <span class="n">_brackets_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_slot_saperator</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">_opening_bracket</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span> <span class="k">else</span> <span class="s2">&quot;:&quot;</span>
                <span class="k">if</span> <span class="n">_opening_bracket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">controller_string</span> <span class="o">=</span> <span class="n">controller_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_controller_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">controller_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_opening_bracket</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">controller_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_opening_bracket</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">_controller_location_string</span> <span class="o">=</span> <span class="n">_temp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_possible_brackets</span><span class="p">[</span><span class="n">_opening_bracket</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_number</span><span class="p">,</span> <span class="n">_location</span> <span class="o">=</span> <span class="n">_controller_location_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">_slot_saperator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_single_slot</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">slot_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">slot_value</span> <span class="ow">in</span> <span class="n">controller_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">slot_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_single_slot</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Received unformatted slot values&#39;</span><span class="p">)</span>
                <span class="n">_controller_type</span> <span class="o">=</span> <span class="n">controller_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_single_slot</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_number</span> <span class="o">=</span> <span class="n">_single_slot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_location</span> <span class="o">=</span> <span class="n">_single_slot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">_controller_type</span><span class="p">,</span> <span class="n">_number</span><span class="p">,</span> <span class="n">_location</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in  process_diks_filter_string </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

<div class="viewcode-block" id="AutoVSASubclient.prepare_disk_filter_list"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.prepare_disk_filter_list">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_disk_filter_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the disk filter list by processing the pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">disk_filter_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="nf">process_repository_filters</span><span class="p">(</span><span class="n">_VM</span><span class="p">,</span> <span class="n">repository_name</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_VM</span><span class="p">]</span><span class="o">.</span><span class="n">_get_disks_by_repository</span><span class="p">(</span><span class="n">repository_name</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">process_control_filters</span><span class="p">(</span><span class="n">_VM</span><span class="p">,</span> <span class="n">controller_type</span><span class="p">):</span>
                <span class="n">controller_type</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_disk_filter_string</span><span class="p">(</span>
                    <span class="n">controller_type</span><span class="p">)</span>
                <span class="n">disk_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_VM</span><span class="p">]</span><span class="o">.</span><span class="n">_get_disk_in_controller</span><span class="p">(</span><span class="n">controller_type</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">disk_path</span>

            <span class="k">def</span> <span class="nf">process_disk_path_filters</span><span class="p">(</span><span class="n">_VM</span><span class="p">,</span> <span class="n">disk_path</span><span class="p">):</span>
                <span class="n">disk_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_VM</span><span class="p">]</span><span class="o">.</span><span class="n">_get_disk_path_from_pattern</span><span class="p">(</span><span class="n">disk_path</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">disk_path</span>

            <span class="n">disks_filter_process</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="n">process_repository_filters</span><span class="p">,</span>
                <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="n">process_control_filters</span><span class="p">,</span>
                <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="n">process_disk_path_filters</span>
            <span class="p">}</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Apply Datastore/repository filters first since </span>
<span class="sd">                there is good chance of all the disks getting filtered out</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">_disk_filter_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disk_filter</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_filter</span><span class="p">:</span> <span class="n">_filter</span><span class="p">[</span><span class="s1">&#39;filterTypeId&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Datastore filter check</span>
            <span class="k">if</span> <span class="n">_disk_filter_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;filterTypeId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_data_store_filter</span> <span class="o">=</span> <span class="n">_disk_filter_sorted</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">_disk_filter_sorted</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_data_store_filter</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_filter</span> <span class="ow">in</span> <span class="n">_disk_filter_sorted</span><span class="p">:</span>
                    <span class="n">disk_path</span> <span class="o">=</span> <span class="n">disks_filter_process</span><span class="p">[(</span><span class="n">each_filter</span><span class="p">[</span><span class="s1">&#39;filterTypeId&#39;</span><span class="p">])](</span><span class="n">each_vm</span><span class="p">,</span> <span class="n">each_filter</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">disk_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">disk_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;the criteria filter </span><span class="si">%s</span><span class="s2"> does not match this VM </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">each_filter</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">each_vm</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">disk_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">disk_filter_list</span> <span class="o">=</span> <span class="n">disk_filter_list</span> <span class="o">+</span> <span class="n">disk_path</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">disk_filter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_path</span><span class="p">)</span>
                    <span class="c1"># Do not apply any more filters if all the disks are filtered out</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disk_filter_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">disk_dict</span><span class="p">):</span>
                        <span class="k">break</span>

            <span class="n">disk_filter_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disk_filter_list</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_disk</span> <span class="ow">in</span> <span class="n">disk_filter_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">disk_dict</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">each_disk</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">Diskcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">disk_list</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to PrepareDiskFilterListContent Exception:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR - exception while PrepareDiskFilterListContent&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_if_windows_live_browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">os_name</span><span class="p">,</span> <span class="n">metadata_collected</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decides Live browse validation need to be perfomred or not.</span>

<span class="sd">        Args:</span>
<span class="sd">                os_name             (str)   - os name of  backups VM</span>

<span class="sd">                metdata_collected   (bool)  - True on metadata collected , false on not collected</span>

<span class="sd">        return:</span>
<span class="sd">                True    - If live browse validation needs to be performed</span>
<span class="sd">                False   - if live browse validation need notto be performed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os_name</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">metadata_collected</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred in checking live browse validation neeeded&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="AutoVSASubclient.vsa_discovery"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.vsa_discovery">[docs]</a>    <span class="k">def</span> <span class="nf">vsa_discovery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates testdata path and generate testdata and copy the test data to each drive in VM .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            TODO: Map Disknames with drive letters and stop copying </span>
<span class="sd">                  data to the filtered disks</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TesdataPath provided is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating test data directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating Test data folders&quot;</span><span class="p">)</span>

            <span class="n">generate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generate</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">generate</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">os_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;If all the disks are filtered out </span>
<span class="sd">                    avoiding copying test data to all the drives&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">disk_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_drive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">drive_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying Testdata to Drive </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_drive</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">copy_test_data_to_each_volume</span><span class="p">(</span>
                           <span class="n">_vm</span><span class="p">,</span> <span class="n">_drive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while doing VSA Discovery  :&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.cleanup_testdata"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.cleanup_testdata">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_testdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up testdata that is copied from each vm in the subclient</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_option   (obj)   -  object of Backup Options class in options</span>
<span class="sd">                                          helper contains all backup options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testdata cleanup from subclient started&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span> <span class="o">=</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">backup_type</span>
            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VM selected is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_vm</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_drive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">drive_list</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">_testdata_path</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">get_folder_to_be_compared</span><span class="p">(</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span> <span class="n">_driveletter</span><span class="o">=</span><span class="n">_drive</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_testdata_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">_testdata_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;clearing Testdata in controller&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while doing cleaning up testdata Discovery  :&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.backup"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_option</span><span class="p">,</span> <span class="n">type_of_content</span><span class="o">=</span><span class="s2">&quot;VM&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit VSA backup job</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_option           (object):   object of Backup Options class in options</span>
<span class="sd">                                                    helper containes all backup options</span>

<span class="sd">                type_of_content         (string):   type of content of a subclient</span>
<span class="sd">        Raise Exception:</span>
<span class="sd">                if job does not complete successfully</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span> <span class="o">=</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">backup_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span> <span class="o">=</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">testdata_path</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">get_testdata_path</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">machine</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vsa_discovery</span><span class="p">()</span>
            <span class="n">common_utils</span> <span class="o">=</span> <span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_of_content</span> <span class="o">==</span> <span class="s2">&quot;template&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting VMs to template&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">convert_vm_to_template</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">type_of_content</span> <span class="o">==</span> <span class="s2">&quot;rdm&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;calculating the details about rdm disks&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">rdm_details</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in getting disk details for the vm&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Backup Job&quot;</span><span class="p">)</span>

            <span class="n">_backup_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_option</span><span class="o">.</span><span class="n">backup_type</span><span class="p">,</span>
                                                <span class="n">backup_option</span><span class="o">.</span><span class="n">run_incr_before_synth</span><span class="p">,</span>
                                                <span class="n">backup_option</span><span class="o">.</span><span class="n">incr_level</span><span class="p">,</span>
                                                <span class="n">backup_option</span><span class="o">.</span><span class="n">collect_metadata</span><span class="p">,</span>
                                                <span class="n">backup_option</span><span class="o">.</span><span class="n">advance_options</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_backup_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run backup with error: &quot;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">_backup_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;SYNTH&quot;</span> <span class="ow">in</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">backup_type</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">incr_level</span> <span class="o">==</span> <span class="s2">&quot;AFTER_SYNTH&quot;</span><span class="p">:</span>
                    <span class="n">_backup_type</span> <span class="o">=</span> <span class="s2">&quot;INCREMENTAL&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_backup_type</span> <span class="o">=</span> <span class="s2">&quot;SYNTHETIC FULL&quot;</span>

                <span class="n">incr_job</span> <span class="o">=</span> <span class="n">common_utils</span><span class="o">.</span><span class="n">get_synthetic_full_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">,</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">incr_level</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">incr_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to run backup with error: &quot;</span> <span class="o">+</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">incr_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span> <span class="o">=</span> <span class="n">incr_job</span><span class="o">.</span><span class="n">job_id</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_backup_type</span> <span class="o">=</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">backup_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span> <span class="o">=</span> <span class="n">_backup_job</span><span class="o">.</span><span class="n">job_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup Job </span><span class="si">{0}</span><span class="s2"> completed successfully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backup Job got complete&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Checking if Job type is Expected for job ID </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">_check_backup_job_type_expected</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">,</span> <span class="n">_backup_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">backup_option</span><span class="p">,</span> <span class="s2">&quot;Application_aware&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">Application_aware</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;It is application Aware backup so checking for other jobs&quot;</span><span class="p">)</span>
                <span class="n">ida_job_id</span><span class="p">,</span> <span class="n">workflow_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">find_app_aware_jobs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">)</span>
                <span class="n">ida_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">ida_job_id</span><span class="p">)</span>
                <span class="n">workflow_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">workflow_job_id</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;Completed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ida_job</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="n">workflow_job</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Ida job </span><span class="si">{0}</span><span class="s2"> or Workflow Job </span><span class="si">{0}</span><span class="s2"> failed , please check the logs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ida_job</span><span class="p">,</span> <span class="n">workflow_job</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">backup_option</span><span class="o">.</span><span class="n">backup_method</span> <span class="o">==</span> <span class="s2">&quot;SNAP&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backupcopy_job_id</span> <span class="o">=</span> <span class="n">common_utils</span><span class="o">.</span><span class="n">get_backup_copy_job_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">)</span>
                <span class="n">backupcopy_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupcopy_job_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">backupcopy_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to run backup copy job with error: &quot;</span> <span class="o">+</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">backupcopy_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while submitting Backup job:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.guest_file_restore"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.guest_file_restore">[docs]</a>    <span class="k">def</span> <span class="nf">guest_file_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs_restore_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        perform Guest file restore for specific subclinet</span>

<span class="sd">        Args:</span>
<span class="sd">                fs_restore_options  -options that need to be set while performing guest fiel restore</span>

<span class="sd">        Exception:</span>
<span class="sd">                        if job fails</span>
<span class="sd">                        if validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">disk_count_before_restore</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">_drive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">drive_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="o">==</span> <span class="n">_drive</span> <span class="ow">or</span> <span class="s2">&quot;/home&quot;</span> <span class="o">==</span> <span class="n">_drive</span><span class="p">:</span>
                        <span class="n">_preserve_level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">preserve_level</span><span class="p">)</span> <span class="o">+</span> \
                                          <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">preserve_level</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_preserve_level</span> <span class="o">=</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">preserve_level</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restore dest path &quot;</span> <span class="o">+</span>
                                  <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">restore_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">browse_from_snap</span><span class="p">:</span>
                        <span class="n">_temp_vm</span><span class="p">,</span> <span class="n">_temp_vmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_get_vm_ids_and_names_dict_from_browse</span><span class="p">()</span>
                        <span class="n">_browse_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">guest_files_browse</span><span class="p">(</span><span class="n">_temp_vmid</span><span class="p">[</span><span class="n">_temp_vm</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                                                                            <span class="n">media_agent</span><span class="o">=</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">browse_ma</span><span class="p">)</span>
                        <span class="n">_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_snap_guest_file_path</span><span class="p">(</span><span class="n">_browse_request</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_drive</span><span class="p">)</span>
                        <span class="n">_fs_path_to_browse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span>
                                                                               <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_fs_path_to_browse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span>
                                                                               <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fs_restore_dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">restore_path</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span>
                                                                             <span class="n">_vm</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_windows_live_browse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_windows_live_browse</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="p">,</span>
                        <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">metadata_collected</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">metadata_collected</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the count of disk of Ma </span><span class="si">{0}</span><span class="s2"> before &quot;</span>
                                      <span class="s2">&quot;Guest file restore for live browse&quot;</span><span class="o">.</span>
                                      <span class="nb">format</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">_browse_ma_client_name</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_windows_live_browse</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">_browse_ma_client_name</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ma_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">_browse_ma_client_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">fbr_ma</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ma_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">fbr_ma</span><span class="p">)</span>
                        <span class="n">disk_count_before_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">get_disk_count</span><span class="p">()</span>
                    <span class="n">fs_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">guest_file_restore</span><span class="p">(</span><span class="n">_vm</span><span class="p">,</span>
                                                                       <span class="n">_fs_path_to_browse</span><span class="p">,</span>
                                                                       <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">destination_client</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">fs_restore_dest</span><span class="p">,</span>
                                                                       <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">,</span>
                                                                       <span class="n">_preserve_level</span><span class="p">,</span>
                                                                       <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                                                                       <span class="n">browse_ma</span><span class="o">=</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">browse_ma</span><span class="p">,</span>
                                                                       <span class="n">fbr_ma</span><span class="o">=</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">fbr_ma</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs_restore_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to run file level restore  job with error: &quot;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">fs_restore_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;file level restore  Job got complete JOb Id:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fs_restore_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>

                    <span class="c1"># File level Validation</span>
                    <span class="n">dest_client</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">fs_restore_options</span><span class="o">.</span><span class="n">destination_client</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fs_testdata_validation</span><span class="p">(</span>
                        <span class="n">dest_client</span><span class="p">,</span> <span class="n">dest_client</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs_restore_dest</span><span class="p">,</span>
                                                           <span class="s2">&quot;TestData&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
                                                           <span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">metadata_collected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">browse_from_snap</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">block_level_validation</span><span class="p">(</span><span class="n">disk_count_before_restore</span><span class="p">,</span> <span class="n">_vm</span><span class="p">,</span>
                                                        <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">_browse_ma_client_name</span><span class="p">)</span>

                    <span class="c1"># vmware live file cleanup validation</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">==</span> <span class="s2">&quot;vmware&quot;</span> <span class="ow">and</span> <span class="n">fs_restore_options</span><span class="o">.</span><span class="n">browse_from_snap</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vmware_live_browse_validation</span><span class="p">(</span><span class="n">_vm</span><span class="p">,</span> <span class="n">disk_count_before_restore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_id</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">backupcopy_job_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Ran file level restore from all the VMs and its drives&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception at restore job please check logs for more details </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restore: FAIL - File level files Restore Failed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.get_extent_count"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_extent_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_extent_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">db_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the extent number of extetnts in live browse DB</span>
<span class="sd">        Args:</span>
<span class="sd">            db_path                 (str):  db folder path of the livebrowse db</span>

<span class="sd">            db_name                 (str):  db file path of the livebrowse db</span>

<span class="sd">        Returns:</span>
<span class="sd">            extent_count            (int):  Number of extents in DB currently</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to get the extent count</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">utils_path</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exe_file_path</span><span class="p">:</span>
                <span class="n">extent_count_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils_path</span><span class="p">,</span> <span class="s2">&quot;Extentcount.py&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extent_count_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
                    <span class="n">_script</span> <span class="o">=</span> <span class="n">f_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">_script</span> <span class="o">=</span> <span class="n">_script</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\xef\xbb\xbf</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">db_argument_list</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;##Automation--([\w_]*)--##&#39;</span><span class="p">,</span> <span class="n">_script</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">db_argument_list</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_name</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">_script</span> <span class="o">=</span> <span class="n">_script</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;##Automation--</span><span class="si">{0}</span><span class="s1">--##&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argument</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

                <span class="n">extent_count_temp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils_path</span><span class="p">,</span> <span class="s2">&quot;Extentcounttemp.py&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">extent_count_temp_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_obj</span><span class="p">:</span>
                    <span class="n">f_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_script</span><span class="p">)</span>
                    <span class="n">f_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">exe_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">generate_executable</span><span class="p">(</span><span class="n">extent_count_temp_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">copy_from_local</span><span class="p">(</span><span class="n">exe_file</span><span class="p">,</span> <span class="n">db_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">exe_file</span><span class="p">)</span>

                <span class="n">_exe_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">exe_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">check_file_exists</span><span class="p">(</span><span class="n">_exe_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exe_file_path</span> <span class="o">=</span> <span class="n">_exe_file</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to copy the extent exe folder&quot;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;iex &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&amp; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exe_file_path</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&#39;\&quot;</span><span class="s2">&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An exception occurred in getting extent count </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.block_level_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.block_level_validation">[docs]</a>    <span class="k">def</span> <span class="nf">block_level_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_count_before_restore</span><span class="p">,</span> <span class="n">_vm</span><span class="p">,</span> <span class="n">browse_ma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perfoms Windows Block level validation</span>
<span class="sd">        Args:</span>
<span class="sd">            disk_count_before_restore               (str):  disk count of Ma before performing</span>
<span class="sd">                                                            guest file restore</span>

<span class="sd">            _vm                                     (str):  backup Vm for which guest level</span>
<span class="sd">                                                            restore is performed</span>

<span class="sd">            browse_ma                               (str):  Ma used for guest file restore</span>
<span class="sd">                                                            browse</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                When block level validation fails</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pre_extent_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;performing pruning validation on Browse MA </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">browse_ma</span><span class="p">))</span>
            <span class="n">_browse_ma_jr_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_job_results_dir</span><span class="p">(</span><span class="n">browse_ma</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">wait_time</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">:</span>
                    <span class="n">db_path</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">get_live_browse_db_path</span><span class="p">(</span><span class="n">_browse_ma_jr_dir</span><span class="p">)</span>
                    <span class="n">db_name</span> <span class="o">=</span> <span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">find_live_browse_db_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="p">,</span> <span class="n">db_path</span><span class="p">)</span>
                    <span class="n">current_extent_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extent_count</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">db_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">current_extent_count</span> <span class="o">&gt;</span> <span class="n">pre_extent_count</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extentshould have reduced butincreasedwill waitfor 3 error&quot;</span><span class="p">)</span>
                        <span class="n">error_count</span> <span class="o">=</span> <span class="n">error_count</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">error_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pruning is not happening , please check logs&quot;</span><span class="p">)</span>

                    <span class="n">pre_extent_count</span> <span class="o">=</span> <span class="n">current_extent_count</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for 2 mins for next check&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
                    <span class="n">wait_time</span> <span class="o">=</span> <span class="n">wait_time</span> <span class="o">+</span> <span class="mi">120</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">700</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;performing Post un-mount validation&quot;</span><span class="p">)</span>
            <span class="c1"># disk Un-mount validation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disk_count_validation</span><span class="p">(</span><span class="n">disk_count_before_restore</span><span class="p">)</span>
            <span class="c1"># Path CleanUp Validation</span>
            <span class="n">live_browse_mount_path</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">get_live_browse_mount_path</span><span class="p">(</span>
                <span class="n">_browse_ma_jr_dir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GUID</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="p">)</span>
            <span class="n">files_in_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">get_files_in_path</span><span class="p">(</span><span class="n">live_browse_mount_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">files_in_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not files are cleaned after Live browse, please check the folder </span><span class="si">%s</span><span class="s2">&quot;</span>
                              <span class="o">%</span> <span class="n">live_browse_mount_path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Staging Path CleanUp Failed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Staging Path </span><span class="si">%s</span><span class="s2"> was cleaned successfully&quot;</span><span class="p">,</span> <span class="n">live_browse_mount_path</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed in performing Block Level Validation&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.fs_testdata_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.fs_testdata_validation">[docs]</a>    <span class="k">def</span> <span class="nf">fs_testdata_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_client</span><span class="p">,</span> <span class="n">dest_location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does Validation of Backed up and data restored from file level</span>

<span class="sd">        Args:</span>
<span class="sd">                dest_client     (obj)   -   Machine class object of Destination client</span>

<span class="sd">                dest_location   (str)   - destination location of file level restore job</span>


<span class="sd">        Exception</span>
<span class="sd">                if folder comparison fails</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsaclient</span><span class="o">.</span><span class="n">fs_testdata_validation</span><span class="p">(</span><span class="n">dest_client</span><span class="o">=</span><span class="n">dest_client</span><span class="p">,</span>
                                                   <span class="n">source_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdata_path</span><span class="p">,</span>
                                                   <span class="n">dest_location</span><span class="o">=</span><span class="n">dest_location</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoVSASubclient.disk_restore"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.disk_restore">[docs]</a>    <span class="k">def</span> <span class="nf">disk_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_restore_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        perform Disk restore for specific subclinet</span>

<span class="sd">        Args:</span>
<span class="sd">                disk_restore_options  (obj)  - represent options that need to be set</span>
<span class="sd">                                                    while performing disk  restore</span>

<span class="sd">        Exception:</span>
<span class="sd">                        if job fails</span>
<span class="sd">                        if validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">disk_restore_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">disk_restore_options</span><span class="o">.</span><span class="n">restore_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span> <span class="n">_vm</span><span class="p">)</span>

                <span class="c1"># &quot;&quot;&quot;</span>
                <span class="n">disk_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">disk_restore</span><span class="p">(</span>
                    <span class="n">_vm</span><span class="p">,</span> <span class="n">proxy_client</span><span class="o">=</span><span class="n">disk_restore_options</span><span class="o">.</span><span class="n">destination_client</span><span class="p">,</span>
                    <span class="n">destination_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_restore_dest</span><span class="p">,</span>
                    <span class="n">copy_precedence</span><span class="o">=</span><span class="n">disk_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">disk_restore_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Failed to run disk  level restore  job with error: &quot;</span> <span class="o">+</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">disk_restore_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disk restore job completed successfully with job id </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">disk_restore_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
                <span class="c1"># &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
                    <span class="c1"># Commenting out validation for vmware disk level restore for now</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">==</span> <span class="s2">&quot;vmware&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">disk_validation</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">],</span>
                            <span class="n">disk_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">disk_restore_dest</span><span class="p">,</span>
                            <span class="n">disk_restore_options</span><span class="o">.</span><span class="n">client_machine</span><span class="p">)</span>

                <span class="n">dest_client_hypervisor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">_create_hypervisor_object</span><span class="p">(</span>
                    <span class="n">disk_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">)</span>
                <span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_restore_dest</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred please check logs&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Disk Restore Job failed, please check agent logs </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span></div>

<div class="viewcode-block" id="AutoVSASubclient.disk_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.disk_validation">[docs]</a>    <span class="k">def</span> <span class="nf">disk_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_obj</span><span class="p">,</span> <span class="n">destination_client_name</span><span class="p">,</span> <span class="n">disk_restore_destination</span><span class="p">,</span> <span class="n">dest_machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs Disk Validation by mounting the restored disk on the Host</span>

<span class="sd">        Args:</span>

<span class="sd">        _vm                     (str)   - object of VMHelper class</span>

<span class="sd">        destination_client_name    (str)   - Pseudo  client name of the destination client</span>

<span class="sd">        disk_restore_destination    (str)   - restore path of all the disk</span>

<span class="sd">        dest_machine    (obj) - destimation client where disk restores are performed</span>

<span class="sd">        Exception:</span>
<span class="sd">                        if job fails</span>
<span class="sd">                        if validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performed Restore in client </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                          <span class="n">destination_client_name</span><span class="p">)</span>
            <span class="n">dest_client_hypervisor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">_create_hypervisor_object</span><span class="p">(</span>
                <span class="n">destination_client_name</span><span class="p">)</span>

            <span class="n">_list_of_disks</span> <span class="o">=</span> <span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">get_disk_in_the_path</span><span class="p">(</span><span class="n">disk_restore_destination</span><span class="p">)</span>

            <span class="n">_vm_disk_list</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">disk_list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_vm_disk_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot validate the Disk as we cannot find the disk attached to the VM&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">_list_of_disks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">_list_of_disks</span> <span class="o">==</span> <span class="p">[])):</span>
                <span class="n">_final_mount_disk_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">each_disk</span> <span class="ow">in</span> <span class="n">_vm_disk_list</span><span class="p">:</span>
                    <span class="n">each_disk_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">each_disk</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">disk_path</span> <span class="ow">in</span> <span class="n">_list_of_disks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">each_disk_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">disk_path</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">_final_mount_disk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disk_path</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;the Disk cannot be validated as we cannot find disk with Hypervisor extension,</span><span class="se">\</span>
<span class="s2">                                                                could be converted disk&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_final_mount_disk_list</span><span class="p">:</span>
                <span class="n">_final_mount_disk_list</span> <span class="o">=</span> <span class="n">_list_of_disks</span>

            <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">_final_mount_disk_list</span><span class="p">:</span>

                <span class="n">_file</span> <span class="o">=</span> <span class="n">disk_restore_destination</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validation Started For Disk :[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">_file</span><span class="p">)</span>
                <span class="n">_drive_letter</span> <span class="o">=</span> <span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">mount_disk</span><span class="p">(</span><span class="n">vm_obj</span><span class="p">,</span> <span class="n">_file</span><span class="p">,</span> <span class="n">dest_machine</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_drive_letter</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">each_drive</span> <span class="ow">in</span> <span class="n">_drive_letter</span><span class="p">:</span>
                        <span class="n">dest_folder_path</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">get_folder_to_be_compared</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span> <span class="n">each_drive</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Folder comparison started...&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fs_testdata_validation</span><span class="p">(</span>
                            <span class="n">dest_machine</span><span class="p">,</span> <span class="n">dest_folder_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ERROR - Error mounting VMDK &quot;</span> <span class="o">+</span> <span class="n">_file</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception at Mounting Disk &quot;</span><span class="p">)</span>

                <span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">un_mount_disk</span><span class="p">(</span><span class="n">vm_obj</span><span class="p">,</span> <span class="n">_file</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred please check logs&quot;</span><span class="p">)</span>
            <span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">un_mount_disk</span><span class="p">(</span><span class="n">vm_obj</span><span class="p">,</span> <span class="n">_file</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.virtual_machine_restore"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.virtual_machine_restore">[docs]</a>    <span class="k">def</span> <span class="nf">virtual_machine_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        perform Full VM restore for specific subclient</span>

<span class="sd">        Args:</span>
<span class="sd">                vm_restore_options  -options that need to be set while performing vm  restore</span>

<span class="sd">        Exception:</span>
<span class="sd">                        if job fails</span>
<span class="sd">                        if validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1">#&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">in_place_overwrite</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">hyperv</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_in_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">,</span>
                        <span class="n">add_to_failover</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">register_with_failover</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">vmware</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_in_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">azureRM</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_in_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">fusion_compute</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_in_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">proxy_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">proxy_client</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="n">hv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hyper-v&quot;</span><span class="p">:</span> <span class="n">hyperv</span><span class="p">,</span> <span class="s2">&quot;vmware&quot;</span><span class="p">:</span> <span class="n">vmware</span><span class="p">,</span> <span class="s2">&quot;azure resource manager&quot;</span><span class="p">:</span> <span class="n">azureRM</span><span class="p">,</span>
                           <span class="s2">&quot;fusioncompute&quot;</span><span class="p">:</span> <span class="n">fusion_compute</span><span class="p">}</span>
                <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="p">(</span><span class="n">hv_dict</span><span class="p">[</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_auto_vsa_instance</span><span class="o">.</span><span class="n">vsa_instance_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()])()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">hyperv</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">:</span>
                        <span class="n">vm_restore_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_path</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vm_restore_dest</span> <span class="o">=</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_path</span>
                    <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_path</span> <span class="o">=</span> <span class="n">vm_restore_dest</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_out_of_place</span><span class="p">(</span>
                        <span class="n">destination_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">,</span>
                        <span class="n">proxy_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">proxy_client</span><span class="p">,</span>
                        <span class="n">destination_path</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_path</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">,</span>
                        <span class="n">add_to_failover</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">register_with_failover</span><span class="p">,</span>
                        <span class="n">restore_option</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">advanced_restore_options</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">fusion_compute</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_out_of_place</span><span class="p">(</span>
                        <span class="n">destination_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">,</span>
                        <span class="n">proxy_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">proxy_client</span><span class="p">,</span>
                        <span class="n">datastore</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">datastore</span><span class="p">,</span>
                        <span class="n">host</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">vmware</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_out_of_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">proxy_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">proxy_client</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">,</span>
                        <span class="n">vcenter_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_dest_client_name</span><span class="p">,</span>
                        <span class="n">datastore</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_datastore</span><span class="p">,</span>
                        <span class="n">esx_host</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_host</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">source_ip</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">source_ip</span><span class="p">,</span>
                        <span class="n">destination_ip</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_ip</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">azure</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_out_of_place</span><span class="p">(</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">,</span>
                        <span class="n">resource_group</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">Resource_Group</span><span class="p">,</span>
                        <span class="n">storage_account</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">Storage_account</span><span class="p">,</span>
                        <span class="n">restore_option</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">advanced_restore_options</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="k">def</span> <span class="nf">oraclevm</span><span class="p">():</span>
                    <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">full_vm_restore_out_of_place</span><span class="p">(</span>
                        <span class="n">virtualization_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">,</span>
                        <span class="n">destination_client</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">proxy_client</span><span class="p">,</span>
                        <span class="n">repository</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">datastore</span><span class="p">,</span>
                        <span class="n">server</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">unconditional_overwrite</span><span class="p">,</span>
                        <span class="n">power_on</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">,</span>
                        <span class="n">copy_precedence</span><span class="o">=</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">vm_restore_job</span>

                <span class="n">hv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hyper-v&quot;</span><span class="p">:</span> <span class="n">hyperv</span><span class="p">,</span> <span class="s2">&quot;fusioncompute&quot;</span><span class="p">:</span> <span class="n">fusion_compute</span><span class="p">,</span>
                           <span class="s2">&quot;vmware&quot;</span><span class="p">:</span> <span class="n">vmware</span><span class="p">,</span> <span class="s2">&quot;oraclevm&quot;</span><span class="p">:</span> <span class="n">oraclevm</span><span class="p">,</span> <span class="s2">&quot;azure resource manager&quot;</span><span class="p">:</span> <span class="n">azure</span><span class="p">}</span>
                <span class="n">vm_restore_job</span> <span class="o">=</span> <span class="p">(</span><span class="n">hv_dict</span><span class="p">[</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_auto_vsa_instance</span><span class="o">.</span><span class="n">vsa_instance_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()])()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">vm_restore_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run VM  restore  job with error: &quot;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">vm_restore_job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">validation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vm_restore_validator</span><span class="p">(</span><span class="n">vm_restore_options</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception while submitting Restore job:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.vm_restore_validator"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.vm_restore_validator">[docs]</a>    <span class="k">def</span> <span class="nf">vm_restore_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="p">,</span> <span class="n">type_of_content</span><span class="o">=</span><span class="s2">&quot;VM&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            vm_restore_options              (str):  options that need to be set while performing vm restore</span>

<span class="sd">            type_of_content                 (string):   type of content of a subclient</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_of_content</span> <span class="o">==</span> <span class="s2">&quot;template&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">convert_template_to_vm</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">in_place_overwrite</span><span class="p">:</span>
                    <span class="n">restore_vm_name</span> <span class="o">=</span> <span class="n">vm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">restore_vm_name</span> <span class="o">=</span> <span class="s2">&quot;Delete&quot;</span> <span class="o">+</span> <span class="n">vm</span>
                <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">restore_backup_job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_restore_validation</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">restore_vm_name</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="p">,</span> <span class="s1">&#39;Basic&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vm_restore_validation</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">restore_vm_name</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception while submitting Restore job:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.vm_restore_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.vm_restore_validation">[docs]</a>    <span class="k">def</span> <span class="nf">vm_restore_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">restore_vm</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;Advanced&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Param:</span>
<span class="sd">             vm:                     -  Source Vm name</span>
<span class="sd">             restore_vm:             -  Restored VM Name</span>
<span class="sd">             vm_restore_options      -  options of VM restore options class</span>
<span class="sd">             prop                    -  only validate basic or advanced properties</span>
<span class="sd">        Exception:</span>
<span class="sd">            if validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># self.hvobj.VMs[vm].update_vm_info(&#39;All&#39;)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
            <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">update_hosts</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">in_place_overwrite</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;it is Inplace restore&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span>

            <span class="n">on_premise</span> <span class="o">=</span> <span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">on_premise_hypervisor</span><span class="p">(</span>
                <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">power_on_after_restore</span><span class="p">:</span>
                <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">VMs</span> <span class="o">=</span> <span class="n">restore_vm</span>
                <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">restore_vm</span><span class="p">]</span><span class="o">.</span><span class="n">update_vm_info</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">os_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span> <span class="o">=</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_client_hypervisor</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">restore_vm</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">in_place_overwrite</span> <span class="ow">and</span> <span class="n">on_premise</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">GUID</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">GUID</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The GUID id of the in place restored VM does not match the source VM&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">NoofCPU</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">NoofCPU</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The CPU count does not match for the source and restored VM&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">Diskcount</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">Diskcount</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The disk count does not match for the source and restored VM&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Basic&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">Ip_regex</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">IP</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The IP address of the restored VM is not of the proper format&quot;</span>
                                        <span class="s2">&quot;. Boot validation failed.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">VirtualServerConstants</span><span class="o">.</span><span class="n">Ip_regex</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">IP</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">IP</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disk_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

                        <span class="k">for</span> <span class="n">each_drive</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">drive_list</span><span class="p">:</span>
                            <span class="n">dest_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="o">.</span><span class="n">drive_list</span><span class="p">[</span><span class="n">each_drive</span><span class="p">],</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">backup_folder_name</span><span class="p">,</span> <span class="s2">&quot;TestData&quot;</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fs_testdata_validation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restore_obj</span><span class="o">.</span><span class="n">machine</span><span class="p">,</span> <span class="n">dest_location</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Skipping test data validation ,&quot;</span>
                            <span class="s2">&quot;because the VM might be running a UNIX OS or the provided subclient have filters applied&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">in_place_overwrite</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">on_premise</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">==</span> <span class="s2">&quot;hyper-v&quot;</span><span class="p">:</span>
                    <span class="n">dest_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vm_restore_options</span><span class="o">.</span><span class="n">destination_path</span><span class="p">,</span> <span class="n">restore_vm</span><span class="p">,</span> <span class="s2">&quot;Virtual Hard Disks&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disk_validation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_obj</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">_destination_pseudo_client</span><span class="p">,</span>
                                         <span class="n">dest_location</span><span class="p">,</span> <span class="n">vm_restore_options</span><span class="o">.</span><span class="n">dest_machine</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping disk validation for powered off restored vm for </span><span class="si">{0}</span><span class="s2"> instance&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">instance_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This is Linux VM and the destination Ip is not proper,&quot;</span>
                              <span class="s2">&quot; so no Data Validation cannot be performed&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred in VM restore validation &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in VM restore validation&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception occurred in VM restore validation &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in VM restore validation&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_all_backup_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the backup jobs for the subclient</span>
<span class="sd">        :return:</span>
<span class="sd">            job_history     (dict)  -   all the unaged jobs for that subclient</span>
<span class="sd">                Ex:</span>
<span class="sd">                    {&#39;job_cycle_1&#39;: {&#39;bkp_level_full&#39;:  {&#39;job_id&#39;:[&#39;aux_copy_jobid_1&#39;,&#39;aux_2&#39;]},</span>
<span class="sd">                                     &#39;bkp_level_incr&#39;: {&#39;job_id1&#39;:[&#39;aux1&#39;,&#39;aux2&#39;],</span>
<span class="sd">                                                        &#39;job_id2&#39;:[&#39;aux1&#39;,&#39;aux2&#39;]}</span>
<span class="sd">                                    },</span>
<span class="sd">                     &#39;job_cycle_2&#39;: {&#39;bkp_level_synth&#39;: {&#39;job_id&#39;:[&#39;aux1&#39;,&#39;aux2&#39;]}</span>
<span class="sd">                                    }</span>
<span class="sd">                    }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_history</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot;select distinct BS.jobID, BS.bkpLevel, BS.fullCycleNum, DS.auxCopyJobId &quot;</span> \
                 <span class="s2">&quot;from JMBkpStats as BS join JMJobDataStats as DS ON BS.jobId = DS.jobId &quot;</span> \
                 <span class="s2">&quot;where BS.agedTime = 0 and BS.appId=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>

        <span class="n">_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">_results</span><span class="p">:</span>
            <span class="n">cycle_num</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">aux_copy</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cycle_num</span> <span class="ow">in</span> <span class="n">job_history</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">aux_jobs</span> <span class="o">=</span> <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="n">job_id</span><span class="p">]</span>
                        <span class="n">aux_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_copy</span><span class="p">)</span>
                        <span class="n">aux_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aux_jobs</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">aux_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux_jobs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux_copy</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">[</span><span class="n">aux_copy</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">level</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="n">job_history</span><span class="p">[</span><span class="n">cycle_num</span><span class="p">][</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">job_id</span><span class="p">:</span> <span class="p">[</span><span class="n">aux_copy</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">job_history</span>

<div class="viewcode-block" id="AutoVSASubclient.create_ini_files"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.create_ini_files">[docs]</a>    <span class="k">def</span> <span class="nf">create_ini_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a temp folder and files for storing and verifying changeID</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to create temp folder and files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
            <span class="n">path_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">path_dir</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">path_dir</span><span class="p">)</span>

            <span class="n">current_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_current_timestamp_folder</span><span class="p">(</span><span class="n">path_dir</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">)</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_current_timestamp_folder</span><span class="p">(</span><span class="n">current_date</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="s2">&quot;cbtStats.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;$null&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="s2">&quot;usedChangeIDStatus.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;$null&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while creating files&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.get_changeid_from_metadata"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_changeid_from_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_changeid_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">,</span> <span class="n">backupjobid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get changeID generated for given backup job</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_type    (String) - FULL/INCR/DIFF/SYNTH_FULL</span>
<span class="sd">                backupjobid    (int) - job ID of the backup job</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to get end time of given job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
            <span class="n">path_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">path_dir</span><span class="p">)</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">curfolder</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">_instance_name</span> <span class="o">==</span> <span class="s1">&#39;hyper-v&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                    <span class="n">vmguid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GUID</span>
                    <span class="n">pathtoBrowse</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vmguid</span>
                    <span class="n">fileToWriteTo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfolder</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cbtStats.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
                    <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">backup_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">each_vm</span> <span class="o">+</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">backupjobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">backupjobid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">find_latest_job</span><span class="p">(</span><span class="n">include_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">backupjobid</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span> <span class="n">pathtoBrowse</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_changeid_tofile</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pathtoBrowse</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
                <span class="n">fileToWriteTo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfolder</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cbtStats.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">backup_type</span> <span class="o">+</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">backupjobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">backupjobid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">find_latest_job</span><span class="p">(</span><span class="n">include_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">backupjobid</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span> <span class="n">pathtoBrowse</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_changeid_tofile</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while getting changeID from Metadata&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.get_metadata"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backupjobid</span><span class="p">,</span> <span class="n">Pathtobrowse</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get metadata for given backup job using browse request</span>

<span class="sd">        Args:</span>
<span class="sd">                backupjobid    (int) - job ID of the backup job</span>
<span class="sd">                Pathtobrowse   (int)   Guid of VM</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to get metdata from brose request</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pathtobrowse</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_subclient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_id</span>
            <span class="n">_backup_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">backupjobid</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">datetime</span>
            <span class="n">temp_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">_backup_job</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">from_time</span> <span class="o">=</span> <span class="n">temp_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">from_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">from_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">temp_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">_backup_job</span><span class="o">.</span><span class="n">_end_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">temp_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;from_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_time</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;to_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;media_agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse_ma</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show_deleted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">_instance_name</span> <span class="o">==</span> <span class="s1">&#39;hyper-v&#39;</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;vm_disk_browse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">paths</span><span class="p">,</span> <span class="n">response_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsa_backupset</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response_json</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while getting metadata using browse request&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.write_changeid_tofile"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.write_changeid_tofile">[docs]</a>    <span class="k">def</span> <span class="nf">write_changeid_tofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and write changeID generated for given backupjob to cbtStats.ini file</span>

<span class="sd">        Args:</span>
<span class="sd">                response_json    (string) Browse response received for given VM</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to find and write changeID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Open the file to write to</span>
            <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
            <span class="n">path_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">path_dir</span><span class="p">)</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">curfolder</span><span class="p">)</span>
            <span class="n">fileToWriteTo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfolder</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">cbtStats.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">_instance_name</span> <span class="o">==</span> <span class="s1">&#39;azure resource manager&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response_json</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                            <span class="n">path_name</span> <span class="o">=</span> <span class="n">value1</span>
                        <span class="k">if</span> <span class="s1">&#39;advanced_data&#39;</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="s1">&#39;browseMetaData&#39;</span> <span class="ow">in</span> <span class="n">key2</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">key3</span><span class="p">,</span> <span class="n">value3</span> <span class="ow">in</span> <span class="n">value2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="s1">&#39;virtualServerMetaData&#39;</span> <span class="ow">in</span> <span class="n">key3</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">key4</span><span class="p">,</span> <span class="n">value4</span> <span class="ow">in</span> <span class="n">value3</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                                <span class="k">if</span> <span class="s1">&#39;changeId&#39;</span> <span class="ow">in</span> <span class="n">key4</span><span class="p">:</span>
                                                    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
                                                    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">value4</span><span class="p">))</span>
                                                    <span class="n">tree_ID</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;recentFullReferencePoint&#39;</span><span class="p">]</span>
                                                    <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">tree_ID</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response_json</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                            <span class="n">path_name</span> <span class="o">=</span> <span class="n">value1</span>
                        <span class="k">if</span> <span class="s1">&#39;advanced_data&#39;</span> <span class="ow">in</span> <span class="n">key1</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="s1">&#39;browseMetaData&#39;</span> <span class="ow">in</span> <span class="n">key2</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">key3</span><span class="p">,</span> <span class="n">value3</span> <span class="ow">in</span> <span class="n">value2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="s1">&#39;virtualServerMetaData&#39;</span> <span class="ow">in</span> <span class="n">key3</span><span class="p">:</span>
                                            <span class="k">for</span> <span class="n">key4</span><span class="p">,</span> <span class="n">value4</span> <span class="ow">in</span> <span class="n">value3</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                                <span class="k">if</span> <span class="s1">&#39;changeId&#39;</span> <span class="ow">in</span> <span class="n">key4</span><span class="p">:</span>
                                                    <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_name</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">value4</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while finding and writing changeID to file &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.parse_diskcbt_stats"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.parse_diskcbt_stats">[docs]</a>    <span class="k">def</span> <span class="nf">parse_diskcbt_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbtstat_folder</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and copy cbt_stat file from hyperv to controller machine.</span>
<span class="sd">        And write changedID used by given backup to usedChangeIDStatus.ini file</span>

<span class="sd">        Args:</span>
<span class="sd">                cbtstat_folder    (string) Folder to which CBT stats are stored on HyperV</span>
<span class="sd">                backup_type      (string) FULL/INCR/DIFF/SYNTH_FULL</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to find and write changeID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="c1"># get CBTstat file and copy it on local system</span>
                <span class="n">vmguid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GUID</span>
                <span class="n">vmcbtstat_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cbtstat_folder</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vmguid</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">:</span>
                    <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">vmcbtstat_folder</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
                <span class="n">cbt_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
                <span class="n">cbt_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBTStats&quot;</span><span class="p">)</span>
                <span class="n">destvmcbt_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cbt_stat</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vmguid</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">is_local_machine</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">):</span>
                        <span class="n">proxy_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">)</span>
                    <span class="n">proxy_machine</span><span class="o">.</span><span class="n">copy_folder</span><span class="p">(</span><span class="n">vmcbtstat_folder</span><span class="p">,</span> <span class="n">destvmcbt_stat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">vmcbtstat_folder</span><span class="p">)</span>
                    <span class="n">host_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_hostname_for_client</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">)</span>
                    <span class="n">remote_vmcbtstat_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">host_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">copy_files_from_network_share</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">,</span> <span class="n">remote_vmcbtstat_folder</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
                <span class="n">proxy_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">vmcbtstat_folder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copied CBTstat folder at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">))</span>

                <span class="c1"># Find and write changeID used</span>
                <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">cbt_folder</span><span class="p">)</span>
                <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">curfolder</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfolder</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">usedChangeIDStatus.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">backup_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">each_vm</span> <span class="o">+</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">paths1</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">))[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">paths1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;avhdx.txt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;.vhd&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;.vhdx&quot;</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">previousChangedIDUsed</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diskName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                    <span class="n">statsFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">statsFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;ChangeId from previous job : &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">changeIDLine</span> <span class="o">=</span> <span class="n">line</span>
                            <span class="n">subStrChangeID</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
                            <span class="n">subStrChangeID2</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
                            <span class="n">lenLine</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="n">changeID</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="p">[</span><span class="n">subStrChangeID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">subStrChangeID2</span><span class="p">]</span>
                            <span class="n">indexDash</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                            <span class="n">diskName</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="n">indexDash</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span>
                            <span class="n">previousChangedIDUsed</span><span class="p">[</span><span class="n">diskName</span><span class="p">]</span> <span class="o">=</span> <span class="n">changeID</span>
                            <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">diskName</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">changeID</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">statsFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while parsing and writing used changeID to file &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.parse_diskcbt_stats_azure"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.parse_diskcbt_stats_azure">[docs]</a>    <span class="k">def</span> <span class="nf">parse_diskcbt_stats_azure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the changedID from the log files on the proxy and copy it to the controller</span>
<span class="sd">        And write changedID used by given backup to usedChangeIDStatus.ini file</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_type      (string) FULL/INCR/DIFF/SYNTH_FULL</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to find and write changeID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vmlog_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;vsbkp.log&#39;</span><span class="p">)</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">find_latest_job</span><span class="p">(</span><span class="n">include_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">:</span>
                <span class="n">proxy_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">vmlog_file</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
            <span class="n">cbt_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
            <span class="n">cbt_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBTStats&quot;</span><span class="p">)</span>
            <span class="n">destvmcbt_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">cbt_stat</span><span class="p">,</span> <span class="n">job_id</span><span class="o">.</span><span class="n">_job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">is_local_machine</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">proxy_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">):</span>
                    <span class="n">proxy_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">)</span>
                <span class="n">proxy_machine</span><span class="o">.</span><span class="n">_copy_file_from_local</span><span class="p">(</span><span class="n">vmlog_file</span><span class="p">,</span> <span class="n">destvmcbt_stat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dest_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">vmlog_file</span><span class="p">)</span>
                <span class="n">host_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_hostname_for_client</span><span class="p">(</span><span class="n">each_proxy</span><span class="p">)</span>
                <span class="n">remote_vmcbtstat_folder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">host_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dest_base_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">copy_files_from_network_share</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">,</span> <span class="n">remote_vmcbtstat_folder</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copied log file at </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destvmcbt_stat</span><span class="p">))</span>

            <span class="c1"># Find and write changeID used</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">cbt_folder</span><span class="p">)</span>
            <span class="n">curfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">curfolder</span><span class="p">)</span>
            <span class="n">fileToWriteTo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curfolder</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">usedChangeIDStatus.ini&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[&quot;</span> <span class="o">+</span> <span class="n">backup_type</span> <span class="o">+</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">err_occur</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="o">.</span><span class="n">_job_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s1">&#39;CAzureInfo::InitCBT()&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vmlog_file</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">linenum</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">err_occur</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">err_occur</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Line &quot;</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;Change Id has been supplied&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">changeIDLine</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="n">subStrChangeID</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
                        <span class="n">subStrChangeID2</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="n">vm_name</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="p">[</span><span class="n">subStrChangeID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">subStrChangeID2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;Using SnapshotID &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">changeIDLine</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="n">subStrChangeID</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
                        <span class="n">subStrChangeID2</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
                        <span class="n">changeID</span> <span class="o">=</span> <span class="n">changeIDLine</span><span class="p">[</span><span class="n">subStrChangeID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">subStrChangeID2</span><span class="p">]</span>
                        <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vm_name</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">changeID</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fileToWriteTo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while parsing and writing used changeID to file &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>


<div class="viewcode-block" id="AutoVSASubclient.verify_changeid_used"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.verify_changeid_used">[docs]</a>    <span class="k">def</span> <span class="nf">verify_changeid_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare and verify if changeID generated by previous backupjob is used by next</span>
<span class="sd">        backup job</span>

<span class="sd">        Args:</span>
<span class="sd">                backup_type      (string) FULL/INCR/DIFF/SYNTH_FULL</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to verify the changeID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">configparser</span>
            <span class="n">_vserver_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">VirtualServerUtils</span><span class="o">.</span><span class="n">UTILS_PATH</span><span class="p">)</span>
            <span class="n">cbt_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">_vserver_path</span><span class="p">,</span> <span class="s2">&quot;TestCases&quot;</span><span class="p">,</span> <span class="s2">&quot;CBT&quot;</span><span class="p">)</span>
            <span class="n">currentfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">cbt_folder</span><span class="p">)</span>
            <span class="n">currentfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">get_latest_timestamp_file_or_folder</span><span class="p">(</span><span class="n">currentfolder</span><span class="p">)</span>
            <span class="n">changeid_generatedfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">currentfolder</span><span class="p">,</span> <span class="s2">&quot;cbtStats.ini&quot;</span><span class="p">)</span>
            <span class="n">changeid_usedfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller_machine</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">currentfolder</span><span class="p">,</span> <span class="s2">&quot;usedChangeIDStatus.ini&quot;</span><span class="p">)</span>
            <span class="n">Config_Curr</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">Config_Curr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">changeid_usedfile</span><span class="p">)</span>
            <span class="n">Config_Prev</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">Config_Prev</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">changeid_generatedfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_type</span> <span class="ow">is</span> <span class="s2">&quot;DIFFERENTIAL&quot;</span><span class="p">:</span>
                <span class="n">cmp_bk_type</span> <span class="o">=</span> <span class="s2">&quot;FULL&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmp_bk_type</span> <span class="o">=</span> <span class="s2">&quot;INCREMENTAL&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">vsa_instance</span><span class="o">.</span><span class="n">_instance_name</span> <span class="o">==</span> <span class="s1">&#39;hyper-v&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Config_Prev</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">cmp_bk_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">each_vm</span><span class="p">):</span>
                        <span class="n">cmp_bk_type</span> <span class="o">=</span> <span class="s2">&quot;FULL&quot;</span>
                    <span class="n">currentDict</span> <span class="o">=</span> <span class="n">Config_Prev</span><span class="p">[</span><span class="n">cmp_bk_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">each_vm</span><span class="p">]</span>
                    <span class="n">previousDict</span> <span class="o">=</span> <span class="n">Config_Curr</span><span class="p">[</span><span class="n">backup_type</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">each_vm</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">curKey</span> <span class="ow">in</span> <span class="n">currentDict</span><span class="p">:</span>
                        <span class="n">new_key</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ide\w+\-\w\-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">curKey</span><span class="p">)</span>
                        <span class="n">new_key</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^scsi\w+\-\w\-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">currentDict</span><span class="p">[</span><span class="n">curKey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">previousDict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Used incorrect change IDs for </span><span class="si">{0}</span><span class="s2"> backup for Disk </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span>
                                                                                              <span class="n">curKey</span><span class="p">))</span>
                            <span class="k">return</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Used correct change IDs for </span><span class="si">{0}</span><span class="s2"> backup Disk </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span> <span class="n">curKey</span><span class="p">))</span>

                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Config_Prev</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">cmp_bk_type</span> <span class="p">):</span>
                    <span class="n">cmp_bk_type</span> <span class="o">=</span> <span class="s2">&quot;FULL&quot;</span>
                <span class="n">currentDict</span> <span class="o">=</span> <span class="n">Config_Prev</span><span class="p">[</span><span class="n">cmp_bk_type</span><span class="p">]</span>
                <span class="n">previousDict</span> <span class="o">=</span> <span class="n">Config_Curr</span><span class="p">[</span><span class="n">backup_type</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">curKey</span> <span class="ow">in</span> <span class="n">currentDict</span><span class="p">:</span>
                    <span class="n">new_key</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ide\w+\-\w\-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">curKey</span><span class="p">)</span>
                    <span class="n">new_key</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^scsi\w+\-\w\-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">currentDict</span><span class="p">[</span><span class="n">curKey</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">previousDict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Used incorrect change IDs for </span><span class="si">{0}</span><span class="s2"> backup for VM </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span>
                                                                                          <span class="n">curKey</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;Used correct change IDs for </span><span class="si">{0}</span><span class="s2"> backup VM </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">backup_type</span><span class="p">,</span> <span class="n">curKey</span><span class="p">))</span>

                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while verifying changeID used by job &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.check_migrate_vm"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.check_migrate_vm">[docs]</a>    <span class="k">def</span> <span class="nf">check_migrate_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if more than one proxy/node is available and migrate to best possible node</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to check/migrate the vm</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_vsainstance</span><span class="o">.</span><span class="n">proxy_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;More than one node available to migrate the VM&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">each_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">migrate_vm</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">each_vm</span><span class="p">]</span><span class="o">.</span><span class="n">recheck_vm_host</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No other host is available for migration&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An Exception occurred while checking and if possible migrating VM to other node </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.find_snap_guest_file_path"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.find_snap_guest_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">find_snap_guest_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_browse_result</span><span class="p">,</span> <span class="n">_drive_letter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Drive&#39;s Serial number</span>
<span class="sd">        Args:</span>
<span class="sd">            _browse_result                      (dict):     guest file browse for vm from snap at vm level</span>

<span class="sd">            _drive_letter                       (string):   drive for which the serial number is evaluated</span>

<span class="sd">        Returns:</span>
<span class="sd">            _browse_result[&#39;snap_display_name&#39;] (string):   Serial number of the _drive_letter</span>

<span class="sd">        Raise Exception:</span>
<span class="sd">                If unable to verify the changeID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">_browse_result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_browse_result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_drive_letter</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_browse_result</span><span class="p">[</span><span class="s1">&#39;snap_display_name&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_browse_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_snap_guest_file_path</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">_drive_letter</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">item</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while getting guest file path for snap &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.disk_count_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.disk_count_validation">[docs]</a>    <span class="k">def</span> <span class="nf">disk_count_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_count_before_restore</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comparing the total number of disks before and after browse</span>
<span class="sd">        Args:</span>
<span class="sd">            disk_count_before_restore (int) :       Number of disk in the MA before Browse</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating the disk-count of the MA after restore&quot;</span><span class="p">)</span>
            <span class="n">disk_count_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">get_disk_count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing Live Browse Un-mount Validation&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">disk_count_before_restore</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">disk_count_after_restore</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disk Unmounted Successfully&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to unmount disk, Number of Disk before restore:</span><span class="si">%s</span><span class="s2"> and Number of disk after restore:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">disk_count_before_restore</span><span class="p">,</span> <span class="n">disk_count_after_restore</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to Un-mount Disk&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception while disk count validation &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.vmware_live_browse_validation"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.vmware_live_browse_validation">[docs]</a>    <span class="k">def</span> <span class="nf">vmware_live_browse_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_vm</span><span class="p">,</span> <span class="n">disk_count_before_restore</span><span class="p">,</span> <span class="n">snap_backup_job</span><span class="p">,</span> <span class="n">backup_copy_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validation for live browse from snap</span>
<span class="sd">        Args:</span>
<span class="sd">            _vm                         (str):  Name of the vm which was browsed and restored</span>

<span class="sd">            disk_count_before_restore   (int): Number of disk on the controller before restore</span>

<span class="sd">            vsa_restore_job             (int):  File level restore job id</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to do live browse validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">find_job_transport_mode</span><span class="p">(</span><span class="n">backup_copy_job</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;directsan&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Live Browse for Proxyless&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Sleeping for 11 minutes&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">700</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disk_count_validation</span><span class="p">(</span><span class="n">disk_count_before_restore</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating Live Browse for Traditional method&quot;</span><span class="p">)</span>
                <span class="n">_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">_list_of_mounted_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">live_browse_get_ds_info</span><span class="p">(</span><span class="n">snap_backup_job</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">live_browse_vm_exists</span><span class="p">(</span><span class="n">_vm</span><span class="p">,</span> <span class="n">snap_backup_job</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Sleeping for 11 minutes&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">700</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">live_browse_vm_exists</span><span class="p">(</span><span class="n">_vm</span><span class="p">,</span> <span class="n">snap_backup_job</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Sleeping for 3 minutes&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">live_browse_ds_exists</span><span class="p">(</span><span class="n">_list_of_mounted_ds</span><span class="p">):</span>
                            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">_flag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Live browse Validation successful&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Live Browse Validation failed&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Live Browse Validation failed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception at Live browse validation </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.validate_rdm_disks"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.validate_rdm_disks">[docs]</a>    <span class="k">def</span> <span class="nf">validate_rdm_disks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disk_restore_options</span><span class="p">,</span> <span class="n">_options_picker</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            disk_restore_options            (object):   represent options that were set for performing</span>
<span class="sd">                                                        disk  restore</span>

<span class="sd">            _options_picker                    (int):    Options passed at the subclient level</span>
<span class="sd">                                                            00 -&gt; No options selected</span>
<span class="sd">                                                            01 -&gt; No Raw only independent</span>
<span class="sd">                                                            10 -&gt; Raw only, no independent</span>
<span class="sd">                                                            11 -&gt; Raw and independent</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to do rdm disks validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm_list</span><span class="p">:</span>
                <span class="n">_temp_vm</span><span class="p">,</span> <span class="n">_temp_vmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_get_vm_ids_and_names_dict_from_browse</span><span class="p">()</span>
                <span class="n">_browse_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">disk_level_browse</span><span class="p">(</span>
                    <span class="n">_temp_vmid</span><span class="p">[</span><span class="n">_temp_vm</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                    <span class="n">copy_precedence</span><span class="o">=</span><span class="n">disk_restore_options</span><span class="o">.</span><span class="n">copy_precedence</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">rdm_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">key1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="n">_browse_request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">value1</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error: RDM disk validation failure&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error: RDM disk validation failure&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RDM disks verified successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception at Validating RDM disks </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.validate_inputs"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.validate_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_os</span><span class="p">,</span> <span class="n">ma_os</span><span class="p">,</span> <span class="n">vm_os</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            proxy_os                (str):  expected os of the proxy</span>

<span class="sd">            ma_os                   (str):  expected os of the Media agent</span>

<span class="sd">            vm_os                   (str):  expected os of the backup vm</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if it fails to match os details</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating proxy OS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_vsaSubclientProp</span><span class="p">[</span><span class="s1">&#39;proxies&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_vsaSubclientProp</span><span class="p">[</span><span class="s1">&#39;proxies&#39;</span><span class="p">][</span><span class="s1">&#39;memberServers&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">proxy_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_client_os_type</span>\
                                    <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;clientName&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OS of Proxy doesn&#39;t match&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proxy_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_client_os_type</span>\
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_proxyClient</span><span class="p">[</span><span class="s1">&#39;clientName&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OS of Proxy doesn&#39;t match&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating MA OS&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ma_os</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_commcell</span><span class="o">.</span><span class="n">get_client_os_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_ma</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OS of MA doesn&#39;t match&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;validating backup vm OS&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_vm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">VMs</span><span class="p">[</span><span class="n">_vm</span><span class="p">]</span><span class="o">.</span><span class="n">GuestOS</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">vm_os</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OS of backup vm doesn&#39;t match&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception at Validating OS   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="AutoVSASubclient.assign_browse_ma"><a class="viewcode-back" href="../../../VirtualServer.VSAUtils.html#VirtualServer.VSAUtils.VirtualServerHelper.AutoVSASubclient.assign_browse_ma">[docs]</a>    <span class="k">def</span> <span class="nf">assign_browse_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_os</span><span class="p">,</span> <span class="n">ma_os</span><span class="p">,</span> <span class="n">vm_os</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigning the correct browse ma for the subclient</span>
<span class="sd">                Args:</span>
<span class="sd">                    proxy_os                (str):  os of the proxy</span>

<span class="sd">                    ma_os                   (str):  os of the Media agent</span>

<span class="sd">                    vm_os                   (str):  os of the backup vm</span>

<span class="sd">                Raises:</span>
<span class="sd">                    Exception:</span>
<span class="sd">                        if it fails to match os details</span>

<span class="sd">                &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Assigning the Browse MA&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm_os</span> <span class="o">==</span> <span class="s1">&#39;windows&#39;</span> <span class="ow">and</span> <span class="n">ma_os</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proxy_os</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">browse_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvobj</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">_commserv_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">browse_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_subclient_properties</span><span class="p">[</span><span class="s1">&#39;proxyClient&#39;</span><span class="p">][</span><span class="s1">&#39;clientName&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception at assigning browse MA   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">err</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Commvault Systems Inc. All Rights Reserved.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>