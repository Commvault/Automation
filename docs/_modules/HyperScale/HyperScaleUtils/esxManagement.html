

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HyperScale.HyperScaleUtils.esxManagement &mdash; Commvault Automation 11.20 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>HyperScale.HyperScaleUtils.esxManagement</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for HyperScale.HyperScaleUtils.esxManagement</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Â©2018 Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="nn">req2</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyVim</span> <span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span> <span class="nn">pyVmomi</span> <span class="kn">import</span> <span class="n">vim</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">pyVim.task</span> <span class="kn">import</span> <span class="n">WaitForTask</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Requirements: pyvmomi package</span>

<span class="sd">&gt;&gt; pip install pyvmomi</span>

<span class="sd">This module provides all the common methods that are needed for esx related functions for </span>
<span class="sd">Hyperscale testing</span>


<span class="sd">    Functions:</span>

<span class="sd">    __init__()                      --  initialize an instance of the esxManagement class</span>

<span class="sd">    tear_down()                     -- Disconnects the object from the ESX server</span>

<span class="sd">    deploy_ovf()                     -- Can be used to remotely deploy an OVF to create a new </span>
<span class="sd">                                        ESX machine for CS/Client</span>

<span class="sd">    keep_lease_alive()              -- This function provides a way to keep the lease to the ESX </span>
<span class="sd">                                            host alive for the duration fo the operation</span>
<span class="sd">                                             being performed.</span>

<span class="sd">    get_all_vms_info()               -- Can be used to get the list of ALL vm&#39;s on the esx host </span>
<span class="sd">                                            along with the details of their disk location and </span>
<span class="sd">                                            IP address</span>

<span class="sd">    get_specific_vm_info()          -- Can be used to get details of a specific VM hosted on </span>
<span class="sd">                                            the esx host</span>

<span class="sd">    get_vm_disk_path()              -- Can be used to get the location of the VM disk on the </span>
<span class="sd">                                        datacenter/store on the esx</span>

<span class="sd">    get_vm_ip()                     -- Can be used to get the IP address of the VM disk on the </span>
<span class="sd">                                            esx.</span>

<span class="sd">    get_vm_object()                 -- This method gives you back the object for the VM on the </span>
<span class="sd">                                        esx to be used further</span>

<span class="sd">    vm_power_control()              -- This method can be used to turn ON/OFF/Reset a VM</span>

<span class="sd">    get_vm_power_state()            -- This method can be used to get teh current power state of </span>
<span class="sd">                                        a VM      </span>

<span class="sd">    destroy_vm()                    -- This method can be used to destroy a VM using its name</span>

<span class="sd">    export_vm()                     -- This method can be used to export a Vm by name in OVF format</span>

<span class="sd">    create_ova()                     -- This methoda can be used to convert the OVF format </span>
<span class="sd">                                        exported machine into an OVA</span>

<span class="sd">    There are other specific methods in this class which are mainly used by the ones listed above.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="EsxManagement"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement">[docs]</a><span class="k">class</span> <span class="nc">EsxManagement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esx_host</span><span class="p">,</span> <span class="n">esx_user</span><span class="p">,</span> <span class="n">esx_password</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the esxManagement class</span>
<span class="sd">        :param esx_host: (str) hostname of the esx server</span>
<span class="sd">        :param esx_user: (str) username of the esx server for connection</span>
<span class="sd">        :param esx_password: (str) password of the esx server for connection</span>
<span class="sd">        :param port: (int) port number of the esx server for connection. Default: 443</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esx_host</span> <span class="o">=</span> <span class="n">esx_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esx_user</span> <span class="o">=</span> <span class="n">esx_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esx_password</span> <span class="o">=</span> <span class="n">esx_password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ovf_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacenter_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lease</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ovfd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s1">&#39;_create_unverified_context&#39;</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_unverified_context</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="n">SmartConnect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">esx_host</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">esx_user</span><span class="p">,</span>
                                           <span class="n">pwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">esx_password</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                                           <span class="n">sslContext</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to connect to host&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

<div class="viewcode-block" id="EsxManagement.tear_down"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.tear_down">[docs]</a>    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tear down function of test case&quot;&quot;&quot;</span>
        <span class="n">connect</span><span class="o">.</span><span class="n">Disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.deploy_ovf"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.deploy_ovf">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_ovf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datacenter_name</span><span class="p">,</span> <span class="n">datastore_name</span><span class="p">,</span> <span class="n">cluster_name</span><span class="p">,</span> <span class="n">vmdk_path</span><span class="p">,</span> <span class="n">ovf_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to deploy an ovf file along with the disk</span>
<span class="sd">        :param datacenter_name: (str) (Required) Data center name where it needs to be hosted</span>
<span class="sd">        :param datastore_name: (str) (Required) DataStore name where it needs to be hosted.</span>
<span class="sd">        :param cluster_name: (str) Name of the clulster on the host. If nothing is provided,</span>
<span class="sd">                default is used from host</span>
<span class="sd">        :param vmdk_path: (str) (Required) Location of the path to the vmdk file on the</span>
<span class="sd">                                local machine</span>
<span class="sd">        :param ovf_path: (str) (Required) Location of the path to the ovf file on the</span>
<span class="sd">                                local machine</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ovf_path</span> <span class="o">=</span> <span class="n">ovf_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span> <span class="o">=</span> <span class="n">vmdk_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastore_name</span> <span class="o">=</span> <span class="n">datastore_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacenter_name</span> <span class="o">=</span> <span class="n">datacenter_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">cluster_name</span>
        <span class="n">exit_flag</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_ovf_descriptor</span><span class="p">()</span>
            <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">ovfManager</span>
            <span class="n">spec_params</span> <span class="o">=</span> <span class="n">vim</span><span class="o">.</span><span class="n">OvfManager</span><span class="o">.</span><span class="n">CreateImportSpecParams</span><span class="p">()</span>
            <span class="n">import_spec</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">CreateImportSpec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ovfd</span><span class="p">,</span> <span class="n">objs</span><span class="p">[</span><span class="s2">&quot;resource pool&quot;</span><span class="p">],</span> <span class="n">objs</span><span class="p">[</span><span class="s2">&quot;datastore&quot;</span><span class="p">]</span>
                                                   <span class="p">,</span> <span class="n">spec_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lease</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="s2">&quot;resource pool&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ImportVApp</span><span class="p">(</span><span class="n">import_spec</span><span class="o">.</span><span class="n">importSpec</span><span class="p">,</span>
                                                          <span class="n">objs</span><span class="p">[</span><span class="s2">&quot;datacenter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vmFolder</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">deviceUrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_host</span><span class="p">)</span>
                    <span class="n">keepalive_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_lease_alive</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">exit_flag</span><span class="p">,))</span>
                    <span class="n">keepalive_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    headers = {&#39;Content-length&#39;: self.get_tarfile_size(),</span>
<span class="sd">                               &#39;Content-Type&#39;: &#39;application/x-vnd.vmware-streamVmdk&#39;} }</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Uploading VM disk now...&#39;</span><span class="p">)</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">req2</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VM disk has been uploaded in </span><span class="si">%d</span><span class="s1"> minutes&#39;</span>
                                  <span class="o">%</span> <span class="nb">int</span><span class="p">(((</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)))</span>
                    <span class="n">exit_flag</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">HttpNfcLeaseComplete</span><span class="p">()</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Lease error: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">msg</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">return</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="EsxManagement.get_ovf_descriptor"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_ovf_descriptor">[docs]</a>    <span class="k">def</span> <span class="nf">get_ovf_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in the OVF descriptor.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ovf_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ovf_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ovf_object</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovfd</span> <span class="o">=</span> <span class="n">ovf_object</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">ovf_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not read file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ovf_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.get_obj_in_list"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_obj_in_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_obj_in_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_name</span><span class="p">,</span> <span class="n">obj_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets an object out of a list (obj_list) whos name matches obj_name.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">obj_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to find object by the name of </span><span class="si">%s</span><span class="s2"> in list </span><span class="si">%s</span><span class="s2">&quot;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">obj_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj_list</span><span class="p">)))</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.get_objects"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict containing the necessary objects for deployment.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get datacenter object.</span>
        <span class="n">datacenter_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">rootFolder</span><span class="o">.</span><span class="n">childEntity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datacenter_name</span><span class="p">:</span>
            <span class="n">datacenter_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_obj_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datacenter_name</span><span class="p">,</span> <span class="n">datacenter_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datacenter_obj</span> <span class="o">=</span> <span class="n">datacenter_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get datastore object.</span>
        <span class="n">datastore_list</span> <span class="o">=</span> <span class="n">datacenter_obj</span><span class="o">.</span><span class="n">datastoreFolder</span><span class="o">.</span><span class="n">childEntity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datastore_name</span><span class="p">:</span>
            <span class="n">datastore_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_obj_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datastore_name</span><span class="p">,</span> <span class="n">datastore_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">datastore_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">datastore_obj</span> <span class="o">=</span> <span class="n">datastore_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No datastores found in DC (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">datacenter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Get cluster object.</span>
        <span class="n">cluster_list</span> <span class="o">=</span> <span class="n">datacenter_obj</span><span class="o">.</span><span class="n">hostFolder</span><span class="o">.</span><span class="n">childEntity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">:</span>
            <span class="n">cluster_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_obj_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">cluster_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cluster_obj</span> <span class="o">=</span> <span class="n">cluster_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No clusters found in DC (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">datacenter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Generate resource pool.</span>
        <span class="n">resource_pool_obj</span> <span class="o">=</span> <span class="n">cluster_obj</span><span class="o">.</span><span class="n">resourcePool</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;datacenter&quot;</span><span class="p">:</span> <span class="n">datacenter_obj</span><span class="p">,</span>
                <span class="s2">&quot;datastore&quot;</span><span class="p">:</span> <span class="n">datastore_obj</span><span class="p">,</span>
                <span class="s2">&quot;resource pool&quot;</span><span class="p">:</span> <span class="n">resource_pool_obj</span><span class="p">}</span></div>

<div class="viewcode-block" id="EsxManagement.keep_lease_alive"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.keep_lease_alive">[docs]</a>    <span class="k">def</span> <span class="nf">keep_lease_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Keeps the lease alive while POSTing the VMDK.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exit_flag_val</span> <span class="o">=</span> <span class="n">exit_flag</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exit_flag_val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Choosing arbitrary percentage to keep the lease alive.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">HttpNfcLeaseProgress</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># If the lease is released, we get an exception.</span>
                <span class="c1"># Returning to kill the thread.</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Lease error </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="EsxManagement.get_tarfile_size"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_tarfile_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_tarfile_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the size of a file inside the tarball.</span>
<span class="sd">        If the object has a size attribute, use that. Otherwise seek to the end</span>
<span class="sd">        and report that.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span><span class="o">.</span><span class="n">size</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vmdk_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size</span></div>

<div class="viewcode-block" id="EsxManagement.get_disk"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_disk">[docs]</a>    <span class="k">def</span> <span class="nf">get_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does translation for disk key to file name, returning a file handle.</span>
<span class="sd">        This is used for deploying of OVF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ovffilename</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">file_item</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">getnames</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">ovffilename</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.get_all_vms_info"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_all_vms_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_vms_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get VM info of ALL the machines on the host</span>
<span class="sd">        :param depth:</span>
<span class="sd">        :return: LIST of DICT (list of all machines )</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">RetrieveContent</span><span class="p">()</span>
        <span class="c1">#vmInfo = {&#39;Name&#39;: &#39;&#39;, &#39;Path&#39;: &#39;&#39;, &#39;IP&#39;: &#39;&#39;}</span>
        <span class="n">full_vm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">rootFolder</span><span class="o">.</span><span class="n">childEntity</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s1">&#39;vmFolder&#39;</span><span class="p">):</span>
                <span class="n">datacenter</span> <span class="o">=</span> <span class="n">child</span>
                <span class="n">vm_folder</span> <span class="o">=</span> <span class="n">datacenter</span><span class="o">.</span><span class="n">vmFolder</span>
                <span class="n">vm_list</span> <span class="o">=</span> <span class="n">vm_folder</span><span class="o">.</span><span class="n">childEntity</span>
                <span class="k">for</span> <span class="n">vm</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                    <span class="n">maxdepth</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="s1">&#39;childEntity&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">maxdepth</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="n">vm_list</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">childEntity</span>
                        <span class="k">for</span> <span class="n">vm_instance</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_info</span><span class="p">(</span><span class="n">vm_instance</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vim</span><span class="o">.</span><span class="n">VirtualApp</span><span class="p">):</span>
                        <span class="n">vm_list</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">vm</span>
                        <span class="k">for</span> <span class="n">vm_instance</span> <span class="ow">in</span> <span class="n">vm_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_info</span><span class="p">(</span><span class="n">vm_instance</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">summary</span>
                    <span class="n">vm_info</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Path&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;IP&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
                    <span class="n">vm_info</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">vm_info</span><span class="p">[</span><span class="s1">&#39;Path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">vmPathName</span>
                    <span class="n">vm_info</span><span class="p">[</span><span class="s1">&#39;IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">guest</span><span class="o">.</span><span class="n">ipAddress</span>
                    <span class="n">full_vm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm_info</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">question</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Question  : &quot;</span><span class="p">,</span> <span class="n">summary</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">full_vm_list</span></div>

<div class="viewcode-block" id="EsxManagement.get_specific_vm_info"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_specific_vm_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_specific_vm_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name: (str) This is the name of the VM on the host</span>
<span class="sd">        :return: (dict) of Name/disk path and IP address of the VM name specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_vms_info</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="EsxManagement.get_vm_disk_path"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_vm_disk_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_disk_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name: (str) This is the name of the VM on the host</span>
<span class="sd">        :return: Disk location of the VM  in string format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_specific_vm_info</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)[</span><span class="s1">&#39;Path&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="EsxManagement.get_vm_ip"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_vm_ip">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name:  (str) This is the name of the VM on the host</span>
<span class="sd">        :return:  IP address of the VM if resolvable in string format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_specific_vm_info</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)[</span><span class="s1">&#39;IP&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="EsxManagement.get_vm_object"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_vm_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name: (str) This is the name of the VM on the host</span>
<span class="sd">        :return: return the VM object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">entity_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">rootFolder</span><span class="o">.</span><span class="n">childEntity</span>
            <span class="k">while</span> <span class="n">entity_stack</span><span class="p">:</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">entity_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">vm_name</span><span class="p">:</span>
                    <span class="n">vm</span> <span class="o">=</span> <span class="n">entity</span>
                    <span class="k">del</span> <span class="n">entity_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">entity_stack</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;childEntity&#39;</span><span class="p">):</span>
                    <span class="n">entity_stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">childEntity</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">vim</span><span class="o">.</span><span class="n">Datacenter</span><span class="p">):</span>
                    <span class="n">entity_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">vmFolder</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vim</span><span class="o">.</span><span class="n">VirtualMachine</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find the virtual machine named </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vm</span></div>

<div class="viewcode-block" id="EsxManagement.vm_power_control"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.vm_power_control">[docs]</a>    <span class="k">def</span> <span class="nf">vm_power_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">vmware_tools_installed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param vm_name: (str) This is the name of the VM on the host</span>
<span class="sd">        :param operation: (str) on | off | shutdown. This is the desired operation</span>
<span class="sd">        shutdown</span>
<span class="sd">        :param vmware_tools_installed: True | False</span>
<span class="sd">                It helps to correctly check if the machine is up or not .</span>
<span class="sd">                if it is not installed, pass False</span>
<span class="sd">        :return: True if successful and False if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_power_state</span><span class="p">(</span><span class="n">vm_name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
                        <span class="c1">#task = vm.PowerOff()</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">ShutdownGuest</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
                            <span class="n">task</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">PowerOff</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">PowerOn</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;shutdown&#39;</span><span class="p">:</span>
                        <span class="n">task</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">ShutdownGuest</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Incorrect operation type provided.&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">operation</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="c1"># answers = {}</span>
                    <span class="k">while</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vim</span><span class="o">.</span><span class="n">TaskInfo</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">success</span><span class="p">,</span>
                                                  <span class="n">vim</span><span class="o">.</span><span class="n">TaskInfo</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">error</span><span class="p">]:</span>
                        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                        if vm.runtime.question is not None:</span>
<span class="sd">                            question_id = vm.runtime.question.id</span>
<span class="sd">                            if question_id not in answers.keys():</span>
<span class="sd">                                answers[question_id] = self.answer_vm_question(vm)</span>
<span class="sd">                                vm.AnswerVM(question_id, answers[question_id])</span>
<span class="sd">                        &#39;&#39;&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Please wait while machine is powered </span><span class="si">%s</span><span class="s1">&#39;</span>
                                      <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">TaskInfo</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;found cause: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">faultCause</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">fault_msg</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">faultMessage</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fault_msg</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fault_msg</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to power </span><span class="si">%s</span><span class="s1"> the machine&#39;</span> <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Machine has been powered </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">vmware_tools_installed</span> <span class="ow">and</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">:</span>
                        <span class="n">time_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">guest</span><span class="o">.</span><span class="n">toolsStatus</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">GuestInfo</span><span class="o">.</span><span class="n">ToolsStatus</span><span class="o">.</span><span class="n">toolsOk</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Machine OS has been booted up&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">elif</span> <span class="n">time_counter</span> <span class="o">&gt;=</span> <span class="mi">120</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Waited about 30 minutes for machine to boot &#39;</span>
                                                 <span class="s1">&#39;without confirmation. Exiting wait now&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting for OS to finish booting&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;vmToolStatus: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">guest</span><span class="o">.</span><span class="n">toolsStatus</span><span class="p">))</span>
                                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                                <span class="n">time_counter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Machine is already powered </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There was an error getting the Vm object. &#39;</span>
                               <span class="s1">&#39;Please check the logs for more info&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please make sure machine has been deployed&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please make sure machine has been deployed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="EsxManagement.get_vm_power_state"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_vm_power_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_power_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name: (str) Name of the VM whose current power state is required.</span>
<span class="sd">        :return: &#39;off&#39; | &#39;on&#39; | None (if error is encountered)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">powerState</span> <span class="o">==</span> <span class="s1">&#39;poweredOff&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - Machine is currently OFF&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;off&#39;</span>
                <span class="k">elif</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">powerState</span> <span class="o">==</span> <span class="s1">&#39;poweredOn&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - Machine is currently ON&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;on&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - Machine is currently in a weird state. </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">powerState</span><span class="p">))</span>
                    <span class="k">return</span> <span class="s1">&#39;stuck&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There was an error getting the Vm object. &#39;</span>
                               <span class="s1">&#39;Please check the logs for more info&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please make sure machine has been deployed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="EsxManagement.destroy_vm"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.destroy_vm">[docs]</a>    <span class="k">def</span> <span class="nf">destroy_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param vm_name: (str) Name of the VM that needs to be deleted.</span>
<span class="sd">        :return: True if successful and False if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">vm</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has been successfully deleted&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There was an error getting the Vm object. &#39;</span>
                               <span class="s1">&#39;Please check the logs for more info&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="EsxManagement.break_down_cookie"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.break_down_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">break_down_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookie</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Breaks down vSphere SOAP cookie</span>
<span class="sd">        :param cookie: vSphere SOAP cookie</span>
<span class="sd">        :type cookie: str</span>
<span class="sd">        :return: Dictionary with cookie_name: cookie_value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cookie_a</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">cookie_name</span> <span class="o">=</span> <span class="n">cookie_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cookie_text</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">; $</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cookie_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">cookie_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">cookie_name</span><span class="p">:</span> <span class="n">cookie_text</span><span class="p">}</span></div>

<div class="viewcode-block" id="EsxManagement.download_device"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.download_device">[docs]</a>    <span class="k">def</span> <span class="nf">download_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">temp_target_disk</span><span class="p">,</span> <span class="n">device_url</span><span class="p">,</span>
                        <span class="n">total_bytes_written</span><span class="p">,</span> <span class="n">total_bytes_to_write</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download disk device of HttpNfcLease.info.deviceUrl list of devices</span>
<span class="sd">        :param headers: Request headers</span>
<span class="sd">        :type cookies: dict</span>
<span class="sd">        :param cookies: Request cookies (session)</span>
<span class="sd">        :type cookies: dict</span>
<span class="sd">        :param temp_target_disk: file name to write</span>
<span class="sd">        :type temp_target_disk: str</span>
<span class="sd">        :param device_url: deviceUrl.url</span>
<span class="sd">        :type device_url: str</span>

<span class="sd">        Following will be used in future</span>

<span class="sd">        :param total_bytes_written: Bytes written so far</span>
<span class="sd">        :type total_bytes_to_write: long</span>
<span class="sd">        :param total_bytes_to_write: VM unshared storage</span>
<span class="sd">        :type total_bytes_to_write: long</span>
<span class="sd">        :return: current_bytes_written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_target_disk</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">req2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                                <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># response other than 200</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="c1"># keeping track of progress</span>
            <span class="n">current_bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
                <span class="c1"># filter out keep-alive new chunks</span>
                <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
                <span class="c1"># getting right progress</span>
                <span class="n">current_bytes_written</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                written_pct = ((current_bytes_written +</span>
<span class="sd">                                total_bytes_written) * 100) / total_bytes_to_write</span>
<span class="sd">                # updating lease</span>
<span class="sd">                #lease_updater.progressPercent = int(written_pct)</span>
<span class="sd">                &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">current_bytes_written</span></div>

<div class="viewcode-block" id="EsxManagement.export_vm"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.export_vm">[docs]</a>    <span class="k">def</span> <span class="nf">export_vm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method can be used to export a VM from a vmware ESX</span>
<span class="sd">        :param vm_name: (str) Name of the VM that needs to be exported</span>
<span class="sd">        :param destination_dir: (srt) Location path where the VM can be exported</span>
<span class="sd">        :return: (str) Location of the path where the exported files are located.</span>
<span class="sd">                        This will typically be a subfolder of the desitantion_dir variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">destination_dir</span>
        <span class="n">exit_flag</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># VM must be powered off to export</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_power_state</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutting down VM </span><span class="si">%s</span><span class="s1"> for export&#39;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">vm_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="c1"># Breaking down SOAP Cookie &amp;</span>
        <span class="c1"># creating Header</span>
        <span class="n">soap_cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">_stub</span><span class="o">.</span><span class="n">cookie</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_down_cookie</span><span class="p">(</span><span class="n">soap_cookie</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-vnd.vmware-streamVmdk&#39;</span><span class="p">}</span>  <span class="c1"># not required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Working dir: </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating working directory </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="c1"># actual target directory for VM</span>
        <span class="n">target_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">instanceUuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Target dir: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_directory</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating target dir </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span>

        <span class="c1"># Getting HTTP NFC Lease</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lease</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">ExportVm</span><span class="p">()</span>
        <span class="n">keepalive_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_lease_alive</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">exit_flag</span><span class="p">,))</span>
        <span class="n">keepalive_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Creating list for ovf files which will be value of</span>
        <span class="n">ovf_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">total_bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_bytes_to_write</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">unshared</span>
        <span class="n">temp_target_disk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;HTTP NFC Lease Ready&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">deviceUrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">deviceUrl</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                        <span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esx_host</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">deviceUrl</span><span class="o">.</span><span class="n">targetId</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No targetId found for url: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Device is not eligible for export&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Skipping...&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">temp_target_disk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span>
                                                        <span class="n">deviceUrl</span><span class="o">.</span><span class="n">targetId</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downloading </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                                                                    <span class="n">temp_target_disk</span><span class="p">))</span>

                        <span class="n">current_bytes_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_device</span><span class="p">(</span>
                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                            <span class="n">temp_target_disk</span><span class="o">=</span><span class="n">temp_target_disk</span><span class="p">,</span>
                            <span class="n">device_url</span><span class="o">=</span><span class="n">deviceUrl</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                            <span class="n">total_bytes_written</span><span class="o">=</span><span class="n">total_bytes_written</span><span class="p">,</span>
                            <span class="n">total_bytes_to_write</span><span class="o">=</span><span class="n">total_bytes_to_write</span><span class="p">)</span>
                        <span class="c1"># Adding up file written bytes to total</span>
                        <span class="n">total_bytes_written</span> <span class="o">+=</span> <span class="n">current_bytes_written</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating OVF file for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_target_disk</span><span class="p">))</span>
                        <span class="c1"># Adding Disk to OVF Files list</span>
                        <span class="n">ovf_file</span> <span class="o">=</span> <span class="n">vim</span><span class="o">.</span><span class="n">OvfManager</span><span class="o">.</span><span class="n">OvfFile</span><span class="p">()</span>
                        <span class="n">ovf_file</span><span class="o">.</span><span class="n">deviceId</span> <span class="o">=</span> <span class="n">deviceUrl</span><span class="o">.</span><span class="n">key</span>
                        <span class="n">ovf_file</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">deviceUrl</span><span class="o">.</span><span class="n">targetId</span>
                        <span class="n">ovf_file</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">current_bytes_written</span>
                        <span class="n">ovf_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ovf_file</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">initializing</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;HTTP NFC Lease Initializing.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">vim</span><span class="o">.</span><span class="n">HttpNfcLease</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP NFC Lease error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting OVF Manager&#39;</span><span class="p">)</span>
            <span class="n">ovf_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">ovfManager</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating OVF Descriptor&#39;</span><span class="p">)</span>
            <span class="n">vm_descriptor_name</span> <span class="o">=</span> <span class="n">vm_name</span> <span class="k">if</span> <span class="n">vm_name</span> <span class="k">else</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ovf_parameters</span> <span class="o">=</span> <span class="n">vim</span><span class="o">.</span><span class="n">OvfManager</span><span class="o">.</span><span class="n">CreateDescriptorParams</span><span class="p">()</span>
            <span class="n">ovf_parameters</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">vm_descriptor_name</span>
            <span class="n">ovf_parameters</span><span class="o">.</span><span class="n">ovfFiles</span> <span class="o">=</span> <span class="n">ovf_files</span>
            <span class="n">vm_descriptor_result</span> <span class="o">=</span> <span class="n">ovf_manager</span><span class="o">.</span><span class="n">CreateDescriptor</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">vm_obj</span><span class="p">,</span>
                                                                <span class="n">cdp</span><span class="o">=</span><span class="n">ovf_parameters</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vm_descriptor_result</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">vm_descriptor_result</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fault</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vm_descriptor_result</span><span class="p">))</span>
                <span class="n">vm_descriptor</span> <span class="o">=</span> <span class="n">vm_descriptor_result</span><span class="o">.</span><span class="n">ovfDescriptor</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vm_descriptor</span><span class="p">))</span>
                <span class="n">target_ovf_descriptor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span>
                                                          <span class="n">vm_descriptor_name</span> <span class="o">+</span>
                                                          <span class="s1">&#39;.ovf&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing OVF Descriptor </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_ovf_descriptor_path</span><span class="p">))</span>
                <span class="n">vm_descriptor</span> <span class="o">=</span> <span class="n">vm_descriptor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;disk-0.vmdk&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-disk1.vmdk&quot;</span>
                                                      <span class="o">%</span> <span class="n">vm_name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_target_disk</span><span class="p">,</span> <span class="n">temp_target_disk</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;disk-0.vmdk&quot;</span><span class="p">,</span>
                                                                     <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-disk1.vmdk&quot;</span> <span class="o">%</span> <span class="n">vm_name</span><span class="p">))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_ovf_descriptor_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vm_descriptor</span><span class="p">)</span>
                <span class="c1"># ending lease</span>
                <span class="n">exit_flag</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">HttpNfcLeaseProgress</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lease</span><span class="o">.</span><span class="n">HttpNfcLeaseComplete</span><span class="p">()</span>
                <span class="n">exit_flag</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">target_directory</span></div>

<div class="viewcode-block" id="EsxManagement.create_ova"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.create_ova">[docs]</a>    <span class="k">def</span> <span class="nf">create_ova</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination_filepath</span><span class="p">,</span> <span class="n">source_folderpath</span><span class="p">,</span> <span class="n">cleanup_source</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function ca be used to convert an OVF export to an OVA</span>
<span class="sd">        :param destination_filepath: (str) This is the path to the ova that needs to be created.</span>
<span class="sd">                                    For Example: &quot;C\\temp\test.ova&quot;</span>
<span class="sd">        :param source_folderpath:  (str) This is a folder path where the ovf and disk files are</span>
<span class="sd">                                    present</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating OVA&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">source_folderpath</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">destination_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar_handle</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%s</span><span class="s1"> to the archive&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                    <span class="n">tar_handle</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OVA creation finished&#39;</span><span class="p">)</span>
            <span class="n">tar_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cleanup_source</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">source_folderpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaned up source ovf directory </span><span class="si">%s</span><span class="s1"> &#39;</span>
                              <span class="s1">&#39;since ova is successfully generated&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">source_folderpath</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.delete_network_card"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.delete_network_card">[docs]</a>    <span class="k">def</span> <span class="nf">delete_network_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">nic_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deletes virtual NIC based on nic number</span>
<span class="sd">        :param vm_name: Virtual Machine name</span>
<span class="sd">        :param nic_number: Unit Number usuallt is 1/2/3 and so on</span>
<span class="sd">        :return: True if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="n">nic_prefix_label</span> <span class="o">=</span> <span class="s1">&#39;Network adapter &#39;</span>
        <span class="n">nic_label</span> <span class="o">=</span> <span class="n">nic_prefix_label</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nic_number</span><span class="p">)</span>
        <span class="n">virtual_nic_device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hardware</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">vim</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">VirtualEthernetCard</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">dev</span><span class="o">.</span><span class="n">deviceInfo</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">nic_label</span><span class="p">:</span>
                <span class="n">virtual_nic_device</span> <span class="o">=</span> <span class="n">dev</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">virtual_nic_device</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Virtual </span><span class="si">{}</span><span class="s1"> could not be found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nic_label</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm_power_control</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">virtual_nic_spec</span> <span class="o">=</span> <span class="n">vim</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">VirtualDeviceSpec</span><span class="p">()</span>
        <span class="n">virtual_nic_spec</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> \
            <span class="n">vim</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">VirtualDeviceSpec</span><span class="o">.</span><span class="n">Operation</span><span class="o">.</span><span class="n">remove</span>
        <span class="n">virtual_nic_spec</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">virtual_nic_device</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">vim</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">ConfigSpec</span><span class="p">()</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">deviceChange</span> <span class="o">=</span> <span class="p">[</span><span class="n">virtual_nic_spec</span><span class="p">]</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">vm_obj</span><span class="o">.</span><span class="n">ReconfigVM_Task</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">nic_label</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="EsxManagement.delete_all_nics"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.delete_all_nics">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_nics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method basically tries to remove the default nic one by one</span>
<span class="sd">        :param vm_name: name of the VM whose nic&#39;s are to be removed</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_network_card</span><span class="p">(</span><span class="n">vm_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed all network adapters&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>

<div class="viewcode-block" id="EsxManagement.get_snapshots"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_snapshots">[docs]</a>    <span class="k">def</span> <span class="nf">get_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method gets list of all snapshots with their names along with their snapshot objects</span>

<span class="sd">        :param vm_name: name of the VM whose snapshots are needed</span>
<span class="sd">        :return: list of dictionary in format</span>
<span class="sd">        op_dict = {&quot;snapshot_name&quot;: &#39;&#39;, &quot;snapshot_obj&quot;: &#39;&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="n">op_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;snapshot_obj&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="n">op</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vm_object</span><span class="o">.</span><span class="n">snapshot</span><span class="o">.</span><span class="n">rootSnapshotList</span><span class="p">:</span>
            <span class="n">op_dict</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span>
            <span class="n">op_dict</span><span class="p">[</span><span class="s2">&quot;snapshot_obj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">snapshot</span>
            <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_dict</span><span class="p">)</span>
            <span class="n">op</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_info</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op</span></div>

<div class="viewcode-block" id="EsxManagement.snapshot_info"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.snapshot_info">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_list</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used internally to get child snapshots of each snapshot</span>
<span class="sd">        :param snapshot_list: internal</span>
<span class="sd">        :param depth:</span>
<span class="sd">        :return: list of dict of name object of snaps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">op_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;snapshot_obj&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>
        <span class="n">op</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshot_list</span><span class="o">.</span><span class="n">childSnapshotList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">snapshot_list</span><span class="o">.</span><span class="n">childSnapshotList</span><span class="p">:</span>
                    <span class="n">op_dict</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">op_dict</span><span class="p">[</span><span class="s2">&quot;snapshot_obj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">snapshot</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_dict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;childSnapshotList&quot;</span><span class="p">):</span>
                        <span class="n">op</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op</span></div>

<div class="viewcode-block" id="EsxManagement.get_snapshot_object"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.get_snapshot_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_snapshot_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method helps to get snapshot object from the outptu of get all snapshots by name</span>
<span class="sd">        :param vm_name: Vm whos snapshot object is reqd</span>
<span class="sd">        :param snapshot_name: snapshot name whose object is reqd</span>
<span class="sd">        :return: snapshot object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">vm_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">snapshot_name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;snapshot_obj&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="EsxManagement.revert_snapshot"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.revert_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">revert_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is to be able to revet to a snapshot of a vm by name</span>
<span class="sd">        :param vm_name: VM name</span>
<span class="sd">        :param snapshot_name: snapshot name</span>
<span class="sd">        :return: Returns True when success | False when it could not find snapshot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">vm_snapshots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snapshot_name</span> <span class="o">==</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]:</span>
                <span class="n">snap_obj</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;snapshot_obj&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reverting snapshot &quot;</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">])</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">snap_obj</span><span class="o">.</span><span class="n">RevertToSnapshot_Task</span><span class="p">()</span>
                <span class="n">WaitForTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Snapshot has been reverted&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="EsxManagement.save_snapshot"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.save_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">save_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Test snapshot&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to create a snapshot of a vm</span>
<span class="sd">        :param vm_name: VM name</span>
<span class="sd">        :param snapshot_name: desired name of snapshot</span>
<span class="sd">        :param description: Description to add to snapshot</span>
<span class="sd">        :return: True if no error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_object</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="n">dump_memory</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">quiesce</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating snapshot </span><span class="si">%s</span><span class="s2"> for virtual machine </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">snapshot_name</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">))</span>
        <span class="n">WaitForTask</span><span class="p">(</span><span class="n">vm_object</span><span class="o">.</span><span class="n">CreateSnapshot</span><span class="p">(</span><span class="n">snapshot_name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">dump_memory</span><span class="p">,</span> <span class="n">quiesce</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="EsxManagement.delete_snapshot"><a class="viewcode-back" href="../../../source/HyperScale.HyperScaleUtils.html#HyperScale.HyperScaleUtils.esxManagement.EsxManagement.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">snapshot_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method can be used to delete a particular snapshot</span>

<span class="sd">        :param vm_name: name of the VM</span>
<span class="sd">        :param snapshot_name: name of the snapshot to be deleted</span>
<span class="sd">        :return: True is success | False if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vm_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">vm_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">vm_snapshots</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snapshot_name</span> <span class="o">==</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;snapshot_name&quot;</span><span class="p">]:</span>
                <span class="n">snap_obj</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;snapshot_obj&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing snapshot </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">snapshot_name</span><span class="p">)</span>
                <span class="n">WaitForTask</span><span class="p">(</span><span class="n">snap_obj</span><span class="o">.</span><span class="n">RemoveSnapshot_Task</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>