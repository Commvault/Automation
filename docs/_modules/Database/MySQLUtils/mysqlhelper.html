

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Database.MySQLUtils.mysqlhelper &mdash; Commvault Automation 11.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Database.MySQLUtils.mysqlhelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Database.MySQLUtils.mysqlhelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Helper file for performing MYSQL operations</span>

<span class="sd">MYSQLHelper is the only class defined in this file</span>

<span class="sd">MYSQLHelper: Helper class to perform MYSQL operations</span>

<span class="sd">MYSQLHelper:</span>
<span class="sd">============</span>
<span class="sd">    __init__()                          --  initializes MYSQLHelper object</span>

<span class="sd">    get_mysql_db_password()             --  Gets the password of the mysql instance</span>

<span class="sd">    get_mysql_port()                    --  Method to get the mysql port from client</span>

<span class="sd">    get_database_information()          --  Method to get the database information</span>

<span class="sd">    get_default_subclient_contents()    --  Method to get default subclient contents</span>

<span class="sd">    validate_db_info()                  --  Method to validate database information</span>

<span class="sd">    drop_table()                        --  Method to drop a table from database</span>

<span class="sd">    clean_up_tables()                   --  This Function takes a dictionary as input.</span>
<span class="sd">    The dictionary has the database names as keys and table names list as values.</span>
<span class="sd">    This function calls the drop_table()</span>

<span class="sd">    cleanup_database_contents()         --  method to clean all views and tables in database</span>

<span class="sd">    basic_setup_on_mysql_server()       --  This function checks for basic settings on MYSQL Server</span>

<span class="sd">    get_tables_list_for_db()            --  This function get list of tables for given DataBases</span>

<span class="sd">    get_table_size()                    --  Method to get the table name and number of rows</span>
<span class="sd">    for all the tables under given database</span>

<span class="sd">    log_bin_on_mysql_server()           --  This function checks whether LOG_BIN ON or OFF,</span>
<span class="sd">    If its OFF then incremental(Log) backup cannot be run.</span>

<span class="sd">    create_table_with_text_db()         --  This function created the table with the</span>
<span class="sd">    given name as prefix and inserts data</span>

<span class="sd">    create_view()                       --  Creates a view inside a database</span>

<span class="sd">    drop_view()                         --  Drops a view inside a database</span>

<span class="sd">    list_views()                        --  Lists views inside a database</span>

<span class="sd">    generate_test_data()                --  Function to generate test data for the automation</span>
<span class="sd">    purpose. Adds specified number of Databases, tables and Rows with a specified Prefix</span>

<span class="sd">    cleanup_test_data()                 --  Cleans up test data which are generated for automation</span>

<span class="sd">    start_mysql_server()                --  Starts the mysql server in client</span>

<span class="sd">    stop_mysql_server()                 --  Stops the mysql server in client</span>

<span class="sd">    get_server_status()                 --  Gets the status of mysql server</span>

<span class="sd">    run_restore()                       --  Initiates the restore job for the specified subclient</span>

<span class="sd">    snap_blocklevel_testcase()          --  Method to perform backup/restore and validation of</span>
<span class="sd">    snap and block level feature TCs</span>

<span class="sd">    snap_prerequirement_check()         --  Method to check if the pre requirement to</span>
<span class="sd">    run snap/block level testcase is met or not</span>

<span class="sd">    blocklevel_redirect_restore()       --  Method to perform redirect restore testcase for</span>
<span class="sd">    snap and block level cases</span>

<span class="sd">    _redirect_operations()              --  Method to perform operations related to redirect restore</span>

<span class="sd">    innodb_file_per_table()             --  Checks if the innodb_files_per_table is enabled</span>
<span class="sd">    in the server or not</span>

<span class="sd">    is_xtrabackup_eligible()            --  Checks if the server is eligible to run xtrabackup</span>

<span class="sd">    is_xtrabackup_effective()           --  Method to check if the xtrabackup is being</span>
<span class="sd">    used for the backup</span>

<span class="sd">    backup_job_ran_on()                 --  Method to get the client and instance details on</span>
<span class="sd">    which backup job was run</span>

<span class="sd">    populate_database()                 --  Inserts test tables and views in the each</span>
<span class="sd">    database in the subclient content</span>

<span class="sd">    run_proxy_backup()                  --  Initiates the backup job on proxy subclient and</span>
<span class="sd">    checks if the proxy is honored</span>

<span class="sd">    proxy_testcase()                    --  Method to run proxy testcases</span>

<span class="sd">    _get_mysql_database_connection()    --  Method for database connection</span>

<span class="sd">    run_data_restore_and_validation()   --  Method to run Data only restore</span>


<span class="sd">MYSQLHelper Instance Attributes:</span>
<span class="sd">================================</span>
<span class="sd">    **data_directory**                  --  returns mysql data directory</span>

<span class="sd">    **partition_enabled**               --  returns true if the partition is enabled</span>
<span class="sd">    in database server</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">cvhelper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">Database.dbhelper</span> <span class="kn">import</span> <span class="n">DbHelper</span>


<div class="viewcode-block" id="MYSQLHelper"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper">[docs]</a><span class="k">class</span> <span class="nc">MYSQLHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform mysql operations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">subclient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes mysqlhelper object</span>

<span class="sd">        Args:</span>
<span class="sd">                commcell             (obj)  --  Commcell object</span>

<span class="sd">                subclient            (obj)  --  Subclient Object</span>

<span class="sd">                        default: None</span>

<span class="sd">                instance             (obj)  --  Instance object</span>

<span class="sd">                        default: None</span>

<span class="sd">                hostname             (str)  --  Cient hostname</span>

<span class="sd">                        default: None</span>

<span class="sd">                user                 (str)  --  MySQL server username</span>

<span class="sd">                        default: None</span>

<span class="sd">                port                 (int)  --  MySQL server port number</span>

<span class="sd">                    default: None</span>

<span class="sd">                connection_info      (dict) --  dictoinary containing connection information</span>
<span class="sd">                that needs to be provided only if subclient and instance objects are not provided</span>

<span class="sd">                    default: None</span>

<span class="sd">                    Format:</span>
<span class="sd">                        connection_info = {</span>
<span class="sd">                            &#39;client_name&#39;: &#39;client_name&#39;,</span>
<span class="sd">                            &#39;instance_name&#39;:&#39;instance_name&#39;,</span>
<span class="sd">                            &#39;socket_file&#39;:&#39;socket_file/port(incase of windows)&#39;}</span>

<span class="sd">            Returns:</span>
<span class="sd">                object - instance of this class</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="c1"># self.csdb = database_helper.get_csdb()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">CommServDatabase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_connect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_client_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_instance_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cloud_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="n">hostname</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_cloud_db</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">mysql_server_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="n">mysql_server_name</span>

        <span class="k">if</span> <span class="n">subclient</span> <span class="ow">and</span> <span class="n">instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="n">subclient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span> <span class="o">=</span> <span class="n">instance</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cloud_db</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">_agent_object</span><span class="o">.</span><span class="n">_client_object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">binary_directory</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_client_name</span> <span class="o">=</span> <span class="n">connection_info</span><span class="p">[</span><span class="s1">&#39;client_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_instance_name</span> <span class="o">=</span> <span class="n">connection_info</span><span class="p">[</span><span class="s1">&#39;instance_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_mysql_bin_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_instance_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket_file</span> <span class="o">=</span> <span class="n">connection_info</span><span class="p">[</span><span class="s1">&#39;socket_file&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mysql_db_password</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usr</span> <span class="o">=</span> <span class="n">user</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BINDIR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span><span class="p">,</span>
            <span class="s1">&#39;USERNAME&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span>
            <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span>
            <span class="s1">&#39;SOCKFILE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_file</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_directory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partition_enabled</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cloud_db</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_mysql_port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns mysql data directory</span>

<span class="sd">        Returns:</span>
<span class="sd">            (str)   --  MySQL data directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_directory</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MySQL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SHOW VARIABLES WHERE Variable_Name LIKE &#39;datadir&#39;;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_directory</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_directory</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">partition_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns true if the partition is enabled in database server</span>

<span class="sd">        Returns:</span>

<span class="sd">            (bool)  --  True if partition is enabled</span>
<span class="sd">                        False if partition not enabled</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_enabled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS &quot;</span>
                    <span class="s2">&quot;where PLUGIN_NAME=&#39;partition&#39;;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partition_enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_partition_enabled</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partition_enabled</span>

<div class="viewcode-block" id="MYSQLHelper.get_mysql_bin_dir"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_mysql_bin_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_mysql_bin_dir</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">client_name</span><span class="p">,</span>
            <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets mysql binary directory</span>
<span class="sd">        Args:</span>

<span class="sd">            client_name        (str)    -- client name</span>

<span class="sd">            instance_name      (str)    -- Mysql instance name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;select attrVal from APP_InstanceProp where componentNameId=(select distinct &quot;</span>
            <span class="s2">&quot;instance from APP_Application where clientId=(select id from APP_Client &quot;</span>
            <span class="s2">&quot;where name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;) and instance in (select id from APP_InstanceName where &quot;</span>
            <span class="s2">&quot;name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;)) and attrName=&#39;MySQL binary file path&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bin directory of MySQL instance is fetched Successfully&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get the MySQL instance bin directory&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_mysql_db_password"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_mysql_db_password">[docs]</a>    <span class="k">def</span> <span class="nf">get_mysql_db_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the password of the mysql instance</span>

<span class="sd">        Returns:</span>

<span class="sd">            mysql_db_password   (str)   --  Password of mysql server</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the password of the instance</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Select attrVal from app_instanceprop where componentNameId = </span><span class="si">{0}</span><span class="s2"> and </span><span class="se">\</span>
<span class="s2">                    attrName = &#39;MySQL SA Password&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Select attrVal from app_instanceprop where componentNameId = &quot;</span>
                    <span class="s2">&quot;(select distinct instance from APP_Application where instance in &quot;</span>
                    <span class="s2">&quot;(select id from APP_InstanceName where name=&#39;</span><span class="si">{1}</span><span class="s2">&#39;) and clientId=&quot;</span>
                    <span class="s2">&quot;(select id from app_client where name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;)) and &quot;</span>
                    <span class="s2">&quot;attrName = &#39;MySQL SA password&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_client_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_instance_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mysql_db_password</span> <span class="o">=</span> <span class="n">cvhelper</span><span class="o">.</span><span class="n">format_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mysql_db_password</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not get the mysql server password. &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_mysql_port"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_mysql_port">[docs]</a>    <span class="k">def</span> <span class="nf">get_mysql_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; method to get the mysql port from client</span>

<span class="sd">        Returns:</span>

<span class="sd">            (int)   --  MySQL Port number</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                if fails to get the port</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_status</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the MySQL port&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OPERATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;port&#39;</span>

            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_MYSQL_SERVER_OPERATIONS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Server is not running, cannot get the port Number&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_database_information"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_database_information">[docs]</a>    <span class="k">def</span> <span class="nf">get_database_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; method to get the database information</span>

<span class="sd">        Args:</span>

<span class="sd">            database_list     (list)  -- Database list</span>

<span class="sd">        Returns:</span>

<span class="sd">            db_info_dict      (dict)  --  Dictionary including database information</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable to generate db information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">database_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">database_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">db_info_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
                <span class="n">table_info_map</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">,</span> <span class="s1">&#39;information_schema&#39;</span><span class="p">,</span> <span class="s1">&#39;performance_schema&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table_info_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_size</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">)</span>
                    <span class="n">db_info_dict</span><span class="p">[</span><span class="n">database</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_info_map</span>
            <span class="k">return</span> <span class="n">db_info_dict</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to generate db information&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_default_subclient_contents"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_default_subclient_contents">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_subclient_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get default subclient contents&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default Subclient:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="n">backupset_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">_backupset_object</span>
        <span class="n">subclient_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">backupset_object</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">all_subclients</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">default_subclient</span> <span class="o">=</span> <span class="n">backupset_object</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">default_subclient</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">default_subclient</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">database_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="n">all_other_sub_clients_contents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">subclient</span> <span class="ow">in</span> <span class="n">subclient_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subclient</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">default_subclient</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient is not default subclient&quot;</span><span class="p">)</span>
                <span class="n">sub_client_new</span> <span class="o">=</span> <span class="n">backupset_object</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclient</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subc: </span><span class="si">%s</span><span class="s2"> and content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">sub_client_new</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">sub_client_new</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                    <span class="n">all_other_sub_clients_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All other subc content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">all_other_sub_clients_contents</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">database_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">]</span>
            <span class="n">system_databases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">performance_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">information_schema&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">database_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">]</span>
            <span class="n">system_databases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/performance_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;/information_schema&quot;</span><span class="p">]</span>
        <span class="n">database_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">database_list</span> <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">system_databases</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">all_other_sub_clients_contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db_name</span><span class="o">.</span><span class="n">strip</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
                <span class="n">database_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">database_list</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="MYSQLHelper.validate_db_info"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.validate_db_info">[docs]</a>    <span class="k">def</span> <span class="nf">validate_db_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database_info_1</span><span class="p">,</span>
            <span class="n">database_info_2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to validate database information</span>

<span class="sd">        Args:</span>

<span class="sd">            database_info_1     (dict)  -- information of first database</span>

<span class="sd">            database_info_2     (dict)  -- information of second database</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if database validations fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">database_info_1</span> <span class="o">==</span> <span class="n">database_info_2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;####Database Information validation success####&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DB1:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">database_info_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DB2:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">database_info_2</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Database Information validation failed..!!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.drop_table"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to drop a table from database</span>

<span class="sd">        Args:</span>

<span class="sd">            database_name     (str)  -- Name of the database</span>

<span class="sd">            table_name        (str)  -- Name of the table to drop</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable to drop the table</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">database_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">database_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tb_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">database_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">tb_name</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">db_name</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;drop table IF EXISTS `</span><span class="si">{0}</span><span class="s2">`;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tb_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not drop the table. &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.clean_up_tables"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.clean_up_tables">[docs]</a>    <span class="k">def</span> <span class="nf">clean_up_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tables_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This Function takes a dictionary as input.</span>
<span class="sd">            The dictionary has the database names as keys and table names list as values.</span>
<span class="sd">            This function calls the drop_table()</span>

<span class="sd">        Args:</span>

<span class="sd">            tables_dict     (dict)  -- Dictionary of database and tables</span>

<span class="sd">                Accepted format: {</span>
<span class="sd">                                    &quot;database1&quot;: [&quot;tab1&quot;, &quot;tab2&quot;],</span>
<span class="sd">                                    &quot;database2&quot;: [&quot;tab1&quot;, &quot;tab2&quot;],</span>
<span class="sd">                                    &quot;database3&quot;: [&quot;tab1&quot;, &quot;tab2&quot;]</span>

<span class="sd">                                 }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">each_db</span> <span class="ow">in</span> <span class="n">tables_dict</span><span class="p">:</span>
            <span class="n">table_list</span> <span class="o">=</span> <span class="n">tables_dict</span><span class="p">[</span><span class="n">each_db</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning tables:</span><span class="si">%s</span><span class="s2"> from DB:</span><span class="si">%s</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">each_db</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">each_table</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">each_db</span><span class="p">,</span> <span class="n">each_table</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.cleanup_database_contents"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.cleanup_database_contents">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_database_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subclient_content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to clean all views and tables in database</span>

<span class="sd">        Args:</span>

<span class="sd">            database_list     (list)  -- list of databases</span>

<span class="sd">                default: None</span>

<span class="sd">            subclient_content (list)  -- list of databases in subclient content</span>

<span class="sd">                default: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">database_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subclient_content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Subclient content or database list needs to passed to the method&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">:</span>
                <span class="n">subclient_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Database list is NONE, deleting tables in all &quot;</span>
                <span class="s2">&quot;the databases specified in the subclient content.&quot;</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">subclient_content</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
            <span class="n">dblist</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">dblist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mysql&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">]:</span>
                    <span class="n">contents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="n">database_list</span> <span class="o">=</span> <span class="n">contents</span>

        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
            <span class="n">table_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tables_list_for_db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="n">view_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_views</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">view_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tables and views in all the databases are dropped&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MYSQLHelper.basic_setup_on_mysql_server"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.basic_setup_on_mysql_server">[docs]</a>    <span class="k">def</span> <span class="nf">basic_setup_on_mysql_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_bin_check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function checks for basic settings on MYSQL Server</span>

<span class="sd">        Args:</span>
<span class="sd">            log_bin_check   (bool)   -- boolean value to specify if</span>
<span class="sd">            log bin value needs to be checked on server or not</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable verify basic setup on mysql server</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">auto_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">auto_path</span><span class="p">,</span> <span class="s2">&quot;MySQLUtils&quot;</span><span class="p">,</span> <span class="s2">&quot;SampleImage.wmf&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the size of file: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
            <span class="n">image_file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for max_allowed Packets for the Blob type data base&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;show variables like &#39;max_allowed_packet&#39;;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Excecuting the command: </span><span class="si">%s</span><span class="s2"> to get max_allowed Packets&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">max_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">image_file_size</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;The Input Image size: </span><span class="si">%s</span><span class="s2"> is greater than &quot;</span>
                    <span class="s2">&quot;max_allowed_packet size: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">image_file_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log_bin_check</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_bin_on_mysql_server</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised at basic_setup_on_mysql_server. &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_tables_list_for_db"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_tables_list_for_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_tables_list_for_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function get list of tables for given DataBases</span>

<span class="sd">        Args:</span>

<span class="sd">            database_name     (str)  -- Database name</span>

<span class="sd">        Returns:</span>

<span class="sd">            table_list        (list)  -- List of tables in the database</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable to get the table list</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tables_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="n">database_name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get List of tables in database:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SHOW FULL TABLES WHERE table_type = &#39;BASE TABLE&#39;;&quot;</span>
            <span class="n">list_tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">list_tb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_tb</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">list_tb</span><span class="p">:</span>
                <span class="n">tables_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">tables_list</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not get the table list. &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_table_size"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_table_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_table_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; method to get the table name and number of rows</span>
<span class="sd">        for all the tables under given database</span>

<span class="sd">        Args:</span>

<span class="sd">            database_name     (str)  -- Database name</span>

<span class="sd">        Returns:</span>

<span class="sd">            table_info_map    (dict)  -- Dictionary consisting of table name as</span>
<span class="sd">            Key and row count as value</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable get the table size</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">table_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tables_list_for_db</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>
        <span class="n">table_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_views</span><span class="p">(</span><span class="n">database_name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">table_info_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from `</span><span class="si">%s</span><span class="s2">`;&quot;</span> <span class="o">%</span> <span class="n">table</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">table_info_map</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">table_info_map</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in Getting table size&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.log_bin_on_mysql_server"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.log_bin_on_mysql_server">[docs]</a>    <span class="k">def</span> <span class="nf">log_bin_on_mysql_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function checks whether LOG_BIN ON or OFF,</span>
<span class="sd">            If its OFF then incremental(Log) backup cannot be run.</span>

<span class="sd">        Returns:</span>

<span class="sd">            True if the LOG_BIN value is on.</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if LOG_BIN value is OFF</span>

<span class="sd">                if Unable to get the LOG_BIN value</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking whether LOG_BIN has been Enable or Disable&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;show variables like &#39;log_bin&#39;;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Excecuting the command:</span><span class="si">%s</span><span class="s2"> to Check LOG_BIN Properties&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;log_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;ON&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;log_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;OFF&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Binary Logging disabled, Kindly enable &quot;</span>
                        <span class="s2">&quot;binary logging to run incremental backup&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to get the LOG_BIN value&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.create_table_with_text_db"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.create_table_with_text_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_with_text_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database_name</span><span class="p">,</span>
            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;AutomTable&quot;</span><span class="p">,</span>
            <span class="n">no_of_tables</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">column_in_each_table</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">drop_table_before_create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This function creates the table with the given name as prefix and inserts data</span>

<span class="sd">        Args:</span>

<span class="sd">            database_name               (str)  -- Database name</span>

<span class="sd">            table_name                  (str)  -- Tablename prefix to create inside the database</span>

<span class="sd">                default: &quot;AutomTable&quot;</span>

<span class="sd">            no_of_tables                (int)  -- Number of tables to create</span>

<span class="sd">                default: 500</span>

<span class="sd">            column_in_each_table        (int)  -- Number of columns to be created</span>

<span class="sd">                default: 7</span>

<span class="sd">            drop_table_before_create    (bool) -- Flag to determnine if table</span>
<span class="sd">            needs to be dropped if already exists</span>

<span class="sd">                default: False</span>

<span class="sd">        Returns:</span>

<span class="sd">            tables_created              (list) -- List of tables created under ther given database</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>
<span class="sd">                if unable create tables</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">database_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">database_name</span> <span class="o">=</span> <span class="n">database_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">database_name</span> <span class="o">=</span> <span class="n">database_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="n">tables_created</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;sys&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating tables inside DB:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">database_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">each_table</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">no_of_tables</span><span class="p">):</span>
                    <span class="n">each_table_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_txtdt_</span><span class="si">{2}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">each_table</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">drop_table_before_create</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span>
                                        <span class="n">each_table_name</span><span class="p">)</span>
                    <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_enabled</span><span class="p">:</span>
                        <span class="n">sql_query</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS `</span><span class="si">%s</span><span class="s2">`(id int unsigned primary key &quot;</span>
                            <span class="s2">&quot;AUTO_INCREMENT,column_var CHAR(254), column_string VARCHAR(254),&quot;</span>
                            <span class="s2">&quot;column_tinytext TINYTEXT NOT NULL, column_text TEXT NOT NULL, &quot;</span>
                            <span class="s2">&quot;column_mediumtext MEDIUMTEXT NOT NULL, column_longtext LONGTEXT &quot;</span>
                            <span class="s2">&quot;NOT NULL) PARTITION BY RANGE (id) (PARTITION p0 VALUES LESS THAN &quot;</span>
                            <span class="s2">&quot;(10), PARTITION p1 VALUES LESS THAN (30), PARTITION p2 VALUES LESS&quot;</span>
                            <span class="s2">&quot; THAN (45), PARTITION p3 VALUES LESS &quot;</span>
                            <span class="s2">&quot;THAN MAXVALUE)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">each_table_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sql_query</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS `</span><span class="si">%s</span><span class="s2">`(id int unsigned primary key &quot;</span>
                            <span class="s2">&quot;AUTO_INCREMENT,column_var CHAR(254), column_string VARCHAR(254),&quot;</span>
                            <span class="s2">&quot;column_tinytext TINYTEXT NOT NULL, column_text TEXT NOT NULL,&quot;</span>
                            <span class="s2">&quot; column_mediumtext MEDIUMTEXT NOT NULL, &quot;</span>
                            <span class="s2">&quot;column_longtext LONGTEXT NOT NULL)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">each_table_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span>
                    <span class="c1">#**************** Insert the values into the database*********************</span>
                    <span class="n">sample_data_for_text_data_type</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
                    <span class="n">number_of_columns</span> <span class="o">=</span> <span class="n">column_in_each_table</span>
                    <span class="k">while</span> <span class="n">number_of_columns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="s2">&quot;insert into `</span><span class="si">%s</span><span class="s2">`(`id`,`column_var`, `column_string`, `column_tinytext`</span><span class="se">\</span>
<span class="s2">                            , `column_text`, `column_mediumtext`, `column_longtext`) values </span><span class="se">\</span>
<span class="s2">                            (NULL, &#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">each_table_name</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">,</span>
                             <span class="n">sample_data_for_text_data_type</span><span class="p">))</span>
                        <span class="n">number_of_columns</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="n">tables_created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_table_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tables are created.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tables_created</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception raised at create_table_with_text_db&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.create_view"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.create_view">[docs]</a>    <span class="k">def</span> <span class="nf">create_view</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="n">view_name</span><span class="p">,</span>
            <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a view inside a database.</span>

<span class="sd">            Args:</span>
<span class="sd">                query               (str)  -- Query to create view</span>

<span class="sd">                view_name           (str)  -- Name of the view</span>

<span class="sd">                database_name       (str)  -- database name</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to create view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;create or replace view `</span><span class="si">{0}</span><span class="s2">` as </span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in creating View&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create the view&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.drop_view"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.drop_view">[docs]</a>    <span class="k">def</span> <span class="nf">drop_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drops a view inside a database.</span>

<span class="sd">            Args:</span>
<span class="sd">                view_name           (str)  -- Name of the view</span>

<span class="sd">                database_name       (str)  -- database name</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to drop view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;drop view if exists `</span><span class="si">{0}</span><span class="s2">` cascade;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in dropping View&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop the view&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.list_views"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.list_views">[docs]</a>    <span class="k">def</span> <span class="nf">list_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lists views inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                database_name       (str)  -- database name</span>

<span class="sd">            Returns:</span>

<span class="sd">                (list) -- list of views in the database</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to list views</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_database_connection</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SHOW FULL TABLES IN `</span><span class="si">{0}</span><span class="s2">` WHERE TABLE_TYPE LIKE &#39;VIEW&#39;;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">database_name</span><span class="p">)</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">response_object</span><span class="o">.</span><span class="n">rows</span>
            <span class="n">view_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">view_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">view_list</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in listing Views&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to list views&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.generate_test_data"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.generate_test_data">[docs]</a>    <span class="k">def</span> <span class="nf">generate_test_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database_prefix</span><span class="o">=</span><span class="s2">&quot;automation&quot;</span><span class="p">,</span>
            <span class="n">num_of_databases</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">num_of_tables</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">num_of_rows</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to generate test data for the automation purpose. Adds specified number of</span>
<span class="sd">        Databases, tables and Rows with a specified Prefix</span>

<span class="sd">        Args:</span>
<span class="sd">            database_prefix         (str)       -- prefix for each database created</span>

<span class="sd">                default: &quot;automation&quot;</span>

<span class="sd">            num_of_databases        (int)       -- Number of database to create</span>

<span class="sd">                default: 5</span>

<span class="sd">            num_of_tables           (int)       -- Number of tables to create inside each db</span>

<span class="sd">                default: 10</span>

<span class="sd">            num_of_rows             (int)       -- Number of rows in each table</span>

<span class="sd">                default: 50</span>

<span class="sd">        Returns:</span>
<span class="sd">            list   -- Database list created</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_db_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">each_db</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_of_databases</span><span class="p">):</span>
            <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_testdb_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_prefix</span><span class="p">,</span> <span class="n">each_db</span><span class="p">)</span>
            <span class="c1"># Check if database exists or not</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">drop_db</span><span class="p">(</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Creating </span><span class="si">%s</span><span class="s2"> MySQL database and tables in </span><span class="si">%s</span><span class="s2"> host on </span><span class="si">%s</span><span class="s2"> port with </span><span class="si">%s</span><span class="s2"> userName&quot;</span><span class="p">,</span>
                <span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">)</span>

            <span class="n">tables_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_table_with_text_db</span><span class="p">(</span>
                <span class="n">database</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;Test_table&quot;</span><span class="p">,</span>
                <span class="n">no_of_tables</span><span class="o">=</span><span class="n">num_of_tables</span><span class="p">,</span>
                <span class="n">column_in_each_table</span><span class="o">=</span><span class="n">num_of_rows</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables_created</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span>
                    <span class="s2">&quot;select count(*) from `</span><span class="si">{0}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                    <span class="s2">&quot;TestView_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                    <span class="n">database</span><span class="p">)</span>

            <span class="n">test_db_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">test_db_list</span></div>

<div class="viewcode-block" id="MYSQLHelper.cleanup_test_data"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.cleanup_test_data">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_test_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database_prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up test data which are generated for automation</span>

<span class="sd">        Args:</span>

<span class="sd">            database_prefix     (str) -- prefix for each database to be deleted</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">database_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="n">dbs_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">database_prefix</span><span class="p">):</span>
                <span class="n">dbs_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database list to delete:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dbs_to_delete</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">dbs_to_delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span><span class="o">.</span><span class="n">drop_db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All the testdata is now deleted&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.start_mysql_server"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.start_mysql_server">[docs]</a>    <span class="k">def</span> <span class="nf">start_mysql_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts the mysql server in client</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                if server start operation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_status</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting the server&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">check_registry_exists</span><span class="p">(</span><span class="s2">&quot;MySQL&quot;</span><span class="p">,</span> <span class="s2">&quot;sServerStartCmd&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please set REGKEY: &#39;sServerStartCmd&#39; on client&quot;</span><span class="p">)</span>
            <span class="n">start_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">get_registry_value</span><span class="p">(</span>
                <span class="s2">&quot;MySQL&quot;</span><span class="p">,</span> <span class="s2">&quot;sServerStartCmd&quot;</span><span class="p">)</span>
            <span class="n">start_command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> 2&gt; /dev/null&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_command</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">start_command</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sleeping for 5 seconds before checking server status&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_status</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to start the server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Output of MySQL server start script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully started the MySQL Server&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is already started&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.stop_mysql_server"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.stop_mysql_server">[docs]</a>    <span class="k">def</span> <span class="nf">stop_mysql_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Stops the mysql server in client</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                if server stop operation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_status</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping the server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OPERATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;shutdown&#39;</span>

            <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_MYSQL_SERVER_OPERATIONS</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">WINDOWS_MYSQL_SERVER_OPERATIONS</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sleeping for 5 seconds before checking server status&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_status</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to stop the server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Output of MySQL server stop script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully Stopped the MySQL Server&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is already stopped&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.get_server_status"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.get_server_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets the status of mysql server</span>

<span class="sd">        Returns:</span>

<span class="sd">            (bool)  --  True if MySQL server is running</span>
<span class="sd">                        False if MySQL server is not running</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                if unable to fetch server status</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the Server status&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;OPERATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>

        <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_MYSQL_SERVER_OPERATIONS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                <span class="n">constants</span><span class="o">.</span><span class="n">WINDOWS_MYSQL_SERVER_OPERATIONS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MYSQLHelper.run_restore"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.run_restore">[docs]</a>    <span class="k">def</span> <span class="nf">run_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">db_list</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">table_level_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clone_env</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clone_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">redirect_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">destination_client_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">destination_instance_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates the restore job for the specified subclient</span>

<span class="sd">        Args:</span>

<span class="sd">            db_list                     (list)   -- List of databases to restore</span>

<span class="sd">            copy_precedence             (int)    -- Copy precedence number</span>

<span class="sd">                default: None</span>

<span class="sd">            table_level_restore         (bool)   -- Table level restore flag</span>

<span class="sd">                default: False</span>

<span class="sd">            clone_env                   (bool)  --  boolean to specify whether the database</span>
<span class="sd">            should be cloned or not</span>

<span class="sd">                default: False</span>

<span class="sd">            clone_options               (dict)  --  clone restore options passed in a dict</span>

<span class="sd">                default: None</span>

<span class="sd">                Accepted format: {</span>
<span class="sd">                                    &quot;stagingLocaion&quot;: &quot;/gk_snap&quot;,</span>
<span class="sd">                                    &quot;forceCleanup&quot;: True,</span>
<span class="sd">                                    &quot;port&quot;: &quot;5595&quot;,</span>
<span class="sd">                                    &quot;libDirectory&quot;: &quot;&quot;,</span>
<span class="sd">                                    &quot;isInstanceSelected&quot;: True,</span>
<span class="sd">                                    &quot;reservationPeriodS&quot;: 3600,</span>
<span class="sd">                                    &quot;user&quot;: &quot;&quot;,</span>
<span class="sd">                                    &quot;binaryDirectory&quot;: &quot;/usr/bin&quot;</span>

<span class="sd">                                 }</span>

<span class="sd">            redirect_path               (str)   --  Path specified in advanced restore options</span>
<span class="sd">            in order to perform redirect restore</span>

<span class="sd">                default: None</span>

<span class="sd">            destination_client_name     (str)   --  Destination client name</span>

<span class="sd">                defsult: None</span>

<span class="sd">            destination_instance_name   (str)   --  Destination instance name</span>

<span class="sd">                default: None</span>

<span class="sd">        Returns:</span>

<span class="sd">            (obj)   -- returns restore JOB object</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception           --  if restore job fails to run</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">redirect_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_client_name</span><span class="p">:</span>
            <span class="n">destination_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_instance_name</span><span class="p">:</span>
            <span class="n">destination_instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">instance_name</span>
        <span class="k">if</span> <span class="n">redirect_path</span><span class="p">:</span>
            <span class="n">redirect_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore_in_place</span><span class="p">(</span>
            <span class="n">db_list</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">job_results_directory</span><span class="p">,</span>
            <span class="n">destination_client_name</span><span class="p">,</span>
            <span class="n">destination_instance_name</span><span class="p">,</span>
            <span class="n">log_restore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">media_agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
            <span class="n">table_level_restore</span><span class="o">=</span><span class="n">table_level_restore</span><span class="p">,</span>
            <span class="n">clone_env</span><span class="o">=</span><span class="n">clone_env</span><span class="p">,</span>
            <span class="n">clone_options</span><span class="o">=</span><span class="n">clone_options</span><span class="p">,</span>
            <span class="n">redirect_enabled</span><span class="o">=</span><span class="n">redirect_enabled</span><span class="p">,</span>
            <span class="n">redirect_path</span><span class="o">=</span><span class="n">redirect_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;####Started Restore with Job ID: </span><span class="si">%s</span><span class="s2">####&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to run restore job with error:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished restore job&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="MYSQLHelper.snap_blocklevel_testcase"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.snap_blocklevel_testcase">[docs]</a>    <span class="k">def</span> <span class="nf">snap_blocklevel_testcase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase_type</span><span class="o">=</span><span class="s2">&quot;ACC1&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to perform backup/restore and validation of snap and</span>
<span class="sd">        block level feature TCs</span>

<span class="sd">        Args:</span>

<span class="sd">                testcase_type       (str)   --  testcase type</span>

<span class="sd">                    default: None</span>

<span class="sd">                    Accepted values: ACC1/INCREMENTAL/SYNTH_FULL/POINT_IN_TIME</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span> <span class="o">=</span> <span class="n">DbHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="c1"># Checking the basic settings required for Automation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Check Basic Setting of mysql server before stating the test cases&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_setup_on_mysql_server</span><span class="p">()</span>

        <span class="c1"># populate test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test Data generated..!!&quot;</span><span class="p">)</span>

        <span class="c1">###################### Running Full Backup ########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting FULL backup job&quot;</span><span class="p">)</span>
        <span class="n">full_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">)</span>

        <span class="n">full_job_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">full_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Native Snap engine is being run. Backup &quot;</span>
                    <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="s2">&quot;automation_inc&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test Data generated before Incremental..!!&quot;</span><span class="p">)</span>

        <span class="c1"># run incremental backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Incremental backup job&quot;</span><span class="p">)</span>
        <span class="n">inc_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="n">inc_with_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Wait for log backup to complete</span>
        <span class="n">inc_job_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">inc_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Native Snap engine is being run. Backup &quot;</span>
                    <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;synth_full&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">db_size_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_mysql_server</span><span class="p">()</span>
                <span class="c1"># Restore from Snap copy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">([</span><span class="s2">&quot;/&quot;</span><span class="p">])</span>
                <span class="n">db_size_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                    <span class="n">db_size_before</span><span class="p">,</span> <span class="n">db_size_after</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Running backup copy job for storage policy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;synth_full&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">synthfull_backup_validation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running a incremental backup after the synthful job&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding more data to run incremental backup&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="s2">&quot;automation_inc_sf&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test Data generated before Incremental..!!&quot;</span><span class="p">)</span>

            <span class="c1"># run incremental backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Incremental backup job&quot;</span><span class="p">)</span>
            <span class="n">inc_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="n">inc_with_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Wait for log backup to complete</span>
            <span class="n">inc_job_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">inc_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Native Snap engine is being run. Backup &quot;</span>
                        <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Running backup copy job for storage policy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>

        <span class="n">storage_policy_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
        <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">storage_policy_object</span><span class="o">.</span><span class="n">get_copy_precedence</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy precedence of primary copy is:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_precedence</span><span class="p">)</span>

        <span class="n">db_size_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>

        <span class="c1"># stopping mysql server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_mysql_server</span><span class="p">()</span>
        <span class="c1"># Restore from Primary copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span><span class="n">db_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">],</span> <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span> <span class="n">table_level_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">db_size_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
            <span class="n">db_size_before</span><span class="p">,</span> <span class="n">db_size_after</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.snap_prerequirement_check"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.snap_prerequirement_check">[docs]</a>    <span class="k">def</span> <span class="nf">snap_prerequirement_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_blocklevel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to check if the pre requirement to</span>
<span class="sd">        run snap/block level testcase is met or not</span>

<span class="sd">        Args:</span>

<span class="sd">            is_blocklevel    (bool)   -- flag to determine if the blocklevel</span>
<span class="sd">            testcase being run</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                If client is windows</span>

<span class="sd">                If IntelliSnap is not enabled</span>

<span class="sd">                If Block level is not enabled</span>

<span class="sd">                If Block level testcase is being run on windows</span>

<span class="sd">                If sServerStartCmd regkey is not set on client</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Windows doesn&#39;t support block level feature&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if the intelliSnap is enabled on subclient or not&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_intelli_snap_enabled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Intellisnap is not enabled for subclient&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;IntelliSnap is enabled on subclient&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_blocklevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if the Block level backup is enabled on subclient or not&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_blocklevel_backup_enabled</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Block level backup is not enabled for subclient&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Block level backup is enabled on subclient&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Block level testcases cannot be run on Windows Machine&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if the &#39;sServerStartCmd&#39; REGKEY enabled on client or not&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">check_registry_exists</span><span class="p">(</span><span class="s2">&quot;MySQL&quot;</span><span class="p">,</span> <span class="s2">&quot;sServerStartCmd&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please set REGKEY: &#39;sServerStartCmd&#39; on client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;sServerStartCmd&#39; REGKEY enabled on client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Check Basic Setting of mysql server before stating the test cases&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_setup_on_mysql_server</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_bin_on_mysql_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="MYSQLHelper.blocklevel_redirect_restore"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.blocklevel_redirect_restore">[docs]</a>    <span class="k">def</span> <span class="nf">blocklevel_redirect_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">destination_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">destination_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_blocklevel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to perform redirect restore testcase for snap and block level cases</span>

<span class="sd">        Args:</span>

<span class="sd">            destination_client    (obj)   -- Destination client object</span>

<span class="sd">                default: None</span>

<span class="sd">            destination_instance  (obj)   -- Destination Instance Object</span>

<span class="sd">                default: None</span>

<span class="sd">            is_blocklevel         (bool)  -- flag to determine if the blocklevel</span>
<span class="sd">            testcase being run</span>

<span class="sd">                default: True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span> <span class="o">=</span> <span class="n">DbHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_prerequirement_check</span><span class="p">(</span><span class="n">is_blocklevel</span><span class="o">=</span><span class="n">is_blocklevel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">destination_instance</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_client</span><span class="p">:</span>
                <span class="n">destination_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="n">destination_subclient</span> <span class="o">=</span> <span class="n">destination_instance</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;defaultdummybackupset&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destination_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span>
            <span class="n">destination_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="n">destination_subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span>

        <span class="n">destination_mysql_helper</span> <span class="o">=</span> <span class="n">MYSQLHelper</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
            <span class="n">destination_subclient</span><span class="p">,</span>
            <span class="n">destination_instance</span><span class="p">,</span>
            <span class="n">destination_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="n">destination_instance</span><span class="o">.</span><span class="n">mysql_username</span><span class="p">)</span>

        <span class="c1"># populate test data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test Data generated..!!&quot;</span><span class="p">)</span>

        <span class="c1">###################### Running Full Backup ########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting FULL backup job&quot;</span><span class="p">)</span>
        <span class="n">full_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">)</span>

        <span class="n">full_job_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">full_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Native Snap engine is being run. Backup &quot;</span>
                    <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Snap engine is not native.&quot;</span><span class="p">)</span>
            <span class="c1">###### Run backup copy job #########</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Running backup copy job for storage policy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="n">copy_precedence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Copy precedence of &#39;primary snap&#39; copy is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="p">)</span>

        <span class="c1">#### Redirect Restore to same instance</span>
        <span class="n">storage_policy_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
        <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">storage_policy_object</span><span class="o">.</span><span class="n">get_copy_precedence</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy precedence of primary copy is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_precedence</span><span class="p">)</span>

        <span class="n">db_size_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>

        <span class="n">source_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_directory</span>
        <span class="n">data_directory</span> <span class="o">=</span> <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">data_directory</span>
        <span class="n">redirect_to</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_red&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
        <span class="n">redirect_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\u0015</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_data_dir</span><span class="p">,</span> <span class="n">redirect_to</span><span class="p">)</span>

        <span class="n">config_file_location</span> <span class="o">=</span> <span class="n">destination_instance</span><span class="o">.</span><span class="n">config_file</span>
        <span class="n">config_file_destination</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.orig&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file_location</span><span class="p">)</span>
        <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">_redirect_operations</span><span class="p">(</span>
            <span class="n">config_source</span><span class="o">=</span><span class="n">config_file_location</span><span class="p">,</span> <span class="n">config_destination</span><span class="o">=</span><span class="n">config_file_destination</span><span class="p">)</span>

        <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">stop_mysql_server</span><span class="p">()</span>
        <span class="c1"># Restore from Primary copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
            <span class="n">db_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;/&quot;</span><span class="p">],</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
            <span class="n">redirect_path</span><span class="o">=</span><span class="n">redirect_path</span><span class="p">,</span>
            <span class="n">destination_client_name</span><span class="o">=</span><span class="n">destination_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
            <span class="n">destination_instance_name</span><span class="o">=</span><span class="n">destination_instance</span><span class="o">.</span><span class="n">instance_name</span><span class="p">)</span>

        <span class="n">db_size_after</span> <span class="o">=</span> <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
            <span class="n">db_size_before</span><span class="p">,</span> <span class="n">db_size_after</span><span class="p">)</span>

        <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">_redirect_operations</span><span class="p">(</span><span class="n">redirect_directory</span><span class="o">=</span><span class="n">redirect_to</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring the config file&quot;</span><span class="p">)</span>
        <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">_redirect_operations</span><span class="p">(</span>
            <span class="n">config_source</span><span class="o">=</span><span class="n">config_file_destination</span><span class="p">,</span> <span class="n">config_destination</span><span class="o">=</span><span class="n">config_file_location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to start the server&quot;</span><span class="p">)</span>
        <span class="n">destination_mysql_helper</span><span class="o">.</span><span class="n">start_mysql_server</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_redirect_operations</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">redirect_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">config_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">config_destination</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to perform operations related to redirect restore</span>

<span class="sd">        Args:</span>

<span class="sd">            redirect_directory  (str)   --  postgres redirect directory path</span>

<span class="sd">                default: None</span>

<span class="sd">            config_source       (str)   --  config file source path</span>

<span class="sd">                default: None</span>

<span class="sd">            config_destination  (str)   --  config file destination path</span>

<span class="sd">                default: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">redirect_directory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping restored server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_mysql_server</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up redirected path&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">redirect_directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Redirected directory is removed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_source</span> <span class="ow">and</span> <span class="n">config_destination</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">check_file_exists</span><span class="p">(</span><span class="n">config_destination</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">config_destination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Copying config file:</span><span class="si">%s</span><span class="s2"> to:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">config_source</span><span class="p">,</span> <span class="n">config_destination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">copy_folder</span><span class="p">(</span>
                <span class="n">config_source</span><span class="p">,</span> <span class="n">config_destination</span><span class="p">)</span>

<div class="viewcode-block" id="MYSQLHelper.innodb_file_per_table"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.innodb_file_per_table">[docs]</a>    <span class="k">def</span> <span class="nf">innodb_file_per_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks if the innodb_file_per_table is enabled</span>
<span class="sd">        in the server or not</span>

<span class="sd">        Returns:</span>

<span class="sd">            (bool) -- Returns True if the flag is enabled</span>
<span class="sd">                      Returns false if the flag is disabled</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if unable to get innodb_file_per_table value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_connect</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MySQL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;show variables like &#39;innodb_file_per_table&#39;;&quot;</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_connect</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response_object</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;on&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get innodb_file_per_table value&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.is_xtrabackup_eligible"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.is_xtrabackup_eligible">[docs]</a>    <span class="k">def</span> <span class="nf">is_xtrabackup_eligible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if the server is eligible to run xtrabackup</span>

<span class="sd">        Returns:</span>
<span class="sd">            (bool)  --  Returns True if eligible</span>
<span class="sd">                        Returns False if not eligible</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">client_object</span><span class="o">.</span>\
                <span class="n">agents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MySQL&quot;</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_instance_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Windows doesn&#39;t support xtrabackup&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">is_xtrabackup_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;xtrabackup is not enabled in the instance property&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">innodb_file_per_table</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;innodb_file_per_table is not ON&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">version</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\D&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="MYSQLHelper.is_xtrabackup_effective"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.is_xtrabackup_effective">[docs]</a>    <span class="k">def</span> <span class="nf">is_xtrabackup_effective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_job</span><span class="p">,</span> <span class="n">client_log_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to check if the xtrabackup is being used for the backup</span>

<span class="sd">        Args:</span>
<span class="sd">            backup_job  (str)           --  Backup job ID</span>
<span class="sd">            client_log_directory(str)   --  Client log directory</span>
<span class="sd">                default: None</span>

<span class="sd">        Returns:</span>
<span class="sd">            (bool)  --  True if xtrabackup is effective</span>
<span class="sd">                        False if xtrabackup is not effective</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                If client machine is windows</span>

<span class="sd">                If failed to run command in the client</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="n">mysql_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_directory</span><span class="p">,</span> <span class="s2">&quot;MySqlBackupChild.log&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">client_log_directory</span><span class="p">:</span>
                <span class="n">mysql_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
                    <span class="n">client_log_directory</span><span class="p">,</span> <span class="s2">&quot;MySqlBackupChild.log&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Set client object or provide client log directory&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Windows doesn&#39;t support xtrabackup&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span>
            <span class="s2">&quot;cat </span><span class="si">%s</span><span class="s2"> | grep </span><span class="si">%s</span><span class="s2">| awk &#39;{for(i=1;i&lt;=NF;i++)if($i~/xtraBackupFlag/)print $(i+1)}&#39; | head -n 1&quot;</span> <span class="o">%</span><span class="p">(</span>
                <span class="n">mysql_log</span><span class="p">,</span> <span class="n">backup_job</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;[1]&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span></div>

<div class="viewcode-block" id="MYSQLHelper.backup_job_ran_on"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.backup_job_ran_on">[docs]</a>    <span class="k">def</span> <span class="nf">backup_job_ran_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to get the client and instance details on which backup job was run</span>

<span class="sd">        Args:</span>
<span class="sd">            backup_job   (obj)   --  Backup job object</span>

<span class="sd">        Returns:</span>
<span class="sd">            (list)  --  List containing [client_name, instance_name, job_status]</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                If could not get the backup job run details</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select dbo.getMysqlProxyAndInstance(</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">backup_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">subclient_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">details</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">backup_job</span><span class="o">.</span><span class="n">status</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">details</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not get the backup job run details &quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.populate_database"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.populate_database">[docs]</a>    <span class="k">def</span> <span class="nf">populate_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts test tables and views in the each</span>
<span class="sd">        database in the subclient content</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_content (list)    --  databases in the subclient</span>

<span class="sd">                    default: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Timestamp For Tablenames</span>
        <span class="n">timestamp_full</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Populating Databases before Backup&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subclient_content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Subclient content needs to passed to the method&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subclient_content</span><span class="p">:</span>
            <span class="n">subclient_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span>
        <span class="k">for</span> <span class="n">each_db</span> <span class="ow">in</span> <span class="n">subclient_content</span><span class="p">:</span>
            <span class="n">table_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_table_with_text_db</span><span class="p">(</span>
                <span class="n">each_db</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;full_38610_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp_full</span><span class="p">),</span>
                <span class="n">no_of_tables</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">column_in_each_table</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">drop_table_before_create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">each_db</span> <span class="o">=</span> <span class="n">each_db</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">each_db</span> <span class="o">=</span> <span class="n">each_db</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">table_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span>
                    <span class="s2">&quot;select count(*) from `</span><span class="si">{0}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                    <span class="s2">&quot;TestView_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                    <span class="n">each_db</span><span class="p">)</span></div>

<div class="viewcode-block" id="MYSQLHelper.run_proxy_backup"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.run_proxy_backup">[docs]</a>    <span class="k">def</span> <span class="nf">run_proxy_backup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">backup_type</span><span class="p">,</span>
            <span class="n">inc_with_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">testcase_type</span><span class="o">=</span><span class="s2">&quot;PROXY_ACC1&quot;</span><span class="p">,</span>
            <span class="n">truncate_logs_on_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">do_not_truncate_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates the backup job on proxy subclient and checks if the proxy is honored</span>

<span class="sd">            Args:</span>

<span class="sd">                backup_type    (str)   -- Backup type to perform on subclient</span>
<span class="sd">                Either FULL or INCREMENTAL</span>

<span class="sd">                inc_with_data  (bool)  --  flag to determine if the incremental backup</span>
<span class="sd">                includes data or not</span>

<span class="sd">                testcase_type  (str)   --  Testcase type which is being run</span>

<span class="sd">                    default:         &quot;PROXY ACC1&quot;</span>

<span class="sd">                    Accepted Values: PROXY_ACC1/PROXY_FAILOVER/DO_NOT_TRUNCATE_LOGS_ON_PROXY</span>

<span class="sd">                truncate_logs_on_source (bool)  --  flag to determine if the logs to be</span>
<span class="sd">                truncated on master client</span>

<span class="sd">                    default: False</span>

<span class="sd">                do_not_truncate_logs    (bool)  --  flag to determine if the proxy logs</span>
<span class="sd">                needs to be truncated or not</span>

<span class="sd">                    default: False</span>

<span class="sd">            Returns:</span>
<span class="sd">                job            (obj)   -- Returns Job object</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>

<span class="sd">                    if proxy settings are not honored</span>

<span class="sd">                    if unable to run backup job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#####Starting Subclient </span><span class="si">%s</span><span class="s2"> Backup#####&quot;</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inc_with_data</span> <span class="ow">or</span> <span class="n">truncate_logs_on_source</span> <span class="ow">or</span> <span class="n">do_not_truncate_logs</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span>
                <span class="n">backup_type</span><span class="p">,</span> <span class="n">inc_with_data</span><span class="o">=</span><span class="n">inc_with_data</span><span class="p">,</span>
                <span class="n">truncate_logs_on_source</span><span class="o">=</span><span class="n">truncate_logs_on_source</span><span class="p">,</span>
                <span class="n">do_not_truncate_logs</span><span class="o">=</span><span class="n">do_not_truncate_logs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">backup_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Started </span><span class="si">%s</span><span class="s2"> backup with Job ID: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;FULL&quot;</span> <span class="ow">in</span> <span class="n">backup_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking if the proxy backup is effective&quot;</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_ran_on</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;completed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">details</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">while</span> <span class="n">job</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;backup&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s2">&quot;pending&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> \
                    <span class="s2">&quot;completed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;proxy_failover&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span> <span class="ow">and</span> \
                            <span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">instance_name</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                            <span class="s2">&quot;In PROXY_FAIL_OVER testcase, backup job is expected to run on Master&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="p">[</span><span class="s1">&#39;clientName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="p">[</span><span class="s1">&#39;instanceName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Backup job is expected to run on proxy client&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Proxy is honored during backup job&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to run </span><span class="si">{0}</span><span class="s2"> backup job with error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">backup_type</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished </span><span class="si">%s</span><span class="s2"> backup job&quot;</span><span class="p">,</span> <span class="n">backup_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runBackupOnProxy&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_job_ran_on</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span> <span class="ow">and</span> \
                <span class="n">details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">instance_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Transactional logs are expected to run on Master. Please check the logs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="MYSQLHelper.proxy_testcase"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.proxy_testcase">[docs]</a>    <span class="k">def</span> <span class="nf">proxy_testcase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testcase_type</span><span class="o">=</span><span class="s2">&quot;PROXY_ACC1&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to run proxy testcases</span>

<span class="sd">        Args:</span>
<span class="sd">            testcase_type  (str)   --  Testcase type which is being run</span>

<span class="sd">                    default:         &quot;PROXY ACC1&quot;</span>

<span class="sd">                    Accepted Values: PROXY_ACC1/PROXY_FAILOVER/DO_NOT_TRUNCATE_LOGS_ON_PROXY</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Proxy testcase being run is:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">testcase_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Check Basic Setting of mysql server before stating the test cases&quot;</span><span class="p">)</span>
        <span class="n">proxy_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="p">[</span><span class="s1">&#39;clientName&#39;</span><span class="p">])</span>
        <span class="n">agent_object</span> <span class="o">=</span> <span class="n">proxy_client</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MySQL&#39;</span><span class="p">)</span>
        <span class="n">proxy_instance</span> <span class="o">=</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="p">[</span><span class="s1">&#39;instanceName&#39;</span><span class="p">])</span>
        <span class="n">proxy_backupset</span> <span class="o">=</span> <span class="n">proxy_instance</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defaultdummybackupset&#39;</span><span class="p">)</span>
        <span class="n">proxy_subclient</span> <span class="o">=</span> <span class="n">proxy_backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">proxy_helper_object</span> <span class="o">=</span> <span class="n">MYSQLHelper</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
            <span class="n">proxy_subclient</span><span class="p">,</span>
            <span class="n">proxy_instance</span><span class="p">,</span>
            <span class="n">proxy_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="n">proxy_instance</span><span class="o">.</span><span class="n">mysql_username</span><span class="p">)</span>
        <span class="n">proxy_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MySQL</span><span class="p">(</span>
            <span class="n">proxy_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="n">proxy_helper_object</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span> <span class="n">proxy_helper_object</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="n">proxy_helper_object</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">start_slave</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basic_setup_on_mysql_server</span><span class="p">()</span>

        <span class="c1">### Checking whether Binary Logging is enabled or not in MySQL Server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_bin_on_mysql_server</span><span class="p">()</span>

        <span class="c1">#### check if the proxy is enabled on instance and subclient</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">proxy_options</span><span class="p">[</span>
                <span class="s1">&#39;isProxyEnabled&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_proxy_enabled</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Check if the proxy is enabled on instance and subclient&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read subclient content&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient Content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Subclient Content is empty please add subclient content from Commcell Console&quot;</span>
            <span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">database</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;mysql&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">contents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;mysql&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;sys&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">contents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span>

        <span class="c1">### Populating Databases For Full Backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_database</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;proxy_failover&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">stop_slave</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;do_not_truncate_logs_on_proxy&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">binary_log_info_before</span> <span class="o">=</span> <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">get_binary_logs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_proxy_backup</span><span class="p">(</span>
                <span class="s1">&#39;FULL&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">testcase_type</span><span class="p">,</span> <span class="n">do_not_truncate_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">### Running Full Backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_proxy_backup</span><span class="p">(</span><span class="s1">&#39;FULL&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">testcase_type</span><span class="p">)</span>

            <span class="c1">### Running Incremental Backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_proxy_backup</span><span class="p">(</span><span class="s1">&#39;INCREMENTAL&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">testcase_type</span><span class="p">)</span>

            <span class="c1">### Getting Database Size and table sizes (Incremental 2)</span>
            <span class="n">database_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">(</span>
                <span class="n">contents</span><span class="p">)</span>

            <span class="c1">### drop all subclient contents</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_database_contents</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropped all database contents before restore&quot;</span><span class="p">)</span>
            <span class="c1">### Running In Place Data + Log Restore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running In Place Restore - Data + Log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">([</span><span class="s2">&quot;/&quot;</span><span class="p">])</span>

            <span class="c1">### Getting Database Size and table sizes (Incremental 2)</span>
            <span class="n">data_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">(</span>
                <span class="n">contents</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###Starting data validation after restore###&quot;</span><span class="p">)</span>
            <span class="c1"># validating data after restore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">database_info</span><span class="p">,</span>
                <span class="n">data_after_restore</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;proxy_failover&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">is_failover_to_production</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">start_slave</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;do_not_truncate_logs_on_proxy&quot;</span> <span class="ow">in</span> <span class="n">testcase_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">binary_log_info_after</span> <span class="o">=</span> <span class="n">proxy_database_object</span><span class="o">.</span><span class="n">get_binary_logs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">binary_log_info_after</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">binary_log_info_before</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="n">binary_log_info_after</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">binary_log_info_before</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Do not truncate logs on proxy was selected during backup, &quot;</span>
                    <span class="s2">&quot;logs on proxy before backup was expected to be more or &quot;</span>
                    <span class="s2">&quot;equal to number of logs after backup&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logs in proxy were not truncated&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_mysql_database_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the mysql database connection</span>
<span class="sd">        Args:</span>
<span class="sd">                database    (str)  -- Database name</span>
<span class="sd">                            default value None</span>
<span class="sd">            Returns:</span>
<span class="sd">                Mysql database connection object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MySQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span>\
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_port</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="n">mysql_db_connection_object</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">MySQL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">host_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span> <span class="o">=</span> <span class="n">mysql_db_connection_object</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_db_connection_object</span>

<div class="viewcode-block" id="MYSQLHelper.run_data_restore_and_validation"><a class="viewcode-back" href="../../../source/Database.MySQLUtils.html#Database.MySQLUtils.mysqlhelper.MYSQLHelper.run_data_restore_and_validation">[docs]</a>    <span class="k">def</span> <span class="nf">run_data_restore_and_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_restore</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">database_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to run inplace restore and validate data after restore</span>

<span class="sd">            Args:</span>

<span class="sd">                data_restore   (bool)  -- data restore flag</span>

<span class="sd">                default: True</span>

<span class="sd">                log_restore    (bool)  -- log restore flag</span>

<span class="sd">                default: True</span>

<span class="sd">                database_info  (dict)  -- database information to validate \</span>
<span class="sd">                against the data after restore</span>

<span class="sd">                default: None</span>
<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>

<span class="sd">                    if database information dict is not provided</span>

<span class="sd">                    if failed to run restore job</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;database information needed to validate the data after restore&quot;</span><span class="p">)</span>
            <span class="c1"># Removing mysql and sys system db&#39;s from restore list</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">mysql&#39;</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">mysql&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">sys&#39;</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">sys&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cloud_db</span><span class="p">:</span>
                <span class="n">staging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">instance_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">staging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">job_results_directory</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mysql_instance</span><span class="o">.</span><span class="n">restore_in_place</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span>
                                                       <span class="n">staging</span><span class="p">,</span>
                                                       <span class="n">data_restore</span><span class="o">=</span><span class="n">data_restore</span><span class="p">,</span>
                                                       <span class="n">log_restore</span><span class="o">=</span><span class="n">log_restore</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Started restore with Job ID: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run data only restore job with error: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully finished data only restore job&quot;</span><span class="p">)</span>
            <span class="c1"># Getting Database Size and Table sizes after Restore</span>
            <span class="n">data_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_database_information</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;###Starting data validation after restore###&quot;</span><span class="p">)</span>
            <span class="c1"># validating data after restore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">database_info</span><span class="p">,</span>
                <span class="n">data_after_restore</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">job</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;An error occurred while running restore and validation&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">excp</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>