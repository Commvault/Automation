

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Database.PostgreSQL.PostgresUtils.pgsqlhelper &mdash; Commvault Automation 11.18 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>Database.PostgreSQL.PostgresUtils.pgsqlhelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Database.PostgreSQL.PostgresUtils.pgsqlhelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Main file for performing Postgres related operations.</span>

<span class="sd">PostgresHelper, UnixObject and WindowsObject are 3 classes defined in this file.</span>

<span class="sd">PostgresHelper: Class for performing postgres related operation</span>


<span class="sd">PostgresHelper:</span>
<span class="sd">    __init__()                          -- initialise object of PostgresHelper object</span>

<span class="sd">    get_postgres_db_password()          -- Gets the db password of the instance</span>

<span class="sd">    strip_slash_char()                  -- strips the &quot;/&quot; character from database</span>

<span class="sd">    generate_table_size()               -- Generates the size of the table which is given as input</span>

<span class="sd">    get_tables_in_db()                  -- Get the list of tables available in the given</span>
<span class="sd">                                           Database Name</span>

<span class="sd">    get_schema_tables_in_db()           -- Gets the list of tables, schemas, sequences in a DB</span>

<span class="sd">    generate_db_info()                  -- Gets complete metadata info of Database</span>

<span class="sd">    validate_db_info()                  -- Takes two Database Information Maps and</span>
<span class="sd">                                            verifies if both have same info</span>

<span class="sd">    generate_test_data()                -- Function to generate test data for the</span>
<span class="sd">                                           automation purpose.</span>
<span class="sd">                                           Adds specified number of Databases, tables and</span>
<span class="sd">                                           rows with a specified Prefix</span>

<span class="sd">    insert_data_into_tables()           -- Inserts random strings to the table specified</span>

<span class="sd">    get_row_count()                     -- Gets the Number of rows in the table</span>

<span class="sd">    create_table()                      -- Creates a table of given name in the specified database</span>

<span class="sd">    drop_table()                        -- drops a table of given name in the specified database</span>

<span class="sd">    create_view()                       -- creates a view inside a database</span>

<span class="sd">    drop_view()                         -- drops a view inside a database</span>

<span class="sd">    list_views()                        -- lists views inside a database</span>

<span class="sd">    create_function()                   -- creates a function inside a database.</span>

<span class="sd">    drop_function()                     -- crops a function inside a database</span>

<span class="sd">    list_functions()                    -- lists all functions inside a database</span>

<span class="sd">    create_trigger()                    -- creates a trigger inside a database</span>

<span class="sd">    drop_trigger()                      -- drops a trigger inside a database.</span>

<span class="sd">    list_triggers()                     -- lists all triggers defined for the database server</span>

<span class="sd">    cleanup_tc_db()                     -- Clean Up test Databases of failed runs or</span>
<span class="sd">                                           completed TCs if exists</span>

<span class="sd">    cleanup_test_data()                 -- Cleans up test data which are generated for automation</span>

<span class="sd">    get_ma_name()                       -- Gets the media agent associated with a storage policy</span>

<span class="sd">    get_size_of_app_in_backup_phase()   -- Gets the size of application in backup phase</span>

<span class="sd">    start_postgres_server()             -- Starts the postgres server in client</span>

<span class="sd">    stop_postgres_server()              -- Stops the postgres server in client</span>

<span class="sd">    get_postgres_status()               -- Gets the postgres server status</span>

<span class="sd">    get_postgres_data_dir()             -- Gets the data directory of postgres server</span>

<span class="sd">    check_chunk_commited()              -- Checks for chunk commit in the commserver for the</span>
<span class="sd">                                            initiated job</span>

<span class="sd">    get_subclient_database_list()       -- method to get databases associated with a given</span>
<span class="sd">    subclient in dumpbased backupset</span>

<span class="sd">    run_restore()                       -- initiates restore job from subclient level and</span>
<span class="sd">    waits for completion</span>

<span class="sd">    clone_backup_restore()              -- method to perform backup/restore and validation</span>
<span class="sd">    of clone feature TCs</span>

<span class="sd">    blocklevel_backup_restore()         -- method to perform backup/restore and validation</span>
<span class="sd">    of block level feature TCs</span>

<span class="sd">    cleanup_database_directories()      -- method to remove data and wal directory before</span>
<span class="sd">    fsbased restore</span>

<span class="sd">    get_replication_job()               -- method to fetch the replication job associated with</span>
<span class="sd">    live sync operation from commserv database</span>

<span class="sd">    check_postgres_recovery_mode()      -- checks if the postgres server is in recovery mode</span>

<span class="sd">    create_path_for_tablespace()        -- method to create tablespace directory</span>


<span class="sd">PostgresHelper instance Attributes</span>
<span class="sd">----------------------------------</span>

<span class="sd">    **postgres_port**                   --  returns the `postgres_port` of postgres server</span>

<span class="sd">    **postgres_db_user_name**           --  returns the `postgres db user name` of postgres server</span>

<span class="sd">    **postgres_server_url**             --  returns the `postgres server url` of postgres server</span>

<span class="sd">    **postgres_log_directory**          --  returns PostgresBackup.log path in the client</span>

<span class="sd">    **is_index_v2_postgres**            --  returns True if Postgres index version is V2</span>

<span class="sd">    **postgres_password**               --  returns postgres server password</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">idautils</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">database_helper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">cvhelper</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="k">import</span> <span class="n">machine</span>
<span class="kn">from</span> <span class="nn">Database.dbhelper</span> <span class="k">import</span> <span class="n">DbHelper</span>


<div class="viewcode-block" id="PostgresHelper"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper">[docs]</a><span class="k">class</span> <span class="nc">PostgresHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper class to perform Postgres operations&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the PostgresHelper object.</span>

<span class="sd">            Args:</span>
<span class="sd">                commcell             (obj)  --  Commcell object</span>

<span class="sd">                instance             (obj)  --  Postgres instance object</span>

<span class="sd">                client               (obj)  --  Client object</span>

<span class="sd">            Returns:</span>
<span class="sd">                object - instance of this class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">get_csdb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_client</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_agent_object</span><span class="o">.</span><span class="n">_client_object</span><span class="o">.</span><span class="n">client_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_instance</span> <span class="o">=</span> <span class="n">instance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_server_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_user_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tables</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_rows</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_number</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_db_password</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_connect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postgres_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter for the postgres port &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_port</span>

    <span class="nd">@postgres_port</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">postgres_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setter for the postgres port &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_port</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postgres_db_user_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter for the postgres db username &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_user_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postgres_server_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; getter for the postgres server URL &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgres_server_url</span>

<div class="viewcode-block" id="PostgresHelper.get_postgres_db_password"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_postgres_db_password">[docs]</a>    <span class="k">def</span> <span class="nf">get_postgres_db_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the db password of the instance</span>

<span class="sd">                Raises:</span>
<span class="sd">                    Exception:</span>
<span class="sd">                        if failed to get the db password of the instance &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Select attrVal from app_instanceprop where componentNameId = </span><span class="si">{0}</span><span class="s2"> and &quot;</span>
            <span class="s2">&quot;attrName = &#39;PostgreSQL SA password&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_instance</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span> <span class="o">=</span> <span class="n">cvhelper</span><span class="o">.</span><span class="n">format_string</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">,</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Password for postgres db is fetched Successfully&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get the postgres database password&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.strip_slash_char"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.strip_slash_char">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">strip_slash_char</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        strips the &quot;/&quot; character from database</span>

<span class="sd">        When we fetch subclient content from CSDB, the</span>
<span class="sd">        database names are prefixed with &quot;/&quot; character</span>
<span class="sd">        hence we use this fucntion to strip that from db name</span>


<span class="sd">        Args:</span>
<span class="sd">            db_list     (list)  --  Database List fetched from csdb</span>
<span class="sd">                                        having / character as prefix</span>

<span class="sd">            Returns:</span>
<span class="sd">                list - Db List without &quot;/&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_list_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">db_list</span><span class="p">:</span>
            <span class="n">db_list_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">db_list_new</span></div>

<div class="viewcode-block" id="PostgresHelper.generate_table_size"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.generate_table_size">[docs]</a>    <span class="k">def</span> <span class="nf">generate_table_size</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates the size of the table which is given as input</span>
<span class="sd">            Args:</span>

<span class="sd">                database    (str)  -- Database name</span>

<span class="sd">                hostname    (Str)  --  Hostname of client</span>

<span class="sd">                port        (str)  -- Port number of postgres server</span>

<span class="sd">                user_name   (str)  -- Username of postgres server</span>

<span class="sd">                password    (str)  -- Password of postgres server</span>

<span class="sd">                table_name  (str)  -- Table name</span>


<span class="sd">            Returns:</span>
<span class="sd">                List - (Table name, size)</span>

<span class="sd">            Raises:</span>
<span class="sd">                BaseException:</span>
<span class="sd">                if unable generate table size</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
            <span class="c1"># Get the list of the tables for the database</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tables_meta</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">db_meta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting tables information for </span><span class="si">%s</span><span class="s2"> Database&quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
                <span class="n">tables</span><span class="p">,</span> <span class="n">tables_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_schema_tables_in_db</span><span class="p">(</span>
                    <span class="n">database</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

            <span class="n">rowlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">each_row</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select count(*) from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">each_row</span>
                <span class="n">postgres_response</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">rowlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">postgres_response</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">tab_row</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">rowlist</span><span class="p">))</span>
            <span class="n">view_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_views</span><span class="p">(</span><span class="n">postgres_database_object</span><span class="p">))</span>
            <span class="n">function_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_functions</span><span class="p">(</span><span class="n">postgres_database_object</span><span class="p">))</span>
            <span class="n">trigger_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_triggers</span><span class="p">(</span><span class="n">postgres_database_object</span><span class="p">))</span>
            <span class="n">db_meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">tab_row</span><span class="p">,</span> <span class="n">tables_meta</span><span class="p">,</span> <span class="n">view_list</span><span class="p">,</span> <span class="n">function_list</span><span class="p">,</span> <span class="n">trigger_list</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">db_meta</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in GenerateTableSize&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in generating table size&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_tables_in_db"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_tables_in_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_tables_in_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of tables available in the given Database Name</span>

<span class="sd">        Args:</span>
<span class="sd">                database    (str)  -- Database name</span>

<span class="sd">                hostname    (Str)  --  Hostname of client</span>

<span class="sd">                port        (str)  -- Port number of postgres server</span>

<span class="sd">                user_name   (str)  -- Username of postgres server</span>

<span class="sd">                password    (str)  -- Password of postgres server</span>



<span class="sd">            Returns:</span>
<span class="sd">                List - Tables in Dabatase</span>

<span class="sd">            Raises:</span>
<span class="sd">                BaseException:</span>
<span class="sd">                if unable to get table in db</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tables_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if database exists or not</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
            <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span>
                <span class="n">database</span><span class="p">)</span>

            <span class="c1"># Run the query to get the list of tables in the database</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select tablename FROM pg_catalog.pg_tables WHERE &quot;</span>
                     <span class="s2">&quot;tablename NOT LIKE &#39;pg\_%&#39; and tablename NOT LIKE &#39;sql\_%&#39;&quot;</span><span class="p">)</span>
            <span class="n">postgres_response</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">postgres_response</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">tables_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">tables_list</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in get_tables_in_db&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to get the tables in db.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_schema_tables_in_db"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_schema_tables_in_db">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_tables_in_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of tables, schemas, sequences and indxes available in the given Database Name</span>

<span class="sd">        Args:</span>
<span class="sd">                database    (str)  -- Database name</span>

<span class="sd">                hostname    (Str)  --  Hostname of client</span>

<span class="sd">                port        (str)  -- Port number of postgres server</span>

<span class="sd">                user_name   (str)  -- Username of postgres server</span>

<span class="sd">                password    (str)  -- Password of postgres server</span>



<span class="sd">            Returns:</span>
<span class="sd">                List - Tables in Dabatase, Metadata of Schema</span>

<span class="sd">            Raises:</span>
<span class="sd">                BaseException:</span>
<span class="sd">                if unable to get table in db</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tables_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">tables_list_meta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if database exists or not</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
            <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

            <span class="c1"># Run the query to get the list of tables in the database</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select nsp.nspname as schema_name,cls.relname as object_name, &quot;</span>
                     <span class="s2">&quot;rol.rolname as owner, case cls.relkind when &#39;r&#39; then &#39;TABLE&#39; when &#39;i&#39; &quot;</span>
                     <span class="s2">&quot;then &#39;INDEX&#39; when &#39;S&#39; then &#39;SEQUENCE&#39; when &#39;v&#39; then &#39;VIEW&#39; when &#39;c&#39; &quot;</span>
                     <span class="s2">&quot;then &#39;TYPE&#39; else cls.relkind::text end as object_type FROM pg_class &quot;</span>
                     <span class="s2">&quot;cls join pg_roles rol on rol.oid = cls.relowner join pg_namespace &quot;</span>
                     <span class="s2">&quot;nsp on nsp.oid = cls.relnamespace where nsp.nspname not in &quot;</span>
                     <span class="s2">&quot;(&#39;information_schema&#39;, &#39;pg_catalog&#39;) and nsp.nspname not like &quot;</span>
                     <span class="s2">&quot;&#39;pg_toast%&#39; order by nsp.nspname, cls.relname&quot;</span><span class="p">)</span>
            <span class="n">postgres_response</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">postgres_response</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                <span class="n">tables_list_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TABLE&#39;</span><span class="p">:</span>
                    <span class="n">tables_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tables_list</span><span class="p">,</span> <span class="n">tables_list_meta</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in get_schema_tables_in_db&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Exception in get_schema_tables_in_db&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.generate_db_info"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.generate_db_info">[docs]</a>    <span class="k">def</span> <span class="nf">generate_db_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">db_list</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets complete metadata info of Database</span>

<span class="sd">        Args:</span>
<span class="sd">                db_list     (list) -- Database list</span>

<span class="sd">                hostname    (Str)  -- Hostname of client</span>

<span class="sd">                port        (str)  -- Port number of postgres server</span>

<span class="sd">                user_name   (str)  -- Username of postgres server</span>

<span class="sd">                password    (str)  -- Password of postgres server</span>


<span class="sd">        Returns:</span>
<span class="sd">            Dict - Database Meta data information</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to generate db info</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_info_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list</span><span class="p">:</span>
                <span class="n">table_info_map</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">table_info_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_table_size</span><span class="p">(</span>
                    <span class="n">database</span><span class="p">,</span>
                    <span class="n">hostname</span><span class="p">,</span>
                    <span class="n">port</span><span class="p">,</span>
                    <span class="n">user_name</span><span class="p">,</span>
                    <span class="n">password</span><span class="p">)</span>
                <span class="n">db_info_dict</span><span class="p">[</span><span class="n">database</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_info_map</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Information of all the tables present in the&quot;</span>
                    <span class="s2">&quot;database </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">db_info_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db_info_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in generate_db_info&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to generate db information&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.validate_db_info"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.validate_db_info">[docs]</a>    <span class="k">def</span> <span class="nf">validate_db_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_info_map_1</span><span class="p">,</span> <span class="n">db_info_map_2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes two Database Information Maps and verifies if both have same info</span>

<span class="sd">        Args:</span>
<span class="sd">                db_info_map_1        (dict)  -- Database info of 1st database</span>

<span class="sd">                db_info_map_2        (dict)  -- Database info of 2nd database</span>

<span class="sd">        Returns:</span>
<span class="sd">            Boolean - Validation status(True/False)</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">                if information validation fails</span>

<span class="sd">                if unable to validate the db info</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating the database information&quot;</span><span class="p">)</span>
        <span class="n">validation_status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_info_map_1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Check if database exists or not</span>
                <span class="k">if</span> <span class="n">database</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_info_map_2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">validation_status</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check if tables exists or not</span>
                    <span class="n">tables_info_in_first_map</span> <span class="o">=</span> <span class="n">db_info_map_1</span><span class="p">[</span><span class="n">database</span><span class="p">]</span>
                    <span class="n">tables_info_in_second_map</span> <span class="o">=</span> <span class="n">db_info_map_2</span><span class="p">[</span><span class="n">database</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables_info_in_first_map</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables_info_in_second_map</span><span class="p">:</span>
                            <span class="n">validation_status</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_status</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Database information validation FAILED.!!!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;###Database information validation PASSED..!!###&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">validation_status</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in validate_db_info&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to validate db info&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.generate_test_data"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.generate_test_data">[docs]</a>    <span class="k">def</span> <span class="nf">generate_test_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">num_of_databases</span><span class="p">,</span>
            <span class="n">num_of_tables</span><span class="p">,</span>
            <span class="n">num_of_rows</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">delete_if_already_exist</span><span class="p">,</span>
            <span class="n">database_prefix</span><span class="p">,</span>
            <span class="n">tablespace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to generate test data for the automation purpose. Adds specified number of</span>
<span class="sd">        Databases, tables and Rows with a specified Prefix</span>

<span class="sd">        Args:</span>
<span class="sd">            hostname                (Str)       --  Hostname of client</span>

<span class="sd">            num_of_databases        (str)       -- Number of database to create</span>

<span class="sd">            num_of_tables           (str)       -- Number of tables to create inside each db</span>

<span class="sd">            num_of_rows             (str)       -- Number of rows in each table</span>

<span class="sd">            port                    (str)       -- Port number of postgres server</span>

<span class="sd">            user_name               (str)       -- Username of postgres server</span>

<span class="sd">            password                (str)       -- Password of postgres server</span>

<span class="sd">            delete_if_already_exist (bool)      -- Drop db if already exists</span>

<span class="sd">            database_prefix         (str)       -- Prefix name for each db created</span>

<span class="sd">            tablespace              (str)       -- Tablespace to be used to create database</span>

<span class="sd">                    Default: None</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns List of Databases on success</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to generate test data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_db_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
            <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_of_databases</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_testdb_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_prefix</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># Check if database exists or not</span>
                <span class="k">if</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
                    <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">drop_db</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">)</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">%s</span><span class="s2"> PGSQL database in </span><span class="si">%s</span><span class="s2"> host on </span><span class="si">%s</span><span class="s2"> port &quot;</span>
                           <span class="s2">&quot;with </span><span class="si">%s</span><span class="s2"> userName and </span><span class="si">%s</span><span class="s2"> &quot;</span>
                           <span class="s2">&quot;password&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tablespace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">create_db</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">create_tablespace_db</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">,</span>
                        <span class="n">tablespace</span><span class="p">)</span>
                <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;connection created for new db&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_of_tables</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;testtab_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
                        <span class="n">table_name</span><span class="p">,</span>
                        <span class="n">hostname</span><span class="p">,</span>
                        <span class="n">port</span><span class="p">,</span>
                        <span class="n">user_name</span><span class="p">,</span>
                        <span class="n">password</span><span class="p">,</span>
                        <span class="n">database</span><span class="p">)</span>
                    <span class="c1"># Insert values in to the table</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">insert_data_into_tables</span><span class="p">(</span>
                        <span class="n">table_name</span><span class="p">,</span>
                        <span class="n">postgres_database_object</span><span class="p">,</span>
                        <span class="n">num_of_rows</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating views, triggers and functions&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_view</span><span class="p">(</span>
                        <span class="s2">&quot;select count(*) from </span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                        <span class="s2">&quot;test_view_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                        <span class="n">postgres_database_object</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span>
                        <span class="s2">&quot;test_function_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                        <span class="n">table_name</span><span class="p">,</span>
                        <span class="n">postgres_database_object</span><span class="p">)</span>

                <span class="n">test_db_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_of_tables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_trigger</span><span class="p">(</span>
                    <span class="s2">&quot;test_trigger_0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;testtab_0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;testtab_1&quot;</span><span class="p">,</span>
                    <span class="n">database</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_testdb_0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_prefix</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">test_db_list</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in generate_test_data&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to generate data&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.insert_data_into_tables"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.insert_data_into_tables">[docs]</a>    <span class="k">def</span> <span class="nf">insert_data_into_tables</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table_name</span><span class="p">,</span>
            <span class="n">con</span><span class="p">,</span>
            <span class="n">num_of_rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts random strings to the table specified</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name          (str)   -- Name of table</span>

<span class="sd">            con                 (obj)   -- PostgreSQL DB connection object</span>

<span class="sd">            num_of_rows         (str)   -- Number of rows in each table</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to insert test data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">con</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;insert into </span><span class="si">%s</span><span class="s2"> &quot;</span>
                     <span class="s2">&quot;select 10,&#39;test_data&#39;,&#39;bangalore&#39; &quot;</span>
                     <span class="s2">&quot;from generate_series(1, </span><span class="si">%s</span><span class="s2">) s(i)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">num_of_rows</span><span class="p">))</span>
            <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in insert_data_into_tables&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to insert the data into tables&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_row_count"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_row_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_count</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table_name</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">database</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the Number of rows in the table</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name          (str)   -- Name of table</span>

<span class="sd">            hostname            (Str)   --  Hostname of client</span>

<span class="sd">            port                (str)   -- Port number of postgres server</span>

<span class="sd">            user_name           (str)   -- Username of postgres server</span>

<span class="sd">            password            (str)   -- Password of postgres server</span>

<span class="sd">            database            (str)   -- Database name</span>


<span class="sd">        Returns:</span>
<span class="sd">            Returns row count on success</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to get row count</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>

            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select * from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">table_name</span>
            <span class="n">postgres_response</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">postgres_response</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in get_row_count&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to get the row count&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.create_table"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.create_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table_name</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">database</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a table of given name in the specified database</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name          (str)  -- Name of table</span>

<span class="sd">            hostname            (Str)  -- Hostname of client</span>

<span class="sd">            port                (str)  -- Port number of postgres server</span>

<span class="sd">            user_name           (str)  -- Username of postgres server</span>

<span class="sd">            password            (str)  -- Password of postgres server</span>

<span class="sd">            database            (str)  -- Database name</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to create table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
            <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span>
                <span class="n">database</span><span class="p">)</span>

            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CREATE TABLE </span><span class="si">{0}</span><span class="s2"> (&quot;</span>
                     <span class="s2">&quot;id int,&quot;</span>
                     <span class="s2">&quot;name VARCHAR(10),&quot;</span>
                     <span class="s2">&quot;city VARCHAR(10)&quot;</span>
                     <span class="s2">&quot;);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
            <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in create_table&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create tables in db&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.drop_table"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.drop_table">[docs]</a>    <span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table_name</span><span class="p">,</span>
            <span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="p">,</span>
            <span class="n">user_name</span><span class="p">,</span>
            <span class="n">password</span><span class="p">,</span>
            <span class="n">database</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drops a table of given name in the specified database</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name          (str)  -- Name of table</span>

<span class="sd">            hostname            (Str)  -- Hostname of client</span>

<span class="sd">            port                (str)  -- Port number of postgres server</span>

<span class="sd">            user_name           (str)  -- Username of postgres server</span>

<span class="sd">            password            (str)  -- Password of postgres server</span>

<span class="sd">            database            (str)  -- Database name</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>

<span class="sd">                if database doesn&#39;t exists</span>

<span class="sd">                if unable to drop table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;drop table if exists </span><span class="si">{0}</span><span class="s2"> cascade;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping the table: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database doesn&#39;t exists&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception while dropping table&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop tables in db&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.create_view"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.create_view">[docs]</a>    <span class="k">def</span> <span class="nf">create_view</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="n">view_name</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a view inside a database.</span>

<span class="sd">            Args:</span>
<span class="sd">                query          (str)  -- Query to create view</span>

<span class="sd">                view_name      (str)  -- Name of the view</span>

<span class="sd">                postgres_db    (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database       (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to create view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;create view </span><span class="si">{0}</span><span class="s2"> as </span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in creating View&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create the view&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.drop_view"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.drop_view">[docs]</a>    <span class="k">def</span> <span class="nf">drop_view</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">view_name</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drops a view inside a database.</span>

<span class="sd">            Args:</span>
<span class="sd">                view_name      (str)  -- Name of the view</span>

<span class="sd">                postgres_db    (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database       (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to drop view</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;drop view if exists </span><span class="si">{0}</span><span class="s2"> cascade;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in dropping View&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop the view&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.list_views"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.list_views">[docs]</a>    <span class="k">def</span> <span class="nf">list_views</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lists views inside a database.</span>

<span class="sd">            Args:</span>
<span class="sd">                postgres_db    (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database       (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Returns:</span>

<span class="sd">                view_list      (list) -- list of views in the database</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to list views</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select viewname FROM pg_views WHERE schemaname &quot;</span>
                     <span class="s2">&quot;NOT IN(&#39;information_schema&#39;, &#39;pg_catalog&#39;);&quot;</span><span class="p">)</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">response_object</span><span class="o">.</span><span class="n">rows</span>
            <span class="n">view_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">view_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">view_list</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in listing Views&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to list views&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.create_function"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.create_function">[docs]</a>    <span class="k">def</span> <span class="nf">create_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">function_name</span><span class="p">,</span>
            <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;tab1&quot;</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a function inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                function_name  (str)  -- Name of the function</span>

<span class="sd">                table_name     (str)  -- Name of the table</span>

<span class="sd">                postgres_db    (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database       (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to create a function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;create OR REPLACE FUNCTION  </span><span class="si">{0}</span><span class="s2">(pcode integer) returns bigint &quot;</span>
                     <span class="s2">&quot;AS $BODY$ select count(*) from </span><span class="si">{1}</span><span class="s2"> where id=pcode; $BODY$ LANGUAGE &quot;</span>
                     <span class="s2">&quot;sql VOLATILE COST 100;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in creating function&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create the function&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.drop_function"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.drop_function">[docs]</a>    <span class="k">def</span> <span class="nf">drop_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">function_name</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drops a function inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                function_name  (str)  -- Name of the function</span>

<span class="sd">                postgres_db    (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database       (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to drop function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;drop function if exists </span><span class="si">{0}</span><span class="s2">(integer);&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in dropping function&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop the function&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.list_functions"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.list_functions">[docs]</a>    <span class="k">def</span> <span class="nf">list_functions</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lists all functions inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                postgres_db         (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database            (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Returns:</span>
<span class="sd">                function_list       (list) -- list of functions</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to list the functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select routine_name FROM information_schema.routines &quot;</span>
                     <span class="s2">&quot;WHERE routine_type=&#39;FUNCTION&#39; AND specific_schema=&#39;public&#39;;&quot;</span><span class="p">)</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">response_object</span><span class="o">.</span><span class="n">rows</span>
            <span class="n">function_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">function_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">function_list</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in listing trigger&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to list the triggers&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.create_trigger"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.create_trigger">[docs]</a>    <span class="k">def</span> <span class="nf">create_trigger</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">trigger_name</span><span class="p">,</span>
            <span class="n">table_name</span><span class="p">,</span>
            <span class="n">trigger_table_name</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; creates a trigger inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                trigger_name        (str)  -- Name of the function</span>

<span class="sd">                table_name          (str)  -- Name of the table where data needs</span>
<span class="sd">                to be inserted after a trigger</span>

<span class="sd">                trigger_table_name  (str)  -- Name of the table on which is</span>
<span class="sd">                trigger is defined</span>

<span class="sd">                postgres_db         (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database            (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to create a trigger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;create OR REPLACE FUNCTION exmp_func() RETURNS trigger AS $BODY$ BEGIN&quot;</span>
                     <span class="s2">&quot; insert into </span><span class="si">{0}</span><span class="s2"> values(1, &#39;test&#39;); RETURN NEW; END; &quot;</span>
                     <span class="s2">&quot;$BODY$ LANGUAGE plpgsql&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trigger function created&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;create TRIGGER </span><span class="si">{0}</span><span class="s2"> AFTER INSERT ON </span><span class="si">{1}</span><span class="s2"> FOR &quot;</span>
                     <span class="s2">&quot;EACH ROW EXECUTE PROCEDURE exmp_func();&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">trigger_name</span><span class="p">,</span> <span class="n">trigger_table_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in creating trigger&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create the trigger&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.drop_trigger"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.drop_trigger">[docs]</a>    <span class="k">def</span> <span class="nf">drop_trigger</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">trigger_name</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Drops a trigger inside a database.</span>

<span class="sd">            Args:</span>

<span class="sd">                trigger_name        (str)  -- Name of the function</span>

<span class="sd">                postgres_db         (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database            (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to drop trigger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DROP TRIGGER </span><span class="si">{0}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trigger_name</span><span class="p">)</span>
            <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_function</span><span class="p">(</span><span class="s2">&quot;exmp_func&quot;</span><span class="p">,</span> <span class="n">postgres_db</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in dropping trigger&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to drop the trigger&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.list_triggers"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.list_triggers">[docs]</a>    <span class="k">def</span> <span class="nf">list_triggers</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">postgres_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lists all triggers defined for the database server.</span>

<span class="sd">            Args:</span>

<span class="sd">                postgres_db         (obj)  -- postgres database object</span>

<span class="sd">                    default: None</span>

<span class="sd">                database            (str)  -- database name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Returns:</span>
<span class="sd">                trigger_list        (list) -- list of triggers</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to list the triggers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postgres_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Establish the connection with database</span>
                <span class="n">postgres_db</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_port</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_db_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgres_password</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select tgname FROM pg_trigger;&quot;</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="n">postgres_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">response_object</span><span class="o">.</span><span class="n">rows</span>
            <span class="n">trigger_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">trigger_name</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">trigger_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trigger_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">trigger_list</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in listing trigger&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to list the triggers&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.cleanup_tc_db"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.cleanup_tc_db">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_tc_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pgsql_server_hostname</span><span class="p">,</span>
            <span class="n">pgsql_server_port</span><span class="p">,</span>
            <span class="n">pgsql_server_user_name</span><span class="p">,</span>
            <span class="n">pgsql_server_password</span><span class="p">,</span>
            <span class="n">tc_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clean Up test Databases of failed runs or completed TCs if exists</span>

<span class="sd">        Args:</span>

<span class="sd">            pgsql_server_hostname    (Str)   --  Hostname of client</span>

<span class="sd">            pgsql_server_port        (str)   -- Port number of postgres server</span>

<span class="sd">            pgsql_server_user_name   (str)   -- Username of postgres server</span>

<span class="sd">            pgsql_server_password    (str)   -- Password of postgres server</span>

<span class="sd">            tc_name                  (str)   -- Table Name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_db_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up test data&quot;</span><span class="p">)</span>
        <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
            <span class="n">pgsql_server_hostname</span><span class="p">,</span>
            <span class="n">pgsql_server_port</span><span class="p">,</span>
            <span class="n">pgsql_server_user_name</span><span class="p">,</span>
            <span class="n">pgsql_server_password</span><span class="p">,</span>
            <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="n">all_db_list</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">all_db_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to retrieve all Database Names in PostGres Server&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to get the db list.&quot;</span><span class="p">)</span>
        <span class="n">dbs_to_delete</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># Extract only test Cases related DB Names</span>
        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">all_db_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tc_name</span><span class="p">):</span>
                <span class="n">dbs_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

        <span class="c1"># Drop the database of subclient content</span>
        <span class="k">if</span> <span class="n">dbs_to_delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_test_data</span><span class="p">(</span>
                <span class="n">dbs_to_delete</span><span class="p">,</span>
                <span class="n">postgres_database_object</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.cleanup_test_data"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.cleanup_test_data">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_test_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">db_list</span><span class="p">,</span>
            <span class="n">postgres_database_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up test data which are generated for automation</span>

<span class="sd">        Args:</span>

<span class="sd">            db_list                  (str) -- Database list</span>

<span class="sd">            postgres_database_object (obj) -- PostgreSQL connection object</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException:</span>
<span class="sd">            if unable to cleanup databases</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">check_if_db_exists</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping the database: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
                    <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">drop_db</span><span class="p">(</span>
                        <span class="n">database</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exception in cleanup_test_data&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to cleanup test data&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_ma_name"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_ma_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_ma_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the Media_agent name associated with the storage_policy</span>

<span class="sd">        Args:</span>
<span class="sd">            storage_policy   (str)   -- Storage Policy name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns media agent name</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the MA name associated with the Storage policy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">storage_policy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The storage_policy has to be string&quot;</span><span class="p">)</span>
            <span class="c1"># get the job result directory from DB</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select name from APP_Client where id=(select HostClientId &quot;</span>
                     <span class="s2">&quot;from MMDataPath where CopyId=(select defaultCopy from archGroup &quot;</span>
                     <span class="s2">&quot;where name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">storage_policy</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
                <span class="n">ma_name</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetched MA Name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ma_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ma_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get the MA name from database&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_size_of_app_in_backup_phase"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_size_of_app_in_backup_phase">[docs]</a>    <span class="k">def</span> <span class="nf">get_size_of_app_in_backup_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the size_of_application in backup phase of JOB</span>

<span class="sd">        Args:</span>
<span class="sd">            job_id   (str)   -- JOB ID</span>

<span class="sd">            phase    (int)   -- Phase Id</span>

<span class="sd">                default: 6</span>

<span class="sd">        Returns: Returns size of application in backup phase</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if failed to get the size of application in backup phase</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The JOB ID has to be string&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select (((sum(unCompBytes))/1024)/1024) FROM &quot;</span>
                 <span class="s2">&quot;JMBkpAtmptStats where jobId=&#39;</span><span class="si">{0}</span><span class="s2">&#39; and phase=</span><span class="si">{1}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">job_id</span><span class="p">,</span> <span class="n">phase</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">size_of_application</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Fetched Size of application in backup phase:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size_of_application</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">size_of_application</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get the size of application in backup phase&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.start_postgres_server"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.start_postgres_server">[docs]</a>    <span class="k">def</span> <span class="nf">start_postgres_server</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="n">pgsql_data_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts the postgres server in client</span>
<span class="sd">        Args:</span>

<span class="sd">            pgsql_bin_dir        (str)  -- postgres bin directory path</span>

<span class="sd">            pgsql_data_dir       (str)  -- postgres data directory path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_status</span><span class="p">(</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span> <span class="n">pgsql_data_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server is not running, starting the server&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;BINDIR&#39;</span><span class="p">:</span> <span class="n">pgsql_bin_dir</span><span class="p">,</span>
                <span class="s1">&#39;DATADIR&#39;</span><span class="p">:</span> <span class="n">pgsql_data_dir</span><span class="p">,</span>
                <span class="s1">&#39;OPERATION&#39;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_POSTGRES_START_STOP</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Output of Postgres server start script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pgctl_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">pgsql_bin_dir</span><span class="p">,</span> <span class="s2">&quot;pg_ctl.exe&quot;</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;cmd /c &quot;</span><span class="se">\&quot;</span><span class="si">{0}</span><span class="se">\&quot;</span><span class="s1"> -U postgres -D </span><span class="se">\&quot;</span><span class="si">{1}</span><span class="se">\&quot;</span><span class="s1"> -s start&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pgctl_path</span><span class="p">,</span> <span class="n">pgsql_data_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">wait_for_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_status</span><span class="p">(</span>
                <span class="n">pgsql_bin_dir</span><span class="p">,</span> <span class="n">pgsql_data_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully started the Postgres Server&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to Start Postgres server, Error while starting server&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server already running, will not start again&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.stop_postgres_server"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.stop_postgres_server">[docs]</a>    <span class="k">def</span> <span class="nf">stop_postgres_server</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="n">pgsql_data_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Stops the postgres server in client</span>
<span class="sd">        Args:</span>

<span class="sd">            pgsql_bin_dir        (str)  -- postgres bin directory path</span>

<span class="sd">            pgsql_data_dir       (str)  -- postgres data directory path</span>


<span class="sd">        Returns:</span>

<span class="sd">            Returns True on success</span>

<span class="sd">            Returns False if the server already stopped</span>

<span class="sd">        Raises:</span>

<span class="sd">            Exception:</span>

<span class="sd">                if server stop operation failes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_status</span><span class="p">(</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span> <span class="n">pgsql_data_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server is running, Stopping the server&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;BINDIR&#39;</span><span class="p">:</span> <span class="n">pgsql_bin_dir</span><span class="p">,</span>
                <span class="s1">&#39;DATADIR&#39;</span><span class="p">:</span> <span class="n">pgsql_data_dir</span><span class="p">,</span>
                <span class="s1">&#39;OPERATION&#39;</span><span class="p">:</span> <span class="s2">&quot;stop&quot;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_POSTGRES_START_STOP</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
                    <span class="n">constants</span><span class="o">.</span><span class="n">WINDOWS_POSTGRES_START_STOP</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Output of Postgres server stop script: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>

            <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_status</span><span class="p">(</span>
                <span class="n">pgsql_bin_dir</span><span class="p">,</span> <span class="n">pgsql_data_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to Stop the postgres server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully Stopped the Postgres Server&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server is not running, unable to stop&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PostgresHelper.get_postgres_status"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_postgres_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_postgres_status</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="n">pgsql_data_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets postgres server status</span>
<span class="sd">        Args:</span>

<span class="sd">            pgsql_bin_dir        (str)  -- postgres bin directory path</span>

<span class="sd">            pgsql_data_dir       (str)  -- postgres data directory path</span>

<span class="sd">        Returns:</span>

<span class="sd">            True  - if PostgreSQl server is running</span>

<span class="sd">            False - if PostgreSQL server is not running</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BINDIR&#39;</span><span class="p">:</span> <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="s1">&#39;DATADIR&#39;</span><span class="p">:</span> <span class="n">pgsql_data_dir</span><span class="p">,</span>
            <span class="s1">&#39;OPERATION&#39;</span><span class="p">:</span> <span class="s2">&quot;status&quot;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">UNIX_POSTGRES_STATUS</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">WINDOWS_POSTGRES_STATUS</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Output of Postgres server status check: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;server is running&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server is not running&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Postgres Server is running&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PostgresHelper.get_postgres_data_dir"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_postgres_data_dir">[docs]</a>    <span class="k">def</span> <span class="nf">get_postgres_data_dir</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="n">pgsql_server_password</span><span class="p">,</span>
            <span class="n">pgsql_server_port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets postgres data directory</span>
<span class="sd">        Args:</span>

<span class="sd">            pgsql_bin_dir        (str)  -- postgres bin directory path</span>

<span class="sd">            pgsql_server_password(str)  -- Postgres server password</span>

<span class="sd">            pgsql_server_port    (str)  -- postgres server port number</span>

<span class="sd">        Returns:</span>
<span class="sd">            Data Directory of PostgreSQL Server</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BINDIR&#39;</span><span class="p">:</span> <span class="n">pgsql_bin_dir</span><span class="p">,</span>
            <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="n">pgsql_server_password</span><span class="p">,</span>
            <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="n">pgsql_server_port</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">UNIX_POSTGRES_DATADIR</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">WINDOWS_POSTGRES_DATADIR</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">data_directory</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span>
        <span class="k">return</span> <span class="n">data_directory</span></div>

<div class="viewcode-block" id="PostgresHelper.check_chunk_commited"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.check_chunk_commited">[docs]</a>    <span class="k">def</span> <span class="nf">check_chunk_commited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">log_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks for chunk commit in the commserver for the</span>
<span class="sd">        initiated job</span>

<span class="sd">        Args:</span>
<span class="sd">            job_id               (str)  -- Job ID</span>

<span class="sd">            log_directory        (str)  -- Commvault Log directory path</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns true on success</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cs_machine_object</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">Machine</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">commserv_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;JOBID&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
            <span class="s1">&#39;DIR&#39;</span><span class="p">:</span> <span class="n">log_directory</span>
        <span class="p">}</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs_machine_object</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span>
            <span class="n">constants</span><span class="o">.</span><span class="n">CS_CVD_LOG_CHECK_FOR_CHUNK_COMMIT</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">formatted_output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span></div>

<div class="viewcode-block" id="PostgresHelper.get_subclient_database_list"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_subclient_database_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_subclient_database_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_name</span><span class="p">,</span> <span class="n">backupset</span><span class="p">,</span> <span class="n">database_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get databases associated with a given</span>
<span class="sd">        subclient in dumpbased backupset</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_name      (str)   -- Subclient Name</span>

<span class="sd">            backupset           (obj)   -- Backupset Object</span>

<span class="sd">            database_list       (str)   -- list of all databases in the server</span>

<span class="sd">        Returns: (list)  --  List of all databases associated with the subclient</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if subclient doesn&#39;t exists</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subclient</span> <span class="o">=</span> <span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subclient_name</span><span class="p">)</span>
        <span class="n">subclient_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">all_subclients</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subclient_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> SubClient Does&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">))</span>
        <span class="n">default_subclient</span> <span class="o">=</span> <span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">default_subclient</span>
        <span class="k">if</span> <span class="n">subclient</span><span class="o">.</span><span class="n">subclient_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">default_subclient</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1"># Get list of all the subclients content and exclude them from total list</span>
            <span class="c1"># of Databases</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Db list before backup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">database_list</span><span class="p">)</span>
            <span class="n">all_other_sub_clients_contents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sbclnt</span> <span class="ow">in</span> <span class="n">subclient_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sbclnt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">default_subclient</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subclient is not default subclient&quot;</span><span class="p">)</span>
                    <span class="n">sub_client_new</span> <span class="o">=</span> <span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sbclnt</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subc: </span><span class="si">%s</span><span class="s2"> and content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sbclnt</span><span class="p">,</span> <span class="n">sub_client_new</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">sub_client_new</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                        <span class="n">all_other_sub_clients_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">database</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All other subc content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">all_other_sub_clients_contents</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">all_other_sub_clients_contents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db_name</span> <span class="ow">in</span> <span class="n">database_list</span><span class="p">:</span>
                    <span class="n">database_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">database_list</span>
        <span class="k">return</span> <span class="n">subclient</span><span class="o">.</span><span class="n">content</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postgres_log_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns PostgresBackup.log path in the client&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">log_directory</span><span class="p">,</span>
            <span class="s2">&quot;PostGresBackup.log&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_index_v2_postgres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if Postgres index version is V2.</span>

<span class="sd">            Returns:</span>
<span class="sd">                Returns true if indexing is V2 for postgres.</span>
<span class="sd">                Else returns False</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if failed to get the postgres indexing version</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;select attrVal from APP_ClientProp where [componentNameId] &quot;</span>
            <span class="s2">&quot;in (select id from APP_Client where name=&#39;</span><span class="si">{0}</span><span class="s2">&#39;) and attrName like &quot;</span>
            <span class="s2">&quot;&#39;IndexingV2_Postgress&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">index_v2</span> <span class="o">=</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">index_v2</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to get the Postgres Index version&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postgres_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns postgres server password&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span>

<div class="viewcode-block" id="PostgresHelper.run_restore"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.run_restore">[docs]</a>    <span class="k">def</span> <span class="nf">run_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">paths</span><span class="p">,</span>
            <span class="n">subclient</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">to_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">clone_env</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clone_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">media_agent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">table_level_restore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_dump_based</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">destination_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">destination_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initiates restore job from subclient level and waits for completion</span>

<span class="sd">            Args:</span>

<span class="sd">                paths                   (list)  --  list of databases to restore</span>

<span class="sd">                subclient               (obj)   --  subclient object</span>

<span class="sd">                copy_precedence         (int)   --  copy precedence value of storage policy copy</span>
<span class="sd">                    default: None</span>

<span class="sd">                to_time                 (str)   --  time to retore the contents before</span>
<span class="sd">                    format: YYYY-MM-DD HH:MM:SS</span>

<span class="sd">                    default: None</span>

<span class="sd">                clone_env               (bool)  --  boolean to specify whether the database</span>
<span class="sd">                should be cloned or not</span>

<span class="sd">                    default: False</span>

<span class="sd">                clone_options           (dict)  --  clone restore options passed in a dict</span>

<span class="sd">                    default: None</span>

<span class="sd">                    Accepted format: {</span>
<span class="sd">                                        &quot;stagingLocaion&quot;: &quot;/gk_snap&quot;,</span>
<span class="sd">                                        &quot;forceCleanup&quot;: True,</span>
<span class="sd">                                        &quot;port&quot;: &quot;5595&quot;,</span>
<span class="sd">                                        &quot;libDirectory&quot;: &quot;/opt/PostgreSQL/9.6/lib&quot;,</span>
<span class="sd">                                        &quot;isInstanceSelected&quot;: True,</span>
<span class="sd">                                        &quot;reservationPeriodS&quot;: 3600,</span>
<span class="sd">                                        &quot;user&quot;: &quot;postgres&quot;,</span>
<span class="sd">                                        &quot;binaryDirectory&quot;: &quot;/opt/PostgreSQL/9.6/bin&quot;</span>
<span class="sd">                                     }</span>

<span class="sd">                media_agent         (str)      --  Media agent name</span>

<span class="sd">                    default: None</span>

<span class="sd">                table_level_restore (bool)     --  table level restore flag</span>

<span class="sd">                    default: False</span>

<span class="sd">                is_dump_based       (bool)     -- flag to specify dump based restore</span>

<span class="sd">                    default: False</span>

<span class="sd">                destination_client  (str)   --  Destination client machine name</span>

<span class="sd">                    default: None</span>

<span class="sd">                destination_instance (str)  --  Destination instance name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Returns:</span>

<span class="sd">                job            (object)    --  returns the instance of Job class</span>
<span class="sd">                for the restore it started</span>

<span class="sd">            Raises:</span>

<span class="sd">                Exception: If restore job fails to run</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backupset_object</span> <span class="o">=</span> <span class="n">subclient</span><span class="o">.</span><span class="n">_backupset_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#####Starting Restore#####&quot;</span><span class="p">)</span>
        <span class="n">staging_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">table_level_restore</span><span class="p">:</span>
            <span class="n">staging_path</span> <span class="o">=</span> <span class="s2">&quot;/tmp/testcase&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">staging_path</span> <span class="o">=</span> <span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">tmp</span><span class="se">\\</span><span class="s2">testcase&quot;</span>
        <span class="n">restore_object</span> <span class="o">=</span> <span class="n">backupset_object</span>
        <span class="k">if</span> <span class="n">clone_env</span> <span class="ow">or</span> <span class="n">is_dump_based</span><span class="p">:</span>
            <span class="n">restore_object</span> <span class="o">=</span> <span class="n">subclient</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_client</span><span class="p">:</span>
            <span class="n">destination_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_instance</span><span class="p">:</span>
            <span class="n">destination_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">instance_name</span>

        <span class="n">job</span> <span class="o">=</span> <span class="n">restore_object</span><span class="o">.</span><span class="n">restore_postgres_server</span><span class="p">(</span>
            <span class="n">paths</span><span class="p">,</span>
            <span class="n">destination_client</span><span class="p">,</span>
            <span class="n">destination_instance</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
            <span class="n">to_time</span><span class="o">=</span><span class="n">to_time</span><span class="p">,</span>
            <span class="n">clone_env</span><span class="o">=</span><span class="n">clone_env</span><span class="p">,</span>
            <span class="n">clone_options</span><span class="o">=</span><span class="n">clone_options</span><span class="p">,</span>
            <span class="n">media_agent</span><span class="o">=</span><span class="n">media_agent</span><span class="p">,</span>
            <span class="n">table_level_restore</span><span class="o">=</span><span class="n">table_level_restore</span><span class="p">,</span>
            <span class="n">staging_path</span><span class="o">=</span><span class="n">staging_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Started Restore with Job ID: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed to run restore job with error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Successfully finished restore job&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="PostgresHelper.clone_backup_restore"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.clone_backup_restore">[docs]</a>    <span class="k">def</span> <span class="nf">clone_backup_restore</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">clone_options</span><span class="p">,</span> <span class="n">point_in_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">destination_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">destination_instance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to perform backup/restore and validation of clone feature TCs</span>

<span class="sd">            Args:</span>
<span class="sd">                subclient       (obj)   --  Subclient Object</span>

<span class="sd">                clone_options   (dict)  --  clone restore options passed in a dict</span>

<span class="sd">                    default: None</span>

<span class="sd">                    Accepted format: {</span>
<span class="sd">                                        &quot;stagingLocaion&quot;: &quot;/gk_snap&quot;,</span>
<span class="sd">                                        &quot;forceCleanup&quot;: True,</span>
<span class="sd">                                        &quot;port&quot;: &quot;5595&quot;,</span>
<span class="sd">                                        &quot;libDirectory&quot;: &quot;/opt/PostgreSQL/9.6/lib&quot;,</span>
<span class="sd">                                        &quot;isInstanceSelected&quot;: True,</span>
<span class="sd">                                        &quot;reservationPeriodS&quot;: 3600,</span>
<span class="sd">                                        &quot;user&quot;: &quot;postgres&quot;,</span>
<span class="sd">                                        &quot;binaryDirectory&quot;: &quot;/opt/PostgreSQL/9.6/bin&quot;</span>
<span class="sd">                                     }</span>

<span class="sd">                point_in_time   (bool)  --  flag to check if the restore operation is</span>
<span class="sd">                point in time or not</span>

<span class="sd">                    default: False</span>

<span class="sd">                destination_client  (str)   --  Destination client machine name</span>

<span class="sd">                    default: None</span>

<span class="sd">                destination_instance (str)  --  Destination instance name</span>

<span class="sd">                    default: None</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to get the database list</span>

<span class="sd">                    if database information validation fails</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dbhelper_object</span> <span class="o">=</span> <span class="n">DbHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
        <span class="n">ignore_db_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span> <span class="s2">&quot;template0&quot;</span><span class="p">]</span>
        <span class="n">pgsql_db_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>

        <span class="c1">###################### Running Full Backup ########################</span>
        <span class="n">full_job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for log backup to complete</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="c1"># Colecting Meta data</span>
        <span class="n">db_list_before_backup</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_list_before_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get the database list.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Get the subclient content Info before backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Collect information of the subclient content&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">db_list_before_backup</span><span class="p">:</span>
                <span class="n">db_list_before_backup</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">db_info_before_full_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
            <span class="n">db_list_before_backup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">destination_client</span> <span class="ow">and</span> <span class="n">destination_instance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trying to perform cross machine clone restore&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">point_in_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for 20 seconds before starting clone restore&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;/data&quot;</span><span class="p">],</span>
                <span class="n">subclient</span><span class="p">,</span>
                <span class="n">clone_env</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">clone_options</span><span class="o">=</span><span class="n">clone_options</span><span class="p">,</span>
                <span class="n">destination_client</span><span class="o">=</span><span class="n">destination_client</span><span class="p">,</span>
                <span class="n">destination_instance</span><span class="o">=</span><span class="n">destination_instance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add some more data and perform a log backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding some more data&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">20</span><span class="p">,</span>
                <span class="mi">100</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;auto_snap_inc&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Perfroming log backup&quot;</span><span class="p">)</span>
            <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;INCREMENTAL&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for 20 seconds before starting clone restore&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring data upto time:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;/data&quot;</span><span class="p">],</span>
                <span class="n">subclient</span><span class="p">,</span>
                <span class="n">clone_env</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">clone_options</span><span class="o">=</span><span class="n">clone_options</span><span class="p">,</span>
                <span class="n">to_time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="c1"># Colecting Meta data</span>
        <span class="n">db_list_after_restore</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_list_after_restore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get the database list.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Collect information of the subclient content after restore&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">db_list_after_restore</span><span class="p">:</span>
                <span class="n">db_list_after_restore</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collecting the DB info from cloned database&quot;</span><span class="p">)</span>

        <span class="n">db_info_after_restore</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">destination_instance</span> <span class="ow">and</span> <span class="n">destination_client</span><span class="p">:</span>
            <span class="n">destination_client_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">destination_client</span><span class="p">)</span>
            <span class="n">destination_instance_obj</span> <span class="o">=</span> <span class="n">destination_client_obj</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;postgresql&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">destination_instance</span><span class="p">)</span>
            <span class="n">destination_pgsql_obj</span> <span class="o">=</span> <span class="n">PostgresHelper</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">,</span> <span class="n">destination_client_obj</span><span class="p">,</span> <span class="n">destination_instance_obj</span><span class="p">)</span>
            <span class="n">db_info_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="n">db_list_after_restore</span><span class="p">,</span>
                <span class="n">destination_client_obj</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="n">clone_options</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                <span class="n">destination_instance_obj</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="n">destination_pgsql_obj</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_info_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="n">db_list_after_restore</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="n">clone_options</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="c1"># validation using meta data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating the database information collected before SNAP </span><span class="se">\</span>
<span class="s2">            Backup and after clone Restore&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">db_info_before_full_backup</span><span class="p">,</span> <span class="n">db_info_after_restore</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Database information validation failed.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Database information validation passed successfully&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.blocklevel_backup_restore"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.blocklevel_backup_restore">[docs]</a>    <span class="k">def</span> <span class="nf">blocklevel_backup_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient</span><span class="p">,</span> <span class="n">postgres_data_population_size</span><span class="p">,</span> <span class="n">tc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to perform backup/restore and validation of block level feature TCs</span>

<span class="sd">            Args:</span>
<span class="sd">                subclient                       (obj)   --  Subclient Object</span>

<span class="sd">                postgres_data_population_size   (list)  --  list containing information</span>
<span class="sd">                of data population size</span>

<span class="sd">                tc_type                         (str)   --  testcase type</span>

<span class="sd">                    default: None</span>

<span class="sd">                    Accepted values: ACC1/INCREMENTAL/SYNTH_FULL/POINT_IN_TIME</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception:</span>
<span class="sd">                    if unable to get the database list</span>

<span class="sd">                    if server fails to stop</span>

<span class="sd">                    if database information validation fails</span>

<span class="sd">                    if data is not restored from snap copy</span>

<span class="sd">                    if failed to run mount/unmount job</span>

<span class="sd">                    if Unable to verify the mounted snap from synthfull job</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tc_type</span> <span class="o">=</span> <span class="s2">&quot;ACC1&quot;</span>

        <span class="n">dbhelper_object</span> <span class="o">=</span> <span class="n">DbHelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
        <span class="n">ignore_db_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span> <span class="s2">&quot;template0&quot;</span><span class="p">]</span>
        <span class="n">pgsql_db_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="n">postgres_data_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_data_dir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">)</span>

        <span class="c1">########################## SNAP Backup/Restore Operation ##########</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;##### SNAP Backup/Restore Operations #####&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating Test Data&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="n">postgres_data_population_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">postgres_data_population_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">postgres_data_population_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;auto_snap&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test Data Generated successfully&quot;</span><span class="p">)</span>

        <span class="c1">###################### Running Full Backup ########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting FULL backup job&quot;</span><span class="p">)</span>
        <span class="n">full_job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;FULL&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for log backup to complete</span>
        <span class="n">full_job_log</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">full_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">full_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="n">db_info_before_full_backup</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">db_info_before_inc_backup</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Colecting Meta data</span>
        <span class="n">db_list_before_backup</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_list_before_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get the database list.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Get the subclient content Info before backup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Collect information of the subclient content&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_before_backup</span><span class="p">:</span>
                <span class="n">db_list_before_backup</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="n">db_info_before_full_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
            <span class="n">db_list_before_backup</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;incremental&quot;</span><span class="p">,</span> <span class="s2">&quot;synth_full&quot;</span><span class="p">,</span> <span class="s2">&quot;point_in_time&quot;</span><span class="p">]:</span>
            <span class="c1"># Add more data before Incremental</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding more data to run incremental backup&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">5</span><span class="p">,</span>
                <span class="mi">100</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;auto_snap_inc&quot;</span><span class="p">)</span>

            <span class="c1"># run incremental backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Incremental backup job&quot;</span><span class="p">)</span>
            <span class="n">inc_job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="n">inc_with_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Wait for log backup to complete</span>
            <span class="n">inc_job_log</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">inc_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

            <span class="c1"># Colecting Meta data after inc backup</span>
            <span class="n">db_list_before_backup</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">db_list_before_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to get the database list.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Get the subclient content Info before backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Collect information of the subclient content&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_before_backup</span><span class="p">:</span>
                    <span class="n">db_list_before_backup</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="n">db_info_before_inc_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="n">db_list_before_backup</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;synth_full&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Snap engine is not native.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for 20 seconds before starting restore&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

                <span class="c1"># stopping postgres server before the restore</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;stopping server&quot;</span><span class="p">)</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_postgres_server</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
                    <span class="n">postgres_data_directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server Stop Success, moving to restore phase&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Server was not running, Continuing to restore phase&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_database_directories</span><span class="p">()</span>

                <span class="c1"># Running FS Restore</span>
                <span class="n">full_job_end_time</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s2">&quot;point_in_time&quot;</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting PIT restore&quot;</span><span class="p">)</span>
                    <span class="n">full_job_end_time</span> <span class="o">=</span> <span class="n">full_job</span><span class="o">.</span><span class="n">end_time</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;/data&quot;</span><span class="p">],</span>
                    <span class="n">subclient</span><span class="p">,</span>
                    <span class="n">to_time</span><span class="o">=</span><span class="n">full_job_end_time</span><span class="p">,</span>
                    <span class="n">media_agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">)</span>

                <span class="k">del</span> <span class="n">pgsql_db_object</span>
                <span class="n">pgsql_db_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                    <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>

                <span class="c1"># Colecting Meta data</span>
                <span class="n">db_list_after_restore</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">db_list_after_restore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to get the database list.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Collect information of the subclient content after restore&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_after_restore</span><span class="p">:</span>
                        <span class="n">db_list_after_restore</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

                <span class="n">db_info_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                    <span class="n">db_list_after_restore</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

                <span class="c1"># validation using meta data</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating the database information collected before SNAP </span><span class="se">\</span>
<span class="s2">                    Backup and after Inplace Restore for SNAP Backup&quot;</span><span class="p">)</span>
                <span class="c1"># validate subclient content information collected before backup</span>
                <span class="c1"># and after restore</span>
                <span class="n">return_code</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;point_in_time&quot;</span><span class="p">,</span> <span class="s2">&quot;acc1&quot;</span><span class="p">]:</span>
                    <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                        <span class="n">db_info_before_inc_backup</span><span class="p">,</span> <span class="n">db_info_after_restore</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                        <span class="n">db_info_before_full_backup</span><span class="p">,</span> <span class="n">db_info_after_restore</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">return_code</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Database information validation failed.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Database information validation passed successfully&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating if the data is restored from snap copy or not&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">check_if_restore_from_snap_copy</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Data is not restored from snap copy.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;validation passed..!! Data is restored form snap copy.&quot;</span><span class="p">)</span>
            <span class="c1">###### Run backup copy job #########</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Running backup copy job for storage policy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">(</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy precedence of &#39;primary snap&#39; copy is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_precedence</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Native Snap engine is being run. backup &quot;</span>
                    <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;synth_full&quot;</span><span class="p">,</span> <span class="s2">&quot;point_in_time&quot;</span><span class="p">]:</span>
            <span class="c1">############ run synthfull backup jobs ######</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting synthetic full backup.&quot;</span><span class="p">)</span>
            <span class="n">synth_job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;synthetic_full&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synthetic full backup </span><span class="si">%s</span><span class="s2"> is finished&quot;</span><span class="p">,</span> <span class="n">synth_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Running data aging on storage policy:</span><span class="si">%s</span><span class="s2"> copy:primary to &quot;</span>
                 <span class="s2">&quot;make sure the restore is triggered from Synthfull backup&quot;</span><span class="p">),</span>
                <span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>

            <span class="n">common_utils</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CommonUtils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="p">)</span>
            <span class="n">data_aging_job</span> <span class="o">=</span> <span class="n">common_utils</span><span class="o">.</span><span class="n">data_aging</span><span class="p">(</span>
                <span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">,</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataaging job run is:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_aging_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_aging_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run data aging job with error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">data_aging_job</span><span class="o">.</span><span class="n">delay_reason</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data aging job is finished&quot;</span><span class="p">)</span>

            <span class="c1">######### Synth full validation #########</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mounting the snap in client at:/tmp/testcase_mount&quot;</span><span class="p">)</span>
            <span class="n">volume_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_volume_id</span><span class="p">(</span><span class="n">synth_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume ID: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">volume_id</span><span class="p">)</span>
            <span class="c1"># mount the snap in the client</span>
            <span class="n">array_mgmt_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">array_management</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s2">&quot;mkdir -p /tmp/testcase_mount&quot;</span><span class="p">)</span>
            <span class="n">mount_job</span> <span class="o">=</span> <span class="n">array_mgmt_object</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">volume_id</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
                <span class="s2">&quot;/tmp/testcase_mount&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Mounting the snapshot in the client with job:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">mount_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mount_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run mount job with error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">mount_job</span><span class="o">.</span><span class="n">delay_reason</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Succesfully mounted the snapshot in the client&quot;</span><span class="p">)</span>

            <span class="c1"># Validate the data</span>
            <span class="c1"># Run find command to check if the data is corrupted</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;find /tmp/testcase_mount -type f -print &quot;</span>
                       <span class="s2">&quot;-exec cp -r </span><span class="si">{}</span><span class="s2"> /dev/null \; &gt; readsnapdata&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to verify the mounted snap from synhfull job&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Synthfull job is verified&quot;</span><span class="p">)</span>

            <span class="c1"># Unmount the snap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unmounting snapshot&quot;</span><span class="p">)</span>
            <span class="n">unmount_job</span> <span class="o">=</span> <span class="n">array_mgmt_object</span><span class="o">.</span><span class="n">unmount</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">volume_id</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;UnMounting the snapshot in the client with job:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">unmount_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unmount_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to run unmount job with error: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">unmount_job</span><span class="o">.</span><span class="n">delay_reason</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Snapshot is unmounted&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;point_in_time&quot;</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1"># Colecting Meta data</span>
                <span class="n">db_list_before_backup</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">db_list_before_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to get the database list.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Get the subclient content Info before backup</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Collect information of the subclient content&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_before_backup</span><span class="p">:</span>
                        <span class="n">db_list_before_backup</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
                <span class="n">db_info_before_full_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                    <span class="n">db_list_before_backup</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;synth_full&quot;</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1">#### Run incremental with data + backup after synthfull</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running a incremental backup after the synthful job&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding more data to run incremental backup&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">5</span><span class="p">,</span>
                <span class="mi">100</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;auto_snap_inc_after_synthfull&quot;</span><span class="p">)</span>

            <span class="c1"># run incremental backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Incremental backup job&quot;</span><span class="p">)</span>
            <span class="n">inc_job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup</span><span class="p">(</span><span class="n">subclient</span><span class="p">,</span> <span class="s2">&quot;Incremental&quot;</span><span class="p">,</span> <span class="n">inc_with_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Wait for log backup to complete</span>
            <span class="n">inc_job_log</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_snap_log_backup_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log backup job with ID:</span><span class="si">%s</span><span class="s2"> is now completed&quot;</span><span class="p">,</span> <span class="n">inc_job_log</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

            <span class="c1"># Colecting Meta data after inc backup</span>
            <span class="n">db_list_before_backup</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">db_list_before_backup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to get the database list.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Get the subclient content Info before backup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Collect information of the subclient content&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_before_backup</span><span class="p">:</span>
                    <span class="n">db_list_before_backup</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
            <span class="n">db_info_before_inc_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="n">db_list_before_backup</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;native&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subclient</span><span class="o">.</span><span class="n">snapshot_engine_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1">###### Run backup copy job #########</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Running backup copy job for storage policy: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
                <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">(</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy precedence of &#39;primary snap&#39; copy is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">copy_precedence</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Native Snap engine is being run. backup &quot;</span>
                        <span class="s2">&quot;copy job will run inline to snap backup&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the backup job ID of backup copy job&quot;</span><span class="p">)</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">dbhelper_object</span><span class="o">.</span><span class="n">get_backup_copy_job</span><span class="p">(</span><span class="n">inc_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Job ID of backup copy Job is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;synth_full&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1">############ Table level restore ############</span>
            <span class="c1">######### Drop two tables from first database ########</span>
            <span class="n">database_name</span> <span class="o">=</span> <span class="s2">&quot;auto_snap_testdb_0&quot;</span>
            <span class="k">if</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;incremental&quot;</span><span class="p">,</span> <span class="s2">&quot;synth_full&quot;</span><span class="p">]:</span>
                <span class="n">database_name</span> <span class="o">=</span> <span class="s2">&quot;auto_snap_inc_testdb_0&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span>
                <span class="s2">&quot;testtab_1&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="n">database_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_view</span><span class="p">(</span><span class="s2">&quot;test_view_0&quot;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">database_name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collecting meta data to validate data after restore.&quot;</span><span class="p">)</span>
            <span class="n">table_info_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="p">[</span><span class="n">database_name</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span>
                <span class="s2">&quot;testtab_0&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="n">database_name</span><span class="p">)</span>

            <span class="c1"># start table level restore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;starting table level restore.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;/</span><span class="si">%s</span><span class="s2">/public/testtab_0/&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">database_name</span><span class="p">)],</span>
                <span class="n">subclient</span><span class="p">,</span>
                <span class="n">media_agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
                <span class="n">table_level_restore</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collecting meta data to validate.&quot;</span><span class="p">)</span>
            <span class="n">table_info_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
                <span class="p">[</span><span class="n">database_name</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

            <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">table_info_after</span><span class="p">,</span> <span class="n">table_info_before</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_code</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Database info validation failed after table level restore.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Database information validation passed successfully for table level restore&quot;</span><span class="p">)</span>

        <span class="c1">############ restore from primary copy ############</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for 20 seconds before starting restore&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">storage_policy_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
        <span class="n">copy_precedence</span> <span class="o">=</span> <span class="n">storage_policy_object</span><span class="o">.</span><span class="n">get_copy_precedence</span><span class="p">(</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>

        <span class="c1"># stopping postgres server before the restore</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_postgres_server</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
            <span class="n">postgres_data_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server Stop Success, moving to restore phase&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Server was not running, Continuing to restore phase&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_database_directories</span><span class="p">()</span>

        <span class="c1"># Running FS Restore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Restoring database from primary copy with precedence:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="p">)</span>
        <span class="n">synth_job_end_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;point_in_time&quot;</span> <span class="ow">in</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">synth_job_end_time</span> <span class="o">=</span> <span class="n">synth_job</span><span class="o">.</span><span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_restore</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;/data&quot;</span><span class="p">],</span>
            <span class="n">subclient</span><span class="p">,</span>
            <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
            <span class="n">media_agent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
            <span class="n">to_time</span><span class="o">=</span><span class="n">synth_job_end_time</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">pgsql_db_object</span>
        <span class="n">pgsql_db_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>

        <span class="c1"># Colecting Meta data</span>
        <span class="n">db_list_after_restore</span> <span class="o">=</span> <span class="n">pgsql_db_object</span><span class="o">.</span><span class="n">get_db_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_list_after_restore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to get the database list.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Collect information of the subclient content after restore&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">ignore_db_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">db_list_after_restore</span><span class="p">:</span>
                <span class="n">db_list_after_restore</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

        <span class="n">db_info_after_restore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_db_info</span><span class="p">(</span>
            <span class="n">db_list_after_restore</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">)</span>

        <span class="c1"># validation using meta data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating the database information collected before Full </span><span class="se">\</span>
<span class="s2">            Backup and after Inplace Restore for FSBased Backup&quot;</span><span class="p">)</span>
        <span class="c1"># validate subclient content information collected before backup</span>
        <span class="c1"># and after restore</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tc_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;point_in_time&quot;</span><span class="p">,</span> <span class="s2">&quot;acc1&quot;</span><span class="p">]:</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">db_info_before_inc_backup</span><span class="p">,</span> <span class="n">db_info_after_restore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_db_info</span><span class="p">(</span>
                <span class="n">db_info_before_full_backup</span><span class="p">,</span> <span class="n">db_info_after_restore</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Database information validation failed.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Database information validation passed for primary copy restore&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting Automation Created databases&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_tc_db</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="s2">&quot;auto&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.cleanup_database_directories"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.cleanup_database_directories">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_database_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; method to remove data and wal directory before fsbased restore &quot;&quot;&quot;</span>
        <span class="n">data_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_data_dir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_status</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
                <span class="n">data_directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is still running, trying to stop server&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_postgres_server</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_bin_directory</span><span class="p">,</span>
                <span class="n">data_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning postgres data directory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
        <span class="n">wal_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_archive_log_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data directory removed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning postgres wal directory&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">wal_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WAL directory removed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.get_replication_job"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.get_replication_job">[docs]</a>    <span class="k">def</span> <span class="nf">get_replication_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; method to fetch the replication job associated with</span>
<span class="sd">        live sync operation from commserv database</span>

<span class="sd">            Args:</span>
<span class="sd">                backup_job     (obj)    -- backup job object</span>

<span class="sd">            Returns:</span>
<span class="sd">                job            (obj)    --  returns replication job object started</span>
<span class="sd">                by the backup job</span>

<span class="sd">            Raises:</span>
<span class="sd">                Exception</span>
<span class="sd">                    if unable to get replication job ID</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backupset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fsbasedbackupset&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">backupset_id</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;select jobId from JMRestoreStats where bkpSetID=</span><span class="si">{0}</span><span class="s2"> and servStartTime&gt;=</span><span class="si">{1}</span><span class="s2"> order by jobId DESC&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">backupset_id</span><span class="p">,</span>
                <span class="n">backup_job</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;jobEndTime&#39;</span><span class="p">]))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cur</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commcell</span><span class="o">.</span><span class="n">job_controller</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cur</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get the replication Job ID&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sleeping for 30 seconds as replication job is not complete yet&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to get the replication Job ID&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.check_postgres_recovery_mode"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.check_postgres_recovery_mode">[docs]</a>    <span class="k">def</span> <span class="nf">check_postgres_recovery_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if the postgres server is in recovery mode</span>

<span class="sd">        Returns:</span>
<span class="sd">            returns True if the server is in recovery mode else returns False</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if unable to get recovery flag</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">postgres_database_object</span> <span class="o">=</span> <span class="n">database_helper</span><span class="o">.</span><span class="n">PostgreSQL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">client_hostname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_port_number</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">postgres_server_user_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_postgres_db_password</span><span class="p">,</span>
                <span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;select pg_is_in_recovery();&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">postgres_database_object</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in getting recovery flag&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to get recovery flag&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PostgresHelper.create_path_for_tablespace"><a class="viewcode-back" href="../../../../source/Database.PostgreSQL.PostgresUtils.html#Database.PostgreSQL.PostgresUtils.pgsqlhelper.PostgresHelper.create_path_for_tablespace">[docs]</a>    <span class="k">def</span> <span class="nf">create_path_for_tablespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pgsql_datadir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method to create tablespace directory</span>

<span class="sd">        Args:</span>
<span class="sd">            pgsql_datadir   (str)  -- postgresql data directory path</span>

<span class="sd">        Returns:</span>
<span class="sd">            tablespace_dir  (str)  -- Path of the tablespace directory</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception:</span>
<span class="sd">                if unable create tablespace directory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;unix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">lastslash</span> <span class="o">=</span> <span class="n">pgsql_datadir</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">tablespace_dir</span> <span class="o">=</span> <span class="n">pgsql_datadir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lastslash</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">tablespace_dir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">autotabspace&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">pgsql_datadir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">tablespace_dir</span><span class="p">)</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;chown -Rf postgres:postgres </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablespace_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lastslash</span> <span class="o">=</span> <span class="n">pgsql_datadir</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">tablespace_dir</span> <span class="o">=</span> <span class="n">pgsql_datadir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lastslash</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">tablespace_dir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">autotabspace&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">pgsql_datadir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">machine_object</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">tablespace_dir</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tablespace_dir</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in creating tablespace directory&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to create tablespace directory&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>