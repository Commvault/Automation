

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>FileSystem.SNAPUtils.unixsnaphelper &mdash; Commvault Automation 11.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Commvault Automation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Commvault Automation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>FileSystem.SNAPUtils.unixsnaphelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for FileSystem.SNAPUtils.unixsnaphelper</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># Copyright Commvault Systems, Inc.</span>
<span class="c1"># See LICENSE.txt in the project root for</span>
<span class="c1"># license information.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;Helper file for performing Intellisnap operations</span>

<span class="sd">Restore , Data, Queries and UnixSnapHelper are 4 classes defined in this file.</span>

<span class="sd">Restore: Enum constants for all the Restore supported by intellisnap subclients</span>

<span class="sd">Data: Enum constant for data operations</span>

<span class="sd">Queries: Enum constant for required queries for snap operation</span>

<span class="sd">UnixSnapHelper - Helper class to perform intellisnap operations</span>

<span class="sd">UnixSnapHelper:</span>
<span class="sd">    _create_paths()            - Creates necessary paths on client and MA</span>

<span class="sd">    _delete_paths()            - Deletes up paths created by the test case</span>

<span class="sd">    _create_disk_lib()         - Creates disk library entity on CS</span>

<span class="sd">    _create_storage_policy()   - Creates storage policy entity on CS</span>

<span class="sd">    _create_subclient()        - Creates subclient entity on CS</span>

<span class="sd">    setup_snap_environment()   - Wrapper function that setups necessary environment</span>
<span class="sd">                                 for the test case</span>

<span class="sd">    _execute_query()           - Execute DB queries</span>

<span class="sd">    _add_array()               - Function to add storage array</span>

<span class="sd">    _generate_test_data()      - Generate test data required for the test case</span>

<span class="sd">    _modify_test_data()        - Modify test data between the jobs</span>

<span class="sd">    snap_backup()              - Adds or modifies data and run a snapshot backup job</span>

<span class="sd">    backup_copy()              - Run backup copy jobs for the storage policy</span>

<span class="sd">    restore()                  - Run restore job either in place or out of place</span>

<span class="sd">    compare_data()             - Compare the source and destination files and folders</span>

<span class="sd">    verify_restore()           - Verifies restore job by comparing the source and restored data</span>

<span class="sd">    verify_mount()             - Mounts the snapshot and compares source and snapshot data</span>

<span class="sd">    verify_unmount()           - Mounts and unmounts the snapshot, and verifies that snapshot</span>
<span class="sd">                                 is unmounted and temporary directories are deleted</span>

<span class="sd">    verify_revert()            - Performs a hardware revert and compares the reverted data with</span>
<span class="sd">                                 copy of source</span>

<span class="sd">    snap_operation()           - Helper function for performing snap operation</span>
<span class="sd">                                 mount/unmount/revert/delete</span>

<span class="sd">    verify_optimized_scan()    - Verifies that jobs was run with optimized scan</span>

<span class="sd">    _make_test_data_copy()     - Make copy of source preserving the metadata</span>

<span class="sd">    _get_mount_status()        - Returns mount status for the snapshot</span>

<span class="sd">    cleanup()                  - Cleans up entities and paths created at the beginning</span>
<span class="sd">                                 of the test case</span>

<span class="sd">    add_data_to_path()         - Add files to the folder path and return the</span>
<span class="sd">                                 list of files added to be Backed-up</span>

<span class="sd">    verify_collect_extent()-   - Verify if all teh extents are backed up for the source_list</span>

<span class="sd">    acceptance_tamplate()      - Snap Acceptance template to be used for all test cases</span>
<span class="sd">                                 with different Unix configurations and snap engines</span>

<span class="sd">    snap_extent_template()     - Template to run extent test case for intellisnap</span>

<span class="sd">    check_volume_monitoring()  - Check the state of the volume for DC</span>

<span class="sd">    get_backup_stream_count()  - Returns the number of streams used by a backup job</span>

<span class="sd">    get_restore_stream_count() - Returns the number of streams used by a restore job</span>

<span class="sd">    verify_job_streams()       - Verifies if the job used expected number of streams</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">cvpysdk.exception</span> <span class="kn">import</span> <span class="n">SDKException</span>
<span class="kn">from</span> <span class="nn">cvpysdk.job</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">cvpysdk.policies.storage_policies</span> <span class="kn">import</span> <span class="n">StoragePolicyCopy</span>
<span class="kn">from</span> <span class="nn">cvpysdk.schedules</span> <span class="kn">import</span> <span class="n">Schedules</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">AutomationUtils</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.constants</span> <span class="kn">import</span> <span class="n">backup_level</span><span class="p">,</span> \
    <span class="n">UNIX_VOLUME_STATE</span><span class="p">,</span> <span class="n">UNIX_GET_RESTORE_STREAM_COUNT</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.database_helper</span> <span class="kn">import</span> <span class="n">get_csdb</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.machine</span> <span class="kn">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">AutomationUtils.options_selector</span> <span class="kn">import</span> <span class="n">CVEntities</span>
<span class="kn">from</span> <span class="nn">FileSystem.FSUtils.fshelper</span> <span class="kn">import</span> <span class="n">ScanType</span>


<div class="viewcode-block" id="Restore"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.Restore">[docs]</a><span class="k">class</span> <span class="nc">Restore</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Restore Types enumeration &quot;&quot;&quot;</span>
    <span class="n">RESTORE_FROM_SNAP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">RESTORE_FROM_TAPE</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="Data"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.Data">[docs]</a><span class="k">class</span> <span class="nc">Data</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data Operation enumeration &quot;&quot;&quot;</span>
    <span class="n">ADD_DATA</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">MODIFY_DATA</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ADD_MODIFY_DATA</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">DELETE_DATA</span> <span class="o">=</span> <span class="mi">4</span></div>


<div class="viewcode-block" id="Queries"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.Queries">[docs]</a><span class="k">class</span> <span class="nc">Queries</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Queries required for snap backup &quot;&quot;&quot;</span>
    <span class="n">BACKUP_COPY_JOB_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT childJobId FROM JMJobWF WHERE jobId = </span><span class="si">{a}</span><span class="s1">&#39;</span>
    <span class="n">BACKUP_SIZE_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT totalBackupSize FROM JMBkpStats WHERE jobID = </span><span class="si">{a}</span><span class="s1">&#39;</span>
    <span class="n">MOUNT_STATUS_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT MountStatus FROM SMVolume WHERE JobId = </span><span class="si">{a}</span><span class="s1">&#39;</span>
    <span class="n">JOB_IDS_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT JobId FROM SMVolume WHERE CopyId = </span><span class="si">{a}</span><span class="s1">&#39;</span>
    <span class="n">MOUNT_PATH_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT SourcePath, MountPath FROM SMVolume </span><span class="se">\</span>
<span class="s1">                        WHERE JobId = </span><span class="si">{a}</span><span class="s1"> AND CopyId = </span><span class="si">{b}</span><span class="s1">&#39;</span>
    <span class="n">VOLUME_ID_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT SMVolumeId FROM SMVolume WHERE jobID = </span><span class="si">{a}</span><span class="s1"> AND CopyId = </span><span class="si">{b}</span><span class="s1">&#39;</span>
    <span class="n">CONTROL_HOST_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT ControlHostId FROM SMsnap WHERE SMSnapId in </span><span class="se">\</span>
<span class="s1">                                (SELECT SMSnapId FROM SMVolSnapMap WHERE SMVolumeId in </span><span class="se">\</span>
<span class="s1">                                (SELECT SMVolumeId from SMVolume WHERE JobId = </span><span class="si">{a}</span><span class="s1">))&#39;</span>
    <span class="n">SNAP_COUNT_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT snap.SMSnapId FROM SMVolume AS Vol </span><span class="se">\</span>
<span class="s1">                                INNER JOIN SMVolSnapMap AS map ON vol.SMVolumeId = map.SMVolumeId </span><span class="se">\</span>
<span class="s1">                                INNER JOIN SMSnap AS snap ON map.SMSnapId = snap.SMSnapId AND </span><span class="se">\</span>
<span class="s1">                                snap.ReserveField2 = </span><span class="si">{a}</span><span class="s1"> WHERE vol.JobId = </span><span class="si">{b}</span><span class="s1"> AND </span><span class="se">\</span>
<span class="s1">                                snap.ControlHostId IN (</span><span class="si">{c}</span><span class="s1">, </span><span class="si">{d}</span><span class="s1">)&#39;</span>
    <span class="n">SNAP_COPY_NAME_QUERY</span> <span class="o">=</span> <span class="s1">&#39;SELECT name FROM ArchGroupCopy WHERE ArchGroupId = </span><span class="si">{a}</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">                            AND copy = 1 AND isSnapCopy = 1&#39;</span></div>


<div class="viewcode-block" id="UnixSnapHelper"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper">[docs]</a><span class="k">class</span> <span class="nc">UnixSnapHelper</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    UnixSnapHelper - helper class for Unix FS snap automation</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commcell</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">tcinputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        Args:</span>
<span class="sd">            commcell        (commcell)          -- Commcell object</span>

<span class="sd">            client          (client)            -- client object</span>

<span class="sd">            agent           (agent)             -- Agent object</span>

<span class="sd">            tcinputs        (dict)              -- tcinputs dictionary of test case class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_library</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_proxy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy_proxy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_tracker</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span> <span class="o">=</span> <span class="n">get_csdb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span> <span class="o">=</span> <span class="n">commcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span> <span class="o">=</span> <span class="n">tcinputs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span> <span class="o">=</span> <span class="n">CVEntities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ScanType&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">ScanType</span><span class="o">.</span><span class="n">OPTIMIZED</span> \
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ScanType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;optimized&#39;</span> \
                <span class="k">else</span> <span class="n">ScanType</span><span class="o">.</span><span class="n">RECURSIVE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">ScanType</span><span class="o">.</span><span class="n">RECURSIVE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SubclientContent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;RestoreLocation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;InstanceName&#39;</span><span class="p">]</span> \
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;InstanceName&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;DefaultInstanceName&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;Filter_content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Filter_content&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_dir</span> <span class="o">=</span> <span class="s1">&#39;automation_disklib_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_name</span> <span class="o">=</span> <span class="s1">&#39;automation_lib_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">=</span> <span class="s1">&#39;automation_sp_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span> <span class="o">=</span> <span class="s1">&#39;automation_bs_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span> <span class="o">=</span> <span class="s1">&#39;automation_sc_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> \
                              <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SnapEngine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;DiskLibLocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_location</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="s1">&#39;_restore&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_location</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="s1">&#39;_copy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bkpset_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BackupsetName&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SubclientName&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_copy_name</span> <span class="o">=</span> <span class="s1">&#39;snapCopy&#39;</span>

    <span class="k">def</span> <span class="nf">_create_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create necessary folders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Create disk library path&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created disk library path [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Create content directory&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created content directory [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Create restore path&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created restore path [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Create copy path&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created copy path [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete folders created during setup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleanup disk library path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ma_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleanup content paths&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleanup restore path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleanup copy path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleanup mount path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_disk_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create disk library</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;mediaagent&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">])</span>
                <span class="p">},</span>
            <span class="s1">&#39;disklibrary&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_name</span><span class="p">,</span>
                    <span class="s1">&#39;mount_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_path</span>
                <span class="p">},</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;disklibrary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;disklibrary&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;disklibrary&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_create_storage_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create storage policy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;mediaagent&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">])</span>
                <span class="p">},</span>
            <span class="s1">&#39;storagepolicy&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span>
                    <span class="s1">&#39;library&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk_lib_name</span><span class="p">),</span>
                    <span class="s1">&#39;retention_period&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;number_of_streams&#39;</span><span class="p">:</span> <span class="mi">50</span>
                <span class="p">},</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span><span class="o">.</span><span class="n">create_snap_copy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_copy_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk_library</span><span class="o">.</span><span class="n">library_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;MediaAgentName&#39;</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># time.sleep(5)</span>
        <span class="c1"># Adding snapshot copy to SP triggers creation of backup copy schedule</span>
        <span class="c1"># check and delete the schedule as it interferes with the test case flow</span>
        <span class="c1"># there is no way to disable the creations of the schedule</span>
        <span class="n">schedules</span> <span class="o">=</span> <span class="n">Schedules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">)</span>
        <span class="n">schedules</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="n">schedules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span> <span class="o">+</span> <span class="s1">&#39; snap copy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schedules</span><span class="o">.</span><span class="n">has_schedule</span><span class="p">(</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">schedule_name</span><span class="p">,</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">schedule_id</span><span class="p">):</span>
            <span class="n">schedules</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">schedule</span><span class="o">.</span><span class="n">schedule_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_subclient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create subclient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;force&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span>
                <span class="p">},</span>
            <span class="s1">&#39;backupset&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">,</span>
                    <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span>
                    <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
                    <span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_name</span>
                <span class="p">},</span>
            <span class="s1">&#39;subclient&#39;</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s1">&#39;agent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient_name</span><span class="p">,</span>
                    <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span>
                    <span class="s1">&#39;filter_content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_content</span><span class="p">,</span>
                    <span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_name</span><span class="p">,</span>
                    <span class="s1">&#39;storagepolicy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy_name</span><span class="p">,</span>
                    <span class="s1">&#39;backupset&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset_name</span><span class="p">,</span>
                    <span class="s1">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span>
                <span class="p">},</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">enable_intelli_snap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SnapEngine&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="UnixSnapHelper.setup_snap_environment"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.setup_snap_environment">[docs]</a>    <span class="k">def</span> <span class="nf">setup_snap_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup snap environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">enable_intelli_snap</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_paths</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkpset_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Note creating entites as test case is run on existing subclient&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">backupsets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bkpset_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backupset</span><span class="o">.</span><span class="n">subclients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_type</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">enable_intelli_snap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SnapEngine&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">storage_policies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_copy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span>
                <span class="n">Queries</span><span class="o">.</span><span class="n">SNAP_COPY_NAME_QUERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span><span class="o">.</span><span class="n">storage_policy_id</span><span class="p">},</span> <span class="n">fetch_rows</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_disk_lib</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_storage_policy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_subclient</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_execute_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fetch_rows</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute query and return one or all rows</span>
<span class="sd">        Args:</span>
<span class="sd">            query           (str)   -- SQL query to be excuted</span>

<span class="sd">            options         (str)   -- values to be replaced in the query</span>


<span class="sd">            fetch_rows      (str)   -- By default return all rows, if not return one row</span>

<span class="sd">        Return:</span>
<span class="sd">            (str) query output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fetch_rows</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_one_row</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">csdb</span><span class="o">.</span><span class="n">fetch_all_rows</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add array entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ArrayName&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ArrayVendor&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ArrayUserName&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ArrayPassword&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding array management entry&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">add_array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ArrayVendor&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ArrayName&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ArrayUserName&#39;</span><span class="p">],</span>
                    <span class="n">b64encode</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ArrayPassword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;ControlHost&#39;</span><span class="p">],</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Array details not provided skipping add array&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SDKException</span> <span class="k">as</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">exception_id</span> <span class="o">==</span> <span class="s1">&#39;101&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Array already exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate test data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating test data under [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modify_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify test data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="n">Data</span><span class="o">.</span><span class="n">ADD_DATA</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_dir</span> <span class="o">=</span> <span class="s1">&#39;incdata_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
                <span class="n">inc_data_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inc_data_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding test data under [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">inc_data_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">inc_data_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">generate_test_data</span><span class="p">(</span><span class="n">inc_data_path</span><span class="p">)</span>

<div class="viewcode-block" id="UnixSnapHelper.snap_backup"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.snap_backup">[docs]</a>    <span class="k">def</span> <span class="nf">snap_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">skip_data_creation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Generate test data and run snap backup</span>

<span class="sd">        Args:</span>
<span class="sd">            level                 (backup_level)     -- Following values are supported:</span>
<span class="sd">                                                        backup_level.Full</span>
<span class="sd">                                                        backup_level.INCREMENTAL</span>
<span class="sd">                                                        backup_level.SYNTHETICFULL</span>

<span class="sd">            skip_data_creation   (bool)              -- False if data need to be create</span>
<span class="sd">                                                        before running backup otherwise False.</span>

<span class="sd">            option              (dict)               -- advance option for snap backup.</span>

<span class="sd">                    key:&#39;inline_bkp_cpy&#39;               Value: (bool) - To run backup copy</span>
<span class="sd">                                                                       immediately</span>

<span class="sd">                    key:&#39;skip_catalog&#39;                 Value: (bool) - To run snap backup</span>
<span class="sd">                                                                       with or without cataloging</span>

<span class="sd">        Returns:</span>
<span class="sd">              job               (job object)        -- job object of snap backup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_data_creation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">backup_level</span><span class="o">.</span><span class="n">FULL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_test_data</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="n">backup_level</span><span class="o">.</span><span class="n">INCREMENTAL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modify_test_data</span><span class="p">(</span><span class="n">Data</span><span class="o">.</span><span class="n">ADD_DATA</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">option</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">advanced_option</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;inline_bkp_cpy&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inline_bkp_cpy&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;skip_catalog&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_catalog&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">backup_level</span><span class="o">.</span><span class="n">SYNTHETICFULL</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="s1">&#39;Synthetic_Full&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span>
                <span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">advanced_options</span><span class="o">=</span><span class="n">advanced_option</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Monitoring [</span><span class="si">%s</span><span class="s1">] [</span><span class="si">%s</span><span class="s1">] job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
            <span class="n">job</span><span class="o">.</span><span class="n">backup_level</span><span class="p">,</span>
            <span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
            <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Failed to run [</span><span class="si">%s</span><span class="s1">] snap backup job with error [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to run snap backup job&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">backup_level</span> <span class="o">!=</span> <span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Backup not run at same level as started expected [</span><span class="si">%s</span><span class="s1">] actual [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">job</span><span class="o">.</span><span class="n">backup_level</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backup not run at the same level as started&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully finished [</span><span class="si">%s</span><span class="s1">] [</span><span class="si">%s</span><span class="s1">] job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                      <span class="n">job</span><span class="o">.</span><span class="n">backup_level</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span>
                      <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span>

        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="UnixSnapHelper.backup_copy"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.backup_copy">[docs]</a>    <span class="k">def</span> <span class="nf">backup_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subclient_level</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run backup copy for a subclient or storage policy</span>

<span class="sd">        Args:</span>
<span class="sd">            subclient_level     (bool)     --following option for running</span>
<span class="sd">                                            backup copy from different level.</span>
<span class="sd">                                            True - subclient level</span>
<span class="sd">                                            False - Storage policy level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">subclient_level</span><span class="p">:</span>
            <span class="n">work_flow_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_flow_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span><span class="o">.</span><span class="n">run_backup_copy</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">backup_copy_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span>
            <span class="n">Queries</span><span class="o">.</span><span class="n">BACKUP_COPY_JOB_QUERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">work_flow_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">},</span> <span class="n">fetch_rows</span><span class="o">=</span><span class="s1">&#39;one&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backup_copy_job_id</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Backup copy job for the workflow job [</span><span class="si">%s</span><span class="s1">] is not started&#39;</span><span class="p">,</span>
                <span class="n">work_flow_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backup copy job not started&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">backup_copy_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span> <span class="n">backup_copy_job_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Monitoring [</span><span class="si">%s</span><span class="s1">] [</span><span class="si">%s</span><span class="s1">] job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">backup_level</span><span class="p">,</span>
                <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Backup copy job failed with error [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                           <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">delay_reason</span>
                           <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backup copy job failed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Successfully finished backup copy job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
            <span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">work_flow_job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Backup copy workflow job failed with error [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                           <span class="n">work_flow_job</span><span class="o">.</span><span class="n">delay_reason</span>
                           <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Backup copy workflow job failed&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy_job</span> <span class="o">=</span> <span class="n">backup_copy_job</span>
        <span class="k">return</span> <span class="n">backup_copy_job</span></div>

<div class="viewcode-block" id="UnixSnapHelper.restore"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="p">,</span>
                <span class="n">src_path</span><span class="p">,</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dst_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">restore_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">no_of_streams</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore from last job</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_precedence (str)       -- Copy precedence</span>
<span class="sd">                                            1 - snapcopy,</span>
<span class="sd">                                            2 - primary copy</span>

<span class="sd">            src_path        (str)       -- source path for restore</span>

<span class="sd">            inplace         (str)       -- By default do inplace restore,</span>
<span class="sd">                                           otherwise out of place restore</span>

<span class="sd">            dst_client      (str)       -- Destination client for cross client out of place restore</span>

<span class="sd">            restore_path    (str)       -- Restore path on destination client</span>

<span class="sd">            \*\*kwargs  (dict)          --  Optional keyword arguments</span>

<span class="sd">            Available kwargs options:</span>

<span class="sd">                instant_clone_options       (dict)  -- Options for performing an instant clone restore operation.</span>
<span class="sd">                The following key-value pairs are supported.</span>

<span class="sd">                    clone_mount_path        (str)   --  The path to which the snapshot needs to be mounted.</span>
<span class="sd">                    This  key is NOT OPTIONAL.</span>

<span class="sd">                    reservation_time        (int)   --  The amount of time, specified in seconds, that the mounted</span>
<span class="sd">                    snapshot needs to be reserved for before it is cleaned up.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">                            Default :   3600</span>

<span class="sd">                    post_clone_script       (str)   --  The script that will run post clone.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">                    clone_cleanup_script    (str)   --  The script that will run after clean up.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">copy_precedence</span> <span class="ow">is</span> <span class="n">Restore</span><span class="o">.</span><span class="n">RESTORE_FROM_SNAP</span><span class="p">:</span>
            <span class="n">from_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;jobStartTime&#39;</span><span class="p">]))</span>
            <span class="n">to_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;jobEndTime&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">to_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Running out of place restore from copy precedence [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="p">)</span>
            <span class="n">fs_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;preserve_level&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;no_of_streams&#39;</span><span class="p">:</span> <span class="n">no_of_streams</span><span class="p">,</span>
                <span class="s1">&#39;instant_clone_options&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instant_clone_options&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">dst_client</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">restore_path</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;Restore path required cross machine out of place restore&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s1">&#39;Restore path not provided cross machine out of place restore&#39;</span><span class="p">)</span>
                <span class="n">dst_client_name</span> <span class="o">=</span> <span class="n">dst_client</span><span class="o">.</span><span class="n">client_name</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">dst_client_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">client_name</span>
                <span class="n">dst_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
                <span class="n">restore_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restore_path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">no_of_streams</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fs_options</span><span class="p">[</span><span class="s1">&#39;destination_appTypeId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">33</span> <span class="k">if</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">in</span> \
                                                            <span class="n">dst_client</span><span class="o">.</span><span class="n">_os_info</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="mi">29</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore_out_of_place</span><span class="p">(</span>
                <span class="n">dst_client_name</span><span class="p">,</span>
                <span class="n">restore_path</span><span class="p">,</span>
                <span class="n">src_path</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
                <span class="n">from_time</span><span class="o">=</span><span class="n">from_time</span><span class="p">,</span>
                <span class="n">to_time</span><span class="o">=</span><span class="n">to_time</span><span class="p">,</span>
                <span class="n">fs_options</span><span class="o">=</span><span class="n">fs_options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Running in place restore from copy precedence [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_test_data_copy</span><span class="p">()</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">restore_in_place</span><span class="p">(</span>
                <span class="n">src_path</span><span class="p">,</span>
                <span class="n">copy_precedence</span><span class="o">=</span><span class="n">copy_precedence</span><span class="p">,</span>
                <span class="n">from_time</span><span class="o">=</span><span class="n">from_time</span><span class="p">,</span> <span class="n">to_time</span><span class="o">=</span><span class="n">to_time</span><span class="p">,</span>
                <span class="n">fs_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;preserve_level&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Monitoring restore job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Restore job failed with error [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                <span class="n">job</span><span class="o">.</span><span class="n">delay_reason</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Restore job failed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">no_of_streams</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instant_clone_options&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_job_streams</span><span class="p">(</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">no_of_streams</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restore_stream_count</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="UnixSnapHelper.compare_data"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.compare_data">[docs]</a>    <span class="k">def</span> <span class="nf">compare_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dst_client_machine</span><span class="p">,</span>
            <span class="n">src_path</span><span class="p">,</span>
            <span class="n">dst_path</span><span class="p">,</span>
            <span class="n">compare_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare metadata and md5sum for the source and destination path</span>

<span class="sd">        Args:</span>
<span class="sd">            dst_client_machine      (str)   -- Destination client machine object for comparison</span>

<span class="sd">            src_path                (str)   -- Source data path</span>

<span class="sd">            dst_path                (str)   -- Restore data path</span>

<span class="sd">            compare_meta            (str)   -- By default do metadata comparison, otherwise skip</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compare_meta</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">diff_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">compare_meta_data</span><span class="p">(</span>
                <span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">,</span> <span class="n">skiplink</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Meta data comparison for source [</span><span class="si">%s</span><span class="s1">] and destination [</span><span class="si">%s</span><span class="s1">] failed&#39;</span><span class="p">,</span>
                    <span class="n">src_path</span><span class="p">,</span>
                    <span class="n">dst_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Diff output </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">diff_output</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Meta data comparison failed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Meta data comparison for source [</span><span class="si">%s</span><span class="s1">] and destination [</span><span class="si">%s</span><span class="s1">] successful&#39;</span><span class="p">,</span>
                    <span class="n">src_path</span><span class="p">,</span>
                    <span class="n">dst_path</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">compare_folders</span><span class="p">(</span>
            <span class="n">dst_client_machine</span><span class="p">,</span> <span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;md5sum comparison for source [</span><span class="si">%s</span><span class="s1">] and destination [</span><span class="si">%s</span><span class="s1">] successful&#39;</span><span class="p">,</span>
                <span class="n">src_path</span><span class="p">,</span>
                <span class="n">dst_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;md5sum comparison for source [</span><span class="si">%s</span><span class="s1">] and destination [</span><span class="si">%s</span><span class="s1">] failed&#39;</span><span class="p">,</span>
            <span class="n">src_path</span><span class="p">,</span>
            <span class="n">dst_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Diff output </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;md5sum comparison failed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_restore"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_restore">[docs]</a>    <span class="k">def</span> <span class="nf">verify_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst_client_machine</span><span class="p">,</span> <span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify Restore by comparing restored data and source data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">src_path</span><span class="p">:</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">dst_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare_data</span><span class="p">(</span><span class="n">dst_client_machine</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restore verification successful&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_mount_unmount"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_mount_unmount">[docs]</a>    <span class="k">def</span> <span class="nf">verify_mount_unmount</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">src_path</span><span class="p">,</span>
            <span class="n">mount_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mount_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Verify mount, Mount snapshot and compare with source. Unmount the snapshot</span>

<span class="sd">            Args:</span>
<span class="sd">                src_path        (str)       -- Source path for comparison</span>

<span class="sd">                dst_client      (str)       -- Destination client if snap</span>
<span class="sd">                                               to be mounted on another client</span>

<span class="sd">                dst_mount_path  (str)       -- Temoporary location for mountinf snapshot</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">copy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snap_copy_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mount_client</span><span class="p">:</span>
            <span class="n">mount_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
            <span class="n">mount_path</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_TMP_DIR</span>
        <span class="n">mount_client_machine</span> <span class="o">=</span> <span class="n">Machine</span><span class="p">(</span><span class="n">mount_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_operation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;mount&#39;</span><span class="p">,</span> <span class="n">mount_client</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="n">copy_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">src_path</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mnt_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mnt_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">dst_path</span> <span class="o">=</span> <span class="n">mnt_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                        <span class="n">mount_client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">mount_client_machine</span><span class="o">.</span><span class="n">os_sep</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">compare_data</span><span class="p">(</span><span class="n">mount_client_machine</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mount verification successful for job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span>
                                  <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mount_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;59&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_operation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;unmount&#39;</span><span class="p">,</span> <span class="n">copy_name</span><span class="o">=</span><span class="n">copy_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mount_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;79&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">mount_client_machine</span><span class="o">.</span><span class="n">check_directory_exists</span><span class="p">(</span>
                            <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unmount verification successful&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_revert"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_revert">[docs]</a>    <span class="k">def</span> <span class="nf">verify_revert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify hardware revert</span>

<span class="sd">        Make a copy of source data</span>

<span class="sd">        Perform hardware revert</span>

<span class="sd">        Compare source data with copy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">copy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snap_copy_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">backup_level</span> <span class="o">==</span> <span class="n">backup_level</span><span class="o">.</span><span class="n">SYNTHETICFULL</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">ScanType</span><span class="o">.</span><span class="n">OPTIMIZED</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_test_data_copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_directory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_operation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;revert&#39;</span><span class="p">,</span> <span class="n">copy_name</span><span class="o">=</span><span class="n">copy_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">:</span>
                <span class="n">dpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Revert verification successful&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.snap_operation"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.snap_operation">[docs]</a>    <span class="k">def</span> <span class="nf">snap_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">,</span>
                       <span class="n">operation</span><span class="p">,</span>
                       <span class="n">mount_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">mount_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">copy_name</span><span class="o">=</span><span class="kc">None</span>
                       <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Snap Operations for given job id</span>

<span class="sd">            Args:</span>

<span class="sd">            job_id          (str)      -- Snapbackup Job ID</span>

<span class="sd">            operation       (str)      -- Following operations are allowed</span>

<span class="sd">                                            mount - mount snapshots</span>

<span class="sd">                                            unmount - unmount snapshot</span>

<span class="sd">                                            revert - perform hardware revert</span>

<span class="sd">                                            delete - delete snapshot</span>

<span class="sd">                                            force_delete - force delete snapshot</span>

<span class="sd">            copy_name       (str)       -- Snapshot copy name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">copy_id</span> <span class="o">=</span> <span class="n">StoragePolicyCopy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage_policy</span><span class="p">,</span>
            <span class="n">copy_name</span><span class="p">)</span><span class="o">.</span><span class="n">copy_id</span>
        <span class="n">volume_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span>
            <span class="n">Queries</span><span class="o">.</span><span class="n">VOLUME_ID_QUERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">copy_id</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;mount&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mount_client</span><span class="p">:</span>
                <span class="n">mount_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
                <span class="n">mount_path</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">UNIX_TMP_DIR</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span>
                <span class="n">volume_id</span><span class="p">,</span> <span class="n">mount_client</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">mount_path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;unmount&#39;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">unmount</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;revert&#39;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">revert</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;force_delete&#39;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">array_management</span><span class="o">.</span><span class="n">force_delete</span><span class="p">(</span><span class="n">volume_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;operation </span><span class="si">%s</span><span class="s2"> is invalid&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;operation </span><span class="si">%s</span><span class="s2"> is invalid&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Monitoring Snap Operation [</span><span class="si">%s</span><span class="s1">] job [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="p">,</span>
            <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to run snap operation [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to run snap operation&#39;</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Completed snap operation [</span><span class="si">%s</span><span class="s1">] for job [</span><span class="si">%s</span><span class="s1">] and volume_id [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="p">,</span>
            <span class="n">job_id</span><span class="p">,</span>
            <span class="n">volume_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;mount&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_mount_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span>
                <span class="n">Queries</span><span class="o">.</span><span class="n">MOUNT_PATH_QUERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">copy_id</span><span class="p">})</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_optimized_scan"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_optimized_scan">[docs]</a>    <span class="k">def</span> <span class="nf">verify_optimized_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">              Verify if DC was run for the job</span>

<span class="sd">                  Args:</span>
<span class="sd">                      jobid       (str)       -- jobid of the required job</span>

<span class="sd">                  Returns</span>
<span class="sd">                      (bool)                  -- return true if all the volume in subclient content has used optimized scan</span>
<span class="sd">                                                  else False</span>
<span class="sd">              &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;grep </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">//FileScan*.log &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">jobid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">log_directory</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;|grep &quot; DataClassificationHelper initialized for&quot;|wc -l&#39;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Failed checking the log lines for DC .output </span><span class="si">{}</span><span class="s2"> error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">exception_message</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Optimized scan used for </span><span class="si">{}</span><span class="s2"> volumes which is not expected&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_make_test_data_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make copy of the test data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">copy_folder</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_copy_path</span><span class="p">,</span> <span class="n">optional_params</span><span class="o">=</span><span class="s1">&#39;-fp&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mount_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To get the mount status of a snap.</span>

<span class="sd">            Returns:</span>
<span class="sd">                mount status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_query</span><span class="p">(</span>
            <span class="n">Queries</span><span class="o">.</span><span class="n">MOUNT_STATUS_QUERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">})</span>

<div class="viewcode-block" id="UnixSnapHelper.cleanup"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup entities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bkpset_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not deleting entities as the test case run on existing subclient&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">delete</span><span class="p">({</span><span class="s1">&#39;subclient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;subclient&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">delete</span><span class="p">({</span><span class="s1">&#39;backupset&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;backupset&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;storagepolicy&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_entities</span><span class="o">.</span><span class="n">delete</span><span class="p">({</span><span class="s1">&#39;disklibrary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="s1">&#39;disklibrary&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_paths</span><span class="p">()</span></div>

<div class="viewcode-block" id="UnixSnapHelper.add_data_to_path"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.add_data_to_path">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_to_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_data_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add files to the folder path and return the list of files added to be Backed-up</span>

<span class="sd">            Args :</span>
<span class="sd">                full_data_path:      (str)      --   Folder path to create the files</span>

<span class="sd">            Return:</span>
<span class="sd">                list of files to be Backed-up</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">list_of_non_extent_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_data_path</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">list_of_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;dd if=/dev/urandom of=</span><span class="si">{0}</span><span class="s2"> count=17 bs=1048576&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">file_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">.doc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">os_sep</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">list_of_non_extent_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;dd if=/dev/urandom of=</span><span class="si">{0}</span><span class="s2"> count=1 bs=1048&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">file_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;List of files that doesnt qualify for extent backup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">list_of_non_extent_files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;List of extent qualified files: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">list_of_files</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">list_of_files</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_collect_extents"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_collect_extents">[docs]</a>    <span class="k">def</span> <span class="nf">verify_collect_extents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if all the extents are backed up for the source_list</span>
<span class="sd">        Args:</span>
<span class="sd">            source_list        (list)       -- Source list to compare it with collect file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Get the job results directory</span>
        <span class="n">collect_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{2}</span><span class="s2">/</span><span class="si">{3}</span><span class="s2">/</span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">job_results_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;CV_JobResults&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commcell_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">collect_path</span><span class="p">)</span>
        <span class="c1"># Check the collect files based on job type</span>

        <span class="c1"># Check for Extents and Container flag in CollectTot</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;cat  </span><span class="si">{0}</span><span class="s2">/CollectTot* | grep </span><span class="si">%E</span><span class="s2">XTENT%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">collect_path</span><span class="p">)</span>
        <span class="n">extent_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">cmd_container</span> <span class="o">=</span> <span class="s2">&quot;cat </span><span class="si">{0}</span><span class="s2">/CollectTot* | grep %CONTAINER%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">collect_path</span><span class="p">)</span>
        <span class="n">container_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd_container</span><span class="p">)</span>
        <span class="n">extent_output_loop</span> <span class="o">=</span> <span class="n">extent_output</span><span class="o">.</span><span class="n">formatted_output</span>
        <span class="n">container_loop</span> <span class="o">=</span> <span class="n">container_output</span><span class="o">.</span><span class="n">formatted_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Container output:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">container_loop</span><span class="p">)</span>
        <span class="c1"># Maintain container only list and extent only list to compare flags</span>
        <span class="c1"># are sent correctly</span>
        <span class="n">container_file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extent_file_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Splitting the collect file items to get the path list for extents or</span>
        <span class="c1"># ACLs</span>
        <span class="k">for</span> <span class="n">list1</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                <span class="n">extent_output_loop</span><span class="p">,</span>
                <span class="n">container_loop</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">innerlist</span> <span class="ow">in</span> <span class="n">list1</span><span class="p">:</span>
                <span class="n">subpaths</span> <span class="o">=</span> <span class="n">innerlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">subpaths</span><span class="p">)</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subpaths</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;%CONTAINER%&quot;</span><span class="p">:</span>
                    <span class="n">lastword</span> <span class="o">=</span> <span class="n">subpaths</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">container_file_split</span> <span class="o">=</span> <span class="n">lastword</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                    <span class="n">container_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subpaths</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">subpaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                                               <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">container_file_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">container_file_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subpaths</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">subpaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">extent_file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subpaths</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">subpaths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">extent_file_list</span><span class="p">)</span>

        <span class="n">collect_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">file_list</span><span class="p">))</span>
        <span class="n">container_cmp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">container_file_list</span><span class="p">))</span>
        <span class="n">extent_cmp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">extent_file_list</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">container_cmp_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Comparing extent files against container list:&quot;</span><span class="p">)</span>
            <span class="n">compare_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">compare_lists</span><span class="p">(</span>
                <span class="n">extent_cmp_list</span><span class="p">,</span> <span class="n">container_cmp_list</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Extent back up file may not have associated container&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Containers are sent correctly for extent backed up files!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;collect list:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">collect_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;source list:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">source_list</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">collect_list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">compare_lists</span><span class="p">(</span>
                <span class="n">source_list</span><span class="p">,</span> <span class="n">collect_list</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collect file comparison is successful&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to compare the collect files&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="UnixSnapHelper.validate_filters"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.validate_filters">[docs]</a>    <span class="k">def</span> <span class="nf">validate_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unix_filters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :type unix_filters: Provide the filter option for validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the job results directory</span>
            <span class="n">collect_file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">/</span><span class="si">{2}</span><span class="s2">/</span><span class="si">{3}</span><span class="s2">/</span><span class="si">{4}</span><span class="s2">/</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">job_results_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;CV_JobResults&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">commcell</span><span class="o">.</span><span class="n">commcell_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy_job</span><span class="o">.</span><span class="n">job_id</span><span class="p">),</span> <span class="s2">&quot;CollectTot1.cvf&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">collect_file_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">unix_filters</span><span class="p">)</span>

            <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">unix_filters</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">filter</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">collect_file_path</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;The filter </span><span class="si">%s</span><span class="s2"> is not being honoured &quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The filter </span><span class="si">%s</span><span class="s2"> is not being honoured&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The filters </span><span class="si">%s</span><span class="s2"> is  honoured &quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span></div>

<div class="viewcode-block" id="UnixSnapHelper.acceptance_tamplate"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.acceptance_tamplate">[docs]</a>    <span class="k">def</span> <span class="nf">acceptance_tamplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Snap Acceptance template to be used for all test cases with different</span>
<span class="sd">        Unix configurations and snap engines</span>

<span class="sd">        Full SnapBackup -&gt; Restore from Snapshot -&gt; Incremental SnapBackup -&gt;</span>
<span class="sd">        Backup Copy -&gt; Restore from Tape - &gt; Incremental SnapBackup -&gt;</span>
<span class="sd">        Backup Copy -&gt; Verify Mount Unmount -&gt; Synth Full -&gt;</span>
<span class="sd">        Restore from Synth Full</span>

<span class="sd">        Args:</span>
<span class="sd">            \*\*kwargs  (dict)          --  Optional keyword arguments</span>

<span class="sd">            Available kwargs options:</span>

<span class="sd">                instant_clone_options       (dict)  -- Options for performing an instant clone restore operation.</span>
<span class="sd">                The following key-value pairs are supported.</span>

<span class="sd">                    clone_mount_path        (str)   --  The path to which the snapshot needs to be mounted.</span>
<span class="sd">                    This  key is NOT OPTIONAL.</span>

<span class="sd">                    reservation_time        (int)   --  The amount of time, specified in seconds, that the mounted</span>
<span class="sd">                    snapshot needs to be reserved for before it is cleaned up.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">                            Default :   3600</span>

<span class="sd">                    post_clone_script       (str)   --  The script that will run post clone.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">                    clone_cleanup_script    (str)   --  The script that will run after clean up.</span>
<span class="sd">                    This key is OPTIONAL.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_snap_environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">FULL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">Restore</span><span class="o">.</span><span class="n">RESTORE_FROM_SNAP</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span>
                            <span class="n">dst_path</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;restore_path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">))</span>

        <span class="c1"># WILL PROCEED FURTHER ONLY IF INSTANT CLONE OPTIONS ISN&#39;T SPECIFIED</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instant_clone_options&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">INCREMENTAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">Restore</span><span class="o">.</span><span class="n">RESTORE_FROM_TAPE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">inc_data_paths</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>
                         <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">INCREMENTAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span> <span class="n">skip_data_creation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_mount_unmount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">INCREMENTAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">SYNTHETICFULL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">Restore</span><span class="o">.</span><span class="n">RESTORE_FROM_TAPE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>
                         <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># WAIT FOR THE RESERVATION PERIOD FOR THE INSTANT CLONE TO EXPIRE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instant_clone_options&#39;</span><span class="p">][</span><span class="s1">&#39;reservation_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s for snap to be unmounted.&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instant_clone_options&#39;</span><span class="p">][</span><span class="s1">&#39;reservation_time&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># ADDING AN EXTRA 120 SECONDS</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df | grep </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">formatted_output</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df | grep </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">formatted_output</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clone has been unmounted since df | grep </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restore_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> returned nothing.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Clone either failed to be unmounted or we did not receive expected final output.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="UnixSnapHelper.snap_extent_template"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.snap_extent_template">[docs]</a>    <span class="k">def</span> <span class="nf">snap_extent_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_proxy_options</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Template to run extent test case for intellisnap</span>

<span class="sd">            Args:</span>
<span class="sd">                set_proxy_options      (bool)   --    True, if the proxy needed otherwise False.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="s2">&quot;Running with Skip Catalog Phase&quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_snap_environment</span><span class="p">()</span>
        <span class="n">proxy_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;snap_proxy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;Snap_Proxy&#39;</span><span class="p">],</span>
            <span class="s1">&#39;backupcopy_proxy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;Backupcopy_Proxy&#39;</span><span class="p">],</span>
            <span class="s1">&#39;use_source_if_proxy_unreachable&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">set_proxy_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subclient</span><span class="o">.</span><span class="n">enable_intelli_snap</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="p">[</span><span class="s1">&#39;SnapEngine&#39;</span><span class="p">],</span> <span class="n">proxy_options</span><span class="p">)</span>
        <span class="n">fsa</span> <span class="o">=</span> <span class="s2">&quot;FileSystemAgent&quot;</span>
        <span class="n">enable</span> <span class="o">=</span> <span class="s2">&quot;bEnableFileExtentBackup&quot;</span>
        <span class="n">slab</span> <span class="o">=</span> <span class="s2">&quot;mszFileExtentSlabs&quot;</span>
        <span class="n">slab_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tcinputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Slab&quot;</span><span class="p">,</span> <span class="s2">&quot;1-1024=5&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;01 : Enable feature by setting </span><span class="si">{}</span><span class="s2"> under </span><span class="si">{}</span><span class="s2"> on client.&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">fsa</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">fsa</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;02 : Lowering threshold by setting </span><span class="si">{}</span><span class="s2"> under </span><span class="si">{}</span><span class="s2"> on client.&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">slab</span><span class="p">,</span> <span class="n">fsa</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">create_registry</span><span class="p">(</span><span class="n">fsa</span><span class="p">,</span> <span class="n">slab</span><span class="p">,</span> <span class="n">slab_val</span><span class="p">)</span>
        <span class="n">source_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_data_to_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_backup</span><span class="p">(</span><span class="n">backup_level</span><span class="o">.</span><span class="n">FULL</span><span class="p">,</span> <span class="n">skip_data_creation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_collect_extents</span><span class="p">(</span><span class="n">source_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">Restore</span><span class="o">.</span><span class="n">RESTORE_FROM_TAPE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>
                     <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">test_data_paths</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">restore_path</span>
                            <span class="p">)</span>
        <span class="n">remove_msg</span> <span class="o">=</span> <span class="s2">&quot;Removing registry entries </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> under </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">enable</span><span class="p">,</span> <span class="n">slab</span><span class="p">,</span> <span class="n">fsa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">remove_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_registry</span><span class="p">(</span><span class="n">fsa</span><span class="p">,</span> <span class="n">enable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">remove_registry</span><span class="p">(</span><span class="n">fsa</span><span class="p">,</span> <span class="n">slab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Snap Backup and restore with Extent Base Feature Test case completed Successfully&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.check_volume_monitoring"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.check_volume_monitoring">[docs]</a>    <span class="k">def</span> <span class="nf">check_volume_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the state of the volume for DC</span>

<span class="sd">            Args:</span>
<span class="sd">                volume         (str)       --   Volume which need to be check for monitoring.</span>

<span class="sd">            Returns:</span>
<span class="sd">                (bool)                     -- Returns True, if the volume is</span>
<span class="sd">                                             monitoring else raise exception.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">get_registry_value</span><span class="p">(</span><span class="s1">&#39;Base&#39;</span><span class="p">,</span> <span class="s1">&#39;dBASEHOME&#39;</span><span class="p">)</span>
        <span class="n">script_arguments</span> <span class="o">=</span> <span class="s2">&quot;-basedir </span><span class="si">{0}</span><span class="s2"> -volume </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span>
                                                             <span class="n">volume</span><span class="p">)</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">UNIX_VOLUME_STATE</span><span class="p">,</span> <span class="n">script_arguments</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Error </span><span class="si">%s</span><span class="s1"> while executing the script&#39;</span><span class="p">,</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Volume state checked fails&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;FULL_SCAN_ATTEMPTED&quot;</span> <span class="ow">or</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;INCR_SCAN_ATTEMPTED&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;The DC scan is going on. We will wait for 5 mins&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;MONITORING&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;volume </span><span class="si">%s</span><span class="s2"> is monitoring and ready for DC&quot;</span> <span class="o">%</span>
                    <span class="n">volume</span><span class="p">)</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NOT_LISTED&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Volume is not added to DC monitoring list&quot;</span><span class="p">)</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Volume can&#39;t be monitored for now&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.get_backup_stream_count"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.get_backup_stream_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_backup_stream_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of streams used by a backup job</span>

<span class="sd">                Args:</span>
<span class="sd">                    job    (object)  -- job object of the backup job to be checked</span>

<span class="sd">                Returns:</span>
<span class="sd">                    int   -   the number of streams used by a backup job</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting the number of streams from job details&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;jobDetail&#39;</span><span class="p">][</span><span class="s1">&#39;detailInfo&#39;</span><span class="p">][</span><span class="s1">&#39;numOfStreams&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="UnixSnapHelper.get_restore_stream_count"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.get_restore_stream_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_restore_stream_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of streams used by a restore job</span>

<span class="sd">                 Args:</span>
<span class="sd">                     job    (object)  -- job object of the restore job to be checked</span>

<span class="sd">                     log_dir  (str)  -- path of the log directory</span>
<span class="sd">                         default:None</span>

<span class="sd">                 Returns:</span>
<span class="sd">                     int   -   the number of streams used by a restore job</span>

<span class="sd">                 Raises:</span>
<span class="sd">                     Exception:</span>
<span class="sd">                         if any error occurred while getting the restore stream count</span>

<span class="sd">             &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">log_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">get_registry_value</span><span class="p">(</span>
                <span class="s1">&#39;EventManager&#39;</span><span class="p">,</span> <span class="s1">&#39;dEVLOGDIR&#39;</span><span class="p">)</span>

        <span class="n">jobid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span>

        <span class="n">script_arguments</span> <span class="o">=</span> <span class="s2">&quot;-logdir </span><span class="si">{0}</span><span class="s2"> -jobid </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_machine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">UNIX_GET_RESTORE_STREAM_COUNT</span><span class="p">,</span> <span class="n">script_arguments</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred while getting the number of restore streams </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Error occurred while getting the number of restore streams </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnixSnapHelper.verify_job_streams"><a class="viewcode-back" href="../../../source/FileSystem.SNAPUtils.html#FileSystem.SNAPUtils.unixsnaphelper.UnixSnapHelper.verify_job_streams">[docs]</a>    <span class="k">def</span> <span class="nf">verify_job_streams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">no_of_streams</span><span class="p">,</span> <span class="n">streams_used</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verifies if the job used expected number of streams</span>

<span class="sd">                 Args:</span>
<span class="sd">                    job (obj)                --  instance of the job class</span>

<span class="sd">                     no_of_streams (int)      --  expected number of streams to be used</span>

<span class="sd">                     streams_used (int)       --  actual number of streams used</span>

<span class="sd">                 Raises:</span>
<span class="sd">                     Exception - if the job didn&#39;t use expected streams</span>

<span class="sd">         &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">streams_used</span> <span class="o">==</span> <span class="n">no_of_streams</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Job </span><span class="si">%s</span><span class="s2"> used </span><span class="si">%s</span><span class="s2"> streams as expected&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">streams_used</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Job:</span><span class="si">%s</span><span class="s2"> used incorrect streams ExpectedStreams:</span><span class="si">%s</span><span class="s2"> ActualStreams:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">no_of_streams</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">streams_used</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Job:</span><span class="si">{0}</span><span class="s2"> used incorrect streams ExpectedStreams:</span><span class="si">{1}</span><span class="s2"> ActualStreams:</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">no_of_streams</span><span class="p">,</span> <span class="n">streams_used</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright Commvault Systems Inc. All Rights Reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>